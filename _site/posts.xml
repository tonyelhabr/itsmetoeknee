<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>Tony&#39;s Blog</title>
<link>https://tonyelhabr.rbind.io/posts.html</link>
<atom:link href="https://tonyelhabr.rbind.io/posts.xml" rel="self" type="application/rss+xml"/>
<description></description>
<generator>quarto-1.3.450</generator>
<lastBuildDate>Sun, 05 May 2024 05:00:00 GMT</lastBuildDate>
<item>
  <title>Estimating Shooting Performance Unlikeliness</title>
  <dc:creator>Tony ElHabr</dc:creator>
  <link>https://tonyelhabr.rbind.io/posts/xg-likelihood/index.html</link>
  <description><![CDATA[ 



<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>Towards the end of each soccer season, we naturally start to look back at player stats, often looking to see who has performed worse compared to their past seasons. We may have different motivations for doing so–we may be trying to attribute team under-performance to individuals, we may be hypothesizing who is likely to be transferred, etc.</p>
<p>It’s not uncommon to ask “How unlikely was their shooting performance this season?” when looking at a player who has scored fewer goals than expected.<sup>1</sup> For instance, if a striker only scores 8 goals on 12 <a href="https://theanalyst.com/na/2021/07/what-are-expected-goals-xg/">expected goals (xG)</a>, their “underperformance” of 4 goals is stark, especially if they had scored more goals than their xG in prior seasons.</p>
<p>The ratio of a player <img src="https://latex.codecogs.com/png.latex?p">’s goals <img src="https://latex.codecogs.com/png.latex?G_p"> to expected goals <img src="https://latex.codecogs.com/png.latex?xG_p">–the <a href="../../posts/xg-ratio-empirical-bayes/">“performance” (<img src="https://latex.codecogs.com/png.latex?PR_p">) ratio</a>–is a common, albeit <a href="https://dtai.cs.kuleuven.be/sports/blog/biases-in-expected-goals-models-confound-finishing-ability">flawed</a>, way of evaluating a player’s shooting performance.<sup>2</sup></p>
<p><img src="https://latex.codecogs.com/png.latex?%0APR_p%20=%20%5Cfrac%7BG_p%7D%7BxG_p%7D%0A"></p>
<p>An <img src="https://latex.codecogs.com/png.latex?PR_p"> of 1 indicates that a player is scoring as many goals as expected; a ratio greater than 1 indicates overperformance; and a ratio less than 1 indicates underperformance. Our hypothetical player underperformed with <img src="https://latex.codecogs.com/png.latex?PR_p%20=%20%5Cfrac%7B8%7D%7B12%7D%20=%200.67">.</p>
<p>In most cases, we have prior seasons of data to use when evaluating a player’s <img src="https://latex.codecogs.com/png.latex?PR_p"> for a given season. For example, let’s say our hypothetical player scored 14 goals on 10 xG (<img src="https://latex.codecogs.com/png.latex?PR_p%20=%201.4">) in the season prior, and 12 goals on 8 xG (<img src="https://latex.codecogs.com/png.latex?PR_p%20=%201.5">) before that. A <img src="https://latex.codecogs.com/png.latex?PR_p%20=%200.67"> after those seasons seems fairly unlikely, especially compared to an “average” player who has a <img src="https://latex.codecogs.com/png.latex?PR_p%20=%201"> every year.</p>
<p>So how do we put a number on the unlikeliness of the <img src="https://latex.codecogs.com/png.latex?PR_p%20=%200.67"> for our hypothetical player, accounting for their prior season-long performances?</p>
<section id="data" class="level3">
<h3 class="anchored" data-anchor-id="data">Data</h3>
<p>I’ll be using public data from <a href="https://fbref.com/">FBref</a> for the 2018/19 - 2023/24 seasons of the <a href="https://fbref.com/en/comps/Big5/Big-5-European-Leagues-Stats">the Big Five European soccer leagues</a>, updated through May 7. Fake data is nice for examples, but ultimately we want to test our methods on real data. Our intuition about the results can be a useful caliber of the sensibility of our results.</p>
<div class="cell">
<details>
<summary>Get shot data</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1">raw_shots <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> worldfootballR<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">load_fb_match_shooting</span>(</span>
<span id="cb1-2">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">country =</span> COUNTRIES,</span>
<span id="cb1-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tier =</span> TIERS,</span>
<span id="cb1-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gender =</span> GENDERS,</span>
<span id="cb1-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">season_end_year =</span> SEASON_END_YEARS</span>
<span id="cb1-6">)</span>
<span id="cb1-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; → Data last updated 2024-05-07 17:52:59 UTC</span></span>
<span id="cb1-8"></span>
<span id="cb1-9">np_shots <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> raw_shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-10">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Drop penalties</span></span>
<span id="cb1-11">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(</span>
<span id="cb1-12">    <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coalesce</span>((Distance <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'13'</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.double</span>(xG), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.79</span>), <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span>
<span id="cb1-13">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-14">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">transmute</span>(</span>
<span id="cb1-15">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">season_end_year =</span> Season_End_Year,</span>
<span id="cb1-16">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">team =</span> Squad,</span>
<span id="cb1-17">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">player_id =</span> Player_Href <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dirname</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">basename</span>(),</span>
<span id="cb1-18">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">player =</span> Player,</span>
<span id="cb1-19">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">match_date =</span> lubridate<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ymd</span>(Date),</span>
<span id="cb1-20">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">match_id =</span> MatchURL <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dirname</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">basename</span>(),</span>
<span id="cb1-21">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">minute =</span> Minute,</span>
<span id="cb1-22">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">g =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.integer</span>(Outcome <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Goal'</span>),</span>
<span id="cb1-23">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xg =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.double</span>(xG)</span>
<span id="cb1-24">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-25">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## A handful of scored shots with empty xG</span></span>
<span id="cb1-26">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(xg)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-27">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(season_end_year, player_id, match_date, minute)</span>
<span id="cb1-28"></span>
<span id="cb1-29"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Use the more commonly used name when a player ID is mapped to multiple names</span></span>
<span id="cb1-30"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   (This "bug" happens because worldfootballR doesn't go back and re-scrape data</span></span>
<span id="cb1-31"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   when fbref makes a name update.)</span></span>
<span id="cb1-32">player_name_mapping <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> np_shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-33">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">count</span>(player_id, player) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-34">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(player_id) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-35">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">slice_max</span>(n, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">with_ties =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-36">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-37">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">distinct</span>(player_id, player)</span>
<span id="cb1-38"></span>
<span id="cb1-39">player_season_np_shots <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> np_shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-40">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(</span>
<span id="cb1-41">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(player_id, season_end_year), </span>
<span id="cb1-42">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shots =</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>(),</span>
<span id="cb1-43">    dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(g, xg), sum)</span>
<span id="cb1-44">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-45">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb1-46">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pr =</span> g <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> xg</span>
<span id="cb1-47">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-48">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(</span>
<span id="cb1-49">    player_name_mapping,</span>
<span id="cb1-50">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(player_id)</span>
<span id="cb1-51">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-52">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">relocate</span>(player, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.after =</span> player_id) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-53">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(player_id, season_end_year)</span>
<span id="cb1-54">player_season_np_shots</span>
<span id="cb1-55"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 15,327 × 7</span></span>
<span id="cb1-56"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    player_id player          season_end_year shots     g    xg    pr</span></span>
<span id="cb1-57"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    &lt;chr&gt;     &lt;chr&gt;                     &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb1-58"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  1 0000acda  Marco Benassi              2018    70     5  4.01 1.25 </span></span>
<span id="cb1-59"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  2 0000acda  Marco Benassi              2019    59     7  5.61 1.25 </span></span>
<span id="cb1-60"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  3 0000acda  Marco Benassi              2020    20     1  1.01 0.990</span></span>
<span id="cb1-61"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  4 0000acda  Marco Benassi              2022    10     0  0.99 0    </span></span>
<span id="cb1-62"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  5 0000acda  Marco Benassi              2023    19     0  1.35 0    </span></span>
<span id="cb1-63"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  6 000b3da6  Manuel Iturra              2018     2     0  0.41 0    </span></span>
<span id="cb1-64"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  7 00242715  Moussa Niakhate            2018    16     0  1.43 0    </span></span>
<span id="cb1-65"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  8 00242715  Moussa Niakhate            2019    10     1  1.5  0.667</span></span>
<span id="cb1-66"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  9 00242715  Moussa Niakhate            2020    11     1  1.02 0.980</span></span>
<span id="cb1-67"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 10 00242715  Moussa Niakhate            2021     9     2  1.56 1.28 </span></span>
<span id="cb1-68"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # ℹ 15,307 more rows</span></span></code></pre></div>
</details>
</div>
<p>For illustrative purposes, we’ll focus on one player in particular–<a href="https://fbref.com/en/players/ee38d9c5/James-Maddison">James Maddison</a>. Maddison has had a sub-par 2023/2024 season by his own standards, underperforming his xG for the first time since he started playing in the <a href="https://fbref.com/en/comps/9/Premier-League-Stats">Premier League</a> in 2018/19.</p>
<div class="cell">
<details open="">
<summary>Maddison’s season-by-season data</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">player_season_np_shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(player <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'James Maddison'</span>)</span>
<span id="cb2-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 6 × 7</span></span>
<span id="cb2-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;   player_id player         season_end_year shots     g    xg    pr</span></span>
<span id="cb2-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;   &lt;chr&gt;     &lt;chr&gt;                    &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb2-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 1 ee38d9c5  James Maddison            2019    81     6  5.85 1.03 </span></span>
<span id="cb2-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 2 ee38d9c5  James Maddison            2020    74     6  5.36 1.12 </span></span>
<span id="cb2-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 3 ee38d9c5  James Maddison            2021    75     8  3.86 2.07 </span></span>
<span id="cb2-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 4 ee38d9c5  James Maddison            2022    72    12  7.56 1.59 </span></span>
<span id="cb2-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 5 ee38d9c5  James Maddison            2023    83     9  7.12 1.26 </span></span>
<span id="cb2-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 6 ee38d9c5  James Maddison            2024    55     4  5.02 0.797</span></span></code></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>More variables useful for the rest of the post</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">TARGET_SEASON_END_YEAR <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2024</span></span>
<span id="cb3-2"></span>
<span id="cb3-3">player_np_shots <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> player_season_np_shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-4">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb3-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">is_target =</span> season_end_year <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> TARGET_SEASON_END_YEAR</span>
<span id="cb3-6">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-7">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(</span>
<span id="cb3-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(is_target, player_id, player),</span>
<span id="cb3-9">    dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(</span>
<span id="cb3-10">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(shots, g, xg),</span>
<span id="cb3-11">      \(.x) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(.x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb3-12">    )</span>
<span id="cb3-13">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-14">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pr =</span> g <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> xg) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-15">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(player, player_id, is_target)</span>
<span id="cb3-16"></span>
<span id="cb3-17">wide_player_np_shots <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> player_np_shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb3-18">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">transmute</span>(</span>
<span id="cb3-19">    player_id, </span>
<span id="cb3-20">    player,</span>
<span id="cb3-21">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">which =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(is_target, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'target'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'prior'</span>), </span>
<span id="cb3-22">    shots, g, xg, pr</span>
<span id="cb3-23">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-24">  tidyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_wider</span>(</span>
<span id="cb3-25">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_from =</span> which, </span>
<span id="cb3-26">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_from =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(shots, g, xg, pr), </span>
<span id="cb3-27">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_glue =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'{which}_{.value}'</span></span>
<span id="cb3-28">  )</span>
<span id="cb3-29"></span>
<span id="cb3-30">all_players_to_evaluate <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> wide_player_np_shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-31">  tidyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">drop_na</span>(prior_pr, target_pr) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-32">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(</span>
<span id="cb3-33">    prior_shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>,</span>
<span id="cb3-34">    target_shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,</span>
<span id="cb3-35">    prior_g <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, </span>
<span id="cb3-36">    target_g <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb3-37">  )</span></code></pre></div>
</details>
</div>
</section>
<section id="methods-and-analysis" class="level2">
<h2 class="anchored" data-anchor-id="methods-and-analysis">Methods and Analysis</h2>
<p>I’ll present 3 approaches to contexutalizing the likelihood of a player underperforming relative to their prior <img src="https://latex.codecogs.com/png.latex?G%20/%20xG"> ratio, which I’ll broadly call the “performance ratio percentile”, <img src="https://latex.codecogs.com/png.latex?PRP_p">.</p>
<ol type="1">
<li>Weighted <strong>percentile ranking</strong>: Identify where a player’s performance relative to their own past ranks among the whole spectrum of relative player performances.</li>
<li><strong>Resampling</strong> from prior shot history: Quantify the likelihood of the observed outcome for a given player by resampling shots from their past.</li>
<li>Evaluating a player-specific <strong>cumulative distribution function (CDF)</strong>: Fit a distribution to represent a player’s past set of season-long outcomes, then identify where the target season’s outcome lies on that distribution.</li>
</ol>
<p>I’ll discuss some of the strengths and weaknesses of each approach as we go along, then summarize the findings in the end.</p>
<p>Note that I use “prior”, or <img src="https://latex.codecogs.com/png.latex?%5Ctext%7Btarget%7D'">, to refer to an aggregate of pre-2023/24 statistics, and “target” to refer to 2023/24. Here’s what the distribution of <img src="https://latex.codecogs.com/png.latex?PR_%7Bp,%5Ctext%7Btarget%7D'%7D"> and <img src="https://latex.codecogs.com/png.latex?PR_%7Bp,%5Ctext%7Btarget%7D%7D"> looks like. The latter’s distribution has a bit more noise–note the lump of players with ratios greater than 2–due to smaller sample sizes.</p>
<p><img src="https://tonyelhabr.rbind.io/posts/xg-likelihood/raw_pr.png" class="img-fluid"></p>
<section id="approach-1-weighted-percentile-ranking" class="level3">
<h3 class="anchored" data-anchor-id="approach-1-weighted-percentile-ranking">Approach 1: Weighted Percentile Ranking</h3>
<p>The first approach I’ll present is a handcrafted “ranking” method.</p>
<ol type="1">
<li>Calculate the proportional difference between the pre-target and target season performance ratios for all players <img src="https://latex.codecogs.com/png.latex?P">.</li>
</ol>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cdelta%20PR_p%20=%20%5Cfrac%7BPR_%7Bp,%5Ctext%7Btarget%7D%7D%20-%20PR_%7Bp,%5Ctext%7Btarget%7D'%7D%7D%7BPR_%7Bp,%5Ctext%7Btarget%7D'%7D%7D%0A"></p>
<ol start="2" type="1">
<li>Weight <img src="https://latex.codecogs.com/png.latex?%5Cdelta%20PR%5Ew_p"> by the player’s <img src="https://latex.codecogs.com/png.latex?xG_p"> accumulated in prior seasons.<sup>3</sup></li>
</ol>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cdelta%20PR%5Ew_p%20=%20%5Cdelta%20PR_p%20*%20xG_p%0A"></p>
<ol start="3" type="1">
<li>Calculate the the performance percentile <img src="https://latex.codecogs.com/png.latex?PRP_p"> as a percentile rank of ascending <img src="https://latex.codecogs.com/png.latex?%5Cdelta%20PR%5Ew_p">, i.e.&nbsp;more negative <img src="https://latex.codecogs.com/png.latex?%5Cdelta%20PR%5Ew_p"> values correspond to a lower <img src="https://latex.codecogs.com/png.latex?PRP_p"> percentile.<sup>4</sup></li>
</ol>
<p>This seems really straightforward, right? Indeed, with the data prepped in the correct manner, it is straightforward to calculate.</p>
<div class="cell">
<details>
<summary>Approach 1 implementation</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## `prp` for "performance ratio percentile"</span></span>
<span id="cb4-2">all_prp_approach1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> all_players_to_evaluate <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb4-3">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">transmute</span>(</span>
<span id="cb4-4">    player,</span>
<span id="cb4-5">    prior_pr,</span>
<span id="cb4-6">    target_pr,</span>
<span id="cb4-7">    prior_xg,</span>
<span id="cb4-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">weighted_delta_o =</span> prior_shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (target_pr <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> prior_pr) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> prior_pr,</span>
<span id="cb4-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prp =</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">percent_rank</span>(weighted_delta_o)</span>
<span id="cb4-10">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb4-11">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(prp)</span>
<span id="cb4-12"></span>
<span id="cb4-13">maddison_prp_approach1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> all_prp_approach1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb4-14">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(player <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'James Maddison'</span>)</span></code></pre></div>
</details>
</div>
<div class="cell">
<details open="">
<summary>Approach 1 output for Maddison</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">maddison_prp_approach1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(player, prior_pr, target_pr, prp)</span>
<span id="cb5-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 1 × 4</span></span>
<span id="cb5-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;   player         prior_pr target_pr    prp</span></span>
<span id="cb5-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;   &lt;chr&gt;             &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span id="cb5-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 1 James Maddison     1.38     0.797 0.0233</span></span></code></pre></div>
</details>
</div>
<p>This approach finds Maddison’s 2023/24 <img src="https://latex.codecogs.com/png.latex?PR_p"> of 0.797 to be about a 2nd percentile outcome. Among the 602 players evaluated, Maddison’s 2023/24 <img src="https://latex.codecogs.com/png.latex?PR_p"> ranks as the 15th lowest.</p>
<p>For context, here’s a look at the top 10 most unlikely outcomes for the 2023/24 season.</p>
<div class="cell">
<details open="">
<summary>Approach 1 output, top 10 underperforming players</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">all_prp_approach1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(player, prior_pr, target_pr, prp)</span>
<span id="cb6-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 10 × 4</span></span>
<span id="cb6-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    player              prior_pr target_pr     prp</span></span>
<span id="cb6-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    &lt;chr&gt;                  &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;</span></span>
<span id="cb6-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  1 Ciro Immobile          1.23      0.503 0      </span></span>
<span id="cb6-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  2 Giovanni Simeone       1.03      0.306 0.00166</span></span>
<span id="cb6-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  3 Nabil Fekir            1.14      0.490 0.00333</span></span>
<span id="cb6-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  4 Wahbi Khazri           1.11      0.322 0.00499</span></span>
<span id="cb6-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  5 Kevin Volland          1.18      0.388 0.00666</span></span>
<span id="cb6-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  6 Adrien Thomasson       1.18      0.282 0.00832</span></span>
<span id="cb6-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  7 Timo Werner            0.951     0.543 0.00998</span></span>
<span id="cb6-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  8 Gaëtan Laborde         1.02      0.546 0.0116 </span></span>
<span id="cb6-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  9 Fabián Ruiz Peña       1.67      0.510 0.0133 </span></span>
<span id="cb6-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 10 Benjamin Bourigeaud    1.12      0.503 0.0150</span></span></code></pre></div>
</details>
</div>
<p><a href="https://fbref.com/en/players/4431aed2/Ciro-Immobile">Ciro Immobile</a> tops the list, with several other notable attacking players who had less than stellar seasons.</p>
<section id="discussion" class="level4">
<h4 class="anchored" data-anchor-id="discussion">Discussion</h4>
<p>Overall, I’d say that this methodology seems to generate fairly reasonable results, but certainly has its flaws.</p>
<ul>
<li><strong>Subjectivity in Weighting</strong>: The choice to weight the difference in performance ratios by pre-2023/24 xG is inherently subjective. While it’s important to have some form of weighting–so as to avoid disproportionately emphasizing players with a shorter history of past shots or who shoot relatively few shots in the target season–alternative weighting strategies could lead to significantly different rankings.</li>
<li><strong>Sensitivity to Player Pool</strong>: The percentile ranking of a player’s <img src="https://latex.codecogs.com/png.latex?PR_%7Bp,%5Ctext%7Btarget%7D%7D"> unlikeliness is highly sensitive to the comparison group. For instance, comparing forwards to defenders could skew results due to generally higher variability in defenders’ goal-to-expected goals ratios. Moreover, if we for some reason chose to evaluate a set of players from lower tier leagues who generally scores less goals than their expected goals, even players who can simply maintain a <img src="https://latex.codecogs.com/png.latex?PR_p%20=%201"> might appear more favorably than they would when compared to Big Five league players. This potential for selection bias underlines the importance of carefully choosing the comparison set of players.</li>
</ul>
</section>
</section>
<section id="approach-2-resampling-from-prior-shot-history" class="level3">
<h3 class="anchored" data-anchor-id="approach-2-resampling-from-prior-shot-history">Approach 2: Resampling from Prior Shot History</h3>
<p>There’s only so much you can do with player-season-level data; shot-level data can help us more robustly understand and quantify the uncertainty of shooting outcomes.</p>
<p>Here’s a “resampling” approach to quantify the performance ratio percentile <img src="https://latex.codecogs.com/png.latex?PRP_p"> of a player in the target season:</p>
<ol type="1">
<li><p>Sample <img src="https://latex.codecogs.com/png.latex?N_%7Bp,%5Ctext%7Btarget%7D%7D"> shots from a player’s past shots <img src="https://latex.codecogs.com/png.latex?S_%7Bp,%5Ctext%7Btarget%7D'%7D">. Repeat this for <img src="https://latex.codecogs.com/png.latex?R"> resamples.<sup>5</sup></p></li>
<li><p>Count the number of resamples <img src="https://latex.codecogs.com/png.latex?r"> in which the outperformance ratio <img src="https://latex.codecogs.com/png.latex?%5Chat%7BPR%7D_%7Bp,%5Ctext%7Btarget%7D'%7D"> of the sampled shots is less than or equal to the observed <img src="https://latex.codecogs.com/png.latex?PR_%7Bp,%5Ctext%7Btarget%7D%7D"> in the target season for the player. The proportion <img src="https://latex.codecogs.com/png.latex?PRP_p%20=%20%5Cfrac%7Br%7D%7BR%7D"> represents the unlikeness of a given player’s observed <img src="https://latex.codecogs.com/png.latex?PR_%7Bp,%5Ctext%7Btarget%7D%7D"> (or worse) in the target season.</p></li>
</ol>
<p>Here’s how that looks in code.</p>
<div class="cell">
<details>
<summary>Approach 2 implementation</summary>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">R <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span></span>
<span id="cb7-2">resample_player_shots <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(</span>
<span id="cb7-3">    shots, </span>
<span id="cb7-4">    n_shots_to_sample, </span>
<span id="cb7-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n_sims =</span> R,</span>
<span id="cb7-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span id="cb7-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seed =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span></span>
<span id="cb7-8">) {</span>
<span id="cb7-9">  </span>
<span id="cb7-10">  withr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">local_seed</span>(seed)</span>
<span id="cb7-11">  purrr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map_dfr</span>(</span>
<span id="cb7-12">    <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>n_sims,</span>
<span id="cb7-13">    \(.sim) {</span>
<span id="cb7-14">      sampled_shots <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb7-15">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">slice_sample</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> n_shots_to_sample, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace =</span> replace)</span>
<span id="cb7-16">      </span>
<span id="cb7-17">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb7-18">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sim =</span> .sim,</span>
<span id="cb7-19">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xg =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(sampled_shots<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>xg),</span>
<span id="cb7-20">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">g =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(sampled_shots<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>g),</span>
<span id="cb7-21">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pr =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(sampled_shots<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>g) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(sampled_shots<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>xg)</span>
<span id="cb7-22">      )</span>
<span id="cb7-23">    }</span>
<span id="cb7-24">  )</span>
<span id="cb7-25">}</span>
<span id="cb7-26"></span>
<span id="cb7-27">resample_one_player_pr <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(shots, target_season_end_year) {</span>
<span id="cb7-28">  target_shots <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb7-29">    dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(season_end_year <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> target_season_end_year)</span>
<span id="cb7-30">  </span>
<span id="cb7-31">  prior_shots <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb7-32">    dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(season_end_year <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> target_season_end_year)</span>
<span id="cb7-33">  </span>
<span id="cb7-34">  prior_shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb7-35">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">resample_player_shots</span>(</span>
<span id="cb7-36">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n_shots_to_sample =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(target_shots)</span>
<span id="cb7-37">    )</span>
<span id="cb7-38">}</span>
<span id="cb7-39"></span>
<span id="cb7-40">resample_player_pr <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(shots, players, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">target_season_end_year =</span> TARGET_SEASON_END_YEAR) {</span>
<span id="cb7-41">  purrr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map_dfr</span>(</span>
<span id="cb7-42">    players,</span>
<span id="cb7-43">    \(.player) {</span>
<span id="cb7-44">      shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb7-45">        dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(player <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> .player) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb7-46">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">resample_one_player_pr</span>(</span>
<span id="cb7-47">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">target_season_end_year =</span> target_season_end_year</span>
<span id="cb7-48">        ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb7-49">        dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb7-50">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">player =</span> .player</span>
<span id="cb7-51">        )</span>
<span id="cb7-52">    }</span>
<span id="cb7-53">  )</span>
<span id="cb7-54">}</span>
<span id="cb7-55"></span>
<span id="cb7-56">maddison_resampled_pr <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> np_shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb7-57">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">resample_player_pr</span>(</span>
<span id="cb7-58">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">players =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'James Maddison'</span></span>
<span id="cb7-59">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb7-60">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inner_join</span>(</span>
<span id="cb7-61">    wide_player_np_shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb7-62">      dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(</span>
<span id="cb7-63">        player,</span>
<span id="cb7-64">        prior_pr,</span>
<span id="cb7-65">        target_pr</span>
<span id="cb7-66">      ),</span>
<span id="cb7-67">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(player)</span>
<span id="cb7-68">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb7-69">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(player)</span>
<span id="cb7-70"></span>
<span id="cb7-71">maddison_prp_approach2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> maddison_resampled_pr <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb7-72">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(</span>
<span id="cb7-73">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(player, prior_pr, target_pr),</span>
<span id="cb7-74">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prp =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(pr <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> target_pr) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>()</span>
<span id="cb7-75">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb7-76">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(player)</span></code></pre></div>
</details>
</div>
<div class="cell">
<details open="">
<summary>Approach 2 output for Maddison</summary>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1">maddison_prp_approach2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(player, prior_pr, target_pr, prp)</span></code></pre></div>
</details>
</div>
<p>The plot below should provide a bit of visual intuition as to what’s going on.</p>
<p><img src="https://tonyelhabr.rbind.io/posts/xg-likelihood/maddison_prp_approach2.png" class="img-fluid"></p>
<p>These results imply that Maddison’s 2023/24 <img src="https://latex.codecogs.com/png.latex?G%20/%20xG"> ratio of 0.797 (or worse) occurs in 10.9% of simulations, i.e.&nbsp;an 11th percentile outcome. That’s a bit higher than what the first approach showed.</p>
<p>How can we feel confident about this approach? Well, in the first approach, we sort of implicitly assumed that underperformance should be uniform across all players, hence the percentile ranking. We should see if the same bears out with this second approach.</p>
<p>The plot below shows a histogram of the performance ratio percentile across all players, where each player’s estimated unlikelihood is grouped into a decile.</p>
<div class="cell">
<details>
<summary>Approach 2 implementation for all players</summary>
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">all_resampled_pr <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> np_shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb9-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">resample_player_pr</span>(</span>
<span id="cb9-3">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">players =</span> all_players_to_evaluate<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>player</span>
<span id="cb9-4">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb9-5">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inner_join</span>(</span>
<span id="cb9-6">    wide_player_np_shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb9-7">      <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## to make sure we just one Rodri, Danilo, and Nicolás González </span></span>
<span id="cb9-8">      dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(player_id <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> all_players_to_evaluate<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>player_id) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb9-9">      dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(</span>
<span id="cb9-10">        player,</span>
<span id="cb9-11">        prior_pr,</span>
<span id="cb9-12">        target_pr,</span>
<span id="cb9-13">        prior_shots,</span>
<span id="cb9-14">        target_shots</span>
<span id="cb9-15">      ),</span>
<span id="cb9-16">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(player)</span>
<span id="cb9-17">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb9-18">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(player, player)</span>
<span id="cb9-19"></span>
<span id="cb9-20">all_prp_approach2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> all_resampled_pr <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb9-21">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(</span>
<span id="cb9-22">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(player, prior_pr, target_pr, prior_shots, target_shots),</span>
<span id="cb9-23">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prp =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(pr <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> target_pr) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>()</span>
<span id="cb9-24">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb9-25">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(prp)</span></code></pre></div>
</details>
</div>
<p><img src="https://tonyelhabr.rbind.io/posts/xg-likelihood/all_prp_approach2.png" class="img-fluid"></p>
<p>Indeed, the histogram shows a fairly uniform distribution, with a bit of irregularity at the very edges.</p>
<p>Looking at who is in the lower end of the leftmost decile, we see some of the same names–Immobile and <a href="https://fbref.com/en/players/6bde367b/Teji-Savanier">Savanier</a>–among the ten underperformers. (Withholding judgment on the superiority of any methodology, we can find some solace in seeing some of the same names among the most unlikely underperformers here as we did with approach 1.)</p>
<div class="cell">
<details open="">
<summary>Approach 2 output, top 10 underperforming players</summary>
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1">all_prp_approach2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(player, prior_pr, target_pr, prp)</span>
<span id="cb10-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 10 × 4</span></span>
<span id="cb10-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    player                    prior_pr target_pr   prp</span></span>
<span id="cb10-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    &lt;chr&gt;                        &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb10-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  1 Pierre-Emerick Aubameyang     1.07     0.636 0.009</span></span>
<span id="cb10-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  2 Alex Baena                    1.54     0.326 0.01 </span></span>
<span id="cb10-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  3 Amine Harit                   1.27     0.262 0.01 </span></span>
<span id="cb10-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  4 Erling Haaland                1.26     0.897 0.013</span></span>
<span id="cb10-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  5 Kevin Volland                 1.18     0.388 0.015</span></span>
<span id="cb10-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  6 Antonio Sanabria              1.05     0.380 0.018</span></span>
<span id="cb10-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  7 Kevin Behrens                 1.39     0.673 0.019</span></span>
<span id="cb10-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  8 Elye Wahi                     1.38     0.770 0.021</span></span>
<span id="cb10-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  9 Ansu Fati                     1.31     0.430 0.024</span></span>
<span id="cb10-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 10 M'Bala Nzola                  1.10     0.274 0.025</span></span></code></pre></div>
</details>
</div>
<p>One familiar face in the printout above is <a href="https://fbref.com/en/players/1f44ac21/Erling-Haaland">Manchester City’s striker Erling Haaland</a>, whose underperformance this season has been called among <a href="https://theathletic.com/5430355/2024/04/20/erling-haaland-manchester-city-human/">fans and the media</a>. His sub-par performance this year ranked as a 9th percentile outcome by approach 1, which is very low, but not quite as low as what this approach finds (1st percentile).</p>
<section id="discussion-1" class="level4">
<h4 class="anchored" data-anchor-id="discussion-1">Discussion</h4>
<ul>
<li><strong>Assumption of Shot Profile Consistency</strong>: We assume that a player’s past shot behavior accurately predicts their future performance. This generally holds unless a player changes their role or team, or is recovering from an injury. But there are other exceptions as well. For example, Haaland has taken a lot more headed shots this season, despite playing effectively the same role on mostly the same team from last season The change in Haaland’s shot profile this year conflicts with the assumption of a consistent shot profile, perhaps explaining why this resampling approach finds Haaland’s shooting performance to be more unlikely the percentile ranking approach.</li>
<li><strong>Non-Parametric Nature</strong>: This method does not assume any specific distribution for a player’s performance ratios; instead, it relies on the stability of a player’s performance over time. The resampling process itself shapes the outcome distribution, which can vary significantly between players with different shooting behaviors, such as a forward versus a defender.</li>
<li><strong>Computational Demands</strong>: The resampling approach requires relatively more computational resources than the prior approach, especially without parallel processing. Even a relatively small number of resamples, such as <img src="https://latex.codecogs.com/png.latex?R=1000">, can take a few second per player to compute.</li>
</ul>
</section>
</section>
<section id="approach-3-evaluating-a-player-specific-cumulative-distribution-function-cdf" class="level3">
<h3 class="anchored" data-anchor-id="approach-3-evaluating-a-player-specific-cumulative-distribution-function-cdf">Approach 3: Evaluating a Player-Specific Cumulative Distribution Function (CDF)</h3>
<p>If we assume that the set of goals-to-xG ratios come from a <a href="https://en.wikipedia.org/wiki/Gamma_process">Gamma data-generating process</a>, then we can leverage the properties of a player-level <a href="https://en.wikipedia.org/wiki/Gamma_distribution">Gamma distribution</a> to assess the unlikelihood of a players <img src="https://latex.codecogs.com/png.latex?PR_p"> ratio.</p>
<p>To calculate the underperforming unlikeliness <img src="https://latex.codecogs.com/png.latex?PRP_p">:</p>
<ol type="1">
<li><p>Estimate a Gamma distribution <img src="https://latex.codecogs.com/png.latex?%5CGamma_%7Bp,%5Ctext%7Btarget%7D'%7D"> to model a player’s true outperformance ratio <img src="https://latex.codecogs.com/png.latex?O_%7Bp%7D"> across all prior shots, excluding those in the target season–<img src="https://latex.codecogs.com/png.latex?%5Chat%7BPR%7D_%7Bp,%5Ctext%7Btarget%7D'%7D">.</p></li>
<li><p>Calculate the probability that <img src="https://latex.codecogs.com/png.latex?%5Chat%7BPR%7D_%7Bp,%5Ctext%7Btarget%7D'%7D"> is less than or equal to the player’s observed <img src="https://latex.codecogs.com/png.latex?PR_%7Bp,%5Ctext%7Btarget%7D%7D"> in the target season using the Gamma distribution’s <a href="https://en.wikipedia.org/wiki/Cumulative_distribution_function">cumulative distribution function (CDF)</a>.</p></li>
</ol>
<p>While that may sound daunting, I promise that it’s not.</p>
<div class="cell">
<details>
<summary>Approach 3 implementation</summary>
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1">N_SIMS <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10000</span></span>
<span id="cb11-2"></span>
<span id="cb11-3">SHOT_TO_SHAPE_MAPPING <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb11-4">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'from'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">750</span>),</span>
<span id="cb11-5">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'to'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span>)</span>
<span id="cb11-6">)</span>
<span id="cb11-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Fix the gamma distribution's "median" to be shaped around the player's past</span></span>
<span id="cb11-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   historical G/xG ratio (with minimum shape value of 1, so as to prevent a </span></span>
<span id="cb11-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   monotonically decreasing distribution function).</span></span>
<span id="cb11-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Fit larger shape and rate parameters when the player has a lot of prior shots, </span></span>
<span id="cb11-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   so as to create a tighter Gamma distibution.</span></span>
<span id="cb11-12">estimate_one_gamma_distributed_pr  <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(</span>
<span id="cb11-13">    shots,</span>
<span id="cb11-14">    target_season_end_year</span>
<span id="cb11-15">) {</span>
<span id="cb11-16">  player_np_shots <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb11-17">    dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">is_target =</span> season_end_year <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> target_season_end_year)</span>
<span id="cb11-18">  </span>
<span id="cb11-19">  prior_player_np_shots <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> player_np_shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb11-20">    dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>is_target)</span>
<span id="cb11-21">  </span>
<span id="cb11-22">  target_player_np_shots <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> player_np_shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb11-23">    dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(is_target)</span>
<span id="cb11-24">  </span>
<span id="cb11-25"></span>
<span id="cb11-26">  agg_player_np_shots <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> player_np_shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb11-27">    dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(</span>
<span id="cb11-28">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(is_target),</span>
<span id="cb11-29">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shots =</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>(),</span>
<span id="cb11-30">      dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(g, xg), \(.x) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(.x))</span>
<span id="cb11-31">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb11-32">    dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pr =</span> g <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> xg)</span>
<span id="cb11-33">  </span>
<span id="cb11-34">  agg_prior_player_np_shots <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> agg_player_np_shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb11-35">    dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>is_target)</span>
<span id="cb11-36">  </span>
<span id="cb11-37">  agg_target_player_np_shots <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> agg_player_np_shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb11-38">    dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(is_target)</span>
<span id="cb11-39"></span>
<span id="cb11-40">  shape <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(</span>
<span id="cb11-41">    agg_prior_player_np_shots<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> SHOT_TO_SHAPE_MAPPING<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>from[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> SHOT_TO_SHAPE_MAPPING<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>to[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>],</span>
<span id="cb11-42">    agg_prior_player_np_shots<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> SHOT_TO_SHAPE_MAPPING<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>from[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> SHOT_TO_SHAPE_MAPPING<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>to[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>],</span>
<span id="cb11-43">    <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> scales<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rescale</span>(</span>
<span id="cb11-44">      agg_prior_player_np_shots<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>shots, </span>
<span id="cb11-45">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">from =</span> SHOT_TO_SHAPE_MAPPING<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>from, </span>
<span id="cb11-46">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">to =</span> SHOT_TO_SHAPE_MAPPING<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>to</span>
<span id="cb11-47">    )</span>
<span id="cb11-48">  )</span>
<span id="cb11-49">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb11-50">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shape'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> shape,</span>
<span id="cb11-51">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'rate'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> shape <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> agg_prior_player_np_shots<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pr</span>
<span id="cb11-52">  )</span>
<span id="cb11-53">}</span>
<span id="cb11-54"></span>
<span id="cb11-55">estimate_gamma_distributed_pr <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(</span>
<span id="cb11-56">    shots,</span>
<span id="cb11-57">    players,</span>
<span id="cb11-58">    target_season_end_year</span>
<span id="cb11-59">) {</span>
<span id="cb11-60">  </span>
<span id="cb11-61">  purrr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map_dfr</span>(</span>
<span id="cb11-62">    players,</span>
<span id="cb11-63">    \(.player) {</span>
<span id="cb11-64">      params <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb11-65">        dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(player <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> .player) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb11-66">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">estimate_one_gamma_distributed_pr</span>(</span>
<span id="cb11-67">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">target_season_end_year =</span> target_season_end_year</span>
<span id="cb11-68">        )</span>
<span id="cb11-69">      </span>
<span id="cb11-70">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb11-71">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'player'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> .player,</span>
<span id="cb11-72">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'params'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(params)</span>
<span id="cb11-73">      )</span>
<span id="cb11-74">    }</span>
<span id="cb11-75">  )</span>
<span id="cb11-76">}</span>
<span id="cb11-77"></span>
<span id="cb11-78">maddison_gamma_pr <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> np_shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb11-79">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">estimate_gamma_distributed_pr</span>(</span>
<span id="cb11-80">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">players =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'James Maddison'</span>,</span>
<span id="cb11-81">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">target_season_end_year =</span> TARGET_SEASON_END_YEAR</span>
<span id="cb11-82">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb11-83">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inner_join</span>(</span>
<span id="cb11-84">    wide_player_np_shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb11-85">      dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(</span>
<span id="cb11-86">        player,</span>
<span id="cb11-87">        prior_pr,</span>
<span id="cb11-88">        target_pr</span>
<span id="cb11-89">      ),</span>
<span id="cb11-90">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(player)</span>
<span id="cb11-91">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb11-92">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(player)</span>
<span id="cb11-93"></span>
<span id="cb11-94">maddison_prp_approach3 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> maddison_gamma_pr <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb11-95">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb11-96">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prp =</span> purrr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map2_dbl</span>(</span>
<span id="cb11-97">      target_pr,</span>
<span id="cb11-98">      params,</span>
<span id="cb11-99">      \(.target_pr, .params) {</span>
<span id="cb11-100">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pgamma</span>(</span>
<span id="cb11-101">          .target_pr, </span>
<span id="cb11-102">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape =</span> .params<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>shape, </span>
<span id="cb11-103">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rate =</span> .params<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>rate,</span>
<span id="cb11-104">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lower.tail =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span></span>
<span id="cb11-105">        )</span>
<span id="cb11-106">      }</span>
<span id="cb11-107">    )</span>
<span id="cb11-108">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb11-109">  tidyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest_wider</span>(params)</span></code></pre></div>
</details>
</div>
<div class="cell">
<details open="">
<summary>Approach 3 output for Maddison</summary>
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1">maddison_prp_approach3 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(player, prior_pr, target_pr, prp)</span>
<span id="cb12-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 1 × 4</span></span>
<span id="cb12-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;   player         prior_pr target_pr    prp</span></span>
<span id="cb12-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;   &lt;chr&gt;             &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span id="cb12-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 1 James Maddison     1.38     0.797 0.0469</span></span></code></pre></div>
</details>
</div>
<p>We see that Maddison’s 2023/24 <img src="https://latex.codecogs.com/png.latex?PR_%7Bp,%5Ctext%7Btarget%7D%7D"> ratio of 0.797 (or worse) is about a 5th percentile outcome given his prior shot history.</p>
<p>To gain some intuition around this approach, we can plot out the Gamma distributed estimate of Maddison’s <img src="https://latex.codecogs.com/png.latex?PR_p">. The result is a histogram that looks not all that dissimilar to the one from before with resampled shots, just much smoother (since this is a “parametric” approach).</p>
<p><img src="https://tonyelhabr.rbind.io/posts/xg-likelihood/maddison_prp_approach3.png" class="img-fluid"></p>
<p>As with approach 2, we should check to see what the distribution of underperforming unlikeliness looks like–we should expect to see a somewhat uniform distribution.</p>
<div class="cell">
<details>
<summary>Approach 3 for all players</summary>
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1">all_gamma_pr <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> np_shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb13-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">estimate_gamma_distributed_pr</span>(</span>
<span id="cb13-3">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">players =</span> all_players_to_evaluate<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>player,</span>
<span id="cb13-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">target_season_end_year =</span> TARGET_SEASON_END_YEAR</span>
<span id="cb13-5">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb13-6">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inner_join</span>(</span>
<span id="cb13-7">    wide_player_np_shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb13-8">      dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(</span>
<span id="cb13-9">        player_id <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> all_players_to_evaluate<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>player_id</span>
<span id="cb13-10">      ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb13-11">      dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(</span>
<span id="cb13-12">        player,</span>
<span id="cb13-13">        prior_pr,</span>
<span id="cb13-14">        target_pr</span>
<span id="cb13-15">      ),</span>
<span id="cb13-16">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(player)</span>
<span id="cb13-17">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb13-18">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(player)</span>
<span id="cb13-19"></span>
<span id="cb13-20">all_prp_approach3 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> all_gamma_pr <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb13-21">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb13-22">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prp =</span> purrr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map2_dbl</span>(</span>
<span id="cb13-23">      target_pr,</span>
<span id="cb13-24">      params,</span>
<span id="cb13-25">      \(.target_pr, .params) {</span>
<span id="cb13-26">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pgamma</span>(</span>
<span id="cb13-27">          .target_pr, </span>
<span id="cb13-28">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape =</span> .params<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>shape, </span>
<span id="cb13-29">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rate =</span> .params<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>rate,</span>
<span id="cb13-30">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lower.tail =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span></span>
<span id="cb13-31">        )</span>
<span id="cb13-32">      }</span>
<span id="cb13-33">    )</span>
<span id="cb13-34">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb13-35">  tidyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest_wider</span>(params) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb13-36">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(prp)</span></code></pre></div>
</details>
</div>
<p><img src="https://tonyelhabr.rbind.io/posts/xg-likelihood/all_prp_approach3.png" class="img-fluid"></p>
<p>This histogram has a bit more distortion than our resampling approach, so perhaps it’s a little less calibrated.</p>
<p>Looking at the top 10 strongest underperformers, 2 of the names here–<a href="https://fbref.com/en/players/64f69877/Kevin-Volland">Volland</a> <a href="https://fbref.com/en/players/0a447501/Antonio-Sanabria">Sanabria</a>–are shared with approach 2’s top 10, and 7 are shared with approach 1’s top 10.</p>
<div class="cell">
<details open="">
<summary>Approach 3 output, top 10 underperforming players</summary>
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1">all_prp_approach3 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(player, prior_pr, target_pr, prp)</span>
<span id="cb14-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 10 × 4</span></span>
<span id="cb14-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    player           prior_pr target_pr      prp</span></span>
<span id="cb14-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    &lt;chr&gt;               &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;</span></span>
<span id="cb14-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  1 Ciro Immobile        1.23     0.503 0.000238</span></span>
<span id="cb14-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  2 Giovanni Simeone     1.03     0.306 0.000248</span></span>
<span id="cb14-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  3 Adrien Thomasson     1.18     0.282 0.000346</span></span>
<span id="cb14-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  4 Wahbi Khazri         1.11     0.322 0.000604</span></span>
<span id="cb14-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  5 Kevin Volland        1.18     0.388 0.00132 </span></span>
<span id="cb14-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  6 Nabil Fekir          1.14     0.490 0.00256 </span></span>
<span id="cb14-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  7 Fabián Ruiz Peña     1.67     0.510 0.00271 </span></span>
<span id="cb14-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  8 Antonio Sanabria     1.05     0.380 0.00796 </span></span>
<span id="cb14-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  9 Téji Savanier        1.42     0.548 0.0103  </span></span>
<span id="cb14-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 10 Jordan Veretout      1.16     0.360 0.0105</span></span></code></pre></div>
</details>
</div>
<p>We can visually check the consistency of the results from this method with the prior two with scatter plots of the estimated performance ratio percentile from each.</p>
<p><img src="https://tonyelhabr.rbind.io/posts/xg-likelihood/all_prp.png" class="img-fluid"></p>
<p>If two of the approaches were perfectly in agreement, then each point, representing one of the 602 evaluated players, would fall along the 45-degree slope 1 line.</p>
<p>With that in mind, we can see that approach 3 is more <strong>precise</strong> agrees with approach 1, although approach 3 tends to assign slightly higher percentiles to players on the whole. The results from approaches 2 and 3 also have a fair degree of agreement, and the results are more uniformly calibrated.</p>
<section id="discussion-2" class="level4">
<h4 class="anchored" data-anchor-id="discussion-2">Discussion</h4>
<ul>
<li><strong>Parametric Nature</strong>: The reliance on a Gamma distribution for modeling a player’s performance is both a strength and a limitation. The Gamma distribution is apt for positive, skewed continuous variables, making it suitable for modeling goals-to-xG ratios. However, the dependency on a single distribution type may restrict the scope of analysis.</li>
<li><strong>Sensitivity to Distribution Parameters</strong>: The outcomes of this methodology are highly sensitive to the parameters defining each player’s Gamma distribution. Small adjustments in shape or rate parameters can significantly alter the distribution, causing substantial shifts in the percentile outcomes of player performances. This sensitivity underscores the need for careful parameter selection and calibration.</li>
<li><strong>Flexibility of the Model</strong>: Despite its sensitivity, the Gamma distribution offers considerable flexibility. It allows for fine-tuning of the model to better fit the data, which can be advantageous for capturing the nuances of different players’ shot profiles.</li>
</ul>
</section>
</section>
</section>
</section>
<section id="conclusion" class="level1">
<h1>Conclusion</h1>
<p>Here’s a summary of the biggest pros and cons of each approach, along with the result for Maddison.</p>
<table class="table">
<colgroup>
<col style="width: 6%">
<col style="width: 24%">
<col style="width: 10%">
<col style="width: 29%">
<col style="width: 29%">
</colgroup>
<thead>
<tr class="header">
<th>Approach</th>
<th>Description</th>
<th>Biggest Pro</th>
<th>Biggest Con</th>
<th>Maddison 2023/24 Underperformance Unlikeliness</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>Percentile Ranking</td>
<td>customizable</td>
<td>sensitive to the choice of players to evaluate</td>
<td>2nd percentile</td>
</tr>
<tr class="even">
<td>2</td>
<td>Resampling</td>
<td>non-parametric</td>
<td>limited by player’s shot history</td>
<td>11th percentile</td>
</tr>
<tr class="odd">
<td>3</td>
<td>Cumulative Distribution Function (CDF)</td>
<td>flexibility<sup>6</sup></td>
<td>sensitive to choice of distribution parameters</td>
<td>5th percentile</td>
</tr>
</tbody>
</table>
<p>I personally prefer either the second or third approach. In practice, perhaps the best thing to do is take an ensemble average of each approach, as they each have their pros and cons.</p>
<section id="potential-future-research" class="level2">
<h2 class="anchored" data-anchor-id="potential-future-research">Potential Future Research</h2>
<ol type="1">
<li><strong>Can these approaches be applied to teams or managers to understand the unlikeliness of their season-long outcomes?</strong></li>
</ol>
<p>I think the answer is “yes”, for the resampling approach. The non-parametric nature of resampling makes it easy to translate to other “levels of aggregation”, i.e.&nbsp;a set of players under a manager or playing as a team.</p>
<ol start="2" type="1">
<li><strong>Can we accurately attribute a percentage of underperformance to skill and luck?</strong></li>
</ol>
<p>Eh, I don’t know about “accurately”, especially at the player-level.The <a href="https://en.wikipedia.org/wiki/Coefficient_of_determination">R-squared</a> of <a href="https://www.americansocceranalysis.com/home/2023/8/28/the-replication-project-measuring-shooting-overperformance">year-over-year player-level G / xG ratios is nearly zero</a>. If we equate “skill” to “percent of variance explained in year-over-year correlations of a measure (i.e.&nbsp;G / xG)”, then I suppose the answer is that basically 0% of seasonal over- or under-performance is due to innate factors; rather, we’d attribute all variation to “luck” (assuming that their “skill” and “luck” are the only factors that can explain residuals). That’s not all that compelling, although it may be the reality.</p>
<p><a href="../../posts/soccer-meta-analytics/">My prior work on “meta-metrics” for soccer</a> perhaps has a more compelling answer. The “stability” measure defined in that post for <img src="https://latex.codecogs.com/png.latex?G%20/%20xG"> comes out to about 70% (out of 100%).</p>
</section>
</section>
<section id="appendix" class="level1">
<h1>Appendix</h1>
<section id="approach-0-t-test" class="level3">
<h3 class="anchored" data-anchor-id="approach-0-t-test">Approach 0: <img src="https://latex.codecogs.com/png.latex?t">-test</h3>
<p>If you have some background in statistics, applying a <a href="https://en.wikipedia.org/wiki/Student%27s_t-test"><img src="https://latex.codecogs.com/png.latex?t">-test</a> (using shot-weighted averages and standard deviations) may be an approach that comes to mind.</p>
<div class="cell">
<details>
<summary>Approach 0</summary>
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1">prp_approach0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> player_season_np_shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb15-2">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">semi_join</span>(</span>
<span id="cb15-3">    all_players_to_evaluate <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(player_id),</span>
<span id="cb15-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(player_id)</span>
<span id="cb15-5">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb15-6">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(season_end_year <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> TARGET_SEASON_END_YEAR) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb15-7">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(</span>
<span id="cb15-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(player),</span>
<span id="cb15-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mean =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">weighted.mean</span>(pr, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">w =</span> shots),</span>
<span id="cb15-10">    <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## could also use a function like Hmisc::wtd.var for weighted variance</span></span>
<span id="cb15-11">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sd =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (pr <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">weighted.mean</span>(pr, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">w =</span> shots))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(shots))</span>
<span id="cb15-12">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb15-13">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inner_join</span>(</span>
<span id="cb15-14">    wide_player_np_shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb15-15">      dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(player, prior_pr, target_pr),</span>
<span id="cb15-16">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(player)</span>
<span id="cb15-17">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb15-18">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb15-19">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">z_score =</span> (target_pr <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> mean) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> sd,</span>
<span id="cb15-20">    <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## multiply by 2 for a two-sided t-test</span></span>
<span id="cb15-21">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prp =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pnorm</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abs</span>(z_score))</span>
<span id="cb15-22">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb15-23">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(mean, sd)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb15-24">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(player)</span></code></pre></div>
</details>
</div>
<div class="cell">
<details open="">
<summary>Approach 0 output</summary>
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1">prp_approach0 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb16-2">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(player <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'James Maddison'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb16-3">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(player, prior_pr, target_pr, prp)</span>
<span id="cb16-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 1 × 4</span></span>
<span id="cb16-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;   player         prior_pr target_pr    prp</span></span>
<span id="cb16-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;   &lt;chr&gt;             &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span id="cb16-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 1 James Maddison     1.38     0.797 0.0543</span></span></code></pre></div>
</details>
</div>
<p>In reality, this isn’t giving us a percentage of unlikelihood of the outcome. Rather, the p-value measures the probability of underformance as extreme as the underperformance observed in 2023/24 if the null hypothesis is true. The null hypothesis in this case would be that there is no significant difference between the player’s actual <img src="https://latex.codecogs.com/png.latex?PR_p"> in the 2023/24 season and the distribution of performance ratios observed in previous seasons.</p>



</section>
</section>


<div class="quarto-listing quarto-listing-container-default" id="listing-listing">
<div class="list quarto-listing-default">

</div>
<div class="listing-no-matching d-none">
No matching items
</div>
</div><div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>I only consider non-penalty xG and goals for this post. The ability to score penalties at a high success rate is generally seen as a different skill set than the ability to score goals in open play.↩︎</p></li>
<li id="fn2"><p>The raw difference between goals and xG is a reasonable measure of shooting performance, but it can “hide” shot volume. Is it fair to compare a player who takes 100 shots in a year and scores 12 goals on 10 xG with a player who takes 10 shots and scores 3 goals on 1 xG? The raw difference is +2 in both cases, indicating no difference in the shooting performance for the two players. However, their <img src="https://latex.codecogs.com/png.latex?PR_p"> would be 1.2 and 3 respectively, hinting at the former player’s small sample size.↩︎</p></li>
<li id="fn3"><p>The weighting emphasizes scenarios where a veteran player, typically overperforming or at worst neutral, suddenly underperforms, as opposed to a second-year player experiencing similar downturns.↩︎</p></li>
<li id="fn4"><p>Percentiles greater than 50% generally correspond with players who have overperformed, so really the bottom 50% are the players we’re looking at when we’re considering underperformance.↩︎</p></li>
<li id="fn5"><p><img src="https://latex.codecogs.com/png.latex?N_p"> should be set equal to the number of shots a player has taken in the target season. <img src="https://latex.codecogs.com/png.latex?R"> should be set to some fairly large number, so as to achieve stability in the results.↩︎</p></li>
<li id="fn6"><p>Well, it’s “flexible” to the extent that a statistical distribution can be flexible.↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>r</category>
  <category>soccer</category>
  <guid>https://tonyelhabr.rbind.io/posts/xg-likelihood/index.html</guid>
  <pubDate>Sun, 05 May 2024 05:00:00 GMT</pubDate>
  <media:content url="https://tonyelhabr.rbind.io/posts/xg-likelihood/maddison_prp_approach3.png" medium="image" type="image/png" height="96" width="144"/>
</item>
<item>
  <title>Ball Progression is All You Need</title>
  <dc:creator>Tony ElHabr</dc:creator>
  <link>https://tonyelhabr.rbind.io/posts/ball-progression-epv/index.html</link>
  <description><![CDATA[ 



<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>I’ve written a lot about expected goals (xG) in soccer, but I haven’t yet talked much about <a href="https://statsbomb.com/soccer-metrics/possession-value-models-explained/">possession value (PV) models</a><sup>1</sup>, another big topic in soccer analytics. What are they? Well, every PV model is different, but they all generally try to assign value to every on-ball action on the pitch. Such a model can help inform decisions about how to improve player and team performance.</p>
<p>I heard someone recently say something like “PV models in soccer basically come down to ball progression”. That’s an interesting thought, and I add a hunch that it probably isn’t too wrong.</p>
<p>One way of getting at that idea is to look at how your PV model treats incomplete passes. Does it say that all long passes are “good”? What is the importance of the starting and end points of the pass? How does PV for an unsuccessful pass compare to a successful one, holding all else equal?</p>
<p>I attempt to answer some of these questions with <a href="https://dtai.cs.kuleuven.be/sports/vaep">a VAEP model</a>–an <a href="https://fivethirtyeight.com/features/possession-is-the-puzzle-of-soccer-analytics-these-models-are-trying-to-solve-it/">open-source PV model</a>.<sup>2</sup><sup>3</sup></p>
</section>
<section id="possession-value-pv-for-passes" class="level1">
<h1>Possession Value (PV) for Passes</h1>
<section id="completed-passes" class="level2">
<h2 class="anchored" data-anchor-id="completed-passes">Completed Passes</h2>
<p>We’ll want to eventually look at the PV of incomplete passes, but it’s probably easier to start with completed passes, as we have a pretty strong intuition about them–pass the ball successfully closer to the goal, and you’re most likely helping your team (i.e.&nbsp;positive PV).</p>
<section id="from-one-spot-to-anywhere-on-the-pitch" class="level3">
<h3 class="anchored" data-anchor-id="from-one-spot-to-anywhere-on-the-pitch">From One Spot, To Anywhere on the Pitch</h3>
<p>In the interactive 8x12 pitch below, the blue cell illustrates where a pass is made, and the colored cells illustrate the average PV associated with all historicalLy successful passes made to that area. Hovering over a cell shows the PV value above the pitch as well.<sup>4</sup></p>
<p>Overall, I’d say that this illustration matches intuition–forward completed passes into the final third should be assigned a non-trivial positive value.</p>
<div class="cell" data-include="true">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb1" data-startfrom="1018" data-source-offset="0" style="background: #f1f3f5;"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1017;"><span id="cb1-1018">{</span>
<span id="cb1-1019">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> chart <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">create</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"div"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"background-color"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"8f8f8f"</span>)</span>
<span id="cb1-1020">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> title <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> chart<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"div"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"heatmap-title-complete-empirical"</span>)</span>
<span id="cb1-1021">  title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"p"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">html</span>(<span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">`PV: &lt;span id='pv-value-complete-empirical'&gt;0&lt;/span&gt;`</span>)</span>
<span id="cb1-1022">  chart<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"div"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"heatmap-complete-empirical"</span>)</span>
<span id="cb1-1023"></span>
<span id="cb1-1024">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> legendSwatchContainer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> chart<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"div"</span>)</span>
<span id="cb1-1025">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"heatmap-legend-complete-empirical"</span>)</span>
<span id="cb1-1026">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"display"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"flex"</span>)</span>
<span id="cb1-1027">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"flex-direction"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"column"</span>)</span>
<span id="cb1-1028">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"align-items"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"center"</span>)</span>
<span id="cb1-1029">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"width"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"100%"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-1030"></span>
<span id="cb1-1031">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> legendRange <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb1-1032">    <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(colorScaleCompleteRange)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-1033">    <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(colorScaleCompleteRange)</span>
<span id="cb1-1034">  ]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-1035">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> stepSize <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (legendRange[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> legendRange[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (swatchParams<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">num</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-1036">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> legendSwatches <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">range</span>(legendRange[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> legendRange[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> stepSize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> stepSize)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-1037">  legendSwatches[legendSwatches<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> legendRange[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-1038"></span>
<span id="cb1-1039">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> totalLegendWidth <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> swatchParams<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> swatchParams<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">num</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-1040"></span>
<span id="cb1-1041">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> swatchRow <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> legendSwatchContainer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"div"</span>)</span>
<span id="cb1-1042">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"display"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"flex"</span>)</span>
<span id="cb1-1043">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"justify-content"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"center"</span>)</span>
<span id="cb1-1044">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"width"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"100%"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-1045"></span>
<span id="cb1-1046">  swatchRow<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">selectAll</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"div"</span>)</span>
<span id="cb1-1047">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data</span>(legendSwatches)</span>
<span id="cb1-1048">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">enter</span>()</span>
<span id="cb1-1049">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"div"</span>)</span>
<span id="cb1-1050">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"width"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">${</span>swatchParams<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">px`</span>)</span>
<span id="cb1-1051">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"height"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">${</span>swatchParams<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">px`</span>)</span>
<span id="cb1-1052">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"background-color"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">=&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colorScaleComplete</span>(d))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-1053"></span>
<span id="cb1-1054">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> labelRow <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> legendSwatchContainer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"div"</span>)</span>
<span id="cb1-1055">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"display"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"flex"</span>)</span>
<span id="cb1-1056">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"justify-content"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"center"</span>)</span>
<span id="cb1-1057">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"width"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">${</span>totalLegendWidth<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">px`</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-1058"></span>
<span id="cb1-1059">  labelRow<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">selectAll</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"span"</span>)</span>
<span id="cb1-1060">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data</span>(colorScaleCompleteRange)</span>
<span id="cb1-1061">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">enter</span>()</span>
<span id="cb1-1062">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"span"</span>)</span>
<span id="cb1-1063">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">text</span>(d <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">=&gt;</span> {</span>
<span id="cb1-1064">      <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">===</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(colorScaleCompleteRange)) {</span>
<span id="cb1-1065">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" &lt;="</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-1066">      } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">===</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(colorScaleCompleteRange)) {</span>
<span id="cb1-1067">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&gt;= "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-1068">      }</span>
<span id="cb1-1069">      <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-1070">    })</span>
<span id="cb1-1071">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"flex"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">=&gt;</span> d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">===</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">null</span>)</span>
<span id="cb1-1072">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text-align"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"center"</span>)</span>
<span id="cb1-1073"></span>
<span id="cb1-1074">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> chart<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">node</span>()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-1075">}</span></code></pre></div>
</details>
<div id="fig-ojs-cell-1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<div id="ojs-cell-1" data-nodetype="expression">

</div>
<figcaption class="figure-caption">Figure&nbsp;1: A heatmap showing the average possession value (PV) of historically completed passes from the center spot (annotated in blue) to all areas on the pitch. The relative frequency of successful passes from the center spot to each other cell is shown as a percentage. The exact PV value associated with a complete pass ending at the hover point can be viewed above the pitch. Black cells represent areas to which successful passes from the center spot have never been made.</figcaption>
</figure>
</div>
</div>
<div class="cell">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb2" data-startfrom="1081" data-source-offset="0" style="background: #f1f3f5;"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1080;"><span id="cb2-1081">{</span>
<span id="cb2-1082">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> heatmap_complete_empirical <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d3_soccer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">heatmap</span>(pitch)</span>
<span id="cb2-1083">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colorScale</span>(colorScaleComplete)</span>
<span id="cb2-1084">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">enableInteraction</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">true</span>)</span>
<span id="cb2-1085">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">onSelect</span>((x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> v) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">=&gt;</span> {</span>
<span id="cb2-1086">      <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> cappedValue <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Math</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Math</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-1087">      d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#pv-value-complete-empirical"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">text</span>(cappedValue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">toFixed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-1088">    })</span>
<span id="cb2-1089">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">parent_el</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#heatmap-complete-empirical"</span>)</span>
<span id="cb2-1090">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">interpolate</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">false</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-1091"></span>
<span id="cb2-1092">  d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#heatmap-complete-empirical"</span>)</span>
<span id="cb2-1093">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">html</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span>
<span id="cb2-1094">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">datum</span>(complete_empirical_pv_data)</span>
<span id="cb2-1095">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">call</span>(heatmap_complete_empirical)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-1096"></span>
<span id="cb2-1097">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> svg <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#heatmap-complete-empirical"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"svg"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-1098"></span>
<span id="cb2-1099">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> cells <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> svg<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">selectAll</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".cell"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-1100"></span>
<span id="cb2-1101">  cells<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">each</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> i) {</span>
<span id="cb2-1102">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> cell <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-1103">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> bbox <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">getBBox</span>()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-1104"></span>
<span id="cb2-1105">    d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">parentNode</span>)</span>
<span id="cb2-1106">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text"</span>)</span>
<span id="cb2-1107">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> bbox<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> bbox<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb2-1108">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> bbox<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> bbox<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb2-1109">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text-anchor"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"middle"</span>)</span>
<span id="cb2-1110">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"alignment-baseline"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"central"</span>)</span>
<span id="cb2-1111">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"font-size"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"3px"</span>)</span>
<span id="cb2-1112">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pointer-events"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>)</span>
<span id="cb2-1113">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">text</span>((d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prop</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">toFixed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-1114">  })<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-1115"></span>
<span id="cb2-1116">  svg<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rect"</span>)</span>
<span id="cb2-1117">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> passStartParams<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x</span>)</span>
<span id="cb2-1118">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> passStartParams<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y</span>)</span>
<span id="cb2-1119">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"width"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> cellParams<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width</span>)</span>
<span id="cb2-1120">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"height"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> cellParams<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height</span>)</span>
<span id="cb2-1121">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"stroke"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"blue"</span>)</span>
<span id="cb2-1122">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fill"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>)</span>
<span id="cb2-1123">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"stroke-width"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1px"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-1124">}</span></code></pre></div>
</details>
<div class="cell-output cell-output-display hidden">
<div id="ojs-cell-2" data-nodetype="expression">

</div>
</div>
</div>
<p>Note that the gradient in the pitch above is for PV, not for the relative frequency of completed passes from the center spot, which is instead shown as overlayed text. While passes into the box from the center spot have really strong positive PV, they’re uncommon because defenders are generally looking to stop those kinds of threatening passes.</p>
<p>The gradient in the plot below illustrates the relative frequency of successful passes from the center spot directly.</p>
<div class="cell" data-include="true">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb3" data-startfrom="1134" data-source-offset="0" style="background: #f1f3f5;"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1133;"><span id="cb3-1134">{</span>
<span id="cb3-1135">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> chart <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">create</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"div"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"background-color"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"8f8f8f"</span>)</span>
<span id="cb3-1136">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> title <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> chart<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"div"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"heatmap-title-complete-empirical-prop"</span>)</span>
<span id="cb3-1137">  chart<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"div"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"heatmap-complete-empirical-prop"</span>)</span>
<span id="cb3-1138"></span>
<span id="cb3-1139">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> chart<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">node</span>()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb3-1140">}</span></code></pre></div>
</details>
<div id="fig-ojs-cell-3" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<div id="ojs-cell-3" data-nodetype="expression">

</div>
<figcaption class="figure-caption">Figure&nbsp;2: A heatmap where the gradient and text illustrate the relative frequency of historically successful passes from the center spot (annotated in blue) to all areas on the pitch. Black cells represent areas to which successful passes from the center spot have never been made.</figcaption>
</figure>
</div>
</div>
<div class="cell">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb4" data-startfrom="1146" data-source-offset="0" style="background: #f1f3f5;"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1145;"><span id="cb4-1146">{</span>
<span id="cb4-1147">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> colorScaleSeq <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scaleSequential</span>(d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">interpolateRgb</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gold"</span>))</span>
<span id="cb4-1148">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">domain</span>([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>])</span>
<span id="cb4-1149">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">clamp</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">true</span>)</span>
<span id="cb4-1150">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> heatmap_complete_empirical_prop <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d3_soccer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">heatmap</span>(pitch)</span>
<span id="cb4-1151">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colorScale</span>(colorScaleSeq)</span>
<span id="cb4-1152">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">enableInteraction</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">false</span>)</span>
<span id="cb4-1153">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">parent_el</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#heatmap-complete-empirical-prop"</span>)</span>
<span id="cb4-1154">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">interpolate</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">false</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-1155"></span>
<span id="cb4-1156">  d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#heatmap-complete-empirical-prop"</span>)</span>
<span id="cb4-1157">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">html</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span>
<span id="cb4-1158">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">datum</span>(complete_empirical_prop_data)</span>
<span id="cb4-1159">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">call</span>(heatmap_complete_empirical_prop)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-1160"></span>
<span id="cb4-1161">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> svg <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#heatmap-complete-empirical-prop"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"svg"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-1162"></span>
<span id="cb4-1163">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> cells <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> svg<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">selectAll</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".cell"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-1164"></span>
<span id="cb4-1165">  cells<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">each</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> i) {</span>
<span id="cb4-1166">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> cell <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-1167">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> bbox <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">getBBox</span>()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-1168"></span>
<span id="cb4-1169">    d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">parentNode</span>)</span>
<span id="cb4-1170">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text"</span>)</span>
<span id="cb4-1171">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> bbox<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> bbox<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb4-1172">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> bbox<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> bbox<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb4-1173">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text-anchor"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"middle"</span>)</span>
<span id="cb4-1174">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"alignment-baseline"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"central"</span>)</span>
<span id="cb4-1175">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"font-size"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"3px"</span>)</span>
<span id="cb4-1176">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pointer-events"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>)</span>
<span id="cb4-1177">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">text</span>((d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prop</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">toFixed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-1178">  })<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-1179"></span>
<span id="cb4-1180">  svg<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rect"</span>)</span>
<span id="cb4-1181">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> passStartParams<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x</span>)</span>
<span id="cb4-1182">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> passStartParams<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y</span>)</span>
<span id="cb4-1183">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"width"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> cellParams<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width</span>)</span>
<span id="cb4-1184">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"height"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> cellParams<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height</span>)</span>
<span id="cb4-1185">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"stroke"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"blue"</span>)</span>
<span id="cb4-1186">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fill"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>)</span>
<span id="cb4-1187">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"stroke-width"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1px"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-1188">}</span></code></pre></div>
</details>
<div class="cell-output cell-output-display hidden">
<div id="ojs-cell-4" data-nodetype="expression">

</div>
</div>
</div>
</section>
<section id="from-anywhere-on-the-pitch-to-anywhere-on-the-pitch" class="level3">
<h3 class="anchored" data-anchor-id="from-anywhere-on-the-pitch-to-anywhere-on-the-pitch">From Anywhere on the Pitch, To Anywhere on the Pitch</h3>
<p>Now, to give the full picture, the interactive pitch below dynamically updates to show the average PV values associated with a pass starting from <strong>any</strong> cell that you hover over. The minimum and maximum PV achieved with a successful pass from the hovered spot are shown in the text above the pitch.</p>
<div class="cell" data-include="true">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb5" data-startfrom="1198" data-source-offset="0" style="background: #f1f3f5;"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1197;"><span id="cb5-1198">{</span>
<span id="cb5-1199">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> chart <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">create</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"div"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"background-color"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"8f8f8f"</span>)</span>
<span id="cb5-1200">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> title <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> chart<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"div"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"heatmap-title-complete-empirical-nested"</span>)</span>
<span id="cb5-1201">  title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"p"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">html</span>(<span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">`min PV: &lt;span id='pv-min-complete-empirical-nested'&gt;0&lt;/span&gt;, max PV: &lt;span id='pv-max-complete-empirical-nested'&gt;0&lt;/span&gt;`</span>)</span>
<span id="cb5-1202">  chart<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"div"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"heatmap-complete-empirical-nested"</span>)</span>
<span id="cb5-1203">  </span>
<span id="cb5-1204">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> legendSwatchContainer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> chart<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"div"</span>)</span>
<span id="cb5-1205">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"heatmap-legend-complete-empirical-nested"</span>)</span>
<span id="cb5-1206">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"display"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"flex"</span>)</span>
<span id="cb5-1207">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"flex-direction"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"column"</span>)</span>
<span id="cb5-1208">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"align-items"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"center"</span>)</span>
<span id="cb5-1209">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"width"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"100%"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-1210">  </span>
<span id="cb5-1211">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> legendRange <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb5-1212">    <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(colorScaleCompleteRange)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-1213">    <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(colorScaleCompleteRange)</span>
<span id="cb5-1214">  ]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-1215">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> stepSize <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (legendRange[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> legendRange[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (swatchParams<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">num</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-1216">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> legendSwatches <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">range</span>(legendRange[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> legendRange[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> stepSize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> stepSize)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-1217">  legendSwatches[legendSwatches<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> legendRange[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-1218">  </span>
<span id="cb5-1219">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> totalLegendWidth <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> swatchParams<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> swatchParams<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">num</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-1220">  </span>
<span id="cb5-1221">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> swatchRow <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> legendSwatchContainer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"div"</span>)</span>
<span id="cb5-1222">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"display"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"flex"</span>)</span>
<span id="cb5-1223">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"justify-content"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"center"</span>)</span>
<span id="cb5-1224">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"width"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"100%"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-1225">  </span>
<span id="cb5-1226">  swatchRow<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">selectAll</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"div"</span>)</span>
<span id="cb5-1227">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data</span>(legendSwatches)</span>
<span id="cb5-1228">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">enter</span>()</span>
<span id="cb5-1229">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"div"</span>)</span>
<span id="cb5-1230">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"width"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">${</span>swatchParams<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">px`</span>)</span>
<span id="cb5-1231">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"height"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">${</span>swatchParams<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">px`</span>)</span>
<span id="cb5-1232">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"background-color"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">=&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colorScaleComplete</span>(d))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-1233">  </span>
<span id="cb5-1234">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> labelRow <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> legendSwatchContainer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"div"</span>)</span>
<span id="cb5-1235">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"display"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"flex"</span>)</span>
<span id="cb5-1236">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"justify-content"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"center"</span>)</span>
<span id="cb5-1237">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"width"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">${</span>totalLegendWidth<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">px`</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-1238">  </span>
<span id="cb5-1239">  </span>
<span id="cb5-1240">  labelRow<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">selectAll</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"span"</span>)</span>
<span id="cb5-1241">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data</span>(colorScaleCompleteRange)</span>
<span id="cb5-1242">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">enter</span>()</span>
<span id="cb5-1243">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"span"</span>)</span>
<span id="cb5-1244">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">text</span>(d <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">=&gt;</span> {</span>
<span id="cb5-1245">      <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">===</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(colorScaleCompleteRange)) {</span>
<span id="cb5-1246">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" &lt;="</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-1247">      } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">===</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(colorScaleCompleteRange)) {</span>
<span id="cb5-1248">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&gt;= "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-1249">      }</span>
<span id="cb5-1250">      <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-1251">    })</span>
<span id="cb5-1252">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"flex"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">=&gt;</span> d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">===</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">null</span>)</span>
<span id="cb5-1253">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text-align"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"center"</span>)</span>
<span id="cb5-1254">  </span>
<span id="cb5-1255">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> chart<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">node</span>()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb5-1256"></span>
<span id="cb5-1257">}</span></code></pre></div>
</details>
<div id="fig-ojs-cell-5" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<div id="ojs-cell-5" data-nodetype="expression">

</div>
<figcaption class="figure-caption">Figure&nbsp;3: A heatmap showing the average possession value (PV) of historically completed pass from the hover spot to all areas on the pitch. The relative frequency of successful passes from the hover spot to each other cell is shown as a percentage. The highest and lowest PV values across all end points associated with a completed pass from the hover point are shown above the pitch. Black cells represent areas to which successful passes from the hover spot have never been made.</figcaption>
</figure>
</div>
</div>
<div class="cell">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb6" data-startfrom="1263" data-source-offset="0" style="background: #f1f3f5;"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1262;"><span id="cb6-1263">{  </span>
<span id="cb6-1264">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> heatmap_complete_empirical_nested <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d3_soccer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">heatmap</span>(pitch)</span>
<span id="cb6-1265">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colorScale</span>(d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scaleLinear</span>()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">domain</span>([<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">range</span>([<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>]))</span>
<span id="cb6-1266">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">enableInteraction</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">true</span>)</span>
<span id="cb6-1267">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">onSelect</span>((x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> v) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">=&gt;</span> {</span>
<span id="cb6-1268">      <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> rawMinValue <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">=&gt;</span> d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-1269">      <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> rawMaxValue <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">=&gt;</span> d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-1270">      <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> minValue <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Math</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(rawMinValue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-1271">      <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> maxValue <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Math</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(rawMaxValue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-1272">  </span>
<span id="cb6-1273">      d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#pv-min-complete-empirical-nested"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">text</span>(minValue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">toFixed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-1274">      d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#pv-max-complete-empirical-nested"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">text</span>(maxValue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">toFixed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-1275">      <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> cells <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d3</span>
<span id="cb6-1276">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#heatmap-complete-empirical-nested"</span>)</span>
<span id="cb6-1277">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">selectAll</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rect.cell"</span>)</span>
<span id="cb6-1278">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data</span>(v)</span>
<span id="cb6-1279">  </span>
<span id="cb6-1280">      cells<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">enter</span>()</span>
<span id="cb6-1281">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">merge</span>(cells)</span>
<span id="cb6-1282">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">=&gt;</span> d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x</span>)</span>
<span id="cb6-1283">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">=&gt;</span> d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y</span>)</span>
<span id="cb6-1284">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"width"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">=&gt;</span> d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width</span>)</span>
<span id="cb6-1285">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"height"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">=&gt;</span> d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height</span>)</span>
<span id="cb6-1286">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fill"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">=&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colorScaleComplete</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value</span>))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-1287"></span>
<span id="cb6-1288">      d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#heatmap-complete-empirical-nested"</span>)</span>
<span id="cb6-1289">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">selectAll</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text"</span>)</span>
<span id="cb6-1290">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">remove</span>()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-1291">        </span>
<span id="cb6-1292">      cells<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">each</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> i) {</span>
<span id="cb6-1293">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> cell <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">parentNode</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-1294">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> bbox <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">getBBox</span>()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-1295">        cell<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text"</span>)</span>
<span id="cb6-1296">          <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> bbox<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> bbox<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb6-1297">          <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> bbox<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> bbox<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb6-1298">          <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text-anchor"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"middle"</span>)</span>
<span id="cb6-1299">          <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"alignment-baseline"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"central"</span>)</span>
<span id="cb6-1300">          <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"font-size"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"3px"</span>)</span>
<span id="cb6-1301">          <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pointer-events"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>)</span>
<span id="cb6-1302">          <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">text</span>((d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prop</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">toFixed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-1303">      })<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-1304">      </span>
<span id="cb6-1305">      cells<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exit</span>()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">remove</span>()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-1306"></span>
<span id="cb6-1307">      d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#heatmap-complete-empirical-nested"</span>)</span>
<span id="cb6-1308">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">selectAll</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rect.cell"</span>)</span>
<span id="cb6-1309">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data</span>(complete_empirical_nested_pv_data)</span>
<span id="cb6-1310"></span>
<span id="cb6-1311">    })</span>
<span id="cb6-1312">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">parent_el</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#heatmap-complete-empirical-nested"</span>)</span>
<span id="cb6-1313">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">interpolate</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">false</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-1314">  </span>
<span id="cb6-1315">  d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#heatmap-complete-empirical-nested"</span>)</span>
<span id="cb6-1316">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">html</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span>
<span id="cb6-1317">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">datum</span>(complete_empirical_nested_pv_data)</span>
<span id="cb6-1318">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">call</span>(heatmap_complete_empirical_nested)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb6-1319">}</span></code></pre></div>
</details>
<div class="cell-output cell-output-display hidden">
<div id="ojs-cell-6" data-nodetype="expression">

</div>
</div>
</div>
<p>There are several takeaways one might have from this view, but the big one that I have is this: As you move your mouse (i.e.&nbsp;the starting point of the pass) from the defender’s box to the opponent’s box, the consolidated green box of +0.025 PV doesn’t change much. It stays basically at around the final quarter of the pitch. So you can’t just complete a 30-yard pass from the top of your own box progressing the ball towards the middle of the pitch and expect to get anywhere near the same PV as completing a 30-yard pass from the center of the pitch to near the opponent’s 18-yard box. The end point really matters.</p>
<p>This conclusion gets at our primary question–“Are all long passes good?”–to which the answer so far is “not quite” (in the sense that “good” is more than just “positive PV” for completed passes). A long completed pass in your own half doesn’t boast a huge positive PV, unless it ends up near the opponent’s box.</p>
<p>To get a more complete perspective, we’ll plot out the PV for incomplete passes to see what the answer is there.</p>
</section>
</section>
<section id="incomplete-passes" class="level2">
<h2 class="anchored" data-anchor-id="incomplete-passes">Incomplete Passes</h2>
<section id="from-one-spot-to-anywhere-on-the-pitch-1" class="level3">
<h3 class="anchored" data-anchor-id="from-one-spot-to-anywhere-on-the-pitch-1">From One Spot, To Anywhere on the Pitch</h3>
<p>Let’s start with an example again, looking at PV for unsuccessful passes from the center spot.</p>
<div class="cell" data-include="true">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb7" data-startfrom="1337" data-source-offset="0" style="background: #f1f3f5;"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1336;"><span id="cb7-1337">{</span>
<span id="cb7-1338">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> chart <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">create</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"div"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"background-color"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"8f8f8f"</span>)</span>
<span id="cb7-1339">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> title <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> chart<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"div"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"heatmap-title-incomplete-empirical"</span>)</span>
<span id="cb7-1340">  title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"p"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">html</span>(<span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">`PV: &lt;span id='pv-value-incomplete-empirical'&gt;0&lt;/span&gt;`</span>)</span>
<span id="cb7-1341">  chart<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"div"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"heatmap-incomplete-empirical"</span>)</span>
<span id="cb7-1342"></span>
<span id="cb7-1343">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> legendSwatchContainer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> chart<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"div"</span>)</span>
<span id="cb7-1344">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"heatmap-legend-incomplete-empirical"</span>)</span>
<span id="cb7-1345">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"display"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"flex"</span>)</span>
<span id="cb7-1346">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"flex-direction"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"column"</span>)</span>
<span id="cb7-1347">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"align-items"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"center"</span>)</span>
<span id="cb7-1348">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"width"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"100%"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-1349"></span>
<span id="cb7-1350">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> legendRange <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb7-1351">    <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(colorScaleIncompleteRange)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb7-1352">    <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(colorScaleIncompleteRange)</span>
<span id="cb7-1353">  ]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-1354">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> stepSize <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (legendRange[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> legendRange[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (swatchParams<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">num</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-1355">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> legendSwatches <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">range</span>(legendRange[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> legendRange[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> stepSize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> stepSize)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-1356">  legendSwatches[legendSwatches<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> legendRange[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-1357"></span>
<span id="cb7-1358">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> totalLegendWidth <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> swatchParams<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> swatchParams<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">num</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-1359"></span>
<span id="cb7-1360">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> swatchRow <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> legendSwatchContainer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"div"</span>)</span>
<span id="cb7-1361">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"display"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"flex"</span>)</span>
<span id="cb7-1362">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"justify-content"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"center"</span>)</span>
<span id="cb7-1363">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"width"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"100%"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-1364"></span>
<span id="cb7-1365">  swatchRow<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">selectAll</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"div"</span>)</span>
<span id="cb7-1366">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data</span>(legendSwatches)</span>
<span id="cb7-1367">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">enter</span>()</span>
<span id="cb7-1368">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"div"</span>)</span>
<span id="cb7-1369">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"width"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">${</span>swatchParams<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">px`</span>)</span>
<span id="cb7-1370">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"height"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">${</span>swatchParams<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">px`</span>)</span>
<span id="cb7-1371">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"background-color"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">=&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colorScaleIncomplete</span>(d))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-1372"></span>
<span id="cb7-1373">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> labelRow <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> legendSwatchContainer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"div"</span>)</span>
<span id="cb7-1374">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"display"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"flex"</span>)</span>
<span id="cb7-1375">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"justify-content"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"center"</span>)</span>
<span id="cb7-1376">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"width"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">${</span>totalLegendWidth<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">px`</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-1377"></span>
<span id="cb7-1378">  labelRow<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">selectAll</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"span"</span>)</span>
<span id="cb7-1379">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data</span>(colorScaleIncompleteRange)</span>
<span id="cb7-1380">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">enter</span>()</span>
<span id="cb7-1381">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"span"</span>)</span>
<span id="cb7-1382">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">text</span>(d <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">=&gt;</span> {</span>
<span id="cb7-1383">      <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">===</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(colorScaleIncompleteRange)) {</span>
<span id="cb7-1384">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" &lt;="</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-1385">      } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">===</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(colorScaleIncompleteRange)) {</span>
<span id="cb7-1386">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&gt;= "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-1387">      }</span>
<span id="cb7-1388">      <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-1389">    })</span>
<span id="cb7-1390">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"flex"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">=&gt;</span> d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">===</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">null</span>)</span>
<span id="cb7-1391">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text-align"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"center"</span>)</span>
<span id="cb7-1392"></span>
<span id="cb7-1393">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> chart<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">node</span>()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb7-1394">}</span></code></pre></div>
</details>
<div id="fig-ojs-cell-7" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<div id="ojs-cell-7" data-nodetype="expression">

</div>
<figcaption class="figure-caption">Figure&nbsp;4: A heatmap showing the average possession value (PV) of historically incomplete passes from the center spot (annotated in blue) to all areas of the pitch. The relative frequency of unsuccessful passes from the center spot to each other cell is shown as a percentage. The exact PV value associated with an incomplete pass ending at the hover point can be viewed above the pitch. Black cells represent areas to which unsuccessful passes from the center spot have never been made.</figcaption>
</figure>
</div>
</div>
<div class="cell">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb8" data-startfrom="1400" data-source-offset="0" style="background: #f1f3f5;"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1399;"><span id="cb8-1400">{</span>
<span id="cb8-1401">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> heatmap_incomplete_empirical <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d3_soccer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">heatmap</span>(pitch)</span>
<span id="cb8-1402">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colorScale</span>(colorScaleIncomplete)</span>
<span id="cb8-1403">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">enableInteraction</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">true</span>)</span>
<span id="cb8-1404">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">onSelect</span>((x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> v) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">=&gt;</span> {</span>
<span id="cb8-1405">      <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> cappedValue <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Math</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Math</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-1406">      d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#pv-value-incomplete-empirical"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">text</span>(cappedValue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">toFixed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-1407">    })</span>
<span id="cb8-1408">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">parent_el</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#heatmap-incomplete-empirical"</span>)</span>
<span id="cb8-1409">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">interpolate</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">false</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-1410"></span>
<span id="cb8-1411">  d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#heatmap-incomplete-empirical"</span>)</span>
<span id="cb8-1412">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">html</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span>
<span id="cb8-1413">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">datum</span>(incomplete_empirical_pv_data)</span>
<span id="cb8-1414">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">call</span>(heatmap_incomplete_empirical)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-1415"></span>
<span id="cb8-1416">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> svg <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#heatmap-incomplete-empirical"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"svg"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-1417"></span>
<span id="cb8-1418">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> cells <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> svg<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">selectAll</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".cell"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-1419"></span>
<span id="cb8-1420">  cells<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">each</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> i) {</span>
<span id="cb8-1421">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> cell <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-1422">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> bbox <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">getBBox</span>()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-1423"></span>
<span id="cb8-1424">    d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">parentNode</span>)</span>
<span id="cb8-1425">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text"</span>)</span>
<span id="cb8-1426">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> bbox<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> bbox<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb8-1427">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> bbox<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> bbox<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb8-1428">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text-anchor"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"middle"</span>)</span>
<span id="cb8-1429">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"alignment-baseline"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"central"</span>)</span>
<span id="cb8-1430">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"font-size"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"3px"</span>)</span>
<span id="cb8-1431">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pointer-events"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>)</span>
<span id="cb8-1432">      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">text</span>((d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prop</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">toFixed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-1433">  })<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-1434"></span>
<span id="cb8-1435">  svg<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rect"</span>)</span>
<span id="cb8-1436">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> passStartParams<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x</span>)</span>
<span id="cb8-1437">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> passStartParams<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y</span>)</span>
<span id="cb8-1438">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"width"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> cellParams<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width</span>)</span>
<span id="cb8-1439">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"height"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> cellParams<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height</span>)</span>
<span id="cb8-1440">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"stroke"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"blue"</span>)</span>
<span id="cb8-1441">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fill"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>)</span>
<span id="cb8-1442">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"stroke-width"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1px"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-1443">}</span></code></pre></div>
</details>
<div class="cell-output cell-output-display hidden">
<div id="ojs-cell-8" data-nodetype="expression">

</div>
</div>
</div>
<p>I think this grid is fairly intuitive.<sup>5</sup> Incomplete passes backward have fairly negative PVs, as those are turnovers probably setting up the opponent for good scoring opportunities. Incomplete passes forward mostly have neutral PVs, with some spots on the pitch having slightly positive PVs. Notably, a positive PV for an incomplete pass is a non-trivial revelation.</p>
<p>Some of the positive PV cells include the area at the top of the 18-yard box, i.e.&nbsp;<a href="https://www.youtube.com/watch?v=_EFtACGzD7E">“zone 14”</a>. You can make the argument that the “risk” of losing possession to passes to zone 14 is justified from the potential to take a shot. Further, a loss of possession in this area can be advantageous, as it leaves the opponent likely in a vulnerable position.</p>
</section>
<section id="from-anywhere-on-the-pitch-to-anywhere-on-the-pitch-1" class="level3">
<h3 class="anchored" data-anchor-id="from-anywhere-on-the-pitch-to-anywhere-on-the-pitch-1">From Anywhere on the Pitch, To Anywhere on the Pitch</h3>
<p>Now let’s scale up our pass PV grid to all incomplete passes. As with the dynamic successful pass heatmap, hovering over a cell will show PV associated with unsuccessful passes from that point on the pitch.</p>
<div class="cell" data-include="true">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb9" data-startfrom="1459" data-source-offset="0" style="background: #f1f3f5;"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1458;"><span id="cb9-1459">{</span>
<span id="cb9-1460">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> chart <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">create</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"div"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"background-color"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"8f8f8f"</span>)</span>
<span id="cb9-1461">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> title <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> chart<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"div"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"heatmap-title-incomplete-empirical-nested"</span>)</span>
<span id="cb9-1462">  title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"p"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">html</span>(<span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">`min PV: &lt;span id='pv-min-incomplete-empirical-nested'&gt;0&lt;/span&gt;, max PV: &lt;span id='pv-max-incomplete-empirical-nested'&gt;0&lt;/span&gt;`</span>)</span>
<span id="cb9-1463">  chart<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"div"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"heatmap-incomplete-empirical-nested"</span>)</span>
<span id="cb9-1464">  </span>
<span id="cb9-1465">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> legendSwatchContainer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> chart<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"div"</span>)</span>
<span id="cb9-1466">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"heatmap-legend-incomplete-empirical-nested"</span>)</span>
<span id="cb9-1467">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"display"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"flex"</span>)</span>
<span id="cb9-1468">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"flex-direction"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"column"</span>)</span>
<span id="cb9-1469">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"align-items"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"center"</span>)</span>
<span id="cb9-1470">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"width"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"100%"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-1471">  </span>
<span id="cb9-1472">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> legendRange <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb9-1473">    <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(colorScaleIncompleteRange)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb9-1474">    <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(colorScaleIncompleteRange)</span>
<span id="cb9-1475">  ]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-1476">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> stepSize <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (legendRange[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> legendRange[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (swatchParams<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">num</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-1477">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> legendSwatches <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">range</span>(legendRange[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> legendRange[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> stepSize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> stepSize)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-1478">  legendSwatches[legendSwatches<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> legendRange[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-1479">  </span>
<span id="cb9-1480">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> totalLegendWidth <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> swatchParams<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> swatchParams<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">num</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-1481">  </span>
<span id="cb9-1482">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> swatchRow <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> legendSwatchContainer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"div"</span>)</span>
<span id="cb9-1483">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"display"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"flex"</span>)</span>
<span id="cb9-1484">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"justify-content"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"center"</span>)</span>
<span id="cb9-1485">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"width"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"100%"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-1486">  </span>
<span id="cb9-1487">  swatchRow<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">selectAll</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"div"</span>)</span>
<span id="cb9-1488">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data</span>(legendSwatches)</span>
<span id="cb9-1489">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">enter</span>()</span>
<span id="cb9-1490">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"div"</span>)</span>
<span id="cb9-1491">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"width"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">${</span>swatchParams<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">px`</span>)</span>
<span id="cb9-1492">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"height"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">${</span>swatchParams<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">px`</span>)</span>
<span id="cb9-1493">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"background-color"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">=&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colorScaleIncomplete</span>(d))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-1494">  </span>
<span id="cb9-1495">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> labelRow <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> legendSwatchContainer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"div"</span>)</span>
<span id="cb9-1496">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"display"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"flex"</span>)</span>
<span id="cb9-1497">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"justify-content"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"center"</span>)</span>
<span id="cb9-1498">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"width"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">${</span>totalLegendWidth<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">px`</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-1499">  </span>
<span id="cb9-1500">  labelRow<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">selectAll</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"span"</span>)</span>
<span id="cb9-1501">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data</span>(colorScaleIncompleteRange)</span>
<span id="cb9-1502">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">enter</span>()</span>
<span id="cb9-1503">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"span"</span>)</span>
<span id="cb9-1504">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">text</span>(d <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">=&gt;</span> {</span>
<span id="cb9-1505">      <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">===</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(colorScaleIncompleteRange)) {</span>
<span id="cb9-1506">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" &lt;="</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-1507">      } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">===</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(colorScaleIncompleteRange)) {</span>
<span id="cb9-1508">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&gt;= "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-1509">      }</span>
<span id="cb9-1510">      <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-1511">    })</span>
<span id="cb9-1512">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"flex"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">=&gt;</span> d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">===</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">null</span>)</span>
<span id="cb9-1513">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text-align"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"center"</span>)</span>
<span id="cb9-1514">  </span>
<span id="cb9-1515">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> chart<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">node</span>()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-1516">}</span></code></pre></div>
</details>
<div id="fig-ojs-cell-9" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<div id="ojs-cell-9" data-nodetype="expression">

</div>
<figcaption class="figure-caption">Figure&nbsp;5: A heatmap showing the average possession value (PV) of historically incomplete pass from the hover spot to all areas on the pitch. The relative frequency of successful passes from the center spot to each other cell is shown as a percentage. The highest and lowest PV values across all end points associated with an incomplete pass from the hover point are shown above the pitch. Black cells represent areas to which unsuccessful passes from the hover spot have never been made.</figcaption>
</figure>
</div>
</div>
<div class="cell">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb10" data-startfrom="1522" data-source-offset="0" style="background: #f1f3f5;"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1521;"><span id="cb10-1522">{  </span>
<span id="cb10-1523">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> heatmap_incomplete_empirical_nested <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d3_soccer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">heatmap</span>(pitch)</span>
<span id="cb10-1524">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colorScale</span>(d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scaleLinear</span>()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">domain</span>([<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">range</span>([<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>]))</span>
<span id="cb10-1525">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">enableInteraction</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">true</span>)</span>
<span id="cb10-1526">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">onSelect</span>((x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> v) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">=&gt;</span> {</span>
<span id="cb10-1527">      <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> rawMinValue <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">=&gt;</span> d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb10-1528">      <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> rawMaxValue <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">=&gt;</span> d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb10-1529">      <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> minValue <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Math</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(rawMinValue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb10-1530">      <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> maxValue <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Math</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(rawMaxValue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb10-1531">  </span>
<span id="cb10-1532">      d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'#pv-min-incomplete-empirical-nested'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">text</span>(minValue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">toFixed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb10-1533">      d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'#pv-max-incomplete-empirical-nested'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">text</span>(maxValue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">toFixed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb10-1534">      <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> cells <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d3</span>
<span id="cb10-1535">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#heatmap-incomplete-empirical-nested"</span>)</span>
<span id="cb10-1536">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">selectAll</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rect.cell"</span>)</span>
<span id="cb10-1537">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data</span>(v)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb10-1538">  </span>
<span id="cb10-1539">      cells<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">enter</span>()</span>
<span id="cb10-1540">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">merge</span>(cells)</span>
<span id="cb10-1541">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">=&gt;</span> d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x</span>)</span>
<span id="cb10-1542">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">=&gt;</span> d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y</span>)</span>
<span id="cb10-1543">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"width"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">=&gt;</span> d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width</span>)</span>
<span id="cb10-1544">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"height"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">=&gt;</span> d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height</span>)</span>
<span id="cb10-1545">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fill"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">=&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colorScaleIncomplete</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value</span>))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb10-1546">        </span>
<span id="cb10-1547">      d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#heatmap-incomplete-empirical-nested"</span>)</span>
<span id="cb10-1548">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">selectAll</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text"</span>)</span>
<span id="cb10-1549">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">remove</span>()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb10-1550">        </span>
<span id="cb10-1551">      cells<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">each</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> i) {</span>
<span id="cb10-1552">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> cell <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">parentNode</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb10-1553">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> bbox <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">getBBox</span>()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb10-1554">        cell<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text"</span>)</span>
<span id="cb10-1555">          <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> bbox<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> bbox<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb10-1556">          <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> bbox<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> bbox<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb10-1557">          <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text-anchor"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"middle"</span>)</span>
<span id="cb10-1558">          <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"alignment-baseline"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"central"</span>)</span>
<span id="cb10-1559">          <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"font-size"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"3px"</span>)</span>
<span id="cb10-1560">          <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pointer-events"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>)</span>
<span id="cb10-1561">          <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">text</span>((d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prop</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">toFixed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb10-1562">      })<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb10-1563">      </span>
<span id="cb10-1564">      cells<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exit</span>()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">remove</span>()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb10-1565">  </span>
<span id="cb10-1566">      d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#heatmap-incomplete-empirical-nested"</span>)</span>
<span id="cb10-1567">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">selectAll</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rect.cell"</span>)</span>
<span id="cb10-1568">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data</span>(incomplete_empirical_nested_pv_data)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb10-1569">    })</span>
<span id="cb10-1570">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">parent_el</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#heatmap-incomplete-empirical-nested"</span>)</span>
<span id="cb10-1571">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">interpolate</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">false</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb10-1572">  </span>
<span id="cb10-1573">  d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#heatmap-incomplete-empirical-nested"</span>)</span>
<span id="cb10-1574">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">html</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span>
<span id="cb10-1575">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">datum</span>(incomplete_empirical_nested_pv_data)</span>
<span id="cb10-1576">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">call</span>(heatmap_incomplete_empirical_nested)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb10-1577">}</span></code></pre></div>
</details>
<div class="cell-output cell-output-display hidden">
<div id="ojs-cell-10" data-nodetype="expression">

</div>
</div>
</div>
<p>Hovering my mouse over various areas in the middle third of the pitch, I consistently see slightly positive values near the top of the 18-yard box. This is not all that dissimilar from the trend observed with the successful pass pitch, where the passes into the final quarter of the pitch had strong positive PV from basically anywhere. And, like the interactive pitch for completed passes, a 30-yard incomplete pass forward from one’s own 18-yard box doesn’t have the same PV as a 30-yard incomplete pass forward from the half line to the opponent’s 18-yard box. Not all long incomplete passes are judged equally.</p>
</section>
</section>
</section>
<section id="conclusion" class="level1">
<h1>Conclusion</h1>
<p>Overall, my takeaways are as follows:</p>
<ol type="1">
<li>Not all long passes add the same kind of value. The pass has to be one that ends up near the box to create non-trivial positive PV.</li>
<li>And, while completed passes will almost always add more value, incomplete passes can also have positive PV when they’re played into dangerous areas.</li>
</ol>
<p>For those who have built PV models or are very familiar with them in some way, perhaps the latter observation is not an unsurprising result. Indeed, we should want our PV models to see past the outcome of a pass and properly quantify the threat that a through ball can have, whether it’s completed or not.</p>
<section id="caveats" class="level2">
<h2 class="anchored" data-anchor-id="caveats">Caveats</h2>
<ul>
<li><p>The choice of model surely plays a role in the inference we’ll make. Even <a href="https://dtai.cs.kuleuven.be/sports/blog/introducing-atomic-spadl:-a-new-way-to-represent-event-stream-data">atomic VAEP</a>, the cooler younger brother to the baseline VAEP model, may yield different answers due to the way that it treats passes.<sup>6</sup></p></li>
<li><p>Along the same lines, the gradients in the pitches are only as “good” as the quality of the model. While the cells show average PV values over many passes<sup>7</sup>, the PV value may not match intuition if the model doesn’t account for all relevant factors. If headed passes weren’t treated differently from footed passes, the gradients would likely show a lot more noise due to the randomness at which headed passes are successfully made.</p></li>
<li><p>The endpoint of incomplete passes is subject to a fundamental source of noise–interception locations. I’ve implicitly assumed that unsuccessful passes are intercepted very near the intended target, but this is not always the case. Interceptions where, for example, the defender blocks a long through ball near where the pass is made, can skew the model training, exaggerating the value of short incomplete passes.</p></li>
</ul>
</section>
</section>
<section id="appendix" class="level1">
<h1>Appendix</h1>
<section id="vaep" class="level2">
<h2 class="anchored" data-anchor-id="vaep">VAEP</h2>
<p>For those really interested in the details, the PV I’ve been showing is actually the goal probabilities underlying the VAEP framework, but not actually VAEP. In other words, I’ve been showing</p>
<p><span id="eq-p-goal"><img src="https://latex.codecogs.com/png.latex?%0AP_%7B%5Ctext%7Bgoal%7D%7D(S_i,%20x)%20=%20P_%7B%5Ctext%7Bscores%7D%7D(S_i,%20x)%20+%20(-P_%7B%5Ctext%7Bconcedes%7D%7D(S_i,%20x))%0A%5Ctag%7B1%7D"></span></p>
<p>where <img src="https://latex.codecogs.com/png.latex?S_i"> is the <img src="https://latex.codecogs.com/png.latex?i">th game state and <img src="https://latex.codecogs.com/png.latex?x"> is the team, either home or visiting. But VAEP is actually</p>
<p><span id="eq-vaep"><img src="https://latex.codecogs.com/png.latex?%0AV(a_i,%20x)%20=%20%5CDelta%20P_%7B%5Ctext%7Bscores%7D%7D(a_i,%20x)%20+%20(-%5CDelta%20P_%7B%5Ctext%7Bconcedes%7D%7D(a_i,%20x))%0A%5Ctag%7B2%7D"></span></p>
<p>where</p>
<p><span id="eq-delta-p-scores"><img src="https://latex.codecogs.com/png.latex?%0A%5CDelta%20P_%7B%5Ctext%7Bscores%7D%7D(a_i,%20x)%20=%20P_%7B%5Ctext%7Bscores%7D%7D(S_i,%20x)%20-%20P_%7B%5Ctext%7Bscores%7D%7D(S_%7Bi-1%7D,%20x)%0A%5Ctag%7B3%7D"></span></p>
<p>for action <img src="https://latex.codecogs.com/png.latex?a_i"> moving the game from state <img src="https://latex.codecogs.com/png.latex?S_%7Bi-1%7D"> to <img src="https://latex.codecogs.com/png.latex?S_i">, and where <img src="https://latex.codecogs.com/png.latex?%5CDelta%20P_%7B%5Ctext%7Bconcedes%7D%7D(a_i,%20x)"> is defined similarly.</p>
<p>VAEP directly reflects the value added by an action relative to the prior action. For those who have worked with expected threat (xT) before, this is analogous to <a href="https://karun.in/blog/expected-threat.html">the “xT created” metric</a>, as described by Singh.</p>
<blockquote class="blockquote">
<p>… [T]he point of xT was to come up with a metric that can quantify threat at any location on the pitch… [W]e can value individual player actions in buildup play by computing the difference in xT between the start and end locations. In other words, we will say that an action that moves the ball from location <img src="https://latex.codecogs.com/png.latex?(x,y)"> to location <img src="https://latex.codecogs.com/png.latex?(z,w)"> has value <img src="https://latex.codecogs.com/png.latex?%5Ctexttt%7BxT%7D_%7Bz,w%7D%20-%20%5Ctexttt%7BxT%7D_%7Bx,y%7D">.</p>
</blockquote>
<section id="complete-passes" class="level3">
<h3 class="anchored" data-anchor-id="complete-passes">Complete Passes</h3>
<p>Assuming the reader is comfortable with the plotting style and notations before, we now skip to re-creating the dynamic completed pass pitch.</p>
<div class="cell" data-include="true">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb11" data-startfrom="1638" data-source-offset="0" style="background: #f1f3f5;"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1637;"><span id="cb11-1638">{</span>
<span id="cb11-1639">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> chart <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">create</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"div"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"background-color"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"8f8f8f"</span>)</span>
<span id="cb11-1640">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> title <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> chart<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"div"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"heatmap-vaep-title-complete-empirical-nested"</span>)</span>
<span id="cb11-1641">  title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"p"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">html</span>(<span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">`min VAEP: &lt;span id='vaep-min-complete-empirical-nested'&gt;0&lt;/span&gt;, max VAEP: &lt;span id='vaep-max-complete-empirical-nested'&gt;0&lt;/span&gt;`</span>)</span>
<span id="cb11-1642">  chart<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"div"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"heatmap-vaep-complete-empirical-nested"</span>)</span>
<span id="cb11-1643">  </span>
<span id="cb11-1644">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> legendSwatchContainer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> chart<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"div"</span>)</span>
<span id="cb11-1645">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"heatmap-vaep-legend-complete-empirical-nested"</span>)</span>
<span id="cb11-1646">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"display"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"flex"</span>)</span>
<span id="cb11-1647">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"flex-direction"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"column"</span>)</span>
<span id="cb11-1648">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"align-items"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"center"</span>)</span>
<span id="cb11-1649">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"width"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"100%"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-1650">  </span>
<span id="cb11-1651">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> legendRange <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb11-1652">    <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(colorScaleCompleteRange)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb11-1653">    <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(colorScaleCompleteRange)</span>
<span id="cb11-1654">  ]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-1655">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> stepSize <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (legendRange[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> legendRange[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (swatchParams<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">num</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-1656">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> legendSwatches <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">range</span>(legendRange[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> legendRange[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> stepSize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> stepSize)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-1657">  legendSwatches[legendSwatches<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> legendRange[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-1658">  </span>
<span id="cb11-1659">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> totalLegendWidth <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> swatchParams<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> swatchParams<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">num</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-1660">  </span>
<span id="cb11-1661">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> swatchRow <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> legendSwatchContainer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"div"</span>)</span>
<span id="cb11-1662">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"display"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"flex"</span>)</span>
<span id="cb11-1663">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"justify-content"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"center"</span>)</span>
<span id="cb11-1664">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"width"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"100%"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-1665">  </span>
<span id="cb11-1666">  swatchRow<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">selectAll</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"div"</span>)</span>
<span id="cb11-1667">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data</span>(legendSwatches)</span>
<span id="cb11-1668">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">enter</span>()</span>
<span id="cb11-1669">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"div"</span>)</span>
<span id="cb11-1670">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"width"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">${</span>swatchParams<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">px`</span>)</span>
<span id="cb11-1671">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"height"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">${</span>swatchParams<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">px`</span>)</span>
<span id="cb11-1672">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"background-color"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">=&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colorScaleComplete</span>(d))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-1673">  </span>
<span id="cb11-1674">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> labelRow <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> legendSwatchContainer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"div"</span>)</span>
<span id="cb11-1675">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"display"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"flex"</span>)</span>
<span id="cb11-1676">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"justify-content"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"center"</span>)</span>
<span id="cb11-1677">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"width"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">${</span>totalLegendWidth<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">px`</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-1678">  </span>
<span id="cb11-1679">  </span>
<span id="cb11-1680">  labelRow<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">selectAll</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"span"</span>)</span>
<span id="cb11-1681">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data</span>(colorScaleCompleteRange)</span>
<span id="cb11-1682">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">enter</span>()</span>
<span id="cb11-1683">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"span"</span>)</span>
<span id="cb11-1684">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">text</span>(d <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">=&gt;</span> {</span>
<span id="cb11-1685">      <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">===</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(colorScaleCompleteRange)) {</span>
<span id="cb11-1686">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" &lt;="</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-1687">      } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">===</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(colorScaleCompleteRange)) {</span>
<span id="cb11-1688">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&gt;= "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-1689">      }</span>
<span id="cb11-1690">      <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-1691">    })</span>
<span id="cb11-1692">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"flex"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">=&gt;</span> d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">===</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">null</span>)</span>
<span id="cb11-1693">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text-align"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"center"</span>)</span>
<span id="cb11-1694">  </span>
<span id="cb11-1695">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> chart<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">node</span>()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb11-1696"></span>
<span id="cb11-1697">}</span></code></pre></div>
</details>
<div id="fig-ojs-cell-11" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<div id="ojs-cell-11" data-nodetype="expression">

</div>
<figcaption class="figure-caption">Figure&nbsp;6: A heatmap showing the average VAEP of historically completed pass from the hover spot to all areas on the pitch. The relative frequency of successful passes from the hover spot to each other cell is shown as a percentage. The highest and lowest VAEP values across all end points associated with a completed pass from the hover point are shown above the pitch. Black cells represent areas to which successful passes from the hover spot have never been made.</figcaption>
</figure>
</div>
</div>
<div class="cell">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb12" data-startfrom="1703" data-source-offset="0" style="background: #f1f3f5;"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1702;"><span id="cb12-1703">{  </span>
<span id="cb12-1704">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> heatmap_vaep_complete_empirical_nested <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d3_soccer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">heatmap</span>(pitch)</span>
<span id="cb12-1705">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colorScale</span>(d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scaleLinear</span>()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">domain</span>([<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">range</span>([<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>]))</span>
<span id="cb12-1706">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">enableInteraction</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">true</span>)</span>
<span id="cb12-1707">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">onSelect</span>((x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> v) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">=&gt;</span> {</span>
<span id="cb12-1708">      <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> rawMinValue <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">=&gt;</span> d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-1709">      <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> rawMaxValue <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">=&gt;</span> d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-1710">      <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> minValue <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Math</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(rawMinValue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-1711">      <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> maxValue <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Math</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(rawMaxValue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-1712">  </span>
<span id="cb12-1713">      d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#vaep-min-complete-empirical-nested"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">text</span>(minValue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">toFixed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-1714">      d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#vaep-max-complete-empirical-nested"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">text</span>(maxValue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">toFixed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-1715">      <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> cells <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d3</span>
<span id="cb12-1716">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#heatmap-vaep-complete-empirical-nested"</span>)</span>
<span id="cb12-1717">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">selectAll</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rect.cell"</span>)</span>
<span id="cb12-1718">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data</span>(v)</span>
<span id="cb12-1719">  </span>
<span id="cb12-1720">      cells<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">enter</span>()</span>
<span id="cb12-1721">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">merge</span>(cells)</span>
<span id="cb12-1722">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">=&gt;</span> d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x</span>)</span>
<span id="cb12-1723">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">=&gt;</span> d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y</span>)</span>
<span id="cb12-1724">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"width"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">=&gt;</span> d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width</span>)</span>
<span id="cb12-1725">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"height"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">=&gt;</span> d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height</span>)</span>
<span id="cb12-1726">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fill"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">=&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colorScaleComplete</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value</span>))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-1727"></span>
<span id="cb12-1728">      d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#heatmap-vaep-complete-empirical-nested"</span>)</span>
<span id="cb12-1729">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">selectAll</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text"</span>)</span>
<span id="cb12-1730">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">remove</span>()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-1731">        </span>
<span id="cb12-1732">      cells<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">each</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> i) {</span>
<span id="cb12-1733">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> cell <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">parentNode</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-1734">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> bbox <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">getBBox</span>()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-1735">        cell<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text"</span>)</span>
<span id="cb12-1736">          <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> bbox<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> bbox<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb12-1737">          <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> bbox<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> bbox<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb12-1738">          <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text-anchor"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"middle"</span>)</span>
<span id="cb12-1739">          <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"alignment-baseline"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"central"</span>)</span>
<span id="cb12-1740">          <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"font-size"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"3px"</span>)</span>
<span id="cb12-1741">          <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pointer-events"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>)</span>
<span id="cb12-1742">          <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">text</span>((d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prop</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">toFixed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-1743">      })<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-1744">      </span>
<span id="cb12-1745">      cells<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exit</span>()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">remove</span>()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-1746"></span>
<span id="cb12-1747">      d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#heatmap-vaep-complete-empirical-nested"</span>)</span>
<span id="cb12-1748">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">selectAll</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rect.cell"</span>)</span>
<span id="cb12-1749">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data</span>(complete_empirical_nested_vaep_data)</span>
<span id="cb12-1750"></span>
<span id="cb12-1751">    })</span>
<span id="cb12-1752">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">parent_el</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#heatmap-vaep-complete-empirical-nested"</span>)</span>
<span id="cb12-1753">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">interpolate</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">false</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-1754">  </span>
<span id="cb12-1755">  d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#heatmap-vaep-complete-empirical-nested"</span>)</span>
<span id="cb12-1756">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">html</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span>
<span id="cb12-1757">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">datum</span>(complete_empirical_nested_vaep_data)</span>
<span id="cb12-1758">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">call</span>(heatmap_vaep_complete_empirical_nested)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-1759">}</span></code></pre></div>
</details>
<div class="cell-output cell-output-display hidden">
<div id="ojs-cell-12" data-nodetype="expression">

</div>
</div>
</div>
<p>The big takeaway for me here is that there are a lot more cells on the pitch showing negative values (now VAEP instead of “PV”), especially for passes backward. This makes sense, as the model should see that, on average, such passes put the ball in a less advantageous position.</p>
<p>Recall that our pre-Appendix “PV” pitches account for the probability of conceding. Instances in which the pre-Appendix complete pass pitch shows a negative value indicate a pass start-end pair in which the probability of conceding increases more than the probability of scoring increases (or instances in which the probability of conceding decreases less than the probability of scoring decreases). Naturally, this resulted in a few negative start-to-end pass location combinations, particularly for passes sent very far backward. But now that we’re also accounting for the value of the prior action with VAEP, the pitch shows a lot more negatively valued start-end pairs, particularly for short passes backward.</p>
</section>
<section id="incomplete-passes-1" class="level3">
<h3 class="anchored" data-anchor-id="incomplete-passes-1">Incomplete Passes</h3>
<p>And now we re-create the dynamic pitch for incomplete passes, but showing VAEP instead of goal probability.</p>
<div class="cell" data-include="true">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb13" data-startfrom="1773" data-source-offset="0" style="background: #f1f3f5;"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1772;"><span id="cb13-1773">{</span>
<span id="cb13-1774">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> chart <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">create</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"div"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"background-color"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"8f8f8f"</span>)</span>
<span id="cb13-1775">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> title <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> chart<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"div"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"heatmap-vaep-title-incomplete-empirical-nested"</span>)</span>
<span id="cb13-1776">  title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"p"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">html</span>(<span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">`min VAEP: &lt;span id='vaep-min-incomplete-empirical-nested'&gt;0&lt;/span&gt;, max VAEP: &lt;span id='vaep-max-incomplete-empirical-nested'&gt;0&lt;/span&gt;`</span>)</span>
<span id="cb13-1777">  chart<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"div"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"heatmap-vaep-incomplete-empirical-nested"</span>)</span>
<span id="cb13-1778">  </span>
<span id="cb13-1779">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> legendSwatchContainer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> chart<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"div"</span>)</span>
<span id="cb13-1780">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"heatmap-vaep-legend-incomplete-empirical-nested"</span>)</span>
<span id="cb13-1781">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"display"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"flex"</span>)</span>
<span id="cb13-1782">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"flex-direction"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"column"</span>)</span>
<span id="cb13-1783">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"align-items"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"center"</span>)</span>
<span id="cb13-1784">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"width"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"100%"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb13-1785">  </span>
<span id="cb13-1786">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> legendRange <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb13-1787">    <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(colorScaleIncompleteRange)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb13-1788">    <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(colorScaleIncompleteRange)</span>
<span id="cb13-1789">  ]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb13-1790">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> stepSize <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (legendRange[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> legendRange[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (swatchParams<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">num</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb13-1791">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> legendSwatches <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">range</span>(legendRange[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> legendRange[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> stepSize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> stepSize)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb13-1792">  legendSwatches[legendSwatches<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> legendRange[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb13-1793">  </span>
<span id="cb13-1794">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> totalLegendWidth <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> swatchParams<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> swatchParams<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">num</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb13-1795">  </span>
<span id="cb13-1796">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> swatchRow <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> legendSwatchContainer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"div"</span>)</span>
<span id="cb13-1797">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"display"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"flex"</span>)</span>
<span id="cb13-1798">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"justify-content"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"center"</span>)</span>
<span id="cb13-1799">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"width"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"100%"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb13-1800">  </span>
<span id="cb13-1801">  swatchRow<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">selectAll</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"div"</span>)</span>
<span id="cb13-1802">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data</span>(legendSwatches)</span>
<span id="cb13-1803">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">enter</span>()</span>
<span id="cb13-1804">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"div"</span>)</span>
<span id="cb13-1805">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"width"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">${</span>swatchParams<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">px`</span>)</span>
<span id="cb13-1806">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"height"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">${</span>swatchParams<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">px`</span>)</span>
<span id="cb13-1807">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"background-color"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">=&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colorScaleIncomplete</span>(d))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb13-1808">  </span>
<span id="cb13-1809">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> labelRow <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> legendSwatchContainer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"div"</span>)</span>
<span id="cb13-1810">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"display"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"flex"</span>)</span>
<span id="cb13-1811">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"justify-content"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"center"</span>)</span>
<span id="cb13-1812">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"width"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">${</span>totalLegendWidth<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">px`</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb13-1813">  </span>
<span id="cb13-1814">  labelRow<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">selectAll</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"span"</span>)</span>
<span id="cb13-1815">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data</span>(colorScaleIncompleteRange)</span>
<span id="cb13-1816">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">enter</span>()</span>
<span id="cb13-1817">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"span"</span>)</span>
<span id="cb13-1818">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">text</span>(d <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">=&gt;</span> {</span>
<span id="cb13-1819">      <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">===</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(colorScaleIncompleteRange)) {</span>
<span id="cb13-1820">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" &lt;="</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb13-1821">      } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">===</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(colorScaleIncompleteRange)) {</span>
<span id="cb13-1822">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&gt;= "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb13-1823">      }</span>
<span id="cb13-1824">      <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb13-1825">    })</span>
<span id="cb13-1826">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"flex"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">=&gt;</span> d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">===</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">?</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">null</span>)</span>
<span id="cb13-1827">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text-align"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"center"</span>)</span>
<span id="cb13-1828">  </span>
<span id="cb13-1829">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> chart<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">node</span>()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb13-1830">}</span></code></pre></div>
</details>
<div id="fig-ojs-cell-13" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<div id="ojs-cell-13" data-nodetype="expression">

</div>
<figcaption class="figure-caption">Figure&nbsp;7: A heatmap showing the average VAEP of historically incomplete pass from the hover spot to all areas on the pitch. The relative frequency of successful passes from the hover spot to each other cell is shown as a percentage. The highest and lowest VAEP values across all end points associated with an incomplete pass from the hover point are shown above the pitch. Black cells represent areas to which unsuccessful passes from the hover spot have never been made.</figcaption>
</figure>
</div>
</div>
<div class="cell">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb14" data-startfrom="1836" data-source-offset="0" style="background: #f1f3f5;"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1835;"><span id="cb14-1836">{  </span>
<span id="cb14-1837">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> heatmap_vaep_incomplete_empirical_nested <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d3_soccer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">heatmap</span>(pitch)</span>
<span id="cb14-1838">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colorScale</span>(d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scaleLinear</span>()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">domain</span>([<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">range</span>([<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>]))</span>
<span id="cb14-1839">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">enableInteraction</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">true</span>)</span>
<span id="cb14-1840">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">onSelect</span>((x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> v) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">=&gt;</span> {</span>
<span id="cb14-1841">      <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> rawMinValue <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">=&gt;</span> d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-1842">      <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> rawMaxValue <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(v<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">=&gt;</span> d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-1843">      <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> minValue <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Math</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(rawMinValue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-1844">      <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> maxValue <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Math</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(rawMaxValue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-1845">  </span>
<span id="cb14-1846">      d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'#vaep-min-incomplete-empirical-nested'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">text</span>(minValue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">toFixed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-1847">      d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'#vaep-max-incomplete-empirical-nested'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">text</span>(maxValue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">toFixed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-1848">      <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> cells <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d3</span>
<span id="cb14-1849">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#heatmap-vaep-incomplete-empirical-nested"</span>)</span>
<span id="cb14-1850">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">selectAll</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rect.cell"</span>)</span>
<span id="cb14-1851">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data</span>(v)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-1852">  </span>
<span id="cb14-1853">      cells<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">enter</span>()</span>
<span id="cb14-1854">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">merge</span>(cells)</span>
<span id="cb14-1855">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">=&gt;</span> d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x</span>)</span>
<span id="cb14-1856">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">=&gt;</span> d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y</span>)</span>
<span id="cb14-1857">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"width"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">=&gt;</span> d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width</span>)</span>
<span id="cb14-1858">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"height"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">=&gt;</span> d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height</span>)</span>
<span id="cb14-1859">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fill"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">=&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colorScaleIncomplete</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value</span>))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-1860">        </span>
<span id="cb14-1861">      d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#heatmap-vaep-incomplete-empirical-nested"</span>)</span>
<span id="cb14-1862">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">selectAll</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text"</span>)</span>
<span id="cb14-1863">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">remove</span>()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-1864">        </span>
<span id="cb14-1865">      cells<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">each</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> i) {</span>
<span id="cb14-1866">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> cell <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">parentNode</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-1867">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> bbox <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">this</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">getBBox</span>()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-1868">        cell<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text"</span>)</span>
<span id="cb14-1869">          <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> bbox<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> bbox<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb14-1870">          <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> bbox<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> bbox<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb14-1871">          <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text-anchor"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"middle"</span>)</span>
<span id="cb14-1872">          <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"alignment-baseline"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"central"</span>)</span>
<span id="cb14-1873">          <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"font-size"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"3px"</span>)</span>
<span id="cb14-1874">          <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">style</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pointer-events"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>)</span>
<span id="cb14-1875">          <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">text</span>((d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prop</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">toFixed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-1876">      })<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-1877">      </span>
<span id="cb14-1878">      cells<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exit</span>()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">remove</span>()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-1879">  </span>
<span id="cb14-1880">      d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#heatmap-vaep-incomplete-empirical-nested"</span>)</span>
<span id="cb14-1881">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">selectAll</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rect.cell"</span>)</span>
<span id="cb14-1882">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data</span>(incomplete_empirical_nested_vaep_data)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-1883">    })</span>
<span id="cb14-1884">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">parent_el</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#heatmap-vaep-incomplete-empirical-nested"</span>)</span>
<span id="cb14-1885">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">interpolate</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">false</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-1886">  </span>
<span id="cb14-1887">  d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#heatmap-vaep-incomplete-empirical-nested"</span>)</span>
<span id="cb14-1888">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">html</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span>
<span id="cb14-1889">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">datum</span>(incomplete_empirical_nested_vaep_data)</span>
<span id="cb14-1890">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">call</span>(heatmap_vaep_incomplete_empirical_nested)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-1891">}</span></code></pre></div>
</details>
<div class="cell-output cell-output-display hidden">
<div id="ojs-cell-14" data-nodetype="expression">

</div>
</div>
</div>
<p>Compared to the pre-Appendix dynamic pitch for incomplete passes, this one shows a lot more negative values. In fact, there is only a very small subset of end points–those near the penalty spot–where an incomplete pass can have positive VAEP, no matter the starting point. So, when accounting for the value of the prior action with VAEP, it appears that incomplete passes only have positive impact in a handful of situations.</p>
<div class="cell" data-include="false">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb15" data-startfrom="1898" data-source-offset="0" style="background: #f1f3f5;"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1897;"><span id="cb15-1898">pitch <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d3_soccer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pitch</span>()</span>
<span id="cb15-1899">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">height</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>)</span>
<span id="cb15-1900">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rotate</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">false</span>)</span>
<span id="cb15-1901">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">showDirOfPlay</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">true</span>)</span>
<span id="cb15-1902">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">shadeMiddleThird</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">false</span>)</span>
<span id="cb15-1903">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pitchStrokeWidth</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)</span>
<span id="cb15-1904">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">clip</span>([[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">105</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">68</span>]])<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
</details>
<div class="cell-output cell-output-display hidden">
<div id="ojs-cell-15" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell" data-include="false">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb16" data-startfrom="1909" data-source-offset="0" style="background: #f1f3f5;"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1908;"><span id="cb16-1909">d3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">require</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"d3@v5"</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-display hidden">
<div id="ojs-cell-16" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell" data-include="false">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb17" data-startfrom="1914" data-source-offset="0" style="background: #f1f3f5;"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1913;"><span id="cb17-1914">d3_soccer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">require</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"d3-soccer@0.1.0"</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-display hidden">
<div id="ojs-cell-17" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell" data-include="false">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb18" data-startfrom="1920" data-source-offset="0" style="background: #f1f3f5;"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1919;"><span id="cb18-1920">complete_empirical_prop_data  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FileAttachment</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"complete_empirical_prop_data.json"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">json</span>()</span></code></pre></div>
</details>
<div id="complete_empirical_prop_data" class="cell-output cell-output-display hidden">
<div id="ojs-cell-18" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell" data-include="false">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb19" data-startfrom="1926" data-source-offset="0" style="background: #f1f3f5;"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1925;"><span id="cb19-1926">complete_empirical_pv_data  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FileAttachment</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"complete_empirical_pv_data.json"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">json</span>()</span></code></pre></div>
</details>
<div id="complete_empirical_pv_data" class="cell-output cell-output-display hidden">
<div id="ojs-cell-19" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell" data-include="true">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb20" data-startfrom="1932" data-source-offset="0" style="background: #f1f3f5;"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1931;"><span id="cb20-1932">complete_empirical_nested_pv_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FileAttachment</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"complete_empirical_nested_pv_data.json"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">json</span>()</span></code></pre></div>
</details>
<div id="complete_empirical_nested_pv_data" class="cell-output cell-output-display">
<div id="ojs-cell-20" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell" data-include="false">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb21" data-startfrom="1938" data-source-offset="0" style="background: #f1f3f5;"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1937;"><span id="cb21-1938">incomplete_empirical_pv_data  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FileAttachment</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"incomplete_empirical_pv_data.json"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">json</span>()</span></code></pre></div>
</details>
<div id="incomplete_empirical_pv_data" class="cell-output cell-output-display hidden">
<div id="ojs-cell-21" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell" data-include="true">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb22" data-startfrom="1944" data-source-offset="0" style="background: #f1f3f5;"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1943;"><span id="cb22-1944">incomplete_empirical_nested_pv_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FileAttachment</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"incomplete_empirical_nested_pv_data.json"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">json</span>()</span></code></pre></div>
</details>
<div id="incomplete_empirical_nested_pv_data" class="cell-output cell-output-display">
<div id="ojs-cell-22" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell" data-include="true">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb23" data-startfrom="1950" data-source-offset="0" style="background: #f1f3f5;"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1949;"><span id="cb23-1950">complete_empirical_nested_vaep_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FileAttachment</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"complete_empirical_nested_vaep_data.json"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">json</span>()</span></code></pre></div>
</details>
<div id="complete_empirical_nested_vaep_data" class="cell-output cell-output-display">
<div id="ojs-cell-23" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell" data-include="true">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb24" data-startfrom="1956" data-source-offset="0" style="background: #f1f3f5;"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1955;"><span id="cb24-1956">incomplete_empirical_nested_vaep_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FileAttachment</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"incomplete_empirical_nested_vaep_data.json"</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">json</span>()</span></code></pre></div>
</details>
<div id="incomplete_empirical_nested_vaep_data" class="cell-output cell-output-display">
<div id="ojs-cell-24" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell" data-include="false">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb25" data-startfrom="1962" data-source-offset="0" style="background: #f1f3f5;"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1961;"><span id="cb25-1962">colorScaleCompleteRange <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.025</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.025</span>]</span></code></pre></div>
</details>
<div id="colorscalecompleterange" class="cell-output cell-output-display hidden">
<div id="ojs-cell-25" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell" data-include="false">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb26" data-startfrom="1968" data-source-offset="0" style="background: #f1f3f5;"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1967;"><span id="cb26-1968">colorScaleIncompleteRange <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.025</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.025</span>]</span></code></pre></div>
</details>
<div id="colorscaleincompleterange" class="cell-output cell-output-display hidden">
<div id="ojs-cell-26" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell" data-include="false">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb27" data-startfrom="1974" data-source-offset="0" style="background: #f1f3f5;"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1973;"><span id="cb27-1974">colorScaleComplete <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scaleLinear</span>()</span>
<span id="cb27-1975">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">domain</span>(colorScaleCompleteRange)</span>
<span id="cb27-1976">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">range</span>([<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#a6611a"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#018571"</span>])<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">clamp</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">true</span>)</span></code></pre></div>
</details>
<div id="colorscalecomplete" class="cell-output cell-output-display hidden">
<div id="ojs-cell-27" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell" data-include="false">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb28" data-startfrom="1982" data-source-offset="0" style="background: #f1f3f5;"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1981;"><span id="cb28-1982">colorScaleIncomplete <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> d3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scaleLinear</span>()</span>
<span id="cb28-1983">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">domain</span>(colorScaleIncompleteRange)</span>
<span id="cb28-1984">  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">range</span>([<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#d01c8b"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#4dac26"</span>])<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">clamp</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">true</span>)</span></code></pre></div>
</details>
<div id="colorscaleincomplete" class="cell-output cell-output-display hidden">
<div id="ojs-cell-28" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell" data-include="false">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb29" data-startfrom="1990" data-source-offset="0" style="background: #f1f3f5;"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1989;"><span id="cb29-1990">swatchParams <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb29-1991">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> {</span>
<span id="cb29-1992">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">width</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb29-1993">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">height</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb29-1994">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">num</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span></span>
<span id="cb29-1995">  }</span>
<span id="cb29-1996">}</span></code></pre></div>
</details>
<div id="swatchparams" class="cell-output cell-output-display hidden">
<div id="ojs-cell-29" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell" data-include="false">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb30" data-startfrom="2002" data-source-offset="0" style="background: #f1f3f5;"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 2001;"><span id="cb30-2002">passStartParams <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb30-2003">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> {</span>
<span id="cb30-2004">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">x</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">43.75</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb30-2005">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">y</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">34</span></span>
<span id="cb30-2006">  }</span>
<span id="cb30-2007">}</span></code></pre></div>
</details>
<div id="passstartparams" class="cell-output cell-output-display hidden">
<div id="ojs-cell-30" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell" data-include="false">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb31" data-startfrom="2013" data-source-offset="0" style="background: #f1f3f5;"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 2012;"><span id="cb31-2013">cellParams <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb31-2014">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> {</span>
<span id="cb31-2015">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">width</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8.75</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb31-2016">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">height</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8.5</span></span>
<span id="cb31-2017">  }</span>
<span id="cb31-2018">}</span></code></pre></div>
</details>
<div id="cellparams" class="cell-output cell-output-display hidden">
<div id="ojs-cell-31" data-nodetype="declaration">

</div>
</div>
</div>



</section>
</section>
</section>


<div class="quarto-listing quarto-listing-container-default" id="listing-listing">
<div class="list quarto-listing-default">

</div>
<div class="listing-no-matching d-none">
No matching items
</div>
</div><div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Except in <a href="../../posts/soccer-league-strength/">this post</a>, where I only briefly mention that I use a PV model.↩︎</p></li>
<li id="fn2"><p>My model is trained on 2013/14 - 2023/24 English Premier League data.↩︎</p></li>
<li id="fn3"><p>While all PV models <a href="https://statsbomb.com/soccer-metrics/possession-value-models-explained/">are similar conceptually</a>, it’s important to identify how they differ in their target variables. VAEP specifically tries to quantify the difference in the probability of scoring and conceding in the next 10 actions. In contrast, expected threat (xT)–perhaps the most well-known PV model–tries to quantify only the probability of scoring in the next 5 actions, not accounting for the conceding probability, which can undermine the “risk” associated with incomplete passes.↩︎</p></li>
<li id="fn4"><p>Do not be alarmed by the small values! Values between 0.02 and 0.02 are very common for PV models. After all, the values represent goal probabilities over sequence of actions, and goals don’t happen all that frequently in soccer.↩︎</p></li>
<li id="fn5"><p>We observe lots of missingness near the defender’s box. Such incomplete passes backward would be very illogical no matter the game situation, so it’s not surprising to see that such passes are not observed in our data set.↩︎</p></li>
<li id="fn6"><p>Atomic VAEP splits passes into two actions–the pass itself and the reception (or lack of).↩︎</p></li>
<li id="fn7"><p>There are over 3.4M total passes in the data set.↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>r</category>
  <category>soccer</category>
  <category>observablejs</category>
  <guid>https://tonyelhabr.rbind.io/posts/ball-progression-epv/index.html</guid>
  <pubDate>Sat, 20 Apr 2024 05:00:00 GMT</pubDate>
  <media:content url="https://tonyelhabr.rbind.io/posts/ball-progression-epv/header.png" medium="image" type="image/png" height="129" width="144"/>
</item>
<item>
  <title>Measuring manager performance in fantasy football</title>
  <dc:creator>Tony ElHabr</dc:creator>
  <link>https://tonyelhabr.rbind.io/posts/fantasy-football-performance/index.html</link>
  <description><![CDATA[ 



<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>If you’ve played (American) fantasy football, you’ve probably felt that you have been unlucky and unjustly lost matches at some point. “I had the second most points of any team in my league this week, and I only lost because I happened to play the team that scored the most points!” If you’re like me, the first thing that we do is go to our league standings and look to see how we stack up against the rest of the teams in points for and against. If you’ve scored the third most points but your current placing is eighth because you’ve happened to have the most points scored against you, then of course you have a right to feel slighted.</p>
<p>But are there other ways you can go about justifying your dissatisfaction? I can think of at least three:</p>
<ol type="1">
<li><strong>All-play record</strong>: What would your position in the league table be if every team played all other teams in head-to-head matchups every week? How much did your schedule impact your record?</li>
<li><strong>Actual points scored compared to projection</strong>: Are you scoring less than your projected total? Is your team under-performing more than other teams compared to their projected scores?</li>
<li><strong>Points “left on the bench”</strong>: How many points could you have had if you had started the best possible lineup (with the benefit of hindsight)?</li>
</ol>
<p>In this post I’ll look at each of these concepts for my own fantasy football league. Evaluating how actual scores and placings may have been impacted by schedule, projections, and lineup choices should help us reason more tangibly about really contributes to “luck”.</p>
</section>
<section id="analysis-and-results" class="level2">
<h2 class="anchored" data-anchor-id="analysis-and-results">Analysis and Results</h2>
<p>The data comes from the 2018 - 2023 seasons of my primary fantasy football league, hosted on <a href="https://www.espn.com/">ESPN</a>.<sup>1</sup> We’ve had different rule sets and schedule formats (i.e.&nbsp;playoffs started in week 14 prior to the 2021 season in this league), but for the most part, measures of performance should be mostly agnostic to this.</p>
<p>Data was scraped with the <a href="https://ffscrapr.ffverse.com/"><code>{ffscrapr}</code> package</a> maintained by <a href="https://tanho.ca/">Tan Ho</a>.</p>
<section id="all-play-records" class="level3">
<h3 class="anchored" data-anchor-id="all-play-records">All-play records</h3>
<p>I felt like I was particularly unlucky with my schedule this past year, and indeed this bears out in the numbers.<sup>2</sup> Juan and Drake were also very unfortunate.</p>

<div id="latest_all_play" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
  <style>@import url("https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
@import url("https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
@import url("https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
@import url("https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
@import url("https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
#latest_all_play table {
  font-family: 'Titillium Web', system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#latest_all_play thead, #latest_all_play tbody, #latest_all_play tfoot, #latest_all_play tr, #latest_all_play td, #latest_all_play th {
  border-style: none;
}

#latest_all_play p {
  margin: 0;
  padding: 0;
}

#latest_all_play .new_gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #FFFFFF;
  font-size: 16px;
  font-weight: 400;
  font-style: normal;
  background-color: #222222;
  width: auto;
  border-top-style: none;
  border-top-width: 3px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #222222;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #222222;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #222222;
}

#latest_all_play .new_gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#latest_all_play .new_gt_title {
  color: #FFFFFF;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #222222;
  border-bottom-width: 0;
}

#latest_all_play .new_gt_subtitle {
  color: #FFFFFF;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #222222;
  border-top-width: 0;
}

#latest_all_play .new_gt_heading {
  background-color: #222222;
  text-align: left;
  border-bottom-color: #222222;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#latest_all_play .new_gt_bottom_border {
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#latest_all_play .new_gt_col_headings {
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 3px;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#latest_all_play .new_gt_col_heading {
  color: #FFFFFF;
  background-color: #222222;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#latest_all_play .new_gt_column_spanner_outer {
  color: #FFFFFF;
  background-color: #222222;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#latest_all_play .new_gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#latest_all_play .new_gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#latest_all_play .new_gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 3px;
  border-bottom-color: #FFFFFF;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#latest_all_play .new_gt_spanner_row {
  border-bottom-style: hidden;
}

#latest_all_play .new_gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #FFFFFF;
  background-color: #222222;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #222222;
  border-bottom-style: solid;
  border-bottom-width: 1px;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#latest_all_play .new_gt_empty_group_heading {
  padding: 0.5px;
  color: #FFFFFF;
  background-color: #222222;
  font-size: 100%;
  font-weight: initial;
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #222222;
  border-bottom-style: solid;
  border-bottom-width: 1px;
  border-bottom-color: #FFFFFF;
  vertical-align: middle;
}

#latest_all_play .new_gt_from_md > :first-child {
  margin-top: 0;
}

#latest_all_play .new_gt_from_md > :last-child {
  margin-bottom: 0;
}

#latest_all_play .new_gt_row {
  padding-top: 7px;
  padding-bottom: 7px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#latest_all_play .new_gt_stub {
  color: #FFFFFF;
  background-color: #222222;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 0px;
  border-right-color: #FFFFFF;
  padding-left: 5px;
  padding-right: 5px;
}

#latest_all_play .new_gt_stub_row_group {
  color: #FFFFFF;
  background-color: #222222;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#latest_all_play .new_gt_row_group_first td {
  border-top-width: 2px;
}

#latest_all_play .new_gt_row_group_first th {
  border-top-width: 2px;
}

#latest_all_play .new_gt_summary_row {
  color: #FFFFFF;
  background-color: #222222;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#latest_all_play .new_gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#latest_all_play .new_gt_first_summary_row.thick {
  border-top-width: 2px;
}

#latest_all_play .new_gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#latest_all_play .new_gt_grand_summary_row {
  color: #FFFFFF;
  background-color: #222222;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#latest_all_play .new_gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#latest_all_play .new_gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#latest_all_play .new_gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#latest_all_play .new_gt_table_body {
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #222222;
}

#latest_all_play .new_gt_footnotes {
  color: #FFFFFF;
  background-color: #222222;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#latest_all_play .new_gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#latest_all_play .new_gt_sourcenotes {
  color: #FFFFFF;
  background-color: #222222;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#latest_all_play .new_gt_sourcenote {
  font-size: 12px;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#latest_all_play .new_gt_left {
  text-align: left;
}

#latest_all_play .new_gt_center {
  text-align: center;
}

#latest_all_play .new_gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#latest_all_play .new_gt_font_normal {
  font-weight: normal;
}

#latest_all_play .new_gt_font_bold {
  font-weight: bold;
}

#latest_all_play .new_gt_font_italic {
  font-style: italic;
}

#latest_all_play .new_gt_super {
  font-size: 65%;
}

#latest_all_play .new_gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#latest_all_play .new_gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#latest_all_play .new_gt_indent_1 {
  text-indent: 5px;
}

#latest_all_play .new_gt_indent_2 {
  text-indent: 10px;
}

#latest_all_play .new_gt_indent_3 {
  text-indent: 15px;
}

#latest_all_play .new_gt_indent_4 {
  text-indent: 20px;
}

#latest_all_play .new_gt_indent_5 {
  text-indent: 25px;
}

#latest_all_play tbody tr:last-child {
  border-bottom: 2px solid #ffffff00;
}
</style>
  
<table class="new_gt_table table" data-quarto-postprocess="true">
<thead>
<tr class="header new_gt_heading">
<th colspan="8" class="new_gt_heading new_gt_title new_gt_font_normal" style="font-family: 'Titillium Web'; font-weight: 700">2023 All-Play Records</th>
</tr>
<tr class="odd new_gt_heading">
<th colspan="8" class="new_gt_heading new_gt_subtitle new_gt_font_normal new_gt_bottom_border" style="font-family: 'Titillium Web'; font-weight: 400">Tony was the most unlucky in the league this past season.</th>
</tr>
<tr class="header new_gt_col_headings new_gt_spanner_row">
<th rowspan="2" id="Team" class="new_gt_col_heading new_gt_columns_bottom_border new_gt_left" data-quarto-table-cell-role="th" style="color: #FFFFFF; font-family: 'Titillium Web'; text-transform: uppercase; font-size: 14px; vertical-align: bottom; font-weight: 200; border-top-width: 0px; border-top-style: solid; border-top-color: #222222" scope="col">Team</th>
<th colspan="2" id="Actual" class="new_gt_center new_gt_columns_top_border new_gt_column_spanner_outer" data-quarto-table-cell-role="th" scope="colgroup"><span class="new_gt_column_spanner">Actual</span></th>
<th colspan="2" id="All Play" class="new_gt_center new_gt_columns_top_border new_gt_column_spanner_outer" data-quarto-table-cell-role="th" scope="colgroup"><span class="new_gt_column_spanner">All Play</span></th>
<th colspan="2" id="Win %" class="new_gt_center new_gt_columns_top_border new_gt_column_spanner_outer" data-quarto-table-cell-role="th" scope="colgroup"><span class="new_gt_column_spanner">Win %</span></th>
<th rowspan="2" id="<strong>Δ</strong>" class="new_gt_col_heading new_gt_columns_bottom_border new_gt_right" data-quarto-table-cell-role="th" style="color: #FFFFFF; font-family: 'Titillium Web'; text-transform: uppercase; font-size: 14px; vertical-align: bottom; font-weight: 200; border-top-width: 0px; border-top-style: solid; border-top-color: #222222" scope="col"><strong>Δ</strong></th>
</tr>
<tr class="odd new_gt_col_headings">
<th id="W" class="new_gt_col_heading new_gt_columns_bottom_border new_gt_right" data-quarto-table-cell-role="th" style="color: #FFFFFF; font-family: 'Titillium Web'; text-transform: uppercase; font-size: 14px; vertical-align: bottom; font-weight: 200; border-top-width: 0px; border-top-style: solid; border-top-color: #222222" scope="col">W</th>
<th id="L" class="new_gt_col_heading new_gt_columns_bottom_border new_gt_right" data-quarto-table-cell-role="th" style="color: #FFFFFF; font-family: 'Titillium Web'; text-transform: uppercase; font-size: 14px; vertical-align: bottom; font-weight: 200; border-top-width: 0px; border-top-style: solid; border-top-color: #222222" scope="col">L</th>
<th id="W" class="new_gt_col_heading new_gt_columns_bottom_border new_gt_right" data-quarto-table-cell-role="th" style="color: #FFFFFF; font-family: 'Titillium Web'; text-transform: uppercase; font-size: 14px; vertical-align: bottom; font-weight: 200; border-top-width: 0px; border-top-style: solid; border-top-color: #222222" scope="col">W</th>
<th id="L" class="new_gt_col_heading new_gt_columns_bottom_border new_gt_right" data-quarto-table-cell-role="th" style="color: #FFFFFF; font-family: 'Titillium Web'; text-transform: uppercase; font-size: 14px; vertical-align: bottom; font-weight: 200; border-top-width: 0px; border-top-style: solid; border-top-color: #222222" scope="col">L</th>
<th id="Actual" class="new_gt_col_heading new_gt_columns_bottom_border new_gt_right" data-quarto-table-cell-role="th" style="color: #FFFFFF; font-family: 'Titillium Web'; text-transform: uppercase; font-size: 14px; vertical-align: bottom; font-weight: 200; border-top-width: 0px; border-top-style: solid; border-top-color: #222222" scope="col">Actual</th>
<th id="All Play" class="new_gt_col_heading new_gt_columns_bottom_border new_gt_right" data-quarto-table-cell-role="th" style="color: #FFFFFF; font-family: 'Titillium Web'; text-transform: uppercase; font-size: 14px; vertical-align: bottom; font-weight: 200; border-top-width: 0px; border-top-style: solid; border-top-color: #222222" scope="col">All Play</th>
</tr>
</thead>
<tbody class="new_gt_table_body">
<tr class="odd">
<td class="new_gt_row new_gt_left" headers="team">Tony</td>
<td class="new_gt_row new_gt_right" headers="actual_w">4</td>
<td class="new_gt_row new_gt_right" headers="actual_l">10</td>
<td class="new_gt_row new_gt_right" headers="all_play_w">56</td>
<td class="new_gt_row new_gt_right" headers="all_play_l">70</td>
<td class="new_gt_row new_gt_right" headers="actual_w_prop">29%</td>
<td class="new_gt_row new_gt_right" headers="all_play_w_prop">44%</td>
<td class="new_gt_row new_gt_right" headers="w_prop_d" style="background-color: rgba(118,42,131,0.9); color: #FFFFFF">−16%</td>
</tr>
<tr class="even">
<td class="new_gt_row new_gt_left" headers="team">Juan</td>
<td class="new_gt_row new_gt_right" headers="actual_w">6</td>
<td class="new_gt_row new_gt_right" headers="actual_l">8</td>
<td class="new_gt_row new_gt_right" headers="all_play_w">73</td>
<td class="new_gt_row new_gt_right" headers="all_play_l">53</td>
<td class="new_gt_row new_gt_right" headers="actual_w_prop">43%</td>
<td class="new_gt_row new_gt_right" headers="all_play_w_prop">58%</td>
<td class="new_gt_row new_gt_right" headers="w_prop_d" style="background-color: rgba(127,58,140,0.9); color: #FFFFFF">−15%</td>
</tr>
<tr class="odd">
<td class="new_gt_row new_gt_left" headers="team">Drake</td>
<td class="new_gt_row new_gt_right" headers="actual_w">4</td>
<td class="new_gt_row new_gt_right" headers="actual_l">10</td>
<td class="new_gt_row new_gt_right" headers="all_play_w">55</td>
<td class="new_gt_row new_gt_right" headers="all_play_l">71</td>
<td class="new_gt_row new_gt_right" headers="actual_w_prop">29%</td>
<td class="new_gt_row new_gt_right" headers="all_play_w_prop">44%</td>
<td class="new_gt_row new_gt_right" headers="w_prop_d" style="background-color: rgba(127,58,140,0.9); color: #FFFFFF">−15%</td>
</tr>
<tr class="even">
<td class="new_gt_row new_gt_left" headers="team">Brandon</td>
<td class="new_gt_row new_gt_right" headers="actual_w">6</td>
<td class="new_gt_row new_gt_right" headers="actual_l">8</td>
<td class="new_gt_row new_gt_right" headers="all_play_w">60</td>
<td class="new_gt_row new_gt_right" headers="all_play_l">66</td>
<td class="new_gt_row new_gt_right" headers="actual_w_prop">43%</td>
<td class="new_gt_row new_gt_right" headers="all_play_w_prop">48%</td>
<td class="new_gt_row new_gt_right" headers="w_prop_d" style="background-color: rgba(233,215,234,0.9); color: #000000">−5%</td>
</tr>
<tr class="odd">
<td class="new_gt_row new_gt_left" headers="team">Andrew L.</td>
<td class="new_gt_row new_gt_right" headers="actual_w">7</td>
<td class="new_gt_row new_gt_right" headers="actual_l">7</td>
<td class="new_gt_row new_gt_right" headers="all_play_w">63</td>
<td class="new_gt_row new_gt_right" headers="all_play_l">63</td>
<td class="new_gt_row new_gt_right" headers="actual_w_prop">50%</td>
<td class="new_gt_row new_gt_right" headers="all_play_w_prop">50%</td>
<td class="new_gt_row new_gt_right" headers="w_prop_d" style="background-color: rgba(247,247,247,0.9); color: #000000">0%</td>
</tr>
<tr class="even">
<td class="new_gt_row new_gt_left" headers="team">Enrique</td>
<td class="new_gt_row new_gt_right" headers="actual_w">9</td>
<td class="new_gt_row new_gt_right" headers="actual_l">5</td>
<td class="new_gt_row new_gt_right" headers="all_play_w">76</td>
<td class="new_gt_row new_gt_right" headers="all_play_l">50</td>
<td class="new_gt_row new_gt_right" headers="actual_w_prop">64%</td>
<td class="new_gt_row new_gt_right" headers="all_play_w_prop">60%</td>
<td class="new_gt_row new_gt_right" headers="w_prop_d" style="background-color: rgba(230,243,227,0.9); color: #000000">4%</td>
</tr>
<tr class="odd">
<td class="new_gt_row new_gt_left" headers="team">Alan</td>
<td class="new_gt_row new_gt_right" headers="actual_w">7</td>
<td class="new_gt_row new_gt_right" headers="actual_l">7</td>
<td class="new_gt_row new_gt_right" headers="all_play_w">55</td>
<td class="new_gt_row new_gt_right" headers="all_play_l">71</td>
<td class="new_gt_row new_gt_right" headers="actual_w_prop">50%</td>
<td class="new_gt_row new_gt_right" headers="all_play_w_prop">44%</td>
<td class="new_gt_row new_gt_right" headers="w_prop_d" style="background-color: rgba(220,241,215,0.9); color: #000000">6%</td>
</tr>
<tr class="even">
<td class="new_gt_row new_gt_left" headers="team">Andrew E.</td>
<td class="new_gt_row new_gt_right" headers="actual_w">9</td>
<td class="new_gt_row new_gt_right" headers="actual_l">5</td>
<td class="new_gt_row new_gt_right" headers="all_play_w">72</td>
<td class="new_gt_row new_gt_right" headers="all_play_l">54</td>
<td class="new_gt_row new_gt_right" headers="actual_w_prop">64%</td>
<td class="new_gt_row new_gt_right" headers="all_play_w_prop">57%</td>
<td class="new_gt_row new_gt_right" headers="w_prop_d" style="background-color: rgba(217,240,211,0.9); color: #000000">7%</td>
</tr>
<tr class="odd">
<td class="new_gt_row new_gt_left" headers="team">Luis</td>
<td class="new_gt_row new_gt_right" headers="actual_w">8</td>
<td class="new_gt_row new_gt_right" headers="actual_l">6</td>
<td class="new_gt_row new_gt_right" headers="all_play_w">57</td>
<td class="new_gt_row new_gt_right" headers="all_play_l">69</td>
<td class="new_gt_row new_gt_right" headers="actual_w_prop">57%</td>
<td class="new_gt_row new_gt_right" headers="all_play_w_prop">45%</td>
<td class="new_gt_row new_gt_right" headers="w_prop_d" style="background-color: rgba(157,207,152,0.9); color: #000000">12%</td>
</tr>
<tr class="even">
<td class="new_gt_row new_gt_left" headers="team">Manny</td>
<td class="new_gt_row new_gt_right" headers="actual_w">10</td>
<td class="new_gt_row new_gt_right" headers="actual_l">4</td>
<td class="new_gt_row new_gt_right" headers="all_play_w">63</td>
<td class="new_gt_row new_gt_right" headers="all_play_l">63</td>
<td class="new_gt_row new_gt_right" headers="actual_w_prop">71%</td>
<td class="new_gt_row new_gt_right" headers="all_play_w_prop">50%</td>
<td class="new_gt_row new_gt_right" headers="w_prop_d" style="background-color: rgba(27,120,55,0.9); color: #FFFFFF">21%</td>
</tr>
</tbody>
</table>

</div>
<p>A 16% difference between my actual record and my all-play record feels non-trivial. In fact, in comparing that level of under-performance to the prior seasons (some of which we played with a <a href="https://www.si.com/fantasy/2023/08/22/fantasy-football-101-what-is-superflex">“superflex”</a>, contributing to more variance), I find that there were only 6 less fortunate outcomes, including a -29% difference for myself in 2020!</p>

<div id="total_all_play" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
  <style>@import url("https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
@import url("https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
@import url("https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
@import url("https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
@import url("https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
#total_all_play table {
  font-family: 'Titillium Web', system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#total_all_play thead, #total_all_play tbody, #total_all_play tfoot, #total_all_play tr, #total_all_play td, #total_all_play th {
  border-style: none;
}

#total_all_play p {
  margin: 0;
  padding: 0;
}

#total_all_play .new_gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #FFFFFF;
  font-size: 16px;
  font-weight: 400;
  font-style: normal;
  background-color: #222222;
  width: auto;
  border-top-style: none;
  border-top-width: 3px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #222222;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #222222;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #222222;
}

#total_all_play .new_gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#total_all_play .new_gt_title {
  color: #FFFFFF;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #222222;
  border-bottom-width: 0;
}

#total_all_play .new_gt_subtitle {
  color: #FFFFFF;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #222222;
  border-top-width: 0;
}

#total_all_play .new_gt_heading {
  background-color: #222222;
  text-align: left;
  border-bottom-color: #222222;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#total_all_play .new_gt_bottom_border {
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#total_all_play .new_gt_col_headings {
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 3px;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#total_all_play .new_gt_col_heading {
  color: #FFFFFF;
  background-color: #222222;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#total_all_play .new_gt_column_spanner_outer {
  color: #FFFFFF;
  background-color: #222222;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#total_all_play .new_gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#total_all_play .new_gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#total_all_play .new_gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 3px;
  border-bottom-color: #FFFFFF;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#total_all_play .new_gt_spanner_row {
  border-bottom-style: hidden;
}

#total_all_play .new_gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #FFFFFF;
  background-color: #222222;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #222222;
  border-bottom-style: solid;
  border-bottom-width: 1px;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#total_all_play .new_gt_empty_group_heading {
  padding: 0.5px;
  color: #FFFFFF;
  background-color: #222222;
  font-size: 100%;
  font-weight: initial;
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #222222;
  border-bottom-style: solid;
  border-bottom-width: 1px;
  border-bottom-color: #FFFFFF;
  vertical-align: middle;
}

#total_all_play .new_gt_from_md > :first-child {
  margin-top: 0;
}

#total_all_play .new_gt_from_md > :last-child {
  margin-bottom: 0;
}

#total_all_play .new_gt_row {
  padding-top: 7px;
  padding-bottom: 7px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#total_all_play .new_gt_stub {
  color: #FFFFFF;
  background-color: #222222;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 0px;
  border-right-color: #FFFFFF;
  padding-left: 5px;
  padding-right: 5px;
}

#total_all_play .new_gt_stub_row_group {
  color: #FFFFFF;
  background-color: #222222;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#total_all_play .new_gt_row_group_first td {
  border-top-width: 2px;
}

#total_all_play .new_gt_row_group_first th {
  border-top-width: 2px;
}

#total_all_play .new_gt_summary_row {
  color: #FFFFFF;
  background-color: #222222;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#total_all_play .new_gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#total_all_play .new_gt_first_summary_row.thick {
  border-top-width: 2px;
}

#total_all_play .new_gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#total_all_play .new_gt_grand_summary_row {
  color: #FFFFFF;
  background-color: #222222;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#total_all_play .new_gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#total_all_play .new_gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#total_all_play .new_gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#total_all_play .new_gt_table_body {
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #222222;
}

#total_all_play .new_gt_footnotes {
  color: #FFFFFF;
  background-color: #222222;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#total_all_play .new_gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#total_all_play .new_gt_sourcenotes {
  color: #FFFFFF;
  background-color: #222222;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#total_all_play .new_gt_sourcenote {
  font-size: 12px;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#total_all_play .new_gt_left {
  text-align: left;
}

#total_all_play .new_gt_center {
  text-align: center;
}

#total_all_play .new_gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#total_all_play .new_gt_font_normal {
  font-weight: normal;
}

#total_all_play .new_gt_font_bold {
  font-weight: bold;
}

#total_all_play .new_gt_font_italic {
  font-style: italic;
}

#total_all_play .new_gt_super {
  font-size: 65%;
}

#total_all_play .new_gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#total_all_play .new_gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#total_all_play .new_gt_indent_1 {
  text-indent: 5px;
}

#total_all_play .new_gt_indent_2 {
  text-indent: 10px;
}

#total_all_play .new_gt_indent_3 {
  text-indent: 15px;
}

#total_all_play .new_gt_indent_4 {
  text-indent: 20px;
}

#total_all_play .new_gt_indent_5 {
  text-indent: 25px;
}

#total_all_play tbody tr:last-child {
  border-bottom: 2px solid #ffffff00;
}
</style>
  
<table class="new_gt_table table" data-quarto-postprocess="true">
<thead>
<tr class="header new_gt_heading">
<th colspan="8" class="new_gt_heading new_gt_title new_gt_font_normal" style="font-family: 'Titillium Web'; font-weight: 700">Actual Win % - All Play Win %</th>
</tr>
<tr class="odd new_gt_heading">
<th colspan="8" class="new_gt_heading new_gt_subtitle new_gt_font_normal new_gt_bottom_border" style="font-family: 'Titillium Web'; font-weight: 400">Juan and Tony have had the most unfair schedules since 2018.</th>
</tr>
<tr class="header new_gt_col_headings">
<th id="Team" class="new_gt_col_heading new_gt_columns_bottom_border new_gt_left" data-quarto-table-cell-role="th" style="color: #FFFFFF; font-family: 'Titillium Web'; text-transform: uppercase; font-size: 14px; vertical-align: bottom; font-weight: 200; border-top-width: 0px; border-top-style: solid; border-top-color: #222222" scope="col">Team</th>
<th id="2018" class="new_gt_col_heading new_gt_columns_bottom_border new_gt_right" data-quarto-table-cell-role="th" style="color: #FFFFFF; font-family: 'Titillium Web'; text-transform: uppercase; font-size: 14px; vertical-align: bottom; font-weight: 200; border-top-width: 0px; border-top-style: solid; border-top-color: #222222" scope="col">2018</th>
<th id="2019" class="new_gt_col_heading new_gt_columns_bottom_border new_gt_right" data-quarto-table-cell-role="th" style="color: #FFFFFF; font-family: 'Titillium Web'; text-transform: uppercase; font-size: 14px; vertical-align: bottom; font-weight: 200; border-top-width: 0px; border-top-style: solid; border-top-color: #222222" scope="col">2019</th>
<th id="2020" class="new_gt_col_heading new_gt_columns_bottom_border new_gt_right" data-quarto-table-cell-role="th" style="color: #FFFFFF; font-family: 'Titillium Web'; text-transform: uppercase; font-size: 14px; vertical-align: bottom; font-weight: 200; border-top-width: 0px; border-top-style: solid; border-top-color: #222222" scope="col">2020</th>
<th id="2021" class="new_gt_col_heading new_gt_columns_bottom_border new_gt_right" data-quarto-table-cell-role="th" style="color: #FFFFFF; font-family: 'Titillium Web'; text-transform: uppercase; font-size: 14px; vertical-align: bottom; font-weight: 200; border-top-width: 0px; border-top-style: solid; border-top-color: #222222" scope="col">2021</th>
<th id="2022" class="new_gt_col_heading new_gt_columns_bottom_border new_gt_right" data-quarto-table-cell-role="th" style="color: #FFFFFF; font-family: 'Titillium Web'; text-transform: uppercase; font-size: 14px; vertical-align: bottom; font-weight: 200; border-top-width: 0px; border-top-style: solid; border-top-color: #222222" scope="col">2022</th>
<th id="2023" class="new_gt_col_heading new_gt_columns_bottom_border new_gt_right" data-quarto-table-cell-role="th" style="color: #FFFFFF; font-family: 'Titillium Web'; text-transform: uppercase; font-size: 14px; vertical-align: bottom; font-weight: 200; border-top-width: 0px; border-top-style: solid; border-top-color: #222222" scope="col">2023</th>
<th id="Total" class="new_gt_col_heading new_gt_columns_bottom_border new_gt_right" data-quarto-table-cell-role="th" style="color: #FFFFFF; font-family: 'Titillium Web'; text-transform: uppercase; font-size: 14px; vertical-align: bottom; font-weight: 200; border-top-width: 0px; border-top-style: solid; border-top-color: #222222" scope="col">Total</th>
</tr>
</thead>
<tbody class="new_gt_table_body">
<tr class="odd">
<td class="new_gt_row new_gt_left" headers="team">Juan</td>
<td class="new_gt_row new_gt_right" headers="2018" style="background-color: rgba(141,83,156,0.9); color: #FFFFFF">−12%</td>
<td class="new_gt_row new_gt_right" headers="2019" style="background-color: rgba(110,178,110,0.9); color: #FFFFFF">15%</td>
<td class="new_gt_row new_gt_right" headers="2020" style="background-color: rgba(241,233,241,0.9); color: #000000">−4%</td>
<td class="new_gt_row new_gt_right" headers="2021" style="background-color: rgba(118,42,131,0.9); color: #FFFFFF">−25%</td>
<td class="new_gt_row new_gt_right" headers="2022" style="background-color: rgba(215,239,209,0.9); color: #000000">7%</td>
<td class="new_gt_row new_gt_right" headers="2023" style="background-color: rgba(127,58,140,0.9); color: #FFFFFF">−15%</td>
<td class="new_gt_row new_gt_right" headers="Total" style="background-color: rgba(118,42,131,0.9); color: #FFFFFF">−6%</td>
</tr>
<tr class="even">
<td class="new_gt_row new_gt_left" headers="team">Tony</td>
<td class="new_gt_row new_gt_right" headers="2018" style="background-color: rgba(237,245,235,0.9); color: #000000">2%</td>
<td class="new_gt_row new_gt_right" headers="2019" style="background-color: rgba(218,240,213,0.9); color: #000000">6%</td>
<td class="new_gt_row new_gt_right" headers="2020" style="background-color: rgba(118,42,131,0.9); color: #FFFFFF">−29%</td>
<td class="new_gt_row new_gt_right" headers="2021" style="background-color: rgba(238,227,239,0.9); color: #000000">−5%</td>
<td class="new_gt_row new_gt_right" headers="2022" style="background-color: rgba(227,242,223,0.9); color: #000000">5%</td>
<td class="new_gt_row new_gt_right" headers="2023" style="background-color: rgba(118,42,131,0.9); color: #FFFFFF">−16%</td>
<td class="new_gt_row new_gt_right" headers="Total" style="background-color: rgba(130,64,144,0.9); color: #FFFFFF">−6%</td>
</tr>
<tr class="odd">
<td class="new_gt_row new_gt_left" headers="team">Enrique</td>
<td class="new_gt_row new_gt_right" headers="2018" style="background-color: rgba(202,232,196,0.9); color: #000000">6%</td>
<td class="new_gt_row new_gt_right" headers="2019" style="background-color: rgba(141,82,156,0.9); color: #FFFFFF">−19%</td>
<td class="new_gt_row new_gt_right" headers="2020" style="background-color: rgba(189,159,205,0.9); color: #000000">−17%</td>
<td class="new_gt_row new_gt_right" headers="2021" style="background-color: rgba(244,240,244,0.9); color: #000000">−2%</td>
<td class="new_gt_row new_gt_right" headers="2022" style="background-color: rgba(224,242,219,0.9); color: #000000">6%</td>
<td class="new_gt_row new_gt_right" headers="2023" style="background-color: rgba(230,243,227,0.9); color: #000000">4%</td>
<td class="new_gt_row new_gt_right" headers="Total" style="background-color: rgba(209,183,217,0.9); color: #000000">−3%</td>
</tr>
<tr class="even">
<td class="new_gt_row new_gt_left" headers="team">Brandon</td>
<td class="new_gt_row new_gt_right" headers="2018" style="background-color: rgba(241,233,241,0.9); color: #000000">−2%</td>
<td class="new_gt_row new_gt_right" headers="2019" style="background-color: rgba(214,190,221,0.9); color: #000000">−9%</td>
<td class="new_gt_row new_gt_right" headers="2020" style="background-color: rgba(172,216,166,0.9); color: #000000">6%</td>
<td class="new_gt_row new_gt_right" headers="2021" style="background-color: rgba(213,189,220,0.9); color: #000000">−11%</td>
<td class="new_gt_row new_gt_right" headers="2022" style="background-color: rgba(234,244,231,0.9); color: #000000">3%</td>
<td class="new_gt_row new_gt_right" headers="2023" style="background-color: rgba(233,215,234,0.9); color: #000000">−5%</td>
<td class="new_gt_row new_gt_right" headers="Total" style="background-color: rgba(209,183,217,0.9); color: #000000">−3%</td>
</tr>
<tr class="odd">
<td class="new_gt_row new_gt_left" headers="team">Drake</td>
<td class="new_gt_row new_gt_right" headers="2018" style="background-color: rgba(237,245,235,0.9); color: #000000">2%</td>
<td class="new_gt_row new_gt_right" headers="2019" style="background-color: rgba(218,240,213,0.9); color: #000000">6%</td>
<td class="new_gt_row new_gt_right" headers="2020" style="background-color: rgba(134,195,129,0.9); color: #000000">8%</td>
<td class="new_gt_row new_gt_right" headers="2021" style="background-color: rgba(50,133,67,0.9); color: #FFFFFF">12%</td>
<td class="new_gt_row new_gt_right" headers="2022" style="background-color: rgba(238,226,238,0.9); color: #000000">−4%</td>
<td class="new_gt_row new_gt_right" headers="2023" style="background-color: rgba(127,58,140,0.9); color: #FFFFFF">−15%</td>
<td class="new_gt_row new_gt_right" headers="Total" style="background-color: rgba(228,243,224,0.9); color: #000000">1%</td>
</tr>
<tr class="even">
<td class="new_gt_row new_gt_left" headers="team">Alan</td>
<td class="new_gt_row new_gt_right" headers="2018" style="background-color: rgba(118,42,131,0.9); color: #FFFFFF">−14%</td>
<td class="new_gt_row new_gt_right" headers="2019" style="background-color: rgba(27,120,55,0.9); color: #FFFFFF">20%</td>
<td class="new_gt_row new_gt_right" headers="2020" style="background-color: rgba(192,226,185,0.9); color: #000000">6%</td>
<td class="new_gt_row new_gt_right" headers="2021" style="background-color: rgba(172,216,166,0.9); color: #000000">6%</td>
<td class="new_gt_row new_gt_right" headers="2022" style="background-color: rgba(161,117,179,0.9); color: #FFFFFF">−15%</td>
<td class="new_gt_row new_gt_right" headers="2023" style="background-color: rgba(220,241,215,0.9); color: #000000">6%</td>
<td class="new_gt_row new_gt_right" headers="Total" style="background-color: rgba(226,242,222,0.9); color: #000000">1%</td>
</tr>
<tr class="odd">
<td class="new_gt_row new_gt_left" headers="team">Luis</td>
<td class="new_gt_row new_gt_right" headers="2018" style="background-color: rgba(27,120,55,0.9); color: #FFFFFF">17%</td>
<td class="new_gt_row new_gt_right" headers="2019" style="background-color: rgba(177,144,197,0.9); color: #FFFFFF">−14%</td>
<td class="new_gt_row new_gt_right" headers="2020" style="background-color: rgba(27,120,55,0.9); color: #FFFFFF">13%</td>
<td class="new_gt_row new_gt_right" headers="2021" style="background-color: rgba(225,242,220,0.9); color: #000000">3%</td>
<td class="new_gt_row new_gt_right" headers="2022" style="background-color: rgba(118,42,131,0.9); color: #FFFFFF">−20%</td>
<td class="new_gt_row new_gt_right" headers="2023" style="background-color: rgba(157,207,152,0.9); color: #000000">12%</td>
<td class="new_gt_row new_gt_right" headers="Total" style="background-color: rgba(220,241,215,0.9); color: #000000">2%</td>
</tr>
<tr class="even">
<td class="new_gt_row new_gt_left" headers="team">Manny</td>
<td class="new_gt_row new_gt_right" headers="2018" style="background-color: rgba(227,242,223,0.9); color: #000000">4%</td>
<td class="new_gt_row new_gt_right" headers="2019" style="background-color: rgba(235,244,232,0.9); color: #000000">3%</td>
<td class="new_gt_row new_gt_right" headers="2020" style="background-color: rgba(241,246,239,0.9); color: #000000">1%</td>
<td class="new_gt_row new_gt_right" headers="2021" style="background-color: rgba(243,237,243,0.9); color: #000000">−2%</td>
<td class="new_gt_row new_gt_right" headers="2022" style="background-color: rgba(174,140,194,0.9); color: #FFFFFF">−13%</td>
<td class="new_gt_row new_gt_right" headers="2023" style="background-color: rgba(27,120,55,0.9); color: #FFFFFF">21%</td>
<td class="new_gt_row new_gt_right" headers="Total" style="background-color: rgba(213,238,207,0.9); color: #000000">2%</td>
</tr>
<tr class="odd">
<td class="new_gt_row new_gt_left" headers="team">Andrew E.</td>
<td class="new_gt_row new_gt_right" headers="2018" style="background-color: rgba(142,199,137,0.9); color: #000000">10%</td>
<td class="new_gt_row new_gt_right" headers="2019" style="background-color: rgba(118,42,131,0.9); color: #FFFFFF">−21%</td>
<td class="new_gt_row new_gt_right" headers="2020" style="background-color: rgba(53,135,69,0.9); color: #FFFFFF">12%</td>
<td class="new_gt_row new_gt_right" headers="2021" style="background-color: rgba(27,120,55,0.9); color: #FFFFFF">13%</td>
<td class="new_gt_row new_gt_right" headers="2022" style="background-color: rgba(177,218,171,0.9); color: #000000">10%</td>
<td class="new_gt_row new_gt_right" headers="2023" style="background-color: rgba(217,240,211,0.9); color: #000000">7%</td>
<td class="new_gt_row new_gt_right" headers="Total" style="background-color: rgba(59,139,73,0.9); color: #FFFFFF">6%</td>
</tr>
<tr class="even">
<td class="new_gt_row new_gt_left" headers="team">Andrew L.</td>
<td class="new_gt_row new_gt_right" headers="2018" style="background-color: rgba(130,63,144,0.9); color: #FFFFFF">−13%</td>
<td class="new_gt_row new_gt_right" headers="2019" style="background-color: rgba(148,202,143,0.9); color: #000000">12%</td>
<td class="new_gt_row new_gt_right" headers="2020" style="background-color: rgba(228,243,224,0.9); color: #000000">3%</td>
<td class="new_gt_row new_gt_right" headers="2021" style="background-color: rgba(69,146,80,0.9); color: #FFFFFF">11%</td>
<td class="new_gt_row new_gt_right" headers="2022" style="background-color: rgba(27,120,55,0.9); color: #FFFFFF">21%</td>
<td class="new_gt_row new_gt_right" headers="2023" style="background-color: rgba(247,247,247,0.9); color: #000000">0%</td>
<td class="new_gt_row new_gt_right" headers="Total" style="background-color: rgba(27,120,55,0.9); color: #FFFFFF">6%</td>
</tr>
</tbody>
</table>

</div>
<p>Andrew E. and Andrew L. have been fairly fortunate, only facing 1 season in the past 6 where they ended up with a record that was worse than their all-play records.</p>
<p>The top and bottom 2.5th percentiles of season-long actual win % minus all play win % are about ±22%. This translates to about ±3 wins in leagues with a 14-game regular season. So the “back-of-the-napkin” takeaway here is that you could be winning or losing 3 more games due to your schedule, in the most extreme cases.</p>
<p>Overall, it’s interesting to see that the under- and over-performance doesn’t quite level out even over the course of 6 seasons. Surely we’d see this even out over more and more seasons, but it’s noteworthy that even 6 seasons may not be sufficient to achieve long-run schedule schedule equality.</p>
</section>
<section id="actual-vs.-projected-points" class="level3">
<h3 class="anchored" data-anchor-id="actual-vs.-projected-points">Actual vs.&nbsp;projected points</h3>
<p>Another way to look at whether a team was “lucky” or not is to compare the points that they scored versus what they were projected to score. <sup>3</sup> Further, we should look to see whether one’s opponents are scoring more than they’re projected to score, as this represents another source of variance in scoring. In total, the sum of the differences between one’s own actual and projected scores and the difference with the opponents’ actual and projected scores presents another way of measuring misfortune.<sup>4</sup></p>

<div id="latest_season_points_above_projected" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
  <style>@import url("https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
@import url("https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
@import url("https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
@import url("https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
@import url("https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
#latest_season_points_above_projected table {
  font-family: 'Titillium Web', system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#latest_season_points_above_projected thead, #latest_season_points_above_projected tbody, #latest_season_points_above_projected tfoot, #latest_season_points_above_projected tr, #latest_season_points_above_projected td, #latest_season_points_above_projected th {
  border-style: none;
}

#latest_season_points_above_projected p {
  margin: 0;
  padding: 0;
}

#latest_season_points_above_projected .new_gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #FFFFFF;
  font-size: 16px;
  font-weight: 400;
  font-style: normal;
  background-color: #222222;
  width: auto;
  border-top-style: none;
  border-top-width: 3px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #222222;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #222222;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #222222;
}

#latest_season_points_above_projected .new_gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#latest_season_points_above_projected .new_gt_title {
  color: #FFFFFF;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #222222;
  border-bottom-width: 0;
}

#latest_season_points_above_projected .new_gt_subtitle {
  color: #FFFFFF;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #222222;
  border-top-width: 0;
}

#latest_season_points_above_projected .new_gt_heading {
  background-color: #222222;
  text-align: left;
  border-bottom-color: #222222;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#latest_season_points_above_projected .new_gt_bottom_border {
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#latest_season_points_above_projected .new_gt_col_headings {
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 3px;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#latest_season_points_above_projected .new_gt_col_heading {
  color: #FFFFFF;
  background-color: #222222;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#latest_season_points_above_projected .new_gt_column_spanner_outer {
  color: #FFFFFF;
  background-color: #222222;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#latest_season_points_above_projected .new_gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#latest_season_points_above_projected .new_gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#latest_season_points_above_projected .new_gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 3px;
  border-bottom-color: #FFFFFF;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#latest_season_points_above_projected .new_gt_spanner_row {
  border-bottom-style: hidden;
}

#latest_season_points_above_projected .new_gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #FFFFFF;
  background-color: #222222;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #222222;
  border-bottom-style: solid;
  border-bottom-width: 1px;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#latest_season_points_above_projected .new_gt_empty_group_heading {
  padding: 0.5px;
  color: #FFFFFF;
  background-color: #222222;
  font-size: 100%;
  font-weight: initial;
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #222222;
  border-bottom-style: solid;
  border-bottom-width: 1px;
  border-bottom-color: #FFFFFF;
  vertical-align: middle;
}

#latest_season_points_above_projected .new_gt_from_md > :first-child {
  margin-top: 0;
}

#latest_season_points_above_projected .new_gt_from_md > :last-child {
  margin-bottom: 0;
}

#latest_season_points_above_projected .new_gt_row {
  padding-top: 7px;
  padding-bottom: 7px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#latest_season_points_above_projected .new_gt_stub {
  color: #FFFFFF;
  background-color: #222222;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 0px;
  border-right-color: #FFFFFF;
  padding-left: 5px;
  padding-right: 5px;
}

#latest_season_points_above_projected .new_gt_stub_row_group {
  color: #FFFFFF;
  background-color: #222222;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#latest_season_points_above_projected .new_gt_row_group_first td {
  border-top-width: 2px;
}

#latest_season_points_above_projected .new_gt_row_group_first th {
  border-top-width: 2px;
}

#latest_season_points_above_projected .new_gt_summary_row {
  color: #FFFFFF;
  background-color: #222222;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#latest_season_points_above_projected .new_gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#latest_season_points_above_projected .new_gt_first_summary_row.thick {
  border-top-width: 2px;
}

#latest_season_points_above_projected .new_gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#latest_season_points_above_projected .new_gt_grand_summary_row {
  color: #FFFFFF;
  background-color: #222222;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#latest_season_points_above_projected .new_gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#latest_season_points_above_projected .new_gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#latest_season_points_above_projected .new_gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#latest_season_points_above_projected .new_gt_table_body {
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #222222;
}

#latest_season_points_above_projected .new_gt_footnotes {
  color: #FFFFFF;
  background-color: #222222;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#latest_season_points_above_projected .new_gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#latest_season_points_above_projected .new_gt_sourcenotes {
  color: #FFFFFF;
  background-color: #222222;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#latest_season_points_above_projected .new_gt_sourcenote {
  font-size: 12px;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#latest_season_points_above_projected .new_gt_left {
  text-align: left;
}

#latest_season_points_above_projected .new_gt_center {
  text-align: center;
}

#latest_season_points_above_projected .new_gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#latest_season_points_above_projected .new_gt_font_normal {
  font-weight: normal;
}

#latest_season_points_above_projected .new_gt_font_bold {
  font-weight: bold;
}

#latest_season_points_above_projected .new_gt_font_italic {
  font-style: italic;
}

#latest_season_points_above_projected .new_gt_super {
  font-size: 65%;
}

#latest_season_points_above_projected .new_gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#latest_season_points_above_projected .new_gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#latest_season_points_above_projected .new_gt_indent_1 {
  text-indent: 5px;
}

#latest_season_points_above_projected .new_gt_indent_2 {
  text-indent: 10px;
}

#latest_season_points_above_projected .new_gt_indent_3 {
  text-indent: 15px;
}

#latest_season_points_above_projected .new_gt_indent_4 {
  text-indent: 20px;
}

#latest_season_points_above_projected .new_gt_indent_5 {
  text-indent: 25px;
}

#latest_season_points_above_projected tbody tr:last-child {
  border-bottom: 2px solid #ffffff00;
}
</style>
  
<table class="new_gt_table table" data-quarto-postprocess="true">
<colgroup>
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
</colgroup>
<thead>
<tr class="header new_gt_heading">
<th colspan="4" class="new_gt_heading new_gt_title new_gt_font_normal" style="font-family: 'Titillium Web'; font-weight: 700">2023 Avg. Weekly Actual - Projected Points</th>
</tr>
<tr class="odd new_gt_heading">
<th colspan="4" class="new_gt_heading new_gt_subtitle new_gt_font_normal new_gt_bottom_border" style="font-family: 'Titillium Web'; font-weight: 400">Brandon was the most misfortunate with performance compared to<br>
projection this past season.</th>
</tr>
<tr class="header new_gt_col_headings">
<th id="Team" class="new_gt_col_heading new_gt_columns_bottom_border new_gt_left" data-quarto-table-cell-role="th" style="color: #FFFFFF; font-family: 'Titillium Web'; text-transform: uppercase; font-size: 14px; vertical-align: bottom; font-weight: 200; border-top-width: 0px; border-top-style: solid; border-top-color: #222222" scope="col">Team</th>
<th id="Team" class="new_gt_col_heading new_gt_columns_bottom_border new_gt_right" data-quarto-table-cell-role="th" style="color: #FFFFFF; font-family: 'Titillium Web'; text-transform: uppercase; font-size: 14px; vertical-align: bottom; font-weight: 200; border-top-width: 0px; border-top-style: solid; border-top-color: #222222" scope="col">Team</th>
<th id="Opponent" class="new_gt_col_heading new_gt_columns_bottom_border new_gt_right" data-quarto-table-cell-role="th" style="color: #FFFFFF; font-family: 'Titillium Web'; text-transform: uppercase; font-size: 14px; vertical-align: bottom; font-weight: 200; border-top-width: 0px; border-top-style: solid; border-top-color: #222222" scope="col">Opponent</th>
<th id="Team -<br/>Opponent" class="new_gt_col_heading new_gt_columns_bottom_border new_gt_right" data-quarto-table-cell-role="th" style="color: #FFFFFF; font-family: 'Titillium Web'; text-transform: uppercase; font-size: 14px; vertical-align: bottom; font-weight: 200; border-top-width: 0px; border-top-style: solid; border-top-color: #222222" scope="col">Team -<br>
Opponent</th>
</tr>
</thead>
<tbody class="new_gt_table_body">
<tr class="odd">
<td class="new_gt_row new_gt_left" headers="team">Brandon</td>
<td class="new_gt_row new_gt_right" headers="user_d_per_game" style="background-color: rgba(140,81,10,0.9); color: #FFFFFF">−11.1</td>
<td class="new_gt_row new_gt_right" headers="opponent_d_per_game" style="background-color: rgba(123,195,188,0.9); color: #000000">4.7</td>
<td class="new_gt_row new_gt_right" headers="total_d_per_game" style="background-color: rgba(140,81,10,0.9); color: #FFFFFF">−15.8</td>
</tr>
<tr class="even">
<td class="new_gt_row new_gt_left" headers="team">Drake</td>
<td class="new_gt_row new_gt_right" headers="user_d_per_game" style="background-color: rgba(231,203,143,0.9); color: #000000">−5.7</td>
<td class="new_gt_row new_gt_right" headers="opponent_d_per_game" style="background-color: rgba(64,152,144,0.9); color: #FFFFFF">6.4</td>
<td class="new_gt_row new_gt_right" headers="total_d_per_game" style="background-color: rgba(193,148,74,0.9); color: #FFFFFF">−12.1</td>
</tr>
<tr class="odd">
<td class="new_gt_row new_gt_left" headers="team">Tony</td>
<td class="new_gt_row new_gt_right" headers="user_d_per_game" style="background-color: rgba(247,236,208,0.9); color: #000000">−2.8</td>
<td class="new_gt_row new_gt_right" headers="opponent_d_per_game" style="background-color: rgba(1,102,94,0.9); color: #FFFFFF">8.2</td>
<td class="new_gt_row new_gt_right" headers="total_d_per_game" style="background-color: rgba(210,170,93,0.9); color: #000000">−11.0</td>
</tr>
<tr class="even">
<td class="new_gt_row new_gt_left" headers="team">Juan</td>
<td class="new_gt_row new_gt_right" headers="user_d_per_game" style="background-color: rgba(182,225,219,0.9); color: #000000">2.0</td>
<td class="new_gt_row new_gt_right" headers="opponent_d_per_game" style="background-color: rgba(47,135,127,0.9); color: #FFFFFF">7.0</td>
<td class="new_gt_row new_gt_right" headers="total_d_per_game" style="background-color: rgba(246,233,198,0.9); color: #000000">−5.0</td>
</tr>
<tr class="odd">
<td class="new_gt_row new_gt_left" headers="team">Alan</td>
<td class="new_gt_row new_gt_right" headers="user_d_per_game" style="background-color: rgba(247,242,230,0.9); color: #000000">−1.2</td>
<td class="new_gt_row new_gt_right" headers="opponent_d_per_game" style="background-color: rgba(247,240,224,0.9); color: #000000">−2.1</td>
<td class="new_gt_row new_gt_right" headers="total_d_per_game" style="background-color: rgba(237,244,243,0.9); color: #000000">0.9</td>
</tr>
<tr class="even">
<td class="new_gt_row new_gt_left" headers="team">Andrew L.</td>
<td class="new_gt_row new_gt_right" headers="user_d_per_game" style="background-color: rgba(212,238,234,0.9); color: #000000">1.3</td>
<td class="new_gt_row new_gt_right" headers="opponent_d_per_game" style="background-color: rgba(247,242,231,0.9); color: #000000">−1.5</td>
<td class="new_gt_row new_gt_right" headers="total_d_per_game" style="background-color: rgba(218,239,236,0.9); color: #000000">2.8</td>
</tr>
<tr class="odd">
<td class="new_gt_row new_gt_left" headers="team">Luis</td>
<td class="new_gt_row new_gt_right" headers="user_d_per_game" style="background-color: rgba(247,238,215,0.9); color: #000000">−2.2</td>
<td class="new_gt_row new_gt_right" headers="opponent_d_per_game" style="background-color: rgba(227,196,131,0.9); color: #000000">−8.2</td>
<td class="new_gt_row new_gt_right" headers="total_d_per_game" style="background-color: rgba(166,217,211,0.9); color: #000000">6.0</td>
</tr>
<tr class="even">
<td class="new_gt_row new_gt_left" headers="team">Enrique</td>
<td class="new_gt_row new_gt_right" headers="user_d_per_game" style="background-color: rgba(121,194,187,0.9); color: #000000">3.0</td>
<td class="new_gt_row new_gt_right" headers="opponent_d_per_game" style="background-color: rgba(238,215,166,0.9); color: #000000">−6.4</td>
<td class="new_gt_row new_gt_right" headers="total_d_per_game" style="background-color: rgba(84,173,165,0.9); color: #FFFFFF">9.4</td>
</tr>
<tr class="odd">
<td class="new_gt_row new_gt_left" headers="team">Manny</td>
<td class="new_gt_row new_gt_right" headers="user_d_per_game" style="background-color: rgba(246,233,197,0.9); color: #000000">−3.5</td>
<td class="new_gt_row new_gt_right" headers="opponent_d_per_game" style="background-color: rgba(140,81,10,0.9); color: #FFFFFF">−14.7</td>
<td class="new_gt_row new_gt_right" headers="total_d_per_game" style="background-color: rgba(55,143,135,0.9); color: #FFFFFF">11.2</td>
</tr>
<tr class="even">
<td class="new_gt_row new_gt_left" headers="team">Andrew E.</td>
<td class="new_gt_row new_gt_right" headers="user_d_per_game" style="background-color: rgba(1,102,94,0.9); color: #FFFFFF">5.2</td>
<td class="new_gt_row new_gt_right" headers="opponent_d_per_game" style="background-color: rgba(226,194,128,0.9); color: #000000">−8.4</td>
<td class="new_gt_row new_gt_right" headers="total_d_per_game" style="background-color: rgba(1,102,94,0.9); color: #FFFFFF">13.6</td>
</tr>
</tbody>
</table>

</div>

<div id="total_season_points_above_projected" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
  <style>@import url("https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
@import url("https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
@import url("https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
@import url("https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
@import url("https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
#total_season_points_above_projected table {
  font-family: 'Titillium Web', system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#total_season_points_above_projected thead, #total_season_points_above_projected tbody, #total_season_points_above_projected tfoot, #total_season_points_above_projected tr, #total_season_points_above_projected td, #total_season_points_above_projected th {
  border-style: none;
}

#total_season_points_above_projected p {
  margin: 0;
  padding: 0;
}

#total_season_points_above_projected .new_gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #FFFFFF;
  font-size: 16px;
  font-weight: 400;
  font-style: normal;
  background-color: #222222;
  width: auto;
  border-top-style: none;
  border-top-width: 3px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #222222;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #222222;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #222222;
}

#total_season_points_above_projected .new_gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#total_season_points_above_projected .new_gt_title {
  color: #FFFFFF;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #222222;
  border-bottom-width: 0;
}

#total_season_points_above_projected .new_gt_subtitle {
  color: #FFFFFF;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #222222;
  border-top-width: 0;
}

#total_season_points_above_projected .new_gt_heading {
  background-color: #222222;
  text-align: left;
  border-bottom-color: #222222;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#total_season_points_above_projected .new_gt_bottom_border {
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#total_season_points_above_projected .new_gt_col_headings {
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 3px;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#total_season_points_above_projected .new_gt_col_heading {
  color: #FFFFFF;
  background-color: #222222;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#total_season_points_above_projected .new_gt_column_spanner_outer {
  color: #FFFFFF;
  background-color: #222222;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#total_season_points_above_projected .new_gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#total_season_points_above_projected .new_gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#total_season_points_above_projected .new_gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 3px;
  border-bottom-color: #FFFFFF;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#total_season_points_above_projected .new_gt_spanner_row {
  border-bottom-style: hidden;
}

#total_season_points_above_projected .new_gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #FFFFFF;
  background-color: #222222;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #222222;
  border-bottom-style: solid;
  border-bottom-width: 1px;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#total_season_points_above_projected .new_gt_empty_group_heading {
  padding: 0.5px;
  color: #FFFFFF;
  background-color: #222222;
  font-size: 100%;
  font-weight: initial;
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #222222;
  border-bottom-style: solid;
  border-bottom-width: 1px;
  border-bottom-color: #FFFFFF;
  vertical-align: middle;
}

#total_season_points_above_projected .new_gt_from_md > :first-child {
  margin-top: 0;
}

#total_season_points_above_projected .new_gt_from_md > :last-child {
  margin-bottom: 0;
}

#total_season_points_above_projected .new_gt_row {
  padding-top: 7px;
  padding-bottom: 7px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#total_season_points_above_projected .new_gt_stub {
  color: #FFFFFF;
  background-color: #222222;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 0px;
  border-right-color: #FFFFFF;
  padding-left: 5px;
  padding-right: 5px;
}

#total_season_points_above_projected .new_gt_stub_row_group {
  color: #FFFFFF;
  background-color: #222222;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#total_season_points_above_projected .new_gt_row_group_first td {
  border-top-width: 2px;
}

#total_season_points_above_projected .new_gt_row_group_first th {
  border-top-width: 2px;
}

#total_season_points_above_projected .new_gt_summary_row {
  color: #FFFFFF;
  background-color: #222222;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#total_season_points_above_projected .new_gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#total_season_points_above_projected .new_gt_first_summary_row.thick {
  border-top-width: 2px;
}

#total_season_points_above_projected .new_gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#total_season_points_above_projected .new_gt_grand_summary_row {
  color: #FFFFFF;
  background-color: #222222;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#total_season_points_above_projected .new_gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#total_season_points_above_projected .new_gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#total_season_points_above_projected .new_gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#total_season_points_above_projected .new_gt_table_body {
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #222222;
}

#total_season_points_above_projected .new_gt_footnotes {
  color: #FFFFFF;
  background-color: #222222;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#total_season_points_above_projected .new_gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#total_season_points_above_projected .new_gt_sourcenotes {
  color: #FFFFFF;
  background-color: #222222;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#total_season_points_above_projected .new_gt_sourcenote {
  font-size: 12px;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#total_season_points_above_projected .new_gt_left {
  text-align: left;
}

#total_season_points_above_projected .new_gt_center {
  text-align: center;
}

#total_season_points_above_projected .new_gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#total_season_points_above_projected .new_gt_font_normal {
  font-weight: normal;
}

#total_season_points_above_projected .new_gt_font_bold {
  font-weight: bold;
}

#total_season_points_above_projected .new_gt_font_italic {
  font-style: italic;
}

#total_season_points_above_projected .new_gt_super {
  font-size: 65%;
}

#total_season_points_above_projected .new_gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#total_season_points_above_projected .new_gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#total_season_points_above_projected .new_gt_indent_1 {
  text-indent: 5px;
}

#total_season_points_above_projected .new_gt_indent_2 {
  text-indent: 10px;
}

#total_season_points_above_projected .new_gt_indent_3 {
  text-indent: 15px;
}

#total_season_points_above_projected .new_gt_indent_4 {
  text-indent: 20px;
}

#total_season_points_above_projected .new_gt_indent_5 {
  text-indent: 25px;
}

#total_season_points_above_projected tbody tr:last-child {
  border-bottom: 2px solid #ffffff00;
}
</style>
  
<table class="new_gt_table table" data-quarto-postprocess="true">
<colgroup>
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
</colgroup>
<thead>
<tr class="header new_gt_heading">
<th colspan="7" class="new_gt_heading new_gt_title new_gt_font_normal" style="font-family: 'Titillium Web'; font-weight: 700">Avg. Weekly Actual - Projected Points<br>
Minus Opponent's Actual - Projected Points</th>
</tr>
<tr class="odd new_gt_heading">
<th colspan="7" class="new_gt_heading new_gt_subtitle new_gt_font_normal new_gt_bottom_border" style="font-family: 'Titillium Web'; font-weight: 400">Drake has under-performed projections the most on average since 2018.</th>
</tr>
<tr class="header new_gt_col_headings">
<th id="Team" class="new_gt_col_heading new_gt_columns_bottom_border new_gt_left" data-quarto-table-cell-role="th" style="color: #FFFFFF; font-family: 'Titillium Web'; text-transform: uppercase; font-size: 14px; vertical-align: bottom; font-weight: 200; border-top-width: 0px; border-top-style: solid; border-top-color: #222222" scope="col">Team</th>
<th id="2019" class="new_gt_col_heading new_gt_columns_bottom_border new_gt_right" data-quarto-table-cell-role="th" style="color: #FFFFFF; font-family: 'Titillium Web'; text-transform: uppercase; font-size: 14px; vertical-align: bottom; font-weight: 200; border-top-width: 0px; border-top-style: solid; border-top-color: #222222" scope="col">2019</th>
<th id="2020" class="new_gt_col_heading new_gt_columns_bottom_border new_gt_right" data-quarto-table-cell-role="th" style="color: #FFFFFF; font-family: 'Titillium Web'; text-transform: uppercase; font-size: 14px; vertical-align: bottom; font-weight: 200; border-top-width: 0px; border-top-style: solid; border-top-color: #222222" scope="col">2020</th>
<th id="2021" class="new_gt_col_heading new_gt_columns_bottom_border new_gt_right" data-quarto-table-cell-role="th" style="color: #FFFFFF; font-family: 'Titillium Web'; text-transform: uppercase; font-size: 14px; vertical-align: bottom; font-weight: 200; border-top-width: 0px; border-top-style: solid; border-top-color: #222222" scope="col">2021</th>
<th id="2022" class="new_gt_col_heading new_gt_columns_bottom_border new_gt_right" data-quarto-table-cell-role="th" style="color: #FFFFFF; font-family: 'Titillium Web'; text-transform: uppercase; font-size: 14px; vertical-align: bottom; font-weight: 200; border-top-width: 0px; border-top-style: solid; border-top-color: #222222" scope="col">2022</th>
<th id="2023" class="new_gt_col_heading new_gt_columns_bottom_border new_gt_right" data-quarto-table-cell-role="th" style="color: #FFFFFF; font-family: 'Titillium Web'; text-transform: uppercase; font-size: 14px; vertical-align: bottom; font-weight: 200; border-top-width: 0px; border-top-style: solid; border-top-color: #222222" scope="col">2023</th>
<th id="Total" class="new_gt_col_heading new_gt_columns_bottom_border new_gt_right" data-quarto-table-cell-role="th" style="color: #FFFFFF; font-family: 'Titillium Web'; text-transform: uppercase; font-size: 14px; vertical-align: bottom; font-weight: 200; border-top-width: 0px; border-top-style: solid; border-top-color: #222222" scope="col">Total</th>
</tr>
</thead>
<tbody class="new_gt_table_body">
<tr class="odd">
<td class="new_gt_row new_gt_left" headers="team">Drake</td>
<td class="new_gt_row new_gt_right" headers="2019" style="background-color: rgba(158,103,33,0.9); color: #FFFFFF">−13.2</td>
<td class="new_gt_row new_gt_right" headers="2020" style="background-color: rgba(214,238,234,0.9); color: #000000">5.0</td>
<td class="new_gt_row new_gt_right" headers="2021" style="background-color: rgba(193,148,74,0.9); color: #FFFFFF">−5.8</td>
<td class="new_gt_row new_gt_right" headers="2022" style="background-color: rgba(247,244,238,0.9); color: #000000">−0.3</td>
<td class="new_gt_row new_gt_right" headers="2023" style="background-color: rgba(193,148,74,0.9); color: #FFFFFF">−12.1</td>
<td class="new_gt_row new_gt_right" headers="Total" style="background-color: rgba(140,81,10,0.9); color: #FFFFFF">−5.4</td>
</tr>
<tr class="even">
<td class="new_gt_row new_gt_left" headers="team">Brandon</td>
<td class="new_gt_row new_gt_right" headers="2019" style="background-color: rgba(140,81,10,0.9); color: #FFFFFF">−14.3</td>
<td class="new_gt_row new_gt_right" headers="2020" style="background-color: rgba(233,243,242,0.9); color: #000000">2.1</td>
<td class="new_gt_row new_gt_right" headers="2021" style="background-color: rgba(67,155,147,0.9); color: #FFFFFF">7.0</td>
<td class="new_gt_row new_gt_right" headers="2022" style="background-color: rgba(196,152,77,0.9); color: #FFFFFF">−4.2</td>
<td class="new_gt_row new_gt_right" headers="2023" style="background-color: rgba(140,81,10,0.9); color: #FFFFFF">−15.8</td>
<td class="new_gt_row new_gt_right" headers="Total" style="background-color: rgba(157,102,32,0.9); color: #FFFFFF">−5.0</td>
</tr>
<tr class="odd">
<td class="new_gt_row new_gt_left" headers="team">Juan</td>
<td class="new_gt_row new_gt_right" headers="2019" style="background-color: rgba(219,239,236,0.9); color: #000000">3.5</td>
<td class="new_gt_row new_gt_right" headers="2020" style="background-color: rgba(140,81,10,0.9); color: #FFFFFF">−17.3</td>
<td class="new_gt_row new_gt_right" headers="2021" style="background-color: rgba(173,122,51,0.9); color: #FFFFFF">−6.5</td>
<td class="new_gt_row new_gt_right" headers="2022" style="background-color: rgba(1,102,94,0.9); color: #FFFFFF">6.9</td>
<td class="new_gt_row new_gt_right" headers="2023" style="background-color: rgba(246,233,198,0.9); color: #000000">−5.0</td>
<td class="new_gt_row new_gt_right" headers="Total" style="background-color: rgba(218,182,107,0.9); color: #000000">−3.5</td>
</tr>
<tr class="even">
<td class="new_gt_row new_gt_left" headers="team">Luis</td>
<td class="new_gt_row new_gt_right" headers="2019" style="background-color: rgba(224,192,125,0.9); color: #000000">−8.3</td>
<td class="new_gt_row new_gt_right" headers="2020" style="background-color: rgba(187,140,66,0.9); color: #FFFFFF">−13.8</td>
<td class="new_gt_row new_gt_right" headers="2021" style="background-color: rgba(112,190,182,0.9); color: #000000">5.5</td>
<td class="new_gt_row new_gt_right" headers="2022" style="background-color: rgba(140,81,10,0.9); color: #FFFFFF">−5.5</td>
<td class="new_gt_row new_gt_right" headers="2023" style="background-color: rgba(166,217,211,0.9); color: #000000">6.0</td>
<td class="new_gt_row new_gt_right" headers="Total" style="background-color: rgba(231,203,144,0.9); color: #000000">−2.8</td>
</tr>
<tr class="odd">
<td class="new_gt_row new_gt_left" headers="team">Andrew E.</td>
<td class="new_gt_row new_gt_right" headers="2019" style="background-color: rgba(247,240,224,0.9); color: #000000">−2.1</td>
<td class="new_gt_row new_gt_right" headers="2020" style="background-color: rgba(235,211,157,0.9); color: #000000">−8.1</td>
<td class="new_gt_row new_gt_right" headers="2021" style="background-color: rgba(140,81,10,0.9); color: #FFFFFF">−7.5</td>
<td class="new_gt_row new_gt_right" headers="2022" style="background-color: rgba(204,235,231,0.9); color: #000000">2.1</td>
<td class="new_gt_row new_gt_right" headers="2023" style="background-color: rgba(1,102,94,0.9); color: #FFFFFF">13.6</td>
<td class="new_gt_row new_gt_right" headers="Total" style="background-color: rgba(247,246,243,0.9); color: #000000">−0.1</td>
</tr>
<tr class="even">
<td class="new_gt_row new_gt_left" headers="team">Enrique</td>
<td class="new_gt_row new_gt_right" headers="2019" style="background-color: rgba(207,236,232,0.9); color: #000000">5.0</td>
<td class="new_gt_row new_gt_right" headers="2020" style="background-color: rgba(237,244,243,0.9); color: #000000">1.6</td>
<td class="new_gt_row new_gt_right" headers="2021" style="background-color: rgba(246,232,196,0.9); color: #000000">−2.5</td>
<td class="new_gt_row new_gt_right" headers="2022" style="background-color: rgba(247,240,224,0.9); color: #000000">−0.8</td>
<td class="new_gt_row new_gt_right" headers="2023" style="background-color: rgba(84,173,165,0.9); color: #FFFFFF">9.4</td>
<td class="new_gt_row new_gt_right" headers="Total" style="background-color: rgba(144,205,198,0.9); color: #000000">2.5</td>
</tr>
<tr class="odd">
<td class="new_gt_row new_gt_left" headers="team">Tony</td>
<td class="new_gt_row new_gt_right" headers="2019" style="background-color: rgba(1,102,94,0.9); color: #FFFFFF">17.7</td>
<td class="new_gt_row new_gt_right" headers="2020" style="background-color: rgba(236,244,243,0.9); color: #000000">1.7</td>
<td class="new_gt_row new_gt_right" headers="2021" style="background-color: rgba(120,193,186,0.9); color: #000000">5.3</td>
<td class="new_gt_row new_gt_right" headers="2022" style="background-color: rgba(216,239,235,0.9); color: #000000">1.5</td>
<td class="new_gt_row new_gt_right" headers="2023" style="background-color: rgba(210,170,93,0.9); color: #000000">−11.0</td>
<td class="new_gt_row new_gt_right" headers="Total" style="background-color: rgba(134,200,193,0.9); color: #000000">2.6</td>
</tr>
<tr class="even">
<td class="new_gt_row new_gt_left" headers="team">Manny</td>
<td class="new_gt_row new_gt_right" headers="2019" style="background-color: rgba(247,242,228,0.9); color: #000000">−1.7</td>
<td class="new_gt_row new_gt_right" headers="2020" style="background-color: rgba(247,246,242,0.9); color: #000000">−0.5</td>
<td class="new_gt_row new_gt_right" headers="2021" style="background-color: rgba(247,243,233,0.9); color: #000000">−0.7</td>
<td class="new_gt_row new_gt_right" headers="2022" style="background-color: rgba(56,144,136,0.9); color: #FFFFFF">5.6</td>
<td class="new_gt_row new_gt_right" headers="2023" style="background-color: rgba(55,143,135,0.9); color: #FFFFFF">11.2</td>
<td class="new_gt_row new_gt_right" headers="Total" style="background-color: rgba(108,188,180,0.9); color: #000000">3.0</td>
</tr>
<tr class="odd">
<td class="new_gt_row new_gt_left" headers="team">Andrew L.</td>
<td class="new_gt_row new_gt_right" headers="2019" style="background-color: rgba(220,240,237,0.9); color: #000000">3.3</td>
<td class="new_gt_row new_gt_right" headers="2020" style="background-color: rgba(1,102,94,0.9); color: #FFFFFF">21.6</td>
<td class="new_gt_row new_gt_right" headers="2021" style="background-color: rgba(229,200,139,0.9); color: #000000">−4.0</td>
<td class="new_gt_row new_gt_right" headers="2022" style="background-color: rgba(228,197,134,0.9); color: #000000">−3.0</td>
<td class="new_gt_row new_gt_right" headers="2023" style="background-color: rgba(218,239,236,0.9); color: #000000">2.8</td>
<td class="new_gt_row new_gt_right" headers="Total" style="background-color: rgba(73,162,154,0.9); color: #FFFFFF">3.6</td>
</tr>
<tr class="even">
<td class="new_gt_row new_gt_left" headers="team">Alan</td>
<td class="new_gt_row new_gt_right" headers="2019" style="background-color: rgba(124,195,188,0.9); color: #000000">10.1</td>
<td class="new_gt_row new_gt_right" headers="2020" style="background-color: rgba(192,231,225,0.9); color: #000000">7.7</td>
<td class="new_gt_row new_gt_right" headers="2021" style="background-color: rgba(1,102,94,0.9); color: #FFFFFF">9.1</td>
<td class="new_gt_row new_gt_right" headers="2022" style="background-color: rgba(240,219,173,0.9); color: #000000">−2.3</td>
<td class="new_gt_row new_gt_right" headers="2023" style="background-color: rgba(237,244,243,0.9); color: #000000">0.9</td>
<td class="new_gt_row new_gt_right" headers="Total" style="background-color: rgba(1,102,94,0.9); color: #FFFFFF">4.9</td>
</tr>
</tbody><tfoot class="new_gt_footnotes">
<tr class="odd">
<td colspan="7" class="new_gt_footnote">2018 season excluded due to miscalibrated projected points.</td>
</tr>
</tfoot>

</table>

</div>
<p>Observations:</p>
<ul>
<li>I benefited from the second most fortunate season in 2019. I averaged 13.0 points per game above my projected score, and my opponents scored 4.7 less than their projected scores, adding up to +17.7.</li>
<li>Drake has under-performed and Alan has over-performed in 4 of the past 5 seasons. Interestingly, I have also over-performed in 4 of the past 5 seasons, but was fairly unfortunate this past season.</li>
<li>The variance in weekly performance against expectation (as defined by projected points) is not directly represented by this table, which shows averages. The standard deviation of the weekly difference in the actual points minus projected points for both teams in a matchup is about 32.5!</li>
</ul>
</section>
<section id="lost-opportunity" class="level3">
<h3 class="anchored" data-anchor-id="lost-opportunity">Lost Opportunity</h3>
<p>How many points did teams “leave on the bench”? This is not something managers typically think about when looking to see how unlucky they might have been (partially because it’s not the easiest thing to calculate), but it’s worth looking at, as it gives us some sense of who is best at minimizing their own downside (by starting the best players).<sup>5</sup></p>

<div id="latest_season_replacement_improvement" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
  <style>@import url("https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
@import url("https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
@import url("https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
@import url("https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
@import url("https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
#latest_season_replacement_improvement table {
  font-family: 'Titillium Web', system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#latest_season_replacement_improvement thead, #latest_season_replacement_improvement tbody, #latest_season_replacement_improvement tfoot, #latest_season_replacement_improvement tr, #latest_season_replacement_improvement td, #latest_season_replacement_improvement th {
  border-style: none;
}

#latest_season_replacement_improvement p {
  margin: 0;
  padding: 0;
}

#latest_season_replacement_improvement .new_gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #FFFFFF;
  font-size: 16px;
  font-weight: 400;
  font-style: normal;
  background-color: #222222;
  width: auto;
  border-top-style: none;
  border-top-width: 3px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #222222;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #222222;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #222222;
}

#latest_season_replacement_improvement .new_gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#latest_season_replacement_improvement .new_gt_title {
  color: #FFFFFF;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #222222;
  border-bottom-width: 0;
}

#latest_season_replacement_improvement .new_gt_subtitle {
  color: #FFFFFF;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #222222;
  border-top-width: 0;
}

#latest_season_replacement_improvement .new_gt_heading {
  background-color: #222222;
  text-align: left;
  border-bottom-color: #222222;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#latest_season_replacement_improvement .new_gt_bottom_border {
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#latest_season_replacement_improvement .new_gt_col_headings {
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 3px;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#latest_season_replacement_improvement .new_gt_col_heading {
  color: #FFFFFF;
  background-color: #222222;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#latest_season_replacement_improvement .new_gt_column_spanner_outer {
  color: #FFFFFF;
  background-color: #222222;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#latest_season_replacement_improvement .new_gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#latest_season_replacement_improvement .new_gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#latest_season_replacement_improvement .new_gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 3px;
  border-bottom-color: #FFFFFF;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#latest_season_replacement_improvement .new_gt_spanner_row {
  border-bottom-style: hidden;
}

#latest_season_replacement_improvement .new_gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #FFFFFF;
  background-color: #222222;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #222222;
  border-bottom-style: solid;
  border-bottom-width: 1px;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#latest_season_replacement_improvement .new_gt_empty_group_heading {
  padding: 0.5px;
  color: #FFFFFF;
  background-color: #222222;
  font-size: 100%;
  font-weight: initial;
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #222222;
  border-bottom-style: solid;
  border-bottom-width: 1px;
  border-bottom-color: #FFFFFF;
  vertical-align: middle;
}

#latest_season_replacement_improvement .new_gt_from_md > :first-child {
  margin-top: 0;
}

#latest_season_replacement_improvement .new_gt_from_md > :last-child {
  margin-bottom: 0;
}

#latest_season_replacement_improvement .new_gt_row {
  padding-top: 7px;
  padding-bottom: 7px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#latest_season_replacement_improvement .new_gt_stub {
  color: #FFFFFF;
  background-color: #222222;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 0px;
  border-right-color: #FFFFFF;
  padding-left: 5px;
  padding-right: 5px;
}

#latest_season_replacement_improvement .new_gt_stub_row_group {
  color: #FFFFFF;
  background-color: #222222;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#latest_season_replacement_improvement .new_gt_row_group_first td {
  border-top-width: 2px;
}

#latest_season_replacement_improvement .new_gt_row_group_first th {
  border-top-width: 2px;
}

#latest_season_replacement_improvement .new_gt_summary_row {
  color: #FFFFFF;
  background-color: #222222;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#latest_season_replacement_improvement .new_gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#latest_season_replacement_improvement .new_gt_first_summary_row.thick {
  border-top-width: 2px;
}

#latest_season_replacement_improvement .new_gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#latest_season_replacement_improvement .new_gt_grand_summary_row {
  color: #FFFFFF;
  background-color: #222222;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#latest_season_replacement_improvement .new_gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#latest_season_replacement_improvement .new_gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#latest_season_replacement_improvement .new_gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#latest_season_replacement_improvement .new_gt_table_body {
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #222222;
}

#latest_season_replacement_improvement .new_gt_footnotes {
  color: #FFFFFF;
  background-color: #222222;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#latest_season_replacement_improvement .new_gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#latest_season_replacement_improvement .new_gt_sourcenotes {
  color: #FFFFFF;
  background-color: #222222;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#latest_season_replacement_improvement .new_gt_sourcenote {
  font-size: 12px;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#latest_season_replacement_improvement .new_gt_left {
  text-align: left;
}

#latest_season_replacement_improvement .new_gt_center {
  text-align: center;
}

#latest_season_replacement_improvement .new_gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#latest_season_replacement_improvement .new_gt_font_normal {
  font-weight: normal;
}

#latest_season_replacement_improvement .new_gt_font_bold {
  font-weight: bold;
}

#latest_season_replacement_improvement .new_gt_font_italic {
  font-style: italic;
}

#latest_season_replacement_improvement .new_gt_super {
  font-size: 65%;
}

#latest_season_replacement_improvement .new_gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#latest_season_replacement_improvement .new_gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#latest_season_replacement_improvement .new_gt_indent_1 {
  text-indent: 5px;
}

#latest_season_replacement_improvement .new_gt_indent_2 {
  text-indent: 10px;
}

#latest_season_replacement_improvement .new_gt_indent_3 {
  text-indent: 15px;
}

#latest_season_replacement_improvement .new_gt_indent_4 {
  text-indent: 20px;
}

#latest_season_replacement_improvement .new_gt_indent_5 {
  text-indent: 25px;
}

#latest_season_replacement_improvement tbody tr:last-child {
  border-bottom: 2px solid #ffffff00;
}
</style>
  
<table class="new_gt_table table" data-quarto-postprocess="true">
<colgroup>
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
</colgroup>
<thead>
<tr class="header new_gt_heading">
<th colspan="4" class="new_gt_heading new_gt_title new_gt_font_normal" style="font-family: 'Titillium Web'; font-weight: 700">2023 Avg. Weekly "Lost Opportunity"<br>
with Sub-Optimal Starter Choices</th>
</tr>
<tr class="odd new_gt_heading">
<th colspan="4" class="new_gt_heading new_gt_subtitle new_gt_font_normal new_gt_bottom_border" style="font-family: 'Titillium Web'; font-weight: 400">Brandon lost out on the most points this season by not starting<br>
bench players that scored more than his starters.</th>
</tr>
<tr class="header new_gt_col_headings">
<th id="Team" class="new_gt_col_heading new_gt_columns_bottom_border new_gt_left" data-quarto-table-cell-role="th" style="color: #FFFFFF; font-family: 'Titillium Web'; text-transform: uppercase; font-size: 14px; vertical-align: bottom; font-weight: 200; border-top-width: 0px; border-top-style: solid; border-top-color: #222222" scope="col">Team</th>
<th id="# of sub-optimal<br/>starters" class="new_gt_col_heading new_gt_columns_bottom_border new_gt_right" data-quarto-table-cell-role="th" style="color: #FFFFFF; font-family: 'Titillium Web'; text-transform: uppercase; font-size: 14px; vertical-align: bottom; font-weight: 200; border-top-width: 0px; border-top-style: solid; border-top-color: #222222" scope="col"># of sub-optimal<br>
starters</th>
<th id="Score improvement<br/>with best lineup" class="new_gt_col_heading new_gt_columns_bottom_border new_gt_right" data-quarto-table-cell-role="th" style="color: #FFFFFF; font-family: 'Titillium Web'; text-transform: uppercase; font-size: 14px; vertical-align: bottom; font-weight: 200; border-top-width: 0px; border-top-style: solid; border-top-color: #222222" scope="col">Score improvement<br>
with best lineup</th>
<th id="League avg.<br/>score improvement -<br/>score improvement" class="new_gt_col_heading new_gt_columns_bottom_border new_gt_right" data-quarto-table-cell-role="th" style="color: #FFFFFF; font-family: 'Titillium Web'; text-transform: uppercase; font-size: 14px; vertical-align: bottom; font-weight: 200; border-top-width: 0px; border-top-style: solid; border-top-color: #222222" scope="col">League avg.<br>
score improvement -<br>
score improvement</th>
</tr>
</thead>
<tbody class="new_gt_table_body">
<tr class="odd">
<td class="new_gt_row new_gt_left" headers="team">Brandon</td>
<td class="new_gt_row new_gt_right" headers="avg_n_replacements" style="background-color: #007163; color: #FFFFFF">2.6</td>
<td class="new_gt_row new_gt_right" headers="avg_score_improvement" style="background-color: #FF6E00; color: #FFFFFF">27.7</td>
<td class="new_gt_row new_gt_right" headers="avg_score_improvement_d" style="background-color: rgba(197,27,125,0.9); color: #FFFFFF">−7.8</td>
</tr>
<tr class="even">
<td class="new_gt_row new_gt_left" headers="team">Andrew E.</td>
<td class="new_gt_row new_gt_right" headers="avg_n_replacements" style="background-color: #2EA99E; color: #FFFFFF">2.3</td>
<td class="new_gt_row new_gt_right" headers="avg_score_improvement" style="background-color: #FF9F00; color: #000000">24.1</td>
<td class="new_gt_row new_gt_right" headers="avg_score_improvement_d" style="background-color: rgba(241,187,216,0.9); color: #000000">−4.2</td>
</tr>
<tr class="odd">
<td class="new_gt_row new_gt_left" headers="team">Juan</td>
<td class="new_gt_row new_gt_right" headers="avg_n_replacements" style="background-color: #004C3F; color: #FFFFFF">2.8</td>
<td class="new_gt_row new_gt_right" headers="avg_score_improvement" style="background-color: #FFB200; color: #000000">22.3</td>
<td class="new_gt_row new_gt_right" headers="avg_score_improvement_d" style="background-color: rgba(253,226,240,0.9); color: #000000">−2.4</td>
</tr>
<tr class="even">
<td class="new_gt_row new_gt_left" headers="team">Manny</td>
<td class="new_gt_row new_gt_right" headers="avg_n_replacements" style="background-color: #007C6E; color: #FFFFFF">2.6</td>
<td class="new_gt_row new_gt_right" headers="avg_score_improvement" style="background-color: #FEB600; color: #000000">22.0</td>
<td class="new_gt_row new_gt_right" headers="avg_score_improvement_d" style="background-color: rgba(252,229,241,0.9); color: #000000">−2.1</td>
</tr>
<tr class="odd">
<td class="new_gt_row new_gt_left" headers="team">Alan</td>
<td class="new_gt_row new_gt_right" headers="avg_n_replacements" style="background-color: #00887A; color: #FFFFFF">2.5</td>
<td class="new_gt_row new_gt_right" headers="avg_score_improvement" style="background-color: #FEB700; color: #000000">21.9</td>
<td class="new_gt_row new_gt_right" headers="avg_score_improvement_d" style="background-color: rgba(252,230,241,0.9); color: #000000">−2.0</td>
</tr>
<tr class="even">
<td class="new_gt_row new_gt_left" headers="team">Tony</td>
<td class="new_gt_row new_gt_right" headers="avg_n_replacements" style="background-color: #2EA99E; color: #FFFFFF">2.3</td>
<td class="new_gt_row new_gt_right" headers="avg_score_improvement" style="background-color: #FFC925; color: #000000">18.8</td>
<td class="new_gt_row new_gt_right" headers="avg_score_improvement_d" style="background-color: rgba(240,246,231,0.9); color: #000000">1.1</td>
</tr>
<tr class="odd">
<td class="new_gt_row new_gt_left" headers="team">Andrew L.</td>
<td class="new_gt_row new_gt_right" headers="avg_n_replacements" style="background-color: #BEE4E0; color: #000000">2.0</td>
<td class="new_gt_row new_gt_right" headers="avg_score_improvement" style="background-color: #FECE39; color: #000000">17.8</td>
<td class="new_gt_row new_gt_right" headers="avg_score_improvement_d" style="background-color: rgba(235,246,218,0.9); color: #000000">2.1</td>
</tr>
<tr class="even">
<td class="new_gt_row new_gt_left" headers="team">Luis</td>
<td class="new_gt_row new_gt_right" headers="avg_n_replacements" style="background-color: #DFF2F1; color: #000000">1.9</td>
<td class="new_gt_row new_gt_right" headers="avg_score_improvement" style="background-color: #FFD44E; color: #000000">16.9</td>
<td class="new_gt_row new_gt_right" headers="avg_score_improvement_d" style="background-color: rgba(225,243,200,0.9); color: #000000">3.0</td>
</tr>
<tr class="odd">
<td class="new_gt_row new_gt_left" headers="team">Drake</td>
<td class="new_gt_row new_gt_right" headers="avg_n_replacements" style="background-color: #DFF2F1; color: #000000">1.9</td>
<td class="new_gt_row new_gt_right" headers="avg_score_improvement" style="background-color: #FFD961; color: #000000">16.2</td>
<td class="new_gt_row new_gt_right" headers="avg_score_improvement_d" style="background-color: rgba(209,236,176,0.9); color: #000000">3.7</td>
</tr>
<tr class="even">
<td class="new_gt_row new_gt_left" headers="team">Enrique</td>
<td class="new_gt_row new_gt_right" headers="avg_n_replacements" style="background-color: #DFF2F1; color: #000000">1.9</td>
<td class="new_gt_row new_gt_right" headers="avg_score_improvement" style="background-color: #FFF8E0; color: #000000">11.4</td>
<td class="new_gt_row new_gt_right" headers="avg_score_improvement_d" style="background-color: rgba(77,146,33,0.9); color: #FFFFFF">8.5</td>
</tr>
</tbody>
</table>

</div>
<p>The magnitude of the points will vary by league, according to the league’s rules for roster slots and points. If your league is anything like mine, then you can expect to lose out on about 20 points due to about 2 sub-optimal starting roster choices each week.</p>
<p>Now, looking at the “lost opportunity” points compared to the league average for the past 6 seasons, we see that things tend to average out close to zero.</p>

<div id="total_season_replacement_improvement" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
  <style>@import url("https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
@import url("https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
@import url("https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
@import url("https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
@import url("https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
#total_season_replacement_improvement table {
  font-family: 'Titillium Web', system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#total_season_replacement_improvement thead, #total_season_replacement_improvement tbody, #total_season_replacement_improvement tfoot, #total_season_replacement_improvement tr, #total_season_replacement_improvement td, #total_season_replacement_improvement th {
  border-style: none;
}

#total_season_replacement_improvement p {
  margin: 0;
  padding: 0;
}

#total_season_replacement_improvement .new_gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #FFFFFF;
  font-size: 16px;
  font-weight: 400;
  font-style: normal;
  background-color: #222222;
  width: auto;
  border-top-style: none;
  border-top-width: 3px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #222222;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #222222;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #222222;
}

#total_season_replacement_improvement .new_gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#total_season_replacement_improvement .new_gt_title {
  color: #FFFFFF;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #222222;
  border-bottom-width: 0;
}

#total_season_replacement_improvement .new_gt_subtitle {
  color: #FFFFFF;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #222222;
  border-top-width: 0;
}

#total_season_replacement_improvement .new_gt_heading {
  background-color: #222222;
  text-align: left;
  border-bottom-color: #222222;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#total_season_replacement_improvement .new_gt_bottom_border {
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#total_season_replacement_improvement .new_gt_col_headings {
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 3px;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#total_season_replacement_improvement .new_gt_col_heading {
  color: #FFFFFF;
  background-color: #222222;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#total_season_replacement_improvement .new_gt_column_spanner_outer {
  color: #FFFFFF;
  background-color: #222222;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#total_season_replacement_improvement .new_gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#total_season_replacement_improvement .new_gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#total_season_replacement_improvement .new_gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 3px;
  border-bottom-color: #FFFFFF;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#total_season_replacement_improvement .new_gt_spanner_row {
  border-bottom-style: hidden;
}

#total_season_replacement_improvement .new_gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #FFFFFF;
  background-color: #222222;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #222222;
  border-bottom-style: solid;
  border-bottom-width: 1px;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#total_season_replacement_improvement .new_gt_empty_group_heading {
  padding: 0.5px;
  color: #FFFFFF;
  background-color: #222222;
  font-size: 100%;
  font-weight: initial;
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #222222;
  border-bottom-style: solid;
  border-bottom-width: 1px;
  border-bottom-color: #FFFFFF;
  vertical-align: middle;
}

#total_season_replacement_improvement .new_gt_from_md > :first-child {
  margin-top: 0;
}

#total_season_replacement_improvement .new_gt_from_md > :last-child {
  margin-bottom: 0;
}

#total_season_replacement_improvement .new_gt_row {
  padding-top: 7px;
  padding-bottom: 7px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#total_season_replacement_improvement .new_gt_stub {
  color: #FFFFFF;
  background-color: #222222;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 0px;
  border-right-color: #FFFFFF;
  padding-left: 5px;
  padding-right: 5px;
}

#total_season_replacement_improvement .new_gt_stub_row_group {
  color: #FFFFFF;
  background-color: #222222;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#total_season_replacement_improvement .new_gt_row_group_first td {
  border-top-width: 2px;
}

#total_season_replacement_improvement .new_gt_row_group_first th {
  border-top-width: 2px;
}

#total_season_replacement_improvement .new_gt_summary_row {
  color: #FFFFFF;
  background-color: #222222;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#total_season_replacement_improvement .new_gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#total_season_replacement_improvement .new_gt_first_summary_row.thick {
  border-top-width: 2px;
}

#total_season_replacement_improvement .new_gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#total_season_replacement_improvement .new_gt_grand_summary_row {
  color: #FFFFFF;
  background-color: #222222;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#total_season_replacement_improvement .new_gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#total_season_replacement_improvement .new_gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#total_season_replacement_improvement .new_gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#total_season_replacement_improvement .new_gt_table_body {
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #222222;
}

#total_season_replacement_improvement .new_gt_footnotes {
  color: #FFFFFF;
  background-color: #222222;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#total_season_replacement_improvement .new_gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#total_season_replacement_improvement .new_gt_sourcenotes {
  color: #FFFFFF;
  background-color: #222222;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#total_season_replacement_improvement .new_gt_sourcenote {
  font-size: 12px;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#total_season_replacement_improvement .new_gt_left {
  text-align: left;
}

#total_season_replacement_improvement .new_gt_center {
  text-align: center;
}

#total_season_replacement_improvement .new_gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#total_season_replacement_improvement .new_gt_font_normal {
  font-weight: normal;
}

#total_season_replacement_improvement .new_gt_font_bold {
  font-weight: bold;
}

#total_season_replacement_improvement .new_gt_font_italic {
  font-style: italic;
}

#total_season_replacement_improvement .new_gt_super {
  font-size: 65%;
}

#total_season_replacement_improvement .new_gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#total_season_replacement_improvement .new_gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#total_season_replacement_improvement .new_gt_indent_1 {
  text-indent: 5px;
}

#total_season_replacement_improvement .new_gt_indent_2 {
  text-indent: 10px;
}

#total_season_replacement_improvement .new_gt_indent_3 {
  text-indent: 15px;
}

#total_season_replacement_improvement .new_gt_indent_4 {
  text-indent: 20px;
}

#total_season_replacement_improvement .new_gt_indent_5 {
  text-indent: 25px;
}

#total_season_replacement_improvement tbody tr:last-child {
  border-bottom: 2px solid #ffffff00;
}
</style>
  
<table class="new_gt_table table" data-quarto-postprocess="true">
<thead>
<tr class="header new_gt_heading">
<th colspan="8" class="new_gt_heading new_gt_title new_gt_font_normal" style="font-family: 'Titillium Web'; font-weight: 700">"Lost Opportunity" Points with Sub-Optimal Starter Choices</th>
</tr>
<tr class="odd new_gt_heading">
<th colspan="8" class="new_gt_heading new_gt_subtitle new_gt_font_normal new_gt_bottom_border" style="font-family: 'Titillium Web'; font-weight: 400">Over several seasons, "lost opportunity" points level out.</th>
</tr>
<tr class="header new_gt_col_headings">
<th id="Team" class="new_gt_col_heading new_gt_columns_bottom_border new_gt_left" data-quarto-table-cell-role="th" style="color: #FFFFFF; font-family: 'Titillium Web'; text-transform: uppercase; font-size: 14px; vertical-align: bottom; font-weight: 200; border-top-width: 0px; border-top-style: solid; border-top-color: #222222" scope="col">Team</th>
<th id="2018" class="new_gt_col_heading new_gt_columns_bottom_border new_gt_right" data-quarto-table-cell-role="th" style="color: #FFFFFF; font-family: 'Titillium Web'; text-transform: uppercase; font-size: 14px; vertical-align: bottom; font-weight: 200; border-top-width: 0px; border-top-style: solid; border-top-color: #222222" scope="col">2018</th>
<th id="2019" class="new_gt_col_heading new_gt_columns_bottom_border new_gt_right" data-quarto-table-cell-role="th" style="color: #FFFFFF; font-family: 'Titillium Web'; text-transform: uppercase; font-size: 14px; vertical-align: bottom; font-weight: 200; border-top-width: 0px; border-top-style: solid; border-top-color: #222222" scope="col">2019</th>
<th id="2020" class="new_gt_col_heading new_gt_columns_bottom_border new_gt_right" data-quarto-table-cell-role="th" style="color: #FFFFFF; font-family: 'Titillium Web'; text-transform: uppercase; font-size: 14px; vertical-align: bottom; font-weight: 200; border-top-width: 0px; border-top-style: solid; border-top-color: #222222" scope="col">2020</th>
<th id="2021" class="new_gt_col_heading new_gt_columns_bottom_border new_gt_right" data-quarto-table-cell-role="th" style="color: #FFFFFF; font-family: 'Titillium Web'; text-transform: uppercase; font-size: 14px; vertical-align: bottom; font-weight: 200; border-top-width: 0px; border-top-style: solid; border-top-color: #222222" scope="col">2021</th>
<th id="2022" class="new_gt_col_heading new_gt_columns_bottom_border new_gt_right" data-quarto-table-cell-role="th" style="color: #FFFFFF; font-family: 'Titillium Web'; text-transform: uppercase; font-size: 14px; vertical-align: bottom; font-weight: 200; border-top-width: 0px; border-top-style: solid; border-top-color: #222222" scope="col">2022</th>
<th id="2023" class="new_gt_col_heading new_gt_columns_bottom_border new_gt_right" data-quarto-table-cell-role="th" style="color: #FFFFFF; font-family: 'Titillium Web'; text-transform: uppercase; font-size: 14px; vertical-align: bottom; font-weight: 200; border-top-width: 0px; border-top-style: solid; border-top-color: #222222" scope="col">2023</th>
<th id="Total" class="new_gt_col_heading new_gt_columns_bottom_border new_gt_right" data-quarto-table-cell-role="th" style="color: #FFFFFF; font-family: 'Titillium Web'; text-transform: uppercase; font-size: 14px; vertical-align: bottom; font-weight: 200; border-top-width: 0px; border-top-style: solid; border-top-color: #222222" scope="col">Total</th>
</tr>
</thead>
<tbody class="new_gt_table_body">
<tr class="odd">
<td class="new_gt_row new_gt_left" headers="team">Enrique</td>
<td class="new_gt_row new_gt_right" headers="2018" style="background-color: rgba(77,146,33,0.9); color: #FFFFFF">8.1</td>
<td class="new_gt_row new_gt_right" headers="2019" style="background-color: rgba(77,146,33,0.9); color: #FFFFFF">6.7</td>
<td class="new_gt_row new_gt_right" headers="2020" style="background-color: rgba(248,242,245,0.9); color: #000000">−0.6</td>
<td class="new_gt_row new_gt_right" headers="2021" style="background-color: rgba(199,231,161,0.9); color: #000000">7.3</td>
<td class="new_gt_row new_gt_right" headers="2022" style="background-color: rgba(252,229,241,0.9); color: #000000">−3.8</td>
<td class="new_gt_row new_gt_right" headers="2023" style="background-color: rgba(77,146,33,0.9); color: #FFFFFF">8.5</td>
<td class="new_gt_row new_gt_right" headers="Total" style="background-color: rgba(77,146,33,0.9); color: #FFFFFF">4.3</td>
</tr>
<tr class="even">
<td class="new_gt_row new_gt_left" headers="team">Drake</td>
<td class="new_gt_row new_gt_right" headers="2018" style="background-color: rgba(189,227,146,0.9); color: #000000">4.4</td>
<td class="new_gt_row new_gt_right" headers="2019" style="background-color: rgba(247,203,226,0.9); color: #000000">−2.5</td>
<td class="new_gt_row new_gt_right" headers="2020" style="background-color: rgba(77,146,33,0.9); color: #FFFFFF">12.4</td>
<td class="new_gt_row new_gt_right" headers="2021" style="background-color: rgba(252,222,238,0.9); color: #000000">−4.1</td>
<td class="new_gt_row new_gt_right" headers="2022" style="background-color: rgba(94,160,49,0.9); color: #FFFFFF">9.1</td>
<td class="new_gt_row new_gt_right" headers="2023" style="background-color: rgba(209,236,176,0.9); color: #000000">3.7</td>
<td class="new_gt_row new_gt_right" headers="Total" style="background-color: rgba(111,173,63,0.9); color: #FFFFFF">3.8</td>
</tr>
<tr class="odd">
<td class="new_gt_row new_gt_left" headers="team">Juan</td>
<td class="new_gt_row new_gt_right" headers="2018" style="background-color: rgba(203,233,166,0.9); color: #000000">3.8</td>
<td class="new_gt_row new_gt_right" headers="2019" style="background-color: rgba(214,238,183,0.9); color: #000000">2.8</td>
<td class="new_gt_row new_gt_right" headers="2020" style="background-color: rgba(236,246,220,0.9); color: #000000">2.8</td>
<td class="new_gt_row new_gt_right" headers="2021" style="background-color: rgba(235,246,219,0.9); color: #000000">3.6</td>
<td class="new_gt_row new_gt_right" headers="2022" style="background-color: rgba(245,247,243,0.9); color: #000000">0.4</td>
<td class="new_gt_row new_gt_right" headers="2023" style="background-color: rgba(253,226,240,0.9); color: #000000">−2.4</td>
<td class="new_gt_row new_gt_right" headers="Total" style="background-color: rgba(217,239,188,0.9); color: #000000">1.7</td>
</tr>
<tr class="even">
<td class="new_gt_row new_gt_left" headers="team">Alan</td>
<td class="new_gt_row new_gt_right" headers="2018" style="background-color: rgba(237,174,208,0.9); color: #000000">−8.4</td>
<td class="new_gt_row new_gt_right" headers="2019" style="background-color: rgba(204,234,169,0.9); color: #000000">3.1</td>
<td class="new_gt_row new_gt_right" headers="2020" style="background-color: rgba(252,228,240,0.9); color: #000000">−2.4</td>
<td class="new_gt_row new_gt_right" headers="2021" style="background-color: rgba(248,244,246,0.9); color: #000000">−0.5</td>
<td class="new_gt_row new_gt_right" headers="2022" style="background-color: rgba(77,146,33,0.9); color: #FFFFFF">9.8</td>
<td class="new_gt_row new_gt_right" headers="2023" style="background-color: rgba(252,230,241,0.9); color: #000000">−2.0</td>
<td class="new_gt_row new_gt_right" headers="Total" style="background-color: rgba(245,247,243,0.9); color: #000000">0.1</td>
</tr>
<tr class="odd">
<td class="new_gt_row new_gt_left" headers="team">Andrew L.</td>
<td class="new_gt_row new_gt_right" headers="2018" style="background-color: rgba(197,27,125,0.9); color: #FFFFFF">−13.9</td>
<td class="new_gt_row new_gt_right" headers="2019" style="background-color: rgba(251,232,242,0.9); color: #000000">−1.2</td>
<td class="new_gt_row new_gt_right" headers="2020" style="background-color: rgba(204,233,168,0.9); color: #000000">5.7</td>
<td class="new_gt_row new_gt_right" headers="2021" style="background-color: rgba(237,246,223,0.9); color: #000000">3.1</td>
<td class="new_gt_row new_gt_right" headers="2022" style="background-color: rgba(237,246,224,0.9); color: #000000">1.9</td>
<td class="new_gt_row new_gt_right" headers="2023" style="background-color: rgba(235,246,218,0.9); color: #000000">2.1</td>
<td class="new_gt_row new_gt_right" headers="Total" style="background-color: rgba(248,244,246,0.9); color: #000000">−0.2</td>
</tr>
<tr class="even">
<td class="new_gt_row new_gt_left" headers="team">Brandon</td>
<td class="new_gt_row new_gt_right" headers="2018" style="background-color: rgba(193,228,152,0.9); color: #000000">4.2</td>
<td class="new_gt_row new_gt_right" headers="2019" style="background-color: rgba(197,27,125,0.9); color: #FFFFFF">−5.6</td>
<td class="new_gt_row new_gt_right" headers="2020" style="background-color: rgba(197,27,125,0.9); color: #FFFFFF">−8.4</td>
<td class="new_gt_row new_gt_right" headers="2021" style="background-color: rgba(77,146,33,0.9); color: #FFFFFF">15.0</td>
<td class="new_gt_row new_gt_right" headers="2022" style="background-color: rgba(249,240,245,0.9); color: #000000">−1.4</td>
<td class="new_gt_row new_gt_right" headers="2023" style="background-color: rgba(197,27,125,0.9); color: #FFFFFF">−7.8</td>
<td class="new_gt_row new_gt_right" headers="Total" style="background-color: rgba(249,239,244,0.9); color: #000000">−0.5</td>
</tr>
<tr class="odd">
<td class="new_gt_row new_gt_left" headers="team">Luis</td>
<td class="new_gt_row new_gt_right" headers="2018" style="background-color: rgba(252,229,241,0.9); color: #000000">−3.7</td>
<td class="new_gt_row new_gt_right" headers="2019" style="background-color: rgba(223,242,196,0.9); color: #000000">2.5</td>
<td class="new_gt_row new_gt_right" headers="2020" style="background-color: rgba(236,170,206,0.9); color: #000000">−5.2</td>
<td class="new_gt_row new_gt_right" headers="2021" style="background-color: rgba(202,51,133,0.9); color: #FFFFFF">−11.4</td>
<td class="new_gt_row new_gt_right" headers="2022" style="background-color: rgba(122,182,72,0.9); color: #000000">8.1</td>
<td class="new_gt_row new_gt_right" headers="2023" style="background-color: rgba(225,243,200,0.9); color: #000000">3.0</td>
<td class="new_gt_row new_gt_right" headers="Total" style="background-color: rgba(252,230,241,0.9); color: #000000">−1.0</td>
</tr>
<tr class="even">
<td class="new_gt_row new_gt_left" headers="team">Tony</td>
<td class="new_gt_row new_gt_right" headers="2018" style="background-color: rgba(252,227,240,0.9); color: #000000">−4.1</td>
<td class="new_gt_row new_gt_right" headers="2019" style="background-color: rgba(220,116,169,0.9); color: #FFFFFF">−4.5</td>
<td class="new_gt_row new_gt_right" headers="2020" style="background-color: rgba(241,186,215,0.9); color: #000000">−4.5</td>
<td class="new_gt_row new_gt_right" headers="2021" style="background-color: rgba(238,246,225,0.9); color: #000000">2.8</td>
<td class="new_gt_row new_gt_right" headers="2022" style="background-color: rgba(251,233,242,0.9); color: #000000">−3.0</td>
<td class="new_gt_row new_gt_right" headers="2023" style="background-color: rgba(240,246,231,0.9); color: #000000">1.1</td>
<td class="new_gt_row new_gt_right" headers="Total" style="background-color: rgba(247,204,226,0.9); color: #000000">−1.8</td>
</tr>
<tr class="odd">
<td class="new_gt_row new_gt_left" headers="team">Manny</td>
<td class="new_gt_row new_gt_right" headers="2018" style="background-color: rgba(161,215,107,0.9); color: #000000">5.4</td>
<td class="new_gt_row new_gt_right" headers="2019" style="background-color: rgba(178,222,130,0.9); color: #000000">4.0</td>
<td class="new_gt_row new_gt_right" headers="2020" style="background-color: rgba(248,243,245,0.9); color: #000000">−0.5</td>
<td class="new_gt_row new_gt_right" headers="2021" style="background-color: rgba(197,27,125,0.9); color: #FFFFFF">−11.8</td>
<td class="new_gt_row new_gt_right" headers="2022" style="background-color: rgba(246,202,225,0.9); color: #000000">−6.6</td>
<td class="new_gt_row new_gt_right" headers="2023" style="background-color: rgba(252,229,241,0.9); color: #000000">−2.1</td>
<td class="new_gt_row new_gt_right" headers="Total" style="background-color: rgba(239,181,212,0.9); color: #000000">−2.3</td>
</tr>
<tr class="even">
<td class="new_gt_row new_gt_left" headers="team">Andrew E.</td>
<td class="new_gt_row new_gt_right" headers="2018" style="background-color: rgba(189,227,146,0.9); color: #000000">4.3</td>
<td class="new_gt_row new_gt_right" headers="2019" style="background-color: rgba(203,56,135,0.9); color: #FFFFFF">−5.3</td>
<td class="new_gt_row new_gt_right" headers="2020" style="background-color: rgba(244,247,241,0.9); color: #000000">0.7</td>
<td class="new_gt_row new_gt_right" headers="2021" style="background-color: rgba(253,223,238,0.9); color: #000000">−4.0</td>
<td class="new_gt_row new_gt_right" headers="2022" style="background-color: rgba(197,27,125,0.9); color: #FFFFFF">−14.5</td>
<td class="new_gt_row new_gt_right" headers="2023" style="background-color: rgba(241,187,216,0.9); color: #000000">−4.2</td>
<td class="new_gt_row new_gt_right" headers="Total" style="background-color: rgba(197,27,125,0.9); color: #FFFFFF">−4.1</td>
</tr>
</tbody><tfoot class="new_gt_footnotes">
<tr class="odd">
<td colspan="8" class="new_gt_footnote">Values represent league average "lost opportunity" minus team's "lost opportunity".</td>
</tr>
</tfoot>

</table>

</div>
<p>Notes:</p>
<ul>
<li>The weighted average lost opportunity points compared to the league average only varies by about ±4 points in the extremes. We’ll likely see that range decrease as more seasons are played, as there seems to be a lot of “noise” here.</li>
<li>Juan is the only team to perform better than the league average in 5 seasons. The rest of the teams had lost opportunity points greater than the league average in either 2, 3, or 4 seasons.</li>
</ul>
</section>
</section>
<section id="discussion" class="level2">
<h2 class="anchored" data-anchor-id="discussion">Discussion</h2>
<p>To overcome the variance that comes with fantasy football, some leagues play with a <a href="https://www.rotostreetjournal.com/2023/08/04/fantasy-football-league-settings-what-is-league-median-and-why-your-league-should-implement-it/">“median scoring” format</a>. In this structure, you earn a win or loss with your head-to-head matchup, as usual, but can earn another win every week if you score more than the median team score for the week. This has the effect of reducing “luck” while still allowing for some of the randomness with which most players have developed a love-hate relationship.</p>
<p>If we applied this scoring format to my league, here’s how the placements would have changed over the past 6 years.</p>
<p><img src="https://tonyelhabr.rbind.io/posts/fantasy-football-performance/median-scoring.png" class="img-fluid"></p>
<p>And here’s a tabular summary. (<code>Total placement Δ</code> represents the sum of placement changes. <code>changes</code> is either 1 or 0 for each season, depending on whether the placement for the team changed in a positive or negative manner.)</p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: left;">Team</th>
<th style="text-align: right;">Total placement Δ</th>
<th style="text-align: right;">Positive changes</th>
<th style="text-align: right;">Negative changes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Enrique</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">Juan</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Tony</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">Manny</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Andrew E.</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="even">
<td style="text-align: left;">Brandon</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">3</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Drake</td>
<td style="text-align: right;">-1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">Luis</td>
<td style="text-align: right;">-1</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">3</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Alan</td>
<td style="text-align: right;">-4</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">3</td>
</tr>
<tr class="even">
<td style="text-align: left;">Andrew L.</td>
<td style="text-align: right;">-8</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">4</td>
</tr>
</tbody>
</table>
<p>Some observations:</p>
<ul>
<li>Enrique would have benefited the most–Enrique would have moved up the rankings in 4 out of the 6 seasons (and not changed in the other 2 seasons), for a total sum of +5 placements.</li>
<li>On the other end of the spectrum, Andrew L. would have placed worse in 4 of the 6 seasons with the median scoring system, for a total ranking change of -8.</li>
</ul>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: right;">Season</th>
<th style="text-align: right;">Teams dropping out of Top 4</th>
<th style="text-align: right;">Teams rising out of Bottom 4</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">2018</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">2019</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2020</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">2021</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2022</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">2023</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
</tr>
</tbody>
</table>
<p>Given the high importance of not finishing in the bottom 4–to avoid being in the loser’s consolation playoffs and getting last place–it’s notable that 1 team would have moved out of the bottom 4 every season with the median scoring system, with the exception of 2018.</p>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>Looking at how the median scoring system would benefit me personally–I would never finish bottom 4 and be at risk for our last-place penalty–I think my personal takeaway is that I should push for a median scoring format in the future. There’s still going to be variance with outcomes–due to scheduling, under-performance compared to projection, and sub-optimal lineup choices–but the more deserving teams (like my own) are less likely to get a short end of the stick.</p>



</section>


<div class="quarto-listing quarto-listing-container-default" id="listing-listing">
<div class="list quarto-listing-default">

</div>
<div class="listing-no-matching d-none">
No matching items
</div>
</div><div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Just based on my own league’s numbers, it seems that ESPN improved their projections after the 2018 season, and are now fairly well calibrated, i.e.&nbsp;on average the error is close to 0.↩︎</p></li>
<li id="fn2"><p>For those looking to calculate this kind of table for themselves, <a href="https://theffhub.com/">“The Fantasy Football Hub”</a> has a nice calculator, plus some extra goodies, e.g.&nbsp;“What would my record have been if I had league member X’s schedule?”.↩︎</p></li>
<li id="fn3"><p>In most cases, I’d assume that a negative difference between actual and projected scores reflects misfortune (e.g.&nbsp;injury, unexpected lack of playing time), although one can argue that it reflects poor management by the user, i.e.&nbsp;“You should have known not to start that running back against the best rushing defense!”. However, projected points should theoretically capture matchup difficulty, so this seems like a weak argument in general.↩︎</p></li>
<li id="fn4"><p>I would generally expect this measure to be correlated with the rankings of teams by actual win % minus all-play win %, assuming the projected scores are reasonably well-calibrated.↩︎</p></li>
<li id="fn5"><p>These numbers are biased by the quality of the players on a team’s roster. If a team has a lot of injured players, then they’re less likely to start sub-optimal players. Further, if they have a lot of players that just don’t tend to get a lot of points (e.g.&nbsp;third string WRs), then they may appear to be starting players optimally more often, simply because they don’t have great replacement-level players.↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>r</category>
  <category>football (american)</category>
  <guid>https://tonyelhabr.rbind.io/posts/fantasy-football-performance/index.html</guid>
  <pubDate>Sun, 31 Dec 2023 06:00:00 GMT</pubDate>
  <media:content url="https://tonyelhabr.rbind.io/posts/fantasy-football-performance/median-scoring.png" medium="image" type="image/png" height="144" width="144"/>
</item>
<item>
  <title>Should we account for team quality in an xG model?</title>
  <dc:creator>Tony ElHabr</dc:creator>
  <link>https://tonyelhabr.rbind.io/posts/xg-team-quality/index.html</link>
  <description><![CDATA[ 



<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>“Should we account for team quality in an <a href="https://theanalyst.com/na/2021/07/what-are-expected-goals-xg/">xG model</a>?” From a purely philosophical point of view, my opinion is “no”–I think that xG models should be agnostic to player and team abilities, even if we were to find that accounting for shot-taker or team identity improves the performance of the model.</p>
<p>But I thought it might be fun to entertain the question from a quantitative perspective. If we add features for team strength to an xG model, can we meaningfully improve the model’s overall predictive performance and <a href="https://tonyelhabr.rbind.io/posts/probability-calibration/">calibration</a>?</p>
<section id="motivation" class="level3">
<h3 class="anchored" data-anchor-id="motivation">Motivation</h3>
<p>This write-up is inspired by <a href="https://twitter.com/RyanBrill_">Ryan Brill</a>’s recent <a href="https://youtu.be/uS4XxQ0LVfE?si=BnmzeePnk3R5uiY3&amp;t=361">presentation on fourth-down decision-making in the National Football League (NFL)</a>. He points out that <a href="https://www.nfeloapp.com/analysis/expected-points-added-epa-nfl/">expected points (EP)</a> models in the NFL have a <a href="https://en.wikipedia.org/wiki/Selection_bias">selection bias</a> problem–they tend to under-rate the probability of a positive outcome for “good” teams and over-rate such outcomes for “bad” teams.</p>
<p>Expected goals (xG) in soccer also suffer from this bias. <a href="https://github.com/larsmaurath">Lars Maurath</a> has <a href="https://www.thesignificantgame.com/portfolio/do-naive-xg-models-underestimate-expected-goals-for-top-teams/">a great deep-dive</a> looking into expected goals under-estimation for strong teams like <a href="https://fbref.com/en/squads/206d90db/Barcelona-Stats">Barcelona</a>.</p>
<p>This phenomenon is evident in the <a href="https://en.wikipedia.org/wiki/Premier_League">English Premier League (EPL)</a> as well. The <a href="https://fbref.com/en/comps/9/2022-2023/2022-2023-Premier-League-Stats">end-of-season table for the 2022/23 season</a> shows that xGD, i.e.&nbsp;goals (G) minus xG, is very positive for the top 6 teams and very negative for the bottom 6 teams.</p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: left;">Team</th>
<th style="text-align: right;">Points</th>
<th style="text-align: right;">G</th>
<th style="text-align: right;">xG</th>
<th style="text-align: right;">xGD</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Manchester City</td>
<td style="text-align: right;">89</td>
<td style="text-align: right;">33</td>
<td style="text-align: right;">78.6</td>
<td style="text-align: right;">46.5</td>
</tr>
<tr class="even">
<td style="text-align: left;">Arsenal</td>
<td style="text-align: right;">84</td>
<td style="text-align: right;">43</td>
<td style="text-align: right;">71.9</td>
<td style="text-align: right;">29.9</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Manchester Utd</td>
<td style="text-align: right;">75</td>
<td style="text-align: right;">43</td>
<td style="text-align: right;">67.7</td>
<td style="text-align: right;">17.3</td>
</tr>
<tr class="even">
<td style="text-align: left;">Newcastle Utd</td>
<td style="text-align: right;">71</td>
<td style="text-align: right;">33</td>
<td style="text-align: right;">72.0</td>
<td style="text-align: right;">32.4</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Liverpool</td>
<td style="text-align: right;">67</td>
<td style="text-align: right;">47</td>
<td style="text-align: right;">72.6</td>
<td style="text-align: right;">21.7</td>
</tr>
<tr class="even">
<td style="text-align: left;">Brighton</td>
<td style="text-align: right;">62</td>
<td style="text-align: right;">53</td>
<td style="text-align: right;">73.3</td>
<td style="text-align: right;">23.1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Aston Villa</td>
<td style="text-align: right;">61</td>
<td style="text-align: right;">46</td>
<td style="text-align: right;">50.2</td>
<td style="text-align: right;">-2.2</td>
</tr>
<tr class="even">
<td style="text-align: left;">Tottenham</td>
<td style="text-align: right;">60</td>
<td style="text-align: right;">63</td>
<td style="text-align: right;">57.1</td>
<td style="text-align: right;">7.4</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Brentford</td>
<td style="text-align: right;">59</td>
<td style="text-align: right;">46</td>
<td style="text-align: right;">56.8</td>
<td style="text-align: right;">6.8</td>
</tr>
<tr class="even">
<td style="text-align: left;">Fulham</td>
<td style="text-align: right;">52</td>
<td style="text-align: right;">53</td>
<td style="text-align: right;">46.2</td>
<td style="text-align: right;">-17.6</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Crystal Palace</td>
<td style="text-align: right;">45</td>
<td style="text-align: right;">49</td>
<td style="text-align: right;">39.3</td>
<td style="text-align: right;">-8.8</td>
</tr>
<tr class="even">
<td style="text-align: left;">Chelsea</td>
<td style="text-align: right;">44</td>
<td style="text-align: right;">47</td>
<td style="text-align: right;">49.5</td>
<td style="text-align: right;">-3.0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Wolves</td>
<td style="text-align: right;">41</td>
<td style="text-align: right;">58</td>
<td style="text-align: right;">36.8</td>
<td style="text-align: right;">-23.1</td>
</tr>
<tr class="even">
<td style="text-align: left;">West Ham</td>
<td style="text-align: right;">40</td>
<td style="text-align: right;">55</td>
<td style="text-align: right;">49.2</td>
<td style="text-align: right;">-3.9</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Bournemouth</td>
<td style="text-align: right;">39</td>
<td style="text-align: right;">71</td>
<td style="text-align: right;">38.6</td>
<td style="text-align: right;">-25.3</td>
</tr>
<tr class="even">
<td style="text-align: left;">Nott’ham Forest</td>
<td style="text-align: right;">38</td>
<td style="text-align: right;">68</td>
<td style="text-align: right;">39.3</td>
<td style="text-align: right;">-24.9</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Everton</td>
<td style="text-align: right;">36</td>
<td style="text-align: right;">57</td>
<td style="text-align: right;">45.2</td>
<td style="text-align: right;">-20.5</td>
</tr>
<tr class="even">
<td style="text-align: left;">Leicester City</td>
<td style="text-align: right;">34</td>
<td style="text-align: right;">68</td>
<td style="text-align: right;">50.6</td>
<td style="text-align: right;">-12.8</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Leeds United</td>
<td style="text-align: right;">31</td>
<td style="text-align: right;">78</td>
<td style="text-align: right;">47.4</td>
<td style="text-align: right;">-19.8</td>
</tr>
<tr class="even">
<td style="text-align: left;">Southampton</td>
<td style="text-align: right;">25</td>
<td style="text-align: right;">73</td>
<td style="text-align: right;">37.7</td>
<td style="text-align: right;">-23.3</td>
</tr>
</tbody>
</table>
<p>Lars does an “ex-post” analysis–evaluating the “residual” of expected goals, or xGD–to arrive at his conclusion that team quality does seem to explain large deviations between goals and expected goals for top teams.</p>
<blockquote class="blockquote">
<p>[W]hen conditioning on… team quality (Elo ranking) I do not find this bias in either naive or sophisticated models.</p>
</blockquote>
<p>I’m curious to see if we can arrive at a related conclusion in a more direct, “ex-ante” fashion. Can we reduce the underestimation of goals for strong teams by directly accounting for team quality in an xG model?</p>
</section>
</section>
<section id="analysis-and-results" class="level2">
<h2 class="anchored" data-anchor-id="analysis-and-results">Analysis and Results</h2>
<section id="data" class="level3">
<h3 class="anchored" data-anchor-id="data">Data</h3>
<p>I’ll be using event data that I’ve ingested with the <a href="https://github.com/ML-KULeuven/socceraction"><code>{socceraction}</code> package</a> (which I’ve made available <a href="https://github.com/tonyelhabr/socceraction-streamlined/releases">here</a>!) for the 2013/14 through 2022/23 EPL seasons. I’ll focus on just “open-play” shots, i.e.&nbsp;shots excluding penalties and those taken from set pieces.</p>
<p>I’ve scraped <a href="https://en.wikipedia.org/wiki/Elo_rating_system">Elo</a> ratings from <a href="http://clubelo.com/">ClubElo</a> for my measure of team quality. I’ve chosen Elo because it provides an intuitive, sport-agnostic measure of relative skill. Also, it is calculated independent of the events that take place in a game, so any correlation with measures of shot volume, quality, etc. is only coincidental.<sup>1</sup></p>
<div class="cell">
<details>
<summary>Package imports and other setup</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Data retrieval</span></span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(curl)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(arrow)</span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(qs) <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## local dev</span></span>
<span id="cb1-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(worldfootballR)</span>
<span id="cb1-6"></span>
<span id="cb1-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Data manipulation</span></span>
<span id="cb1-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)</span>
<span id="cb1-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyr)</span>
<span id="cb1-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(purrr)</span>
<span id="cb1-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(lubridate)</span>
<span id="cb1-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(forcats)</span>
<span id="cb1-13"></span>
<span id="cb1-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Modeling</span></span>
<span id="cb1-15"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(rsample)</span>
<span id="cb1-16"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(recipes)</span>
<span id="cb1-17"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(parsnip)</span>
<span id="cb1-18"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(workflows)</span>
<span id="cb1-19"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(hardhat)</span>
<span id="cb1-20"></span>
<span id="cb1-21"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Model tuning</span></span>
<span id="cb1-22"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tune)</span>
<span id="cb1-23"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dials)</span>
<span id="cb1-24"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(workflowsets)</span>
<span id="cb1-25"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(finetune)</span>
<span id="cb1-26"></span>
<span id="cb1-27"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Model diagnostics</span></span>
<span id="cb1-28"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(rlang)</span>
<span id="cb1-29"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(yardstick)</span>
<span id="cb1-30"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(SHAPforxgboost)</span>
<span id="cb1-31"></span>
<span id="cb1-32"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Plotting</span></span>
<span id="cb1-33"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb1-34"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(sysfonts)</span>
<span id="cb1-35"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(showtext)</span>
<span id="cb1-36"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggtext)</span>
<span id="cb1-37"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(htmltools)</span>
<span id="cb1-38"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(scales)</span>
<span id="cb1-39"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(grid)</span>
<span id="cb1-40"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(glue)</span>
<span id="cb1-41"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(knitr)</span>
<span id="cb1-42"></span>
<span id="cb1-43">PROJ_DIR <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'posts/xg-team-quality'</span></span>
<span id="cb1-44"></span>
<span id="cb1-45">TAG_LABEL <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> htmltools<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tagList</span>(</span>
<span id="cb1-46">  htmltools<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>tags<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">span</span>(htmltools<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">HTML</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">enc2utf8</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&amp;#xf099;"</span>)), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">style =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'font-family:fb'</span>),</span>
<span id="cb1-47">  htmltools<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>tags<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">span</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"@TonyElHabr"</span>),</span>
<span id="cb1-48">)</span>
<span id="cb1-49">SUBTITLE_LABEL <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'English Premier League, 2012/13 - 2022/23'</span></span>
<span id="cb1-50">PLOT_RESOLUTION <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span></span>
<span id="cb1-51">WHITISH_FOREGROUND_COLOR <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'white'</span></span>
<span id="cb1-52">COMPLEMENTARY_FOREGROUND_COLOR <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'#cbcbcb'</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># '#f1f1f1'</span></span>
<span id="cb1-53">BLACKISH_BACKGROUND_COLOR <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'#1c1c1c'</span></span>
<span id="cb1-54">COMPLEMENTARY_BACKGROUND_COLOR <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'#4d4d4d'</span></span>
<span id="cb1-55">FONT <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Titillium Web'</span></span>
<span id="cb1-56">sysfonts<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">font_add_google</span>(FONT, FONT)</span>
<span id="cb1-57"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## https://github.com/tashapiro/tanya-data-viz/blob/main/chatgpt-lensa/chatgpt-lensa.R for twitter logo</span></span>
<span id="cb1-58">sysfonts<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">font_add</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fb'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Font Awesome 6 Brands-Regular-400.otf'</span>)</span>
<span id="cb1-59">showtext<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">showtext_auto</span>()</span>
<span id="cb1-60">showtext<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">showtext_opts</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dpi =</span> PLOT_RESOLUTION)</span>
<span id="cb1-61"></span>
<span id="cb1-62">ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_set</span>(ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>())</span>
<span id="cb1-63">ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_update</span>(</span>
<span id="cb1-64">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">text =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> FONT),</span>
<span id="cb1-65">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> WHITISH_FOREGROUND_COLOR),</span>
<span id="cb1-66">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.title =</span> ggtext<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_markdown</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bold'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> WHITISH_FOREGROUND_COLOR),</span>
<span id="cb1-67">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.title.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'plot'</span>,</span>
<span id="cb1-68">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.subtitle =</span> ggtext<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_markdown</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> COMPLEMENTARY_FOREGROUND_COLOR),</span>
<span id="cb1-69">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> WHITISH_FOREGROUND_COLOR, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>),</span>
<span id="cb1-70">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># axis.title = ggplot2::element_text(size = 14, color = WHITISH_FOREGROUND_COLOR, face = 'bold', hjust = 0.99),</span></span>
<span id="cb1-71">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.title.x =</span> ggtext<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_markdown</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> WHITISH_FOREGROUND_COLOR, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bold'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.99</span>),</span>
<span id="cb1-72">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.title.y =</span> ggtext<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_markdown</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> WHITISH_FOREGROUND_COLOR, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bold'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.99</span>),</span>
<span id="cb1-73">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.line =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb1-74">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">strip.text =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> WHITISH_FOREGROUND_COLOR, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bold'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>),</span>
<span id="cb1-75">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'top'</span>,</span>
<span id="cb1-76">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.text =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> WHITISH_FOREGROUND_COLOR, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'plain'</span>),</span>
<span id="cb1-77">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.title =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> WHITISH_FOREGROUND_COLOR, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bold'</span>),</span>
<span id="cb1-78">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid.major =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_line</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> COMPLEMENTARY_BACKGROUND_COLOR),</span>
<span id="cb1-79">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid.minor =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_line</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> COMPLEMENTARY_BACKGROUND_COLOR),</span>
<span id="cb1-80">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid.minor.x =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb1-81">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid.minor.y =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb1-82">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.margin =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">margin</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>),</span>
<span id="cb1-83">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.background =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_rect</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> BLACKISH_BACKGROUND_COLOR, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> BLACKISH_BACKGROUND_COLOR),</span>
<span id="cb1-84">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.caption =</span> ggtext<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_markdown</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> WHITISH_FOREGROUND_COLOR, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'plain'</span>),</span>
<span id="cb1-85">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.caption.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'plot'</span>,</span>
<span id="cb1-86">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.tag =</span> ggtext<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_markdown</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> WHITISH_FOREGROUND_COLOR, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb1-87">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.tag.position =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.99</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>),</span>
<span id="cb1-88">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.spacing.x =</span> grid<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'lines'</span>),</span>
<span id="cb1-89">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.background =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_rect</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> BLACKISH_BACKGROUND_COLOR, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> BLACKISH_BACKGROUND_COLOR)</span>
<span id="cb1-90">)</span></code></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Retrieve and wrangle data</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">read_parquet_from_url <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(url) {</span>
<span id="cb2-2">  load <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> curl<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">curl_fetch_memory</span>(url)</span>
<span id="cb2-3">  arrow<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_parquet</span>(load<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>content)</span>
<span id="cb2-4">}</span>
<span id="cb2-5"></span>
<span id="cb2-6">REPO <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tonyelhabr/socceraction-streamlined'</span></span>
<span id="cb2-7">read_socceraction_parquet_release <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(name, tag) {</span>
<span id="cb2-8">  url <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sprintf</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'https://github.com/%s/releases/download/%s/%s.parquet'</span>, REPO, tag, name)</span>
<span id="cb2-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_parquet_from_url</span>(url)</span>
<span id="cb2-10">}</span>
<span id="cb2-11"></span>
<span id="cb2-12">read_socceraction_parquet_releases <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(name, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tag =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'data-processed'</span>) {</span>
<span id="cb2-13">  purrr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map_dfr</span>(</span>
<span id="cb2-14">    <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2013</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2022</span>,</span>
<span id="cb2-15">    \(season_start_year) {</span>
<span id="cb2-16">      basename <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sprintf</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'8-%s-%s'</span>, season_start_year, name)</span>
<span id="cb2-17">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">message</span>(basename)</span>
<span id="cb2-18">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_socceraction_parquet_release</span>(basename, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tag =</span> tag)</span>
<span id="cb2-19">    }</span>
<span id="cb2-20">  )</span>
<span id="cb2-21">}</span>
<span id="cb2-22"></span>
<span id="cb2-23">read_socceraction_parquet <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(name, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">branch =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'main'</span>) {</span>
<span id="cb2-24">  url <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sprintf</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'https://github.com/%s/raw/%s/%s.parquet'</span>, REPO, branch, name)</span>
<span id="cb2-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_parquet_from_url</span>(url)</span>
<span id="cb2-26">}</span>
<span id="cb2-27"></span>
<span id="cb2-28">x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_socceraction_parquet_releases</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x'</span>)</span>
<span id="cb2-29">y <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_socceraction_parquet_releases</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'y'</span>)</span>
<span id="cb2-30">actions <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_socceraction_parquet_releases</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'actions'</span>)</span>
<span id="cb2-31">games <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_socceraction_parquet_releases</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'games'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb2-32">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb2-33">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">date =</span> lubridate<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">date</span>(game_date)</span>
<span id="cb2-34">  )</span>
<span id="cb2-35">team_elo <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_socceraction_parquet</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'data/final/8/2013-2022/clubelo-ratings'</span>)</span>
<span id="cb2-36"></span>
<span id="cb2-37">open_play_shots <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> games <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb2-38">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">transmute</span>(</span>
<span id="cb2-39">    season_id,</span>
<span id="cb2-40">    game_id,</span>
<span id="cb2-41">    date,</span>
<span id="cb2-42">    home_team_id,</span>
<span id="cb2-43">    away_team_id</span>
<span id="cb2-44">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb2-45">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inner_join</span>(</span>
<span id="cb2-46">    x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb2-47">      dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(type_shot_a0 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb2-48">      dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(</span>
<span id="cb2-49">        game_id,</span>
<span id="cb2-50">        action_id,</span>
<span id="cb2-51">        </span>
<span id="cb2-52">        <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## features</span></span>
<span id="cb2-53">        start_x_a0,</span>
<span id="cb2-54">        start_y_a0,</span>
<span id="cb2-55">        start_dist_to_goal_a0,</span>
<span id="cb2-56">        start_angle_to_goal_a0,</span>
<span id="cb2-57">        type_dribble_a1,</span>
<span id="cb2-58">        type_pass_a1,</span>
<span id="cb2-59">        type_cross_a1,</span>
<span id="cb2-60">        type_corner_crossed_a1,</span>
<span id="cb2-61">        type_shot_a1,</span>
<span id="cb2-62">        type_freekick_crossed_a1,</span>
<span id="cb2-63">        bodypart_foot_a0,</span>
<span id="cb2-64">        bodypart_head_a0,</span>
<span id="cb2-65">        bodypart_other_a0</span>
<span id="cb2-66">      ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb2-67">      dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb2-68">        dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(game_id, action_id), as.integer)</span>
<span id="cb2-69">      ),</span>
<span id="cb2-70">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(game_id),</span>
<span id="cb2-71">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">relationship =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'many-to-many'</span></span>
<span id="cb2-72">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb2-73">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inner_join</span>(</span>
<span id="cb2-74">    y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb2-75">      dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">transmute</span>(</span>
<span id="cb2-76">        game_id, </span>
<span id="cb2-77">        action_id,</span>
<span id="cb2-78">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scores =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(scores, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'yes'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'no'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'yes'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'no'</span>))</span>
<span id="cb2-79">      ),</span>
<span id="cb2-80">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(game_id, action_id)</span>
<span id="cb2-81">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb2-82">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inner_join</span>(</span>
<span id="cb2-83">    actions <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb2-84">      dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(</span>
<span id="cb2-85">        game_id,</span>
<span id="cb2-86">        action_id,</span>
<span id="cb2-87">        team_id,</span>
<span id="cb2-88">        player_id</span>
<span id="cb2-89">      ),</span>
<span id="cb2-90">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(game_id, action_id)</span>
<span id="cb2-91">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb2-92">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(</span>
<span id="cb2-93">    team_elo <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(date, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">home_team_id =</span> team_id, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">home_elo =</span> elo),</span>
<span id="cb2-94">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(date, home_team_id)</span>
<span id="cb2-95">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb2-96">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(</span>
<span id="cb2-97">    team_elo <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(date, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">away_team_id =</span> team_id, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">away_elo =</span> elo),</span>
<span id="cb2-98">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(date, away_team_id)</span>
<span id="cb2-99">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb2-100">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">transmute</span>(</span>
<span id="cb2-101">    date,</span>
<span id="cb2-102">    season_id,</span>
<span id="cb2-103">    game_id,</span>
<span id="cb2-104">    team_id,</span>
<span id="cb2-105">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">opponent_team_id =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(team_id <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> home_team_id, away_team_id, home_team_id),</span>
<span id="cb2-106">    action_id,</span>
<span id="cb2-107">    </span>
<span id="cb2-108">    scores,</span>
<span id="cb2-109">    </span>
<span id="cb2-110">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">elo =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(team_id <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> home_team_id, home_elo, away_elo),</span>
<span id="cb2-111">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">opponent_elo =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(team_id <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> home_team_id, away_elo, home_elo),</span>
<span id="cb2-112">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">elo_diff =</span> elo <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> opponent_elo,</span>
<span id="cb2-113">    </span>
<span id="cb2-114">    start_dist_to_goal_a0,</span>
<span id="cb2-115">    start_angle_to_goal_a0,</span>
<span id="cb2-116">    type_dribble_a1,</span>
<span id="cb2-117">    type_pass_a1,</span>
<span id="cb2-118">    type_cross_a1,</span>
<span id="cb2-119">    type_corner_crossed_a1,</span>
<span id="cb2-120">    type_shot_a1,</span>
<span id="cb2-121">    type_freekick_crossed_a1,</span>
<span id="cb2-122">    bodypart_foot_a0,</span>
<span id="cb2-123">    bodypart_head_a0,</span>
<span id="cb2-124">    bodypart_other_a0</span>
<span id="cb2-125">  )</span></code></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Split the data for modeling</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">split <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> rsample<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_splits</span>(</span>
<span id="cb3-2">  open_play_shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(season_id <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(2013L<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>2019L)),</span>
<span id="cb3-3">  open_play_shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(season_id <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(2020L<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>2022L))</span>
<span id="cb3-4">)</span>
<span id="cb3-5"></span>
<span id="cb3-6">train <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> rsample<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">training</span>(split)</span>
<span id="cb3-7">test <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> rsample<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">testing</span>(split)</span></code></pre></div>
</details>
</div>
<p>It’s worth spotlighting Elo a bit more since it’s the novel feature here. Below is a look at the distribution of pre-match Elo over the course of the entire data set.</p>
<p><img src="https://tonyelhabr.rbind.io/posts/xg-team-quality/elo-hist.png" class="img-fluid"></p>
<p>To make Elo values feel a bit more tangible, note that:</p>
<ul>
<li><a href="https://fbref.com/en/squads/206d90db/Barcelona-Stats">Man City</a>–arguably the best team in the EPL for the past decade–has sustained an Elo greater than 1850 for the majority of the past decade.</li>
<li>Bottom-table teams often in the <a href="https://en.wikipedia.org/wiki/Promotion_and_relegation">relegation</a> battle tend to have Elos less than 1650.</li>
</ul>
<p>The pre-match difference team Elos follows a normal-ish distribution, with most values falling within the ±300 range.</p>
<p><img src="https://tonyelhabr.rbind.io/posts/xg-team-quality/elo-diff-hist.png" class="img-fluid"></p>
</section>
<section id="model-training" class="level3">
<h3 class="anchored" data-anchor-id="model-training">Model Training</h3>
<p>The feature set for our “base” xG model consists of the following:</p>
<ul>
<li>location of the shot (distance and angle of the shot to the center of the goal mouth)<sup>2</sup>.</li>
<li>type of action leading to the shot.</li>
<li>body part with which the shot was taken.</li>
</ul>
<p>These features are essentially what <a href="https://fbref.com/en/expected-goals-model-explained/">all xG models</a> have in common, although the exact implementation differs. Data providers such as <a href="https://theanalyst.com/na/2023/08/what-is-expected-goals-xg/">Opta also account for information</a> that is not captured in traditional event data, such as the position of the goalkeeper.</p>
<p>For the team-quality-adjusted (or “Elo-augmented”) model, I’ll add two additional features:</p>
<ul>
<li>the Elo of the team of the shot-taker.</li>
<li>the difference in the Elo of the shot-taking team and the opposing team.</li>
</ul>
<p>The former is meant to capture the opponent-agnostic quality of a team, while the latter captures the quality of the team relative to their opponent.</p>
<div class="cell">
<details>
<summary>Setting up the models</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">rec_elo <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> recipes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">recipe</span>(</span>
<span id="cb4-2">  scores <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> </span>
<span id="cb4-3">    elo <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-4">    elo_diff <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-5">    start_dist_to_goal_a0 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-6">    start_angle_to_goal_a0 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-7">    type_dribble_a1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-8">    type_pass_a1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-9">    type_cross_a1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-10">    type_corner_crossed_a1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-11">    type_shot_a1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-12">    type_freekick_crossed_a1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-13">    bodypart_foot_a0 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-14">    bodypart_head_a0 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-15">    bodypart_other_a0,</span>
<span id="cb4-16">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> train</span>
<span id="cb4-17">)</span>
<span id="cb4-18"></span>
<span id="cb4-19">rec_base <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> rec_elo <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb4-20">  recipes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">step_rm</span>(elo, elo_diff)</span></code></pre></div>
</details>
</div>
<p>I’ll be using <a href="https://xgboost.readthedocs.io/en/stable/">xgboost</a> for my xG models.<sup>3</sup> I’ll choose <a href="https://en.wikipedia.org/wiki/Hyperparameter_(machine_learning)">hyperparameters</a> using <a href="https://finetune.tidymodels.org/index.html">an efficient grid search</a>, evaluating models with the <a href="https://en.wikipedia.org/wiki/Brier_score#Brier_Skill_Score_(BSS)">Brier skill score (BSS)</a>. For the reference Brier score for BSS, I’ll use a dummy model that predicts 12% conversion for all shots.<sup>4</sup></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Brier skill score (BSS)
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>If this isn’t the first blog post you’ve read of mine, you probably know that <a href="https://tonyelhabr.rbind.io/posts/opta-xg-model-calibration">I love to use BSS</a> for classification tasks, especially for xG models.</p>
<p>But why BSS? Simply put, <a href="https://en.wikipedia.org/wiki/Brier_score">Brier scores</a> are known as <a href="https://machinelearningmastery.com/tour-of-evaluation-metrics-for-imbalanced-classification/">the best evaluation metric</a> to use for classification tasks where you’re purely interested in probabilities. And BSS goes one step beyond Brier scores, forcing one to contextualize the model evaluation with a reasonable baseline. In the context of xG, BSS helps us directly see whether our fitted model is better than a naive prediction, such as guessing that all shots convert at the observed shot conversion rate.</p>
<p>Keep in mind that a higher BSS is ideal. A perfect model would have a BSS of 1; a model that is no better than a reference model would have a BSS of 0.</p>
</div>
</div>
</div>
<div class="cell">
<details>
<summary>Functions for Brier skill score</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## See also: probability-calibration</span></span>
<span id="cb5-2">brier_skill_score <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(data, ...) {</span>
<span id="cb5-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">UseMethod</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'brier_skill_score'</span>)</span>
<span id="cb5-4">}</span>
<span id="cb5-5"></span>
<span id="cb5-6">brier_skill_score <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> yardstick<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">new_prob_metric</span>(</span>
<span id="cb5-7">  brier_skill_score, </span>
<span id="cb5-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">direction =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'maximize'</span></span>
<span id="cb5-9">)</span>
<span id="cb5-10"></span>
<span id="cb5-11">bss <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(</span>
<span id="cb5-12">    truth, </span>
<span id="cb5-13">    estimate, </span>
<span id="cb5-14">    ref_estimate, </span>
<span id="cb5-15">    event_level,</span>
<span id="cb5-16">    case_weights,</span>
<span id="cb5-17">    ...</span>
<span id="cb5-18">) {</span>
<span id="cb5-19">  </span>
<span id="cb5-20">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(estimate) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) {</span>
<span id="cb5-21">    estimate <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(estimate, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(truth))</span>
<span id="cb5-22">  }</span>
<span id="cb5-23">  </span>
<span id="cb5-24">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(ref_estimate) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) {</span>
<span id="cb5-25">    ref_estimate <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(ref_estimate, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(truth))</span>
<span id="cb5-26">  }</span>
<span id="cb5-27">  </span>
<span id="cb5-28">  estimate_brier_score <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brier_class_vec</span>(</span>
<span id="cb5-29">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">truth =</span> truth,</span>
<span id="cb5-30">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">estimate =</span> estimate,</span>
<span id="cb5-31">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">event_level =</span> event_level,</span>
<span id="cb5-32">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">case_weights =</span> case_weights,</span>
<span id="cb5-33">    ...</span>
<span id="cb5-34">  )</span>
<span id="cb5-35">  </span>
<span id="cb5-36">  ref_brier_score <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brier_class_vec</span>(</span>
<span id="cb5-37">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">truth =</span> truth,</span>
<span id="cb5-38">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">estimate =</span> ref_estimate,</span>
<span id="cb5-39">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">event_level =</span> event_level,</span>
<span id="cb5-40">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">case_weights =</span> case_weights,</span>
<span id="cb5-41">    ...</span>
<span id="cb5-42">  )</span>
<span id="cb5-43">  </span>
<span id="cb5-44">  <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> (estimate_brier_score <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> ref_brier_score)</span>
<span id="cb5-45">}</span>
<span id="cb5-46"></span>
<span id="cb5-47">brier_skill_score_estimator_impl <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(</span>
<span id="cb5-48">    truth, </span>
<span id="cb5-49">    estimate, </span>
<span id="cb5-50">    ref_estimate, </span>
<span id="cb5-51">    event_level,</span>
<span id="cb5-52">    case_weights</span>
<span id="cb5-53">) {</span>
<span id="cb5-54">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bss</span>(</span>
<span id="cb5-55">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">truth =</span> truth,</span>
<span id="cb5-56">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">estimate =</span> estimate,</span>
<span id="cb5-57">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ref_estimate =</span> ref_estimate,</span>
<span id="cb5-58">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">event_level =</span> event_level,</span>
<span id="cb5-59">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">case_weights =</span> case_weights</span>
<span id="cb5-60">  )</span>
<span id="cb5-61">}</span>
<span id="cb5-62"></span>
<span id="cb5-63">brier_skill_score_vec <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(</span>
<span id="cb5-64">    truth, </span>
<span id="cb5-65">    estimate, </span>
<span id="cb5-66">    ref_estimate, </span>
<span id="cb5-67">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na_rm =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, </span>
<span id="cb5-68">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">event_level =</span> yardstick<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">yardstick_event_level</span>(),</span>
<span id="cb5-69">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">case_weights =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, </span>
<span id="cb5-70">    ...</span>
<span id="cb5-71">) {</span>
<span id="cb5-72">  </span>
<span id="cb5-73">  yardstick<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abort_if_class_pred</span>(truth)</span>
<span id="cb5-74">  </span>
<span id="cb5-75">  estimator <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> yardstick<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">finalize_estimator</span>(</span>
<span id="cb5-76">    truth, </span>
<span id="cb5-77">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metric_class =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'brier_skill_score'</span></span>
<span id="cb5-78">  )</span>
<span id="cb5-79">  </span>
<span id="cb5-80">  yardstick<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">check_prob_metric</span>(truth, estimate, case_weights, estimator)</span>
<span id="cb5-81">  </span>
<span id="cb5-82">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (na_rm) {</span>
<span id="cb5-83">    result <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> yardstick<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">yardstick_remove_missing</span>(truth, estimate, case_weights)</span>
<span id="cb5-84">    </span>
<span id="cb5-85">    truth <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> result<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>truth</span>
<span id="cb5-86">    estimate <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> result<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>estimate</span>
<span id="cb5-87">    case_weights <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> result<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>case_weights</span>
<span id="cb5-88">  } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (yardstick<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">yardstick_any_missing</span>(truth, estimate, case_weights)) {</span>
<span id="cb5-89">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA_real_</span>)</span>
<span id="cb5-90">  }</span>
<span id="cb5-91">  </span>
<span id="cb5-92">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brier_skill_score_estimator_impl</span>(</span>
<span id="cb5-93">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">truth =</span> truth,</span>
<span id="cb5-94">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">estimate =</span> estimate,</span>
<span id="cb5-95">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ref_estimate =</span> ref_estimate,</span>
<span id="cb5-96">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">event_level =</span> event_level,</span>
<span id="cb5-97">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">case_weights =</span> case_weights</span>
<span id="cb5-98">  )</span>
<span id="cb5-99">}</span>
<span id="cb5-100"></span>
<span id="cb5-101">brier_skill_score.data.frame <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(</span>
<span id="cb5-102">    data, </span>
<span id="cb5-103">    truth, </span>
<span id="cb5-104">    ...,</span>
<span id="cb5-105">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na_rm =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span id="cb5-106">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">event_level =</span> yardstick<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">yardstick_event_level</span>(),</span>
<span id="cb5-107">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">case_weights =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb5-108">    </span>
<span id="cb5-109">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ref_estimate =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>,</span>
<span id="cb5-110">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'brier_skill_score'</span></span>
<span id="cb5-111">) {</span>
<span id="cb5-112">  yardstick<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prob_metric_summarizer</span>(</span>
<span id="cb5-113">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name =</span> name,</span>
<span id="cb5-114">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fn =</span> brier_skill_score_vec,</span>
<span id="cb5-115">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> data,</span>
<span id="cb5-116">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">truth =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!!</span>rlang<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">enquo</span>(truth),</span>
<span id="cb5-117">    ...,</span>
<span id="cb5-118">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na_rm =</span> na_rm,</span>
<span id="cb5-119">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">event_level =</span> event_level,</span>
<span id="cb5-120">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">case_weights =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!!</span>rlang<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">enquo</span>(case_weights),</span>
<span id="cb5-121">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fn_options =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb5-122">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ref_estimate =</span> ref_estimate</span>
<span id="cb5-123">    )</span>
<span id="cb5-124">  )</span>
<span id="cb5-125">}</span>
<span id="cb5-126"></span>
<span id="cb5-127">xg_brier_skill_score <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(data, ...) {</span>
<span id="cb5-128">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">UseMethod</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'xg_brier_skill_score'</span>)</span>
<span id="cb5-129">}</span>
<span id="cb5-130"></span>
<span id="cb5-131"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># REF_ESTIMATE &lt;- open_play_shots |&gt;</span></span>
<span id="cb5-132"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   dplyr::summarize(goal_rate = sum(scores == 'yes') / dplyr::n()) |&gt;</span></span>
<span id="cb5-133"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   dplyr::pull(goal_rate)</span></span>
<span id="cb5-134">REF_ESTIMATE <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.12</span></span>
<span id="cb5-135"></span>
<span id="cb5-136">xg_brier_skill_score.data.frame <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(...) {</span>
<span id="cb5-137">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brier_skill_score</span>(</span>
<span id="cb5-138">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ref_estimate =</span> REF_ESTIMATE,</span>
<span id="cb5-139">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'xg_brier_skill_score'</span>,</span>
<span id="cb5-140">    ...</span>
<span id="cb5-141">  )</span>
<span id="cb5-142">}</span>
<span id="cb5-143"></span>
<span id="cb5-144">xg_brier_skill_score <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> yardstick<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">new_prob_metric</span>(</span>
<span id="cb5-145">  xg_brier_skill_score,</span>
<span id="cb5-146">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">direction =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'maximize'</span></span>
<span id="cb5-147">)</span></code></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Tuning the xG models</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Useful reference: https://jlaw.netlify.app/2022/01/24/predicting-when-kickers-get-iced-with-tidymodels/</span></span>
<span id="cb6-2">TREES <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span></span>
<span id="cb6-3">LEARN_RATE <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span></span>
<span id="cb6-4">spec <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> parsnip<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">boost_tree</span>(</span>
<span id="cb6-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">trees =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!!</span>TREES,</span>
<span id="cb6-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">learn_rate =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!!</span>LEARN_RATE,</span>
<span id="cb6-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tree_depth =</span> tune<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tune</span>(),</span>
<span id="cb6-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">min_n =</span> tune<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tune</span>(), </span>
<span id="cb6-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">loss_reduction =</span> tune<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tune</span>(),</span>
<span id="cb6-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sample_size =</span> tune<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tune</span>(), </span>
<span id="cb6-11">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mtry =</span> tune<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tune</span>(),</span>
<span id="cb6-12">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">stop_iter =</span> tune<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tune</span>()</span>
<span id="cb6-13">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb6-14">  parsnip<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_engine</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'xgboost'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-15">  parsnip<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_mode</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'classification'</span>)</span>
<span id="cb6-16"></span>
<span id="cb6-17">grid <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> dials<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grid_latin_hypercube</span>(</span>
<span id="cb6-18">  dials<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tree_depth</span>(),</span>
<span id="cb6-19">  dials<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min_n</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">range =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(5L, 40L)),</span>
<span id="cb6-20">  dials<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">loss_reduction</span>(),</span>
<span id="cb6-21">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sample_size =</span> dials<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample_prop</span>(),</span>
<span id="cb6-22">  dials<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">finalize</span>(dials<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mtry</span>(), train),</span>
<span id="cb6-23">  dials<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stop_iter</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">range =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(10L, 50L)),</span>
<span id="cb6-24">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span></span>
<span id="cb6-25">)</span>
<span id="cb6-26"></span>
<span id="cb6-27">wf_sets <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> workflowsets<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">workflow_set</span>(</span>
<span id="cb6-28">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">preproc =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb6-29">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">base =</span> rec_base, </span>
<span id="cb6-30">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">elo =</span> rec_elo</span>
<span id="cb6-31">  ),</span>
<span id="cb6-32">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">models =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb6-33">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">model =</span> spec</span>
<span id="cb6-34">  ),</span>
<span id="cb6-35">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cross =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span></span>
<span id="cb6-36">)</span>
<span id="cb6-37"></span>
<span id="cb6-38">control <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> finetune<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">control_race</span>(</span>
<span id="cb6-39">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">save_pred =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span id="cb6-40">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">parallel_over =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'everything'</span>,</span>
<span id="cb6-41">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">save_workflow =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span id="cb6-42">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">verbose =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span></span>
<span id="cb6-43">)</span>
<span id="cb6-44"></span>
<span id="cb6-45"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb6-46">train_folds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> rsample<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vfold_cv</span>(train, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">strata =</span> scores, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">v =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb6-47"></span>
<span id="cb6-48">tuned_results <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> workflowsets<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">workflow_map</span>(</span>
<span id="cb6-49">  wf_sets,</span>
<span id="cb6-50">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fn =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tune_race_anova'</span>,</span>
<span id="cb6-51">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">grid =</span> grid,</span>
<span id="cb6-52">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">control =</span> control,</span>
<span id="cb6-53">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metrics =</span> yardstick<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">metric_set</span>(xg_brier_skill_score),</span>
<span id="cb6-54">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">resamples =</span> train_folds,</span>
<span id="cb6-55">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seed =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span></span>
<span id="cb6-56">)</span></code></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Choosing best hyper-parameters</summary>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">MODEL_TYPES <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(</span>
<span id="cb7-2">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'base_model'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Base'</span>,</span>
<span id="cb7-3">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'elo_model'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Elo-augmented'</span></span>
<span id="cb7-4">)</span>
<span id="cb7-5">select_best_model <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(tuned_results, model_type) {</span>
<span id="cb7-6">  tuned_results <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb7-7">    workflowsets<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">extract_workflow_set_result</span>(model_type) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb7-8">    tune<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select_best</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metric =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'xg_brier_skill_score'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb7-9">    dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">transmute</span>(</span>
<span id="cb7-10">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">model_type =</span> MODEL_TYPES[model_type],</span>
<span id="cb7-11">      mtry,</span>
<span id="cb7-12">      min_n,</span>
<span id="cb7-13">      tree_depth, </span>
<span id="cb7-14">      loss_reduction,</span>
<span id="cb7-15">      sample_size,</span>
<span id="cb7-16">      stop_iter</span>
<span id="cb7-17">    )</span>
<span id="cb7-18">}</span>
<span id="cb7-19"></span>
<span id="cb7-20">best_base_set <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select_best_model</span>(tuned_results, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'base_model'</span>)</span>
<span id="cb7-21">best_elo_set <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select_best_model</span>(tuned_results, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'elo_model'</span>)</span>
<span id="cb7-22"></span>
<span id="cb7-23">dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>(</span>
<span id="cb7-24">  best_base_set,</span>
<span id="cb7-25">  best_elo_set</span>
<span id="cb7-26">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb7-27">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">transmute</span>(</span>
<span id="cb7-28">    model_type,</span>
<span id="cb7-29">    mtry,</span>
<span id="cb7-30">    min_n,</span>
<span id="cb7-31">    tree_depth, </span>
<span id="cb7-32">    loss_reduction,</span>
<span id="cb7-33">    sample_size,</span>
<span id="cb7-34">    stop_iter</span>
<span id="cb7-35">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb7-36">  knitr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kable</span>()</span></code></pre></div>
</details>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Model hyperparameters
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>For reproducibility, the chosen hyperparameters are as follows.<sup>5</sup> By coincidence, the same hyper-parameters are chosen. (Only 50 combinations were evaluated.)</p>
<table class="table">
<colgroup>
<col style="width: 18%">
<col style="width: 7%">
<col style="width: 8%">
<col style="width: 15%">
<col style="width: 20%">
<col style="width: 16%">
<col style="width: 13%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">model_type</th>
<th style="text-align: right;">mtry</th>
<th style="text-align: right;">min_n</th>
<th style="text-align: right;">tree_depth</th>
<th style="text-align: right;">loss_reduction</th>
<th style="text-align: right;">sample_size</th>
<th style="text-align: right;">stop_iter</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Base</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">17</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.4641502</td>
<td style="text-align: right;">50</td>
</tr>
<tr class="even">
<td style="text-align: left;">Elo-augmented</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">17</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.4641502</td>
<td style="text-align: right;">50</td>
</tr>
</tbody>
</table>
<p>The number of <code>trees</code> and <code>learning_rate</code> were pre-defined to be 500 and 0.01 respectively.</p>
</div>
</div>
</div>
<div class="cell">
<details>
<summary>Fit models on the entire training set after choosing the hyperparameters</summary>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1">finalize_tuned_results <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(tuned_results, model_type) {</span>
<span id="cb8-2">  best_set <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select_best_model</span>(tuned_results, model_type)</span>
<span id="cb8-3">  tuned_results <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb8-4">    hardhat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">extract_workflow</span>(model_type) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb8-5">    tune<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">finalize_workflow</span>(best_base_set) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb8-6">    tune<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">last_fit</span>(</span>
<span id="cb8-7">      split,</span>
<span id="cb8-8">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metrics =</span> yardstick<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">metric_set</span>(xg_brier_skill_score)</span>
<span id="cb8-9">    )</span>
<span id="cb8-10">}</span>
<span id="cb8-11">last_base_fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">finalize_tuned_results</span>(tuned_results, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'base_model'</span>)</span>
<span id="cb8-12">last_elo_fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">finalize_tuned_results</span>(tuned_results, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'elo_model'</span>)</span></code></pre></div>
</details>
</div>
</section>
<section id="feature-importance" class="level3">
<h3 class="anchored" data-anchor-id="feature-importance">Feature Importance</h3>
<p>We should verify to see that the fitted xG models are behaving as expected. One way of doing so is to look at the importance of the features for model predictions.</p>
<p>In bespoke models (like the Elo-augmented model), feature importance can be enlightening, as it tells us which features are contributing most to the predicted outcomes. For the base model, I know that shot distance should be the most important feature (by far), as this is found to be the most important features in other similar “basic” public xG models, such as <a href="https://github.com/AnshChoudhary/xGModel/blob/main/expected-goals-model-xg.ipynb">this one</a> and <a href="https://github.com/ML-KULeuven/soccer_xg/blob/master/notebooks/4-creating-custom-xg-pipelines.ipynb">this one</a>.</p>
<p>I like to use <a href="https://christophm.github.io/interpretable-ml-book/shap.html">SHAP values</a> for feature importance since <a href="https://liuyanguu.github.io/post/2019/07/18/visualization-of-shap-for-xgboost/">they have nice “local” explanations and are found to be consistent in their “global” structure</a>.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
SHAP values
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>SHAP values quantify the impact of each feature in a predictive model on the model’s output. For a binary classification task like ours, SHAP values are expressed on a 0-1 scale.</p>
<p>A SHAP value of 0.9 for a specific feature in a binary classification model doesn’t mean that the feature contributes 90% to the prediction, nor does it directly imply that the predicted probability is 90%. Instead, it indicates that this particular feature contributes a value of 0.9 to the shift from the baseline prediction (usually the average of the training data’s output) to the specific model output for that observation.</p>
</div>
</div>
</div>
<p><img src="https://tonyelhabr.rbind.io/posts/xg-team-quality/var-imp-base.png" class="img-fluid"></p>
<p>Indeed, we find that shot distance is the most important feature with the base xG model.</p>
<p>Now, if we make the same plot and add the aggregate SHAP values for our Elo-augmented xG model, we see that Elo and Elo difference terms are in the middle of the pack in terms of feature importance. That’s pretty interesting. That indicates that these features aren’t super influential, on average.</p>
<p><img src="https://tonyelhabr.rbind.io/posts/xg-team-quality/var-imp-compared.png" class="img-fluid"></p>
<p>Further, we can verify that the Elo-augmented model predicts xG in a manner that matches intuition using <a href="https://christophm.github.io/interpretable-ml-book/shap.html#shap-dependence-plot">SHAP dependence plots</a>. We should see that the SHAP values are higher when Elo is higher and when Elo difference is higher.</p>
<p><img src="https://tonyelhabr.rbind.io/posts/xg-team-quality/elo-pdp.png" class="img-fluid"></p>
<p>Indeed, this is generally what we observe, although the relationships aren’t quite monotonic, as I would have expected.<sup>6</sup></p>
</section>
<section id="model-evaluation" class="level3">
<h3 class="anchored" data-anchor-id="model-evaluation">Model Evaluation</h3>
<p>So aggregate SHAP values indicate that our two Elo features aren’t playing a big role in contributing to model predictions, although the features do indeed contribute in the way that we’d expect. But SHAP values are just telling us about how and why a model makes certain predictions. What about the performance of the Elo-augmented model compared to the base xG model?</p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: left;">Model Type</th>
<th style="text-align: right;">Brier Skill Score</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Base</td>
<td style="text-align: right;">0.1058</td>
</tr>
<tr class="even">
<td style="text-align: left;">Elo-augmented</td>
<td style="text-align: right;">0.1056</td>
</tr>
</tbody>
</table>
<p>Well, at least in terms of BSS, it looks like there’s basically no difference between the models.</p>
<p>But that’s just one, holistic measure. How well-calibrated is the Elo-augmented model compared to the traditional xG model? Does the augmented model demonstrate better performance across the whole range of shot conversion probabilities?</p>
<p><img src="https://tonyelhabr.rbind.io/posts/xg-team-quality/compared-calibration.png" class="img-fluid"></p>
<p>Visually, I wouldn’t say there’s any significant difference between the calibration curves. A plot of calibration given various buckets for Elo difference would lead to the same conclusion–the Elo-augmented model isn’t notably more calibrated.</p>
</section>
</section>
<section id="discussion" class="level2">
<h2 class="anchored" data-anchor-id="discussion">Discussion</h2>
<p>So we’ve seen that there is no clear evidence that accounting for team quality improves an xG model. Sure, it can provide value to an xG model–as shown with the SHAP plots for the Elo-augmented model–but it’s effectively just providing a different kind of information that could be otherwise captured by other traditional xG features.</p>
<p>So naturally one may ask–what about player quality? Or goalkeeper quality?</p>
<p>While I do think those would be a little more useful in terms of making a better xG model, the better question is whether we should be accounting for these kinds of “quality” features at all. say “no”–although I do think it’s fine for NFL EP models–due to the manner in which xG models are typically applied.</p>
<section id="application-of-xg-in-soccer-vs.-ep-in-american-football" class="level3">
<h3 class="anchored" data-anchor-id="application-of-xg-in-soccer-vs.-ep-in-american-football">Application of xG in soccer vs.&nbsp;EP in American football</h3>
<p>Unlike a fourth-down model that can be “actively” used by NFL coaches to make real-time decisions, an xG model in soccer serves a more “passive” role. Soccer players lack the luxury of time that NFL coaches have to calculate xG on the fly when deciding whether to take a shot. Instead, xG feels better suited as a retrospective, descriptive measure of actions that have already occurred.</p>
<p>Further, one can make the argument that incorporating team or player quality into an xG model can make interpretation more difficult, at least in the manner that we typically use xG to contextualize a game or a season. (xGods, please forgive me for looking at single-game xG.) As an extreme example, let’s say that we add an “Is Messi?” feature to an xG model–not unlike what Ryan suggested with Justin Tucker in his presentation–to achieve a slightly more accurate xG model. That’s all fine in theory, but then your game- and season-level xG insights would need to change.</p>
<p>I may look at an Inter Miami game where they “lost” on actual goals, let’s say 2 to 1, <em>and</em> “lost” on xG, let’s say 0.9 to 1.7, and think “Oh, that’s a fair result”. But if Messi took 4 shots and we’re using an expected goals model with the “Is Messi?” feature, the Inter Miami xG might appear to be 2.2, perhaps leading to a different take on the game–“that was Inter Miami’s game, but they failed to convert on some key chances”.</p>
<p>Overall, I’d say that it feels circular to build in “quality” features into a model used to evaluate shot quality, and, downstream, player and team quality, at least in the current paradigm of soccer analytics.</p>
</section>
<section id="in-favor-of-team-andor-player-quality-features" class="level3">
<h3 class="anchored" data-anchor-id="in-favor-of-team-andor-player-quality-features">In favor of team and/or player quality features</h3>
<p>On the other hand, I do see the argument in favor of identity features in xG models, e.g.&nbsp;a <a href="https://www.youtube.com/watch?v=5WRe6SoBh3g">RAPM-esque</a> xG model. Such indicator variables allow us <a href="https://www.youtube.com/watch?v=CzKCMUJ9yV8">to estimate player and team impact directly</a>, as well as the uncertainty for those individual estimates. Assuming the model estimation procedure is sound, a direct estimate of player or team skill is better than relying on the “residual” of goals minus xG, as is typically done.</p>
<p>Further, I’ve been assuming that looking at xGD will always be the primary way that xG is used to evaluate players. If we can reliably estimate player skill directly with an xG model and can tease out how that effect changes over time, then perhaps we should prefer those kinds of estimates.</p>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>Inspired by observed biases in American football’s expected points models, I trained a model to evaluate whether accounting for team strength directly might improve predictiveness and calibration of an expected goals model for soccer. Despite SHAP plots indicating some value in Elo-augmented models, the overall performance metrics and calibration plots showed negligible differences compared to the base xG model.</p>
<p>On the surface, this is a little at odds with <a href="https://www.thesignificantgame.com/portfolio/do-naive-xg-models-underestimate-expected-goals-for-top-teams/">Lars Maurath’s ex-post finding</a> that team quality is useful for explaining xGD, which matches my intuition. However, as Lars points out, team quality is highly correlated with shot volume, and team quality may just be a mask for the effect of highly skilled players with superior finishing capabilities. So, perhaps with better feature engineering–e.g.&nbsp;shots per 90 in the prior N matches, weekly wages of the shot-taker or the shot-taking team–I could prove that directly accounting for team strength can improve an xG model.</p>
<p>Given all my questions and speculations about the role of player quality with respect to xG calibration, perhaps it’s not surprising that the most natural area of future research would be to evaluate how measures of player skill might improve an xG model. There is some <a href="https://statsbomb.com/wp-content/uploads/2022/09/Tahmeed-Tureen-and-Sigrid-Olthof-%E2%80%93-Estimated-Player-Impact-EPI-Quantifying-The-Effects-Of-Individual-Players-On-Football-Actions-Using-Hierarchical-Statistical-Models.pdf">prior art</a> on this, so it would be wise to identify how one could contribute something novel to that work.</p>



</section>


<div class="quarto-listing quarto-listing-container-default" id="listing-listing">
<div class="list quarto-listing-default">

</div>
<div class="listing-no-matching d-none">
No matching items
</div>
</div><div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>It was also fairly easy to retrieve and is what Lars used to gauge “top” teams in a quantitative way.↩︎</p></li>
<li id="fn2"><p>One might get a slightly more performant by adding the <code>x</code> and <code>y</code> coordinates of the shot–to implicitly account for right-footed bias, for example–but I actually prefer not to add those in the model. Such terms can result in slight <a href="https://en.wikipedia.org/wiki/Overfitting">over-fitting</a>, in the presence of other features that provide information about the location of the shot, such as distance and angle. (This is the classical <a href="https://en.wikipedia.org/wiki/Bias%E2%80%93variance_tradeoff">“bias-variance” trade-off</a>.)↩︎</p></li>
<li id="fn3"><p>xgboost is the state-of-the-art framework for tabular machine learning tasks and is used by companies like Opta for their xG models.↩︎</p></li>
<li id="fn4"><p>12% is approximately the observed shot conversion rate in the whole data set.↩︎</p></li>
<li id="fn5"><p>This post isn’t meant to be so much about the why’s and how’s of model tuning and training, so I’ve spared commentary on the code.↩︎</p></li>
<li id="fn6"><p>Of course, I could have forced the xgboost model with the Elo terms to have monotonic behavior for those features. I intentionally didn’t do that here so as to not confirm my own biases–that higher xG should generally correspond with higher Elo.↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>r</category>
  <category>soccer</category>
  <guid>https://tonyelhabr.rbind.io/posts/xg-team-quality/index.html</guid>
  <pubDate>Fri, 29 Dec 2023 06:00:00 GMT</pubDate>
  <media:content url="https://tonyelhabr.rbind.io/posts/xg-team-quality/var-imp-compared.png" medium="image" type="image/png" height="144" width="144"/>
</item>
<item>
  <title>Game state with FBref data</title>
  <dc:creator>Tony ElHabr</dc:creator>
  <link>https://tonyelhabr.rbind.io/posts/fbref-gamestate-expected-goal-difference/index.html</link>
  <description><![CDATA[ 



<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>Soccer is a game defined by its discrete, low-scoring nature, where the dynamics of a match are often dictated by the <a href="https://statsbomb.com/articles/soccer/game-states-and-loss-aversion/">“game state”</a>. Whether a team is leading, trailing, or level with their opponent at a specific moment can often influence how aggressively a team plays. Contextualizing statistics like <a href="https://theanalyst.com/na/2021/07/what-are-expected-goals-xg/">expected goals (xG)</a> can shed new light on how we evaluate team performance.</p>
<p>Consider this scenario: a team enters a match as the underdog. They play aggressively early on, getting a few shots on target and eventually scoring, taking a 1-0 lead going into halftime. After the half, they decide to switch into a more defensive scheme, pulling everyone back towards their 18-yard box when the opponent has the ball. They end the match with no additional shots or xG accumulated, but they win the game. While their secondhalf statistics look poor because they <a href="https://www.youtube.com/watch?v=7LF-K-ta9PI">“parked the bus”</a>, they arguably increased their odds of winning. If we consider the game state when looking at the winning team’s statistics, we can reason about why their xG looks poor.</p>
<p>So, game state is useful, right? Yet, game state analysis remains somewhat under-utilized in soccer analytics, in my opinion. Why is that? Well, it’s not without its challenges. Contextualizing numbers according to game state can introduce biases, leading us to over-attribute outcomes to tactical choices. Moreover, the calculations involved can be far from trivial.</p>
<p>So that’s what this post is for. I’ll walk through how to calculate expected goals difference (xGD)<sup>1</sup>–the difference between your team’s expected goals and your opponent’s–with respect to the game state, using data from <a href="https://fbref.com/">FBref</a>.</p>
</section>
<section id="data-pull" class="level2">
<h2 class="anchored" data-anchor-id="data-pull">Data pull</h2>
<p>The 2023 Major League Soccer (MLS) regular season just ended, and I’m interested to see what we might learn about the teams who qualified for playoffs. So, naturally, I’ve chosen to focus on this past MLS season for our game state calculations.</p>
<p>To begin<sup>2</sup>, we pull raw FBref data from pre-saved <code>{worldfootballR}</code> release data, starting with match shots.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## data scrape</span></span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(worldfootballR) <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## version: 0.6.4.9</span></span>
<span id="cb1-3"></span>
<span id="cb1-4"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## data manipulation</span></span>
<span id="cb1-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)</span>
<span id="cb1-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(lubridate)</span>
<span id="cb1-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyr)</span>
<span id="cb1-8"></span>
<span id="cb1-9">COUNTRY <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'USA'</span></span>
<span id="cb1-10">GENDER <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'M'</span></span>
<span id="cb1-11">TIER <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'1st'</span></span>
<span id="cb1-12">SEASON_END_YEAR <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2023</span></span>
<span id="cb1-13"></span>
<span id="cb1-14">raw_shots <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> worldfootballR<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">load_fb_match_shooting</span>(</span>
<span id="cb1-15">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">country =</span> COUNTRY,</span>
<span id="cb1-16">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gender =</span> GENDER,</span>
<span id="cb1-17">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tier =</span> TIER,</span>
<span id="cb1-18">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">season_end_year =</span> SEASON_END_YEAR</span>
<span id="cb1-19">)</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glimpse</span>(raw_shots)</span>
<span id="cb2-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; Rows: 15,277</span></span>
<span id="cb2-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; Columns: 23</span></span>
<span id="cb2-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ MatchURL         &lt;chr&gt; "https://fbref.com/en/matches/48a684ed/Nashvil…</span></span>
<span id="cb2-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ Date             &lt;chr&gt; "2023-02-25", "2023-02-25", "2023-02-25", "202…</span></span>
<span id="cb2-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ Squad            &lt;chr&gt; "Nashville", "Nashville", "Nashville", "Nashvi…</span></span>
<span id="cb2-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ Home_Away        &lt;chr&gt; "Home", "Home", "Home", "Home", "Home", "Home"…</span></span>
<span id="cb2-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ Match_Half       &lt;dbl&gt; 1, 1, 1, 1, 1, 2, 2, 2, 2, 1, 1, 1, 1, 2, 2, 2…</span></span>
<span id="cb2-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ Minute           &lt;chr&gt; "6", "13", "31", "34", "45+1", "51", "73", "80…</span></span>
<span id="cb2-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ Player           &lt;chr&gt; "Jacob Shaffelburg", "Sean Davis", "Teal Bunbu…</span></span>
<span id="cb2-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ Player_Href      &lt;chr&gt; "/en/players/339a2561/Jacob-Shaffelburg", "/en…</span></span>
<span id="cb2-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ xG               &lt;chr&gt; "0.39", "0.09", "0.03", "0.25", "0.04", "0.02"…</span></span>
<span id="cb2-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ PSxG             &lt;chr&gt; "0.47", "", "0.06", "0.74", "", "", "", "0.96"…</span></span>
<span id="cb2-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ Outcome          &lt;chr&gt; "Saved", "Off Target", "Saved", "Goal", "Off T…</span></span>
<span id="cb2-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ Distance         &lt;chr&gt; "16", "18", "29", "8", "17", "25", "28", "11",…</span></span>
<span id="cb2-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ `Body Part`      &lt;chr&gt; "Right Foot", "Left Foot", "Right Foot", "Righ…</span></span>
<span id="cb2-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ Notes            &lt;chr&gt; "", "Volley", "Deflected", "Volley", "", "", "…</span></span>
<span id="cb2-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ Player_SCA_1     &lt;chr&gt; "Randall Leal", "Aníbal Godoy", "Jacob Shaffel…</span></span>
<span id="cb2-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ Event_SCA_1      &lt;chr&gt; "Pass (Live)", "Pass (Live)", "Pass (Live)", "…</span></span>
<span id="cb2-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ Player_SCA_2     &lt;chr&gt; "Walker Zimmerman", "Jack Maher", "Joe Willis"…</span></span>
<span id="cb2-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ Event_SCA_2      &lt;chr&gt; "Pass (Live)", "Pass (Live)", "Pass (Live)", "…</span></span>
<span id="cb2-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ Competition_Name &lt;chr&gt; "Major League Soccer", "Major League Soccer", …</span></span>
<span id="cb2-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ Gender           &lt;chr&gt; "M", "M", "M", "M", "M", "M", "M", "M", "M", "…</span></span>
<span id="cb2-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ Country          &lt;chr&gt; "USA", "USA", "USA", "USA", "USA", "USA", "USA…</span></span>
<span id="cb2-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ Tier             &lt;chr&gt; "1st", "1st", "1st", "1st", "1st", "1st", "1st…</span></span>
<span id="cb2-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ Season_End_Year  &lt;int&gt; 2023, 2023, 2023, 2023, 2023, 2023, 2023, 2023…</span></span></code></pre></div>
</div>
<p>Given a match URL like <a href="https://fbref.com/en/matches/82503f4e/Atlanta-United-Inter-Miami-September-16-2023-Major-League-Soccer">this</a>, <code>worldfootballR::load_fb_match_shooting()</code> provides data from the “Shots” table on the page.</p>
<p><img src="https://tonyelhabr.rbind.io/posts/fbref-gamestate-expected-goal-difference/match-shots.png" class="img-fluid"></p>
<p>While it might seem like the shots table is all we’d need to calculate expected goal difference (xGD), FBref’s match shot log table doesn’t include own goals. Nonetheless, we can use <code>worldfootballR::load_fb_match_summary()</code> to extract timestamps for own goals from the “Match Summary” timeline.</p>
<p><img src="https://tonyelhabr.rbind.io/posts/fbref-gamestate-expected-goal-difference/match-summary.png" class="img-fluid"></p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">raw_match_summaries <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> worldfootballR<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">load_fb_match_summary</span>(</span>
<span id="cb3-2">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">country =</span> COUNTRY,</span>
<span id="cb3-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gender =</span> GENDER,</span>
<span id="cb3-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tier =</span> TIER,</span>
<span id="cb3-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">season_end_year =</span> SEASON_END_YEAR</span>
<span id="cb3-6">)</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glimpse</span>(raw_match_summaries)</span>
<span id="cb4-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; Rows: 9,565</span></span>
<span id="cb4-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; Columns: 33</span></span>
<span id="cb4-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ MatchURL          &lt;chr&gt; "https://fbref.com/en/matches/48a684ed/Nashvi…</span></span>
<span id="cb4-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ League            &lt;chr&gt; "Major League Soccer", "Major League Soccer",…</span></span>
<span id="cb4-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ Match_Date        &lt;chr&gt; "2023-02-25", "2023-02-25", "2023-02-25", "20…</span></span>
<span id="cb4-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ Matchweek         &lt;chr&gt; "Major League Soccer (Regular Season)", "Majo…</span></span>
<span id="cb4-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ Home_Team         &lt;chr&gt; "Nashville SC", "Nashville SC", "Nashville SC…</span></span>
<span id="cb4-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ Home_Formation    &lt;chr&gt; "4-2-3-1", "4-2-3-1", "4-2-3-1", "4-2-3-1", "…</span></span>
<span id="cb4-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ Home_Score        &lt;dbl&gt; 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, …</span></span>
<span id="cb4-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ Home_xG           &lt;dbl&gt; 1.3, 1.3, 1.3, 1.3, 1.3, 1.3, 1.3, 1.3, 1.3, …</span></span>
<span id="cb4-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ Home_Goals        &lt;chr&gt; "Walker Zimmerman · 34&amp;rsquor; Jacob Shaffelb…</span></span>
<span id="cb4-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ Home_Yellow_Cards &lt;chr&gt; "1", "1", "1", "1", "1", "1", "1", "1", "1", …</span></span>
<span id="cb4-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ Home_Red_Cards    &lt;chr&gt; "0", "0", "0", "0", "0", "0", "0", "0", "0", …</span></span>
<span id="cb4-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ Away_Team         &lt;chr&gt; "New York City FC", "New York City FC", "New …</span></span>
<span id="cb4-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ Away_Formation    &lt;chr&gt; "4-2-3-1", "4-2-3-1", "4-2-3-1", "4-2-3-1", "…</span></span>
<span id="cb4-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ Away_Score        &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, …</span></span>
<span id="cb4-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ Away_xG           &lt;dbl&gt; 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, …</span></span>
<span id="cb4-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ Away_Goals        &lt;chr&gt; "", "", "", "", "", "", "", "", "", "", "", "…</span></span>
<span id="cb4-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ Away_Yellow_Cards &lt;chr&gt; "4", "4", "4", "4", "4", "4", "4", "4", "4", …</span></span>
<span id="cb4-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ Away_Red_Cards    &lt;chr&gt; "0", "0", "0", "0", "0", "0", "0", "0", "0", …</span></span>
<span id="cb4-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ Game_URL          &lt;chr&gt; "https://fbref.com/en/matches/48a684ed/Nashvi…</span></span>
<span id="cb4-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ Team              &lt;chr&gt; "New York City FC", "Nashville SC", "Nashvill…</span></span>
<span id="cb4-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ Home_Away         &lt;chr&gt; "Away", "Home", "Home", "Away", "Away", "Home…</span></span>
<span id="cb4-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ Event_Time        &lt;dbl&gt; 28, 34, 58, 62, 70, 72, 74, 75, 80, 82, 82, 8…</span></span>
<span id="cb4-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ Is_Pens           &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FAL…</span></span>
<span id="cb4-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ Event_Half        &lt;dbl&gt; 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, …</span></span>
<span id="cb4-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ Event_Type        &lt;chr&gt; "Yellow Card", "Goal", "Yellow Card", "Yellow…</span></span>
<span id="cb4-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ Event_Players     &lt;chr&gt; "Braian Cufré", "Walker Zimmerman Assist: Faf…</span></span>
<span id="cb4-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ Score_Progression &lt;chr&gt; "0:0", "1:0", "1:0", "1:0", "1:0", "1:0", "1:…</span></span>
<span id="cb4-31"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ Penalty_Number    &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…</span></span>
<span id="cb4-32"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ Competition_Name  &lt;chr&gt; "Major League Soccer", "Major League Soccer",…</span></span>
<span id="cb4-33"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ Gender            &lt;chr&gt; "M", "M", "M", "M", "M", "M", "M", "M", "M", …</span></span>
<span id="cb4-34"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ Country           &lt;chr&gt; "USA", "USA", "USA", "USA", "USA", "USA", "US…</span></span>
<span id="cb4-35"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ Tier              &lt;chr&gt; "1st", "1st", "1st", "1st", "1st", "1st", "1s…</span></span>
<span id="cb4-36"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ Season_End_Year   &lt;int&gt; 2023, 2023, 2023, 2023, 2023, 2023, 2023, 202…</span></span></code></pre></div>
</div>
</section>
<section id="data-wrangling" class="level2">
<h2 class="anchored" data-anchor-id="data-wrangling">Data wrangling</h2>
<p>Now we start to clean up the raw data. Starting with the match summary data, we:</p>
<ol type="1">
<li>Create a <code>match_id</code> field, to make it easy to join this data set with the shots data set.</li>
<li>Clean up the time fields, <code>minutes</code> and <code>minutes_added</code>.</li>
<li>Rename existing columns.</li>
</ol>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Extract the from "47880eb7" from "https://fbref.com/en/matches/47880eb7/Liverpool-Manchester-City-November-10-2019-Premier-League"</span></span>
<span id="cb5-2">extract_fbref_match_id <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(match_url) {</span>
<span id="cb5-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">basename</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dirname</span>(match_url))</span>
<span id="cb5-4">}</span>
<span id="cb5-5"></span>
<span id="cb5-6">match_summaries <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> raw_match_summaries <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-7">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(MatchURL) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-8">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb5-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">match_summary_rn =</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">row_number</span>(dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">desc</span>(Event_Time)),</span>
<span id="cb5-10">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">match_has_no_penalties =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all</span>(Event_Type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Penalty'</span>)</span>
<span id="cb5-11">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-12">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-13">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb5-14">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">match_has_no_goals =</span> Away_Score <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> Home_Score <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb5-15">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-16">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Drop non-shot events, e.g. card and substitution events. </span></span>
<span id="cb5-17">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   Always keep the first timeline event, so that we're not accidentally dropping matches.</span></span>
<span id="cb5-18">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(</span>
<span id="cb5-19">    Event_Type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Goal'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Own Goal'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Penalty'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> </span>
<span id="cb5-20">      <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## don't drop games with no goals</span></span>
<span id="cb5-21">      (match_has_no_goals <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> match_has_no_penalties <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> match_summary_rn <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb5-22">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-23">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">transmute</span>(</span>
<span id="cb5-24">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">match_id =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">extract_fbref_match_id</span>(MatchURL),</span>
<span id="cb5-25">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">season =</span> Season_End_Year,</span>
<span id="cb5-26">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gender =</span> Gender,</span>
<span id="cb5-27">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tier =</span> Tier,</span>
<span id="cb5-28">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">date =</span> lubridate<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ymd</span>(Match_Date),</span>
<span id="cb5-29">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">home_team =</span> Home_Team ,</span>
<span id="cb5-30">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">away_team =</span> Away_Team,</span>
<span id="cb5-31">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">period =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.integer</span>(Event_Half),</span>
<span id="cb5-32">    <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## ensure that minutes always has a value</span></span>
<span id="cb5-33">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">minutes =</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(</span>
<span id="cb5-34">      period <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> 1L <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> Event_Time <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> 45L <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> 45L, </span>
<span id="cb5-35">      period <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> 2L <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> Event_Time <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> 90L <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> 90L,</span>
<span id="cb5-36">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.default =</span> Event_Time</span>
<span id="cb5-37">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.integer</span>(),</span>
<span id="cb5-38">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">minutes_added =</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(</span>
<span id="cb5-39">      period <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> 1L <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> Event_Time <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">45</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> Event_Time <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> 45L, </span>
<span id="cb5-40">      period <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> 2L <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> Event_Time <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">90</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> Event_Time <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> 90L,</span>
<span id="cb5-41">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.default =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA_integer_</span></span>
<span id="cb5-42">    ),</span>
<span id="cb5-43">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">home_g =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.integer</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gsub</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'[:].*$'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>, Score_Progression)), <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## after event</span></span>
<span id="cb5-44">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">away_g =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.integer</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gsub</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'^.*[:]'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>, Score_Progression)),</span>
<span id="cb5-45">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">is_own_goal =</span> Event_Type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Own Goal'</span>,</span>
<span id="cb5-46">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">team =</span> Team,</span>
<span id="cb5-47">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">player =</span> Event_Players</span>
<span id="cb5-48">  )</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glimpse</span>(match_summaries)</span>
<span id="cb6-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; Rows: 1,752</span></span>
<span id="cb6-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; Columns: 15</span></span>
<span id="cb6-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ match_id      &lt;chr&gt; "48a684ed", "48a684ed", "1861e533", "1861e533", "…</span></span>
<span id="cb6-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ season        &lt;int&gt; 2023, 2023, 2023, 2023, 2023, 2023, 2023, 2023, 2…</span></span>
<span id="cb6-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ gender        &lt;chr&gt; "M", "M", "M", "M", "M", "M", "M", "M", "M", "M",…</span></span>
<span id="cb6-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ tier          &lt;chr&gt; "1st", "1st", "1st", "1st", "1st", "1st", "1st", …</span></span>
<span id="cb6-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ date          &lt;date&gt; 2023-02-25, 2023-02-25, 2023-02-25, 2023-02-25, …</span></span>
<span id="cb6-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ home_team     &lt;chr&gt; "Nashville SC", "Nashville SC", "FC Cincinnati", …</span></span>
<span id="cb6-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ away_team     &lt;chr&gt; "New York City FC", "New York City FC", "Houston …</span></span>
<span id="cb6-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ period        &lt;int&gt; 1, 2, 1, 1, 2, 2, 1, 1, 2, 2, 1, 1, 2, 2, 2, 2, 1…</span></span>
<span id="cb6-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ minutes       &lt;int&gt; 34, 80, 19, 45, 48, 48, 12, 39, 90, 90, 28, 45, 5…</span></span>
<span id="cb6-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ minutes_added &lt;dbl&gt; NA, NA, NA, 2, NA, NA, NA, NA, 3, 9, NA, 3, NA, N…</span></span>
<span id="cb6-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ home_g        &lt;int&gt; 1, 2, 1, 1, 2, 0, 0, 0, 1, 2, 0, 1, 2, 3, 4, 1, 0…</span></span>
<span id="cb6-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ away_g        &lt;int&gt; 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1…</span></span>
<span id="cb6-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ is_own_goal   &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, …</span></span>
<span id="cb6-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ team          &lt;chr&gt; "Nashville SC", "Nashville SC", "FC Cincinnati", …</span></span>
<span id="cb6-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ player        &lt;chr&gt; "Walker Zimmerman Assist: Fafà Picault", "Jacob S…</span></span></code></pre></div>
</div>
<p>Next, we start to clean up the <code>shots</code> data frame. The data wrangling is similar.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">shots <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> raw_shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb7-2">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">transmute</span>(</span>
<span id="cb7-3">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">match_id =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">extract_fbref_match_id</span>(MatchURL),</span>
<span id="cb7-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">period =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.integer</span>(Match_Half),</span>
<span id="cb7-5">    <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## convert "45+2" to "45"</span></span>
<span id="cb7-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">minutes =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(</span>
<span id="cb7-7">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grepl</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'[+]'</span>, Minute),</span>
<span id="cb7-8">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.integer</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gsub</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'(^[0-9]+)[+]([0-9]+$)'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">1'</span>, Minute)), </span>
<span id="cb7-9">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.integer</span>(Minute)</span>
<span id="cb7-10">    ),</span>
<span id="cb7-11">    <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## convert "45+2" to "2"</span></span>
<span id="cb7-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">minutes_added =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(</span>
<span id="cb7-13">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grepl</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'[+]'</span>, Minute), </span>
<span id="cb7-14">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.integer</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gsub</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'(^[0-9]+)[+]([0-9]+$)'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">2'</span>, Minute)), </span>
<span id="cb7-15">      <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA_integer_</span></span>
<span id="cb7-16">    ),</span>
<span id="cb7-17">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">is_home =</span> Home_Away <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Home'</span>,</span>
<span id="cb7-18">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">team =</span> Squad,</span>
<span id="cb7-19">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">player =</span> Player,</span>
<span id="cb7-20">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">is_goal =</span> Outcome <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Goal'</span>,</span>
<span id="cb7-21">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xg =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.double</span>(xG)</span>
<span id="cb7-22">  )</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1">dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glimpse</span>(shots)</span>
<span id="cb8-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; Rows: 15,277</span></span>
<span id="cb8-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; Columns: 9</span></span>
<span id="cb8-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ match_id      &lt;chr&gt; "48a684ed", "48a684ed", "48a684ed", "48a684ed", "…</span></span>
<span id="cb8-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ period        &lt;int&gt; 1, 1, 1, 1, 1, 2, 2, 2, 2, 1, 1, 1, 1, 2, 2, 2, 2…</span></span>
<span id="cb8-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ minutes       &lt;int&gt; 6, 13, 31, 34, 45, 51, 73, 80, 83, 19, 30, 41, 45…</span></span>
<span id="cb8-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ minutes_added &lt;int&gt; NA, NA, NA, NA, 1, NA, NA, NA, NA, NA, NA, NA, 2,…</span></span>
<span id="cb8-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ is_home       &lt;lgl&gt; TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, T…</span></span>
<span id="cb8-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ team          &lt;chr&gt; "Nashville", "Nashville", "Nashville", "Nashville…</span></span>
<span id="cb8-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ player        &lt;chr&gt; "Jacob Shaffelburg", "Sean Davis", "Teal Bunbury"…</span></span>
<span id="cb8-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ is_goal       &lt;lgl&gt; FALSE, FALSE, FALSE, TRUE, FALSE, FALSE, FALSE, T…</span></span>
<span id="cb8-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ xg            &lt;dbl&gt; 0.39, 0.09, 0.03, 0.25, 0.04, 0.02, 0.02, 0.45, 0…</span></span></code></pre></div>
</div>
<section id="accounting-for-own-goals" class="level3">
<h3 class="anchored" data-anchor-id="accounting-for-own-goals">Accounting for Own goals</h3>
<p>Now, for the ugliest part of all this shot data wrangling–handling own goals.</p>
<p>First, we inject “synthetic” records into the <code>shots</code> data for every case where the match summary indicates that there is an own goal.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">shots_with_own_goals <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>(</span>
<span id="cb9-2">  shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb9-3">    dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">transmute</span>(</span>
<span id="cb9-4">      match_id,</span>
<span id="cb9-5">      period,</span>
<span id="cb9-6">      minutes,</span>
<span id="cb9-7">      minutes_added,</span>
<span id="cb9-8">      is_home,</span>
<span id="cb9-9">      team,</span>
<span id="cb9-10">      player,</span>
<span id="cb9-11">      is_goal,</span>
<span id="cb9-12">      xg,</span>
<span id="cb9-13">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">is_own_goal =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span></span>
<span id="cb9-14">    ),</span>
<span id="cb9-15">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## synthetic events for own goals</span></span>
<span id="cb9-16">  match_summaries <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb9-17">    dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(</span>
<span id="cb9-18">      is_own_goal</span>
<span id="cb9-19">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb9-20">    dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">transmute</span>(</span>
<span id="cb9-21">      match_id,</span>
<span id="cb9-22">      period,</span>
<span id="cb9-23">      minutes,</span>
<span id="cb9-24">      minutes_added,</span>
<span id="cb9-25">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">is_home =</span> team <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> home_team,</span>
<span id="cb9-26">      team,</span>
<span id="cb9-27">      player,</span>
<span id="cb9-28">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">is_goal =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span id="cb9-29">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xg =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA_real_</span>,</span>
<span id="cb9-30">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">is_own_goal =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span></span>
<span id="cb9-31">    )</span>
<span id="cb9-32">)</span></code></pre></div>
</details>
</div>
<p>Next, we add proper, cleaned columns for goals and xG.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1">clean_shots <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> shots_with_own_goals <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb10-2">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## To get meta-information about the game</span></span>
<span id="cb10-3">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inner_join</span>(</span>
<span id="cb10-4">    match_summaries <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb10-5">      dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">distinct</span>(match_id, home_team, away_team),</span>
<span id="cb10-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(match_id),</span>
<span id="cb10-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">relationship =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'many-to-one'</span></span>
<span id="cb10-8">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb10-9">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb10-10">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">home_g =</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(</span>
<span id="cb10-11">      <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Note that fotmob would list the away team for an own goal but fbref </span></span>
<span id="cb10-12">      <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   lists the home team</span></span>
<span id="cb10-13">      (is_goal <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> is_own_goal) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> is_home <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> 1L,</span>
<span id="cb10-14">      is_own_goal <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> is_home <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> 1L,</span>
<span id="cb10-15">      <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> 0L</span>
<span id="cb10-16">    ),</span>
<span id="cb10-17">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">away_g =</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(</span>
<span id="cb10-18">      (is_goal <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> is_own_goal) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>is_home <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> 1L,</span>
<span id="cb10-19">      <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> 0L</span>
<span id="cb10-20">    ),</span>
<span id="cb10-21">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">home_xg =</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(</span>
<span id="cb10-22">      is_home <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coalesce</span>(xg, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>),</span>
<span id="cb10-23">      <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> 0L <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## even for own goals</span></span>
<span id="cb10-24">    ),</span>
<span id="cb10-25">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">away_xg =</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(</span>
<span id="cb10-26">      <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>is_home <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coalesce</span>(xg, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>),</span>
<span id="cb10-27">      <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> 0L</span>
<span id="cb10-28">    )</span>
<span id="cb10-29">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb10-30">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(match_id) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb10-31">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Differentiate between shots in the same minute.</span></span>
<span id="cb10-32">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb10-33">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shot_idx =</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">row_number</span>((minutes <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coalesce</span>(minutes_added, 0L)))</span>
<span id="cb10-34">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb10-35">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb10-36">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">transmute</span>(</span>
<span id="cb10-37">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shot_id =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sprintf</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'%s-%02d'</span>, match_id, shot_idx),</span>
<span id="cb10-38">    match_id,</span>
<span id="cb10-39">    period,</span>
<span id="cb10-40">    minutes,</span>
<span id="cb10-41">    minutes_added,</span>
<span id="cb10-42">    is_home,</span>
<span id="cb10-43">    is_goal,</span>
<span id="cb10-44">    is_own_goal,</span>
<span id="cb10-45">    player,</span>
<span id="cb10-46">    home_team,</span>
<span id="cb10-47">    away_team,</span>
<span id="cb10-48">    home_g,</span>
<span id="cb10-49">    away_g,</span>
<span id="cb10-50">    home_xg,</span>
<span id="cb10-51">    away_xg</span>
<span id="cb10-52">  )</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1">dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glimpse</span>(clean_shots)</span>
<span id="cb11-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; Rows: 15,335</span></span>
<span id="cb11-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; Columns: 15</span></span>
<span id="cb11-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ shot_id       &lt;chr&gt; "48a684ed-01", "48a684ed-02", "48a684ed-05", "48a…</span></span>
<span id="cb11-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ match_id      &lt;chr&gt; "48a684ed", "48a684ed", "48a684ed", "48a684ed", "…</span></span>
<span id="cb11-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ period        &lt;int&gt; 1, 1, 1, 1, 1, 2, 2, 2, 2, 1, 1, 1, 1, 2, 2, 2, 2…</span></span>
<span id="cb11-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ minutes       &lt;int&gt; 6, 13, 31, 34, 45, 51, 73, 80, 83, 19, 30, 41, 45…</span></span>
<span id="cb11-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ minutes_added &lt;dbl&gt; NA, NA, NA, NA, 1, NA, NA, NA, NA, NA, NA, NA, 2,…</span></span>
<span id="cb11-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ is_home       &lt;lgl&gt; TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, T…</span></span>
<span id="cb11-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ is_goal       &lt;lgl&gt; FALSE, FALSE, FALSE, TRUE, FALSE, FALSE, FALSE, T…</span></span>
<span id="cb11-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ is_own_goal   &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, …</span></span>
<span id="cb11-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ player        &lt;chr&gt; "Jacob Shaffelburg", "Sean Davis", "Teal Bunbury"…</span></span>
<span id="cb11-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ home_team     &lt;chr&gt; "Nashville SC", "Nashville SC", "Nashville SC", "…</span></span>
<span id="cb11-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ away_team     &lt;chr&gt; "New York City FC", "New York City FC", "New York…</span></span>
<span id="cb11-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ home_g        &lt;int&gt; 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0…</span></span>
<span id="cb11-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ away_g        &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…</span></span>
<span id="cb11-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ home_xg       &lt;dbl&gt; 0.39, 0.09, 0.03, 0.25, 0.04, 0.02, 0.02, 0.45, 0…</span></span>
<span id="cb11-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ away_xg       &lt;dbl&gt; 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0…</span></span></code></pre></div>
</div>
</section>
<section id="double-counting-shot-events" class="level3">
<h3 class="anchored" data-anchor-id="double-counting-shot-events">Double Counting Shot Events</h3>
<p>Up to this point, we have one record per shot. But, to calculate goals and expected goals (xG) conceded for any given team at any given point in a game, we can make our lives easier by “double counting” each shot event, once from each team’s perspective.</p>
<p>To do that, we first re-assign (“re-stack”) teams and goals based on the home and away teams’ perspectives.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1">restacked_shots <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>(</span>
<span id="cb12-2">  clean_shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb12-3">    dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(is_home) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb12-4">    dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">transmute</span>(</span>
<span id="cb12-5">      shot_id,</span>
<span id="cb12-6">      match_id,</span>
<span id="cb12-7">      period,</span>
<span id="cb12-8">      minutes,</span>
<span id="cb12-9">      minutes_added,</span>
<span id="cb12-10">      is_home,</span>
<span id="cb12-11">      is_goal,</span>
<span id="cb12-12">      is_own_goal,</span>
<span id="cb12-13">      player,</span>
<span id="cb12-14">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">team =</span> home_team,</span>
<span id="cb12-15">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">opponent =</span> away_team,</span>
<span id="cb12-16">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">g =</span> home_g,</span>
<span id="cb12-17">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">g_conceded =</span> away_g,</span>
<span id="cb12-18">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xg =</span> home_xg,</span>
<span id="cb12-19">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xg_conceded =</span> away_xg</span>
<span id="cb12-20">    ),</span>
<span id="cb12-21">  clean_shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb12-22">    dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>is_home) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb12-23">    dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">transmute</span>(</span>
<span id="cb12-24">      shot_id,</span>
<span id="cb12-25">      match_id,</span>
<span id="cb12-26">      period,</span>
<span id="cb12-27">      minutes,</span>
<span id="cb12-28">      minutes_added,</span>
<span id="cb12-29">      is_home,</span>
<span id="cb12-30">      is_goal,</span>
<span id="cb12-31">      is_own_goal,</span>
<span id="cb12-32">      player,</span>
<span id="cb12-33">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">team =</span> away_team,</span>
<span id="cb12-34">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">opponent =</span> home_team,</span>
<span id="cb12-35">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">g =</span> away_g,</span>
<span id="cb12-36">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">g_conceded =</span> home_g,</span>
<span id="cb12-37">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xg =</span> away_xg,</span>
<span id="cb12-38">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xg_conceded =</span> home_xg</span>
<span id="cb12-39">    )</span>
<span id="cb12-40">)</span></code></pre></div>
</details>
</div>
<p>Then, we replicate the whole data frame, indicating whether we’re looking at the shot events from a given team’s <strong>p</strong>oint <strong>o</strong>f <strong>v</strong>iew (<code>pov = "primary"</code>) or their opponents’ point of view (<code>"secondary"</code>).</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1">doublecounted_restacked_shots <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>(</span>
<span id="cb13-2">  restacked_shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pov =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'primary'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.before =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb13-3">  restacked_shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb13-4">    <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## re-assign to temporary variable names first, so that way we don't accidentlaly overwrite information</span></span>
<span id="cb13-5">    dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(</span>
<span id="cb13-6">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">team1 =</span> team,</span>
<span id="cb13-7">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">team2 =</span> opponent,</span>
<span id="cb13-8">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">g1 =</span> g,</span>
<span id="cb13-9">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">g2 =</span> g_conceded,</span>
<span id="cb13-10">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xg1 =</span> xg,</span>
<span id="cb13-11">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xg2 =</span> xg_conceded</span>
<span id="cb13-12">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb13-13">    <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## then formally re-assign columns</span></span>
<span id="cb13-14">    dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(</span>
<span id="cb13-15">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">team =</span> team2,</span>
<span id="cb13-16">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">opponent =</span> team1,</span>
<span id="cb13-17">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">g =</span> g2,</span>
<span id="cb13-18">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">g_conceded =</span> g1,</span>
<span id="cb13-19">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xg =</span> xg2,</span>
<span id="cb13-20">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xg_conceded =</span> xg1</span>
<span id="cb13-21">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb13-22">    dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb13-23">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">is_home =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>is_home</span>
<span id="cb13-24">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb13-25">    dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb13-26">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pov =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'secondary'</span>,</span>
<span id="cb13-27">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.before =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb13-28">    )</span>
<span id="cb13-29">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb13-30">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(match_id, shot_id, pov)</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1">dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glimpse</span>(doublecounted_restacked_shots)</span>
<span id="cb14-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; Rows: 30,670</span></span>
<span id="cb14-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; Columns: 16</span></span>
<span id="cb14-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ pov           &lt;chr&gt; "primary", "secondary", "primary", "secondary", "…</span></span>
<span id="cb14-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ shot_id       &lt;chr&gt; "00069d73-01", "00069d73-01", "00069d73-02", "000…</span></span>
<span id="cb14-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ match_id      &lt;chr&gt; "00069d73", "00069d73", "00069d73", "00069d73", "…</span></span>
<span id="cb14-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ period        &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…</span></span>
<span id="cb14-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ minutes       &lt;int&gt; 2, 2, 4, 4, 9, 9, 20, 20, 24, 24, 32, 32, 34, 34,…</span></span>
<span id="cb14-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ minutes_added &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…</span></span>
<span id="cb14-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ is_home       &lt;lgl&gt; TRUE, FALSE, TRUE, FALSE, TRUE, FALSE, TRUE, FALS…</span></span>
<span id="cb14-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ is_goal       &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, …</span></span>
<span id="cb14-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ is_own_goal   &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, …</span></span>
<span id="cb14-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ player        &lt;chr&gt; "Hany Mukhtar", "Hany Mukhtar", "Teal Bunbury", "…</span></span>
<span id="cb14-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ team          &lt;chr&gt; "Nashville SC", "Chicago Fire", "Nashville SC", "…</span></span>
<span id="cb14-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ opponent      &lt;chr&gt; "Chicago Fire", "Nashville SC", "Chicago Fire", "…</span></span>
<span id="cb14-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ g             &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…</span></span>
<span id="cb14-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ g_conceded    &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…</span></span>
<span id="cb14-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ xg            &lt;dbl&gt; 0.04, 0.00, 0.17, 0.00, 0.02, 0.00, 0.12, 0.00, 0…</span></span>
<span id="cb14-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ xg_conceded   &lt;dbl&gt; 0.00, 0.04, 0.00, 0.17, 0.00, 0.02, 0.00, 0.12, 0…</span></span></code></pre></div>
</div>
</section>
<section id="calculating-cumulative-goals" class="level3">
<h3 class="anchored" data-anchor-id="calculating-cumulative-goals">Calculating Cumulative Goals</h3>
<p>Next, we calculate cumulative goals and xG scored and conceded.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1">cumu_doublecounted_restacked_shots <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> doublecounted_restacked_shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb15-2">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(match_id, team) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb15-3">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb15-4">    dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(</span>
<span id="cb15-5">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(g, g_conceded),</span>
<span id="cb15-6">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cumu =</span> cumsum)</span>
<span id="cb15-7">    )</span>
<span id="cb15-8">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb15-9">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb15-10">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb15-11">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gamestate =</span> g_cumu <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> g_conceded_cumu</span>
<span id="cb15-12">  )</span></code></pre></div>
</details>
</div>
<p>And then we bring everything together to create a singular data frame from which it is straightforward to calculate xGD with respect to game state.<sup>3</sup></p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1">ORDERED_gamestate_LABELS <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Trailing'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Tied'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Leading'</span>)</span>
<span id="cb16-2">gamestate_shots <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> cumu_doublecounted_restacked_shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb16-3">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inner_join</span>(</span>
<span id="cb16-4">    match_summaries <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb16-5">      dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">distinct</span>(</span>
<span id="cb16-6">        match_id,</span>
<span id="cb16-7">        season,</span>
<span id="cb16-8">        date,</span>
<span id="cb16-9">        home_team,</span>
<span id="cb16-10">        away_team</span>
<span id="cb16-11">      ),</span>
<span id="cb16-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(match_id)</span>
<span id="cb16-13">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb16-14">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">transmute</span>(</span>
<span id="cb16-15">    pov,</span>
<span id="cb16-16">    match_id,</span>
<span id="cb16-17">    season,</span>
<span id="cb16-18">    date,</span>
<span id="cb16-19">    home_team,</span>
<span id="cb16-20">    away_team,</span>
<span id="cb16-21">    team,</span>
<span id="cb16-22">    player,</span>
<span id="cb16-23">    shot_id,</span>
<span id="cb16-24">    period,</span>
<span id="cb16-25">    minutes,</span>
<span id="cb16-26">    minutes_added,</span>
<span id="cb16-27">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time =</span> minutes <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coalesce</span>(minutes_added, 0L),</span>
<span id="cb16-28">    xg,</span>
<span id="cb16-29">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xgd =</span> xg <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> xg_conceded,</span>
<span id="cb16-30">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gamestate =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cut</span>(</span>
<span id="cb16-31">      gamestate,</span>
<span id="cb16-32">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">breaks =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">Inf</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">Inf</span>),</span>
<span id="cb16-33">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> ORDERED_gamestate_LABELS</span>
<span id="cb16-34">    )</span>
<span id="cb16-35">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb16-36">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(match_id, team) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb16-37">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(shot_id, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.by_group =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb16-38">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb16-39">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pre_shot_gamestate =</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lag</span>(gamestate, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">default =</span> ORDERED_gamestate_LABELS[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])</span>
<span id="cb16-40">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb16-41">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>()</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1">dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glimpse</span>(gamestate_shots)</span>
<span id="cb17-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; Rows: 30,670</span></span>
<span id="cb17-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; Columns: 17</span></span>
<span id="cb17-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ pov                &lt;chr&gt; "secondary", "secondary", "secondary", "seco…</span></span>
<span id="cb17-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ match_id           &lt;chr&gt; "00069d73", "00069d73", "00069d73", "00069d7…</span></span>
<span id="cb17-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ season             &lt;int&gt; 2023, 2023, 2023, 2023, 2023, 2023, 2023, 20…</span></span>
<span id="cb17-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ date               &lt;date&gt; 2023-05-06, 2023-05-06, 2023-05-06, 2023-05…</span></span>
<span id="cb17-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ home_team          &lt;chr&gt; "Nashville SC", "Nashville SC", "Nashville S…</span></span>
<span id="cb17-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ away_team          &lt;chr&gt; "Chicago Fire", "Chicago Fire", "Chicago Fir…</span></span>
<span id="cb17-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ team               &lt;chr&gt; "Chicago Fire", "Chicago Fire", "Chicago Fir…</span></span>
<span id="cb17-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ player             &lt;chr&gt; "Hany Mukhtar", "Teal Bunbury", "Hany Mukhta…</span></span>
<span id="cb17-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ shot_id            &lt;chr&gt; "00069d73-01", "00069d73-02", "00069d73-03",…</span></span>
<span id="cb17-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ period             &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1,…</span></span>
<span id="cb17-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ minutes            &lt;int&gt; 2, 4, 9, 20, 24, 32, 34, 35, 39, 40, 41, 42,…</span></span>
<span id="cb17-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ minutes_added      &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …</span></span>
<span id="cb17-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ time               &lt;dbl&gt; 2, 4, 9, 20, 24, 32, 34, 35, 39, 40, 41, 42,…</span></span>
<span id="cb17-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ xg                 &lt;dbl&gt; 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.…</span></span>
<span id="cb17-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ xgd                &lt;dbl&gt; -0.04, -0.17, -0.02, -0.12, -0.05, -0.08, -0…</span></span>
<span id="cb17-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ gamestate          &lt;fct&gt; Tied, Tied, Tied, Tied, Tied, Tied, Tied, Ti…</span></span>
<span id="cb17-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ pre_shot_gamestate &lt;fct&gt; Tied, Tied, Tied, Tied, Tied, Tied, Tied, Ti…</span></span></code></pre></div>
</div>
</section>
<section id="padding-end-of-match-events" class="level3">
<h3 class="anchored" data-anchor-id="padding-end-of-match-events">Padding end-of-match events</h3>
<p>Oh, wait! We should probably account for the amount of time spent in a game state when contextualizing xGD. To do that properly, we should add more synthetic records for the end of halves.</p>
<p>Unfortunately, FBref does not provide the exact ending minute of each half, as far as I know. Thus, we’ll “pad” our data with artificial records to mark the end of halves–the 45th minute in the first half / 90th minute in the second half–using some heuristics.</p>
<ol type="1">
<li>If there are no shots after the last regular minute in a half, we add 3 minutes. (3 minutes is about the median amount of minutes allocated for extra time.)</li>
<li>If the last shot is after the last regular minute in a half, we take the maximum of:
<ul>
<li>Adding 3 minutes beyond the last regular minute (like (1)) or</li>
<li>Adding one minute beyond the last shot.</li>
</ul></li>
</ol>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1">LAST_MIN_BUFFER <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span></span>
<span id="cb18-2">last_min_pad <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> gamestate_shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb18-3">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(</span>
<span id="cb18-4">    match_id,</span>
<span id="cb18-5">    season,</span>
<span id="cb18-6">    date,</span>
<span id="cb18-7">    team,</span>
<span id="cb18-8">    pre_shot_gamestate,</span>
<span id="cb18-9">    period,</span>
<span id="cb18-10">    time</span>
<span id="cb18-11">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb18-12">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(match_id, team, period) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb18-13">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">slice_max</span>(time, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">with_ties =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb18-14">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb18-15">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb18-16">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xg =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb18-17">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xgd =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb18-18">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">last_regular_min =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(period <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> 1L, 45L, 90L),</span>
<span id="cb18-19">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(last_regular_min <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> LAST_MIN_BUFFER, time <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb18-20">  )</span>
<span id="cb18-21"></span>
<span id="cb18-22">padded_gamestate_shots <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>(</span>
<span id="cb18-23">  gamestate_shots,</span>
<span id="cb18-24">  last_min_pad</span>
<span id="cb18-25">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb18-26">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(match_id, time)</span>
<span id="cb18-27"></span>
<span id="cb18-28">gamestate_shots_and_durations <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> padded_gamestate_shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb18-29">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(match_id, team) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb18-30">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb18-31">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prev_period =</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lag</span>(period),</span>
<span id="cb18-32">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prev_time =</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lag</span>(time)</span>
<span id="cb18-33">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb18-34">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb18-35">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb18-36">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">duration =</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(</span>
<span id="cb18-37">      period <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> 1L <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(prev_period) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> time <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> 0L,</span>
<span id="cb18-38">      period <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> 2L <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> period <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> prev_period <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> time <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> 45L,</span>
<span id="cb18-39">      <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> time <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> prev_time</span>
<span id="cb18-40">    )</span>
<span id="cb18-41">  )</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1">dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glimpse</span>(gamestate_shots_and_durations)</span>
<span id="cb19-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; Rows: 32,642</span></span>
<span id="cb19-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; Columns: 21</span></span>
<span id="cb19-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ pov                &lt;chr&gt; "secondary", "primary", "secondary", "primar…</span></span>
<span id="cb19-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ match_id           &lt;chr&gt; "00069d73", "00069d73", "00069d73", "00069d7…</span></span>
<span id="cb19-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ season             &lt;int&gt; 2023, 2023, 2023, 2023, 2023, 2023, 2023, 20…</span></span>
<span id="cb19-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ date               &lt;date&gt; 2023-05-06, 2023-05-06, 2023-05-06, 2023-05…</span></span>
<span id="cb19-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ home_team          &lt;chr&gt; "Nashville SC", "Nashville SC", "Nashville S…</span></span>
<span id="cb19-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ away_team          &lt;chr&gt; "Chicago Fire", "Chicago Fire", "Chicago Fir…</span></span>
<span id="cb19-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ team               &lt;chr&gt; "Chicago Fire", "Nashville SC", "Chicago Fir…</span></span>
<span id="cb19-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ player             &lt;chr&gt; "Hany Mukhtar", "Hany Mukhtar", "Teal Bunbur…</span></span>
<span id="cb19-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ shot_id            &lt;chr&gt; "00069d73-01", "00069d73-01", "00069d73-02",…</span></span>
<span id="cb19-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ period             &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…</span></span>
<span id="cb19-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ minutes            &lt;int&gt; 2, 2, 4, 4, 9, 9, 20, 20, 24, 24, 32, 32, 34…</span></span>
<span id="cb19-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ minutes_added      &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …</span></span>
<span id="cb19-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ time               &lt;dbl&gt; 2, 2, 4, 4, 9, 9, 20, 20, 24, 24, 32, 32, 34…</span></span>
<span id="cb19-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ xg                 &lt;dbl&gt; 0.00, 0.04, 0.00, 0.17, 0.00, 0.02, 0.00, 0.…</span></span>
<span id="cb19-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ xgd                &lt;dbl&gt; -0.04, 0.04, -0.17, 0.17, -0.02, 0.02, -0.12…</span></span>
<span id="cb19-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ gamestate          &lt;fct&gt; Tied, Tied, Tied, Tied, Tied, Tied, Tied, Ti…</span></span>
<span id="cb19-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ pre_shot_gamestate &lt;fct&gt; Tied, Tied, Tied, Tied, Tied, Tied, Tied, Ti…</span></span>
<span id="cb19-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ last_regular_min   &lt;int&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …</span></span>
<span id="cb19-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ prev_period        &lt;int&gt; NA, NA, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …</span></span>
<span id="cb19-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ prev_time          &lt;dbl&gt; NA, NA, 2, 2, 4, 4, 9, 9, 20, 20, 24, 24, 32…</span></span>
<span id="cb19-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ duration           &lt;dbl&gt; 2, 2, 2, 2, 5, 5, 11, 11, 4, 4, 8, 8, 2, 2, …</span></span></code></pre></div>
</div>
</section>
</section>
<section id="data-analysis" class="level2">
<h2 class="anchored" data-anchor-id="data-analysis">Data analysis</h2>
<p>As the saying goes, “80% of data analysis/science is data cleaning”. Well, that rings true here, as all we need to do at this point is perform a few common <code>{dplyr}</code> and <code>{tidyr}</code> actions to arrive at xGD by game state. Oh, and we should contextualize game state xGD by how long a team has spent in each game state (<code>duration</code>).</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1">agg_gamestate_xgd <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> gamestate_shots_and_durations <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb20-2">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(team, pre_shot_gamestate) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb20-3">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(</span>
<span id="cb20-4">    dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(</span>
<span id="cb20-5">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(</span>
<span id="cb20-6">        xgd,</span>
<span id="cb20-7">        duration</span>
<span id="cb20-8">      ),</span>
<span id="cb20-9">      \(.x) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(.x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb20-10">    )</span>
<span id="cb20-11">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb20-12">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb20-13">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb20-14">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xgd_p90 =</span> xgd <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">90</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> duration</span>
<span id="cb20-15">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb20-16">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(team) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb20-17">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb20-18">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prop_duration =</span> duration <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(duration)</span>
<span id="cb20-19">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb20-20">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb20-21">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(</span>
<span id="cb20-22">    team,</span>
<span id="cb20-23">    pre_shot_gamestate,</span>
<span id="cb20-24">    xgd_p90,</span>
<span id="cb20-25">    prop_duration</span>
<span id="cb20-26">  )</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1">agg_gamestate_xgd</span>
<span id="cb21-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 87 × 4</span></span>
<span id="cb21-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    team           pre_shot_gamestate  xgd_p90 prop_duration</span></span>
<span id="cb21-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    &lt;chr&gt;          &lt;fct&gt;                 &lt;dbl&gt;         &lt;dbl&gt;</span></span>
<span id="cb21-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  1 Atlanta United Trailing            0.277           0.266</span></span>
<span id="cb21-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  2 Atlanta United Tied               -0.00208         0.385</span></span>
<span id="cb21-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  3 Atlanta United Leading             0.262           0.350</span></span>
<span id="cb21-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  4 Austin FC      Trailing            0.0287          0.271</span></span>
<span id="cb21-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  5 Austin FC      Tied               -0.0978          0.508</span></span>
<span id="cb21-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  6 Austin FC      Leading            -0.474           0.221</span></span>
<span id="cb21-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  7 CF Montréal    Trailing           -1.20            0.376</span></span>
<span id="cb21-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  8 CF Montréal    Tied               -0.388           0.400</span></span>
<span id="cb21-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  9 CF Montréal    Leading             0.327           0.223</span></span>
<span id="cb21-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 10 Charlotte FC   Trailing           -0.0656          0.212</span></span>
<span id="cb21-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # ℹ 77 more rows</span></span></code></pre></div>
</div>
<p>We did all that work, so let’s make a pretty graph that conveys both:</p>
<ol type="1">
<li>the proportion of time spent in a given game state, and</li>
<li>the xGD <a href="https://statsbomb.com/articles/soccer/an-introduction-to-the-per-90-metric/">per 90</a> per game state</li>
</ol>
<p>for every team. Keep in mind that an xGD per 90 of +0.50 means that you’re accumulating half a goal’s worth of shot quality more than you’re giving up over the course of a game. While this number may seem small, that’s quite a good number over the course of an entire season.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## logo scraping</span></span>
<span id="cb22-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(httr)</span>
<span id="cb22-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(jsonlite)</span>
<span id="cb22-4"></span>
<span id="cb22-5"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## plotting</span></span>
<span id="cb22-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb22-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(sysfonts)</span>
<span id="cb22-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(showtext)</span>
<span id="cb22-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggtext)</span>
<span id="cb22-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(htmltools)</span>
<span id="cb22-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(grid)</span>
<span id="cb22-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(scales)</span>
<span id="cb22-13"></span>
<span id="cb22-14">TAG_LABEL <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> htmltools<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tagList</span>(</span>
<span id="cb22-15">  htmltools<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>tags<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">span</span>(htmltools<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">HTML</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">enc2utf8</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'&amp;#xf099;'</span>)), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">style =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'font-family:fb'</span>),</span>
<span id="cb22-16">  htmltools<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>tags<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">span</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'@TonyElHabr'</span>),</span>
<span id="cb22-17">)</span>
<span id="cb22-18">CAPTION_LABEL <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'**Data**: Opta via fbref.'</span></span>
<span id="cb22-19">SUBTITLE_LABEL <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'MLS, 2023 Season'</span></span>
<span id="cb22-20">PLOT_RESOLUTION <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span></span>
<span id="cb22-21">WHITISH_FOREGROUND_COLOR <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'white'</span></span>
<span id="cb22-22">COMPLEMENTARY_FOREGROUND_COLOR <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'#cbcbcb'</span></span>
<span id="cb22-23">BLACKISH_BACKGROUND_COLOR <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'#1c1c1c'</span></span>
<span id="cb22-24">COMPLEMENTARY_BACKGROUND_COLOR <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'#4d4d4d'</span></span>
<span id="cb22-25">FONT <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Titillium Web'</span></span>
<span id="cb22-26">sysfonts<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">font_add_google</span>(FONT, FONT)</span>
<span id="cb22-27"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## https://github.com/tashapiro/tanya-data-viz/blob/main/chatgpt-lensa/chatgpt-lensa.R for twitter logo</span></span>
<span id="cb22-28">sysfonts<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">font_add</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fb'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Font Awesome 6 Brands-Regular-400.otf'</span>)</span>
<span id="cb22-29">showtext<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">showtext_auto</span>()</span>
<span id="cb22-30">showtext<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">showtext_opts</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dpi =</span> PLOT_RESOLUTION)</span>
<span id="cb22-31"></span>
<span id="cb22-32">ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_set</span>(ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>())</span>
<span id="cb22-33">ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_update</span>(</span>
<span id="cb22-34">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">text =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> FONT),</span>
<span id="cb22-35">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> WHITISH_FOREGROUND_COLOR),</span>
<span id="cb22-36">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.title =</span> ggtext<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_markdown</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bold'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> WHITISH_FOREGROUND_COLOR),</span>
<span id="cb22-37">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.title.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'plot'</span>,</span>
<span id="cb22-38">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.subtitle =</span> ggtext<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_markdown</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> COMPLEMENTARY_FOREGROUND_COLOR),</span>
<span id="cb22-39">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> WHITISH_FOREGROUND_COLOR, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>),</span>
<span id="cb22-40">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.title.x =</span> ggtext<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_markdown</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> WHITISH_FOREGROUND_COLOR, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bold'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.99</span>),</span>
<span id="cb22-41">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.title.y =</span> ggtext<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_markdown</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> WHITISH_FOREGROUND_COLOR, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bold'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.99</span>),</span>
<span id="cb22-42">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.line =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb22-43">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">strip.text =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> WHITISH_FOREGROUND_COLOR, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bold'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>),</span>
<span id="cb22-44">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'top'</span>,</span>
<span id="cb22-45">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.text =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> WHITISH_FOREGROUND_COLOR, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'plain'</span>),</span>
<span id="cb22-46">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.title =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> WHITISH_FOREGROUND_COLOR, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bold'</span>),</span>
<span id="cb22-47">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid.major =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_line</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> COMPLEMENTARY_BACKGROUND_COLOR),</span>
<span id="cb22-48">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid.minor =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_line</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> COMPLEMENTARY_BACKGROUND_COLOR),</span>
<span id="cb22-49">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid.minor.x =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb22-50">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid.minor.y =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb22-51">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.margin =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">margin</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>),</span>
<span id="cb22-52">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.background =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_rect</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> BLACKISH_BACKGROUND_COLOR, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> BLACKISH_BACKGROUND_COLOR),</span>
<span id="cb22-53">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.caption =</span> ggtext<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_markdown</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> WHITISH_FOREGROUND_COLOR, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'plain'</span>),</span>
<span id="cb22-54">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.caption.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'plot'</span>,</span>
<span id="cb22-55">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.tag =</span> ggtext<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_markdown</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> WHITISH_FOREGROUND_COLOR, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb22-56">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.tag.position =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.99</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>),</span>
<span id="cb22-57">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.spacing.x =</span> grid<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'lines'</span>),</span>
<span id="cb22-58">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.background =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_rect</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> BLACKISH_BACKGROUND_COLOR, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> BLACKISH_BACKGROUND_COLOR)</span>
<span id="cb22-59">)</span>
<span id="cb22-60">ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update_geom_defaults</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'text'</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> WHITISH_FOREGROUND_COLOR, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> .pt))</span>
<span id="cb22-61"></span>
<span id="cb22-62">GAMESTATE_PAL <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(</span>
<span id="cb22-63">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Trailing'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'#ef3e36'</span>,</span>
<span id="cb22-64">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Tied'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> COMPLEMENTARY_FOREGROUND_COLOR,</span>
<span id="cb22-65">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Leading'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'#17bebb'</span></span>
<span id="cb22-66">)</span>
<span id="cb22-67"></span>
<span id="cb22-68"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## There is a way to get team logos from FBref, but they have a white background </span></span>
<span id="cb22-69"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   by default, and making the background transparent for a plot with a dark</span></span>
<span id="cb22-70"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   background is kind of a pain in the ass. So let's pull images from fotmob.</span></span>
<span id="cb22-71"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## This function is basically a minified version of what used to exist as</span></span>
<span id="cb22-72"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   worldfootballR::fotmob_get_league_tables(). I rely on FBref and fotmob listing</span></span>
<span id="cb22-73"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   teams in the same order alphabetically, which works fine for the MLS. A</span></span>
<span id="cb22-74"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   better, scalable strategy for binding team names between sources is to</span></span>
<span id="cb22-75"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   order teams by points / placement in the standings.</span></span>
<span id="cb22-76"></span>
<span id="cb22-77">get_fotmob_standings <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>() {</span>
<span id="cb22-78">  url <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'https://www.fotmob.com/api/leagues?id=130'</span></span>
<span id="cb22-79">  resp <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> httr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">GET</span>(url)</span>
<span id="cb22-80">  cont <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> httr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">content</span>(resp, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">as =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'text'</span>)</span>
<span id="cb22-81">  result <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> jsonlite<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fromJSON</span>(cont)</span>
<span id="cb22-82">  table_init <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> result<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>table<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>data</span>
<span id="cb22-83">  tables <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>(table_init<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>tables)</span>
<span id="cb22-84">  tables<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>table<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>all[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb22-85">    dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">transmute</span>(</span>
<span id="cb22-86">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">team =</span> name,</span>
<span id="cb22-87">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">team_id =</span> id,</span>
<span id="cb22-88">      pts,</span>
<span id="cb22-89">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">logo_url =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sprintf</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'https://images.fotmob.com/image_resources/logo/teamlogo/%s.png'</span>, team_id)</span>
<span id="cb22-90">    )</span>
<span id="cb22-91">}</span>
<span id="cb22-92"></span>
<span id="cb22-93">fotmob_standings <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_fotmob_standings</span>()</span>
<span id="cb22-94">team_logos <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> agg_gamestate_xgd <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb22-95">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">distinct</span>(team) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb22-96">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(team) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb22-97">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Lucky for us, MLS team names line up with the fotmob names alphabetically.</span></span>
<span id="cb22-98">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_cols</span>(</span>
<span id="cb22-99">    fotmob_standings <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb22-100">      dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(team) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb22-101">      dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">path =</span> logo_url, pts)</span>
<span id="cb22-102">  )</span>
<span id="cb22-103"></span>
<span id="cb22-104">agg_gamestate_xgd_with_logos <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> agg_gamestate_xgd <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb22-105">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inner_join</span>(</span>
<span id="cb22-106">    team_logos <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb22-107">      dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(</span>
<span id="cb22-108">        team,</span>
<span id="cb22-109">        pts,</span>
<span id="cb22-110">        path</span>
<span id="cb22-111">      ),</span>
<span id="cb22-112">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(team)</span>
<span id="cb22-113">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb22-114">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb22-115">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> glue<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glue</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&lt;span style='font-size:12px;color:{WHITISH_FOREGROUND_COLOR}'&gt;{team}&lt;/span&gt; &lt;span style='font-size:9px;color:{COMPLEMENTARY_FOREGROUND_COLOR}'&gt;{pts} pts&lt;/span&gt; &lt;img src='{path}' width='14' height='14'/&gt;"</span>)</span>
<span id="cb22-116">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb22-117">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>path)</span>
<span id="cb22-118"></span>
<span id="cb22-119">team_label_order <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> agg_gamestate_xgd_with_logos <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb22-120">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(</span>
<span id="cb22-121">    pre_shot_gamestate <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Leading'</span></span>
<span id="cb22-122">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb22-123">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(prop_duration) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb22-124">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pull</span>(team)</span>
<span id="cb22-125"></span>
<span id="cb22-126">prepped_agg_gamestate_xgd <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> agg_gamestate_xgd_with_logos <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb22-127">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb22-128">    dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(</span>
<span id="cb22-129">      team,</span>
<span id="cb22-130">      \(.x) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(.x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels =</span> team_label_order)</span>
<span id="cb22-131">    )</span>
<span id="cb22-132">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb22-133">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(team, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">desc</span>(pre_shot_gamestate)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb22-134">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(team) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb22-135">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb22-136">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cumu_prop_duration =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cumsum</span>(prop_duration)</span>
<span id="cb22-137">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb22-138">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb22-139">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb22-140">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">half_cumu_prop_duration =</span> cumu_prop_duration <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> prop_duration</span>
<span id="cb22-141">  )</span>
<span id="cb22-142"></span>
<span id="cb22-143">xgd_p90_plot <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> prepped_agg_gamestate_xgd <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb22-144">  ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb22-145">  ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(</span>
<span id="cb22-146">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> prop_duration,</span>
<span id="cb22-147">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> team</span>
<span id="cb22-148">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb22-149">  ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_y_discrete</span>(</span>
<span id="cb22-150">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>,</span>
<span id="cb22-151">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> prepped_agg_gamestate_xgd <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb22-152">      dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">distinct</span>(team, label) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb22-153">      tibble<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">deframe</span>()</span>
<span id="cb22-154">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb22-155">  ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(</span>
<span id="cb22-156">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.y =</span> ggtext<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_markdown</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">margin =</span> grid<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'pt'</span>)),</span>
<span id="cb22-157">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb22-158">  ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_col</span>(</span>
<span id="cb22-159">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">show.legend =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>,</span>
<span id="cb22-160">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>,</span>
<span id="cb22-161">    ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(</span>
<span id="cb22-162">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> pre_shot_gamestate</span>
<span id="cb22-163">    )</span>
<span id="cb22-164">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb22-165">  ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_text</span>(</span>
<span id="cb22-166">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> FONT,</span>
<span id="cb22-167">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>.pt,</span>
<span id="cb22-168">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fontface =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bold'</span>,</span>
<span id="cb22-169">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> WHITISH_FOREGROUND_COLOR,</span>
<span id="cb22-170">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(prepped_agg_gamestate_xgd, xgd_p90 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>),</span>
<span id="cb22-171">    ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(</span>
<span id="cb22-172">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> half_cumu_prop_duration,</span>
<span id="cb22-173">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> team,</span>
<span id="cb22-174">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> scales<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">number</span>(xgd_p90, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">accuracy =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">style_positive =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'plus'</span>)</span>
<span id="cb22-175">    )</span>
<span id="cb22-176">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb22-177">  ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_text</span>(</span>
<span id="cb22-178">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> FONT,</span>
<span id="cb22-179">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>.pt,</span>
<span id="cb22-180">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fontface =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bold.italic'</span>,</span>
<span id="cb22-181">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> BLACKISH_BACKGROUND_COLOR,</span>
<span id="cb22-182">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(prepped_agg_gamestate_xgd, xgd_p90 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>),</span>
<span id="cb22-183">    ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(</span>
<span id="cb22-184">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> half_cumu_prop_duration,</span>
<span id="cb22-185">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> team,</span>
<span id="cb22-186">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> scales<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">number</span>(xgd_p90, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">accuracy =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>)</span>
<span id="cb22-187">    )</span>
<span id="cb22-188">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb22-189">  ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(</span>
<span id="cb22-190">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> scales<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">percent_format</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">accuracy =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb22-191">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">expand =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>)</span>
<span id="cb22-192">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb22-193">  ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(</span>
<span id="cb22-194">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> GAMESTATE_PAL</span>
<span id="cb22-195">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb22-196">  ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(</span>
<span id="cb22-197">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid.major.y =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb22-198">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid.major.x =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb22-199">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'top'</span></span>
<span id="cb22-200">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb22-201">  ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(</span>
<span id="cb22-202">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> glue<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glue</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"xGD per 90 when &lt;span style='color:{GAMESTATE_PAL[['Leading']]}'&gt;Leading&lt;/span&gt;, &lt;span style='color:{GAMESTATE_PAL[['Tied']]}'&gt;Tied&lt;/span&gt;, and &lt;span style='color:{GAMESTATE_PAL[['Trailing']]}'&gt;Trailing&lt;/spna&gt;"</span>),</span>
<span id="cb22-203">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle =</span> SUBTITLE_LABEL,</span>
<span id="cb22-204">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb22-205">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tag =</span> TAG_LABEL,</span>
<span id="cb22-206">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">caption =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(CAPTION_LABEL, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'&lt;br/&gt;**xGD**: Expected goals for minus expected goals conceded'</span>),</span>
<span id="cb22-207">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'% of Match Time'</span></span>
<span id="cb22-208">  )</span>
<span id="cb22-209">xgd_p90_plot</span>
<span id="cb22-210"></span>
<span id="cb22-211">xgd_p90_plot_path <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(PROJ_DIR, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'2023-mls-xgd-p90.png'</span>)</span>
<span id="cb22-212">ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(</span>
<span id="cb22-213">  xgd_p90_plot,</span>
<span id="cb22-214">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">filename =</span> xgd_p90_plot_path,</span>
<span id="cb22-215">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,</span>
<span id="cb22-216">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span></span>
<span id="cb22-217">)</span>
<span id="cb22-218"></span>
<span id="cb22-219"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## https://themockup.blog/posts/2019-01-09-add-a-logo-to-your-plot/</span></span>
<span id="cb22-220">add_logo <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(</span>
<span id="cb22-221">    plot_path,</span>
<span id="cb22-222">    logo_path,</span>
<span id="cb22-223">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">logo_scale =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>,</span>
<span id="cb22-224">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">idx_x =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>, <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## right-hand side</span></span>
<span id="cb22-225">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">idx_y =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.99</span>, <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## top of plot</span></span>
<span id="cb22-226">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">adjust_x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(idx_x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>),</span>
<span id="cb22-227">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">adjust_y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(idx_y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span>
<span id="cb22-228">) {</span>
<span id="cb22-229">  plot <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> magick<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">image_read</span>(plot_path)</span>
<span id="cb22-230">  logo_raw <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> magick<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">image_read</span>(logo_path)</span>
<span id="cb22-231">  </span>
<span id="cb22-232">  plot_height <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> magick<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">image_info</span>(plot)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>height</span>
<span id="cb22-233">  plot_width <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> magick<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">image_info</span>(plot)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>width</span>
<span id="cb22-234">  </span>
<span id="cb22-235">  logo <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> magick<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">image_scale</span>(</span>
<span id="cb22-236">    logo_raw,</span>
<span id="cb22-237">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.character</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(plot_width <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> logo_scale))</span>
<span id="cb22-238">  )</span>
<span id="cb22-239">  </span>
<span id="cb22-240">  info <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> magick<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">image_info</span>(logo)</span>
<span id="cb22-241">  logo_width <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> info<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>width</span>
<span id="cb22-242">  logo_height <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> info<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>height</span>
<span id="cb22-243">  </span>
<span id="cb22-244">  x_pos <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> plot_width <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> idx_x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> plot_width</span>
<span id="cb22-245">  y_pos <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> plot_height <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> idx_y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> plot_height</span>
<span id="cb22-246">  </span>
<span id="cb22-247">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">isTRUE</span>(adjust_x)) {</span>
<span id="cb22-248">    x_pos <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> x_pos <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> logo_width</span>
<span id="cb22-249">  }</span>
<span id="cb22-250">  </span>
<span id="cb22-251">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">isTRUE</span>(adjust_y)) {</span>
<span id="cb22-252">    y_pos <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> y_pos <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> logo_height</span>
<span id="cb22-253">  }</span>
<span id="cb22-254">  </span>
<span id="cb22-255">  offset <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'+'</span>, x_pos, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'+'</span>, y_pos)</span>
<span id="cb22-256">  </span>
<span id="cb22-257">  new_plot <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> magick<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">image_composite</span>(plot, logo, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">offset =</span> offset)</span>
<span id="cb22-258">  ext <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> tools<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file_ext</span>(plot_path)</span>
<span id="cb22-259">  rgx_ext <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sprintf</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'[.]%s$'</span>, ext)</span>
<span id="cb22-260">  </span>
<span id="cb22-261">  magick<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">image_write</span>(</span>
<span id="cb22-262">    new_plot,</span>
<span id="cb22-263">    plot_path</span>
<span id="cb22-264">  )</span>
<span id="cb22-265">}</span>
<span id="cb22-266"></span>
<span id="cb22-267"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_logo</span>(</span>
<span id="cb22-268">  xgd_p90_plot_path,</span>
<span id="cb22-269">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">logo_path =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(PROJ_DIR, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'mls-logo-black-and-white.png'</span>),</span>
<span id="cb22-270">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">logo_scale =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.06</span></span>
<span id="cb22-271">)</span></code></pre></div>
</details>
</div>
<p><img src="https://tonyelhabr.rbind.io/posts/fbref-gamestate-expected-goal-difference/2023-mls-xgd-p90.png" class="img-fluid"></p>
<p>So, what can we learn from this perspective?</p>
<ol type="1">
<li><a href="https://en.wikipedia.org/wiki/Columbus_Crew">Columbus</a>, who <a href="https://www.fotmob.com/leagues/130/table/mls?season=2023">finished</a> with the third most points, looks to be the most dominant team all-around. They have the most time spent leading (43%) and are one of only three teams with a positive xGD rate in every game state.</li>
<li><a href="https://en.wikipedia.org/wiki/FC_Cincinnati">Cincinnati</a>–the team that ended up with the most points in the regular season–is 11th in terms of time spent leading (30%). On the other hand, they do have the best xGD per 90 rate (+0.60) out of all teams in neutral (“Tied”) game states, which is the most common game state on average.</li>
<li><a href="https://en.wikipedia.org/wiki/Orlando_City_SC">Orlando City</a>, who finished with the second most points, has a relatively poor xGD rate in neutral game states (-0.21). This may be something to be concerned about it in the playoffs, where matches can be tighter.</li>
<li><a href="https://en.wikipedia.org/wiki/Sporting_Kansas_City">Sporting KC</a> has the fourth-most time spent leading (35%) and one of the better xGD rates when leading (+0.40), but ended up 8th in the Western Conference after accumulating just the 16th most points across all 29 teams. They could be a team to watch out for in the playoffs if they can get a lead early in their matches.</li>
<li><a href="https://en.wikipedia.org/wiki/New_York_Red_Bulls">New York Red Bulls</a> squeaked into the playoffs, but have a really strong xGD rate (+0.98) when tied. They may be a team to look out to overperform their seeding.</li>
<li><a href="https://en.wikipedia.org/wiki/Los_Angeles_FC">Los Anegeles FC</a>, like Columbus, is one of the only teams to have a positive xGD in all game states. In fact, they have the strongest xGD in positive game states (+0.97). Evidently, they look to continue to attack once they get a lead.</li>
<li><a href="https://en.wikipedia.org/wiki/St._Louis_City_SC">St.&nbsp;Louis City</a>, as analytics folks will tell you, has overperformed in its inaugural season. While they finished with the most points in the Western Conference, the underlying numbers–the negative xGD in all game states–suggest that they could be in for a rude awakening in the playoffs.</li>
</ol>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>As we’ve seen, calculating stats with respect to game state using data from the biggest public provider of soccer info is… not exactly straightforward. But the additional layers of insights that we can glean from contextualizing with game state can be rewarding.</p>



</section>


<div class="quarto-listing quarto-listing-container-default" id="listing-listing">
<div class="list quarto-listing-default">

</div>
<div class="listing-no-matching d-none">
No matching items
</div>
</div><div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>I like xGD because it captures a lot of information about how your team is playing relative to your opponent. Your team could be putting up a lot of shots, each with a decent amount of xG (i.e.&nbsp;“shot quality”), but if you’re conceding even more shots than you’ve taken and/or the quality of those shots are better than yours, then you’re really not performing all that well. This would be reflected with a negative xGD. Respected analysts like <a href="https://twitter.com/MC_of_A">Michael Caley</a> also seem to like <a href="https://twitter.com/MC_of_A/status/1716474802259574848">using xGD</a> for diagnosing performance.↩︎</p></li>
<li id="fn2"><p>All code is intentionally hidden by default in this post, but can easily be viewed via toggles. There’s a decent amount of it, and it can be distracting upon first read.↩︎</p></li>
<li id="fn3"><p>Keep in mind that the xG associated with a shot that is scored and changes the game state should be associated with the pre-shot game state, not the post-shot game state.↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>r</category>
  <category>soccer</category>
  <guid>https://tonyelhabr.rbind.io/posts/fbref-gamestate-expected-goal-difference/index.html</guid>
  <pubDate>Wed, 25 Oct 2023 05:00:00 GMT</pubDate>
  <media:content url="https://tonyelhabr.rbind.io/posts/fbref-gamestate-expected-goal-difference/2023-mls-xgd-p90.png" medium="image" type="image/png" height="144" width="144"/>
</item>
<item>
  <title>Calibrating Binary Probabilities</title>
  <dc:creator>Tony ElHabr</dc:creator>
  <link>https://tonyelhabr.rbind.io/posts/probability-calibration/index.html</link>
  <description><![CDATA[ 



<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>Ever grappled with a <a href="https://en.wikipedia.org/wiki/Statistical_classification">classification</a> model that consistently over-predicts or under-predicts an event? Your first thought might be to re-evaluate the model’s features or framework. But what if tweaking the model isn’t an option, either due to a lack of resources or access restrictions? The good news is, there’s another way–it’s called <a href="https://www.tidyverse.org/blog/2022/11/model-calibration/"><strong>calibration</strong></a>.</p>
<p>Calibration falls in the “post-processing” step of predictive modeling.<sup>1</sup> We modify the output of a model using nothing but the model predictions and labels of the output. We do that by, you guess it, fitting another model, often called <a href="https://scikit-learn.org/stable/modules/calibration.html#calibrating-a-classifier">a “calibrator”</a>.</p>
<blockquote class="blockquote">
<ul>
<li>the pre-processing stage (e.g., feature engineering, normalization, etc.)</li>
<li>model fitting (actually training the model)</li>
<li>post-processing (such as optimizing a probability threshold)</li>
</ul>
</blockquote>
<p>One of my favorite (and relatively new) packages in the <a href="https://www.tidymodels.org/"><code>{tidymodels}</code> ecosystem</a> is the <a href="https://probably.tidymodels.org/"><code>{probably}</code></a> package. It provides functions that make it fairly straightforward to do calibration, even for those who are new to the concept. So let’s use <code>{probably}</code> to demonstrate the power of calibration.</p>
</section>
<section id="calibrating-a-binary-classifier" class="level2">
<h2 class="anchored" data-anchor-id="calibrating-a-binary-classifier">Calibrating a Binary Classifier</h2>
<section id="data" class="level3">
<h3 class="anchored" data-anchor-id="data">Data</h3>
<p>I’ll be using the pre-match win probabilities from <a href="https://data.fivethirtyeight.com/#soccer-spi">FiveThirtyEight</a> (<a href="https://twitter.com/ryanabest/status/1672013407908667392">RIP</a>). Specifically, I’ll subset their plethora of historical projections to two women’s leagues: the <a href="https://en.wikipedia.org/wiki/Women%27s_Super_League">Women’s Super League (WSL)</a> in England and the <a href="https://en.wikipedia.org/wiki/National_Women%27s_Soccer_League">National Women’s Soccer League (NWSL)</a> in the U.S. I have a suspicion that the model probabilities are not as calibrated as they could be, as <a href="https://statsbomb.com/articles/soccer/analytics-and-modelling-in-womens-football/">has been observed that gender-agnostic models</a> in soccer can be less performant for the women’s game.</p>
<p>To keep things simple, I’m going to treat this as a <a href="https://en.wikipedia.org/wiki/Binary_classification">binary classification</a> task, where matches are the “positive” outcome (<code>"yes"</code>), and losses and draws are grouped as the “negative” outcome (<code>"no"</code>).</p>
<div class="cell">
<details>
<summary>Retrieve data</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(readr)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)</span>
<span id="cb1-3">matches <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> readr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_csv</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'https://projects.fivethirtyeight.com/soccer-api/club/spi_matches.csv'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-4">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(</span>
<span id="cb1-5">    <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(score1), <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## match is completed</span></span>
<span id="cb1-6">    league <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(</span>
<span id="cb1-7">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"FA Women's Super League"</span>,</span>
<span id="cb1-8">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"National Women's Soccer League"</span></span>
<span id="cb1-9">    )</span>
<span id="cb1-10">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-11">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">transmute</span>(</span>
<span id="cb1-12">    league,</span>
<span id="cb1-13">    season,</span>
<span id="cb1-14">    date,</span>
<span id="cb1-15">    team1,</span>
<span id="cb1-16">    team2,</span>
<span id="cb1-17">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">target =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(score1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> score2, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'yes'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'no'</span>)),</span>
<span id="cb1-18">    <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## .pred_ is sort of a convention among {tidymodels} docs</span></span>
<span id="cb1-19">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.pred_yes =</span> prob1,</span>
<span id="cb1-20">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.pred_no =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> .pred_yes </span>
<span id="cb1-21">  )</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">matches</span>
<span id="cb2-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 1,358 × 6</span></span>
<span id="cb2-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    date       team1               team2             target .pred_yes .pred_no</span></span>
<span id="cb2-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    &lt;date&gt;     &lt;chr&gt;               &lt;chr&gt;             &lt;fct&gt;      &lt;dbl&gt;    &lt;dbl&gt;</span></span>
<span id="cb2-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  1 2016-07-09 Liverpool Women     Reading           yes        0.439    0.561</span></span>
<span id="cb2-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  2 2016-07-10 Arsenal Women       Notts County Lad… yes        0.357    0.643</span></span>
<span id="cb2-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  3 2016-07-10 Chelsea FC Women    Birmingham City   no         0.480    0.520</span></span>
<span id="cb2-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  4 2016-07-16 Liverpool Women     Notts County Lad… no         0.429    0.571</span></span>
<span id="cb2-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  5 2016-07-17 Chelsea FC Women    Arsenal Women     no         0.412    0.588</span></span>
<span id="cb2-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  6 2016-07-24 Reading             Birmingham City   no         0.382    0.618</span></span>
<span id="cb2-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  7 2016-07-24 Notts County Ladies Manchester City … no         0.308    0.692</span></span>
<span id="cb2-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  8 2016-07-31 Reading             Notts County Lad… no         0.407    0.593</span></span>
<span id="cb2-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  9 2016-07-31 Arsenal Women       Liverpool Women   no         0.435    0.565</span></span>
<span id="cb2-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 10 2016-08-03 Reading             Manchester City … no         0.306    0.694</span></span>
<span id="cb2-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # ℹ 1,348 more rows</span></span></code></pre></div>
</div>
</section>
<section id="diagnosis" class="level3">
<h3 class="anchored" data-anchor-id="diagnosis">Diagnosis</h3>
<p>We start with the <a href="https://www.tidymodels.org/learn/models/calibration/#but-is-it-calibrated">“diagnosis”</a> phase: “How well do the original probabilities perform?” To evaluate this, we can use one of the several <code>probably::cal_plot_*</code> functions. In this case, we’ll use <code>cal_plot_breaks()</code>.<sup>2</sup></p>
<p>This function neatly divides the range of predicted probabilities from zero to one into distinct bins. For each bin, it calculates the observed event rate using data that has probabilities falling within that bin’s range. Ideally, if our predictions are calibrated, the curve produced should match up with a straight diagonal line, i.e.&nbsp;a 45-degree slope passing through (0,0) and (1,1). As a bonus, the <code>probably::cal_plot_*</code> family of functions even provides confidence intervals about the calibration curve.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(probably)</span>
<span id="cb3-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">packageVersion</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'probably'</span>)</span>
<span id="cb3-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [1] ‘1.0.1.9000’</span></span>
<span id="cb3-4"></span>
<span id="cb3-5">matches <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-6">  probably<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cal_plot_breaks</span>(</span>
<span id="cb3-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">truth =</span> target,</span>
<span id="cb3-8">    <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## the "_yes" in `.pred_yes` must match one of the values in `target`</span></span>
<span id="cb3-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">estimate =</span> .pred_yes,</span>
<span id="cb3-10">    <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## because "yes" is the second event level ("no" is the first)</span></span>
<span id="cb3-11">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">event_level =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'second'</span></span>
<span id="cb3-12">  )</span></code></pre></div>
</div>
<p><code>{probably}</code> offers some really neat automatic plotting of calibration curves. While I’d suggest giving them a try, I like to make my curves in a certain manner. In particular, instead of using a “rug”, I like showing sample sizes via points on the curve.</p>
<p><img src="https://tonyelhabr.rbind.io/posts/probability-calibration/raw-calibration.png" class="img-fluid"></p>
<p>Indeed, it looks like there is some room for improvement with the match probabilities. It seems that the <a href="https://fivethirtyeight.com/">FiveThirtyEight</a> model over-predicts when the actual win rate is low, broadly below 20%; and, likewise, it tends to under-predict when the true win rate is really greater than 60%</p>
</section>
<section id="remediation" class="level3">
<h3 class="anchored" data-anchor-id="remediation">Remediation</h3>
<p>Now we move on to the <a href="https://www.tidymodels.org/learn/models/calibration/#remediation">“remedation”</a> step. That is, we fit a model, a “calibrator”, with the binary outcome as the target variable and the probability estimate as the lone input feature. <code>{probably}</code> offers several options with <a href="https://probably.tidymodels.org/reference/index.html#calibration-validation">the <code>cal_estimate_*()</code> set of functions</a>.</p>
<p>I’ve opted for <a href="https://probably.tidymodels.org/reference/cal_estimate_beta.html">Beta calibration</a>, although <a href="https://probably.tidymodels.org/reference/cal_estimate_logistic.html">logistic calibration</a> would work fine here as well. Beta calibration is a little more flexible, and, consequently, <a href="https://projecteuclid.org/journals/electronic-journal-of-statistics/volume-11/issue-2/Beyond-sigmoids--How-to-obtain-well-calibrated-probabilities-from/10.1214/17-EJS1338SI.full">can provide superior probability estimates</a>, especially when the target distribution is skewed.<sup>3</sup></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">matches <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb4-2">  probably<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cal_estimate_beta</span>(</span>
<span id="cb4-3">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">truth =</span> target,</span>
<span id="cb4-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">estimate =</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">starts_with</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.pred'</span>),</span>
<span id="cb4-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">event_level =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'second'</span></span>
<span id="cb4-6">  )</span>
<span id="cb4-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  ── Probability Calibration </span></span>
<span id="cb4-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  Method: Beta calibration</span></span>
<span id="cb4-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  Type: Binary</span></span>
<span id="cb4-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  Source class: Data Frame</span></span>
<span id="cb4-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  Data points: 1,358</span></span>
<span id="cb4-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  Truth variable: `target`</span></span>
<span id="cb4-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  Estimate variables:</span></span>
<span id="cb4-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  `.pred_no` ==&gt; no</span></span>
<span id="cb4-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  .pred_yes` ==&gt; yes</span></span></code></pre></div>
</div>
<p>Under the hood, <code>cal_estimate_beta()</code> is doing something like this.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(betacal)</span>
<span id="cb5-2"></span>
<span id="cb5-3">betacal<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">beta_calibration</span>(</span>
<span id="cb5-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">p =</span> matches<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>.pred_yes,</span>
<span id="cb5-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> matches<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>target <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'yes'</span>,</span>
<span id="cb5-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">parameters =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'abm'</span></span>
<span id="cb5-7">)</span></code></pre></div>
</div>
<p>It’s almost shocking how simple the implementation is.</p>
</section>
</section>
<section id="results" class="level2">
<h2 class="anchored" data-anchor-id="results">Results</h2>
<p>With the calibrator model in hand, let’s make a scatter plot of all the points in the data set, viewing how the model has adjusted the original probabilities.</p>
<p><img src="https://tonyelhabr.rbind.io/posts/probability-calibration/calibration-scatter.png" class="img-fluid"></p>
<p>We observe that the calibrator has increased point estimates on the lower end of the spectrum and decreased estimates on the upper end of the spectrum. The calibration has seemingly fine-tuned under-predicting and over-predicting behavior from the original model.</p>
<p>To see the change that calibrator has made, we can re-make our calibration curve plot, adding the “calibrated” curve alongside the original “un-calibrated” curve.</p>
<p><img src="https://tonyelhabr.rbind.io/posts/probability-calibration/compared-calibration.png" class="img-fluid"></p>
<p>Visually, it’s evident that the remediation has improved the probability estimates. The calibrated curve more closely “hugs” the ideal 45 degree slope across the whole probability spectrum.</p>
<section id="validation" class="level3">
<h3 class="anchored" data-anchor-id="validation">Validation</h3>
<p>To quantitatively describe the difference in calibration between the two models, we can compare the <a href="https://en.wikipedia.org/wiki/Brier_score#Brier_Skill_Score_(BSS)">Brier Skill Score (BSS)</a> of the un-calibrated and calibrated models.<sup>4</sup> Keep in mind that a higher BSS indicates a more calibrated model. (1 is ideal. 0 indicates that the model is no better or worse than a reference model<sup>5</sup>.)</p>
<div class="cell">
<details>
<summary>Brier Skill Score (BSS) calculation</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(yardstick)</span>
<span id="cb6-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(rlang)</span>
<span id="cb6-3"></span>
<span id="cb6-4">brier_skill_score <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(data, ...) {</span>
<span id="cb6-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">UseMethod</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'brier_skill_score'</span>)</span>
<span id="cb6-6">}</span>
<span id="cb6-7"></span>
<span id="cb6-8">brier_skill_score <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> yardstick<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">new_prob_metric</span>(</span>
<span id="cb6-9">  brier_skill_score, </span>
<span id="cb6-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">direction =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'maximize'</span></span>
<span id="cb6-11">)</span>
<span id="cb6-12"></span>
<span id="cb6-13">bss <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(</span>
<span id="cb6-14">    truth, </span>
<span id="cb6-15">    estimate, </span>
<span id="cb6-16">    ref_estimate, </span>
<span id="cb6-17">    event_level,</span>
<span id="cb6-18">    case_weights,</span>
<span id="cb6-19">    ...</span>
<span id="cb6-20">) {</span>
<span id="cb6-21">    </span>
<span id="cb6-22">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(estimate) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) {</span>
<span id="cb6-23">    estimate <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(estimate, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(truth))</span>
<span id="cb6-24">  }</span>
<span id="cb6-25">  </span>
<span id="cb6-26">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(ref_estimate) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) {</span>
<span id="cb6-27">    ref_estimate <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(ref_estimate, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(truth))</span>
<span id="cb6-28">  }</span>
<span id="cb6-29">  </span>
<span id="cb6-30">  estimate_brier_score <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brier_class_vec</span>(</span>
<span id="cb6-31">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">truth =</span> truth,</span>
<span id="cb6-32">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">estimate =</span> estimate,</span>
<span id="cb6-33">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">event_level =</span> event_level,</span>
<span id="cb6-34">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">case_weights =</span> case_weights,</span>
<span id="cb6-35">    ...</span>
<span id="cb6-36">  )</span>
<span id="cb6-37">  </span>
<span id="cb6-38">  ref_brier_score <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brier_class_vec</span>(</span>
<span id="cb6-39">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">truth =</span> truth,</span>
<span id="cb6-40">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">estimate =</span> ref_estimate,</span>
<span id="cb6-41">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">event_level =</span> event_level,</span>
<span id="cb6-42">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">case_weights =</span> case_weights,</span>
<span id="cb6-43">    ...</span>
<span id="cb6-44">  )</span>
<span id="cb6-45">  </span>
<span id="cb6-46">  <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> (estimate_brier_score <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> ref_brier_score)</span>
<span id="cb6-47">}</span>
<span id="cb6-48"></span>
<span id="cb6-49">brier_skill_score_estimator_impl <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(</span>
<span id="cb6-50">    truth, </span>
<span id="cb6-51">    estimate, </span>
<span id="cb6-52">    ref_estimate, </span>
<span id="cb6-53">    event_level,</span>
<span id="cb6-54">    case_weights</span>
<span id="cb6-55">) {</span>
<span id="cb6-56">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bss</span>(</span>
<span id="cb6-57">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">truth =</span> truth,</span>
<span id="cb6-58">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">estimate =</span> estimate,</span>
<span id="cb6-59">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ref_estimate =</span> ref_estimate,</span>
<span id="cb6-60">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">event_level =</span> event_level,</span>
<span id="cb6-61">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">case_weights =</span> case_weights</span>
<span id="cb6-62">  )</span>
<span id="cb6-63">}</span>
<span id="cb6-64"></span>
<span id="cb6-65"></span>
<span id="cb6-66">brier_skill_score_vec <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(</span>
<span id="cb6-67">    truth, </span>
<span id="cb6-68">    estimate, </span>
<span id="cb6-69">    ref_estimate, </span>
<span id="cb6-70">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na_rm =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, </span>
<span id="cb6-71">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">event_level =</span> yardstick<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">yardstick_event_level</span>(),</span>
<span id="cb6-72">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">case_weights =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, </span>
<span id="cb6-73">    ...</span>
<span id="cb6-74">) {</span>
<span id="cb6-75">  </span>
<span id="cb6-76">  yardstick<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abort_if_class_pred</span>(truth)</span>
<span id="cb6-77">  </span>
<span id="cb6-78">  estimator <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> yardstick<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">finalize_estimator</span>(</span>
<span id="cb6-79">    truth, </span>
<span id="cb6-80">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metric_class =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'brier_skill_score'</span></span>
<span id="cb6-81">  )</span>
<span id="cb6-82">  </span>
<span id="cb6-83">  yardstick<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">check_prob_metric</span>(truth, estimate, case_weights, estimator)</span>
<span id="cb6-84">  </span>
<span id="cb6-85">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (na_rm) {</span>
<span id="cb6-86">    result <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> yardstick<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">yardstick_remove_missing</span>(truth, estimate, case_weights)</span>
<span id="cb6-87">    </span>
<span id="cb6-88">    truth <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> result<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>truth</span>
<span id="cb6-89">    estimate <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> result<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>estimate</span>
<span id="cb6-90">    case_weights <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> result<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>case_weights</span>
<span id="cb6-91">  } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (yardstick<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">yardstick_any_missing</span>(truth, estimate, case_weights)) {</span>
<span id="cb6-92">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA_real_</span>)</span>
<span id="cb6-93">  }</span>
<span id="cb6-94"></span>
<span id="cb6-95">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brier_skill_score_estimator_impl</span>(</span>
<span id="cb6-96">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">truth =</span> truth,</span>
<span id="cb6-97">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">estimate =</span> estimate,</span>
<span id="cb6-98">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ref_estimate =</span> ref_estimate,</span>
<span id="cb6-99">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">event_level =</span> event_level,</span>
<span id="cb6-100">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">case_weights =</span> case_weights</span>
<span id="cb6-101">  )</span>
<span id="cb6-102">}</span>
<span id="cb6-103"></span>
<span id="cb6-104">brier_skill_score.data.frame <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(</span>
<span id="cb6-105">    data, </span>
<span id="cb6-106">    truth, </span>
<span id="cb6-107">    ...,</span>
<span id="cb6-108">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na_rm =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span id="cb6-109">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">event_level =</span> yardstick<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">yardstick_event_level</span>(),</span>
<span id="cb6-110">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">case_weights =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span></span>
<span id="cb6-111">) {</span>
<span id="cb6-112">  yardstick<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prob_metric_summarizer</span>(</span>
<span id="cb6-113">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'brier_skill_score'</span>,</span>
<span id="cb6-114">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fn =</span> brier_skill_score_vec,</span>
<span id="cb6-115">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> data,</span>
<span id="cb6-116">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">truth =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!!</span>rlang<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">enquo</span>(truth),</span>
<span id="cb6-117">    ...,</span>
<span id="cb6-118">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na_rm =</span> na_rm,</span>
<span id="cb6-119">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">event_level =</span> event_level,</span>
<span id="cb6-120">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">case_weights =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!!</span>rlang<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">enquo</span>(case_weights),</span>
<span id="cb6-121">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fn_options =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb6-122">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ref_estimate =</span> ref_estimate</span>
<span id="cb6-123">    )</span>
<span id="cb6-124">  )</span>
<span id="cb6-125">}</span>
<span id="cb6-126"></span>
<span id="cb6-127"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## The BSS is more intuitive to caluclate using the match non-win rate.</span></span>
<span id="cb6-128"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   Accordingly, we'll use .pred_no for our probability.</span></span>
<span id="cb6-129">REF_ESTIMATE <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> matches <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-130">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">count</span>(target) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-131">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prop =</span> n <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(n)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-132">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(target <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'yes'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-133">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pull</span>(prop)</span>
<span id="cb6-134"></span>
<span id="cb6-135">raw_brier_skill_score <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brier_skill_score_vec</span>(</span>
<span id="cb6-136">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">truth =</span> calibrated<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>target,</span>
<span id="cb6-137">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">estimate =</span> calibrated<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>.raw_pred_no,</span>
<span id="cb6-138">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ref_estimate =</span> REF_ESTIMATE</span>
<span id="cb6-139">)</span>
<span id="cb6-140"></span>
<span id="cb6-141">calibrated_brier_skill_score <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brier_skill_score_vec</span>(</span>
<span id="cb6-142">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">truth =</span> calibrated<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>target,</span>
<span id="cb6-143">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">estimate =</span> calibrated<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>.pred_no,</span>
<span id="cb6-144">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ref_estimate =</span> REF_ESTIMATE</span>
<span id="cb6-145">)</span>
<span id="cb6-146"></span>
<span id="cb6-147">compared_brier_skill_scores <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(</span>
<span id="cb6-148">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(</span>
<span id="cb6-149">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Un-calibrated'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> raw_brier_skill_score,</span>
<span id="cb6-150">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Calibrated'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> calibrated_brier_skill_score</span>
<span id="cb6-151">  ),</span>
<span id="cb6-152">  <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span></span>
<span id="cb6-153">)</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">compared_brier_skill_scores</span>
<span id="cb7-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; Un-calibrated    Calibrated </span></span>
<span id="cb7-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;         0.196         0.205</span></span></code></pre></div>
</div>
<p>Indeed, we have (marginally) improved the original pre-match win probabilities. But this approach is arguably a little naive–we’ve only re-assessed the entire data set a single time without accounting for potential uncertainties.</p>
<p>Fortunately, the <code>{probably}</code> package provides <a href="https://probably.tidymodels.org/reference/index.html#calibration-validation">the <code>cal_validate_*()</code> family</a> of functions. These functions allow for a more rigorous assessment of whether the calibration enhances the original probabilities. We can generate resamples from the original data and then compute the average and standard error for our chosen metrics. This lets us compare the calibrated and uncalibrated probabilities more effectively.</p>
<p>Let’s do just that, using <a href="https://en.wikipedia.org/wiki/Cross-validation_(statistics)">cross-validation</a> with 10 folds and 10 repeats We’ll again use BSS to evaluate the model probabilities.</p>
<div class="cell">
<details>
<summary>Robustly evaluate-ing calibrator</summary>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb8-2">sets <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> rsample<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vfold_cv</span>(</span>
<span id="cb8-3">  matches, </span>
<span id="cb8-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">v =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, </span>
<span id="cb8-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">repeats =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span>
<span id="cb8-6">)</span>
<span id="cb8-7"></span>
<span id="cb8-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## "fixed" in the sense that we're pre-defining the reference estimate.</span></span>
<span id="cb8-9"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   I'm not sure there's another way of going about this when working in conjunction `yardstick::metric_set()` and `probably::cal_validate_*()`</span></span>
<span id="cb8-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   with</span></span>
<span id="cb8-11">fixed_brier_skill_score.data.frame <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(...) {</span>
<span id="cb8-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brier_skill_score</span>(</span>
<span id="cb8-13">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ref_estimate =</span> REF_ESTIMATE,</span>
<span id="cb8-14">    ...</span>
<span id="cb8-15">  )</span>
<span id="cb8-16">}</span>
<span id="cb8-17"></span>
<span id="cb8-18">fixed_brier_skill_score <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(data, ...) {</span>
<span id="cb8-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">UseMethod</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fixed_brier_skill_score'</span>)</span>
<span id="cb8-20">}</span>
<span id="cb8-21"></span>
<span id="cb8-22">fixed_brier_skill_score <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> yardstick<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">new_prob_metric</span>(</span>
<span id="cb8-23">  fixed_brier_skill_score,</span>
<span id="cb8-24">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">direction =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'maximize'</span></span>
<span id="cb8-25">)</span>
<span id="cb8-26"></span>
<span id="cb8-27">eval_metrics <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> yardstick<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">metric_set</span>(</span>
<span id="cb8-28">  fixed_brier_skill_score</span>
<span id="cb8-29">)</span>
<span id="cb8-30"></span>
<span id="cb8-31">validation <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> probably<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cal_validate_beta</span>(</span>
<span id="cb8-32">  sets,</span>
<span id="cb8-33">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">truth =</span> target,</span>
<span id="cb8-34">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metrics =</span> eval_metrics</span>
<span id="cb8-35">)</span>
<span id="cb8-36"></span>
<span id="cb8-37">validation_metrics <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> validation <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb8-38">  tune<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">collect_metrics</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb8-39">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## i think the `.config` column is bugged (it just says "config" for all rows?)</span></span>
<span id="cb8-40">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">any_of</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.config'</span>))</span>
<span id="cb8-41">validation_metrics</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">validation_metrics</span>
<span id="cb9-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 2 × 6</span></span>
<span id="cb9-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;   .metric           .type        .estimator  mean     n std_err</span></span>
<span id="cb9-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;   &lt;chr&gt;             &lt;chr&gt;        &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt;</span></span>
<span id="cb9-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 1 brier_skill_score uncalibrated binary     0.196   100 0.00494</span></span>
<span id="cb9-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 2 brier_skill_score calibrated   binary     0.202   100 0.00628</span></span></code></pre></div>
</div>
<p>We find that the calibrator does indeed offer a “significant” improvement when assessed through this more statistically rigorous method. Specifically, the mean BSS of the validation set, minus one standard error, exceeds the mean of the uncalibrated BSS by more than one standard error.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1">pivoted_validation_metrics <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> validation_metrics <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb10-2">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">transmute</span>(</span>
<span id="cb10-3">    .type,</span>
<span id="cb10-4">    mean,</span>
<span id="cb10-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lower =</span> mean <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> std_err,</span>
<span id="cb10-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">upper =</span> mean <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> std_err</span>
<span id="cb10-7">  )</span>
<span id="cb10-8">pivoted_validation_metrics</span>
<span id="cb10-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 2 × 4</span></span>
<span id="cb10-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;   .type         mean lower upper</span></span>
<span id="cb10-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;   &lt;chr&gt;        &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb10-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 1 uncalibrated 0.196 0.191 0.201</span></span>
<span id="cb10-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 2 calibrated   0.202 0.196 0.209</span></span></code></pre></div>
</div>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>While I wouldn’t say “calibration is all you need”, it’s certainly something nice to have in your toolkit when you’re working on a modeling task. It can be a game-changer, especially when tweaking the original model isn’t an option, whether due to access limitations or, let’s be honest, sheer laziness.</p>
<p>Oh, and I failed to mention this earlier—calibration isn’t just for binary classifiers. Multinomial classifiers and even regression models can benefit from this technique as well.</p>
<p>Happy modeling, folks.</p>



</section>


<div class="quarto-listing quarto-listing-container-default" id="listing-listing">
<div class="list quarto-listing-default">

</div>
<div class="listing-no-matching d-none">
No matching items
</div>
</div><div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>The <a href="https://www.tidymodels.org/learn/models/calibration"><code>{tidymodels}</code> guide</a> breaks down the traditional modeling workflow into three steps:↩︎</p></li>
<li id="fn2"><p>Sticking with the basics, I use the defaults for <code>num_breaks</code> (10) and <code>conf_level</code> (0.9).↩︎</p></li>
<li id="fn3"><p>We don’t have a skew problem in this context, but it’s good to note when a Beta calibration might provide meaningful benefits over other calibration methods.↩︎</p></li>
<li id="fn4"><p>I’ve discussed BSS in <a href="../../posts/opta-xg-model-calibration">a prior post on expected goals model calibration</a> and <a href="../../posts/epl-xpts-simulation-1">another post on expected goals match-implied win probabilities</a>.↩︎</p></li>
<li id="fn5"><p>In this case, I choose to use the observed match win rate as the reference model.↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>r</category>
  <category>soccer</category>
  <guid>https://tonyelhabr.rbind.io/posts/probability-calibration/index.html</guid>
  <pubDate>Mon, 11 Sep 2023 05:00:00 GMT</pubDate>
  <media:content url="https://tonyelhabr.rbind.io/posts/probability-calibration/compared-calibration.png" medium="image" type="image/png" height="144" width="144"/>
</item>
<item>
  <title>Meta-Analytics for Soccer</title>
  <dc:creator>Tony ElHabr</dc:creator>
  <link>https://tonyelhabr.rbind.io/posts/soccer-meta-analytics/index.html</link>
  <description><![CDATA[ 



<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>This blog post demonstrates how to calculate the <strong>discrimination</strong> and <strong>stability</strong> “meta-metrics” proposed by <a href="https://www.degruyter.com/document/doi/10.1515/jqas-2016-0098/html">Franks et al.&nbsp;(2017)</a> for an array of soccer stats. Before the computations (<em>“Inference”</em>), I start by defining these meta-metrics (<em>“Methods”</em>), although I gloss over a lot of details for the sake of brevity. At the end, in <em>“Results and Discussion”</em>, I briefly discuss how my results compare to those for Franks et al., who analyzed basketball and hockey stats.</p>
<section id="background" class="level3">
<h3 class="anchored" data-anchor-id="background">Background</h3>
<p>In the realm of sports, data analysis has grown significantly, introducing numerous metrics to guide coaching, management, and, of course, fans. However, this proliferation has also led to confusion, with overlapping and sometimes conflicting metrics. To address this, Franks et al.<sup>1</sup> propose three “meta-metrics” to help determine which metrics offer unique and dependable information for decision-makers.</p>
<p>By examining sources of variation in sports metrics (e.g.&nbsp;intrinsic player skill), Franks et al.&nbsp;introduce three meta-metrics to assess player performance stats:</p>
<ul>
<li><strong>discrimination</strong>: How good is the metric at telling players apart?</li>
<li><strong>stability</strong>: How likely is it that a player maintains the same performance for the metric in the next season?</li>
<li><strong>independence</strong>: Does the stat tell us something different about players that other stats don’t tell us?</li>
</ul>
</section>
</section>
<section id="methods" class="level2">
<h2 class="anchored" data-anchor-id="methods">Methods</h2>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>I skip over a lot of details from Frank et al.’s paper here. I’d encourage an interested reader to review the original paper.</p>
</div>
</div>
<section id="discrimination" class="level3">
<h3 class="anchored" data-anchor-id="discrimination">Discrimination</h3>
<p>Simplifying the formulation of Franks et al., let’s define discrimination as follows:</p>
<p><span id="eq-discrimination-short"><img src="https://latex.codecogs.com/png.latex?%0A1%20-%20%5Cfrac%7BBV%7D%7BSV%7D.%0A%5Ctag%7B1%7D"></span></p>
<p><img src="https://latex.codecogs.com/png.latex?BV"> is the average sampling <strong>v</strong>ariance of a metric after <strong>b</strong>ootstrapping matches. (This variance measure is unique in that it involves resampling, while the others are simply calculated on the observed data.) <img src="https://latex.codecogs.com/png.latex?SV"> is the total <strong>v</strong>ariance of a metric between players in a given <strong>s</strong>eason.</p>
<p>Altogether, this equation describes <strong>the fraction of variance between players due to true differences in player ability</strong>. A value closer to 1 indicates a metric that can differentiate between players more precisely.</p>
</section>
<section id="stability" class="level3">
<h3 class="anchored" data-anchor-id="stability">Stability</h3>
<p>Again, simplifying the original equation from Franks et al., we define stability as so:</p>
<p><span id="eq-stability-short"><img src="https://latex.codecogs.com/png.latex?%0A1%20-%20%5Cfrac%7BWV%20-%20BV%7D%7BTV%20-%20BV%7D.%0A%5Ctag%7B2%7D"></span></p>
<p><img src="https://latex.codecogs.com/png.latex?WV"> represents the average <strong>v</strong>ariance among seasons “<strong>w</strong>ithin” a player, before accounting for sampling variance (<img src="https://latex.codecogs.com/png.latex?BV">). <img src="https://latex.codecogs.com/png.latex?TV"> is the <strong>t</strong>otal <strong>v</strong>ariance of a metric over all seasons, before accounting for sampling variance.</p>
<p>On the whole, this equation represent <strong>the fraction of total variance that is due to within-player changes over time</strong>. A value closer to 1 indicates that the metric value for a given player is less likely to change from season to season.</p>
</section>
</section>
<section id="inference" class="level2">
<h2 class="anchored" data-anchor-id="inference">Inference</h2>
<section id="data" class="level3">
<h3 class="anchored" data-anchor-id="data">Data</h3>
<p>We’ll be using public data from <a href="https://fbref.com/">FBref</a> for the 2018/19 - 2022/23 seasons of the <a href="https://fbref.com/en/comps/Big5/Big-5-European-Leagues-Stats">the Big 5 European soccer leagues</a>.</p>
<div class="cell">
<details>
<summary>Retrieve and wrangle data</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyr)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(purrr)</span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tibble)</span>
<span id="cb1-5"></span>
<span id="cb1-6">load_fb_advanced_match_stats <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(country, gender, tier, stat_type, team_or_player, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">season_end_year =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>) {</span>
<span id="cb1-7">  </span>
<span id="cb1-8">  url <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sprintf</span>(</span>
<span id="cb1-9">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'https://github.com/JaseZiv/worldfootballR_data/releases/download/fb_advanced_match_stats/%s_%s_%s_%s_%s_advanced_match_stats.rds'</span>,</span>
<span id="cb1-10">    country,</span>
<span id="cb1-11">    gender,</span>
<span id="cb1-12">    tier,</span>
<span id="cb1-13">    stat_type,</span>
<span id="cb1-14">    team_or_player</span>
<span id="cb1-15">  )</span>
<span id="cb1-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readRDS</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">url</span>(url))</span>
<span id="cb1-17">}</span>
<span id="cb1-18"></span>
<span id="cb1-19">possibly_load_fb_advanced_match_stats <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> purrr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">possibly</span>(</span>
<span id="cb1-20">  load_fb_advanced_match_stats, </span>
<span id="cb1-21">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">otherwise =</span> tibble<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(),</span>
<span id="cb1-22">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">quiet =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span></span>
<span id="cb1-23">)</span>
<span id="cb1-24"></span>
<span id="cb1-25">params <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> tidyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">expand_grid</span>(</span>
<span id="cb1-26">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">country =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ENG'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ESP'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'FRA'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'GER'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ITA'</span>),</span>
<span id="cb1-27">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gender =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'M'</span>,</span>
<span id="cb1-28">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tier =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'1st'</span>,</span>
<span id="cb1-29">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">stat_type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'summary'</span>,</span>
<span id="cb1-30">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">team_or_player =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'player'</span></span>
<span id="cb1-31">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-32">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.list</span>()</span>
<span id="cb1-33"></span>
<span id="cb1-34">raw_player_match_stats <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> purrr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmap_dfr</span>(</span>
<span id="cb1-35">  params,</span>
<span id="cb1-36">  possibly_load_fb_advanced_match_stats</span>
<span id="cb1-37">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-38">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(</span>
<span id="cb1-39">    <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## stop at 2022/23 season</span></span>
<span id="cb1-40">    Season_End_Year <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> 2024L,</span>
<span id="cb1-41">    <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## don't include keepers</span></span>
<span id="cb1-42">    <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grepl</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'GK'</span>, Pos)</span>
<span id="cb1-43">  )</span>
<span id="cb1-44"></span>
<span id="cb1-45">ALL_METRICS <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(</span>
<span id="cb1-46">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'goals'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Goals'</span>,</span>
<span id="cb1-47">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'assists'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Assists'</span>,</span>
<span id="cb1-48">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shots'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Shots'</span>,</span>
<span id="cb1-49">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shots_on_target'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Shots on Target'</span>,</span>
<span id="cb1-50">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tackles'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Tackles'</span>,</span>
<span id="cb1-51">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'interceptions'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Interceptions'</span>,</span>
<span id="cb1-52">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'xg'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'xG'</span>,</span>
<span id="cb1-53">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'xa'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'xA'</span>,</span>
<span id="cb1-54">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'goals_xg_ratio'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Goals/xG'</span>,</span>
<span id="cb1-55">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'carries'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Carries'</span>,</span>
<span id="cb1-56">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shot_conversion_rate'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Shots Conversion Rate'</span>,</span>
<span id="cb1-57">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'pass_completion_rate'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Pass Completion Rate'</span>,</span>
<span id="cb1-58">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'goals_p90'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Goals/90'</span>,</span>
<span id="cb1-59">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shots_p90'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Shots/90'</span>,</span>
<span id="cb1-60">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'xg_p90'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'xG/90'</span></span>
<span id="cb1-61">)</span>
<span id="cb1-62"></span>
<span id="cb1-63">safe_divide <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(num, den) {</span>
<span id="cb1-64">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(</span>
<span id="cb1-65">    den <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(den),</span>
<span id="cb1-66">    <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA_real_</span>,</span>
<span id="cb1-67">    dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coalesce</span>(num <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> den, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb1-68">  )</span>
<span id="cb1-69">}</span>
<span id="cb1-70"></span>
<span id="cb1-71">coalesce_fraction <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> purrr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">compose</span>(</span>
<span id="cb1-72">  \(num, den) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">safe_divide</span>(num, den),</span>
<span id="cb1-73">  \(x) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, x),</span>
<span id="cb1-74">  \(x) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, x),</span>
<span id="cb1-75">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.dir =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'forward'</span></span>
<span id="cb1-76">)</span>
<span id="cb1-77"></span>
<span id="cb1-78">add_rate_and_p90_metric_columns <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(df) {</span>
<span id="cb1-79">  df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-80">    dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb1-81">      <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Mark Noble with the epic 1 goal on 0 shots https://fbref.com/en/matches/b56fd899/Watford-West-Ham-United-December-28-2021-Premier-League</span></span>
<span id="cb1-82">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shot_conversion_rate =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coalesce_fraction</span>(goals, shots),</span>
<span id="cb1-83">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pass_completion_rate =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coalesce_fraction</span>(passes_completed, passes_attempted),</span>
<span id="cb1-84">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">goals_xg_ratio =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">safe_divide</span>(goals, xg)</span>
<span id="cb1-85">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-86">    dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb1-87">      dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(</span>
<span id="cb1-88">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(goals, shots, xg),</span>
<span id="cb1-89">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb1-90">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">p90 =</span> \(.x) <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">90</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> .x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> minutes_played</span>
<span id="cb1-91">        )</span>
<span id="cb1-92">      )</span>
<span id="cb1-93">    )</span>
<span id="cb1-94">}</span>
<span id="cb1-95"></span>
<span id="cb1-96">summarize_all_metric_columns <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(df, ...) {</span>
<span id="cb1-97">  matches_played <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-98">    dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(league, season, team, player) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb1-99">    dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(minutes_played <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> 0L) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-100">    dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(</span>
<span id="cb1-101">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">matches_played =</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n_distinct</span>(match_id)</span>
<span id="cb1-102">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-103">    dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>()</span>
<span id="cb1-104">  </span>
<span id="cb1-105">  df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-106">    dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(..., league, season, team, player) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-107">    dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(</span>
<span id="cb1-108">      dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(</span>
<span id="cb1-109">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(minutes_played<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">last_col</span>()),</span>
<span id="cb1-110">        sum</span>
<span id="cb1-111">      )</span>
<span id="cb1-112">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-113">    dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-114">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_rate_and_p90_metric_columns</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-115">    dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inner_join</span>(</span>
<span id="cb1-116">      matches_played,</span>
<span id="cb1-117">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(league, season, team, player)</span>
<span id="cb1-118">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-119">    dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">relocate</span>(</span>
<span id="cb1-120">      matches_played,</span>
<span id="cb1-121">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.before =</span> minutes_played</span>
<span id="cb1-122">    )</span>
<span id="cb1-123">}</span>
<span id="cb1-124"></span>
<span id="cb1-125"></span>
<span id="cb1-126">player_match_stats <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> raw_player_match_stats <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-127">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">transmute</span>(</span>
<span id="cb1-128">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">league =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sprintf</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'%s-%s-%s'</span>, Country, Gender, Tier),</span>
<span id="cb1-129">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">season =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sprintf</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'%s/%s'</span>, Season_End_Year <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">substr</span>(Season_End_Year, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)),</span>
<span id="cb1-130">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">date =</span> Match_Date,</span>
<span id="cb1-131">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">match_id =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">basename</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dirname</span>(MatchURL)),</span>
<span id="cb1-132">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">team =</span> Team,</span>
<span id="cb1-133">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">player =</span> Player,</span>
<span id="cb1-134">    </span>
<span id="cb1-135">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">minutes_played =</span> Min,</span>
<span id="cb1-136">    </span>
<span id="cb1-137">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">goals =</span> Gls, <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## includes pks</span></span>
<span id="cb1-138">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">assists =</span> Ast,</span>
<span id="cb1-139">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shots =</span> Sh, <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## does not include pk attempts</span></span>
<span id="cb1-140">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shots_on_target =</span> SoT,</span>
<span id="cb1-141">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tackles =</span> Tkl,</span>
<span id="cb1-142">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">interceptions =</span> Int,</span>
<span id="cb1-143">    </span>
<span id="cb1-144">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">passes_completed =</span> Cmp_Passes,</span>
<span id="cb1-145">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">passes_attempted =</span> Att_Passes,</span>
<span id="cb1-146">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">carries =</span> Carries_Carries,</span>
<span id="cb1-147">    </span>
<span id="cb1-148">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xg =</span> xG_Expected,</span>
<span id="cb1-149">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xa =</span> xAG_Expected</span>
<span id="cb1-150">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-151">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_rate_and_p90_metric_columns</span>()</span>
<span id="cb1-152"></span>
<span id="cb1-153">player_season_stats <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize_all_metric_columns</span>(player_match_stats)</span>
<span id="cb1-154"></span>
<span id="cb1-155"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Franks et al. used 250 min played for the NBA</span></span>
<span id="cb1-156"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## https://github.com/afranks86/meta-analytics/blob/1871d24762184afa69f29a2b5b348431e70b9b2b/basketballReliability.R#L60</span></span>
<span id="cb1-157">MIN_MINUTES_PLAYED <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">270</span></span>
<span id="cb1-158">eligible_player_season_stats <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> player_season_stats <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-159">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(minutes_played <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> MIN_MINUTES_PLAYED)</span>
<span id="cb1-160"></span>
<span id="cb1-161">eligible_player_match_stats <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> player_match_stats <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-162">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">semi_join</span>(</span>
<span id="cb1-163">    eligible_player_season_stats,</span>
<span id="cb1-164">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(league, season, team, player)</span>
<span id="cb1-165">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-166">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(league, season, team, player)</span>
<span id="cb1-167"></span>
<span id="cb1-168"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## drop players with 0s for any given metric across any season?</span></span>
<span id="cb1-169"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   looks like they only did that for testing a 1-season evaluation:</span></span>
<span id="cb1-170"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   https://github.com/afranks86/meta-analytics/blob/1871d24762184afa69f29a2b5b348431e70b9b2b/basketballReliability.R#L25</span></span>
<span id="cb1-171"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># eligible_player_season_stats |&gt; </span></span>
<span id="cb1-172"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   pivot_metric_columns() |&gt; </span></span>
<span id="cb1-173"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   group_by(league, team, player, metric) |&gt; </span></span>
<span id="cb1-174"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   summarize(has_any_zero = any(value == 0)) |&gt; </span></span>
<span id="cb1-175"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   ungroup() |&gt; </span></span>
<span id="cb1-176"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   filter(has_any_zero)</span></span></code></pre></div>
</details>
</div>
<p>After some light wrangling, the player-match data looks like this.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glimpse</span>(eligible_player_match_stats)</span>
<span id="cb2-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; Rows: 271,416</span></span>
<span id="cb2-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; Columns: 24</span></span>
<span id="cb2-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ league               &lt;chr&gt; "ENG-M-1st", "ENG-M-1st", "ENG-M-1st", "ENG-M-…</span></span>
<span id="cb2-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ season               &lt;chr&gt; "2018/19", "2018/19", "2018/19", "2018/19", "2…</span></span>
<span id="cb2-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ date                 &lt;chr&gt; "2018-08-12", "2018-08-18", "2018-08-25", "201…</span></span>
<span id="cb2-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ match_id             &lt;chr&gt; "478e9dab", "9b69882c", "0014076a", "c1503e09"…</span></span>
<span id="cb2-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ team                 &lt;chr&gt; "Arsenal", "Arsenal", "Arsenal", "Arsenal", "A…</span></span>
<span id="cb2-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ player               &lt;chr&gt; "Aaron Ramsey", "Aaron Ramsey", "Aaron Ramsey"…</span></span>
<span id="cb2-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ minutes_played       &lt;dbl&gt; 53, 23, 90, 90, 79, 79, 62, 24, 11, 13, 18, 16…</span></span>
<span id="cb2-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ goals                &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0…</span></span>
<span id="cb2-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ assists              &lt;dbl&gt; 0, 0, 0, 0, 0, 2, 0, 1, 0, 0, 0, 1, 0, 2, 0, 0…</span></span>
<span id="cb2-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ shots                &lt;dbl&gt; 1, 2, 2, 2, 0, 1, 0, 1, 0, 0, 0, 1, 0, 3, 1, 0…</span></span>
<span id="cb2-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ shots_on_target      &lt;dbl&gt; 1, 1, 1, 2, 0, 1, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0…</span></span>
<span id="cb2-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ tackles              &lt;dbl&gt; 2, 0, 2, 1, 2, 0, 2, 0, 1, 0, 0, 0, 1, 2, 1, 0…</span></span>
<span id="cb2-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ interceptions        &lt;dbl&gt; 0, 0, 1, 2, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0…</span></span>
<span id="cb2-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ passes_completed     &lt;dbl&gt; 9, 6, 48, 51, 49, 26, 16, 16, 13, 5, 11, 7, 8,…</span></span>
<span id="cb2-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ passes_attempted     &lt;dbl&gt; 13, 9, 61, 66, 58, 31, 20, 21, 15, 7, 12, 10, …</span></span>
<span id="cb2-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ carries              &lt;dbl&gt; 5, 7, 41, 49, 43, 27, 21, 16, 11, 8, 11, 7, 7,…</span></span>
<span id="cb2-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ xg                   &lt;dbl&gt; 0.0, 0.1, 0.1, 0.1, 0.0, 0.0, 0.0, 0.1, 0.0, 0…</span></span>
<span id="cb2-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ xa                   &lt;dbl&gt; 0.1, 0.0, 0.2, 0.2, 0.1, 0.4, 0.0, 0.1, 0.0, 0…</span></span>
<span id="cb2-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ shot_conversion_rate &lt;dbl&gt; 0, 0, 0, 0, NA, 0, NA, 1, NA, NA, NA, 0, NA, 0…</span></span>
<span id="cb2-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ pass_completion_rate &lt;dbl&gt; 0.6923077, 0.6666667, 0.7868852, 0.7727273, 0.…</span></span>
<span id="cb2-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ goals_xg_ratio       &lt;dbl&gt; NA, 0.000000, 0.000000, 0.000000, NA, NA, NA, …</span></span>
<span id="cb2-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ goals_p90            &lt;dbl&gt; 0.000000, 0.000000, 0.000000, 0.000000, 0.0000…</span></span>
<span id="cb2-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ shots_p90            &lt;dbl&gt; 1.698113, 7.826087, 2.000000, 2.000000, 0.0000…</span></span>
<span id="cb2-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ xg_p90               &lt;dbl&gt; 0.0000000, 0.3913043, 0.1000000, 0.1000000, 0.…</span></span></code></pre></div>
</div>
<p>There are a lot more stats we could pull in, but I’ve opted for a relatively small set of 15 stats<sup>2</sup>:</p>
<ul>
<li>“Un-adjusted” (i.e.&nbsp;not normalized for the number of minutes played) <strong>counting</strong> stats: goals, assists, shots, shots on target, tackles, interceptions, and carries</li>
<li>Un-adjusted <strong>“advanced”</strong> stats: <a href="https://theanalyst.com/na/2023/08/what-is-expected-goals-xg/">expected goals (xG)</a>, <a href="https://theanalyst.com/eu/2021/03/what-are-expected-assists-xa/">expected assists (xA)</a>, and goals/xG ratio</li>
<li><strong>Rate</strong> metrics: pass completion rate and shot conversion rate (i.e.&nbsp;goals divided by shots)</li>
<li><strong>“Per 90”</strong> versions of other stats: goals/90, shots/90, and xG/90</li>
</ul>
<p>Now we can start to calculate the meta-metrics.</p>
</section>
<section id="discrimination-1" class="level3">
<h3 class="anchored" data-anchor-id="discrimination-1">Discrimination</h3>
<p>We’ll begin with the discrimination meta-metric, which means we’ll need to calculate “bootstrap variance”, <img src="https://latex.codecogs.com/png.latex?BV">, and, “seasonal variance”, <img src="https://latex.codecogs.com/png.latex?SV">, as shown in Equation&nbsp;1.</p>
<p>Starting with the former, we resample player matches within teams, with replacement.</p>
<div class="cell">
<details>
<summary>Bootstrap observed player-seasons</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">resample_stats <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(player_match_stats) {</span>
<span id="cb3-2">  </span>
<span id="cb3-3">  match_ids <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> player_match_stats <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb3-4">    dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">distinct</span>(league, season, team, date, match_id) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-5">    dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(league, season, team, date)</span>
<span id="cb3-6">  </span>
<span id="cb3-7">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## can't just specify to resample 38 matches per team since different leagues </span></span>
<span id="cb3-8">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## have different season lengths (Bundesliga)</span></span>
<span id="cb3-9">  resampled_match_ids <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> match_ids <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-10">    dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(league, season, team, match_id) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-11">    dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(league, season, team) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-12">    dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(</span>
<span id="cb3-13">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">match_id =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(match_id)</span>
<span id="cb3-14">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-15">    dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-16">    dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb3-17">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">match_id =</span> purrr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map</span>(</span>
<span id="cb3-18">        match_id,</span>
<span id="cb3-19">        \(.x) {</span>
<span id="cb3-20">          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(.x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(.x), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb3-21">        })</span>
<span id="cb3-22">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-23">    tidyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest</span>(match_id)</span>
<span id="cb3-24">  </span>
<span id="cb3-25">  resampled_match_ids <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-26">    dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inner_join</span>(</span>
<span id="cb3-27">      player_match_stats,</span>
<span id="cb3-28">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(league, season, team, match_id),</span>
<span id="cb3-29">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">relationship =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'many-to-many'</span></span>
<span id="cb3-30">    )</span>
<span id="cb3-31">}</span>
<span id="cb3-32"></span>
<span id="cb3-33"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Franks et al. used 20 bootstrap replicates</span></span>
<span id="cb3-34"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## https://github.com/afranks86/meta-analytics/blob/1871d24762184afa69f29a2b5b348431e70b9b2b/basketballReliability.R#L70</span></span>
<span id="cb3-35">N_BOOSTRAPS <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span></span>
<span id="cb3-36"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb3-37">resampled_player_match_stats <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> purrr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map_dfr</span>(</span>
<span id="cb3-38">  rlang<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_names</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>N_BOOSTRAPS),</span>
<span id="cb3-39">  \(...) {</span>
<span id="cb3-40">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">resample_stats</span>(</span>
<span id="cb3-41">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">player_match_stats =</span> eligible_player_match_stats</span>
<span id="cb3-42">    )</span>
<span id="cb3-43">  },</span>
<span id="cb3-44">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.id =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bootstrap_id'</span></span>
<span id="cb3-45">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-46">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bootstrap_id =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.integer</span>(bootstrap_id))</span></code></pre></div>
</details>
</div>
<p>After we aggregate over the matches in each bootstrap to create player-season summaries per bootstrap, we get a data frame that looks like this.</p>
<div class="cell">
<details>
<summary>Aggregate bootstraps</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">resampled_player_match_stats <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> resampled_player_match_stats <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb4-2">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Franks et al. did this</span></span>
<span id="cb4-3">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## https://github.com/afranks86/meta-analytics/blob/1871d24762184afa69f29a2b5b348431e70b9b2b/basketballReliability.R#L78</span></span>
<span id="cb4-4">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(minutes_played <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> MIN_MINUTES_PLAYED))</span>
<span id="cb4-5"></span>
<span id="cb4-6">resampled_player_season_stats <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> resampled_player_match_stats <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb4-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize_all_metric_columns</span>(bootstrap_id) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb4-8">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(bootstrap_id, league, season, team, player)</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glimpse</span>(resampled_player_season_stats)</span>
<span id="cb5-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; Rows: 234,172</span></span>
<span id="cb5-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; Columns: 24</span></span>
<span id="cb5-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ bootstrap_id         &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…</span></span>
<span id="cb5-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ league               &lt;chr&gt; "ENG-M-1st", "ENG-M-1st", "ENG-M-1st", "ENG-M-…</span></span>
<span id="cb5-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ season               &lt;chr&gt; "2018/19", "2018/19", "2018/19", "2018/19", "2…</span></span>
<span id="cb5-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ team                 &lt;chr&gt; "Arsenal", "Arsenal", "Arsenal", "Arsenal", "A…</span></span>
<span id="cb5-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ player               &lt;chr&gt; "Aaron Ramsey", "Ainsley Maitland-Niles", "Ale…</span></span>
<span id="cb5-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ matches_played       &lt;int&gt; 28, 16, 35, 35, 29, 25, 19, 17, 34, 33, 24, 8,…</span></span>
<span id="cb5-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ minutes_played       &lt;dbl&gt; 1349, 1053, 1714, 2767, 2213, 1357, 989, 1385,…</span></span>
<span id="cb5-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ goals                &lt;dbl&gt; 2, 2, 3, 11, 4, 3, 0, 5, 0, 0, 7, 0, 2, 20, 0,…</span></span>
<span id="cb5-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ assists              &lt;dbl&gt; 1, 1, 4, 8, 2, 5, 3, 0, 3, 0, 2, 0, 4, 4, 0, 5…</span></span>
<span id="cb5-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ shots                &lt;dbl&gt; 28, 8, 31, 102, 24, 30, 7, 5, 21, 20, 14, 9, 7…</span></span>
<span id="cb5-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ shots_on_target      &lt;dbl&gt; 9, 6, 15, 28, 11, 11, 4, 5, 1, 4, 9, 0, 6, 27,…</span></span>
<span id="cb5-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ tackles              &lt;dbl&gt; 37, 28, 21, 35, 44, 17, 9, 21, 61, 35, 9, 21, …</span></span>
<span id="cb5-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ interceptions        &lt;dbl&gt; 10, 17, 14, 19, 34, 9, 13, 36, 55, 23, 3, 0, 3…</span></span>
<span id="cb5-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ passes_completed     &lt;dbl&gt; 733, 444, 619, 677, 1656, 552, 470, 832, 1269,…</span></span>
<span id="cb5-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ passes_attempted     &lt;dbl&gt; 906, 561, 847, 933, 2059, 724, 580, 905, 1504,…</span></span>
<span id="cb5-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ carries              &lt;dbl&gt; 630, 334, 724, 738, 1085, 454, 333, 602, 978, …</span></span>
<span id="cb5-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ xg                   &lt;dbl&gt; 2.7, 1.6, 4.2, 11.0, 1.0, 3.9, 0.3, 1.9, 0.6, …</span></span>
<span id="cb5-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ xa                   &lt;dbl&gt; 2.4, 0.9, 5.3, 3.6, 2.0, 4.8, 0.9, 0.5, 0.7, 0…</span></span>
<span id="cb5-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ shot_conversion_rate &lt;dbl&gt; 0.07142857, 0.25000000, 0.09677419, 0.10784314…</span></span>
<span id="cb5-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ pass_completion_rate &lt;dbl&gt; 0.8090508, 0.7914439, 0.7308146, 0.7256163, 0.…</span></span>
<span id="cb5-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ goals_xg_ratio       &lt;dbl&gt; 0.7407407, 1.2500000, 0.7142857, 1.0000000, 4.…</span></span>
<span id="cb5-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ goals_p90            &lt;dbl&gt; 0.1334322, 0.1709402, 0.1575263, 0.3577882, 0.…</span></span>
<span id="cb5-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ shots_p90            &lt;dbl&gt; 1.8680504, 0.6837607, 1.6277713, 3.3176726, 0.…</span></span>
<span id="cb5-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ xg_p90               &lt;dbl&gt; 0.180133432, 0.136752137, 0.220536756, 0.35778…</span></span></code></pre></div>
</div>
<p>Next, we calculate the variance across the player-season bootstraps, and then average the bootstrap variance over all player-seasons, grouping by season, to arrive at <img src="https://latex.codecogs.com/png.latex?BV">. We end up with one variance value per season and metric.</p>
<div class="cell">
<details>
<summary>Calculate average bootstrap variance, BV</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">pivot_metric_columns <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(df) {</span>
<span id="cb6-2">  df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-3">    dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(</span>
<span id="cb6-4">      league,</span>
<span id="cb6-5">      season,</span>
<span id="cb6-6">      team,</span>
<span id="cb6-7">      player,</span>
<span id="cb6-8">      dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">any_of</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(ALL_METRICS))</span>
<span id="cb6-9">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-10">    tidyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(</span>
<span id="cb6-11">      <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(league, season, team, player),</span>
<span id="cb6-12">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'metric'</span>,</span>
<span id="cb6-13">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'value'</span></span>
<span id="cb6-14">    )</span>
<span id="cb6-15">}</span>
<span id="cb6-16"></span>
<span id="cb6-17">resampled_player_season_variance <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> resampled_player_season_stats <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_metric_columns</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-19">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(season, team, player, metric) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-20">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(</span>
<span id="cb6-21">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bv =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">var</span>(value, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb6-22">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-23">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>()</span>
<span id="cb6-24"></span>
<span id="cb6-25">bv <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> resampled_player_season_variance <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-26">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(season, metric) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-27">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(</span>
<span id="cb6-28">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bv =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(bv, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb6-29">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-30">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-31">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(season, metric)</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">bv</span>
<span id="cb7-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 90 × 3</span></span>
<span id="cb7-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    season  metric                        bv</span></span>
<span id="cb7-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    &lt;chr&gt;   &lt;chr&gt;                      &lt;dbl&gt;</span></span>
<span id="cb7-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  1 2017/18 assists                 1.64    </span></span>
<span id="cb7-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  2 2017/18 carries              7712.      </span></span>
<span id="cb7-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  3 2017/18 goals                   2.36    </span></span>
<span id="cb7-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  4 2017/18 goals_p90               0.0102  </span></span>
<span id="cb7-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  5 2017/18 goals_xg_ratio          1.40    </span></span>
<span id="cb7-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  6 2017/18 interceptions          33.4     </span></span>
<span id="cb7-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  7 2017/18 pass_completion_rate    0.000577</span></span>
<span id="cb7-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  8 2017/18 shot_conversion_rate    0.00604 </span></span>
<span id="cb7-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  9 2017/18 shots                  32.5     </span></span>
<span id="cb7-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 10 2017/18 shots_on_target         8.39 </span></span>
<span id="cb7-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # ℹ 80 more rows</span></span></code></pre></div>
</div>
<p>Next, we move on to the “seasonal variance”, <img src="https://latex.codecogs.com/png.latex?SV">. This is actually pretty trivial, as it’s just a direct call to <code>stats::var</code> on the observed player-season aggregates, grouping by season. Again, we end up with one row per season and metric.</p>
<div class="cell">
<details>
<summary>Calculate seasonal variance, SV</summary>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1">pivoted_player_season_stats <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_metric_columns</span>(player_season_stats)</span>
<span id="cb8-2"></span>
<span id="cb8-3">sv <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pivoted_player_season_stats <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb8-4">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(season, metric) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb8-5">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(</span>
<span id="cb8-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sv =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">var</span>(value, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb8-7">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb8-8">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb8-9">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(season, metric)</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">sv</span>
<span id="cb9-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 90 × 3</span></span>
<span id="cb9-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    season  metric                         sv</span></span>
<span id="cb9-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    &lt;chr&gt;   &lt;chr&gt;                       &lt;dbl&gt;</span></span>
<span id="cb9-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  1 2017/18 assists                   4.33   </span></span>
<span id="cb9-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  2 2017/18 carries              153542.     </span></span>
<span id="cb9-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  3 2017/18 goals                    12.4    </span></span>
<span id="cb9-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  4 2017/18 goals_p90                 0.302  </span></span>
<span id="cb9-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  5 2017/18 goals_xg_ratio            2.15   </span></span>
<span id="cb9-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  6 2017/18 interceptions           319.     </span></span>
<span id="cb9-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  7 2017/18 pass_completion_rate      0.00948</span></span>
<span id="cb9-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  8 2017/18 shot_conversion_rate      0.0128 </span></span>
<span id="cb9-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  9 2017/18 shots                   480.     </span></span>
<span id="cb9-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 10 2017/18 shots_on_target          73.4    </span></span>
<span id="cb9-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # ℹ 80 more rows</span></span></code></pre></div>
</div>
<p>Finally, we bring <img src="https://latex.codecogs.com/png.latex?BV"> and <img src="https://latex.codecogs.com/png.latex?SV"> together to calculate discrimination by season.</p>
<div class="cell">
<details>
<summary>Calculate discrimination</summary>
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1">discrimination <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> bv <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb10-2">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inner_join</span>(</span>
<span id="cb10-3">    sv,</span>
<span id="cb10-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(season, metric)</span>
<span id="cb10-5">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb10-6">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb10-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">discrimination =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> bv <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> sv</span>
<span id="cb10-8">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb10-9">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(season, metric)</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1">discrimination</span>
<span id="cb11-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 90 × 5</span></span>
<span id="cb11-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    season  metric                        bv           sv discrimination</span></span>
<span id="cb11-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    &lt;chr&gt;   &lt;chr&gt;                      &lt;dbl&gt;        &lt;dbl&gt;          &lt;dbl&gt;</span></span>
<span id="cb11-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  1 2017/18 assists                 1.64          4.33             0.621</span></span>
<span id="cb11-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  2 2017/18 carries              7712.       153542.               0.950</span></span>
<span id="cb11-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  3 2017/18 goals                   2.36         12.4              0.810</span></span>
<span id="cb11-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  4 2017/18 goals_p90               0.0102        0.302            0.966</span></span>
<span id="cb11-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  5 2017/18 goals_xg_ratio          1.40          2.15             0.348</span></span>
<span id="cb11-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  6 2017/18 interceptions          33.4         319.               0.895</span></span>
<span id="cb11-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  7 2017/18 pass_completion_rate    0.000577      0.00948          0.939</span></span>
<span id="cb11-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  8 2017/18 shot_conversion_rate    0.00604       0.0128           0.527</span></span>
<span id="cb11-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  9 2017/18 shots                  32.5         480.               0.932</span></span>
<span id="cb11-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 10 2017/18 shots_on_target         8.39         73.4              0.886</span></span>
<span id="cb11-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # ℹ 80 more rows</span></span></code></pre></div>
</div>
<p>For the sake of making discrimination directly comparable to stability (which is only calculated per metric, not per metric and season), we can average the discrimination values over all seasons.</p>
<div class="cell">
<details>
<summary>Average discrimination</summary>
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1">average_discrimination <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> discrimination <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb12-2">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(metric) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb12-3">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(</span>
<span id="cb12-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">discrimination =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(discrimination)</span>
<span id="cb12-5">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb12-6">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(metric)</span>
<span id="cb12-7">average_discrimination</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1">average_discrimination</span>
<span id="cb13-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 15 × 2</span></span>
<span id="cb13-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    metric               discrimination</span></span>
<span id="cb13-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    &lt;chr&gt;                         &lt;dbl&gt;</span></span>
<span id="cb13-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  1 assists                       0.600</span></span>
<span id="cb13-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  2 carries                       0.951</span></span>
<span id="cb13-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  3 goals                         0.792</span></span>
<span id="cb13-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  4 goals_p90                     0.830</span></span>
<span id="cb13-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  5 goals_xg_ratio                0.181</span></span>
<span id="cb13-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  6 interceptions                 0.889</span></span>
<span id="cb13-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  7 pass_completion_rate          0.950</span></span>
<span id="cb13-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  8 shot_conversion_rate          0.507</span></span>
<span id="cb13-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  9 shots                         0.926</span></span>
<span id="cb13-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 10 shots_on_target               0.875</span></span>
<span id="cb13-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 11 shots_p90                     0.956</span></span>
<span id="cb13-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 12 tackles                       0.895</span></span>
<span id="cb13-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 13 xa                            0.830</span></span>
<span id="cb13-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 14 xg                            0.898</span></span>
<span id="cb13-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 15 xg_p90                        0.929</span></span></code></pre></div>
</div>
</section>
<section id="stability-1" class="level3">
<h3 class="anchored" data-anchor-id="stability-1">Stability</h3>
<p>For stability, we need to calculate “within”-player variance, <img src="https://latex.codecogs.com/png.latex?WV">, and “total variance”, <img src="https://latex.codecogs.com/png.latex?TV">, as shown in Equation&nbsp;2.</p>
<p>For <img src="https://latex.codecogs.com/png.latex?WV">, we start by grouping on the on everything but the metric values and season variable in our data frame for observed player-season stats, and calculate variance with <code>var()</code>. Then we average the variance across all players with <code>mean()</code>.</p>
<div class="cell">
<details>
<summary>Calculate within-player variance, WV</summary>
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1">within_player_variance <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pivoted_player_season_stats <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb14-2">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## should check for players with the same name</span></span>
<span id="cb14-3">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(league, team, player, metric) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb14-4">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(</span>
<span id="cb14-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seasons_played =</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>(),</span>
<span id="cb14-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">wv =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">var</span>(value, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb14-7">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb14-8">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>()</span>
<span id="cb14-9"></span>
<span id="cb14-10">wv <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> within_player_variance <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb14-11">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Franks et al. don't have something quite like this, where they filter for</span></span>
<span id="cb14-12">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   a minimum number of seasons played. I think they didn't find it necessary</span></span>
<span id="cb14-13">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   after dropping player who have ever had zeros, and because they were working</span></span>
<span id="cb14-14">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   with 20 seasons of NBA data. (I'm working with 6.)</span></span>
<span id="cb14-15">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(</span>
<span id="cb14-16">    seasons_played <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> 3L</span>
<span id="cb14-17">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb14-18">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(metric) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb14-19">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(</span>
<span id="cb14-20">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">wv =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(wv, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb14-21">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb14-22">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb14-23">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(metric)</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1">wv</span>
<span id="cb15-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 15 × 2</span></span>
<span id="cb15-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    metric                        wv</span></span>
<span id="cb15-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    &lt;chr&gt;                      &lt;dbl&gt;</span></span>
<span id="cb15-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  1 assists                  2.71   </span></span>
<span id="cb15-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  2 carries              77143.     </span></span>
<span id="cb15-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  3 goals                    5.75   </span></span>
<span id="cb15-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  4 goals_p90                0.0269 </span></span>
<span id="cb15-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  5 goals_xg_ratio           1.45   </span></span>
<span id="cb15-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  6 interceptions          122.     </span></span>
<span id="cb15-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  7 pass_completion_rate     0.00339</span></span>
<span id="cb15-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  8 shot_conversion_rate     0.0103 </span></span>
<span id="cb15-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  9 shots                  183.     </span></span>
<span id="cb15-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 10 shots_on_target         29.1    </span></span>
<span id="cb15-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 11 shots_p90                0.821  </span></span>
<span id="cb15-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 12 tackles                239.     </span></span>
<span id="cb15-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 13 xa                       1.57   </span></span>
<span id="cb15-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 14 xg                       3.71   </span></span>
<span id="cb15-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 15 xg_p90                   0.0141</span></span></code></pre></div>
</div>
<p>To finish our variance calculations, we calculate “total variance”, <img src="https://latex.codecogs.com/png.latex?TV">. This is the most straightforward of them all, as it involves just a call to <code>var()</code> for each metric on the observed player-season stats.</p>
<div class="cell">
<details>
<summary>Calculate total variance, TV</summary>
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1">tv <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pivoted_player_season_stats <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb16-2">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(metric) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb16-3">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(</span>
<span id="cb16-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tv =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">var</span>(value, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb16-5">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb16-6">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb16-7">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(metric)</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1">tv</span>
<span id="cb17-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 15 × 2</span></span>
<span id="cb17-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    metric                        tv</span></span>
<span id="cb17-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    &lt;chr&gt;                      &lt;dbl&gt;</span></span>
<span id="cb17-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  1 assists                   4.16  </span></span>
<span id="cb17-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  2 carries              161078.    </span></span>
<span id="cb17-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  3 goals                    11.5   </span></span>
<span id="cb17-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  4 goals_p90                 0.0925</span></span>
<span id="cb17-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  5 goals_xg_ratio            1.67  </span></span>
<span id="cb17-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  6 interceptions           252.    </span></span>
<span id="cb17-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  7 pass_completion_rate      0.0119</span></span>
<span id="cb17-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  8 shot_conversion_rate      0.0136</span></span>
<span id="cb17-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  9 shots                   427.    </span></span>
<span id="cb17-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 10 shots_on_target          65.2   </span></span>
<span id="cb17-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 11 shots_p90                 4.76  </span></span>
<span id="cb17-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 12 tackles                 460.    </span></span>
<span id="cb17-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 13 xa                        3.15  </span></span>
<span id="cb17-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 14 xg                        9.27  </span></span>
<span id="cb17-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 15 xg_p90                    0.0729</span></span></code></pre></div>
</div>
<p>We bring <img src="https://latex.codecogs.com/png.latex?BV">, <img src="https://latex.codecogs.com/png.latex?WV"> and <img src="https://latex.codecogs.com/png.latex?TV"> together to calculate stability.</p>
<div class="cell">
<details>
<summary>Calculate stability</summary>
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1">average_bv <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> bv <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb18-2">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(metric) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb18-3">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(</span>
<span id="cb18-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bv =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(bv)</span>
<span id="cb18-5">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb18-6">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>()</span>
<span id="cb18-7"></span>
<span id="cb18-8">stability <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> average_bv <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb18-9">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inner_join</span>(</span>
<span id="cb18-10">    tv,</span>
<span id="cb18-11">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(metric)</span>
<span id="cb18-12">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb18-13">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inner_join</span>(</span>
<span id="cb18-14">    wv,</span>
<span id="cb18-15">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(metric)</span>
<span id="cb18-16">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb18-17">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb18-18">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">stability =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> (wv <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> bv) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (tv <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> bv)</span>
<span id="cb18-19">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb18-20">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(metric)</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1">stability</span>
<span id="cb19-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 15 × 5</span></span>
<span id="cb19-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    metric                        bv          tv          wv stability</span></span>
<span id="cb19-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    &lt;chr&gt;                      &lt;dbl&gt;       &lt;dbl&gt;       &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span id="cb19-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  1 assists                 1.66          4.16       2.71        0.580</span></span>
<span id="cb19-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  2 carries              7808.       161078.     77143.          0.548</span></span>
<span id="cb19-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  3 goals                   2.38         11.5        5.75        0.629</span></span>
<span id="cb19-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  4 goals_p90               0.0105        0.0925     0.0269      0.799</span></span>
<span id="cb19-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  5 goals_xg_ratio          1.35          1.67       1.45        0.696</span></span>
<span id="cb19-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  6 interceptions          27.8         252.       122.          0.577</span></span>
<span id="cb19-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  7 pass_completion_rate    0.000582      0.0119     0.00339     0.752</span></span>
<span id="cb19-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  8 shot_conversion_rate    0.00670       0.0136     0.0103      0.487</span></span>
<span id="cb19-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  9 shots                  31.7         427.       183.          0.618</span></span>
<span id="cb19-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 10 shots_on_target         8.17         65.2       29.1         0.634</span></span>
<span id="cb19-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 11 shots_p90               0.118         4.76       0.821       0.849</span></span>
<span id="cb19-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 12 tackles                48.3         460.       239.          0.537</span></span>
<span id="cb19-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 13 xa                      0.538         3.15       1.57        0.607</span></span>
<span id="cb19-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 14 xg                      0.944         9.27       3.71        0.668</span></span>
<span id="cb19-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 15 xg_p90                  0.00397       0.0729     0.0141      0.853</span></span></code></pre></div>
</div>
</section>
</section>
<section id="results-and-discussion" class="level2">
<h2 class="anchored" data-anchor-id="results-and-discussion">Results and Discussion</h2>
<p>Let’s make a scatter plot of the discrimination and stability of our metrics, akin to the plots made by Franks et al.</p>
<p><img src="https://tonyelhabr.rbind.io/posts/soccer-meta-analytics/discrimination-vs-stability.png" class="img-fluid"></p>
<p>We can make the following observations:</p>
<ul>
<li><p>Un-adjusted volume (i.e.&nbsp;“count” in the plot) statistics based on total playing time–like shots, tackles, and interceptions–tend to be highly discriminative, but not quite as stable. This makes sense—such statistics have large between-player variance—think about the number of shots that a central defender takes compared to a striker. When aggregated for each player throughout a season, they provide a strong signal for different player types, i.e.&nbsp;positions. Indeed, Franks et al.&nbsp;found the same for NBA and NHL statistics.</p></li>
<li><p>Advanced stats like xG and xA also prove to be more discriminative than stable.</p></li>
<li><p>The other advanced stat, goals/xG ratio, stands out. It’s the only metric that is significantly more stable than discriminative. Although I haven’t looked into this extensively or given it much more than a few moments of thought, I believe this is because most players do not score goals in individual matches, but often accumulate some non-zero xG via shots. Thus, Goals/xG can be zero very frequently, meaning that it would be hard to differentiate players just on this ratio. And, because the ratio is often zero, it is found to be stable.</p></li>
<li><p>Shot conversion rate seems to be the center of the universe, having nearly equal discrimination and stability, both at around 0.5.</p></li>
<li><p>The per 90 metrics show higher stability than all other stats evaluated. This speaks to the between-player noise-minimizing benefits of comparing players on an equal-minute basis. Their stability is much closer to their discriminative power than most other other metrics.</p></li>
</ul>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>We’ve replicated the ideas of a commonly cited sports analytics paper<sup>3</sup>, applying them to the beautiful game of soccer. While this blog post was more about replication than insights, we’ve confirmed that the key observations regarding the meta-metric properties of volume and rate statistics also apply soccer.</p>
<ul>
<li>Discrimination can be used to distinguish between players for a given season. Volume measures like shots and tackles should implicitly provide some indication of player positions and roles. (After all, we wouldn’t expect a striker to be making more tackles than a defender.)</li>
<li>Stability represents how much a metric can vary over time. Intuitively, stats that adjust for playing time (i.e.&nbsp;“per 90”) show less fluctuations from season to season.</li>
</ul>



</section>


<div class="quarto-listing quarto-listing-container-default" id="listing-listing">
<div class="list quarto-listing-default">

</div>
<div class="listing-no-matching d-none">
No matching items
</div>
</div><div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>If it means anything, the <em>Meta-analytics</em> paper has <a href="https://scholar.google.com/scholar?cites=13818794209592074425&amp;as_sdt=5,44&amp;sciodt=0,44&amp;hl=en">40 citations</a> at the time of writing, suggesting it has had a non-trivial influence on subsequent sports analytics research.↩︎</p></li>
<li id="fn2"><p>This isn’t meant to be an explainer of what these stats are or why they were chosen. Nonetheless, it’s worth pointing out the different types of stats, as it is relevant to the calculation relationship between discrimination and stability, as we shall see.↩︎</p></li>
<li id="fn3"><p>The fact that they’ve published <a href="https://github.com/afranks86/meta-analytics">their code</a> made the replication much less of a daunting task, so huge kudos to the authors. (Note that there were a few tweaks that I needed to make to get all of the code working properly with R &gt;4.0.)↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>r</category>
  <category>soccer</category>
  <guid>https://tonyelhabr.rbind.io/posts/soccer-meta-analytics/index.html</guid>
  <pubDate>Fri, 08 Sep 2023 05:00:00 GMT</pubDate>
  <media:content url="https://tonyelhabr.rbind.io/posts/soccer-meta-analytics/discrimination-vs-stability.png" medium="image" type="image/png" height="144" width="144"/>
</item>
<item>
  <title>Measuring Shooting Overperformance in Soccer</title>
  <dc:creator>Tony ElHabr</dc:creator>
  <link>https://tonyelhabr.rbind.io/posts/xg-ratio-empirical-bayes/index.html</link>
  <description><![CDATA[ 



<div class="callout callout-style-default callout-note callout-titled" data-code-fold="true" title="Updates">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Updates
</div>
</div>
<div class="callout-body-container callout-body">
<p><em>Wording in this post was updated after the original posting. Originally an outperformance ratio greater than 1 was mistakenly called “underperforming”, and a ratio less than 1 was mistakenly called “overperforming”. The wording has been fixed.</em></p>
</div>
</div>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>This blog post is my attempt to replicate the results in Laurie Shaw’s 2018 blog post <a href="http://eightyfivepoints.blogspot.com/2018/09/exceeding-expected-goals.html">“Exceeding Expected Goals”</a>. Specifically, I want to shed light on how to implement <a href="https://en.wikipedia.org/wiki/Empirical_Bayes_method#Poisson%E2%80%93gamma_model">Gamma-Poisson</a> <a href="https://en.wikipedia.org/wiki/Empirical_Bayes_method">empirical Bayes</a> (EB) estimation. If you don’t care at all about the theory behind EB and its application to this context, then go ahead and skip ahead to the “Implementation” section.</p>
<section id="what-is-empirical-bayes-eb-estimation" class="level3">
<h3 class="anchored" data-anchor-id="what-is-empirical-bayes-eb-estimation">What Is Empirical Bayes (EB) estimation?</h3>
<p><strong>Empirical Bayes</strong> (EB) estimation. Wow, just typing that out makes me feel smart. But what is it, really? In short, I’d describe it as a mix of <a href="https://en.wikipedia.org/wiki/Bayesian_inference">Bayesian</a> and <a href="https://en.wikipedia.org/wiki/Frequentist_inference">Frequentist</a> inference. We lean into the observed frequencies of the data (Frequentist) while simultaneously refining our initial data assumptions through Bayesian updating. In practice, one might use EB as a (relatively) simple alternative to a full Bayesian analysis, which can feel daunting.</p>
<p>In regular Bayesian analysis, you start with your initial “guess” (prior distribution) about something, and as you gather data, you tweak that “guess” using Bayes’ theorem to get a final view (posterior distribution). We combine what we thought about the data beforehand with how likely the data matches (likelihood).</p>
<p>Empirical Bayes puts a twist on this. Instead of having a prior guess, you figure out that initial guess from the same data you’re analyzing. This can make things simpler, especially when you’re dealing with tons of guesses but not much initial info.</p>
</section>
<section id="a-canonical-example-of-eb-estimation-beta-binomial" class="level3">
<h3 class="anchored" data-anchor-id="a-canonical-example-of-eb-estimation-beta-binomial">A canonical example of EB estimation (Beta-Binomial)</h3>
<p><a href="https://github.com/dgrtwo">David Robinson</a> wrote <a href="http://varianceexplained.org/r/empirical_bayes_baseball/">a wonderful blog post</a> about empirical Bayes estimation for estimating <a href="https://en.wikipedia.org/wiki/Batting_average_(baseball)">batting averages in baseball</a>, notably “shrinking” the battering averages of those with relatively few at bats closer to some “prior” estimate derived from a choice of hyperparameters. For context, batting average, <img src="https://latex.codecogs.com/png.latex?BA">, is defined as a player’s count of hits, <img src="https://latex.codecogs.com/png.latex?H">, divided by the count of their at bats, <img src="https://latex.codecogs.com/png.latex?AB">.</p>
<p><span id="eq-ba"><img src="https://latex.codecogs.com/png.latex?%0ABA%20=%20%5Cfrac%7BH%7D%7BAB%7D%0A%5Ctag%7B1%7D"></span></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>I’d David’s post <strong>must read</strong> material before going through this blog post.</p>
</div>
</div>
<p>In his post, David uses <a href="https://en.wikipedia.org/wiki/Beta_distribution">a Beta prior</a> and <a href="https://en.wikipedia.org/wiki/Binomial_distribution">a binomial posterior</a> together, i.e.&nbsp;a <a href="https://www.bayesrulesbook.com/chapter-3">Beta-binomial Bayesian model</a>)<sup>1</sup><sup>2</sup>, since this tandem is suitable for proportions and probabilities. The gist of his approach: we add some fixed number of hits, <img src="https://latex.codecogs.com/png.latex?%5Calpha_0">, and a fixed number of at bats, <img src="https://latex.codecogs.com/png.latex?%5Cbeta_0">, to the numerator and denominator of the battering average equation as so.</p>
<p><span id="eq-adj-ba"><img src="https://latex.codecogs.com/png.latex?%0A%5Cfrac%7BH%20+%20%5Calpha_0%7D%7BAB%20+%20%5Calpha_0%20+%20%5Cbeta_0%7D%0A%5Ctag%7B2%7D"></span></p>
<p>Specifically, the “prior” estimate of batting average is found by isolating the <img src="https://latex.codecogs.com/png.latex?%5Calpha_0"> and <img src="https://latex.codecogs.com/png.latex?%5Cbeta_0"> elements:</p>
<p><span id="eq-ba-prior"><img src="https://latex.codecogs.com/png.latex?%0A%5Cfrac%7B%5Calpha_0%7D%7B%5Calpha_0%20+%20%5Cbeta_0%7D%0A%5Ctag%7B3%7D"></span></p>
<p>If, for example, <code>alpha0 = 70</code> and <code>beta0 = 163</code>, then the prior estimate of batting average is effectively <code>70 / (70 + 163) = 0.3</code>. Note that <code>alpha0</code> and <code>beta0</code> are learned from the data using <a href="https://en.wikipedia.org/wiki/Maximum_likelihood_estimation">maximum likelihood estimation (MLE)</a>, although other approaches, such as <a href="https://en.wikipedia.org/wiki/Method_of_moments_(statistics)">“method of moments”</a> could be used. (Heck, you could even defensibly choose these “hyperparameters” yourself, without any fancy statistics, if you feel that you have enough knowledge of the data.)</p>
</section>
<section id="gamma-poisson-eb-estimation" class="level3">
<h3 class="anchored" data-anchor-id="gamma-poisson-eb-estimation">Gamma-Poisson EB estimation</h3>
<p>Now, for my replication of Shaw’s analysis, we’re going to be focusing on the ratio of a player’s goals, <img src="https://latex.codecogs.com/png.latex?G">, divided by their <a href="../../posts/epl-xpts-simulation-1">expected goals</a>), <img src="https://latex.codecogs.com/png.latex?xG">, summed up over a fixed period. Shaw refers to this as “outperformance” <img src="https://latex.codecogs.com/png.latex?O"> for a player <img src="https://latex.codecogs.com/png.latex?p">:</p>
<p><span id="eq-o"><img src="https://latex.codecogs.com/png.latex?%0AO_p%20=%20%5Cfrac%7BG_p%7D%7BxG_p%7D%0A%5Ctag%7B4%7D"></span></p>
<p>While one might be tempted to use Beta-Binomial EB since this setup seems similar to batting average in Equation&nbsp;1, Shaw used a <a href="https://www.bayesrulesbook.com/chapter-5#gamma-poisson-conjugate-family">Gamma-Poisson</a> EB adjustment, and justifiably so. Gamma-Poisson makes more sense when the underlying data consists of counts <em>and</em> what you’re trying to estimate is a rate or ratio, not a proportion bounded between 0 and 1. Note that a <img src="https://latex.codecogs.com/png.latex?O_p"> ratio of 1 indicates that a player is scoring as many goals as expected; a ratio greater than 1 indicates overperformance; and a ratio less than 1 indicates underperformance. On, the other hand, batting average is bounded between 0 and 1.</p>
<p>Now, despite the naming of conjugate prior pairs–e.g.&nbsp;“Beta-Binomial” and “Gamma-Poisson”, where the prior distribution is represented by the first distribution and the likelihood distribution is indicated by the second–let’s not forget that there is a third distribution to be noted: the posterior. In the case of the Gamma-Poisson model, the unnormalized posterior distribution of the “kernel” (i.e.&nbsp;the prior and likelihood pair) is a Gamma distribution. (This is always the case with Gamma-Prior kernels.)</p>
<p>In practice, this means that we’ll be using the Gamma distribution for both estimating hyperparameters and posterior sampling. Perhaps surprising to the reader, you won’t need any Poisson functions in the code implementation. Rather, the Poisson distribution is pertinent to implementation only to the extent that the Gamma distribution happens to be the most reasonable distribution to pair with it.</p>
<p>I’ve woefully explained away a lot of details here, but hopefully this all makes sense to those with a basic understanding of the Gamma and Poisson distributions themselves.</p>
</section>
</section>
<section id="implementation" class="level2">
<h2 class="anchored" data-anchor-id="implementation">Implementation</h2>
<p>Ok, so with all of that context provided, now let’s do the replication of Shaw’s findings.</p>
<section id="data" class="level3">
<h3 class="anchored" data-anchor-id="data">Data</h3>
<p>First, let’s pull the data we’ll need–2016/17 and 2017/18 <a href="https://www.premierleague.com">English Premier League</a> goals and <a href="https://theanalyst.com/na/2023/08/what-is-expected-goals-xg/">expected goals (xG)</a> by player. I’m using <a href="https://understat.com/">understat</a> since it is a reliable source of data<sup>3</sup> and is easy to retrieve data from via the <a href="https://jaseziv.github.io/worldfootballR/"><code>{worldfootballR}</code> package</a>.<sup>4</sup></p>
<p>Note that Shaw used data from a provider, <a href="https://www.linkedin.com/company/stratagem-ltd/about/">Stratagem</a>, that no long provides data, as far as I can tell. For at least this reason, I won’t be able to exactly match his reason.<sup>5</sup></p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## data wrangling</span></span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(worldfootballR)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)</span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tibble)</span>
<span id="cb1-5"></span>
<span id="cb1-6"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## distribution fitting and wrangling</span></span>
<span id="cb1-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(MASS, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">include.only =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fitdistr'</span>) <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## to avoid `select` name conflict with dplyr</span></span>
<span id="cb1-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(withr)</span>
<span id="cb1-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(purrr)</span>
<span id="cb1-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyr)</span>
<span id="cb1-11"></span>
<span id="cb1-12">raw_shots <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> worldfootballR<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">load_understat_league_shots</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">league =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'EPL'</span>)</span>
<span id="cb1-13">shots <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> raw_shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-14">  tibble<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-15">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(</span>
<span id="cb1-16">    season <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(2016L, 2017L), <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2016/17 and 2017/18 seasons</span></span>
<span id="cb1-17">    situation <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'DirectFreeKick'</span> <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## "excluding free-kicks" in the blog post</span></span>
<span id="cb1-18">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-19">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(id) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-20">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">transmute</span>(</span>
<span id="cb1-21">    id,</span>
<span id="cb1-22">    player,</span>
<span id="cb1-23">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xg =</span> x_g,</span>
<span id="cb1-24">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">g =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.integer</span>(result <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Goal'</span>)</span>
<span id="cb1-25">  )</span>
<span id="cb1-26">shots</span>
<span id="cb1-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 19,047 × 4</span></span>
<span id="cb1-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;        id player               xg     g</span></span>
<span id="cb1-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;     &lt;dbl&gt; &lt;chr&gt;             &lt;dbl&gt; &lt;int&gt;</span></span>
<span id="cb1-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  1 112088 Aaron Ramsey    0.0695      0</span></span>
<span id="cb1-31"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  2 112089 Nathaniel Clyne 0.0293      0</span></span>
<span id="cb1-32"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  3 112090 Aaron Ramsey    0.00734     0</span></span>
<span id="cb1-33"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  4 112091 Roberto Firmino 0.0856      0</span></span>
<span id="cb1-34"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  5 112092 Roberto Firmino 0.0441      0</span></span>
<span id="cb1-35"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  6 112093 Sadio Mané      0.0607      0</span></span>
<span id="cb1-36"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  7 112094 Ragnar Klavan   0.0742      0</span></span>
<span id="cb1-37"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  8 112095 Theo Walcott    0.761       0</span></span>
<span id="cb1-38"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  9 112096 Theo Walcott    0.0721      1</span></span>
<span id="cb1-39"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 10 112097 Roberto Firmino 0.0241      0</span></span>
<span id="cb1-40"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # ℹ 19,037 more rows</span></span></code></pre></div>
</details>
</div>
<p>Above was pulling in every record of shots, with 1 row per shot. Now we aggregate to the player level, such that we have one row per player.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">shots_by_player <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb2-2">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(player) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb2-3">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(</span>
<span id="cb2-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shots =</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>(),</span>
<span id="cb2-5">    dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(g, xg), sum)</span>
<span id="cb2-6">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb2-7">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb2-8">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">raw_ratio =</span> g <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> xg) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb2-9">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">desc</span>(shots))</span>
<span id="cb2-10">shots_by_player</span>
<span id="cb2-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 588 × 5</span></span>
<span id="cb2-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    player            shots     g    xg raw_ratio</span></span>
<span id="cb2-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    &lt;chr&gt;             &lt;int&gt; &lt;int&gt; &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span id="cb2-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  1 Harry Kane          293    59  46.7     1.26 </span></span>
<span id="cb2-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  2 Sergio Agüero       234    41  41.2     0.994</span></span>
<span id="cb2-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  3 Christian Eriksen   229    18  16.1     1.12 </span></span>
<span id="cb2-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  4 Alexis Sánchez      217    33  29.1     1.13 </span></span>
<span id="cb2-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  5 Romelu Lukaku       196    41  32.1     1.28 </span></span>
<span id="cb2-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  6 Roberto Firmino     184    26  21.1     1.23 </span></span>
<span id="cb2-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  7 Kevin De Bruyne     179    14  12.2     1.15 </span></span>
<span id="cb2-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  8 Salomón Rondón      171    15  16.2     0.924</span></span>
<span id="cb2-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  9 Paul Pogba          168    11  14.3     0.768</span></span>
<span id="cb2-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 10 Christian Benteke   164    18  28.5     0.631</span></span>
<span id="cb2-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # ℹ 578 more rows</span></span></code></pre></div>
</details>
</div>
</section>
<section id="eb-step-1-estimate-prior-hyperparameters" class="level3">
<h3 class="anchored" data-anchor-id="eb-step-1-estimate-prior-hyperparameters">EB step 1: estimate prior hyperparameters</h3>
<p>Next, we estimate hyperparameters for our prior gamma distribution using MLE. (With R’s <code>dgamma</code>, the hyperparameters are <code>shape</code> and <code>rate</code><sup>6</sup>). I subset the data down to players having taken at least 50 shots for estimating these hyperparameters, as this is what Shaw does. In general, you’d want to filter your data here to records that provide good “signal”, and, therefore, will provide reliable estimates of your hyperparameters.<sup>7</sup></p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">prior_shots_by_player <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(</span>
<span id="cb3-2">  shots_by_player, </span>
<span id="cb3-3">  shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>,</span>
<span id="cb3-4">  g <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## prevent error with fitting prior distribution</span></span>
<span id="cb3-5">)</span>
<span id="cb3-6"></span>
<span id="cb3-7">prior_distr <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> MASS<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fitdistr</span>(</span>
<span id="cb3-8">  prior_shots_by_player<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>raw_ratio,</span>
<span id="cb3-9">  dgamma,</span>
<span id="cb3-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">start =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rate =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb3-11">)</span>
<span id="cb3-12">prior_shape <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> prior_distr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>estimate[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb3-13">prior_rate <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> prior_distr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>estimate[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]</span>
<span id="cb3-14"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prior_shape =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(prior_shape, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prior_rate =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(prior_rate, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span>
<span id="cb3-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $prior_shape</span></span>
<span id="cb3-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; shape </span></span>
<span id="cb3-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  9.39 </span></span>
<span id="cb3-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; </span></span>
<span id="cb3-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $prior_rate</span></span>
<span id="cb3-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; rate </span></span>
<span id="cb3-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 8.93</span></span></code></pre></div>
</details>
</div>
</section>
<section id="eb-step-2-use-prior-distribution-to-sample-the-posterior" class="level3">
<h3 class="anchored" data-anchor-id="eb-step-2-use-prior-distribution-to-sample-the-posterior">EB step 2: Use prior distribution to sample the posterior</h3>
<p>Now we use our prior distribution’s hyperparameters to update all players’ <img src="https://latex.codecogs.com/png.latex?O"> ratio based on their individual volume of evidence, i.e.&nbsp;their goals and xG.</p>
<div class="cell" data-label="adj_ratio_by_player">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">simulate_gamma_posterior <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(</span>
<span id="cb4-2">    successes, </span>
<span id="cb4-3">    trials, </span>
<span id="cb4-4">    prior_shape, </span>
<span id="cb4-5">    prior_rate, </span>
<span id="cb4-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n_sims =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10000</span>,</span>
<span id="cb4-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seed =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span></span>
<span id="cb4-8">) {</span>
<span id="cb4-9">  posterior_shape <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> prior_shape <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> successes</span>
<span id="cb4-10">  posterior_rate <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> prior_rate <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> trials</span>
<span id="cb4-11">  withr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">local_seed</span>(seed)</span>
<span id="cb4-12">  posterior_sample <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rgamma</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> n_sims, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape =</span> posterior_shape, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rate =</span> posterior_rate)</span>
<span id="cb4-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb4-14">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mean =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(posterior_sample),</span>
<span id="cb4-15">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sd =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sd</span>(posterior_sample)</span>
<span id="cb4-16">  )</span>
<span id="cb4-17">}</span>
<span id="cb4-18"></span>
<span id="cb4-19">shots_by_player<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>adj_ratio <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> purrr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map2</span>(</span>
<span id="cb4-20">  shots_by_player<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>g, shots_by_player<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>xg,</span>
<span id="cb4-21">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(g, xg) {</span>
<span id="cb4-22">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">simulate_gamma_posterior</span>(</span>
<span id="cb4-23">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">successes =</span> g,</span>
<span id="cb4-24">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">trials =</span> xg,</span>
<span id="cb4-25">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prior_shape =</span> prior_shape,</span>
<span id="cb4-26">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prior_rate =</span> prior_rate</span>
<span id="cb4-27">    )</span>
<span id="cb4-28">  }</span>
<span id="cb4-29">)</span>
<span id="cb4-30"></span>
<span id="cb4-31">adj_ratio_by_player <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> shots_by_player <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb4-32">  tidyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest_wider</span>(</span>
<span id="cb4-33">    adj_ratio, </span>
<span id="cb4-34">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_sep =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'_'</span></span>
<span id="cb4-35">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb4-36">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">desc</span>(adj_ratio_mean))</span>
<span id="cb4-37">adj_ratio_by_player</span>
<span id="cb4-38"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 588 × 7</span></span>
<span id="cb4-39"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    player            shots     g    xg raw_ratio adj_ratio_mean adj_ratio_sd</span></span>
<span id="cb4-40"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    &lt;chr&gt;             &lt;int&gt; &lt;int&gt; &lt;dbl&gt;     &lt;dbl&gt;          &lt;dbl&gt;        &lt;dbl&gt;</span></span>
<span id="cb4-41"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  1 Fernando Llorente    57    16  9.19      1.74           1.40        0.281</span></span>
<span id="cb4-42"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  2 Philippe Coutinho   160    20 12.5       1.60           1.37        0.256</span></span>
<span id="cb4-43"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  3 Shkodran Mustafi     37     5  1.82      2.75           1.34        0.357</span></span>
<span id="cb4-44"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  4 Pascal Groß          43     7  3.34      2.10           1.34        0.334</span></span>
<span id="cb4-45"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  5 Ryan Fraser          55     8  4.09      1.95           1.34        0.324</span></span>
<span id="cb4-46"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  6 Eden Hazard         148    28 19.2       1.45           1.33        0.219</span></span>
<span id="cb4-47"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  7 James McArthur       53    10  5.93      1.69           1.31        0.299</span></span>
<span id="cb4-48"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  8 Charlie Daniels      39     5  2.18      2.30           1.30        0.346</span></span>
<span id="cb4-49"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  9 Xherdan Shaqiri     117    12  7.61      1.58           1.29        0.282</span></span>
<span id="cb4-50"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 10 Andy Carroll         67    10  6.09      1.64           1.29        0.296</span></span>
<span id="cb4-51"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # ℹ 578 more rows</span></span></code></pre></div>
</div>
<p>Finally, let’s plot our results, plotting our adjusted mean estimates of <img src="https://latex.codecogs.com/png.latex?O_p">, ±1 standard deviation about the adjusted mean.<sup>8</sup> As noted earlier, we won’t achieve exactly the same results as Shaw due to using a different set of xG values, but evidently we’ve achieved results reasonably close to his.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb5-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(forcats)</span>
<span id="cb5-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggh4x)</span>
<span id="cb5-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(magick)</span>
<span id="cb5-5"></span>
<span id="cb5-6">shaw_players <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(</span>
<span id="cb5-7">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Eden Hazard'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'E. Hazard'</span>,</span>
<span id="cb5-8">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Mohamed Salah'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Mohamed Salah'</span>,</span>
<span id="cb5-9">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Son Heung-Min'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Heung-Min Son'</span>,</span>
<span id="cb5-10">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Joshua King'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'J. King'</span>,</span>
<span id="cb5-11">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Romelu Lukaku'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'R. Lukaku'</span>,</span>
<span id="cb5-12">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Harry Kane'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'H. Kane'</span>,</span>
<span id="cb5-13">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Sadio Mané'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'S. Mane'</span>,</span>
<span id="cb5-14">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Dele Alli'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'D. Ali'</span>,</span>
<span id="cb5-15">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Riyad Mahrez'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'R. Mahrez'</span>,</span>
<span id="cb5-16">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Christian Eriksen'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C. Eriksen'</span>,</span>
<span id="cb5-17">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Pedro'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Pedro'</span>,</span>
<span id="cb5-18">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Alexis Sánchez'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A. Sanchez'</span>,</span>
<span id="cb5-19">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Roberto Firmino'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Roberto Firmino'</span>,</span>
<span id="cb5-20">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Jamie Vardy'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'J. Vardy'</span>,</span>
<span id="cb5-21">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Xherdan Shaqiri'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'X. Shaqiri'</span>,</span>
<span id="cb5-22">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Wilfried Zaha'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'W. Zaha'</span>,</span>
<span id="cb5-23">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Nathan Redmond'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'N. Redmond'</span>,</span>
<span id="cb5-24">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Gylfi Sigurdsson'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'G. Sigurdsson'</span>,</span>
<span id="cb5-25">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Kevin De Bruyne'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'K. De Bruyne'</span>,</span>
<span id="cb5-26">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Andros Townsend'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A. Townsend'</span>,</span>
<span id="cb5-27">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Sergio Agüero'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'S. Aguero'</span>,</span>
<span id="cb5-28">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Marcus Rashford'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'M. Rashford'</span>,</span>
<span id="cb5-29">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Jermain Defoe'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'J. Defoe'</span>,</span>
<span id="cb5-30">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Raheem Sterling'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'R. Sterling'</span>,</span>
<span id="cb5-31">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Marko Arnautovic'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'M. Arnautovic'</span>,</span>
<span id="cb5-32">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Paul Pogba'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'P. Pogba'</span>,</span>
<span id="cb5-33">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Salomón Rondón'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'S. Rondon'</span>,</span>
<span id="cb5-34">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Christian Benteke'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C. Benteke'</span></span>
<span id="cb5-35">)</span>
<span id="cb5-36"></span>
<span id="cb5-37">ordinal_adj_ratio_by_player <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> adj_ratio_by_player <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb5-38">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(</span>
<span id="cb5-39">    player <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(shaw_players)</span>
<span id="cb5-40">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-41">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb5-42">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">player =</span> forcats<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_reorder</span>(shaw_players[player], adj_ratio_mean)</span>
<span id="cb5-43">  )</span>
<span id="cb5-44"></span>
<span id="cb5-45">adj_ratio_plot <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> ordinal_adj_ratio_by_player <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb5-46">  ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-47">  ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> player) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-48">  ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_errorbarh</span>(</span>
<span id="cb5-49">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(</span>
<span id="cb5-50">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmin =</span> adj_ratio_mean <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> adj_ratio_sd,</span>
<span id="cb5-51">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmax =</span> adj_ratio_mean <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> adj_ratio_sd</span>
<span id="cb5-52">    ),</span>
<span id="cb5-53">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'blue'</span>,</span>
<span id="cb5-54">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>,</span>
<span id="cb5-55">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span></span>
<span id="cb5-56">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-57">  ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(</span>
<span id="cb5-58">    ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> adj_ratio_mean),</span>
<span id="cb5-59">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">23</span>,</span>
<span id="cb5-60">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>,</span>
<span id="cb5-61">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">stroke =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.15</span>,</span>
<span id="cb5-62">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'red'</span>,</span>
<span id="cb5-63">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'black'</span></span>
<span id="cb5-64">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-65">  ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(</span>
<span id="cb5-66">    ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), </span>
<span id="cb5-67">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, </span>
<span id="cb5-68">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb5-69">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-70">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## add duplicate axis for ticks: https://stackoverflow.com/questions/56247205/r-ggplot2-add-ticks-on-top-and-right-sides-of-all-facets</span></span>
<span id="cb5-71">  ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sec.axis =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dup_axis</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-72">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## ggplot2 doesn't support duplicated and creatinga  second axis for discrete variables:</span></span>
<span id="cb5-73">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   https://github.com/tidyverse/ggplot2/issues/3171.</span></span>
<span id="cb5-74">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   using ggh4x is a workaround.</span></span>
<span id="cb5-75">  ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guides</span>(</span>
<span id="cb5-76">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y.sec =</span> ggh4x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guide_axis_manual</span>(</span>
<span id="cb5-77">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">breaks =</span> ordinal_adj_ratio_by_player<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>player,</span>
<span id="cb5-78">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> ordinal_adj_ratio_by_player<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>player</span>
<span id="cb5-79">    )</span>
<span id="cb5-80">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-81">  ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_linedraw</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">base_family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'DejaVu Sans'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">base_size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-82">  ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(</span>
<span id="cb5-83">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.title =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.25</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'plain'</span>),</span>
<span id="cb5-84">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.ticks.length =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'pt'</span>),</span>
<span id="cb5-85">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.ticks =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_line</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>),</span>
<span id="cb5-86">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid.major.y =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb5-87">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid.minor =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb5-88">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid.major.x =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_line</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>),</span>
<span id="cb5-89">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.x.top =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb5-90">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.y.right =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb5-91">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.title.x.top =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb5-92">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.title.y.right =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>()</span>
<span id="cb5-93">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-94">  ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(</span>
<span id="cb5-95">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Shots from 2016/17 &amp; 2017/18 seasons'</span>,</span>
<span id="cb5-96">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb5-97">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Outperformance (= G/xG)'</span></span>
<span id="cb5-98">  )</span>
<span id="cb5-99"></span>
<span id="cb5-100">proj_dir <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'posts/xg-ratio-empirical-bayes'</span></span>
<span id="cb5-101">plot_path <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(proj_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shaw-figure-1-replication.png'</span>)</span>
<span id="cb5-102">ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(</span>
<span id="cb5-103">  adj_ratio_plot,</span>
<span id="cb5-104">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">filename =</span> plot_path,</span>
<span id="cb5-105">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">units =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'px'</span>,</span>
<span id="cb5-106">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">549</span>,</span>
<span id="cb5-107">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">640</span></span>
<span id="cb5-108">)</span>
<span id="cb5-109"></span>
<span id="cb5-110">orig_image <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> magick<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">image_read</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(proj_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shaw-figure-1.png'</span>))</span>
<span id="cb5-111">replicated_image_with_asa_logo <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> magick<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">image_read</span>(plot_with_asa_logo_path)</span>
<span id="cb5-112">combined_image_with_tony_logo <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> magick<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">image_append</span>(</span>
<span id="cb5-113">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(orig_image, replicated_image_with_tony_logo), </span>
<span id="cb5-114">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">stack =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span></span>
<span id="cb5-115">)</span>
<span id="cb5-116"></span>
<span id="cb5-117">magick<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">image_write</span>(</span>
<span id="cb5-118">  combined_image_with_tony_logo, </span>
<span id="cb5-119">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">path =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(proj_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'shaw-figure-1-compared-w-tony-logo.png'</span>)</span>
<span id="cb5-120">)</span></code></pre></div>
</details>
</div>
<p><img src="https://tonyelhabr.rbind.io/posts/xg-ratio-empirical-bayes/shaw-figure-1-compared-w-tony-logo.png" class="img-fluid"></p>
</section>
<section id="beyond-replication" class="level3">
<h3 class="anchored" data-anchor-id="beyond-replication">Beyond Replication</h3>
<p>For the sake of having a pretty plot that’s not just an attempt to replicate the original, let’s run it all back, this time with EPL 2021/22 and 2022/23 data.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">raw_shots <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> worldfootballR<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">load_understat_league_shots</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">league =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'EPL'</span>)</span>
<span id="cb6-2">shots <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> raw_shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-3">  tibble<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-4">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(</span>
<span id="cb6-5">    season <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(2021L, 2022L),</span>
<span id="cb6-6">    situation <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'DirectFreeKick'</span></span>
<span id="cb6-7">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-8">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(id) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-9">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">transmute</span>(</span>
<span id="cb6-10">    id,</span>
<span id="cb6-11">    player,</span>
<span id="cb6-12">    <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## since 2022/23, xG is filled out, not x_g</span></span>
<span id="cb6-13">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xg =</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coalesce</span>(x_g, xG),</span>
<span id="cb6-14">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">g =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.integer</span>(result <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Goal'</span>)</span>
<span id="cb6-15">  )</span>
<span id="cb6-16"></span>
<span id="cb6-17">shots_by_player <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-18">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(player) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-19">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(</span>
<span id="cb6-20">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shots =</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>(),</span>
<span id="cb6-21">    dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(g, xg), sum)</span>
<span id="cb6-22">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-23">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-24">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">raw_ratio =</span> g <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> xg) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-25">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">desc</span>(shots))</span>
<span id="cb6-26">shots_by_player</span>
<span id="cb6-27"></span>
<span id="cb6-28">shots_by_player<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>adj_ratio <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> purrr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map2</span>(</span>
<span id="cb6-29">  shots_by_player<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>g, shots_by_player<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>xg,</span>
<span id="cb6-30">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(g, xg) {</span>
<span id="cb6-31">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">simulate_gamma_posterior</span>(</span>
<span id="cb6-32">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">successes =</span> g,</span>
<span id="cb6-33">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">trials =</span> xg,</span>
<span id="cb6-34">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prior_shape =</span> prior_shape,</span>
<span id="cb6-35">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prior_rate =</span> prior_rate</span>
<span id="cb6-36">    )</span>
<span id="cb6-37">  }</span>
<span id="cb6-38">)</span>
<span id="cb6-39"></span>
<span id="cb6-40">adj_ratio_by_player <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> shots_by_player <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-41">  tidyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest_wider</span>(</span>
<span id="cb6-42">    adj_ratio, </span>
<span id="cb6-43">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_sep =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'_'</span></span>
<span id="cb6-44">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-45">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">desc</span>(adj_ratio_mean))</span>
<span id="cb6-46"></span>
<span id="cb6-47">ordinal_adj_ratio_by_player <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> adj_ratio_by_player <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb6-48">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(</span>
<span id="cb6-49">    player <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(shaw_players)</span>
<span id="cb6-50">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-51">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb6-52">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">player =</span> forcats<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_reorder</span>(shaw_players[player], adj_ratio_mean)</span>
<span id="cb6-53">  )</span>
<span id="cb6-54"></span>
<span id="cb6-55"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(htmltools)</span>
<span id="cb6-56"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(sysfonts)</span>
<span id="cb6-57"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(showtext)</span>
<span id="cb6-58"></span>
<span id="cb6-59">blackish_background <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'#1f1f1f'</span></span>
<span id="cb6-60">font <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Titillium Web'</span></span>
<span id="cb6-61">sysfonts<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">font_add_google</span>(font, font)</span>
<span id="cb6-62">sysfonts<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">font_add</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fb'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Font Awesome 6 Brands-Regular-400.otf'</span>)</span>
<span id="cb6-63">showtext<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">showtext_auto</span>()</span>
<span id="cb6-64">plot_resolution <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span></span>
<span id="cb6-65">showtext<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">showtext_opts</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dpi =</span> plot_resolution)</span>
<span id="cb6-66"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## https://github.com/tashapiro/tanya-data-viz/blob/1dfad735bca1a7f335969f0eafc94cf971345075/nba-shot-chart/nba-shots.R#L64</span></span>
<span id="cb6-67"></span>
<span id="cb6-68">tag_lab <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> htmltools<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tagList</span>(</span>
<span id="cb6-69">  htmltools<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>tags<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">span</span>(htmltools<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">HTML</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">enc2utf8</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&amp;#xf099;"</span>)), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">style=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'font-family:fb'</span>),</span>
<span id="cb6-70">  htmltools<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>tags<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">span</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"@TonyElHabr"</span>),</span>
<span id="cb6-71">)</span>
<span id="cb6-72"></span>
<span id="cb6-73">beyond_replication_adj_ratio_plot <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> ordinal_adj_ratio_by_player <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb6-74">  ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-75">  ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> player) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-76">  ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(</span>
<span id="cb6-77">    ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), </span>
<span id="cb6-78">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>,</span>
<span id="cb6-79">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,</span>
<span id="cb6-80">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'white'</span></span>
<span id="cb6-81">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-82">  ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_errorbarh</span>(</span>
<span id="cb6-83">    ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(</span>
<span id="cb6-84">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmin =</span> adj_ratio_mean <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> adj_ratio_sd,</span>
<span id="cb6-85">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmax =</span> adj_ratio_mean <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> adj_ratio_sd</span>
<span id="cb6-86">    ),</span>
<span id="cb6-87">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'white'</span>,</span>
<span id="cb6-88">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span></span>
<span id="cb6-89">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-90">  ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(</span>
<span id="cb6-91">    ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> adj_ratio_mean, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> shots),</span>
<span id="cb6-92">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'white'</span></span>
<span id="cb6-93">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-94">  ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-95">  ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(</span>
<span id="cb6-96">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">text =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> font, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'white'</span>),</span>
<span id="cb6-97">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'white'</span>),</span>
<span id="cb6-98">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.title =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bold'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'white'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>),</span>
<span id="cb6-99">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.title.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'plot'</span>,</span>
<span id="cb6-100">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.subtitle =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'white'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>),</span>
<span id="cb6-101">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.margin =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">margin</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>),</span>
<span id="cb6-102">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.caption =</span> ggtext<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_markdown</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'white'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'plain'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lineheight =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span>),</span>
<span id="cb6-103">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.caption.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'plot'</span>,</span>
<span id="cb6-104">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.tag =</span> ggtext<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_markdown</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'white'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb6-105">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.tag.position =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.99</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>),</span>
<span id="cb6-106">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid.major.y =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb6-107">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid.minor.x =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb6-108">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid.major.x =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_line</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>),</span>
<span id="cb6-109">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.background =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_rect</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> blackish_background, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> blackish_background),</span>
<span id="cb6-110">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.background =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_rect</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> blackish_background, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> blackish_background),</span>
<span id="cb6-111">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.title =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'white'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">face =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bold'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.99</span>),</span>
<span id="cb6-112">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.line =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb6-113">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'white'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>),</span>
<span id="cb6-114">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.y =</span> ggtext<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_markdown</span>(),</span>
<span id="cb6-115">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.text =</span> ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'white'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>),</span>
<span id="cb6-116">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'top'</span></span>
<span id="cb6-117">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-118">  ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(</span>
<span id="cb6-119">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Top 20 shooting overperformers in the EPL'</span>,</span>
<span id="cb6-120">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'EPL 2021/22 and 2022/23 seasons. '</span>,</span>
<span id="cb6-121">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">caption =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Players sorted according to descending adjusted G/xG ratio. Minimum 100 shots.&lt;br/&gt;**Source**: understat.'</span>,</span>
<span id="cb6-122">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb6-123">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Adjusted G/xG Ratio'</span>,</span>
<span id="cb6-124">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tag =</span> tag_lab</span>
<span id="cb6-125">  )</span>
<span id="cb6-126"></span>
<span id="cb6-127">beyond_replication_plot_path <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(proj_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'beyond-replication.png'</span>)</span>
<span id="cb6-128">ggplot2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(</span>
<span id="cb6-129">  beyond_replication_adj_ratio_plot,</span>
<span id="cb6-130">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">filename =</span> beyond_replication_plot_path,</span>
<span id="cb6-131">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>,</span>
<span id="cb6-132">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span></span>
<span id="cb6-133">)</span></code></pre></div>
</details>
</div>
<p><img src="https://tonyelhabr.rbind.io/posts/xg-ratio-empirical-bayes/beyond-replication.png" class="img-fluid"></p>
<p>For those who follow the EPL, The usual suspects, like Heung-Min Son, show up among the best of the best HERE. The adjusted mean minus one standard deviation value exceeds zero for Son, so one might say that he was a significantly skilled shooter over the past two season.<sup>9</sup></p>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>Having not seen a very clear example of Gamma-Prior EB implementation on the internet–although there are several good explanations with toy examples such as <a href="https://vioshyvo.github.io/Bayesian_inference/conjugate-distributions.html">this e-book chapter from Hyvönen and Topias Tolonen</a>–I hope I’ve perhaps un-muddied the waters for at least one interested reader.</p>
<p>As for the actual application of <img src="https://latex.codecogs.com/png.latex?G%20/%20xG"> for evaluating shooting performance, I have mixed feelings about it. Further analysis shows that it has zero year-over-year stability, i.e.&nbsp;one shouldn’t use a player’s raw or adjusted G/xG ratio in one season to try to predict whether their outperformance ratio will sustain in the next season. On the other hand, by simply making player estimates more comparable, the EB adjustment of <img src="https://latex.codecogs.com/png.latex?O_p"> certainly is an improvement over raw <img src="https://latex.codecogs.com/png.latex?G%20/%20xG"> itself.</p>
<p>Comparing hypothetical player A with 6 goals on 2 xG (<img src="https://latex.codecogs.com/png.latex?O_p%20=%203">) vs.&nbsp;player B with 120 goals on 100 xG directly (<img src="https://latex.codecogs.com/png.latex?O_p%20=%201.2">) is unfair; the former could be performing at an unsustainable rate, while the latter has demonstrated sustained overperformance over a lot more time. Indeed, applying the EB adjustment to these hypothetical numbers, player A’s <img src="https://latex.codecogs.com/png.latex?O_p"> would be shrunken back towards 1, and player B’s adjustment would be effectively nothing, indicating that player B’s shooting performance is stronger, on average.</p>



</section>


<div class="quarto-listing quarto-listing-container-default" id="listing-listing">
<div class="list quarto-listing-default">

</div>
<div class="listing-no-matching d-none">
No matching items
</div>
</div><div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>This <a href="https://en.wikipedia.org/wiki/Conjugate_prior">conjugate distribution table</a> might be handy for those curious to know which distributions are typically paired together for empirical Bayes estimation.↩︎</p></li>
<li id="fn2"><p>If you’ve seen my work, you might have noticed that I’ve used Beta-Binomial EB a few times for public projects in the past:</p>
<ol type="1">
<li><a href="https://twitter.com/TonyElHabr/status/1457377069957107715?s=20">to estimate the proportion of direct free kick shots on target (soccer), grouped by league</a></li>
<li><a href="https://twitter.com/TonyElHabr/status/1429610210964955137?s=20">to adjust Whataburger Yelp reviews for small sample sizes</a></li>
</ol>
↩︎</li>
<li id="fn3"><p>Note that understat maintains its own xG model, so the xG on understat won’t exactly match what you might get from <a href="https://www.statsperform.com/opta/">Opta</a> or <a href="https://statsbomb.com/">StatsBomb</a>.↩︎</p></li>
<li id="fn4"><p><a href="https://fbref.com/en/expected-goals-model-explained/">FBRef</a> only provides expected goals dating back to the 2017/18 season, so unfortunately it’s not viable for this analysis.↩︎</p></li>
<li id="fn5"><p>The other major reason why I may not be able to match his results is if I’ve implemented the Gamma-Poisson adjustment in a different (hopefully, not incorrect 😅) manner.↩︎</p></li>
<li id="fn6"><p>In <a href="https://en.wikipedia.org/wiki/Gamma_distribution">the wild</a>, you’ll see <code>alpha</code> and <code>beta</code> used to describe the hyperparameters. <code>shape</code> and <code>rate</code> are different ways of framing these parameters.↩︎</p></li>
<li id="fn7"><p>Note that this process of selecting priors is the “twist” I mentioned in the introduction that really separates empirical Bayes estimation from a traditional, full Bayesian approach. In the latter, one chooses priors for an analysis without using the data to be included in the analysis.↩︎</p></li>
<li id="fn8"><p>This post isn’t meant to be about uncertainty and credible intervals for EB adjusted means, so I won’t go into it here. Loosely, one can read the interval as quantifying the bound about which we can be confident that the true estimate lands. Uncertainty intervals that overlap with 1 broadly suggest that, even though the mean estimate may look to be much greater or less than 1, we cannot say the difference is significant from the “average” (of 1).↩︎</p></li>
<li id="fn9"><p>A more strict and, arguably, correct measure is a 90 or 95% credible interval to ascertain “significance”. Nonetheless, to maintain consistency with Shaw, I’m showing standard deviation.↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>r</category>
  <category>soccer</category>
  <guid>https://tonyelhabr.rbind.io/posts/xg-ratio-empirical-bayes/index.html</guid>
  <pubDate>Mon, 28 Aug 2023 05:00:00 GMT</pubDate>
  <media:content url="https://tonyelhabr.rbind.io/posts/xg-ratio-empirical-bayes/beyond-replication.png" medium="image" type="image/png" height="144" width="144"/>
</item>
<item>
  <title>xG Model Calibration</title>
  <dc:creator>Tony ElHabr</dc:creator>
  <link>https://tonyelhabr.rbind.io/posts/opta-xg-model-calibration/index.html</link>
  <description><![CDATA[ 



<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>Recently, <a href="https://twitter.com/TonyElHabr/status/1614288983105617922">I pointed out</a> what seemed to be a bug with the <a href="https://theanalyst.com/na/2021/07/what-are-expected-goals-xg/">expected goals (xG)</a> data shown on <a href="https://fbref.com">FBref</a>. In particular, the difference between non-penalty goals (npG) and non-penalty xG (npxG)<sup>1</sup> seemed to be an outlier for the 2021/22 season across <a href="https://fbref.com/en/comps/Big5/Big-5-European-Leagues-Stats">the Big 5 leagues</a>.</p>
<blockquote class="twitter-tweet blockquote">
<p lang="en" dir="ltr">
</p><p>“aLl xG mOdeLs ArE thE sAme”<br><br>my brother in christ wut is this then <a href="https://t.co/7tjp1VFkoc">pic.twitter.com/7tjp1VFkoc</a></p>
<p></p>
<p>— Tony (<span class="citation" data-cites="TonyElHabr">@TonyElHabr</span>) <a href="https://twitter.com/TonyElHabr/status/1614288983105617922?ref_src=twsrc%5Etfw">January 14, 2023</a></p>
</blockquote>
<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<p>As it turns out FBref and their data provider, <a href="https://www.statsperform.com/opta/">Opta</a>, agreed! On Feb.&nbsp;8, 2023, <a href="https://twitter.com/fbref/status/1623358271791722502?s=20">they posted an update</a> indicating that they adjusted their 2021/22 xG such that the difference between npG and npxG is much more in line with other seasons.</p>
<p>The FBref/Opta update gave me two ideas:</p>
<ol type="1">
<li><p><strong>Compare pre- and post-update xG</strong> to identify where/how adjustments were applied. Where were the “blind spot(s)”?<sup>2</sup></p></li>
<li><p><strong>Quantify the <a href="https://en.wikipedia.org/wiki/Calibration_(statistics)">calibration</a> of their xG model.</strong> Are there obvious weak points with the model?</p></li>
</ol>
</section>
<section id="pre--and-post-update-xg-comparison" class="level2">
<h2 class="anchored" data-anchor-id="pre--and-post-update-xg-comparison">1. Pre- and post-update xG comparison</h2>
<p>First, let’s take a wholistic look at all of the shots for the 2021/22 seasons played in Big 5 leagues.</p>
<p><img src="https://tonyelhabr.rbind.io/posts/opta-xg-model-calibration/old_vs_new_xg.png" class="img-fluid"></p>
<p>Of the 44,986 shots in the data set, 30,326 (67.2%) had changes to their xG values.<sup>3</sup> Of those that changed, 23, 584 (78.0%) were reduced, i.e.&nbsp;the pre-update xG value was higher. The average change was pretty minimal, just about ~0.01 xG.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glimpse</span>(discretized_updated_np_shots)</span>
<span id="cb1-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; Rows: 44,986</span></span>
<span id="cb1-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; Columns: 16</span></span>
<span id="cb1-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ league             &lt;fct&gt; ENG, ENG, ENG, ENG, ENG, ENG, ENG, ENG, ENG, ENG, E…</span></span>
<span id="cb1-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ date               &lt;date&gt; 2021-08-13, 2021-08-13, 2021-08-13, 2021-08-13, 20…</span></span>
<span id="cb1-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ half               &lt;dbl&gt; 1, 1, 1, 1, 1, 2, 2, 2, 1, 1, 1, 1, 1, 1, 1, 2, 2, …</span></span>
<span id="cb1-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ minute             &lt;chr&gt; "11", "12", "22", "28", "30", "66", "73", "80", "2"…</span></span>
<span id="cb1-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ team               &lt;chr&gt; "Brentford", "Brentford", "Brentford", "Brentford",…</span></span>
<span id="cb1-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ player             &lt;chr&gt; "Frank Onyeka", "Bryan Mbeumo", "Sergi Canós", "Ser…</span></span>
<span id="cb1-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ new_xg             &lt;dbl&gt; 0.08, 0.09, 0.02, 0.06, 0.26, 0.06, 0.40, 0.28, 0.0…</span></span>
<span id="cb1-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ old_xg             &lt;dbl&gt; 0.09, 0.14, 0.04, 0.07, 0.31, 0.13, 0.58, 0.27, 0.0…</span></span>
<span id="cb1-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ is_goal            &lt;fct&gt; no, no, yes, no, no, no, yes, no, no, no, no, no, n…</span></span>
<span id="cb1-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ distance           &lt;fct&gt; "(8,10]", "(12,14]", "(16,18]", "(20,25]", "(12,14]…</span></span>
<span id="cb1-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ sca1               &lt;fct&gt; pass_live, pass_live, pass_live, pass_live, take_on…</span></span>
<span id="cb1-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ body_part          &lt;fct&gt; Head, Right Foot, Right Foot, Right Foot, Right Foo…</span></span>
<span id="cb1-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ is_from_deflection &lt;fct&gt; no, no, no, no, no, no, no, no, no, no, no, no, no,…</span></span>
<span id="cb1-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ is_from_volley     &lt;fct&gt; no, no, no, no, no, no, no, no, no, yes, no, no, no…</span></span>
<span id="cb1-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ is_free_kick       &lt;fct&gt; no, no, no, no, no, no, no, no, no, no, no, no, no,…</span></span>
<span id="cb1-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; $ is_primary_foot    &lt;fct&gt; missing, no, yes, yes, no, yes, missing, missing, y…</span></span>
<span id="cb1-20"></span>
<span id="cb1-21">discretized_updated_np_shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xgd =</span> old_xg <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> new_xg) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pull</span>(xgd) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>()</span>
<span id="cb1-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [1] 0.0095014</span></span></code></pre></div>
</details>
</div>
<p>To get more insight into how/why xG changed, we can look at changes to xG values grouped by various <code>feature</code>s that we can derive from data that FBref publishes alongside each shot’s xG, including <code>distance</code> (yards), <code>sca1</code> (first <a href="https://www.sports-reference.com/blog/2020/04/goal-creation-possession-passing-and-more-advanced-stats-on-fbref/">shot-creating action</a>), <code>body_part</code>, <code>is_from_deflection</code>, <code>is_from_volley</code>, <code>is_free_kick</code>, and <code>is_primary_foot</code>.<sup>4</sup><sup>5</sup></p>
<p>The table below shows that the reductions in npxG occurred most frequently for longer <code>distance</code>s, suggesting that the pre-update xG model was over-predicting xG for longer shots. Interestingly, xG for shots when interceptions were the shot-creating action that led directly to the shot, and xG for shots with <code>body_part = "other"</code> (non-foot, non-header) were also frequently reduced, in the cases where xG was changed.</p>
<table class="table">
<colgroup>
<col style="width: 8%">
<col style="width: 12%">
<col style="width: 16%">
<col style="width: 20%">
<col style="width: 42%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Feature</th>
<th style="text-align: left;">Group</th>
<th style="text-align: right;"># of non-penalty shots</th>
<th style="text-align: right;"># of shots with changed npxG</th>
<th style="text-align: right;"># of shots with lower post-update npxG of those that changed</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>distance</code></td>
<td style="text-align: left;"><code>(25,30]</code></td>
<td style="text-align: right;">6,061</td>
<td style="text-align: right;">3,659 (60.4%)</td>
<td style="text-align: right;">3,437 (93.9%)</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>distance</code></td>
<td style="text-align: left;"><code>(20,25]</code></td>
<td style="text-align: right;">6,760</td>
<td style="text-align: right;">4,463 (66.0%)</td>
<td style="text-align: right;">4,088 (91.6%)</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>sca1</code></td>
<td style="text-align: left;"><code>"interception"</code></td>
<td style="text-align: right;">149</td>
<td style="text-align: right;">96 (64.4%)</td>
<td style="text-align: right;">87 (90.6%)</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>distance</code></td>
<td style="text-align: left;"><code>(18,20]</code></td>
<td style="text-align: right;">1,889</td>
<td style="text-align: right;">1,232 (65.2%)</td>
<td style="text-align: right;">1,088 (88.3%)</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>distance</code></td>
<td style="text-align: left;"><code>(30,35]</code></td>
<td style="text-align: right;">2,725</td>
<td style="text-align: right;">1,267 (46.5%)</td>
<td style="text-align: right;">1,117 (88.2%)</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>body_part</code></td>
<td style="text-align: left;"><code>"Other"</code></td>
<td style="text-align: right;">191</td>
<td style="text-align: right;">153 (80.1%)</td>
<td style="text-align: right;">130 (85.0%)</td>
</tr>
</tbody>
</table>
<p>On the other end of the spectrum, reductions in npxG occurred least frequently for shorter <code>distance</code> buckets (<code>(0,2]</code>, <code>(2,4]</code>, <code>(4,6]</code>, <code>(6,8)</code>). Reductions still occurred a majority of the time when there was a change—note that each has <code>&gt;50%</code> for the last column—for all but the shortest <code>distance</code> group, <code>(0,2]</code>.</p>
<table class="table">
<colgroup>
<col style="width: 10%">
<col style="width: 8%">
<col style="width: 17%">
<col style="width: 21%">
<col style="width: 42%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Feature</th>
<th style="text-align: left;">Group</th>
<th style="text-align: right;"># of non-penalty shots</th>
<th style="text-align: right;"># of shots with changed npxG</th>
<th style="text-align: right;"># of shots with lower post-update npxG of those that changed</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>distance</code></td>
<td style="text-align: left;"><code>(0,2]</code></td>
<td style="text-align: right;">173</td>
<td style="text-align: right;">130 (75.1%)</td>
<td style="text-align: right;">51 (39.2%)</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>distance</code></td>
<td style="text-align: left;"><code>(2,4]</code></td>
<td style="text-align: right;">1,087</td>
<td style="text-align: right;">826 (76.0%)</td>
<td style="text-align: right;">428 (51.8%)</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>distance</code></td>
<td style="text-align: left;"><code>(4,6]</code></td>
<td style="text-align: right;">2,003</td>
<td style="text-align: right;">1,479 (73.8%)</td>
<td style="text-align: right;">831 (56.2%)</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>distance</code></td>
<td style="text-align: left;"><code>(35,Inf]</code></td>
<td style="text-align: right;">539</td>
<td style="text-align: right;">313 (58.1%)</td>
<td style="text-align: right;">177 (56.5%)</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>distance</code></td>
<td style="text-align: left;"><code>(6,8]</code></td>
<td style="text-align: right;">2,557</td>
<td style="text-align: right;">1,882 (73.6%)</td>
<td style="text-align: right;">1,183 (62.9%)</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>is_free_kick</code></td>
<td style="text-align: left;"><code>"yes"</code></td>
<td style="text-align: right;">1,576</td>
<td style="text-align: right;">882 (56.0%)</td>
<td style="text-align: right;">557 (63.2%)</td>
</tr>
</tbody>
</table>
</section>
<section id="xg-model-calibration" class="level2">
<h2 class="anchored" data-anchor-id="xg-model-calibration">2. xG Model Calibration</h2>
<p><a href="../../posts/epl-xpts-simulation-1/#match-predictive-performance7">I’ve touched on model calibration before</a>, when discussing xG-implied match outcome probabilities. There, I wrote my own code to create a <a href="https://changhsinlee.com/python-calibration-plot/">calibration plot</a>. Since then, the <a href="https://www.tidymodels.org/"><code>{tidymodels}</code> team</a> has added <a href="https://www.tidyverse.org/blog/2022/11/model-calibration/">calibration plot functionality</a> to the <a href="https://probably.tidymodels.org/"><code>{probably}</code> package</a>. Let’s try it out.</p>
<p>Here, we’ll use a big sample of data—all 2017/18 - 2021/22 non-penalty shots for the Big 5 leagues and several other first and second tier leagues.<sup>6</sup></p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">np_shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">count</span>(league, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'n_shots'</span>)</span>
<span id="cb2-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 13 × 2</span></span>
<span id="cb2-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    league    n_shots</span></span>
<span id="cb2-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    &lt;chr&gt;       &lt;int&gt;</span></span>
<span id="cb2-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  1 BRA_1st_M   39380</span></span>
<span id="cb2-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  2 ENG_1st_F   11366</span></span>
<span id="cb2-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  3 ENG_1st_M   46766</span></span>
<span id="cb2-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  4 ENG_2nd_M   52701</span></span>
<span id="cb2-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  5 ESP_1st_M   43398</span></span>
<span id="cb2-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  6 FRA_1st_M   43021</span></span>
<span id="cb2-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  7 GER_1st_M   39148</span></span>
<span id="cb2-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  8 ITA_1st_M   49903</span></span>
<span id="cb2-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  9 MEX_1st_M   32650</span></span>
<span id="cb2-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 10 NED_1st_M   29803</span></span>
<span id="cb2-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 11 POR_1st_M   27366</span></span>
<span id="cb2-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 12 USA_1st_F    9887</span></span>
<span id="cb2-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 13 USA_1st_M   31047</span></span></code></pre></div>
</details>
</div>
<section id="calibration-plot" class="level3">
<h3 class="anchored" data-anchor-id="calibration-plot">Calibration plot</h3>
<p>We can use <code>probably::cal_plot_breaks()</code> to visually assess whether the observed rate of non-penalty goals (y-axis) is close to the predicted probability of goals (npxG, x-axis).<sup>7</sup> If the xG model’s predictions are “well calibrated”, the calibration points will align with the “ideal” line having slope 1 and intercept 0. Points at which the curve is below the diagonal line indicate where the model is more likelty to overpredict; and, likewise, points where the curve is above the diagonal line indicate where the model is underpredicting.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(probably) <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 0.1.0.9007</span></span>
<span id="cb3-2"></span>
<span id="cb3-3">overall_calibration <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cal_plot_breaks</span>(</span>
<span id="cb3-4">  np_shots,</span>
<span id="cb3-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">truth =</span> is_goal,</span>
<span id="cb3-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">estimate =</span> xg,</span>
<span id="cb3-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">num_breaks =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>,</span>
<span id="cb3-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">conf_level =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>,</span>
<span id="cb3-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">event_level =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'second'</span></span>
<span id="cb3-10">)</span></code></pre></div>
</details>
</div>
<p><img src="https://tonyelhabr.rbind.io/posts/opta-xg-model-calibration/overall_calibration.png" class="img-fluid"></p>
<p>We can see that the model is pretty well calibrated on the lower end of the spectrum, when xG &lt; 0.25. This makes up a larger majority of the shots (~90%). However, the model is not as well calibrated for higher xG values, tending to overpredict. For example, at the calibration point where npxG is <code>0.675</code>, the actual goal rate is <code>0.6</code>.</p>
<p>Observing the miscalibration for shots with xG &gt; 0.25, one has to wonder whether <a href="https://theanalyst.com/na/2022/04/evolving-expected-goals-xg/">the removal of the “big chance” feature</a> in favor of other contextual features—an update that Opta made sometime in the first half of 2022—may have (unintentionally) made the model worse in some ways.<sup>8</sup> Unfortunately, I didn’t have accessed to Opta xG data prior to that update, so I can’t evaluate this hypothesis. (For all we know, the model calibration for high xG shots might have been worse before!)</p>
</section>
<section id="brier-skill-score-bss" class="level3">
<h3 class="anchored" data-anchor-id="brier-skill-score-bss">Brier Skill Score (BSS)</h3>
<p>One thing that is not provided in the <code>{tidymodels}</code> realm (specifically, the <code>{yardstick}</code> package) is a function to compute <a href="https://en.wikipedia.org/wiki/Brier_score">Brier score</a>. Nonetheless, we can define a Brier score function ourselves by closely following <a href="https://www.tidymodels.org/learn/develop/metrics/">the mean squared error custom metric example</a> provided by the <code>{tidymodels}</code> team.<sup>9</sup></p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(yardstick)</span>
<span id="cb4-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(rlang)</span>
<span id="cb4-3">brier_score <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(data, ...) {</span>
<span id="cb4-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">UseMethod</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'brier_score'</span>)</span>
<span id="cb4-5">}</span>
<span id="cb4-6"></span>
<span id="cb4-7">brier_score <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> yardstick<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">new_prob_metric</span>(brier_score, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">direction =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'minimize'</span>)</span>
<span id="cb4-8"></span>
<span id="cb4-9">brier_score_vec <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(truth, estimate, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na_rm =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, event_level, ...) {</span>
<span id="cb4-10">  </span>
<span id="cb4-11">  brier_score_impl <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(truth, estimate, event_level, ...) {</span>
<span id="cb4-12">    truth <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(truth) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb4-13">    </span>
<span id="cb4-14">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (event_level <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'second'</span>) {</span>
<span id="cb4-15">      truth <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> truth</span>
<span id="cb4-16">    }</span>
<span id="cb4-17">    </span>
<span id="cb4-18">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>((truth <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> estimate)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb4-19">  }</span>
<span id="cb4-20">  </span>
<span id="cb4-21">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Recycle the estimate value if it's scalar-ish.</span></span>
<span id="cb4-22">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(estimate) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) {</span>
<span id="cb4-23">    estimate <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(estimate, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(truth))</span>
<span id="cb4-24">  }</span>
<span id="cb4-25">  </span>
<span id="cb4-26">  yardstick<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">metric_vec_template</span>(</span>
<span id="cb4-27">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metric_impl =</span> brier_score_impl,</span>
<span id="cb4-28">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">truth =</span> truth,</span>
<span id="cb4-29">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">estimate =</span> estimate,</span>
<span id="cb4-30">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na_rm =</span> na_rm,</span>
<span id="cb4-31">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cls =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'factor'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'numeric'</span>),</span>
<span id="cb4-32">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">estimator =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'binary'</span>,</span>
<span id="cb4-33">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">event_level =</span> event_level,</span>
<span id="cb4-34">    ...</span>
<span id="cb4-35">  )</span>
<span id="cb4-36">}</span>
<span id="cb4-37"></span>
<span id="cb4-38">brier_score.data.frame <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(data, truth, estimate, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na_rm =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">event_level =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'first'</span>, ...) {</span>
<span id="cb4-39">  yardstick<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">metric_summarizer</span>(</span>
<span id="cb4-40">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metric_nm =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'brier_score'</span>,</span>
<span id="cb4-41">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metric_fn =</span> brier_score_vec,</span>
<span id="cb4-42">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> data,</span>
<span id="cb4-43">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">truth =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!!</span>rlang<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">enquo</span>(truth),</span>
<span id="cb4-44">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">estimate =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!!</span>rlang<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">enquo</span>(estimate),</span>
<span id="cb4-45">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na_rm =</span> na_rm,</span>
<span id="cb4-46">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">event_level =</span> event_level,</span>
<span id="cb4-47">    ...</span>
<span id="cb4-48">  )</span>
<span id="cb4-49">}</span></code></pre></div>
</details>
</div>
<p>Let’s compute the Brier scores for (1) the overall goal rate (i.e.&nbsp;shots per goal) and (2) xG. We should expect the Brier score for the latter to be closer to 0 (perfect model), since xG should be a better predictor of goals than the naive goal rate.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">np_goal_rate <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> np_shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">count</span>(is_goal) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prop =</span> n <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(n)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(is_goal <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'yes'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pull</span>(prop)</span>
<span id="cb5-6">np_goal_rate</span>
<span id="cb5-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 0.0960288</span></span>
<span id="cb5-8"></span>
<span id="cb5-9">np_goal_rate_brier_score <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> np_shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brier_score</span>(</span>
<span id="cb5-11">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">truth =</span> is_goal,</span>
<span id="cb5-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">estimate =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!!</span>np_goal_rate,</span>
<span id="cb5-13">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">event_level =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'second'</span></span>
<span id="cb5-14">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pull</span>(.estimate)</span>
<span id="cb5-16">np_goal_rate_brier_score</span>
<span id="cb5-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [1] 0.08680727</span></span>
<span id="cb5-18"></span>
<span id="cb5-19">npxg_brier_score <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> np_shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brier_score</span>(</span>
<span id="cb5-21">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">truth =</span> is_goal,</span>
<span id="cb5-22">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">estimate =</span> xg,</span>
<span id="cb5-23">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">event_level =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'second'</span></span>
<span id="cb5-24">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pull</span>(.estimate)</span>
<span id="cb5-26">npxg_brier_score</span>
<span id="cb5-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [1] 0.07150071</span></span></code></pre></div>
</details>
</div>
<p>Now we can go on to compute <a href="https://en.wikipedia.org/wiki/Brier_score#Brier_Skill_Score_(BSS)">Brier skill score (BSS)</a> using an appropriate reference Brier score.<sup>10</sup> In this context, the average goal rate seems to be a good choice for a baseline. In contrast to the Brier score, a higher BSS is ideal. (A perfect model would have a BSS of 1.)</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> (npxg_brier_score <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> np_goal_rate_brier_score)</span>
<span id="cb6-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [1] 0.176328</span></span></code></pre></div>
</details>
</div>
<p>A BSS of ~0.18 is not bad! This is better than <a href="https://projects.fivethirtyeight.com/checking-our-work/">FiveThirtyEight’s BSS</a> for predicting the results for men’s World Cup matches (~0.12 at time of writing) and right around their BSS for predicting WNBA playoff game outcomes (~0.18).<sup>11</sup></p>
</section>
<section id="grouped-calibration-and-bss" class="level3">
<h3 class="anchored" data-anchor-id="grouped-calibration-and-bss">Grouped Calibration and BSS</h3>
<p>Now let’s take a look at model calibration under specific criteria. Is the model worse for shots that follow a dribble (<code>take_on</code>) shot-creating action? After a <code>live_ball</code> pass? etc.</p>
<p><img src="https://tonyelhabr.rbind.io/posts/opta-xg-model-calibration/sca1_calibration.png" class="img-fluid"></p>
<p>A couple of observations and thoughts:</p>
<ul>
<li><p>xG of shots following another shot are over-predicted so much that it causes the BSS to be negative.<sup>12</sup> This means that the model is actually doing worse in its xG assignment than simply predicting naive goal rate for shots after another shot!</p></li>
<li><p>A relatively “jagged” calibration plot may not correspond with a worse (lower) BSS score; and visa versa, a relatively “smooth” calibration plot may not correspond with a better (higher) BSS.</p>
<ul>
<li>Note that the <code>fouled</code> calibration looks jagged for higher predicted xG, but the fact that goals are only scored on about 5% shots immediately following a foul means that inprecise probabilities are not “penalized” quite as much. On the other hand, while the <code>pass_live</code> calibration looks relatively smooth, the 10% goal rate following live ball passes (2x the frequency for shots following fouls) means that it is more penalized for imprecision than an otherwise equivalent post-<code>fouled</code> shot. In fact, this is <a href="https://en.wikipedia.org/wiki/Brier_score#Shortcomings">one of the shortcomings of BSS</a>—it does not do a great job with evaluation of relatively infrequent events.</li>
</ul></li>
</ul>
<p>Next, let’s take a look at calibration of shots coming after deflections (of other shots).</p>
<p><img src="https://tonyelhabr.rbind.io/posts/opta-xg-model-calibration/deflection_calibration.png" class="img-fluid"></p>
<ul>
<li>The model doesn’t seem to be very well calibrated for shots following deflections! Like shots following other shots in the shot-creating action calibration plot, the BSS for shots after deflections is negative. And, perhaps more interestingly, the model seems to underpredict post-deflection shots, which is the opposite of it’s general tendency to overpredict. (See the wholistic calibration plot from before.)
<ul>
<li>I’d suspect that there’s lots of confounders that might explain the lack of calibration after deflections. For one, it could be the case that there are often zero defenders between the shot-taker and keeper for shots following a deflection. As far as I know, the Opta model doesn’t have an explicit feature for this.</li>
<li>As with the overall model calibration, one has to wonder whether the model may have performed better on shots following deflections with the binary big chance feature.</li>
<li>The high goal rate on shots after deflections relative to the goal rate on all other shots certainly contributes to the negative BSS, as we saw earlier with shots following other shots.</li>
</ul></li>
</ul>
<p>Moving on, let’s look at calibration of the xG model by groups of leagues, splitting out by tier and gender.</p>
<p><img src="https://tonyelhabr.rbind.io/posts/opta-xg-model-calibration/league_group_calibration.png" class="img-fluid"></p>
<ul>
<li><a href="https://statsbomb.com/articles/soccer/analytics-and-modelling-in-womens-football/">StatsBomb has talked</a> about how a “gender-aware” model outperformed a baseline model, so one might expect the calibration of Opta’s singular model to be weaker for the women’s game. It turns out that while, yes, the calibration seems to be a bit worse for shots in the women’s leagues, the overall difference in model performance for men’s and women’s leagues seems to be trivial for the sample here.</li>
<li>Interestingly, the calibration of the model for non-Big 5 leagues and the English men’s Championship league are slightly better according to BSS, although the differences (both visually, with the calibration curve, and with BSS) are very minimal.</li>
</ul>
<p>Finally, let’s look at how footedness may play a role in model calibration. As far as I know, whether or not a footed shot is take by a player’s primary foot is not an input into the Opta model, so it may be particularly interesting to look at.</p>
<p><img src="https://tonyelhabr.rbind.io/posts/opta-xg-model-calibration/footedness_calibration.png" class="img-fluid"></p>
<ul>
<li>Despite my suspicion that xG for shots taken by a player’s weaker foot (<code>right foot shot, left-footed</code> and <code>left foot shot, right-footed</code>) might be severely overpredicted, this doesn’t really seem to be the case. Yes, the model tends to overpredict for these kinds of shots, but the degree to which overprediction occurs doesn’t seem out of line with the whole model.
<ul>
<li>I can think of least two types of “selection bias” at play here that might explain why the calibration isn’t as bad as I might have guessed for weak-footed shots:
<ol type="1">
<li>Players are more likely to take weak-footed shots when they’re closer to the goal, where shots are likely to have higher xG, but also where shots are more likely to go in.</li>
<li>Players are less likely to take more difficult shots with their weak foot, so they’re not taking as many shots that are unlikely to go in, holding all else equal.</li>
</ol></li>
</ul></li>
<li>Of the non-footed shots, it’s interesting to see that the BSS for headers and shots from <code>other</code> body parts are not particularly well calibrated. In fact, the latter has a negative BSS, indicating that we’d better off with a model that predicted the average goal rate for such shots.
<ul>
<li>A high goal rate on such shots compared to other types of shots seems to, once again, be the reason that BSS looks particularly bad here.</li>
</ul></li>
</ul>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>We’ve explored the wonderful world of model calibration, making friends with BSS and calibration curves in our investigation of a public xG model. Are BSS and calibration curves the be-all and end-all when it comes to model evaluation? Of course not! But they’re useful tools that may or may not be appropriate for your use case.</p>
<p>When it comes to the Opta xG model specifically, am I implying that the model is bad? Of course not (again)! Yes, faceted calibration curves and feature-specific BSS can make a model look bad, but we must keep in mind that there are trade-offs to be made with modeling. Fine-tuning a model to be more well calibrated under certain conditions, e.g.&nbsp;shots after deflections, may make other parts of the model worse! It’s all about trade-offs.</p>



</section>


<div class="quarto-listing quarto-listing-container-default" id="listing-listing">
<div class="list quarto-listing-default">

</div>
<div class="listing-no-matching d-none">
No matching items
</div>
</div><div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>It’s typically better to analyze expected goals after removing penalties since penalties can distort quantities, adding “noise” to an analysis.↩︎</p></li>
<li id="fn2"><p>FBref/Opta didn’t specify how they changed their xG model. Given how I observed very only trivial differences in the shot-level xG for prior seasons, it’s possible that they didn’t even change their model! There could have been some data issue specific to the 2021/22 season, that, when addressed, resulted in more plausible xG.↩︎</p></li>
<li id="fn3"><p>Observe that, for a large majority of shots, where xG is in the (0, 0.05] range, xG either did not change at all or only trivially changed. (See the blur of white points on the left-hand side of the plot.)↩︎</p></li>
<li id="fn4"><p>Several of these are not provided directly from the raw FBref tables. For example, <code>is_from_deflection</code> is derived from the <code>Notes</code> field in the FBref shot table. <code>is_primary_foot</code> is derived from collecting player footedness data and checking for a match with <code>body_part</code>.↩︎</p></li>
<li id="fn5"><p>Note that I use the term “feature” here, although this set of fields does not quite match the actual <a href="https://theanalyst.com/eu/2021/07/what-are-expected-goals-xg">inputs to the</a> <a href="https://fbref.com/en/expected-goals-model-explained/">Opta xG model</a>. While things like <code>distance</code> and <code>body_part</code> certainly are inputs to the model, we don’t have angle of the shot to the goal, and <code>is_primary_foot</code>—a field that I’ve added the feature set myself—isn’t one of the model inputs, as far as I’m aware.↩︎</p></li>
<li id="fn6"><p>Several leagues don’t have data available for all such seasons, which is reflected in the number of shots per league in <code>np_shots</code>.↩︎</p></li>
<li id="fn7"><p>I’ve written my own code to plot the calibration, but I imagine most users will be satisfied with the plot that <code>{probably}</code> will generate for you.↩︎</p></li>
<li id="fn8"><p>Thanks to a handful of people who reached out and made me aware of this, after I initially published this post. I’ve gone back and updated some wording.↩︎</p></li>
<li id="fn9"><p>Brier score for a binary classification task is equivalent to mean squared error.↩︎</p></li>
<li id="fn10"><p>Personally, I like to use BSS over other classification metrics like <a href="https://en.wikipedia.org/wiki/Receiver_operating_characteristic">ROC AUC</a> or Brier score alone. BSS is arguably the most interpretable probabilistic classification measure. Also, I like that you have to specify a reference with which to compare, which seems like good principle in general.↩︎</p></li>
<li id="fn11"><p>I’m perhaps comparing apples to oranges here for the sake of providing some additional context that might help interpretability. The truth is that BSS is only comparable among different tasks to the extent that the reference choice in each task is “uninformed” to the same degree. For example, I could have said that the baseline for goals per shot is 50% instead of the actual goal rate (about 10%). This would change the baseline brier score to 0.25, and would inflate the BSS to 0.71. On the other hand, a 50/50 baseline makes sense in other settings. In fact, that’s what FiveThirtyEight uses for match outcome BSS for various sports.↩︎</p></li>
<li id="fn12"><p>The reader may be wondering what the BSS would look like if I had used the Brier score of the goal rate grouped by each feature as the baseline for BSS, instead of the overall goal rate. In that case, all BSS’s would be positive, and the <code>fouled</code> BSS would actually be the lowest, as opposed to the highest! Perhaps this would better match intuition, given how the calibration curve for <code>fouled</code> looks like one of the worst here. I’m not strongly opposed to choosing the grouped goal rate as the baseline instead of the overall goal rate, if that’s what one so happens to believe is a better choice.↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>r</category>
  <category>soccer</category>
  <guid>https://tonyelhabr.rbind.io/posts/opta-xg-model-calibration/index.html</guid>
  <pubDate>Mon, 20 Feb 2023 06:00:00 GMT</pubDate>
  <media:content url="https://tonyelhabr.rbind.io/posts/opta-xg-model-calibration/footedness_calibration.png" medium="image" type="image/png" height="101" width="144"/>
</item>
<item>
  <title>What exactly is an “expected point”? (part 2)</title>
  <dc:creator>Tony ElHabr</dc:creator>
  <link>https://tonyelhabr.rbind.io/posts/epl-xpts-simulation-2/index.html</link>
  <description><![CDATA[ 



<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>I’ll be picking up where I left off in <a href="../../posts/epl-xpts-simulation-1">my last post</a>, so stop everything that you’re doing and go read that if you haven’t already. In this post we’ll do two things:</p>
<ol type="1">
<li><p>We’ll compare how well season-level expected goal difference (xGD), season-level xPts, and aggregated match-level xPts predict season-long points for a given team.</p></li>
<li><p>We’ll use the match-level probabilites to answer the questions “Which teams had the most unlikely placings in the table given the quality of all their shots across the season?” and “How unlikely were such placings?”</p></li>
</ol>
</section>
<section id="analysis" class="level2">
<h2 class="anchored" data-anchor-id="analysis">Analysis</h2>
<p>Before we start, we need to step back and retrieve data on the actual placings. We could theoretically calculate this from the shot data we already have. However, the logic for handling own goals is a little complicated. We’re probably better off using <code>worldfootballR::understat_league_match_results()</code>—which returns goals at the match-level—to calculate the table. <sup>1</sup></p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1">match_results <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2014</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2021</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map_dfr</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">understat_league_match_results</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'EPL'</span>, .x)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>()</span>
<span id="cb1-4"></span>
<span id="cb1-5">init_table <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> match_results <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">transmute</span>(</span>
<span id="cb1-7">    match_id,</span>
<span id="cb1-8">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(season, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_replace</span>(.x, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">/20'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'/'</span>)),</span>
<span id="cb1-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">date =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">strptime</span>(datetime, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'%Y-%m-%d %H:%M:%S'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tz =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'UTC'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">date</span>(),</span>
<span id="cb1-10">    home_team,</span>
<span id="cb1-11">    home_goals,</span>
<span id="cb1-12">    away_team,</span>
<span id="cb1-13">    away_goals</span>
<span id="cb1-14">  )</span>
<span id="cb1-15"></span>
<span id="cb1-16">table <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>(</span>
<span id="cb1-17">  init_table <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb1-18">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">is_home =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-19">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename_home_away_teams</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-20">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(season, team, opponent, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">goals =</span> home_goals, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">opponent_goals =</span> away_goals),</span>
<span id="cb1-21">  init_table <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-22">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">is_home =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-23">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename_home_away_teams</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-24">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(season, team, opponent, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">goals =</span> away_goals,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">opponent_goals =</span> home_goals)</span>
<span id="cb1-25">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-26">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb1-27">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pts =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(</span>
<span id="cb1-28">      goals <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> opponent_goals <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> 3L,</span>
<span id="cb1-29">      goals <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> opponent_goals <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> 0L,</span>
<span id="cb1-30">      <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> 1L</span>
<span id="cb1-31">    )</span>
<span id="cb1-32">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-33">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(season, team) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-34">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(goals, opponent_goals, pts), sum)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-35">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-36">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gd =</span> goals <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> opponent_goals) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-37">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(season, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">desc</span>(pts), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">desc</span>(gd)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-38">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(season) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-39">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rank =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">row_number</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">desc</span>(pts))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-40">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-41">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(season, rank)</span></code></pre></div>
</details>
</div>
<p>This data will help us contextualize predicted placings with actual placings.</p>
<section id="predicting-season-long-points" class="level3">
<h3 class="anchored" data-anchor-id="predicting-season-long-points">1. Predicting season-long points</h3>
<section id="with-season-long-xpts-and-xgd" class="level4">
<h4 class="anchored" data-anchor-id="with-season-long-xpts-and-xgd">With season-long xPts and xGD</h4>
<p>We start with the <code>all_raw_understat_xpts_by_match</code> variable from the prior post, adding the opponent’s expected goals to create a column for expected goal difference (<code>xgd</code>).</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">all_raw_understat_xpts_by_match_with_opponent <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> all_raw_understat_xpts_by_match <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb2-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inner_join</span>(</span>
<span id="cb2-3">    all_understat_shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">distinct</span>(match_id, season, date, team, opponent),</span>
<span id="cb2-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'season'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'date'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'team'</span>)</span>
<span id="cb2-5">  )</span>
<span id="cb2-6"></span>
<span id="cb2-7"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## we've already determined that the raw_xpts (provided directly by understat) </span></span>
<span id="cb2-8"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   is close to our calculated xpts, so we'll just use the raw_xpts.</span></span>
<span id="cb2-9">all_raw_understat_xpts_xgd_by_match <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> all_raw_understat_xpts_by_match_with_opponent <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb2-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(match_id, season, date, team, opponent, pts, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xpts =</span> raw_xpts, xg) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb2-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inner_join</span>(</span>
<span id="cb2-12">    all_raw_understat_xpts_by_match_with_opponent <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb2-13">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(match_id, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">opponent =</span> team, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">opponent_xg =</span> xg),</span>
<span id="cb2-14">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'match_id'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'opponent'</span>)</span>
<span id="cb2-15">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb2-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xgd =</span> xg <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> opponent_xg)</span></code></pre></div>
</details>
</div>
<p>Next, we aggregate up to the season-level.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">all_raw_understat_xpts_xgd_by_season <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> all_raw_understat_xpts_xgd_by_match <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(season, team) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(pts, xpts, xgd), sum)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(season) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xrank =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">row_number</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">desc</span>(xpts))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(season, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">desc</span>(pts), team)</span></code></pre></div>
</details>
</div>
<p>Finally, we compute RMSE and R squared, like we did in the last post.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">diagnose_season_feature <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(df, col) {</span>
<span id="cb4-2">  fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pts <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> df[[col]])</span>
<span id="cb4-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb4-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rmse =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">compute_rmse</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pts, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(fit)),</span>
<span id="cb4-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">r2 =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(fit)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>r.squared</span>
<span id="cb4-6">  )</span>
<span id="cb4-7">}</span>
<span id="cb4-8"></span>
<span id="cb4-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'xgd'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'xpts'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb4-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_names</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb4-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map_dfr</span>(</span>
<span id="cb4-12">    <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">diagnose_season_feature</span>(all_raw_understat_xpts_xgd_by_season, .x), </span>
<span id="cb4-13">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.id =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'feature'</span></span>
<span id="cb4-14">  )</span>
<span id="cb4-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 2 × 3</span></span>
<span id="cb4-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;   feature  rmse    r2</span></span>
<span id="cb4-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;   &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb4-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 1 xgd      7.33 0.831</span></span>
<span id="cb4-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 2 xpts     7.20 0.837</span></span></code></pre></div>
</details>
</div>
<p>As we should expect, a model using season-long xPts to predict final points outperforms one using season-long xGD as a feature, although maybe the difference between the two is smaller than we might have expected.</p>
</section>
<section id="with-match-level-outcome-probabilities" class="level4">
<h4 class="anchored" data-anchor-id="with-match-level-outcome-probabilities">With match-level outcome probabilities</h4>
<p>First, we use the full understat shot data set and the custom functions from the prior post to calculate xPts by match.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">all_understat_xpts_by_match <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> all_understat_shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">calculate_permuted_xg</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize_permuted_xg_by_match</span>()</span></code></pre></div>
</details>
</div>
<p>Next, the fun part: simulating match outcomes using the xG-implied match outcome probabilities. This is computationally intense, so we parallelize the calculation.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(parallel)</span>
<span id="cb6-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(future)</span>
<span id="cb6-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(furrr)</span>
<span id="cb6-4"></span>
<span id="cb6-5">understat_probs_by_match <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> all_understat_xpts_by_match <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(match_id, season, team, opponent, is_home, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">starts_with</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'prob'</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename_with</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_remove</span>(.x, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'^prob_'</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">starts_with</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'prob'</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(</span>
<span id="cb6-9">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(win, lose, draw),</span>
<span id="cb6-10">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'result'</span>,</span>
<span id="cb6-11">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'prob'</span></span>
<span id="cb6-12">  )</span>
<span id="cb6-13"></span>
<span id="cb6-14">simulate_season_xpts <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(...) {</span>
<span id="cb6-15">  sim_home_pts_by_match <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> understat_probs_by_match <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-16">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(is_home) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-17">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(team, season, match_id) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-18">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">slice_sample</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">weight_by =</span> prob) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-19">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb6-20">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb6-21">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pts =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(</span>
<span id="cb6-22">        result <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'win'</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> 3L,</span>
<span id="cb6-23">        result <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'lose'</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> 0L,</span>
<span id="cb6-24">        <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> 1L</span>
<span id="cb6-25">      )</span>
<span id="cb6-26">    )</span>
<span id="cb6-27">  </span>
<span id="cb6-28">  sim_pts_by_match <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>(</span>
<span id="cb6-29">    sim_home_pts_by_match <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(match_id, season, team, pts),</span>
<span id="cb6-30">    sim_home_pts_by_match <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-31">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">transmute</span>(</span>
<span id="cb6-32">        match_id,</span>
<span id="cb6-33">        season,</span>
<span id="cb6-34">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">team =</span> opponent,</span>
<span id="cb6-35">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pts =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(</span>
<span id="cb6-36">          result <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'win'</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> 0L,</span>
<span id="cb6-37">          result <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'lose'</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> 3L,</span>
<span id="cb6-38">          <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> 1L</span>
<span id="cb6-39">        )</span>
<span id="cb6-40">      )</span>
<span id="cb6-41">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-42">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(season, team) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-43">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(pts, sum)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-44">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>()</span>
<span id="cb6-45">  </span>
<span id="cb6-46">  sim_pts_by_match <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-47">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(season, team) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-48">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(pts, sum)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-49">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-50">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(season) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-51">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rank =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">row_number</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">desc</span>(pts))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-52">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-53">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(season, rank)</span>
<span id="cb6-54">}</span>
<span id="cb6-55"></span>
<span id="cb6-56">n_cores <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">detectCores</span>()</span>
<span id="cb6-57">cores_for_parallel <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ceiling</span>(n_cores <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)</span>
<span id="cb6-58"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plan</span>(</span>
<span id="cb6-59">  multisession,</span>
<span id="cb6-60">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">workers =</span> cores_for_parallel</span>
<span id="cb6-61">)</span>
<span id="cb6-62"></span>
<span id="cb6-63"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## set seed both prior to the future_map_dfr and in .options to guarantee determinstic results</span></span>
<span id="cb6-64"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb6-65">n_sims <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10000</span></span>
<span id="cb6-66">understat_sim_pts_by_season <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_names</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>n_sims) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-67">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">future_map_dfr</span>(</span>
<span id="cb6-68">    simulate_season_xpts, </span>
<span id="cb6-69">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.id =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'sim_idx'</span>, </span>
<span id="cb6-70">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.options =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">furrr_options</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seed =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb6-71">  )</span>
<span id="cb6-72"></span>
<span id="cb6-73"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## back to normal processing</span></span>
<span id="cb6-74"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plan</span>(sequential)</span></code></pre></div>
</details>
</div>
<p>Next, we aggregate the season-long points across simulations, calculating the relative proportion of simulations in which a given team ends up at a given rank.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">understat_sim_placings <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> understat_sim_pts_by_season <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb7-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(season, team, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xrank =</span> rank) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb7-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>(), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xpts =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(pts)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb7-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb7-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(season, team) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb7-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prop =</span> n <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(n)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb7-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>()</span></code></pre></div>
</details>
</div>
<p>Finally, we calculate the weighted average of expected points that a team ends up with, and run the same regression that we ran earlier with season-long xPts and xGD.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1">understat_sim_placings_agg <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> understat_sim_placings <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb8-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(season, team) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb8-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xpts =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(xpts <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> prop)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb8-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb8-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(season, team, xpts) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb8-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inner_join</span>(</span>
<span id="cb8-7">    all_raw_understat_xpts_xgd_by_season <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(season, team, pts),</span>
<span id="cb8-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'season'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'team'</span>)</span>
<span id="cb8-9">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb8-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(season, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">desc</span>(xpts))</span>
<span id="cb8-11"></span>
<span id="cb8-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">diagnose_season_feature</span>(understat_sim_placings_agg, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'xpts'</span>)</span>
<span id="cb8-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 1 × 2</span></span>
<span id="cb8-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    rmse    r2</span></span>
<span id="cb8-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;   &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb8-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 1  7.16 0.839</span></span></code></pre></div>
</details>
</div>
<p>Interestingly, the RMSE and R squared values are almost identical to those for the season-long xPts. Perhaps this is not too surprising—match-level outcome probabilities simulated and averaged to arrive at a singular estimate of season-long xPts should give us something very close to just computing season-long xPts directly.</p>
<p>While the null result may be discouraging, the simulations are useful in and of themselves. They can be used to understand the distribution of outcomes for team in a given season, as seen in the table below.<sup>2</sup></p>
<p><img src="https://tonyelhabr.rbind.io/posts/epl-xpts-simulation-2/sim_placings.png" class="img-fluid"></p>
<p>We can see that Leicester, Wolves, and Newcastle all placed at the uppper end of their simulated placings, indicating that they over-achieved relative to expectation; on the other hand, Crystal Palace, Brentford, and Leeds placed on the lower end of the distribution of placings, indicating that they under-achieved.</p>
<p>In fact, we can go beyond simple observational judgement of whether teams over- and under-achieved—we can use the relative proportion of simulations where a team ends up at a given placing (or “rank”) in the standings to quantify just how unexpected actual end-of-season placings were.</p>
</section>
</section>
<section id="identifying-un-expected-placings" class="level3">
<h3 class="anchored" data-anchor-id="identifying-un-expected-placings">2. Identifying un-expected placings</h3>
<p>First, we join the <code>table</code> of end-of-season placements (<code>actual_rank</code>) to the simulation results that describe the frequency with which a given team places at a given rank (<code>xrank</code>).</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">understat_sim_placings_with_actual_ranks <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> understat_sim_placings <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb9-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inner_join</span>(</span>
<span id="cb9-3">    table <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(season, team, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">actual_pts =</span> pts, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">actual_rank =</span> rank),</span>
<span id="cb9-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'season'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'team'</span>)</span>
<span id="cb9-5">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb9-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inner_join</span>(</span>
<span id="cb9-7">    all_raw_understat_xpts_xgd_by_season <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb9-8">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(season, team, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">actual_xpts =</span> xpts, xgd),</span>
<span id="cb9-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'season'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'team'</span>)</span>
<span id="cb9-10">  )</span></code></pre></div>
</details>
</div>
<p>Finally, to identify over-achieving teams, we find the teams that had the lowest cumulative probability of placing at their actual placing or better; and to identify under-achieving teams, we find the teams with the lowest cumulative probability of placing at their actual placing or worse.</p>
<p><img src="https://tonyelhabr.rbind.io/posts/epl-xpts-simulation-2/unexpected.png" class="img-fluid"></p>
<p>This table certainly passes the eye test. Brighton’s sixteenth place finish in the 2020/21 season was discussed ad nauseum in the analytics sphere. Brighton under-performed historically given their massively positive xGD.</p>
<p>On the other end of the spectrum, it’s not hyperbole to say that Manchester United’s second place finish in the 2017/18 season was an over-achievement. Although they ended up with the third best goal differential that season, they were closely followed by several teams. And their xGD was sixth in the league that season.</p>
<section id="comparison-with-a-simpler-approach" class="level4">
<h4 class="anchored" data-anchor-id="comparison-with-a-simpler-approach">Comparison with a simpler approach</h4>
<p>Notably, we could get somewhat similar results by simply looking at the largest residuals of a model that regresses the actual final table placing on just xGD, which is how most people tend to think of “unexpected placings”.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1">table_with_xgd <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> table <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb10-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(season, team, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">actual_pts =</span> pts, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">actual_rank =</span> rank) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb10-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inner_join</span>(</span>
<span id="cb10-4">    all_raw_understat_xpts_xgd_by_season <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(season, team, xgd),</span>
<span id="cb10-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'season'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'team'</span>)</span>
<span id="cb10-6">  )</span>
<span id="cb10-7"></span>
<span id="cb10-8">xgd_rank_fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(actual_rank <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> xgd, table_with_xgd)</span></code></pre></div>
</details>
</div>
<p>The table below shows the top five over- and under-achieving teams according to our regression explaining season-ending placing with season-ending xGD. Three of the top five over- and under-performing teams appear in the respective top fives according to the ranks from the simulations of match probabilities shown before.</p>
<p><img src="https://tonyelhabr.rbind.io/posts/epl-xpts-simulation-2/xgd_unexpected.png" class="img-fluid"></p>
<p>We can also look at this from the opposite perspective. Where do the top five over- and under-achievers according to our simulations with match outcome probabilities fall among the season-ending xGD ranks for unlikelihood?</p>
<p><img src="https://tonyelhabr.rbind.io/posts/epl-xpts-simulation-2/xgd_matching_unexpected.png" class="img-fluid"></p>
<p>Outside of the the three team-season pairs appearing in the both of the top five over- and under-achievers that we already saw before, one team-season pair is not too far off from the top five—the 2017/18 Manchester United squad ranked as the sixth biggest over-performers by the season-long xGD regression.<sup>3</sup> However, the other over-perfomer, 2019/20 Newcastle, and the two remaining under-performers, 2021/22 Crystal Palace and 2021/22 Brentford, have somewhat large ranking discrepancies. So yes, the two methods can lead to somewhat similar results in some cases, but there is some observational evidence to suggest that there are non-trivial differences in other cases.</p>
<p>In fact, there are some big differences between the two methods once we look outside the top five or so biggest over- and under- achievers. For example, in terms of over-achieving, Arsenal’s fifth place finish 2018/19 season is given just a 7.50% chance of occurring given their season-long xGD, ranking them as the 17th biggest over-performer (among 80 team-season pairs considered to have over-achieved from 2014/15).<sup>4</sup> On the other hand, the match-level simulation approach marks the likelihood of them finishing fourth as 31.63% (37th of 80). The season-long xGD model essentially sees that they finished with an xGD of 7.5—less than any other fifth place finisher from 2014/15 - 2021/22—and penalizes them, while the match-level approach contextualizes them among their competition more robustly.</p>
<p>As another example, Manchester United’s under-achieving sixth place finish in the 2016/17 is given a fairly reasonable 37.36% chance (66th of 80 under-achieving teams) of occurring given their season-long 25.9 xGD, most for any sixth place team in the data set. On the other hand, the match-level simulation approach sees their sixth place finish as more unlikely, at just a 15.88% probability (16th of 80). While one might have their own opinion regarding which approach seems more “correct”, I’d say that likelihoods from the simulation approach seem more appropriate for extreme examples such as this one and the 2018/19 Arsenal example</p>
<p>Overall, both approaches seem reasonable to use to answer the question “Which teams had the most unlikely placings in the table given the quality of all their shots across the season?” But the approach based on simulations using match probabilities seems more appropriate to use to quantify exactly how unlikely a team’s final placing was. While the simpler regression approach can also be used to quantify likelihood, it is more brittle, dependent on statistical assumptions. Additionally, while it contextualizes a team’s xGD with historical xGD, it does not contextualize a team’s xGD among the other teams in the league, meaning that it does not do a good job with capturing likelihood when there are strong xGD over- and under-performances among a set of teams in a given season.</p>
</section>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>While aggregating match-level outcome probabilities to try to predict season-ending points does no better than more direct approaches with season-long xGD or xPts, simulating seasons using match-level outcome probabilities can be used in a perhaps more interesting way—to quantify just how unlikely a team’s placement in the table is, given xG for all of their shots across the season.</p>



</section>


<div class="quarto-listing quarto-listing-container-default" id="listing-listing">
<div class="list quarto-listing-default">

</div>
<div class="listing-no-matching d-none">
No matching items
</div>
</div><div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Maybe even more simply, we could use <code>worldfootballR::fb_season_team_stats(..., stat_type = 'league_table')</code>, although we’d need to add a column for team names for <a href="https://fbref.com/en/">FBref</a> to our team mapping to corroborate team names.↩︎</p></li>
<li id="fn2"><p>Table code is not shown since it’s not particularly instructive.↩︎</p></li>
<li id="fn3"><p>Note that, given the 160 team-season pairs in the data set, we should expect that 80 teams each are ranked as over-performing and under-performing. No team will be labeled as performing exactly as expected, unless they happen to have only one possible placing in the simulation approach, or a residual of exactly 0 in the regression approach.↩︎</p></li>
<li id="fn4"><p>To quantify the likelihood of a team’s placing with the simple regression, we convert the standard residual of the regression to a tail probability.↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>r</category>
  <category>soccer</category>
  <guid>https://tonyelhabr.rbind.io/posts/epl-xpts-simulation-2/index.html</guid>
  <pubDate>Mon, 05 Sep 2022 05:00:00 GMT</pubDate>
  <media:content url="https://tonyelhabr.rbind.io/posts/epl-xpts-simulation-2/unexpected.png" medium="image" type="image/png" height="143" width="144"/>
</item>
<item>
  <title>What exactly is an “expected point”? (part 1)</title>
  <dc:creator>Tony ElHabr</dc:creator>
  <link>https://tonyelhabr.rbind.io/posts/epl-xpts-simulation-1/index.html</link>
  <description><![CDATA[ 



<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p><a href="https://theanalyst.com/na/2021/07/what-are-expected-goals-xg/">Expected goals (xG)</a> in soccer have gone mainstream and are no longer cool to talk about.</p>
<blockquote class="twitter-tweet blockquote">
<p lang="en" dir="ltr">
</p><p>What exactly is an ” expected goal “? Who decides the criteria ? Is there a list of” expected goal scorers ” ? Or even ” unexpected ones ” ?</p>
<p></p>
<p>— Ian Darke (<span class="citation" data-cites="IanDarke">@IanDarke</span>) <a href="https://twitter.com/IanDarke/status/1341904890914885641?ref_src=twsrc%5Etfw">December 24, 2020</a></p>
</blockquote>
<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<p>So let’s talk about <a href="https://www.bettingodds.com/news/what-are-expected-points-xp-football-betting">expected points (xPts)</a>. The one sentence explainer for xPts: it’s a number between 0 and 3 assigned to each team in a match that we estimate from the xG of each shot in the match. Teams that accumulate more xG than their opponents in the match are more likely to have xPts closer to 3, i.e.&nbsp;the points awarded for a win, and those that accumulate less than their opponents are more likely to earn xPts closer to 0. xPts is convenient for translating a team’s xG (relative to it’s opponents) to the team’s expected placement in the standings.</p>
<p>While <a href="https://luke-beggs.medium.com/creating-an-expected-points-xp-calculator-for-football-matches-ce4edd18d16f">several</a> <a href="https://theshortfuse.sbnation.com/2017/11/15/16655916/how-to-calculate-xpoints-analysis-stats-xg">outlets</a> have described computing expected points with simulation<sup>1</sup>, <a href="https://www.jonaslindstrom.dk/?p=330">simulation is actually not necessary</a> if you have the xG for every shot taken in a match.<sup>2</sup> For example, let’s say team A shoots six times with an xG of 0.1 for each shot, and team B shoots three shots with xG’s of 0.1, 0.2, and 0.3 respectively. Given these goal probabilities, we can analytically compute xPts as follows.</p>
<p>First, we find the probability of scoring 0, 1, 2, etc. goals (up to the number of shots taken).<sup>3</sup></p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(poibin)</span>
<span id="cb1-2">xg_a <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>)</span>
<span id="cb1-3">xg_b <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>)</span>
<span id="cb1-4"></span>
<span id="cb1-5">probs_a <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dpoibin</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq.int</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(xg_a)), xg_a)</span>
<span id="cb1-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(probs_a, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb1-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [1] 0.53 0.35 0.10 0.01 0.00 0.00 0.00</span></span>
<span id="cb1-8">probs_b <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dpoibin</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq.int</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(xg_b)), xg_b)</span>
<span id="cb1-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(probs_b, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb1-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [1] 0.50 0.40 0.09 0.01</span></span></code></pre></div>
</details>
</div>
<p><img src="https://tonyelhabr.rbind.io/posts/epl-xpts-simulation-1/ex.png" class="img-fluid"></p>
<p>Second, we convert the goal probabilities to singular probabilities for each team winning the match, as well as the probability of a draw.<sup>4</sup></p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(gdata)</span>
<span id="cb2-2">outer_prod <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">outer</span>(probs_a, probs_b)</span>
<span id="cb2-3">p_a <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lowerTriangle</span>(outer_prod))</span>
<span id="cb2-4">p_b <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">upperTriangle</span>(outer_prod))</span>
<span id="cb2-5">p_draw <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">diag</span>(outer_prod))</span>
<span id="cb2-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(p_a, p_b, p_draw), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb2-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [1] 0.28 0.30 0.42</span></span></code></pre></div>
</details>
</div>
<p>Finally, given the match outcome probabilities, the xPts calculation is straightforward.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">xpts_a <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> p_a <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> p_draw</span>
<span id="cb3-2">xpts_b <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> p_b <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> p_draw</span>
<span id="cb3-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(xpts_a, xpts_b), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb3-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [1] 1.27 1.31</span></span></code></pre></div>
</details>
</div>
<p>For this example, we arrive at the interesting result that, despite the two teams total xG being equal (=0.6), team B has a slightly higher probability of winning. There have been plenty of <a href="https://hockey-graphs.com/2018/12/19/some-people-were-wrong-on-twitter/">explanations</a> on this “quality vs.&nbsp;quantity” phenomenon, so I won’t go into it in detail. Nonetheless, this simple example illustrates why it can be useful to translate xG into another form—doing so can provide a better perspective on match results and, consequently, team placement in the standings.</p>
<section id="objectives" class="level3">
<h3 class="anchored" data-anchor-id="objectives">Objectives</h3>
<p>So we’ve gone over what expected points are and why they’re important. Now we set out to do the following.</p>
<ol type="1">
<li><strong>Calculate xPts from shot xG for multiple seasons of data.</strong> We’ll limit the scope to the 2020/21 and 2021/22 seasons for the English Premier League.<sup>5</sup></li>
<li><strong>Compare the calibration of the understat and fotmob match outcome probabilities.</strong> <code>{worldfootballR}</code> makes it easy for us to get xG from both <a href="https://understat.com/">understat</a> and <a href="https://www.fotmob.com/">fotmob</a>, and it should be interesting to compare the the predictive performance of the two models.</li>
<li><strong>Compare predictions of actual season-long points using xPts that we derive from understat and fotmob xG.</strong> In particular, we’ll be interested to see if our conclusions regarding the better source for xG here matches the conclusions for (2).</li>
</ol>
</section>
</section>
<section id="analysis" class="level2">
<h2 class="anchored" data-anchor-id="analysis">Analysis</h2>
<section id="calculating-xpts-from-xg" class="level3">
<h3 class="anchored" data-anchor-id="calculating-xpts-from-xg">1. Calculating xPts from xG</h3>
<p>Let’s start by using the <code>load_understat_league_shots()</code> function from <code>{worldfootballR}</code> to retrieve understat xG by shot.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(readr)</span>
<span id="cb4-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)</span>
<span id="cb4-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tibble)</span>
<span id="cb4-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyr)</span>
<span id="cb4-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(stringr)</span>
<span id="cb4-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(lubridate)</span>
<span id="cb4-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(worldfootballR) <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## version: 0.5.12.5000</span></span>
<span id="cb4-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(janitor)</span>
<span id="cb4-9"></span>
<span id="cb4-10">rename_home_away_teams <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(df) {</span>
<span id="cb4-11">  df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb4-12">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb4-13">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">team =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(is_home, home_team, away_team),</span>
<span id="cb4-14">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">opponent =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(is_home, away_team, home_team)</span>
<span id="cb4-15">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb4-16">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(home_team, away_team)) </span>
<span id="cb4-17">}</span>
<span id="cb4-18"></span>
<span id="cb4-19">convert_understat_year_to_season <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x) {</span>
<span id="cb4-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sprintf</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'%s/%s'</span>, x, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_sub</span>(x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>))</span>
<span id="cb4-21">}</span>
<span id="cb4-22"></span>
<span id="cb4-23"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## we'll use all of the shots later when exporing understat data only</span></span>
<span id="cb4-24">all_understat_shots <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">load_understat_league_shots</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'EPL'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb4-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb4-26">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## camelcase like "xG" is for Java scrubs</span></span>
<span id="cb4-27">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">clean_names</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb4-28">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(season <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2021</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb4-29">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## transmute = select + mutate</span></span>
<span id="cb4-30">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">transmute</span>(</span>
<span id="cb4-31">    match_id,</span>
<span id="cb4-32">    <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## "2021/2022" format so that we have a clear, consistent way to represent season</span></span>
<span id="cb4-33">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(season, convert_understat_year_to_season),</span>
<span id="cb4-34">    <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## to convert "2020-09-12 11:30:00" to a date ("2020-09-12")</span></span>
<span id="cb4-35">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(date, lubridate<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>date),</span>
<span id="cb4-36">    home_team,</span>
<span id="cb4-37">    away_team,</span>
<span id="cb4-38">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">is_home =</span> h_a <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'h'</span>,</span>
<span id="cb4-39">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xg =</span> x_g</span>
<span id="cb4-40">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb4-41">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename_home_away_teams</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb4-42">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(season, date, team)</span>
<span id="cb4-43"></span>
<span id="cb4-44"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## but when comparing understat with fotmob, we'll need to limit the seasons to just</span></span>
<span id="cb4-45"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   those that both sources have</span></span>
<span id="cb4-46">understat_shots <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> all_understat_shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(season <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2020</span>)</span></code></pre></div>
</details>
</div>
<p>We can use <code>load_fotmob_match_details()</code> to get fotmob’s shot xG in a similar fashion.<sup>6</sup></p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## manually created CSV with at least 2 columns: team_understat, team_fotmob.</span></span>
<span id="cb5-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   use the team_understat name to be consistent across sources.</span></span>
<span id="cb5-3">team_mapping <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'https://raw.githubusercontent.com/tonyelhabr/sports_viz/master/59-xg_xpoints/team_mapping.csv'</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_csv</span>()</span>
<span id="cb5-5"></span>
<span id="cb5-6">rename_fotmob_teams <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(df) {</span>
<span id="cb5-7">  df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-8">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(</span>
<span id="cb5-9">      team_mapping <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(team_understat, team_fotmob),</span>
<span id="cb5-10">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'home_team'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'team_fotmob'</span>)</span>
<span id="cb5-11">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-12">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>home_team) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-13">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">home_team =</span> team_understat) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-14">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(</span>
<span id="cb5-15">      team_mapping <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(team_understat, team_fotmob),</span>
<span id="cb5-16">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'away_team'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'team_fotmob'</span>)</span>
<span id="cb5-17">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-18">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>away_team) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-19">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">away_team =</span> team_understat)</span>
<span id="cb5-20">}</span>
<span id="cb5-21"></span>
<span id="cb5-22">fotmob_shots <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">load_fotmob_match_details</span>(</span>
<span id="cb5-23">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">country =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ENG'</span>,</span>
<span id="cb5-24">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">league_name =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Premier League'</span></span>
<span id="cb5-25">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-26">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb5-27">    <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## to convert strings from 'Sat, Sep 12, 2020, 11:30 UTC' to a date</span></span>
<span id="cb5-28">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">date =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">strptime</span>(match_time_utc, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'%a, %b %d, %Y, %H:%M UTC'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tz =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'UTC'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">date</span>(),</span>
<span id="cb5-29">    <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## fotmob's parent_league_season always reflects the current season, so we need to manually</span></span>
<span id="cb5-30">    <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   define the season from the date. we would certainly want a more automated approach</span></span>
<span id="cb5-31">    <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##   if working with more seasons and more leagues.</span></span>
<span id="cb5-32">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">season =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(</span>
<span id="cb5-33">      date <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ymd</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'2020-09-12'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> date <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ymd</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'2021-05-23'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'2020/21'</span>,</span>
<span id="cb5-34">      date <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ymd</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'2021-08-13'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> date <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ymd</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'2022-05-22'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'2021/22'</span>,</span>
<span id="cb5-35">      <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA_character_</span></span>
<span id="cb5-36">    )</span>
<span id="cb5-37">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-38">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## the NAs are for 2022/2023 (incomplete as of writing) and the partial data for 2019/2020</span></span>
<span id="cb5-39">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">drop_na</span>(season) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-40">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">transmute</span>(</span>
<span id="cb5-41">    match_id,</span>
<span id="cb5-42">    season,</span>
<span id="cb5-43">    date,</span>
<span id="cb5-44">    home_team,</span>
<span id="cb5-45">    away_team,</span>
<span id="cb5-46">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">is_home =</span> team_id <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> home_team_id,</span>
<span id="cb5-47">    <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## some shots with NAs for some reason</span></span>
<span id="cb5-48">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xg =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coalesce</span>(expected_goals, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb5-49">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb5-50">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename_fotmob_teams</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-51">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename_home_away_teams</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-52">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(season, date, team)</span></code></pre></div>
</details>
</div>
<p>Alright, now the fun part. We functionalize the code from the example for calculating the probability that xG will result in 0, 1, 2, etc. goals.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(purrr)</span>
<span id="cb6-2">permute_xg <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(xg) {</span>
<span id="cb6-3">  n <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(xg)</span>
<span id="cb6-4">  x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq.int</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, n)</span>
<span id="cb6-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dpoibin</span>(x, xg)</span>
<span id="cb6-6">}</span>
<span id="cb6-7"></span>
<span id="cb6-8">calculate_permuted_xg <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(df) {</span>
<span id="cb6-9">  df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-10">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">everything</span>(), <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>xg))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-11">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(xg, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(.x))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-12">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb6-13">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prob =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map</span>(xg, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">permute_xg</span>(.x))</span>
<span id="cb6-14">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-15">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(xg)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-16">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cols =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(prob)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-17">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(prob))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb6-18">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb6-19">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">g =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">row_number</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> 1L</span>
<span id="cb6-20">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb6-21">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-22">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(match_id, is_home, g)</span>
<span id="cb6-23">}</span>
<span id="cb6-24"></span>
<span id="cb6-25">understat_permuted_xg <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> understat_shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">calculate_permuted_xg</span>()</span>
<span id="cb6-26">fotmob_permuted_xg <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> fotmob_shots <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">calculate_permuted_xg</span>()</span></code></pre></div>
</details>
</div>
<p>Next, we identify all possible goal combinations using xG as “weights” to compute the relative likelihood of each combination, and then analytically calculate the probabilities of winning, losing, and drawing.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">summarize_pivoted_permuted_xg <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(prob_away, prob_home) {</span>
<span id="cb7-2">  outer_prod <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">outer</span>(prob_away, prob_home)</span>
<span id="cb7-3">  p_draw <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">diag</span>(outer_prod), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb7-4">  p_home <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">upperTriangle</span>(outer_prod), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb7-5">  p_away <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lowerTriangle</span>(outer_prod), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb7-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb7-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">draw =</span> p_draw,</span>
<span id="cb7-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">home =</span> p_home,</span>
<span id="cb7-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">away =</span> p_away</span>
<span id="cb7-10">  )</span>
<span id="cb7-11">}</span>
<span id="cb7-12"></span>
<span id="cb7-13"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Bournemouth 0 - 1 Manchester City on 2019-03-02</span></span>
<span id="cb7-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Huddersfield 0 - 0 Swansea on 2018-03-10</span></span>
<span id="cb7-15">pad_for_matches_without_shots_from_one_team <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(df) {</span>
<span id="cb7-16">  n_teams_per_match <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb7-17">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">distinct</span>(match_id, team) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb7-18">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">count</span>(match_id, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sort =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb7-19">  </span>
<span id="cb7-20">  matches_with_no_shots_from_one_team <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> n_teams_per_match <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb7-21">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(n <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb7-22">  </span>
<span id="cb7-23">  dummy_opponents <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb7-24">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">distinct</span>(match_id, season, date, team, opponent, is_home) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb7-25">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">semi_join</span>(</span>
<span id="cb7-26">      matches_with_no_shots_from_one_team,</span>
<span id="cb7-27">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'match_id'</span></span>
<span id="cb7-28">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb7-29">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb7-30">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">z =</span> team</span>
<span id="cb7-31">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb7-32">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">transmute</span>(</span>
<span id="cb7-33">      match_id, </span>
<span id="cb7-34">      season, </span>
<span id="cb7-35">      date, </span>
<span id="cb7-36">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">team =</span> opponent,</span>
<span id="cb7-37">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">opponent =</span> z,</span>
<span id="cb7-38">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(is_home, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~!</span>.x),</span>
<span id="cb7-39">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prob =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb7-40">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">g =</span> 0L</span>
<span id="cb7-41">    )</span>
<span id="cb7-42">  </span>
<span id="cb7-43">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>(</span>
<span id="cb7-44">    df,</span>
<span id="cb7-45">    dummy_opponents</span>
<span id="cb7-46">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb7-47">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(season, date, team, g)</span>
<span id="cb7-48">}</span>
<span id="cb7-49"></span>
<span id="cb7-50">summarize_permuted_xg_by_match <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(df) {</span>
<span id="cb7-51">  </span>
<span id="cb7-52">  padded_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pad_for_matches_without_shots_from_one_team</span>(df)</span>
<span id="cb7-53">  </span>
<span id="cb7-54">  pivoted <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> padded_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb7-55">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">transmute</span>(</span>
<span id="cb7-56">      match_id,</span>
<span id="cb7-57">      season,</span>
<span id="cb7-58">      date,</span>
<span id="cb7-59">      g,</span>
<span id="cb7-60">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">is_home =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(is_home, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'home'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'away'</span>),</span>
<span id="cb7-61">      prob</span>
<span id="cb7-62">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb7-63">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_wider</span>(</span>
<span id="cb7-64">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_from =</span> is_home,</span>
<span id="cb7-65">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_prefix =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'prob_'</span>,</span>
<span id="cb7-66">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_from =</span> prob,</span>
<span id="cb7-67">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_fill =</span> 0L</span>
<span id="cb7-68">    )</span>
<span id="cb7-69">  </span>
<span id="cb7-70">  pivoted <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb7-71">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(match_id, season, date, prob_away, prob_home) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb7-72">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(match_id, season, date) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb7-73">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(</span>
<span id="cb7-74">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">starts_with</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'prob_'</span>), <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(.x))</span>
<span id="cb7-75">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb7-76">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb7-77">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inner_join</span>(</span>
<span id="cb7-78">      padded_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">distinct</span>(match_id, team, opponent, is_home),</span>
<span id="cb7-79">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'match_id'</span></span>
<span id="cb7-80">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb7-81">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb7-82">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prob =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map2</span>(prob_away, prob_home, summarize_pivoted_permuted_xg)</span>
<span id="cb7-83">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb7-84">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">starts_with</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'prob_'</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb7-85">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest_wider</span>(prob, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_sep =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'_'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb7-86">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb7-87">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prob_win =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(is_home, prob_home, prob_away),</span>
<span id="cb7-88">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prob_lose =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(is_home, prob_away, prob_home),</span>
<span id="cb7-89">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xpts =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> prob_win <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> prob_draw</span>
<span id="cb7-90">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb7-91">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(prob_home, prob_away))</span>
<span id="cb7-92">}</span>
<span id="cb7-93"></span>
<span id="cb7-94">understat_xpts_by_match <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> understat_permuted_xg <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize_permuted_xg_by_match</span>()</span>
<span id="cb7-95">fotmob_xpts_by_match <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> fotmob_permuted_xg <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize_permuted_xg_by_match</span>()</span></code></pre></div>
</details>
</div>
<p>Let’s take a quick peak at the distributions of xG and xPts, both as a sanity check and to enhance our understanding of the relationship between the two. When plotting xPts as a function xG, we should expect to see a monotonically increasing relationship where xPts bottoms out at zero and tops out at three.</p>
<p><img src="https://tonyelhabr.rbind.io/posts/epl-xpts-simulation-1/xg_vs_xpts.png" class="img-fluid"></p>
<p>Further, if there is any doubt about the expected points calculation, note that understat offers xPts directly in their data. The mean absolute error of our calculation of xPts with theirs is ~0.02.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(understatr)</span>
<span id="cb8-2"></span>
<span id="cb8-3">all_raw_understat_xpts_by_match <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2014</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2021</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb8-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_names</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb8-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map_dfr</span>(</span>
<span id="cb8-6">    <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_league_teams_stats</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'EPL'</span>, .x),</span>
<span id="cb8-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.id =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'season'</span></span>
<span id="cb8-8">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb8-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">transmute</span>(</span>
<span id="cb8-10">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(season, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">convert_understat_year_to_season</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.integer</span>(.x))),</span>
<span id="cb8-11">    date,</span>
<span id="cb8-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">team =</span> team_name,</span>
<span id="cb8-13">    result,</span>
<span id="cb8-14">    pts,</span>
<span id="cb8-15">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">raw_xpts =</span> xpts,</span>
<span id="cb8-16">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xg =</span> xG</span>
<span id="cb8-17">  )</span>
<span id="cb8-18"></span>
<span id="cb8-19">raw_understat_xpts_by_match <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> all_raw_understat_xpts_by_match <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb8-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inner_join</span>(</span>
<span id="cb8-21">    understat_xpts_by_match <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(season, date, team, xpts),</span>
<span id="cb8-22">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'season'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'date'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'team'</span>)</span>
<span id="cb8-23">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb8-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb8-25">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xptsd =</span> raw_xpts <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> xpts</span>
<span id="cb8-26">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb8-27">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(season, date, team)</span>
<span id="cb8-28"></span>
<span id="cb8-29"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## mean absolute error</span></span>
<span id="cb8-30"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abs</span>(raw_understat_xpts_by_match<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>xptsd)), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb8-31"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [1] 0.02</span></span></code></pre></div>
</details>
</div>
</section>
<section id="match-predictive-performance7" class="level3">
<h3 class="anchored" data-anchor-id="match-predictive-performance7">2. Match predictive performance<sup>7</sup></h3>
<p>As one might guess, the match outcome probabilities implied by the xG from understat and fotmob are strongly correlated.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">rename_xpts_by_match <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(df, src) {</span>
<span id="cb9-2">  df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb9-3">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(season, date, team, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">starts_with</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'prob_'</span>), xpts) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb9-4">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename_with</span>(</span>
<span id="cb9-5">      <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sprintf</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'%s_%s'</span>, .x, src), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">starts_with</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'prob_'</span>), xpts)</span>
<span id="cb9-6">    )</span>
<span id="cb9-7">}</span>
<span id="cb9-8"></span>
<span id="cb9-9">xpts_by_match <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> raw_understat_xpts_by_match <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb9-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(season, date, team, result, pts) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb9-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inner_join</span>(</span>
<span id="cb9-12">    understat_xpts_by_match <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename_xpts_by_match</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'understat'</span>),</span>
<span id="cb9-13">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'season'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'date'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'team'</span>)</span>
<span id="cb9-14">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb9-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inner_join</span>(</span>
<span id="cb9-16">    fotmob_xpts_by_match <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename_xpts_by_match</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fotmob'</span>),</span>
<span id="cb9-17">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'season'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'date'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'team'</span>)</span>
<span id="cb9-18">  )</span>
<span id="cb9-19"></span>
<span id="cb9-20">cor_draw <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cor</span>(xpts_by_match<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>prob_draw_fotmob, xpts_by_match<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>prob_draw_understat)</span>
<span id="cb9-21">cor_win <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cor</span>(xpts_by_match<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>prob_win_fotmob, xpts_by_match<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>prob_win_understat)</span>
<span id="cb9-22">cor_lose <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cor</span>(xpts_by_match<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>prob_lose_fotmob, xpts_by_match<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>prob_lose_understat)</span>
<span id="cb9-23"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(cor_draw, cor_win, cor_lose), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span>
<span id="cb9-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [1] 0.906 0.958 0.958</span></span></code></pre></div>
</details>
</div>
<p>Note that the win and loss correlations are identical. This is due to the symmetric nature of the data—we have two records for each match, one from each team’s perspective.<sup>8</sup></p>
<section id="predicting-match-outcomes-with-binary-logistic-regression" class="level4">
<h4 class="anchored" data-anchor-id="predicting-match-outcomes-with-binary-logistic-regression">Predicting match outcomes with binary logistic regression</h4>
<p>Now let’s compare how “good” the implied probabilities from the two sources are. To do this, we’ll create binary logistic regression models to predict a given outcome and compute:</p>
<ol type="1">
<li>the <a href="https://en.wikipedia.org/wiki/Mean_squared_error">mean squared error (MSE)</a>;</li>
<li>the <a href="https://en.wikipedia.org/wiki/Brier_score#Brier_Skill_Score_(BSS)">brier skill score (BSS)</a>, treating the empirical proportion of the specified outcome as the reference.<sup>9</sup><sup>10</sup></li>
<li>a <a href="https://changhsinlee.com/python-calibration-plot/">calibration plot</a>, grouping predictions into “buckets” at every 5%.</li>
</ol>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1">result_props <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> xpts_by_match <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb10-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">count</span>(result) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb10-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prop =</span> n <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(n))</span>
<span id="cb10-4"></span>
<span id="cb10-5">compute_mse <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(truth, estimate) {</span>
<span id="cb10-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>((truth <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> estimate)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb10-7">}</span>
<span id="cb10-8"></span>
<span id="cb10-9">diagnose_prob_by_match <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(src, result) {</span>
<span id="cb10-10">  </span>
<span id="cb10-11">  df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> xpts_by_match <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb10-12">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb10-13">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">result =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(result <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!!</span>result, 1L, 0L) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>()</span>
<span id="cb10-14">    )</span>
<span id="cb10-15">  </span>
<span id="cb10-16">  result_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">switch</span>(</span>
<span id="cb10-17">    result,</span>
<span id="cb10-18">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'w'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'win'</span>,</span>
<span id="cb10-19">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'l'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'lose'</span>,</span>
<span id="cb10-20">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'d'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'draw'</span></span>
<span id="cb10-21">  )</span>
<span id="cb10-22">  col <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sprintf</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'prob_%s_%s'</span>, result_name, src)</span>
<span id="cb10-23">  </span>
<span id="cb10-24">  fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glm</span>(</span>
<span id="cb10-25">    df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>result <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> df[[col]],</span>
<span id="cb10-26">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'binomial'</span></span>
<span id="cb10-27">  )</span>
<span id="cb10-28">  </span>
<span id="cb10-29">  probs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb10-30">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">result_num =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>result) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb10-31">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.prob =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unname</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(fit, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'response'</span>))</span>
<span id="cb10-32">  )</span>
<span id="cb10-33">  </span>
<span id="cb10-34">  n_buckets <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span></span>
<span id="cb10-35">  alpha <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span></span>
<span id="cb10-36">  calib <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> probs <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb10-37">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb10-38">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(.prob, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(.x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> n_buckets) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> n_buckets)</span>
<span id="cb10-39">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb10-40">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(.prob) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb10-41">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(</span>
<span id="cb10-42">      <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Jeffreys' prior</span></span>
<span id="cb10-43">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ci_lower =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">qbeta</span>(alpha <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(result_num) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(result_num) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>),</span>
<span id="cb10-44">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ci_upper =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">qbeta</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> alpha <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(result_num) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(result_num) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>),</span>
<span id="cb10-45">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">actual =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(result_num) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>(),</span>
<span id="cb10-46">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>()</span>
<span id="cb10-47">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb10-48">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>()</span>
<span id="cb10-49">  </span>
<span id="cb10-50">  mse <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">compute_mse</span>(probs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>result_num, probs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>.prob)</span>
<span id="cb10-51">  </span>
<span id="cb10-52">  ref_prob <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> result_props <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb10-53">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(result <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!!</span>result) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb10-54">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pull</span>(prop)</span>
<span id="cb10-55">  </span>
<span id="cb10-56">  ref_mse <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">compute_mse</span>(probs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>result_num, ref_prob)</span>
<span id="cb10-57">  bss <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> (mse <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> ref_mse)</span>
<span id="cb10-58">  </span>
<span id="cb10-59">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb10-60">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">calib =</span> calib,</span>
<span id="cb10-61">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mse =</span> mse,</span>
<span id="cb10-62">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bss =</span> bss</span>
<span id="cb10-63">  )</span>
<span id="cb10-64">}</span>
<span id="cb10-65"></span>
<span id="cb10-66">diagnostics <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">crossing</span>(</span>
<span id="cb10-67">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">result =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'w'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'d'</span>),</span>
<span id="cb10-68">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">src =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'understat'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fotmob'</span>)</span>
<span id="cb10-69">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb10-70">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb10-71">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">diagnostics =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map2</span>(src, result, diagnose_prob_by_match)</span>
<span id="cb10-72">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb10-73">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest_wider</span>(diagnostics)</span>
<span id="cb10-74">diagnostics <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>calib)</span>
<span id="cb10-75"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 4 × 4</span></span>
<span id="cb10-76"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;   result src         mse    bss</span></span>
<span id="cb10-77"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;   &lt;chr&gt;  &lt;chr&gt;     &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span id="cb10-78"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 1 d      fotmob    0.170 0.0268</span></span>
<span id="cb10-79"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 2 d      understat 0.166 0.0466</span></span>
<span id="cb10-80"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 3 w      fotmob    0.173 0.270 </span></span>
<span id="cb10-81"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 4 w      understat 0.162 0.317</span></span></code></pre></div>
</details>
</div>
<p>The MSE (where lower is “better”) and the BSS (where higher is “better”) lead us to the same conclusion—the models based on understat’s xG slightly outperform the one based on fotmob’s xG.</p>
<p>Moreover, looking at the calibration plot, the understat model predictions seem to stick closer to the 45 degree slope representing perfect calibration.</p>
<p><img src="https://tonyelhabr.rbind.io/posts/epl-xpts-simulation-1/calib.png" class="img-fluid"></p>
</section>
<section id="predicting-points-with-linear-regression" class="level4">
<h4 class="anchored" data-anchor-id="predicting-points-with-linear-regression">Predicting points with linear regression</h4>
<p>Alternatively, we could regress points on expected points. For linear regression, we can use the <a href="https://en.wikipedia.org/wiki/Root-mean-square_deviation">root mean squared error (RMSE)</a> (where lower is “better”) and <a href="https://en.wikipedia.org/wiki/Coefficient_of_determination">R squared</a> (where higher is “better”) to compare the models.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1">compute_rmse <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(truth, estimate) {</span>
<span id="cb11-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>((truth <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> estimate)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span>
<span id="cb11-3">}</span>
<span id="cb11-4"></span>
<span id="cb11-5">diagnose_xpts_by_match <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(src) {</span>
<span id="cb11-6">  </span>
<span id="cb11-7">  col <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sprintf</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'xpts_%s'</span>, src)</span>
<span id="cb11-8">  fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(xpts_by_match<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pts <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> xpts_by_match[[col]])</span>
<span id="cb11-9">  </span>
<span id="cb11-10">  pred <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(fit)</span>
<span id="cb11-11">  </span>
<span id="cb11-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb11-13">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rmse =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">compute_rmse</span>(xpts_by_match<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pts, pred),</span>
<span id="cb11-14">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">r2 =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(fit)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>r.squared</span>
<span id="cb11-15">  )</span>
<span id="cb11-16">}</span>
<span id="cb11-17"></span>
<span id="cb11-18"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'understat'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fotmob'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb11-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_names</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb11-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map_dfr</span>(diagnose_xpts_by_match, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.id =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'src'</span>)</span>
<span id="cb11-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 2 × 3</span></span>
<span id="cb11-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;   src        rmse    r2</span></span>
<span id="cb11-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;   &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb11-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 1 understat  1.06 0.374</span></span>
<span id="cb11-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 2 fotmob     1.10 0.323</span></span></code></pre></div>
</details>
</div>
<p>The understat model proves to be better by both metrics, having a lower RMSE and higher R squared than the fotmob model.</p>
</section>
<section id="predicting-match-outcomes-with-multinomial-logistic-regression" class="level4">
<h4 class="anchored" data-anchor-id="predicting-match-outcomes-with-multinomial-logistic-regression">Predicting match outcomes with multinomial logistic regression</h4>
<p>Personally, I don’t like predicting points directly like this since it’s a discrete variable that can only take on three values (0, 1, and 3). If we’re going to predict points instead of a probability, I think the better approach is to run a multinomial logistic regression and to convert the predicted probabilities to expected points.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(nnet)</span>
<span id="cb12-2">diagnose_implied_xpts_by_match <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(src) {</span>
<span id="cb12-3">  </span>
<span id="cb12-4">  col_win <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sprintf</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'prob_win_%s'</span>, src)</span>
<span id="cb12-5">  col_draw <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sprintf</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'prob_draw_%s'</span>, src)</span>
<span id="cb12-6">  fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">multinom</span>(</span>
<span id="cb12-7">    xpts_by_match<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>result <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> xpts_by_match[[col_win]] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> xpts_by_match[[col_draw]],</span>
<span id="cb12-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">trace =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span></span>
<span id="cb12-9">  )</span>
<span id="cb12-10">  probs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(fit, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'probs'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>()</span>
<span id="cb12-11">  preds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> probs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>w <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> probs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>d</span>
<span id="cb12-12">  </span>
<span id="cb12-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb12-14">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rmse =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">compute_rmse</span>(xpts_by_match<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pts, preds),</span>
<span id="cb12-15">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">r2 =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cor</span>(xpts_by_match<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pts, preds)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb12-16">  )</span>
<span id="cb12-17">}</span>
<span id="cb12-18"></span>
<span id="cb12-19"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'understat'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fotmob'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb12-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_names</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb12-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map_dfr</span>(diagnose_implied_xpts_by_match, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.id =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'src'</span>)</span>
<span id="cb12-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 2 × 3</span></span>
<span id="cb12-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;   src        rmse    r2</span></span>
<span id="cb12-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;   &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb12-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 1 understat  1.06 0.374</span></span>
<span id="cb12-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 2 fotmob     1.10 0.321</span></span></code></pre></div>
</details>
</div>
<p>Again, we see that understat has a lower RMSE and higher R squared. The implication that understat performs slightly better than fotmob agrees with the results from the binary logistic regression approiach for predicting match outcome probabilities and the linear regression approach for predicting points.</p>
<p>Overall, we might say that understat seems to be the better of the two xG sources for explaining individual match results, although the margin is small enough that I would hesitate to say that this is the true across all leagues and all seasons.</p>
</section>
</section>
<section id="season-predictive-performance" class="level3">
<h3 class="anchored" data-anchor-id="season-predictive-performance">3. Season predictive performance</h3>
<p>How do the understat and fotmob models fare if we aggregate up the expected points to the season level and predict actual points?<sup>11</sup></p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1">xpts_by_season <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> xpts_by_match <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb13-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(season, team) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb13-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(</span>
<span id="cb13-4">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(pts, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">starts_with</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'xpts'</span>)), sum)</span>
<span id="cb13-5">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb13-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>()</span>
<span id="cb13-7"></span>
<span id="cb13-8">diagnose_xpts_by_season <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(src) {</span>
<span id="cb13-9">  </span>
<span id="cb13-10">  col <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sprintf</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'xpts_%s'</span>, src)</span>
<span id="cb13-11">  fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(xpts_by_season<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pts <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> xpts_by_season[[col]])</span>
<span id="cb13-12">  </span>
<span id="cb13-13">  preds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(fit)</span>
<span id="cb13-14">  </span>
<span id="cb13-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb13-16">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rmse =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">compute_rmse</span>(xpts_by_match<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pts, preds),</span>
<span id="cb13-17">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">r2 =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(fit)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>r.squared</span>
<span id="cb13-18">  )</span>
<span id="cb13-19">}</span>
<span id="cb13-20"></span>
<span id="cb13-21"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'understat'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fotmob'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb13-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_names</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb13-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map_dfr</span>(diagnose_xpts_by_season, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.id =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'src'</span>)</span>
<span id="cb13-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 2 × 3</span></span>
<span id="cb13-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;   src        rmse    r2</span></span>
<span id="cb13-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;   &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb13-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 1 understat  53.9 0.845</span></span>
<span id="cb13-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 2 fotmob     53.8 0.825</span></span></code></pre></div>
</details>
</div>
<p>The results are closer than those at the match-level. In fact, fotmob just barely edges out understat in terms of RMSE xPts, although understat outperforms fotmob according to R squared by a relatively comfortable 0.02. It’s harder to make a general statement regarding which data source provides better xG for explaining season-long expected points, although we might lean in favor of understat again.</p>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>Overall, we find that understat’s xG model seems to very slightly outperform fotmob’s in terms of explaining match results and season-long point totals.</p>
<p>In a follow up post, we’ll go more in depth regarding how we can leverage the match outcome probabilities to simulate season-ending points in a more rigorous fashion that done in the last section above.</p>



</section>


<div class="quarto-listing quarto-listing-container-default" id="listing-listing">
<div class="list quarto-listing-default">

</div>
<div class="listing-no-matching d-none">
No matching items
</div>
</div><div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p><a href="https://danny.page/expected_goals.html">Danny Page’s interactive web app</a> also uses simulation.↩︎</p></li>
<li id="fn2"><p>Now, if you desire the statistical properties that simulation offers, such as an estimation of error, that’s understandable; however, in write-ups that I’ve seen, such is not mentioned explicitly. Additionally, if one chooses to go down the simulation route because they believe that it helps to suppress flaws with the xG model, that’s also understandable. On the other hand, the analytical approach I present should present nearly identical results to that which one would find with simulation, and it offers the advantage of being much faster.↩︎</p></li>
<li id="fn3"><p>Plotting code is omitted throughout the post since it’s not particularly instructive.↩︎</p></li>
<li id="fn4"><p>How does this work? Under the assumption that xG comes from a <a href="https://en.wikipedia.org/wiki/Poisson_binomial_distribution">Poisson binomial distribution</a>, we look at all combinations of makes and misses of the shots and compare the relative proportion of instances in which one team’s number of success, i.e.&nbsp;goals, is greater than, equal to, or less than their opponent’s.↩︎</p></li>
<li id="fn5"><p>We’ve limited the scope for several reasons: (1) fotmob only has complete xG data for the 2020/21 and 2021/22 seasons as of writing, (2) I didn’t want to have to map team names across the two data sources for a ton of teams; and (3) of all league, I’m most interested in the EPL 😄.↩︎</p></li>
<li id="fn6"><p>Note that there are three additional shots in the fotmob data. There’s no simple solution to resolving this data discrepancy since we don’t have matching shot identifiers in the two data sets 🤷.↩︎</p></li>
<li id="fn7"><p>Using the adjective “predictive” is a little misleading, since we’re not actually making predictions out-of-sample. Rather, we’re using models based on xG to evaluate which xG data source better explains the observed results.↩︎</p></li>
<li id="fn8"><p>Home field advantage is treated as a feature instead of defined directly via columns, i.e.&nbsp;<code>home_team</code>, <code>home_score</code>, etc., which is good practice in general.↩︎</p></li>
<li id="fn9"><p>Draws occur for 22.5% of matches in the data set, and wins and losses occur in 38.8% of matches each.↩︎</p></li>
<li id="fn10"><p>Personally, I tend to rely on BSS wherever I can. Not only is it more interpretable—it’s a number between 0 and 1, while MSE can take on any value, depending on the context—I like that it forces one to compare to a baseline, which is a good principle in general.↩︎</p></li>
<li id="fn11"><p>Note that aggregating match-level probabilities to the season-level is not a statistically valid way to use the probabilities, which are intended to be treated independently.↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>r</category>
  <category>soccer</category>
  <guid>https://tonyelhabr.rbind.io/posts/epl-xpts-simulation-1/index.html</guid>
  <pubDate>Sun, 04 Sep 2022 05:00:00 GMT</pubDate>
  <media:content url="https://tonyelhabr.rbind.io/posts/epl-xpts-simulation-1/calib.png" medium="image" type="image/png" height="108" width="144"/>
</item>
<item>
  <title>Yet Another (Advanced?) Soccer Statistic</title>
  <dc:creator>Tony ElHabr</dc:creator>
  <link>https://tonyelhabr.rbind.io/posts/soccer-pass-network-max-cut/index.html</link>
  <description><![CDATA[ 



<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p><a href="https://www.datofutbol.cl/passing-networks-r/">Pass networks</a> are a common visualization form used to summarize a team’s behavior in a soccer match. Nodes represent average player position on passes that they are involved with, and edges represent passes between players. Most pass networks also weight node size and edge width by the total number of passes.</p>
<p><img src="https://tonyelhabr.rbind.io/posts/soccer-pass-network-max-cut/betweentheposts-example-pass-network.jpg" class="img-fluid"></p>
<p>While pass networks provide a nice visual tool for providing insight that can (and should) be supplemented by more detailed analysis, they’re often just that—purely a visual tool. In order to gain meaning beyond just anecdotal insight (“Look at how far the wingbacks were up the field!”), practitioners may leverage graph theory concepts such as <a href="https://en.wikipedia.org/wiki/Centrality">centrality</a> to quantify relationships.<sup>1</sup></p>
<p>Inspired by the findings of Eliakim et al.&nbsp;in <a href="https://www.tandfonline.com/doi/abs/10.1080/24733938.2021.1919747">“The development of metrics for measuring the level of symmetry in team formation and ball movement flow, and their association with performance”</a>, I wanted to evaluate a graph theory concept that has not been explored in relation to soccer pass networks (except for by Eliakim et al.): <a href="https://en.wikipedia.org/wiki/Maximum_cut">maximum cuts</a>.</p>
<p>To do so, I’ll be using data from the 2017/18 - 2020/21 Premier League seasons, along with the games up through Boxing Day of the 2021/22 season. Passes and other events are only considered up through the first substitution or red card of each match.</p>
</section>
<section id="examples" class="level2">
<h2 class="anchored" data-anchor-id="examples">Examples</h2>
<section id="simple" class="level3">
<h3 class="anchored" data-anchor-id="simple">Simple</h3>
<p>What is a maximum cut? Visually, it’s an arbitrary line that you can draw through the edges of a network that maximizes the sum of the edge weights.</p>
<p><img src="https://tonyelhabr.rbind.io/posts/soccer-pass-network-max-cut/example_max_cut.png" class="img-fluid"></p>
<p>For this example, 15 is actually a <em>weighted</em> max cut, since edges are treated differently, according to their assigned value. (An unweighted max cut would assign each edge a value of 1.)</p>
<p>On the other side of things, the min cut would be 2+4=6 for this example.</p>
</section>
<section id="in-soccer" class="level3">
<h3 class="anchored" data-anchor-id="in-soccer">In Soccer</h3>
<p>A 4-node, 5-edge network is nice for illustration, but how does this bear out in soccer?</p>
<p>To give a soccer example, Here’s the pass network and weighted max cut numbers for <a href="https://www.fotmob.com/match/3609994/matchfacts/liverpool-vs-manchester-city">the match between Liverpool and Manchester City on October 3, 2021</a>. <sup>2</sup></p>
<p><img src="https://tonyelhabr.rbind.io/posts/soccer-pass-network-max-cut/network-game_id=1549604-max_cut_weighted_norm_w_logo.png" class="img-fluid"></p>
<p>Zooming out from a single example to all games in our data set, the distribution of weighted max cuts per 90 minutes looks relatively normal, perhaps log-normal. <em>Note: It’s important to adjust for time since not all games have the same number of minutes played due to variance in the occurrence of the first formation change.</em></p>
<p><img src="https://tonyelhabr.rbind.io/posts/soccer-pass-network-max-cut/game_mc_hist_w_logo.png" class="img-fluid"></p>
</section>
</section>
<section id="but-is-max-cut-useful" class="level2">
<h2 class="anchored" data-anchor-id="but-is-max-cut-useful">But is Max Cut Useful?</h2>
<section id="setup" class="level3">
<h3 class="anchored" data-anchor-id="setup">Setup</h3>
<p>To quantify the impact of weighted max cuts, we’ll look at two measures of quality of play.</p>
<ol type="1">
<li><a href="https://theanalyst.com/na/2021/07/what-are-expected-goals-xg/"><strong>expected goals (xG)</strong></a>: xG tells the story of shot quality and quantity, which is massively important in a low-scoring game like soccer.</li>
<li><a href="https://karun.in/blog/expected-threat.html"><strong>expected threat (xT)</strong></a>: xT quantifies scoring opportunities more generally, looking beyond shots.</li>
</ol>
<p>I’d argue that xT is more informative for our purposes since max cut is related to passes and xT accounts for passes; xG is so tied up in shots that their relationship to passes leading up to those shots may be lost. Nonetheless, we’ll be considering both since both are commonly used for judging overall “value” in soccer.</p>
<p>We’ll be transforming these xG and xT in two manners.</p>
<ol type="1">
<li><strong>Volume-adjusting</strong>, i.e.&nbsp;taking each value per 90 minutes. The justification for adjusting max cut for time also applies here.</li>
<li><strong>Opponent-adjusting</strong>, or “differencing”, i.e.&nbsp;subtracting one side’s value from the other’s value. Sure, having a lot of touches in the opponent’s half and taking a lot of shots means scoring is more likely, but if you’re also giving up a ton of shots, then that effort is essentially negated.</li>
</ol>
<p>Given that we’ll be making our two quality-of-play stats—xG and xT—relative to the opponent, I prefer to opponent-adjust weighted max cut in the same manner. I’d argue that weighted max cut differential is more informative than just the weighted max cut of one side or the other. Suppressing your opponent’s weighted max cut is reflective of limiting their pass volume, and, consequently, makes it more likely that your weighted max cut is higher.</p>
<p>The relationship between weighted max cut and weighted max cut differential is very linear, so, ultimately, it shouldn’t matter too much if we look at opponent-adjust weighted max cut versus just raw weighted max cut.</p>
<p><img src="https://tonyelhabr.rbind.io/posts/soccer-pass-network-max-cut/game_mc_scatter_diff_w_logo.png" class="img-fluid"></p>
<p>Differencing has the added benefit of making our distributions look more “normal”, by making them symmetric about 0. This generally is beneficial for regression analysis, which we go on to conduct.</p>
</section>
<section id="correlations" class="level3">
<h3 class="anchored" data-anchor-id="correlations">Correlations</h3>
<p>A first step in looking at the relationship between weighted max cut with xG and xT is a <a href="https://en.wikipedia.org/wiki/Correlation">correlation</a>.</p>
<p><img src="https://tonyelhabr.rbind.io/posts/soccer-pass-network-max-cut/game_x_cors_table.png" class="img-fluid"></p>
<p>Weighted max cut compares favorably to other network stats for summarizing (pass) networks. Perhaps this isn’t too surprising; Eliakim et al.&nbsp;argue that, in relation to soccer, maximum cut surmises what is captured separately by various measures of centrality (<a href="https://en.wikipedia.org/wiki/Betweenness_centrality">betweenness</a>, <a href="https://en.wikipedia.org/wiki/Directed_graph#Indegree_and_outdegree">indegree and outdegree</a>, etc.).</p>
<p>Weighted max cut has a similar correlation to traditional pass metrics such as relative percentage of passes, but not as strong as counting stats for shots. We really shouldn’t expect any metric to have as strong a relation with xG and xT (especially xG) as shot-based metrics since these are derived from shots and their outcomes.</p>
<p>Overall, the game-level correlations are not super strong, indicating that we can’t read too much into them for individual games. The correlations are much stronger at the season-level, showing the same ordinality in magnitude of correlation.</p>
<p><img src="https://tonyelhabr.rbind.io/posts/soccer-pass-network-max-cut/season_x_cors_table.png" class="img-fluid"></p>
<p>Observing the difference in the game-level and season-level correlations should be a good reminder that single-game stats should not be scrutinized too heavily when evaluating a team’s performance over the course of a season. The same is true for max cuts!</p>
</section>
<section id="accounting-for-confounders" class="level3">
<h3 class="anchored" data-anchor-id="accounting-for-confounders">Accounting for Confounders</h3>
<p>The correlation approach for quantifying the descriptive role of max cuts in quality of play is a bit naive. Single-variable regressions, i.e.&nbsp;correlations, overstate the impact of the “treatment” variables.</p>
<p>If we regress max cut on xG and xT with z-score normalized counts of shots and passes as <a href="https://en.wikipedia.org/wiki/Confounding">confounders</a>, we see that the influence of max cut is negated.</p>
<p><img src="https://tonyelhabr.rbind.io/posts/soccer-pass-network-max-cut/team_stat_coefs_w_logo.png" class="img-fluid"></p>
<p>In the case of xG, the coefficient estimate for weighted max cut is offset by the coefficient for the passing term. This is due to their <a href="https://en.wikipedia.org/wiki/Collinearity">collinearity</a> (over 90%) and their lack of explanatory value in the presence of shot counts, which directly informs xG. For xT, the weighted max cut coefficient is completely suppressed, likely due to collinearity with passing.</p>
<p>Of course, we could be a little more sophisticated here, drawing out <a href="https://en.wikipedia.org/wiki/Directed_acyclic_graph">directed acyclic graphs (DAG)</a> and running a more formal <a href="https://en.wikipedia.org/wiki/Causal_inference">causal analysis</a>. But my intuition is that we would come to the same general conclusion: in the face of more traditional metrics like shot and pass counts, possibly the most robust pass-network-derived statistic—weighted max cut—provides minimal additional descriptive power for quantifying quality of play.</p>
</section>
<section id="why-havent-people-tried-this-before" class="level3">
<h3 class="anchored" data-anchor-id="why-havent-people-tried-this-before">Why Haven’t People Tried this Before?</h3>
<p>I can think of a couple of reasons why weighted max cut isn’t commonly seen in soccer literature:</p>
<ol type="1">
<li>The calculation requires an un-directed network. In our context, this requires treating passes between players as equal, regardless of who is the passer and who is the receiver. This can distort the role of a striker, who may receive much more than pass, or a keeper, who may pass much more than receive.</li>
<li>It’s difficult to visualize beyond just reporting a single number, and, thus, may not resonate with an audience.</li>
<li>It’s not super easy to calculate! In fact, <code>{igraph}</code>—the most popular R framework for network analysis—doesn’t have a function for it!</li>
</ol>
<p>For what it’s worth, the code that I wrote to calculate the weighted maximum cut for a pass network looks something like this.<sup>3</sup> (This is the calculation for the 4-node example network shown before.)</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tibble)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyr)</span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(sdpt3r) <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Semi-Definite Quadratic Linear Programming Solver</span></span>
<span id="cb1-5"></span>
<span id="cb1-6">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb1-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">from =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'a'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'a'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'a'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'b'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'b'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'b'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'c'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'c'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'c'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'d'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'d'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'d'</span>),</span>
<span id="cb1-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">to   =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'b'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'c'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'d'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'a'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'c'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'d'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'a'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'b'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'d'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'a'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'b'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'c'</span>),</span>
<span id="cb1-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n    =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>( 1L,  0L,  3L,  1L,  1L,  1L,  0L,  2L,  1L,  1L,  5L,  4L)</span>
<span id="cb1-10">)</span>
<span id="cb1-11"></span>
<span id="cb1-12">wide_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb1-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_wider</span>(</span>
<span id="cb1-14">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_from =</span> to,</span>
<span id="cb1-15">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_from =</span> n,</span>
<span id="cb1-16">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_fill =</span> 0L</span>
<span id="cb1-17">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb1-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(from, a, b, c, d) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb1-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(from) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb1-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>from)</span>
<span id="cb1-21">wide_df</span>
<span id="cb1-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 4 x 4</span></span>
<span id="cb1-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;       a     b     c     d</span></span>
<span id="cb1-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;</span></span>
<span id="cb1-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 1     0     1     0     3</span></span>
<span id="cb1-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 2     1     0     1     1</span></span>
<span id="cb1-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 3     0     2     0     1</span></span>
<span id="cb1-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 4     1     5     4     0</span></span>
<span id="cb1-29"></span>
<span id="cb1-30">m <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(wide_df)</span>
<span id="cb1-31">symmetric_m <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> m <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(m) <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## must be symmetric</span></span>
<span id="cb1-32">mc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">maxcut</span>(symmetric_m)</span>
<span id="cb1-33">max_cut <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(mc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pobj, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb1-34">max_cut</span>
<span id="cb1-35"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [1] 15</span></span></code></pre></div>
</details>
</div>
<p>Or, perhaps, people have actually evaluated max cut for pass networks, but have found the same non-significant result that I have found, and have simply opted not to write about it. 🤷</p>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>Weighted max cut can be a very informative metric for summarizing pass volume and pass network structure, as seen in a correlation analysis. It’s merit surpasses that of other summary network stats and is nearly equivalent to traditional pass-derived stats for explaining xG and xT. However, I don’t think it should supersede more traditional stats like shots and passes if purely evaluating attacking quality.</p>



</section>


<div class="quarto-listing quarto-listing-container-default" id="listing-listing">
<div class="list quarto-listing-default">

</div>
<div class="listing-no-matching d-none">
No matching items
</div>
</div><div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>There are other things researchers have done, such as <a href="https://karun.in/blog/interactive-passing-networks.html">subsetting the passes that make up the network based on game situation</a>, or <a href="https://statsbomb.com/2018/08/explaining-xgchain-passing-networks/">supplement the visual with meaningful color</a>↩︎</p></li>
<li id="fn2"><p>Unfortunately, max cuts can be difficult to visualize for graphs with lots of edges and/or nodes, so reporting just the quantity is often the best thing we can do. 🤷↩︎</p></li>
<li id="fn3"><p>If we wanted to do an un-weighted calculation, we would use <code>1</code> for any <code>n&gt;0</code> in the example here.↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>r</category>
  <category>soccer</category>
  <guid>https://tonyelhabr.rbind.io/posts/soccer-pass-network-max-cut/index.html</guid>
  <pubDate>Mon, 31 Jan 2022 06:00:00 GMT</pubDate>
  <media:content url="https://tonyelhabr.rbind.io/posts/soccer-pass-network-max-cut/network-game_id=1549604-max_cut_weighted_norm_w_logo.png" medium="image" type="image/png" height="111" width="144"/>
</item>
<item>
  <title>Tired: PCA + kmeans, Wired: UMAP + GMM</title>
  <dc:creator>Tony ElHabr</dc:creator>
  <link>https://tonyelhabr.rbind.io/posts/dimensionality-reduction-and-clustering/index.html</link>
  <description><![CDATA[ 



<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>Combining <a href="https://en.wikipedia.org/wiki/Principal_component_analysis">principal component analysis (PCA)</a> and <a href="https://en.wikipedia.org/wiki/K-means_clustering">kmeans clustering</a> seems to be a pretty popular 1-2 punch in data science. While there is some debate about whether combining <a href="https://en.wikipedia.org/wiki/Dimensionality_reduction">dimensionality reduction</a> and <a href="https://en.wikipedia.org/wiki/Clustering">clustering</a> is something we should ever do<sup>1</sup>, I’m not here to debate that. I’m here to illustrate the potential advantages of upgrading your PCA + kmeans workflow to <a href="https://umap-learn.readthedocs.io/en/latest/">Uniform Manifold Approximation and Projection (UMAP)</a> + <a href="https://en.wikipedia.org/wiki/Mixture_model">Gaussian Mixture Model (GMM)</a>, as noted in <a href="https://twitter.com/TonyElHabr/status/1400149998629703681">my reply here</a>.</p>
<blockquote class="twitter-tweet blockquote">
<p lang="tl" dir="ltr">
</p><p>tired: PCA + kmeans<br>wired: UMAP + GMM</p>
<p></p>
<p>— Tony (<span class="citation" data-cites="TonyElHabr">@TonyElHabr</span>) <a href="https://twitter.com/TonyElHabr/status/1400149998629703681?ref_src=twsrc%5Etfw">June 2, 2021</a></p>
</blockquote>
<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<p>For this demonstration, I’ll be using <a href="https://docs.google.com/spreadsheets/d/1lQgIDcxsHT1m_IayMldmiHVOt4ICbX-ys8Mh9rggPHM/edit?usp=sharing">this data set</a> pointed out <a href="https://twitter.com/ronanmann/status/1408504415690969089?s=21">here</a>, including over 100 stats for players from <a href="https://fbref.com/en/comps/Big5/Big-5-European-Leagues-Stats">soccer’s “Big 5” leagues</a>.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span>
<span id="cb1-2">raw_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'FBRef 2020-21 T5 League Data.xlsx'</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb1-3">  readxl<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_excel</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb1-4">  janitor<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">clean_names</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb1-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">where</span>(is.double), <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">replace_na</span>(.x, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)))</span>
<span id="cb1-6"></span>
<span id="cb1-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Let's only use players with a 10 matches' worth of minutes.</span></span>
<span id="cb1-8">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> raw_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(min <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">90</span>))</span>
<span id="cb1-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(df)</span>
<span id="cb1-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## [1] 1626  128</span></span></code></pre></div>
</details>
</div>
<p>Trying to infer something from the correlation matrix doesn’t get you very far, so one can see why dimensionality reduction will be useful.</p>
<p><img src="https://tonyelhabr.rbind.io/posts/dimensionality-reduction-and-clustering/viz_cors.png" class="img-fluid"></p>
<p>Also, we don’t really have “labels” here (more on this later), so clustering can be useful for learning something from our data.</p>
</section>
<section id="unsupervised-evaluation" class="level2">
<h2 class="anchored" data-anchor-id="unsupervised-evaluation">Unsupervised Evaluation</h2>
<p>We’ll be feeding in the results from the dimensionality reduction—either PCA or UMAP—to a clustering method—either kmeans or GMM. So, since clustering comes last, all we need to do is figure out how to judge the clustering; this will tell us something about how “good” the combination of dimensionality reduction and clustering is overall.</p>
<p>I’ll save you from google-ing and just tell you that <a href="https://en.wikipedia.org/wiki/Total_sum_of_squares">within-cluster sum of squares (WSS)</a> is typically used for kmeans, and <a href="https://en.wikipedia.org/wiki/Bayesian_information_criterion">Bayesian Information Criteria (BIC)</a> is the go-to metric for GMM. WSS and BIC are not on the same scale, so we can’t directly compare kmeans and GMM at this point. Nonetheless, we can experiment with different numbers of components—the one major <a href="https://en.wikipedia.org/wiki/Hyperparameter_(machine_learning)">“hyperparameter”</a> for dimensionality reduction—prior to the clustering to identify if more or less components is “better”, given the clustering method. Oh, and why not also vary the number of clusters—the one notable hyperparameter for clustering—while we’re at it?</p>
<p><img src="https://tonyelhabr.rbind.io/posts/dimensionality-reduction-and-clustering/viz_kmeans_wss.png" class="img-fluid"></p>
<p>For kmeans, we see that WSS decreases with increasing number of clusters, which is typically what we see in <a href="https://en.wikipedia.org/wiki/Elbow_method_(clustering)">“elbow” plots</a> like this. Additionally, we see that WSS decreases with increasing number of components. This makes sense—additional components means more data is accounted for.<sup>2</sup> There is definitely a point of “diminishing returns”, somewhere around 3 clusters, after which WSS barely improves.<sup>3</sup> Overall, we observe that the kmeans models using UMAP pre-processing do better, compared to those using PCA.</p>
<p>Moving on to GMM, we observe that BIC generally increases with the number of clusters as well. (Note that, due to the way <a href="https://stats.stackexchange.com/questions/237220/mclust-model-selection">the <code>{mclust}</code> package defines its objective function, higher BIC is “better”</a>.)</p>
<p><img src="https://tonyelhabr.rbind.io/posts/dimensionality-reduction-and-clustering/viz_gmm_bic.png" class="img-fluid"></p>
<p>Regarding number of components, we see that the GMM models using more UMAP components do better, as we should have expected. On the other hand, we observe that GMM models using less PCA components do better than those with more components. This is a bit of an odd finding that I don’t have a great explanation for. (Someone please math-splain to me.) Nonetheless, we see that UMAP does better than PCA overall, as we observed with kmeans.</p>
<p>For those interested in the code, I <code>map</code>-ed a function across a grid of parameters to generate the data for these plots.<sup>4</sup></p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">do_dimr_clust <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(df, n, k, dimr, clust, ...) {</span>
<span id="cb2-2">  step_f <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">switch</span>(dimr, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'pca'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> recipes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>step_pca, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'umap'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> embed<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>step_umap)</span>
<span id="cb2-3">  fit_f <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">switch</span>(clust, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'kmeans'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> stats<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>kmeans, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'gmm'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> mclust<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>Mclust)</span>
<span id="cb2-4">  </span>
<span id="cb2-5">  d <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> recipes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">recipe</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">formula</span>( <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> .), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> df) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb2-6">    recipes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">step_normalize</span>(recipes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all_numeric_predictors</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb2-7">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">step_f</span>(recipes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all_numeric_predictors</span>(), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">num_comp =</span> n) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb2-8">    recipes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prep</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb2-9">    recipes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">juice</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb2-10">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">where</span>(is.numeric))</span>
<span id="cb2-11">  fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fit_f</span>(d, k, ...)</span>
<span id="cb2-12">  broom<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glance</span>(fit)</span>
<span id="cb2-13">}</span>
<span id="cb2-14"></span>
<span id="cb2-15">metrics <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">crossing</span>(</span>
<span id="cb2-16">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq.int</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>),</span>
<span id="cb2-17">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">k =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq.int</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>),</span>
<span id="cb2-18">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">f_dimr =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'pca'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'umap'</span>),</span>
<span id="cb2-19">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">f_clust =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'kmeans'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'mclust'</span>)</span>
<span id="cb2-20">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb2-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">metrics =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmap</span>(</span>
<span id="cb2-22">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(n, k, f_dimr, f_clust),</span>
<span id="cb2-23">    <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">do_dimr_clust</span>(</span>
<span id="cb2-24">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">df =</span> df,</span>
<span id="cb2-25">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> ..<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb2-26">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">k =</span> ..<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,</span>
<span id="cb2-27">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">f_dimr =</span> ..<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,</span>
<span id="cb2-28">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">f_clust =</span> ..<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span></span>
<span id="cb2-29">    )</span>
<span id="cb2-30">  ))</span>
<span id="cb2-31">metrics</span>
<span id="cb2-32"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 196 x 5</span></span>
<span id="cb2-33"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;        n     k f     g      metrics         </span></span>
<span id="cb2-34"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    &lt;int&gt; &lt;int&gt; &lt;chr&gt; &lt;chr&gt;  &lt;list&gt;          </span></span>
<span id="cb2-35"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  1     2     2 pca   kmeans &lt;tibble [1 x 4]&gt;</span></span>
<span id="cb2-36"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  2     2     2 pca   gmm    &lt;tibble [1 x 7]&gt;</span></span>
<span id="cb2-37"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  3     2     2 umap  kmeans &lt;tibble [1 x 4]&gt;</span></span>
<span id="cb2-38"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  4     2     2 umap  gmm    &lt;tibble [1 x 7]&gt;</span></span>
<span id="cb2-39"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  5     2     3 pca   kmeans &lt;tibble [1 x 4]&gt;</span></span>
<span id="cb2-40"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  6     2     3 pca   gmm    &lt;tibble [1 x 7]&gt;</span></span>
<span id="cb2-41"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  7     2     3 umap  kmeans &lt;tibble [1 x 4]&gt;</span></span>
<span id="cb2-42"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  8     2     3 umap  gmm    &lt;tibble [1 x 7]&gt;</span></span>
<span id="cb2-43"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  9     2     4 pca   kmeans &lt;tibble [1 x 4]&gt;</span></span>
<span id="cb2-44"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 10     2     4 pca   gmm    &lt;tibble [1 x 7]&gt;</span></span>
<span id="cb2-45"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # ... with 186 more rows</span></span></code></pre></div>
</details>
</div>
</section>
<section id="supervised-evaluation" class="level2">
<h2 class="anchored" data-anchor-id="supervised-evaluation">“Supervised” Evaluation</h2>
<p>We actually do have something that we can use to help us identify clusters—player position (<code>pos</code>). Let’s treat these position groups as pseudo-labels with which we can gauge the effectiveness of the clustering.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb3-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb3-3">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(</span>
<span id="cb3-4">      pos,</span>
<span id="cb3-5">      <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(</span>
<span id="cb3-6">        .x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'DF,MF'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'MF,DF'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'DM'</span>,</span>
<span id="cb3-7">        .x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'DF,FW'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'FW,DF'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'M'</span>,</span>
<span id="cb3-8">        .x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'MF,FW'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'FW,MF'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'AM'</span>,</span>
<span id="cb3-9">        .x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'DF'</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'D'</span>,</span>
<span id="cb3-10">        .x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'MF'</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'M'</span>,</span>
<span id="cb3-11">        .x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'FW'</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'F'</span>,</span>
<span id="cb3-12">        .x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'GK'</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'G'</span>,</span>
<span id="cb3-13">        .x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'GK,MF'</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'G'</span>,</span>
<span id="cb3-14">        <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> .x</span>
<span id="cb3-15">      )</span>
<span id="cb3-16">    )</span>
<span id="cb3-17">  )</span>
<span id="cb3-18">df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">count</span>(pos, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sort =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb3-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 6 x 2</span></span>
<span id="cb3-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;   pos       n</span></span>
<span id="cb3-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;   &lt;chr&gt; &lt;int&gt;</span></span>
<span id="cb3-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 1 D       595</span></span>
<span id="cb3-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 2 M       364</span></span>
<span id="cb3-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 3 AM      273</span></span>
<span id="cb3-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 4 F       196</span></span>
<span id="cb3-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 5 G       113</span></span>
<span id="cb3-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 6 DM       85</span></span></code></pre></div>
</details>
</div>
<p>Typically we don’t have labels for clustering tasks; if we do, we’re usually doing some kind of supervised multi-label classification. But our labels aren’t “true” labels in this case, both because:</p>
<ol type="1">
<li>a player’s nominal position often doesn’t completely describe their style of play, and</li>
<li>the grouping I did to reduce the number of positions from 11 to 6 was perhaps not optimal.</li>
</ol>
<p>So now let’s do the same as before—evaluate different combinations of PCA and UMAP with kmeans and GMM. But now we can use some supervised evaluation metrics: (1) <a href="https://en.wikipedia.org/wiki/Accuracy_and_precision">accuracy</a> and (2) mean <a href="https://en.wikipedia.org/wiki/Cross_entropy">log loss</a>. While the former is based on the “hard” predictions, the latter is based on probabilities for each class. kmeans returns just hard cluster assignments, so computing accuracy is straightforward; since it doesn’t return probabilities, we’ll treat the hard assignments as having a probability of 1 to compute log loss.<sup>5</sup></p>
<p>We can compare the two clustering methods more directly now using these two metrics. Since we know that there are 6 position groups, we’ll keep the number of clusters constant at 6. (Note that number of <strong>clusters</strong> was shown on the x-axis before; but since we have fixed number of components at 6, now we show the number of <strong>components</strong> on the x-axis.)</p>
<p>Looking at accuracy first, we see that the best combo depends on our choice for number of components. Overall, we might say that the UMAP combos are better.</p>
<p><img src="https://tonyelhabr.rbind.io/posts/dimensionality-reduction-and-clustering/viz_acc.png" class="img-fluid"></p>
<p>Next, looking at average log loss, we see that the GMM clustering methods seem to do better overall (although this may be due to the fact that log loss is not typically used for supervised kmeans). The PCA + GMM does the best across all number of components, with the exception of 7. Note that we get a mean log loss around 28 when we predict the majority class (defender) with a probability of 1 for all observations. (This is a good “baseline” to contextualize our numbers.)</p>
<p><img src="https://tonyelhabr.rbind.io/posts/dimensionality-reduction-and-clustering/viz_ll.png" class="img-fluid"></p>
<p>UMAP shines relative to PCA according to accuracy, and GMM beats out kmeans in terms of log loss. Despite these conclusions, we still don’t have clear evidence that UMAP + GMM is the best 1-2 combo; nonetheless, we can at least feel good about its general strength.</p>
<section id="aside-re-coding-clusters" class="level3">
<h3 class="anchored" data-anchor-id="aside-re-coding-clusters">Aside: Re-coding Clusters</h3>
<p>I won’t bother to show all the code to generate the above plots since it’s mostly just <code>broom::augmment()</code> and <code>{ggplot2}</code>. But, if you have ever worked with supervised stuff like this (if we can call it that), you’ll know that figuring out which of your clusters correspond to your known groups can be difficult. In this case, I started from a variable holding the predicted <code>.class</code> and the true class (<code>pos</code>).</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">assignments</span>
<span id="cb4-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 1,626 x 2</span></span>
<span id="cb4-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    .class pos  </span></span>
<span id="cb4-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;     &lt;int&gt; &lt;chr&gt;</span></span>
<span id="cb4-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  1      1 D    </span></span>
<span id="cb4-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  2      2 D    </span></span>
<span id="cb4-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  3      3 M    </span></span>
<span id="cb4-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  4      3 M    </span></span>
<span id="cb4-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  5      4 AM   </span></span>
<span id="cb4-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  6      2 D    </span></span>
<span id="cb4-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  7      2 D    </span></span>
<span id="cb4-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  8      4 F    </span></span>
<span id="cb4-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  9      2 D    </span></span>
<span id="cb4-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 10      1 D    </span></span>
<span id="cb4-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # ... with 1,616 more rows</span></span></code></pre></div>
</details>
</div>
<p>I generated a correlation matrix for these two columns, ready to pass into a matching procedure.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">assignments <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb5-2">  fastDummies<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dummy_cols</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.class'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'pos'</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">remove_selected_columns =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb5-3">  corrr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">correlate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'spearman'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">quiet =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb5-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(term <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_detect</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'pos'</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb5-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(term, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matches</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'^[.]class'</span>))</span>
<span id="cb5-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 6 x 7</span></span>
<span id="cb5-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;   term   .class_1 .class_2 .class_3 .class_4 .class_5 .class_6</span></span>
<span id="cb5-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;   &lt;chr&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;</span></span>
<span id="cb5-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 1 pos_AM  -0.208   -0.241   -0.178    0.0251   0.625   -0.123 </span></span>
<span id="cb5-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 2 pos_D    0.499    0.615   -0.335   -0.264   -0.428   -0.208 </span></span>
<span id="cb5-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 3 pos_DM   0.0797   0.0330   0.0548  -0.0829  -0.0519  -0.0642</span></span>
<span id="cb5-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 4 pos_F   -0.171   -0.199   -0.168    0.724    0.0232  -0.101 </span></span>
<span id="cb5-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 5 pos_G   -0.127   -0.147   -0.124   -0.0964  -0.157    1     </span></span>
<span id="cb5-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 6 pos_M   -0.222   -0.267    0.724   -0.180    0.0395  -0.147</span></span></code></pre></div>
</details>
</div>
<p>Then I used <code>clue::solve_LSAP()</code> to do the <a href="https://en.wikipedia.org/wiki/Hungarian_algorithm">bipartite matching magic</a>. The rest is just pre- and post-processing.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">k <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># number of clusters</span></span>
<span id="cb6-2">cols_idx <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>(k<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb6-3">cors_mat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(cors[,cols_idx]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># all values have to be positive</span></span>
<span id="cb6-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rownames</span>(cors_mat) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> cors<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>term</span>
<span id="cb6-5">cols <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(cors)[cols_idx]</span>
<span id="cb6-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(cors_mat) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> cols</span>
<span id="cb6-7">cols_idx_min <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> clue<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">solve_LSAP</span>(cors_mat, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">maximum =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb6-8">cols_min <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> cols[cols_idx_min]</span>
<span id="cb6-9">tibble<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb6-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.class =</span> cols_min <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_remove</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'^[.]class_'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.integer</span>(),</span>
<span id="cb6-11">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pos =</span> cors<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>term <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_remove</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'pos_'</span>)</span>
<span id="cb6-12">)</span>
<span id="cb6-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 6 x 2</span></span>
<span id="cb6-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;   .class pos  </span></span>
<span id="cb6-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    &lt;int&gt; &lt;chr&gt;</span></span>
<span id="cb6-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 1      5 AM   </span></span>
<span id="cb6-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 2      2 D    </span></span>
<span id="cb6-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 3      1 DM   </span></span>
<span id="cb6-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 4      4 F    </span></span>
<span id="cb6-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 5      6 G    </span></span>
<span id="cb6-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 6      3 M </span></span></code></pre></div>
</details>
</div>
<p>This <code>pairs</code> variable can be used to re-code the <code>.class</code> column in our <code>assignments</code> from before.</p>
</section>
</section>
<section id="case-study-pca-vs.-umap" class="level2">
<h2 class="anchored" data-anchor-id="case-study-pca-vs.-umap">Case Study: PCA vs.&nbsp;UMAP</h2>
<p>Let’s step back from the clustering techniques and focus on dimensionality reduction for a moment. One of the ways that dimensionality reduction can be leveraged in sports like soccer is for player similarity metrics.<sup>6</sup> Let’s take a look at how this can be done, comparing the PCA and UMAP results while we’re at it.</p>
<p>Direct comparison of the similarity “scores” we’ll compute—based on Euclidean distance between a chosen player’s components and other players’ components—is not wise given the different ranges of our PCA and UMAP components, so we’ll rely on rankings based on these scores.<sup>7</sup> Additionally, <a href="https://fbref.com/">fbref</a> provides a “baseline” that we can use to judge our similarity rankings.<sup>8</sup></p>
<p>We’ll start with <a href="https://fbref.com/en/players/dbf053da/Jadon-Sancho">Jadon Sancho</a>, a highly discussed player at the moment (as a potential transfer).</p>
<span style="max-width:100%; height:auto"><img src="https://tonyelhabr.rbind.io/posts/dimensionality-reduction-and-clustering/jadon-sancho-fbref.PNG"></span>
<p>We first need to set up our data into the following format. (This is for 2-component, 6-cluster UMAP + GMM.)</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">sims_int</span>
<span id="cb7-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 1,664 x 6</span></span>
<span id="cb7-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    player_1     player_2           comp_1 comp_2 value_1 value_2</span></span>
<span id="cb7-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    &lt;chr&gt;        &lt;chr&gt;               &lt;int&gt;  &lt;int&gt;   &lt;dbl&gt;   &lt;dbl&gt;</span></span>
<span id="cb7-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  1 Jadon Sancho Aaron Leya Iseka        1      1  -4.18  -5.14  </span></span>
<span id="cb7-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  2 Jadon Sancho Aaron Leya Iseka        2      2  -0.678  2.49  </span></span>
<span id="cb7-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  3 Jadon Sancho Aaron Ramsey            1      1  -4.18  -3.25  </span></span>
<span id="cb7-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  4 Jadon Sancho Aaron Ramsey            2      2  -0.678 -0.738 </span></span>
<span id="cb7-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  5 Jadon Sancho Abdoul Kader Bamba      1      1  -4.18  -3.40  </span></span>
<span id="cb7-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  6 Jadon Sancho Abdoul Kader Bamba      2      2  -0.678  0.0929</span></span>
<span id="cb7-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  7 Jadon Sancho Abdoulaye Doucouré      1      1  -4.18  -1.36  </span></span>
<span id="cb7-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  8 Jadon Sancho Abdoulaye Doucouré      2      2  -0.678 -2.66  </span></span>
<span id="cb7-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  9 Jadon Sancho Abdoulaye Touré         1      1  -4.18  -1.36  </span></span>
<span id="cb7-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 10 Jadon Sancho Abdoulaye Touré         2      2  -0.678 -2.89  </span></span>
<span id="cb7-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # ... with 1,654 more rows</span></span></code></pre></div>
</details>
</div>
<p>Then the Euclidean distance calculation is fairly straightforward.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1">sims_init <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb8-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(player_1, player_2) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb8-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(</span>
<span id="cb8-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">d =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>((value_1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> value_2)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span>
<span id="cb8-5">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb8-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb8-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">score =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> ((d <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(d) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb8-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rnk =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">row_number</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">desc</span>(score))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb8-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(rnk) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb8-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">player =</span> player_2, d, score, rnk)</span>
<span id="cb8-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 830 x 4</span></span>
<span id="cb8-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    player                  d score   rnk</span></span>
<span id="cb8-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    &lt;chr&gt;               &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt;</span></span>
<span id="cb8-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  1 Alexis Sánchez     0.0581 0.994     1</span></span>
<span id="cb8-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  2 Riyad Mahrez       0.120  0.988     2</span></span>
<span id="cb8-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  3 Serge Gnabry       0.132  0.986     3</span></span>
<span id="cb8-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  4 Jack Grealish      0.137  0.986     4</span></span>
<span id="cb8-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  5 Pablo Sarabia      0.171  0.983     5</span></span>
<span id="cb8-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  6 Thomas Müller      0.214  0.978     6</span></span>
<span id="cb8-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  7 Leroy Sané         0.223  0.977     7</span></span>
<span id="cb8-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  8 Callum Hudson-Odoi 0.226  0.977     8</span></span>
<span id="cb8-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  9 Jesse Lingard      0.260  0.973     9</span></span>
<span id="cb8-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 10 Ousmane Dembélé    0.263  0.973    10</span></span>
<span id="cb8-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # ... with 820 more rows</span></span></code></pre></div>
</details>
</div>
<p>Doing the same for PCA and combining all results, we get the following set of rankings.</p>
<span style="max-width:80%; height:auto"><img src="https://tonyelhabr.rbind.io/posts/dimensionality-reduction-and-clustering/gt_similarity_jadon_sancho.png"></span>
<p>We see that the UMAP rankings are “closer” overall to the fbref rankings. Of course, there are some caveats:</p>
<ol type="1">
<li>This is just one player.</li>
<li>This is with a specific number of components and clusters.</li>
<li>We are comparing to similarity rankings based on a separate methodology.</li>
</ol>
<p>Our observation here (that UMAP &gt; PCA) shouldn’t be taken out of context to conclude that UMAP &gt; PCA in all contexts. Nonetheless, I think this is an interesting use case for dimensionality reduction, where one can justify PCA, UMAP, or any other similar technique, depending on how intuitive the results are.</p>
</section>
<section id="case-study-umap-gmm" class="level2">
<h2 class="anchored" data-anchor-id="case-study-umap-gmm">Case Study: UMAP + GMM</h2>
<p>Finally, let’s bring clustering back into the conversation. We’re going to focus on how the heralded UMAP + GMM combo can be visualized to provide insight that supports (or debunks) our prior understanding.</p>
<p>With a 2-component UMAP + 6-cluster GMM, we can see how the 6 position groups can be identified in a 2-D space.</p>
<p><img src="https://tonyelhabr.rbind.io/posts/dimensionality-reduction-and-clustering/viz_uncertainty_umap_full.png" class="img-fluid"></p>
<p>For those curious, using PCA instead of UMAP also leads to an identifiable set of clusters. However, uncertainties are generally higher across the board (larger point sizes, more overlap between covariance ellipsoids).</p>
<p><img src="https://tonyelhabr.rbind.io/posts/dimensionality-reduction-and-clustering/viz_uncertainty_pca_full.png" class="img-fluid"></p>
<p>If we exclude keepers (G) and defenders (D) to focus on the other 4 positions with our UMAP + GMM approach, we can better see how some individual points —at the edges or outside of covariance ellipsoids—are classified with a higher degree of uncertainty.<sup>9</sup></p>
<p><img src="https://tonyelhabr.rbind.io/posts/dimensionality-reduction-and-clustering/viz_uncertainty_umap_filt.png" class="img-fluid"></p>
<p>Now, highlighting incorrect classifications, we can see how the defensive midfielder (DM) position group (upper left) seems to be a blind spot in our approach.</p>
<p><img src="https://tonyelhabr.rbind.io/posts/dimensionality-reduction-and-clustering/viz_misclassified_umap.png" class="img-fluid"></p>
<p>A more traditional confusion matrix<sup>10</sup> also illustrates the inaccuracy with classifying DMs. (Note the lack of dark grey fill in the DM column.)</p>
<p><img src="https://tonyelhabr.rbind.io/posts/dimensionality-reduction-and-clustering/viz_cm_umap.png" class="img-fluid"></p>
<p>DMs are often classified as defenders instead. I think this poor result has is more so due to my lazy grouping of players with <code>"MF,DF"</code> or <code>"DF,MF"</code> positions in the original data set than a fault in our approach.</p>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>So, should our overall conclusion be that we should never use PCA or kmeans? No, not necessarily. They can both be much faster to compute than UMAP and GMMs respectively, which can be a huge positive if computation is a concern. PCA is linear while UMAP is not, so you may want to choose PCA to make it easier to explain to your friends. Regarding clustering, kmeans is technically a specific form of a GMM, so if you want to sound cool to your friends and tell them that you use GMMs, you can do that.</p>
<p>Anyways, I hope I’ve shown why you should try out UMAP and GMM the next time you think about using PCA and kmeans.</p>



</section>


<div class="quarto-listing quarto-listing-container-default" id="listing-listing">
<div class="list quarto-listing-default">

</div>
<div class="listing-no-matching d-none">
No matching items
</div>
</div><div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>In some contexts you may want to do feature selection and/or manual grouping of data.↩︎</p></li>
<li id="fn2"><p>While this whole thing is more about comparing techniques, I should make a note about WSS. We don’t want to increase the number of components for the sake of minimizing WSS. We lose some degree of interpretation with increasing components. Additionally, we could be <a href="https://en.wikipedia.org/wiki/Overfitting">overfitting</a> the model by increasing the number of components. Although we don’t have the intention of classifying new observations in this demo, it’s still good to keep overfitting in mind.↩︎</p></li>
<li id="fn3"><p>This demo isn’t really intended to be a study in how to choose the best number of clusters, but I figured I’d point this out.↩︎</p></li>
<li id="fn4"><p>I’d suggest <a href="https://juliasilge.com/blog/kmeans-employment/">this blog post from Julia Silge</a> for a better explanation of clustering with R and <a href="https://www.tidymodels.org/"><code>{tidymodels}</code></a>.↩︎</p></li>
<li id="fn5"><p>Perhaps this is against best practice, but we’ll do it here for the sake of comparison.↩︎</p></li>
<li id="fn6"><p>Normalization perhaps doesn’t help much here given the clustered nature of the reduced data.↩︎</p></li>
<li id="fn7"><p>Normalization perhaps doesn’t help much here given the clustered nature of the reduced data.↩︎</p></li>
<li id="fn8"><p>fbref uses a different methodology, so perhaps it’s unwise to compare to them.↩︎</p></li>
<li id="fn9"><p>Sure, one can argue that a player like Diogo Jota should have been classified as an attacking midfielder (AM) to begin with, in which case he might not have been misclassified here.↩︎</p></li>
<li id="fn10"><p>By the way, the <code>autoplot()</code> function for <code>yardstick::conf_mat()</code> results is awesome if you haven’t ever used it.↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>r</category>
  <category>soccer</category>
  <guid>https://tonyelhabr.rbind.io/posts/dimensionality-reduction-and-clustering/index.html</guid>
  <pubDate>Wed, 30 Jun 2021 05:00:00 GMT</pubDate>
  <media:content url="https://tonyelhabr.rbind.io/posts/dimensionality-reduction-and-clustering/featured.png" medium="image" type="image/png" height="144" width="144"/>
</item>
<item>
  <title>Quantifying Relative Soccer League Strength</title>
  <dc:creator>Tony ElHabr</dc:creator>
  <link>https://tonyelhabr.rbind.io/posts/soccer-league-strength/index.html</link>
  <description><![CDATA[ 



<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>Arguing about domestic league strength is something that soccer fans seems to never tire of. (<a href="https://www.goal.com/en-us/news/what-does-can-they-do-it-on-a-cold-rainy-night-in-stoke-mean/1f7alegnrwfr01i5vj34vak59k"><em>“Could Messi do it on a cold rainy night in Stoke?”</em></a>) Many of these conversations are anecdotal, leading to “hot takes” that are unfalsifiable. While we’ll probably never move away from these kinds of discussions, we can at least try to inform them with a quantitative approach.</p>
<p>Perhaps the obvious way to do so is to take match results from international tournaments (e.g.&nbsp;Champions League, Europa). But such an approach can be flawed—there’s not a large sample, and match results may not be reflective of “true” team strength (e.g.&nbsp;one team may win on xG by a large margin, but lose the game.)</p>
</section>
<section id="methodology" class="level2">
<h2 class="anchored" data-anchor-id="methodology">Methodology</h2>
<p>But what if we used an approach rooted in player performance? <a href="https://twitter.com/TonyElHabr/status/1405946557237796871">I asked myself</a> that very question and came up with the following approach. (Thanks to <a href="https://twitter.com/canzhiye">Cahnzhi Ye</a> for the data.)</p>
<ol type="1">
<li>Identify players who played in more than one league within the same season or across consecutive seasons. Calculate the difference in each player’s <a href="https://arxiv.org/pdf/1802.07127.pdf">atomic VAEP</a><sup>1</sup> per 90 minutes (VAEP/90) after changing leagues.</li>
</ol>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 2,462 x 7</span></span>
<span id="cb1-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    Season Player        `League A`        `League B`       `VAEP/90 A` `VAEP/90 B`   Diff.</span></span>
<span id="cb1-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;     &lt;dbl&gt; &lt;chr&gt;         &lt;chr&gt;             &lt;chr&gt;                  &lt;dbl&gt;       &lt;dbl&gt;   &lt;dbl&gt;</span></span>
<span id="cb1-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  1   2020 Timo Werner   Bundesliga 1 (Ge~ Premier League ~       1.25        0.638  0.610 </span></span>
<span id="cb1-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  2   2020 Alexander Sø~ Super Lig (Turke~ Bundesliga 1 (G~       1.07        0.773  0.296 </span></span>
<span id="cb1-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  3   2020 Hakim Ziyech  Eredivisie (Neth~ Premier League ~       0.958       0.365  0.593 </span></span>
<span id="cb1-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  4   2020 Nicolás Gonz~ Bundesliga 2 (Ge~ Bundesliga 1 (G~       0.917       0.943 -0.0256</span></span>
<span id="cb1-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  5   2020 Fabian Klos   Bundesliga 2 (Ge~ Bundesliga 1 (G~       0.904       0.547  0.358 </span></span>
<span id="cb1-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  6   2020 Victor Osimh~ Ligue 1 (France)  Serie A (Italy)        0.889       1.01  -0.120 </span></span>
<span id="cb1-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  7   2020 Eldor Shomur~ Premier League (~ Serie A (Italy)        0.882       0.755  0.126 </span></span>
<span id="cb1-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  8   2020 Callum Robin~ Championship (En~ Premier League ~       0.880       0.682  0.198 </span></span>
<span id="cb1-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  9   2020 Jarrod Bowen  Championship (En~ Premier League ~       0.871       0.448  0.423 </span></span>
<span id="cb1-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 10   2020 Aleksandar M~ Championship (En~ Premier League ~       0.866       0.499  0.367 </span></span>
<span id="cb1-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # ... with 2,452 more rows</span></span></code></pre></div>
</details>
</div>
<p>Why VAEP? Theoretically it should capture more about in-game actions (including defense) than other stats such as <a href="https://fbref.com/en/expected-goals-model-explained/">xG</a>, which is biased in favor of attacking players. VAEP is not perfect by any means (e.g.&nbsp;it does not capture off-ball actions), but, in theory, it should be a better measure of overall performance. <sup>2</sup></p>
<p>Notably, we give up a little in interpretability in using VAEP, since it’s not directly translatable to goals. <sup>3</sup> The following table of top season-long xG totals since 2012 to contextualize the magnitudes of xG and VAEP.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 36,857 x 5</span></span>
<span id="cb2-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    Season Player             Minutes    xG  VAEP</span></span>
<span id="cb2-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;     &lt;dbl&gt; &lt;chr&gt;                &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb2-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  1   2015 Lionel Messi          3529  38.1  69.0</span></span>
<span id="cb2-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  2   2016 Luis Suárez           3294  35.6  55.7</span></span>
<span id="cb2-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  3   2018 Robert Lewandowski    2259  35.1  40.2</span></span>
<span id="cb2-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  4   2012 Lionel Messi          3425  32.4  76.2</span></span>
<span id="cb2-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  5   2013 Lionel Messi          2776  31.6  60.0</span></span>
<span id="cb2-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  6   2015 Cristiano Ronaldo     3236  30.8  58.7</span></span>
<span id="cb2-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  7   2018 Mohamed Salah         3080  30.4  50.5</span></span>
<span id="cb2-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  8   2012 Cristiano Ronaldo     3504  30.1  62.7</span></span>
<span id="cb2-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  9   2017 Edin Dzeko            3216  29.8  49.7</span></span>
<span id="cb2-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 10   2020 Robert Lewandowski    2902  29.7  49.2</span></span>
<span id="cb2-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # ... with 36,847 more rows</span></span></code></pre></div>
</details>
</div>
<p>And a scatter plot, because who doesn’t love a graph.</p>
<p><img src="https://tonyelhabr.rbind.io/posts/soccer-league-strength/viz_xg_v_vaep.png" class="img-fluid"></p>
<ol start="2" type="1">
<li>Convert the player-level VAEP/90 differences to z-scores by position and age group.</li>
</ol>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 2,462 x 7</span></span>
<span id="cb3-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    Season Player      Position `Age Group` `League A`      `League B`    `VAEP/90 Diff. Z`</span></span>
<span id="cb3-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;     &lt;dbl&gt; &lt;chr&gt;       &lt;chr&gt;    &lt;chr&gt;       &lt;chr&gt;           &lt;chr&gt;                     &lt;dbl&gt;</span></span>
<span id="cb3-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  1   2020 Timo Werner AM       24&lt;=x&lt;27    Bundesliga 1 (~ Premier Leagu~            2.28 </span></span>
<span id="cb3-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  2   2020 Alexander ~ FW       24&lt;=x&lt;27    Super Lig (Tur~ Bundesliga 1 ~            1.10 </span></span>
<span id="cb3-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  3   2020 Hakim Ziye~ M        27&lt;=x&lt;30    Eredivisie (Ne~ Premier Leagu~            3.20 </span></span>
<span id="cb3-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  4   2020 Nicolás Go~ M        18&lt;=x&lt;24    Bundesliga 2 (~ Bundesliga 1 ~           -0.148</span></span>
<span id="cb3-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  5   2020 Fabian Klos FW       30&lt;=x&lt;36    Bundesliga 2 (~ Bundesliga 1 ~            1.20 </span></span>
<span id="cb3-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  6   2020 Victor Osi~ FW       18&lt;=x&lt;24    Ligue 1 (Franc~ Serie A (Ital~           -0.439</span></span>
<span id="cb3-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  7   2020 Eldor Shom~ FW       24&lt;=x&lt;27    Premier League~ Serie A (Ital~            0.471</span></span>
<span id="cb3-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  8   2020 Callum Rob~ AM       24&lt;=x&lt;27    Championship (~ Premier Leagu~            0.740</span></span>
<span id="cb3-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  9   2020 Jarrod Bow~ AM       18&lt;=x&lt;24    Championship (~ Premier Leagu~            1.89 </span></span>
<span id="cb3-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 10   2020 Aleksandar~ FW       24&lt;=x&lt;27    Championship (~ Premier Leagu~            1.37 </span></span>
<span id="cb3-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # ... with 2,452 more rows</span></span></code></pre></div>
</details>
</div>
<p>Why grouping? This is intended to account for the fact that attacking players and “peaking” players (usually age 24-30) tend to have higher VAEP/90, so their league-to-league differences have larger variation. The choice to normalize is perhaps more questionable. The mean of differences is ~0 for all groups already, but the dispersion is smaller without normalization (i.e.&nbsp;standard deviations are closer to 0). So, in this case, normalization should help the linear model capture variation.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 20 x 5</span></span>
<span id="cb4-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    Position Age Group N    Mean   SD</span></span>
<span id="cb4-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    &lt;chr&gt;    &lt;chr&gt;    &lt;int&gt; &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span id="cb4-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  1 AM       18&lt;=x&lt;24   138     0 0.224 </span></span>
<span id="cb4-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  2 AM       24&lt;=x&lt;27   128     0 0.268 </span></span>
<span id="cb4-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  3 AM       27&lt;=x&lt;30   118     0 0.248 </span></span>
<span id="cb4-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  4 AM       30&lt;=x&lt;36    68     0 0.248 </span></span>
<span id="cb4-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  5 D        18&lt;=x&lt;24   203     0 0.112 </span></span>
<span id="cb4-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  6 D        24&lt;=x&lt;27   268     0 0.101 </span></span>
<span id="cb4-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  7 D        27&lt;=x&lt;30   295     0 0.0930</span></span>
<span id="cb4-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  8 D        30&lt;=x&lt;36   316     0 0.0939</span></span>
<span id="cb4-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  9 DM       18&lt;=x&lt;24    30     0 0.102 </span></span>
<span id="cb4-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 10 DM       24&lt;=x&lt;27    48     0 0.0913</span></span>
<span id="cb4-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 11 DM       27&lt;=x&lt;30    20     0 0.105 </span></span>
<span id="cb4-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 12 DM       30&lt;=x&lt;36    13     0 0.0719</span></span>
<span id="cb4-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 13 FW       18&lt;=x&lt;24    26     0 0.274 </span></span>
<span id="cb4-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 14 FW       24&lt;=x&lt;27    67     0 0.268 </span></span>
<span id="cb4-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 15 FW       27&lt;=x&lt;30    50     0 0.263 </span></span>
<span id="cb4-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 16 FW       30&lt;=x&lt;36    66     0 0.297 </span></span>
<span id="cb4-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 17 M        18&lt;=x&lt;24   113     0 0.173 </span></span>
<span id="cb4-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 18 M        24&lt;=x&lt;27   130     0 0.147 </span></span>
<span id="cb4-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 19 M        27&lt;=x&lt;30   189     0 0.185 </span></span>
<span id="cb4-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 20 M        30&lt;=x&lt;36   186     0 0.171  </span></span></code></pre></div>
</details>
</div>
<ol start="3" type="1">
<li>Run a single regression where the response variable is the z-transformed VAEP/90 difference, and the features are indicators for leagues, where -1 indicates player departure, a +1 indicates player arrival, and all other values are 0.<sup>4</sup> <sup>5</sup></li>
</ol>
<p>For those familiar with basketball and hockey, this is similar to the set-up for <a href="https://squared2020.com/2017/09/18/deep-dive-on-regularized-adjusted-plus-minus-i-introductory-example/">an adjusted plus-minus (APM) calculation</a>. Here, each feature column is a league (instead of a player), each row represents a player (instead of a “stint”), and the response is transformed VAEP/90 (instead of net points per possession).</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; tibble [2,472 x 16] (S3: tbl_df/tbl/data.frame)</span></span>
<span id="cb5-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  $ VAEP/90 Diff Z-Trans     : num [1:2472] -0.0825 0.3285 -0.0143 0.1137 0.1526 ...</span></span>
<span id="cb5-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  $ Serie A (Italy)          : int [1:2472] -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 ...</span></span>
<span id="cb5-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  $ Bundesliga 1 (Germany)   : int [1:2472] 1 1 0 0 0 0 0 0 0 0 ...</span></span>
<span id="cb5-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  $ La Liga (Spain)          : int [1:2472] 0 0 0 0 0 0 0 0 0 0 ...</span></span>
<span id="cb5-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  $ Serie A (Brazil)         : int [1:2472] 0 0 0 0 0 1 0 0 0 0 ...</span></span>
<span id="cb5-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  $ Super Lig (Turkey)       : int [1:2472] 0 0 1 0 0 0 0 1 0 0 ...</span></span>
<span id="cb5-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  $ Premier League (England) : int [1:2472] 0 0 0 0 0 0 0 0 0 0 ...</span></span>
<span id="cb5-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  $ Super League (China)     : int [1:2472] 0 0 0 0 0 0 0 0 0 1 ...</span></span>
<span id="cb5-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  $ Major League Soccer (USA): int [1:2472] 0 0 0 0 1 0 1 0 0 0 ...</span></span>
<span id="cb5-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  $ Primeira Liga (Portugal) : int [1:2472] 0 0 0 0 0 0 0 0 0 0 ...</span></span>
<span id="cb5-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  $ Ligue 1 (France)         : int [1:2472] 0 0 0 1 0 0 0 0 0 0 ...</span></span>
<span id="cb5-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  $ Bundesliga 2 (Germany)   : int [1:2472] 0 0 0 0 0 0 0 0 0 0 ...</span></span>
<span id="cb5-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  $ Championship (England)   : int [1:2472] 0 0 0 0 0 0 0 0 0 0 ...</span></span>
<span id="cb5-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  $ Premier League (Russia)  : int [1:2472] 0 0 0 0 0 0 0 0 0 0 ...</span></span>
<span id="cb5-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  $ Superliga (Argentina)    : int [1:2472] 0 0 0 0 0 0 0 0 1 0 ...</span></span>
<span id="cb5-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  $ Eredivisie (Netherlands) : int [1:2472] 0 0 0 0 0 0 0 0 0 0 ...</span></span></code></pre></div>
</details>
</div>
<p>The result is a set of coefficient estimates corresponding to each league. Notably, these are all positive (even if subtracting the intercept), and the Netherlands coefficient is <code>NA</code> due to multi-collinearity in the data. <sup>6</sup></p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 16 x 2</span></span>
<span id="cb6-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    League                    Estimate</span></span>
<span id="cb6-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    &lt;chr&gt;                        &lt;dbl&gt;</span></span>
<span id="cb6-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  1 Premier League (England)    0.975 </span></span>
<span id="cb6-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  2 La Liga (Spain)             0.869 </span></span>
<span id="cb6-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  3 Ligue 1 (France)            0.786 </span></span>
<span id="cb6-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  4 Serie A (Italy)             0.738 </span></span>
<span id="cb6-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  5 Serie A (Brazil)            0.724 </span></span>
<span id="cb6-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  6 Primeira Liga (Portugal)    0.675 </span></span>
<span id="cb6-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  7 Bundesliga 1 (Germany)      0.649 </span></span>
<span id="cb6-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  8 Championship (England)      0.641 </span></span>
<span id="cb6-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  9 Super Lig (Turkey)          0.617 </span></span>
<span id="cb6-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 10 Premier League (Russia)     0.485 </span></span>
<span id="cb6-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 11 Superliga (Argentina)       0.463 </span></span>
<span id="cb6-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 12 Super League (China)        0.360 </span></span>
<span id="cb6-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 13 Major League Soccer (USA)   0.281 </span></span>
<span id="cb6-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 14 Bundesliga 2 (Germany)      0.197 </span></span>
<span id="cb6-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 15 (Intercept)                 0.0747</span></span>
<span id="cb6-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 16 Eredivisie (Netherlands)   NA     </span></span></code></pre></div>
</details>
</div>
<p>For hockey/basketball APM, we would say the coefficient estimate represents how much a player contributes relative to an “average” player. We might be tempted to try to interpret these coefficients directly as well. Yes, we can infer the league “power rankings” from just this singular coefficient list (Premier League as the strongest and Bundesliga 2 as the weakest), but there are some issues.</p>
<ul>
<li><p>We first need to “un-transform” this back to the VAEP/90 scale. (See next step.)</p></li>
<li><p>Note that this is not a zero-sum situation (even after un-transforming). There is no notion of a matchup between one league and another like there is in hockey/basketball with players on the ice/court. Instead, our data is more analogous to a player playing against themselves (not a set of players versus another set of players).</p></li>
<li><p>Even if this were a zero-sum type of problem and the model returned some negative coefficient estimates, it’s unclear what the intercept (or 0) even means. Does it mean “average”? If so, what is an “average” league?</p></li>
<li><p>We accounted for minutes played—the “per 90” denominator—prior to subtracting rates (difference in VAEP/90), which is different than how APM works. In APM, the minutes played is directly accounted for in the response variable (net points, divided by possessions).</p></li>
</ul>
<p>The take-away here is that we can only interpret the model coefficients on a relative basis.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 256 x 5</span></span>
<span id="cb7-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    `League A`               `League B`               `Estimate A` `Estimate B` Diff.</span></span>
<span id="cb7-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    &lt;fct&gt;                    &lt;fct&gt;                           &lt;dbl&gt;        &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb7-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  1 Premier League (England) Premier League (England)        0.975        0.975 0    </span></span>
<span id="cb7-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  2 Premier League (England) La Liga (Spain)                 0.975        0.869 0.107</span></span>
<span id="cb7-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  3 Premier League (England) Ligue 1 (France)                0.975        0.786 0.189</span></span>
<span id="cb7-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  4 Premier League (England) Serie A (Italy)                 0.975        0.738 0.238</span></span>
<span id="cb7-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  5 Premier League (England) Serie A (Brazil)                0.975        0.724 0.252</span></span>
<span id="cb7-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  6 Premier League (England) Primeira Liga (Portugal)        0.975        0.675 0.300</span></span>
<span id="cb7-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  7 Premier League (England) Bundesliga 1 (Germany)          0.975        0.649 0.326</span></span>
<span id="cb7-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  8 Premier League (England) Championship (England)          0.975        0.641 0.334</span></span>
<span id="cb7-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  9 Premier League (England) Super Lig (Turkey)              0.975        0.617 0.358</span></span>
<span id="cb7-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 10 Premier League (England) Premier League (Russia)         0.975        0.485 0.491</span></span>
<span id="cb7-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # ... with 246 more rows</span></span></code></pre></div>
</details>
</div>
<ol start="4" type="1">
<li>“Un-transform” the coefficients of the regression using a “weighted-average” standard deviation and mean from the z-transformations of groups. <sup>7</sup></li>
</ol>
<p>Interpretation after this transformation can be a little tricky. The differences between a specified pair of these post-transformed coefficients represents the expected change in an “average” player’s VAEP/90 (<code>Diff. (VAEP/90)</code>) when moving between the specified leagues.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 256 x 4</span></span>
<span id="cb8-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    `League A`               `League B`               Diff. `Diff. (VAEP/90)`</span></span>
<span id="cb8-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    &lt;fct&gt;                    &lt;fct&gt;                    &lt;dbl&gt;             &lt;dbl&gt;</span></span>
<span id="cb8-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  1 Premier League (England) Premier League (England) 0                0     </span></span>
<span id="cb8-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  2 Premier League (England) La Liga (Spain)          0.107            0.0166</span></span>
<span id="cb8-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  3 Premier League (England) Ligue 1 (France)         0.189            0.0295</span></span>
<span id="cb8-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  4 Premier League (England) Serie A (Italy)          0.238            0.0371</span></span>
<span id="cb8-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  5 Premier League (England) Serie A (Brazil)         0.252            0.0393</span></span>
<span id="cb8-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  6 Premier League (England) Primeira Liga (Portugal) 0.300            0.0469</span></span>
<span id="cb8-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  7 Premier League (England) Bundesliga 1 (Germany)   0.326            0.0509</span></span>
<span id="cb8-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  8 Premier League (England) Championship (England)   0.334            0.0521</span></span>
<span id="cb8-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  9 Premier League (England) Super Lig (Turkey)       0.358            0.0559</span></span>
<span id="cb8-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 10 Premier League (England) Premier League (Russia)  0.491            0.0766</span></span>
<span id="cb8-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # ... with 246 more rows</span></span></code></pre></div>
</details>
</div>
<p>To interpret these differences as a percentage (so that we can “scale” the properly for a player with a VAEP/90 of 1.5, compared to a player with a lower VAEP/90 rate), we use the median VAEP/90 across all leagues as a “baseline”. For example, for Bundesliga -&gt; Premier League, since the overall median VAEP/90 is 0.305 and the <code>Diff. (VAEP/90)</code> between league A and league B is 0.0509, the <code>% Difference</code> is 0.0509/0.305 = 17%.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 256 x 5</span></span>
<span id="cb9-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    `League A`               `League B`               Diff. `Diff. (VAEP/90)` `% Diff.`</span></span>
<span id="cb9-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    &lt;fct&gt;                    &lt;fct&gt;                    &lt;dbl&gt;             &lt;dbl&gt; &lt;chr&gt;    </span></span>
<span id="cb9-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  1 Premier League (England) Premier League (England) 0                0      0%       </span></span>
<span id="cb9-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  2 Premier League (England) La Liga (Spain)          0.107            0.0166 5%       </span></span>
<span id="cb9-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  3 Premier League (England) Ligue 1 (France)         0.189            0.0295 10%      </span></span>
<span id="cb9-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  4 Premier League (England) Serie A (Italy)          0.238            0.0371 12%      </span></span>
<span id="cb9-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  5 Premier League (England) Serie A (Brazil)         0.252            0.0393 13%      </span></span>
<span id="cb9-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  6 Premier League (England) Primeira Liga (Portugal) 0.300            0.0469 15%      </span></span>
<span id="cb9-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  7 Premier League (England) Bundesliga 1 (Germany)   0.326            0.0509 17%      </span></span>
<span id="cb9-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  8 Premier League (England) Championship (England)   0.334            0.0521 17%      </span></span>
<span id="cb9-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  9 Premier League (England) Super Lig (Turkey)       0.358            0.0559 18%      </span></span>
<span id="cb9-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 10 Premier League (England) Premier League (Russia)  0.491            0.0766 25%      </span></span>
<span id="cb9-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # ... with 246 more rows</span></span></code></pre></div>
</details>
</div>
<p><img src="https://tonyelhabr.rbind.io/posts/soccer-league-strength/viz_relative_p_vaep_direct2z.png" class="img-fluid"></p>
</section>
<section id="improvements-further-work" class="level2">
<h2 class="anchored" data-anchor-id="improvements-further-work">Improvements &amp; Further Work</h2>
<ul>
<li><p>Although my approach does eventually get back to the original units (VAEP/90), it does feel a little convoluted. <a href="https://twitter.com/thecomeonman">Aditya Kothari</a> proposed re-defining the target variable in the regression to be the <strong>ratio of VAEP/minute</strong> (instead of a z-transformed difference in VAEP/90) between the leagues that a player moves to and from. (<a href="https://thecomeonman.github.io/PredictingTransferSuccesses/">See his full post.</a>) In my eyes, the main advantage of such an approach is that it is more direct. A player-level ratio embeds information about position and age—a forward will tend to have higher VAEP/minute than a defender, and will continue to have higher VAEP/minute than a defender after transferring—so normalizing for age and position is not necessarily justified. Additionally, the model’s league coefficients can be directly interpreted, unlike my approach. Perhaps the main disadvantage is sensitivity to low minutes played. <sup>8</sup></p></li>
<li><p>Another weakness in my approach is the assumption that relative league strengths are the same every year, which is most certainly not true. One could apply a decaying weight to past seasons to account for varying league strength.</p></li>
<li><p>I would be hesitant to use my results to directly infer how a specific player will translate going from one league to another. My approach focuses on leagues and is more about the “average” player. One aught to include additional features about play style (e.g.&nbsp;touches, progressive passes, team role) if interested in predicting individual player performance with a high degree of accuracy.</p></li>
<li><p>One can swap out the response variable with other reasonable metrics of player performance, such as xG (which is more readily available than atomic VAEP). In fact, I did this myself and came up with the result below (showing in units of xG/90 instead of as a percentage, since most fans are accustomed to seeing xG and are used to its relative magnitude).</p></li>
</ul>
<p><img src="https://tonyelhabr.rbind.io/posts/soccer-league-strength/viz_relative_vp_xg_direct2z.png" class="img-fluid"></p>
<ul>
<li>One could stay in the realm of just purely “power rankings” and focus more on the estimates and error. For example, in an earlier iteration of this methodology, I used a Bradley-Terry approach to come up with a distribution of estimates for each league.<sup>9</sup> Here, the x-axis could be loosely interpreted as the log odds of one league winning in a match versus another league, although it’s not clear exactly what that means. (An “average” team from both leagues? A matchup of teams composed of “average” players from any team in each league?)</li>
</ul>
<p><img src="https://tonyelhabr.rbind.io/posts/soccer-league-strength/coefs_bt.png" class="img-fluid"></p>
<ul>
<li>Notably, I’m not using match results at all! Certainly a model could learn something from international and tournament matches. However, using match-level data would require a whole new approach. Also, most would agree that tournament data can be biased by atypical lineups. For example, a manager on one side may opt to rest their best players, saving them for domestic league games, while the other manager may play their side at full strength.<sup>10</sup></li>
</ul>
<!-- -->
<ul>
<li>Sample size is an issue on two levels: (1) the number of transfers (more data would be better) and (2) minutes played.</li>
</ul>
<p>Regarding (1), one could expand the data set by including all seasons played by a player that has played in more than one league, taking all combinations of seasons in different leagues (i.e.&nbsp;relaxing the the same-season or subsequent-season criteria). I actually did attempt this and found that overall the results were somewhat similar, but there were more questionable results overall. (Brazil’s Serie A was found to be the second strongest league overall with this approach.).</p>
<p>Regarding (2), one has to make a choice to drop players with low minutes played to prevent outliers affecting the results of the model. However, in some cases, a loaned player coming in at the end of the season and making a huge impact can tell us a lot about the difference in strength of two leagues, so we may not want to drop some of the records after all. An empirical bayes adjustment to VAEP/90, not unlike <a href="http://varianceexplained.org/r/empirical_bayes_baseball/">the one described here</a> by <a href="https://twitter.com/drob">David Robinson</a>, can help overcome this. Below shows how such an adjustment slightly “shrinks” VAEP/90 numbers, especially for those who played less.</p>
<p><img src="https://tonyelhabr.rbind.io/posts/soccer-league-strength/viz_vaep_adj.png" class="img-fluid"></p>
<p>On the topic of “shrinking”, we could have used ridge regression (regression with some penalty) to get more robust league estimates overall. However, there is a downside to ridge regression—we give up some level of interpretability.<sup>11</sup> Nonetheless, the relative ranking of leagues would be more reliable with ridge regression.</p>
</section>
<section id="ancillary-take-away" class="level2">
<h2 class="anchored" data-anchor-id="ancillary-take-away">Ancillary Take-away</h2>
<p>One final thing I’d like to point out here: I think this whole approach really showcases the inference made possible by player stats (xG, possession value metrics like atomic VAEP, etc.) aggregated over long periods of time. While such stats are often used to evaluate player performance in single games or even for singular in-game actions, they are most effective in providing insight when employed in higher-level analyses.</p>



</section>


<div class="quarto-listing quarto-listing-container-default" id="listing-listing">
<div class="list quarto-listing-default">

</div>
<div class="listing-no-matching d-none">
No matching items
</div>
</div><div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Valuing Actions by Estimating Probabilities (VAEP) based on the atomic SPADL format.↩︎</p></li>
<li id="fn2"><p><a href="https://twitter.com/TonyElHabr/status/1393553732659519490">I had a Twitter thread in May 2021 describing how one could use VAEP ratings.</a>↩︎</p></li>
<li id="fn3"><p>It’s closer to <a href="https://www.optasports.com/services/analytics/advanced-metrics/">xG+xA</a>, although the authors might disagree with that as well. It’s really best treated separately, which perhaps explains why the authors often using “rating” and “contribution” when referring to VAEP.↩︎</p></li>
<li id="fn4"><p>Each row represents one player. Each row only has one +1 and one -1, and 0s for other features.↩︎</p></li>
<li id="fn5"><p>We’re including all positions and ages in this regression, even though these groupings have varying standard deviations for transformation of the response variable. (All have 0 mean, as one might expect with a feature representing the difference between values with the same distribution.)↩︎</p></li>
<li id="fn6"><p>This <code>NA</code> occurs even when setting the intercept to 0, which is typically the way to get around this kind of issue with <code>lm</code> in R. When changing the order of columns in the regression and forcing the Netherlands coefficient to be non-<code>NA</code>, its estimate is lower than that of Bundesliga 2 (and a different league’s estimate is <code>NA</code>).↩︎</p></li>
<li id="fn7"><p>“Weighted-average”: <code>Diff. (VAEP/90) = (Diff. * sum(SD * (N * sum(N)))) - sum(Mean * (N * sum(N)))</code>↩︎</p></li>
<li id="fn8"><p>This is also a weakness of my approach, but arguably ratios exacerbate this.↩︎</p></li>
<li id="fn9"><p>Here I was treating the Champions League and Europa as their own “leagues”, purely out of curiosity.↩︎</p></li>
<li id="fn10"><p>Arguably you’ll have this kind of issue no matter what, due to injuries.↩︎</p></li>
<li id="fn11"><p>“Un-transformation” becomes more difficult since we have to account for the ridge penalty.↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>r</category>
  <category>soccer</category>
  <guid>https://tonyelhabr.rbind.io/posts/soccer-league-strength/index.html</guid>
  <pubDate>Sat, 26 Jun 2021 05:00:00 GMT</pubDate>
  <media:content url="https://tonyelhabr.rbind.io/posts/soccer-league-strength/featured.png" medium="image" type="image/png" height="72" width="144"/>
</item>
<item>
  <title>Fantasy Football and the Classical Scheduling Problem</title>
  <dc:creator>Tony ElHabr</dc:creator>
  <link>https://tonyelhabr.rbind.io/posts/fantasy-football-schedule-problem/index.html</link>
  <description><![CDATA[ 



<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>Every year I play in several fantasy football (American) leagues. For those who are unaware, it’s a game that occurs every year in sync with the <a href="https://en.wikipedia.org/wiki/National_Football_League">National Football League (NFL)</a> where participants play in weekly head-to-head games as general managers of virtual football teams. (Yes, it’s very silly.) The winner at the end of the season is often not the player with the team that scores the most points; often a fortunate sequence of matchups dictates who comes out on top.</p>
<p>I didn’t fare so well this year in one of my leagues, but my disappointing placement was not due to my team struggling to score points; rather, I was extremely unlucky. I finished the season in 7th place despite scoring the most points!</p>
<p>This inspired me to quantify just how unlikely I was. The most common way to calculate the likelihood of a given team’s ranking in a league with is with a <a href="https://mathworld.wolfram.com/MonteCarloMethod.html">Monte Carlo simulation</a> based on some parameterized model of scoring to generate probabilities for the final standings. <a href="https://fivethirtyeight.com/methodology/how-our-club-soccer-predictions-work/">FiveThirtyEight uses such a model for their soccer models</a>, for example. For a setting in which team scores are independent of one another, such as fantasy football, another approach is to simply <a href="https://github.com/JakePartusch/fantasy-tools">calculate what each team’s record would be if they had played every other team each week</a>. (So, if your league has 10 teams and each plays each other once, each team would have a hypothetical count of 90 games played.) However, I was particularly interested in answering the question: “In how many different schedules would I have finished where I did?”</p>
</section>
<section id="problem" class="level2">
<h2 class="anchored" data-anchor-id="problem">Problem</h2>
<p>Figuring out how unlucky I was to finish 7th requires me to first figure out how many possible schedules there are. Formally, the problem can be put as follows<sup>1</sup>:</p>
<blockquote class="blockquote">
<p>Let <img src="https://latex.codecogs.com/png.latex?T=%7Bt_1,%20...,%20t_n%7D"> be a set of an even <img src="https://latex.codecogs.com/png.latex?n"> teams. Let <img src="https://latex.codecogs.com/png.latex?R"> denote a round consisting of a set of pairs <img src="https://latex.codecogs.com/png.latex?(t_i,%20t_j)"> (denoting a match), such that <img src="https://latex.codecogs.com/png.latex?0%20%3C%20i%20%3C%20j%20%3C=%20n">, and such that each team in <img src="https://latex.codecogs.com/png.latex?T"> is participates exactly once in <img src="https://latex.codecogs.com/png.latex?R">. Let <img src="https://latex.codecogs.com/png.latex?S"> be a schedule consisting of a tuple of <img src="https://latex.codecogs.com/png.latex?n%20-%201"> valid rounds <img src="https://latex.codecogs.com/png.latex?(R_1,%20...,%20R_%7Bn-1%7D)">, such that all rounds in <img src="https://latex.codecogs.com/png.latex?S"> are pair-wise disjoint (no round shares a match). How many valid constructions of <img src="https://latex.codecogs.com/png.latex?S"> are there for <img src="https://latex.codecogs.com/png.latex?n"> input teams?</p>
</blockquote>
<p>For a small number of teams, it’s fairly simple to write out all possible combinations of matchups. For example, for a two-team league (where each team plays each other once), there is only one possible schedule (solution)—Team 1 vs.&nbsp;Team 2. For a four-team league, there are six possible schedules. Two are shown below.</p>
<table class="table">
<thead>
<tr class="header">
<th>solution</th>
<th>round</th>
<th>team1</th>
<th>team2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>1</td>
<td>1</td>
<td>2</td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td>3</td>
<td>4</td>
</tr>
<tr class="odd">
<td></td>
<td>2</td>
<td>1</td>
<td>3</td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td>2</td>
<td>4</td>
</tr>
<tr class="odd">
<td></td>
<td>3</td>
<td>1</td>
<td>4</td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td>2</td>
<td>3</td>
</tr>
<tr class="odd">
<td>2</td>
<td>1</td>
<td>1</td>
<td>3</td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td>2</td>
<td>4</td>
</tr>
<tr class="odd">
<td></td>
<td>2</td>
<td>1</td>
<td>2</td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td>3</td>
<td>4</td>
</tr>
<tr class="odd">
<td></td>
<td>3</td>
<td>1</td>
<td>4</td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td>2</td>
<td>3</td>
</tr>
</tbody>
</table>
<p>Note that there is no concept of “home advantage” in fantasy football, so the order of teams in a given matchup does not matter. Also, note that if our restriction (“constraint”) that each team must play each other once and only once, implies that the number of teams has to be an even number.</p>
</section>
<section id="constraint-programming" class="level2">
<h2 class="anchored" data-anchor-id="constraint-programming">Constraint Programming</h2>
<p>To truly answer this question, we can turn to <a href="https://en.wikipedia.org/wiki/Constraint_programming">constraint programming</a>. If you’re familiar with constraint programming, then you’ll notice that this set-up is similar to the canonical <a href="https://en.wikipedia.org/wiki/Nurse_scheduling_problem">nurse scheduling problem</a> and is a specific form of the <a href="https://en.wikipedia.org/wiki/Traveling_tournament_problem">tournament problem</a>.</p>
<p>Below is some python code that is able to identify the number feasible solutions for four teams. I print out the first solution for illustrative purposes.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> ortools.sat.python <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> cp_model</span>
<span id="cb1-2"></span>
<span id="cb1-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> SolutionPrinter(cp_model.CpSolverSolutionCallback):</span>
<span id="cb1-4">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, games, n_team, n_show<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>):</span>
<span id="cb1-5">        cp_model.CpSolverSolutionCallback.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>)</span>
<span id="cb1-6">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._games <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> games</span>
<span id="cb1-7">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._n_show <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> n_show</span>
<span id="cb1-8">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._n_team <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> n_team</span>
<span id="cb1-9">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._n_sol <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb1-10"></span>
<span id="cb1-11">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> on_solution_callback(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb1-12">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._n_sol <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb1-13">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>()</span>
<span id="cb1-14">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._n_show <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">or</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._n_sol <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._n_show:</span>
<span id="cb1-15">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'Solution </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>_n_sol<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">.'</span>)</span>
<span id="cb1-16">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> team1 <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._n_team):</span>
<span id="cb1-17">                <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> team2 <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._n_team):</span>
<span id="cb1-18">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> team1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> team2:</span>
<span id="cb1-19">                        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(</span>
<span id="cb1-20">                            <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'Team </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>team1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> vs. Team </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>team2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> in Round </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>Value(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._games[(team1, team2)])<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span></span>
<span id="cb1-21">                        )</span>
<span id="cb1-22">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span>:</span>
<span id="cb1-23">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'Found solution </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>_n_sol<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">.'</span>)</span>
<span id="cb1-24"></span>
<span id="cb1-25">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> get_n_sol(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb1-26">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._n_sol</span>
<span id="cb1-27"></span>
<span id="cb1-28">n_team <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span></span>
<span id="cb1-29">n_w <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> n_team <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb1-30">model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cp_model.CpModel()</span>
<span id="cb1-31">games <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {}</span>
<span id="cb1-32"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> team1 <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(n_team):</span>
<span id="cb1-33">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> team2 <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(n_team):</span>
<span id="cb1-34">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> team1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> team2:</span>
<span id="cb1-35">            games[(team1, team2)] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.NewIntVar(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, n_w, <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>team1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:02}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>team2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:02}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb1-36"></span>
<span id="cb1-37"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> team1 <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(n_team):</span>
<span id="cb1-38">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> team2 <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(n_team):</span>
<span id="cb1-39">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> team1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> team2:</span>
<span id="cb1-40">            model.Add(games[(team1, team2)] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> games[(team2, team1)])</span>
<span id="cb1-41"></span>
<span id="cb1-42"></span>
<span id="cb1-43"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Each team can only play in 1 game each week</span></span>
<span id="cb1-44"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> t <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(n_team):</span>
<span id="cb1-45">    model.AddAllDifferent(</span>
<span id="cb1-46">        [games[(t, team2)] <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> team2 <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(n_team) <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> team2]</span>
<span id="cb1-47">    )</span>
<span id="cb1-48"></span>
<span id="cb1-49">solver <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cp_model.CpSolver()</span>
<span id="cb1-50">solution_printer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> SolutionPrinter(games, n_team<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>n_team, n_show<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb1-51">status <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> solver.SearchForAllSolutions(model, solution_printer)</span>
<span id="cb1-52"></span>
<span id="cb1-53"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>()</span>
<span id="cb1-54"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'Solve status: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>solver<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>StatusName(status)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb1-55"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'Solutions found: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>solution_printer<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get_n_sol()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb1-56"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; Solution 1.</span></span>
<span id="cb1-57"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; Team 1 vs. Team 2 in Round 3</span></span>
<span id="cb1-58"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; Team 1 vs. Team 3 in Round 2</span></span>
<span id="cb1-59"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; Team 1 vs. Team 4 in Round 1</span></span>
<span id="cb1-60"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; Team 2 vs. Team 1 in Round 3</span></span>
<span id="cb1-61"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; Team 2 vs. Team 3 in Round 1</span></span>
<span id="cb1-62"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; Team 2 vs. Team 4 in Round 2</span></span>
<span id="cb1-63"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; Team 3 vs. Team 1 in Round 2</span></span>
<span id="cb1-64"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; Team 3 vs. Team 2 in Round 1</span></span>
<span id="cb1-65"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; Team 3 vs. Team 4 in Round 3</span></span>
<span id="cb1-66"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; Team 4 vs. Team 1 in Round 1</span></span>
<span id="cb1-67"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; Team 4 vs. Team 2 in Round 2</span></span>
<span id="cb1-68"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; Team 4 vs. Team 3 in Round 3</span></span>
<span id="cb1-69"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; </span></span>
<span id="cb1-70"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; Found solution 2.</span></span>
<span id="cb1-71"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; </span></span>
<span id="cb1-72"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; Found solution 3.</span></span>
<span id="cb1-73"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; </span></span>
<span id="cb1-74"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; Found solution 4.</span></span>
<span id="cb1-75"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; </span></span>
<span id="cb1-76"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; Found solution 5.</span></span>
<span id="cb1-77"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; </span></span>
<span id="cb1-78"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; Found solution 6.</span></span>
<span id="cb1-79"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; </span></span>
<span id="cb1-80"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; Solve status: OPTIMAL</span></span>
<span id="cb1-81"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; Solutions found: 6</span></span></code></pre></div>
</details>
</div>
<p>Easy enough to run for 10 teams and get an answer, right? <strong>WRONG</strong>. Turns out this the number of feasible solutions (schedules) starts to blow up really quickly. In fact, I believe the number of solutions for this particular problem is only known up to 14 teams. (I’ve intentionally left the numbers un-rounded to emphasize just how much the number of solutions increases as a function of the number of teams.)</p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: right;">n</th>
<th style="text-align: left;">solutions</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">2</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">4</td>
<td style="text-align: left;">6</td>
</tr>
<tr class="odd">
<td style="text-align: right;">6</td>
<td style="text-align: left;">720</td>
</tr>
<tr class="even">
<td style="text-align: right;">8</td>
<td style="text-align: left;">31,449,600</td>
</tr>
<tr class="odd">
<td style="text-align: right;">10</td>
<td style="text-align: left;">444,733,651,353,600</td>
</tr>
<tr class="even">
<td style="text-align: right;">12</td>
<td style="text-align: left;">10,070,314,878,246,925,803,220,024</td>
</tr>
<tr class="odd">
<td style="text-align: right;">14</td>
<td style="text-align: left;">614,972,203,951,464,579,840,082,248,206,026,604,282</td>
</tr>
</tbody>
</table>
<p>Unless you happen to be an expert in <a href="https://en.wikipedia.org/wiki/Graph_(discrete_mathematics)">graph theory</a> and <a href="https://mathworld.wolfram.com/Combinatorics.html">combinatorics</a>, you probably wouldn’t be able to figure this out by hand; for us non-experts out there, we can refer to a known sequence of <a href="http://oeis.org/A000438">1-factorizations of a complete graph <img src="https://latex.codecogs.com/png.latex?K_%7B2n%7D"></a> and use our brain to figure out permutations in a given round. (Don’t worry if that makes no sense.)</p>
<p>Why do I bring this up? Well, I realized that generating all possible schedules for a 10-team league (such as my aforementioned league) is just not reasonable for anyone without a supercomputer and a lot of time. I enhanced the above python code a bit and tried it out for a 10-team league and was only able to generate a couple of million solutions after 3 hours.</p>
</section>
<section id="alternative-exhaustive-search" class="level2">
<h2 class="anchored" data-anchor-id="alternative-exhaustive-search">Alternative: Exhaustive Search</h2>
<p>The failure to generate all solutions made me reconsider things a bit. If I can’t reasonably “have it all”, I should simplify things a bit. By “simplify”, I mean perform an <a href="https://en.wikipedia.org/wiki/Brute-force_search">“exhaustive” (or “brute-force) search</a> that stops after a specified number of solutions. And, by re-writing things in R, I can eliminate dependencies on <a href="https://developers.google.com/optimization">Google’s ortools package</a> and python. (Both are great, but, nonetheless, they are potential obstacles for R users.)</p>
<p>Writing a script to perform an exhaustive search is not so easy itself, and, in this case, requires a completely different approach to the problem. My steps are as follows:</p>
<ol type="1">
<li>Set up an <img src="https://latex.codecogs.com/png.latex?n"> x <img src="https://latex.codecogs.com/png.latex?n-1"> matrix, where the <img src="https://latex.codecogs.com/png.latex?n"> rows designate teams and the <img src="https://latex.codecogs.com/png.latex?n-1"> columns designate rounds.</li>
</ol>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">league_size <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span></span>
<span id="cb2-2">rounds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> league_size <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb2-3">mat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> league_size, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> rounds)</span>
<span id="cb2-4">mat</span>
<span id="cb2-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;      [,1] [,2] [,3]</span></span>
<span id="cb2-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [1,]   NA   NA   NA</span></span>
<span id="cb2-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [2,]   NA   NA   NA</span></span>
<span id="cb2-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [3,]   NA   NA   NA</span></span>
<span id="cb2-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [4,]   NA   NA   NA</span></span></code></pre></div>
</details>
</div>
<ol start="2" type="1">
<li>Randomly select the opponent of team 1 in round 1.</li>
</ol>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">team_i <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb3-2">round_i <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb3-3">retry_i <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb3-4">idx_team <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>league_size</span>
<span id="cb3-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb3-6"></span>
<span id="cb3-7">team_1_round_1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>league_size, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span>
<span id="cb3-8">mat[team_i, round_i] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> team_1_round_1</span>
<span id="cb3-9">mat</span>
<span id="cb3-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;      [,1] [,2] [,3]</span></span>
<span id="cb3-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [1,]    2   NA   NA</span></span>
<span id="cb3-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [2,]   NA   NA   NA</span></span>
<span id="cb3-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [3,]   NA   NA   NA</span></span>
<span id="cb3-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [4,]   NA   NA   NA</span></span></code></pre></div>
</details>
</div>
<ol start="3" type="1">
<li>Find a unique set of opponents for teams 2 through <img src="https://latex.codecogs.com/png.latex?n"> to fill the rest of the cells in column 1.</li>
</ol>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">while</span>(team_i <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> league_size) {</span>
<span id="cb4-2">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(team_i <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> teams_already_matched) {</span>
<span id="cb4-3">    team_i_round_i <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">which</span>(team_i <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> teams_already_matched)</span>
<span id="cb4-4">    mat[team_i, round_i] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> team_i_round_i</span>
<span id="cb4-5">    team_i <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> team_i <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb4-6">  } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> {</span>
<span id="cb4-7">    teams_cant_match <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(teams_already_indexed, teams_already_matched))</span>
<span id="cb4-8">    teams_unmatched <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setdiff</span>(teams_possible, teams_cant_match)</span>
<span id="cb4-9">    n_matched <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(teams_unmatched)</span>
<span id="cb4-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(n_matched <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) {</span>
<span id="cb4-11">      mat[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>league_size, round_i] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span></span>
<span id="cb4-12">      team_i <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb4-13">    } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> {</span>
<span id="cb4-14">      team_i_round_i <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(n_matched <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) {</span>
<span id="cb4-15">        teams_unmatched</span>
<span id="cb4-16">      } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> {</span>
<span id="cb4-17">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(teams_unmatched, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb4-18">      }</span>
<span id="cb4-19"></span>
<span id="cb4-20">      mat[team_i, round_i] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> team_i_round_i</span>
<span id="cb4-21">      team_i <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> team_i <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb4-22">    }</span>
<span id="cb4-23">  }</span>
<span id="cb4-24">}</span>
<span id="cb4-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;      [,1] [,2] [,3]</span></span>
<span id="cb4-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [1,]    2   NA   NA</span></span>
<span id="cb4-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [2,]    1   NA   NA</span></span>
<span id="cb4-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [3,]    4   NA   NA</span></span>
<span id="cb4-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [4,]    3   NA   NA</span></span></code></pre></div>
</details>
</div>
<ol start="4" type="1">
<li>Identify a unique set of opponents for team 1 for all other rounds (rounds 2 through <img src="https://latex.codecogs.com/png.latex?n-1">).</li>
</ol>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">teams_possible <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setdiff</span>(idx_team, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, team_1_round_1))</span>
<span id="cb5-2">team1_all_rounds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(teams_possible, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(teams_possible))</span>
<span id="cb5-3">mat[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>rounds] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> team1_all_rounds</span>
<span id="cb5-4">mat</span>
<span id="cb5-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;      [,1] [,2] [,3]</span></span>
<span id="cb5-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [1,]    2    3    4</span></span>
<span id="cb5-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [2,]    1   NA   NA</span></span>
<span id="cb5-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [3,]    4   NA   NA</span></span>
<span id="cb5-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [4,]    3   NA   NA</span></span></code></pre></div>
</details>
</div>
<ol start="5" type="1">
<li>Repeat step 3 for rounds 2 through <img src="https://latex.codecogs.com/png.latex?n-2"> (penultimate round).</li>
</ol>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">while</span>(round_i <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> rounds) {</span>
<span id="cb6-2">  team_i <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb6-3">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">while</span>(team_i <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> league_size) {</span>
<span id="cb6-4">    teams_possible <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setdiff</span>(idx_team, team_i)</span>
<span id="cb6-5">    teams_already_indexed <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>(team_i <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb6-6">    teams_already_matched <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> mat[teams_already_indexed, round_i]</span>
<span id="cb6-7">    teams_already_played <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> mat[team_i, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>(round_i <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)]</span>
<span id="cb6-8">    reset <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span></span>
<span id="cb6-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(team_i <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> teams_already_matched) {</span>
<span id="cb6-10">      team_i_round_i <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">which</span>(team_i <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> teams_already_matched)</span>
<span id="cb6-11">      <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">any</span>(team_i_round_i <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> teams_already_played)) {</span>
<span id="cb6-12">        reset <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span></span>
<span id="cb6-13">      }</span>
<span id="cb6-14">    } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> {</span>
<span id="cb6-15">      teams_cant_match <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span></span>
<span id="cb6-16">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(teams_already_indexed, teams_already_matched, teams_already_played))</span>
<span id="cb6-17">      teams_unmatched <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setdiff</span>(teams_possible, teams_cant_match)</span>
<span id="cb6-18">      n_matched <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(teams_unmatched)</span>
<span id="cb6-19">      <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (n_matched <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) {</span>
<span id="cb6-20">        reset <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span></span>
<span id="cb6-21">      } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> {</span>
<span id="cb6-22">        team_i_round_i <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(n_matched <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) {</span>
<span id="cb6-23">          teams_unmatched</span>
<span id="cb6-24">        } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> {</span>
<span id="cb6-25">          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(teams_unmatched, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb6-26">        }</span>
<span id="cb6-27">      }</span>
<span id="cb6-28">    }</span>
<span id="cb6-29">    </span>
<span id="cb6-30">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(reset) {</span>
<span id="cb6-31">      mat[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>league_size, round_i] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span></span>
<span id="cb6-32">      team_i <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb6-33">      retry_i <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> retry_i <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb6-34">    } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> {</span>
<span id="cb6-35">      mat[team_i, round_i] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> team_i_round_i</span>
<span id="cb6-36">      team_i <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> team_i <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb6-37">    }</span>
<span id="cb6-38">  }</span>
<span id="cb6-39">  round_i <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> round_i <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb6-40">}</span>
<span id="cb6-41">mat</span>
<span id="cb6-42"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;      [,1] [,2] [,3]</span></span>
<span id="cb6-43"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [1,]    2    3    4</span></span>
<span id="cb6-44"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [2,]    1    4   NA</span></span>
<span id="cb6-45"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [3,]    4    1   NA</span></span>
<span id="cb6-46"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [4,]    3    2   NA</span></span></code></pre></div>
</details>
</div>
<ol start="6" type="1">
<li>Identify the only valid set of matchups for the last round <img src="https://latex.codecogs.com/png.latex?n-1">.</li>
</ol>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">idx_not1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>league_size</span>
<span id="cb7-2">total <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Reduce</span>(sum, idx_team) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> idx_not1</span>
<span id="cb7-3">rs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rowSums</span>(mat[idx_not1, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>(rounds <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)])</span>
<span id="cb7-4">teams_last <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> total <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> rs</span>
<span id="cb7-5">mat[idx_not1, rounds] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> teams_last</span>
<span id="cb7-6">mat</span>
<span id="cb7-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;      [,1] [,2] [,3]</span></span>
<span id="cb7-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [1,]    2    3    4</span></span>
<span id="cb7-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [2,]    1    4    3</span></span>
<span id="cb7-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [3,]    4    1    2</span></span>
<span id="cb7-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [4,]    3    2    1</span></span></code></pre></div>
</details>
</div>
<p>That is the core of the solution. The rest of the work<sup>2</sup> involves repeating the steps for however many times you want, always checking for duplicates of previous solutions, i.e.&nbsp;<a href="https://en.wikipedia.org/wiki/Simple_random_sample#Distinction_between_a_systematic_random_sample_and_a_simple_random_sample">sampling without replacement</a>. (Or, if you don’t care about schedules being unique, i.e.&nbsp;sampling with replacement, it’s even easier.)</p>
</section>
<section id="application" class="level2">
<h2 class="anchored" data-anchor-id="application">Application</h2>
<p>Since generating unique schedules is something I’d like to be able to do every year for my fantasy football leagues, I <a href="https://github.com/tonyelhabr/ffsched">wrote a package for it, called <code>{ffsched}</code></a>. The package includes functionality to retrieve your league’s fantasy scores from <a href="https://www.espn.com/fantasy/">ESPN</a>, which you can combine with the simulated schedules to generate a plot such as the following.</p>
<p><img src="https://tonyelhabr.rbind.io/posts/fantasy-football-schedule-problem/viz_standings_tile_2020.png" class="img-fluid"></p>
<p>It’s immediately evident how un-lucky I (“Tony El Tigre”) was. In the 100,000 simulations, I never finished below 7th, and I only finished 7th 1.1% of the time!</p>
<p>In the previous year I scored the most points and finished first. “The Juggernaut” got the short end of the stick in 2019, finishing 7th. He only finished 7th or lower in 6.6% of schedules.</p>
<p><img src="https://tonyelhabr.rbind.io/posts/fantasy-football-schedule-problem/viz_standings_tile_2019.png" class="img-fluid"></p>
</section>
<section id="take-away" class="level2">
<h2 class="anchored" data-anchor-id="take-away">Take-away</h2>
<p>An exhaustive search as a work-around for true constraint programming isn’t always elegant and can be difficult to implement, but if you’re motivated enough to do it—as I was to prove my extreme lack of fortune—it can generate what you need to make a compelling point. My use case (for generating unique fantasy generating football schedules) is inconsequential, but such techniques are often immensely important in real world contexts.</p>



</section>


<div class="quarto-listing quarto-listing-container-default" id="listing-listing">
<div class="list quarto-listing-default">

</div>
<div class="listing-no-matching d-none">
No matching items
</div>
</div><div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>This is almost directly taken from this <a href="https://math.stackexchange.com/questions/284416/how-many-possible-arrangements-for-a-round-robin-tournament">Stack Exchange question</a>.↩︎</p></li>
<li id="fn2"><p>In fantasy football, teams often play each other more than once in a year (depending on your league size), so I’ve somewhat simplified the problem for the purpose of this post. More work could be done to figure out the number of possibilities when more than one game has to be scheduled for each pair of teams.↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>r</category>
  <category>python</category>
  <category>football (american)</category>
  <guid>https://tonyelhabr.rbind.io/posts/fantasy-football-schedule-problem/index.html</guid>
  <pubDate>Mon, 11 Jan 2021 06:00:00 GMT</pubDate>
  <media:content url="https://tonyelhabr.rbind.io/posts/fantasy-football-schedule-problem/viz_standings_tile_2020.png" medium="image" type="image/png" height="96" width="144"/>
</item>
<item>
  <title>Decomposing and Smoothing Soccer Spatial Tendencies</title>
  <dc:creator>Tony ElHabr</dc:creator>
  <link>https://tonyelhabr.rbind.io/posts/decomposition-smoothing-soccer/index.html</link>
  <description><![CDATA[ 



<p>While reading up on modern soccer analytics, I stumbled upon <a href="https://github.com/devinpleuler/analytics-handbook">an excellent set of tutorials</a> written by <a href="https://twitter.com/devinpleuler">Devin Pleuler</a>. In particular, his notebook on <a href="https://en.wikipedia.org/wiki/Non-negative_matrix_factorization">non-negative matrix factorization (NNMF)</a> caught my eye. I hadn’t really heard of the concept before, but it turned out to be much less daunting once I realized that it is just another type of matrix decomposition. <a href="https://en.wikipedia.org/wiki/Singular_value_decomposition">Singular value decomposition (SVD)</a>, which I’m much more familiar with, belongs to the same family of calculations (although NNMF and SVD are quite different). In an effort to really gain a better understanding of NNMF, I set out to emulate his notebook.</p>
<p>In the process of converting his python code to R, I encountered three challenges with resolutions worth documenting.</p>
<ol type="1">
<li><p>Before the NNMF calculation, I needed to perform <a href="https://www.w3resource.com/sql/joins/perform-a-non-equi-join.php">non-equi join</a> with a fairly size-able data set. Unfortunately, <a href="https://dplyr.tidyverse.org/"><code>{dplyr}</code></a><sup>1</sup> does not have built-in support for such a join. I tossed aside any kind of personal implicit bias against <a href="https://cran.r-project.org/web/packages/data.table/index.html"><code>{data.table}</code></a>—which is certainly the go-to option in the R ecosystem for non-equi joins—and used it for this process.</p></li>
<li><p>For the NNMF calculation, the only R implementation (that I could find) comes with the <a href="https://cran.r-project.org/web/packages/NMF/index.html">{NMF} package</a><sup>2</sup>, which requires the installation of the <a href="https://cran.r-project.org/web/packages/BiocManager/index.html">Bioconductor-exclusive {BiocManager} package</a>. I’m relatively unfamiliar with <a href="https://www.bioconductor.org/">Bioconductor</a>, so this was not very appealing (although I did end up downloading <code>{NMF}</code> and trying it out). Instead, I ended up using <a href="https://rstudio.github.io/reticulate/"><code>{reticulate}</code></a> to call the <a href="https://scikit-learn.org/stable/modules/generated/sklearn.decomposition.NMF.html"><code>skearn.decomposition.NMF()</code></a> function directly (as is done in the python code). This is a perfect example of using <code>{reticulate}</code> for a non-trivial reason (i.e.&nbsp;for an algorithm).</p></li>
<li><p>After the NNMF computation, I needed to perform <a href="https://en.wikipedia.org/wiki/Gaussian_blur">2-D Gaussian smoothing</a>, which is helpful for making the output of the NNMF output more interpretable. The <a href="https://cran.r-project.org/web/packages/spatstat/index.html"><code>{spatstat}</code> package</a> had just the function for the job (<code>spatstat::blur()</code>), and it all it took for me was to write some a tidy wrapper function to integrate it nicely into my workflow.</p></li>
</ol>
<p>I’ve always considered myself a “whatever gets the job done” kind of person, not insistent on ignoring solutions that use “base” R, <code>{data.table}</code>, python, etc. Nonetheless, replicating Devin’s notebook really underscored the importance of being comfortable outside of a <code>{tidyverse}</code>-centric workflow.</p>
<p>Anyways, this post outlines the code and my thought process in porting Devin’s code to R. I’ll skip some of the details, emphasizing the things that are most interesting.</p>
<section id="data" class="level2">
<h2 class="anchored" data-anchor-id="data">Data</h2>
<p>We’ll be working with the <a href="https://github.com/statsbomb/open-data">open-sourced StatsBomb data</a> for the <a href="https://en.wikipedia.org/wiki/2018_FIFA_World_Cup">2018 Men’s World Cup</a>, which I’ve called <code>events</code> below. <sup>3</sup></p>
<p>This is a relatively large data set with lots of columns (and rows). However, we only need three columns for what we’re going to do: (1) a unique identifier for each player, <code>player_id</code>, along with their (2) <code>x</code> and (3) <code>y</code> coordinates.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span>
<span id="cb1-2">comps <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> StatsBombR<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FreeCompetitions</span>()</span>
<span id="cb1-3"></span>
<span id="cb1-4">matches <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> comps <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb1-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(competition_id <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">43</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb1-6">  StatsBombR<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">FreeMatches</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb1-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(match_date)</span>
<span id="cb1-8"></span>
<span id="cb1-9">events <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> StatsBombR<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">StatsBombFreeEvents</span>(matches)</span>
<span id="cb1-10">events <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> StatsBombR<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">allclean</span>(events)</span>
<span id="cb1-11">events <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> events <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb1-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">player_id =</span> player.id, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> location.x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> location.y) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb1-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">drop_na</span>()</span></code></pre></div>
</details>
</div>
<p>A quick summary of the data shows that there are 603 unique players, and that the <code>x</code> and <code>y</code> coordinates range from 1 to 120 (yards) and 1 to 80 respectively.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">events <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb2-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(</span>
<span id="cb2-3">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>(),</span>
<span id="cb2-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n_player =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n_distinct</span>(player_id),</span>
<span id="cb2-5">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(x, y), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">min =</span> min, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">max =</span> max, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mean =</span> mean))</span>
<span id="cb2-6">  )</span>
<span id="cb2-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 1 x 8</span></span>
<span id="cb2-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;       n n_player x_min x_max x_mean y_min y_max y_mean</span></span>
<span id="cb2-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;   &lt;int&gt;    &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span id="cb2-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 1 224018      603     1   120  60.05     1    80  40.37</span></span></code></pre></div>
</details>
</div>
</section>
<section id="non-equi-joining-with-data.table" class="level2">
<h2 class="anchored" data-anchor-id="non-equi-joining-with-data.table">Non-Equi Joining with <code>{data.table}</code></h2>
<p>Our first challenge is to convert the following chunk of python.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb3-2"></span>
<span id="cb3-3">x_scale, y_scale <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span></span>
<span id="cb3-4"></span>
<span id="cb3-5">x_bins <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.linspace(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">120</span>, x_scale)</span>
<span id="cb3-6">y_bins <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.linspace(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">80</span>, y_scale)</span>
<span id="cb3-7"></span>
<span id="cb3-8">players <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {}</span>
<span id="cb3-9"></span>
<span id="cb3-10"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> e <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> events:</span>
<span id="cb3-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'player'</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> e.keys():</span>
<span id="cb3-12">        player_id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> e[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'player'</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'id'</span>]</span>
<span id="cb3-13">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> player_id <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">not</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> players.keys():</span>
<span id="cb3-14">            players[player_id] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.zeros((x_scale, y_scale))</span>
<span id="cb3-15">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">try</span>:</span>
<span id="cb3-16">            x_bin <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(np.digitize(e[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'location'</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], x_bins[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:], right<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>))</span>
<span id="cb3-17">            y_bin <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(np.digitize(e[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'location'</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], y_bins[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:], right<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>))</span>
<span id="cb3-18">            players[player_id][x_bin][y_bin] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb3-19">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">except</span>:</span>
<span id="cb3-20">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">pass</span></span></code></pre></div>
</details>
</div>
<p>This code creates a nested <code>dict</code>, where the keys are player id’s and the values are 20x30 matrices. Each element in the matrix is an integer that represents the count of times that the player was recorded being at a certain position on the pitch. (These counts range from 0 to 94 for this data set.)</p>
<p>Some technical details:</p>
<ol type="1">
<li>The python <code>events</code> is actually a pretty heavily nested list<sup>4</sup>, hence the non-rectangular operations such as <code>e['player']['id']</code>.</li>
<li>Observations with missing coordinates are ignored with the <code>try</code>-<code>except</code> block.</li>
<li><code>x</code> and <code>y</code> values (elements of the <code>'location'</code> sub-list) are mapped to “bins” using <code>numpy</code>’s <code>digitize()</code> function, which is analogous to <code>base::cut()</code>.</li>
</ol>
<p>How can we do this same data manipulation in an idiomatic R fashion? We could certainly create a named list element and use <code>base::cut()</code> to closely match the python approach. However, I prefer to stick with data frames and SQL-ish operations since I think these are much more “natural” for R users.<sup>5</sup></p>
<p>So, going forward with data frames and joins, it’s quickly apparent that we’ll have to do some non-equi joining. <code>{fuzzyjoin}</code> and <a href="https://cran.r-project.org/web/packages/sqldf/index.html"><code>{sqldf}</code></a> offer functionality for such an approach, but <code>{data.table}</code> is really the best option. The only minor inconvenience here is that we have to explicitly coerce our <code>events</code> data frame to a data.table.</p>
<p>We’ll also need a helper, grid-like data frame to assist with the binning. The 600-row <code>grid_xy_yards</code> data frame (30 <code>x</code> bins * 20 <code>y</code> bins) below is essentially a tidy definition of the cells of the grid upon which we are binning the <code>events</code> data. (One can use whatever flavor of <code>crossing()</code>, <code>expand.grid()</code>, <code>seq()</code>, etc. that you prefer to create a data frame like this.)</p>
<p>Visually, this grid looks like this.</p>
<p><img src="https://tonyelhabr.rbind.io/posts/decomposition-smoothing-soccer/viz_grid_nnmf.png" class="img-fluid"></p>
<p>And if you prefer numbers instead of a chart, see the first 10 rows below.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">grid_xy_yards</span>
<span id="cb4-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 600 x 5</span></span>
<span id="cb4-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;     idx     x      y next_y next_x</span></span>
<span id="cb4-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;   &lt;int&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span id="cb4-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 1     1     0  0      4.211  4.138</span></span>
<span id="cb4-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 2     2     0  4.211  8.421  4.138</span></span>
<span id="cb4-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 3     3     0  8.421 12.63   4.138</span></span>
<span id="cb4-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 4     4     0 12.63  16.84   4.138</span></span>
<span id="cb4-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 5     5     0 16.84  21.05   4.138</span></span>
<span id="cb4-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 6     6     0 21.05  25.26   4.138</span></span>
<span id="cb4-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 7     7     0 25.26  29.47   4.138</span></span>
<span id="cb4-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 8     8     0 29.47  33.68   4.138</span></span>
<span id="cb4-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 9     9     0 33.68  37.89   4.138</span></span>
<span id="cb4-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 10    10    0 37.89  42.11   4.138</span></span>
<span id="cb4-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # ... with 590 more rows</span></span></code></pre></div>
</details>
</div>
<p>Two things to note about this supplementary data frame:</p>
<ol type="1">
<li><p>Cells aren’t evenly spaced integers, i.e.&nbsp;<code>x</code> cells are defined at 0, 4.138, 8.276, …, 80 instead of something like 0, 4, 8, …, 80, and <code>y</code> cells are defined at 0, 4.211, 8.421, …, 120 instead of something like 0, 4, 8, …, 120). That’s simply due to using 30 and 20 instead of 31 and 21 to split up the <code>x</code> and <code>y</code> ranges respectively. I point this out because this SQL-ish approach would have been much easier if these numbers were just integers! We could have done an inner join on an integer grid instead of non-equi-joining upon a grid of floating point numbers. Unfortunately, joining on floating point numbers as keys leads to <a href="https://stackoverflow.com/questions/52207851/how-do-you-join-on-floating-point-columns-in-sql">inconsistent results, simply due to the nature of floating points</a>.<sup>6</sup></p></li>
<li><p>The index <code>idx</code> is important! This will come back into play when we do the NNMF procedure, at which point we’ll “flatten” out our <code>x</code>-<code>y</code> pairs into a 1-d format.</p></li>
</ol>
<p>Ok, on to the actual data joining.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">events_dt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> events <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">drop_na</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> data.table<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.table</span>()</span>
<span id="cb5-2">grid_xy_yards_dt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> grid_xy_yards <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> data.table<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.table</span>()</span>
<span id="cb5-3"></span>
<span id="cb5-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># We don't even have to load `{data.table}` for this to work!</span></span>
<span id="cb5-5">events_binned <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> events_dt[grid_xy_yards_dt, on<span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span>.(x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> x, x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> next_x, y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> y, y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> next_y)] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb5-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb5-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(player_id, idx, x, y)</span>
<span id="cb5-8">events_binned</span>
<span id="cb5-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 224,038 x 4</span></span>
<span id="cb5-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    player_id   idx     x     y</span></span>
<span id="cb5-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;        &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb5-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  1      5462     1     0     0</span></span>
<span id="cb5-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  2      5467     1     0     0</span></span>
<span id="cb5-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  3      5488     1     0     0</span></span>
<span id="cb5-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  4      3632     1     0     0</span></span>
<span id="cb5-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  5      5576     1     0     0</span></span>
<span id="cb5-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  6      5595     1     0     0</span></span>
<span id="cb5-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  7      5263     1     0     0</span></span>
<span id="cb5-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  8      4063     1     0     0</span></span>
<span id="cb5-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  9      5231     1     0     0</span></span>
<span id="cb5-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 10      5231     1     0     0</span></span>
<span id="cb5-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # ... with 224,028 more rows</span></span></code></pre></div>
</details>
</div>
<p>In retrospect, this join was pretty straightforward!</p>
<p>The rest of the code below is just doing the actual tallying.</p>
<ol type="1">
<li>First, we make an intermediate data set <code>grid_players</code>, which is the Cartesian product of all possible cells in the grid and all players in <code>events</code>.</li>
<li>Second, we “add back” missing cells to <code>events_binned</code> using the intermediate data set <code>grid_players</code>.</li>
</ol>
<p>In the end, we end up with a <code>players</code> data frame with 603 <code>player_id</code>s * 30 <code>x</code> bins * 20 <code>y</code> bins = 361,800 rows.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># This `dummy` column approach is an easy way to do a Cartesian join when the two data frames don't share any column names.</span></span>
<span id="cb6-2">grid_players <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> grid_xy_yards <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb6-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dummy =</span> 0L) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb6-4">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Cartesian join of all possible cells in the grid and all players in `events`.</span></span>
<span id="cb6-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">full_join</span>(</span>
<span id="cb6-6">    events <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb6-7">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">drop_na</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb6-8">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">distinct</span>(player_id) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb6-9">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dummy =</span> 0L),</span>
<span id="cb6-10">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'dummy'</span></span>
<span id="cb6-11">  )</span>
<span id="cb6-12"></span>
<span id="cb6-13">players <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> events_binned <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb6-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(player_id, x, y, idx) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb6-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb6-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb6-17">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Rejoin back on the grid to 'add back' cells with empty counts (i.e. `n = 0`).</span></span>
<span id="cb6-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">full_join</span>(grid_players, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'player_id'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'y'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'idx'</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb6-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>dummy, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>next_x, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>next_y) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb6-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">replace_na</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> 0L)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb6-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(player_id, x, y)</span>
<span id="cb6-22">players</span>
<span id="cb6-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 361,800 x 5</span></span>
<span id="cb6-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    player_id     x      y   idx     n</span></span>
<span id="cb6-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;        &lt;int&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;int&gt; &lt;int&gt;</span></span>
<span id="cb6-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  1      2941     0  0         1     0</span></span>
<span id="cb6-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  2      2941     0  4.211     2     0</span></span>
<span id="cb6-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  3      2941     0  8.421     3     0</span></span>
<span id="cb6-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  4      2941     0 12.63      4     0</span></span>
<span id="cb6-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  5      2941     0 16.84      5     0</span></span>
<span id="cb6-31"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  6      2941     0 21.05      6     0</span></span>
<span id="cb6-32"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  7      2941     0 25.26      7     0</span></span>
<span id="cb6-33"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  8      2941     0 29.47      8     0</span></span>
<span id="cb6-34"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  9      2941     0 33.68      9     0</span></span>
<span id="cb6-35"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 10      2941     0 37.89     10     0</span></span>
<span id="cb6-36"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # ... with 361,790 more rows</span></span></code></pre></div>
</details>
</div>
<p>To make this a little bit more tangible, let’s plot Messi’s heatmap. (Is this really a blog post about soccer if it doesn’t mention Messi 😆?)</p>
<p><img src="https://tonyelhabr.rbind.io/posts/decomposition-smoothing-soccer/viz_43_messi_binned.png" class="img-fluid"></p>
</section>
<section id="non-negative-matrix-factorization-nnmf-with-reticulate-and-sklearn" class="level2">
<h2 class="anchored" data-anchor-id="non-negative-matrix-factorization-nnmf-with-reticulate-and-sklearn">Non-Negative Matrix Factorization (NNMF) with <code>{reticulate}</code> and <code>sklearn</code></h2>
<p>Next up is the actual NNMF calculation. I don’t care if you’re the biggest R <a href="https://www.urbandictionary.com/define.php?term=Stan">stan</a> in the world—you have to admit that the python code to perform the NNMF is quite simple and (dare I say) elegant. The <code>comps=30</code> here means</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sklearn.decomposition <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> NMF</span>
<span id="cb7-2"></span>
<span id="cb7-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Flatten individual player matrices into shape=(600,) which is the product of the original shape components (30 by 20)</span></span>
<span id="cb7-4">unraveled <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [np.matrix.flatten(v) <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> k, v <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> players.items()]</span>
<span id="cb7-5">comps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span></span>
<span id="cb7-6">model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> NMF(n_components<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>comps, init<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'random'</span>, random_state<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb7-7">W <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.fit_transform(unraveled)</span></code></pre></div>
</details>
</div>
<p>My understanding is that <code>comps=30</code> is telling the algorithm to reduce our original data (with 603 players) to a lower dimensional space with 30 player “archetypes” that best represent the commonalities among the 603 players.<sup>7</sup> Per Devin, the choice of 30 here is somewhat arbitrary. In practice, one might perform some cross validation to identify what number minimizes some loss function, but that’s beyond the scope of what we’re doing here.</p>
<p>After re-formatting our <code>players</code> data into a wide format—equivalent to the <code>numpy.matrix.flatten()</code> call in the python code—we could use the <code>{NMF}</code> package for an R replication.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert from tidy format to wide format (603 rows x 600 columns)</span></span>
<span id="cb8-2">players_mat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> players <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb8-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">drop_na</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb8-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(player_id, idx, n) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb8-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_wider</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_from =</span> idx, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_from =</span> n) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb8-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>player_id) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb8-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>()</span>
<span id="cb8-8"></span>
<span id="cb8-9">comps <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> 30L</span>
<span id="cb8-10">W <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> NMF<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nmf</span>(NMF<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rmatrix</span>(players_mat), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rank =</span> comps, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seed =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Frobenius'</span>)</span></code></pre></div>
</details>
</div>
<p>However, I found that the results weren’t all that comparable to the python results. (Perhaps I needed to define the arguments in a different manner.) So why not use <code>{reticulate}</code> and call the <code>sklearn.decomposition.NMF()</code> function to make sure that we exactly emulate the python decomposition?</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">sklearn <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> reticulate<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">import</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'sklearn'</span>)</span>
<span id="cb9-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Won't work if `n_components` aren't explicitly defined as integers!</span></span>
<span id="cb9-3">model <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sklearn<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>decomposition<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">NMF</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n_components =</span> comps, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">init =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'random'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">random_state =</span> 0L)</span>
<span id="cb9-4">W <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> model<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fit_transform</span>(players_mat)</span></code></pre></div>
</details>
</div>
<p>The result includes 30 20x30 matrices—one 30x20 <code>x</code>-<code>y</code> matrix for each of the 30 components (<code>comps</code>). We have some wrangling left to do to gain anything meaningful from this NNMF procedure, but we have something to work with!</p>
</section>
<section id="gaussian-smoothing-with-spatstat" class="level2">
<h2 class="anchored" data-anchor-id="gaussian-smoothing-with-spatstat">Gaussian Smoothing with <code>{spatstat}</code></h2>
<p>The last thing to do is to post-process the NNMF results and, of course, make pretty plots. The python plotting is pretty standard <code>matplotlib</code>, with the exception of the Gaussian smoothing performed on each component’s matrix <code>model.component_</code> in the loop to make sub-plots.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> scipy.ndimage <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> gaussian_filter</span>
<span id="cb10-2"></span>
<span id="cb10-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>):</span>
<span id="cb10-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ...</span></span>
<span id="cb10-5">    z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.rot90(gaussian_filter(model.components_[i].reshape(x_scale, y_scale), sigma<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb10-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ...</span></span></code></pre></div>
</details>
</div>
<p>The first 9 smoothed component matrices come out looking like this. <sup>8</sup></p>
<p><img src="https://tonyelhabr.rbind.io/posts/decomposition-smoothing-soccer/viz_nnmf_dimensions_1to9_py.png" class="img-fluid"></p>
<p>There’s a couple of steps involved to do the same thing in R.</p>
<ol type="1">
<li><p>First, we’ll convert the components matrices to a tidy format, <code>decomp_tidy</code></p></li>
<li><p>Second, we’ll join our tidied components matrices with our tidy grid of cells, <code>grid_xy_yards</code>, and convert our <code>x</code> and <code>y</code> bins to integers in preparation of the matrix operation performed in the subsequent step.</p></li>
<li><p>Lastly, we’ll perform the Gaussian smoothing on nested data frames with a custom function, <code>smoothen_dimension</code>, that wraps <code>spatstat::blur()</code>. This function also maps <code>idx</code> back to field positions (in meters instead of yards) using the supplementary <code>grid_xy_rev_m</code><sup>9</sup> data frame (which is a lot like <code>grid_xy_yards</code>)</p></li>
</ol>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 1</span></span>
<span id="cb11-2">decomp_tidy <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> model<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>components_ <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb11-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb11-4">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># "Un-tidy" tibble with 30 rows (one for each dimension) and 600 columns (one for every `idx`)</span></span>
<span id="cb11-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dimension =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">row_number</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb11-6">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert to a tidy tibble with dimensions * x * y rows (30 * 30 * 20 = 18,000)</span></span>
<span id="cb11-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>dimension, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'idx'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'value'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb11-8">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The columns from the matrix are named `V1`, `V2`, ... `V600` by default, so convert them to an integer that can be joined on.</span></span>
<span id="cb11-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(idx, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_remove</span>(.x, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'^V'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.integer</span>()))</span>
<span id="cb11-10"></span>
<span id="cb11-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 2</span></span>
<span id="cb11-12">decomp <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> decomp_tidy <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb11-13">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Join on our grid of x-y pairs.</span></span>
<span id="cb11-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inner_join</span>(</span>
<span id="cb11-15">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Using `dense_rank` because we need indexes here (i.e. 1, 2, ..., 30 instead of 0, 4.1, 8.2, ..., 120 for `x`).</span></span>
<span id="cb11-16">    grid_xy_yards <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb11-17">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(idx, x, y) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb11-18">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(x, y), dense_rank))</span>
<span id="cb11-19">  )</span>
<span id="cb11-20"></span>
<span id="cb11-21"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## 3</span></span>
<span id="cb11-22">smoothen_component <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(.data, ...) {</span>
<span id="cb11-23">  mat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> .data <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb11-24">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(x, y, value) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb11-25">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_wider</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_from =</span> x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_from =</span> value) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb11-26">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>y) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb11-27">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>()</span>
<span id="cb11-28">  </span>
<span id="cb11-29">  mat_smoothed <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> mat <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb11-30">    spatstat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.im</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb11-31">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Pass `sigma` in here.</span></span>
<span id="cb11-32">    spatstat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">blur</span>(...) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb11-33">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Could use `spatstat::as.data.frame.im()`, but it converts directly to x,y,value triplet of columns, which is not the format I want.</span></span>
<span id="cb11-34">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pluck</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'v'</span>)</span>
<span id="cb11-35">  </span>
<span id="cb11-36">  res <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> mat_smoothed <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb11-37">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert 20x30 y-x matrix to tidy format with 20*30 rows.</span></span>
<span id="cb11-38">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb11-39">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">row_number</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb11-40">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>y, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'value'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb11-41">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The columns from the matrix are named `V1`, `V2`, ... `V30` by default, so convert them to an integer that can be joined on.</span></span>
<span id="cb11-42">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(x, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_remove</span>(.x, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'^V'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.integer</span>())) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb11-43">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(x, y) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb11-44">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># "Re-index" rows with `idx`, ranging from 1 to 600.</span></span>
<span id="cb11-45">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">idx =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">row_number</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb11-46">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>x, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>y) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb11-47">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert `x` and `y` indexes (i.e. 1, 2, 3, ..., to meters and flip the y-axis).</span></span>
<span id="cb11-48">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inner_join</span>(grid_xy_rev_m) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb11-49">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Re-scale smoothed values to 0-1 range.</span></span>
<span id="cb11-50">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">frac =</span> (value <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(value)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(value) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(value))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb11-51">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>()</span>
<span id="cb11-52">  res</span>
<span id="cb11-53">}</span>
<span id="cb11-54"></span>
<span id="cb11-55">decomp_smooth <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> decomp <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb11-56">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nest</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(dimension)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb11-57">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># `sigma` passed into `...` of `smoothen_component()`. (`data` passed as first argument.)</span></span>
<span id="cb11-58">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map</span>(data, smoothen_component, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sigma =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb11-59">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest</span>(data)</span>
<span id="cb11-60">decomp_smooth</span>
<span id="cb11-61"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 18,000 x 8</span></span>
<span id="cb11-62"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    dimension    value   idx     x     y next_y next_x     frac</span></span>
<span id="cb11-63"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;        &lt;int&gt;    &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;</span></span>
<span id="cb11-64"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  1         1 0.002191     1     0 68     4.211  4.138 0.004569</span></span>
<span id="cb11-65"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  2         1 0.004843     2     0 64.42  8.421  4.138 0.01064 </span></span>
<span id="cb11-66"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  3         1 0.008334     3     0 60.84 12.63   4.138 0.01863 </span></span>
<span id="cb11-67"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  4         1 0.01130      4     0 57.26 16.84   4.138 0.02541 </span></span>
<span id="cb11-68"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  5         1 0.01258      5     0 53.68 21.05   4.138 0.02834 </span></span>
<span id="cb11-69"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  6         1 0.01208      6     0 50.11 25.26   4.138 0.02719 </span></span>
<span id="cb11-70"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  7         1 0.01033      7     0 46.53 29.47   4.138 0.02319 </span></span>
<span id="cb11-71"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  8         1 0.008165     8     0 42.95 33.68   4.138 0.01824 </span></span>
<span id="cb11-72"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  9         1 0.006156     9     0 39.37 37.89   4.138 0.01364 </span></span>
<span id="cb11-73"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 10         1 0.004425    10     0 35.79 42.11   4.138 0.009680</span></span>
<span id="cb11-74"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # ... with 17,990 more rows</span></span></code></pre></div>
</details>
</div>
<p>With the data in the proper format, the plotting is pretty straightforward <code>{ggplot2}</code> code.</p>
<p><img src="https://tonyelhabr.rbind.io/posts/decomposition-smoothing-soccer/viz_nnmf_dimensions_1to9_r_smooth.png" class="img-fluid"></p>
<p>Viola! I would say that our R version of the python plot is very comparable (just by visual inspection). Note that we could achieve a similar visual profile without the smoothing—see below—but the smoothing undoubtedly makes pattern detection a little less ambiguous.</p>
<p><img src="https://tonyelhabr.rbind.io/posts/decomposition-smoothing-soccer/viz_nnmf_dimensions_1to9_r_unsmooth.png" class="img-fluid"></p>
<p>From the smoothed contours, we can discern several different player profiles (in terms of positioning).</p>
<ul>
<li>Components 1, 5, 9: left back</li>
<li>Components 2: right midfielder</li>
<li>Component 3: attacking right midfielder</li>
<li>Component 4: wide left midfielder</li>
<li>Component 6: central left midfielder</li>
<li>Components 7, 8: goalkeeper</li>
</ul>
<p>The redundancy with left back and goalkeeper is not ideal. That’s certainly something we could fine tune with more experimentation with components. Anyways, the point of this post wasn’t so much about the insights that could be gained (although that’s ultimately what stakeholders would be interested in if this were a “real” analysis).</p>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>Translating python code can be challenging, throwing us off from our typical workflow (for me, being <code>{tidyverse}</code>-centric). But hopefully one can see the value in “doing whatever it takes”, even if it means using “non-tidy” R functions (e.g.&nbsp;<code>{data.table}</code>, matrices, etc.) or a different language altogether.</p>



</section>


<div class="quarto-listing quarto-listing-container-default" id="listing-listing">
<div class="list quarto-listing-default">

</div>
<div class="listing-no-matching d-none">
No matching items
</div>
</div><div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>the go-to package for data manipulation and all SQL-ish things↩︎</p></li>
<li id="fn2"><p>Non-negative matrix factorization may also be abbreviated just as NMF, hence the package name.↩︎</p></li>
<li id="fn3"><p>There’s nothing too interesting about the data retrieval—I’ve essentially just called <code>StatsBombR::FreeCompetitions()</code>, <code>StatsBombR::FreeMatches()</code>,<code>StatsBombR::FreeEvents()</code>, and <code>StatsBombR::allclean()</code> in succession for <code>competition_id = 43</code>.↩︎</p></li>
<li id="fn4"><p>minimally converted from the original JSON format↩︎</p></li>
<li id="fn5"><p>compared to <code>dict</code> and <code>list</code>s or python users↩︎</p></li>
<li id="fn6"><p>A potential solution would be to round the floating point numbers before joining and “restore” them after the join, but that’s just kluge-y and inelegant.↩︎</p></li>
<li id="fn7"><p>I believe the number of components is analogous to the number of components that one would define in performing <a href="https://en.wikipedia.org/wiki/Principal_component_analysis">principal components analysis (PCA)</a>.↩︎</p></li>
<li id="fn8"><p>There is nothing stopping us from plotting all 30 components—and, in fact, Devin does in his notebook—but I think it’s easier to digest a fraction of the components (for pedagogical purposes).↩︎</p></li>
<li id="fn9"><p>StatsBomb data treats the origin as the top-left corner of the pitch, which I find inconvenient for plotting since I prefer the origin to be the bottom left. Thus, this grid also flip the y-axis of the grid, hence the <code>_rev</code> part of the variable name.↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>r</category>
  <category>soccer</category>
  <guid>https://tonyelhabr.rbind.io/posts/decomposition-smoothing-soccer/index.html</guid>
  <pubDate>Wed, 14 Oct 2020 05:00:00 GMT</pubDate>
  <media:content url="https://tonyelhabr.rbind.io/posts/decomposition-smoothing-soccer/viz_nnmf_dimensions_1to9_r_smooth.png" medium="image" type="image/png" height="96" width="144"/>
</item>
<item>
  <title>Creating a Soccer Pitch Control Model</title>
  <dc:creator>Tony ElHabr</dc:creator>
  <link>https://tonyelhabr.rbind.io/posts/soccer-pitch-control-r/index.html</link>
  <description><![CDATA[ 



<section id="intro" class="level2">
<h2 class="anchored" data-anchor-id="intro">Intro</h2>
<p>There’s never been a better time to be involved in sports analytics. There is a wealth of open-sourced data and code (not to mention well-researched and public analysis) to digest and use. Both people working for teams and people just doing at as a hobby are publishing new and interesting analyses every day.</p>
<p>In particular, the <a href="https://www.youtube.com/channel/UCUBFJYcag8j2rm_9HkrrA7w">FriendsOfTracking (FOT)</a> group, co-led by Professor and author <a href="ttps://twitter.com/Soccermatics">David Sumpter</a><sup>1</sup> have put together an awesome series of videos on YouTube discussing modern soccer analytics, along with a collection of repositories on GitHub sharing the code shown in videos.</p>
<p><a href="https://twitter.com/EightyFivePoint">Laurie Shaw</a> has shared code that implements the <a href="https://www.youtube.com/watch?v=X9PrwPyolyU">pitch control model</a> described in <a href="https://twitter.com/the_spearman">William Spearman</a>’s paper <a href="http://www.sloansportsconference.com/wp-content/uploads/2018/02/2002.pdf">“Beyond Expected Goals”</a> is interesting to me. The model is different than the one that I used <a href="https://twitter.com/TonyElHabr/status/1304766718468857857?s=20">to create some animations on Twitter</a>. Those were based on the pitch control model described by <a href="https://twitter.com/JaviOnData">Javier Fernandez</a> and <a href="https://twitter.com/lukebornn">Luke Bornn</a> in their paper <a href="http://www.sloansportsconference.com/wp-content/uploads/2018/03/1003.pdf">“Wide Open Spaces”</a> (<a href="https://www.robert-hickman.eu/post/fall_back_in_to_space/">code</a> courtesy of <a href="https://twitter.com/robwhickman">Rob Hickman</a>). (Apologies for the onslaught of links!)</p>
<p>Now, I am not one for language wars—and, in fact, I use python often—but I thought it would be awesome to be able to plot Spearman’s pitch control model directly with <code>{ggplot2}</code> and friends. Thus, I set out to convert Laurie’s code to R, attempting to give it a “native” R feel while I was at it.</p>
<p>Most of the process of translating python to R was relatively straightforward (slicing and dicing data frames and arrays/vectors is just part of data cleaning), so I won’t detail them here. However, there was one part that was particularly interesting—the conversion of a python class object. This was actually the key (and most challenging part) of the conversion process.</p>
<p>There are some great resources for describing how to implement <a href="https://en.wikipedia.org/wiki/Object-oriented_programming">object-orientated programming (OOP)</a> in R, including a couple of chapter’s from <a href="https://twitter.com/hadleywickham">Hadley Wickham</a>’s <a href="https://adv-r.hadley.nz/oo.html">Advanced R book</a> and a <a href="https://blog.earo.me/2019/11/03/practical-guide-to-s3/">very practical write-up</a> from <a href="https://twitter.com/earowang">Earo Wang</a>. Every object-oriented task has its unique aspects, so hopefully my discussion here has something to add to what has already been written on the subject matter.</p>
<p><strong><em>For demonstration purposes, I’m going to walk through my steps for converting the python class object as if I were doing it for the first time.</em></strong></p>
</section>
<section id="constructor" class="level2">
<h2 class="anchored" data-anchor-id="constructor">Constructor</h2>
<p>Below is a stripped down version of Laurie’s code, showing the “essence” of what we need to replicate.<sup>2</sup></p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> player(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">object</span>):</span>
<span id="cb1-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>,player_id,frame):</span>
<span id="cb1-3">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> player_id</span>
<span id="cb1-4">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.get_position(frame)</span>
<span id="cb1-5">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.get_velocity(frame)</span>
<span id="cb1-6">        </span>
<span id="cb1-7">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> get_position(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>,frame):</span>
<span id="cb1-8">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.position <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array(frame[<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.player_id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x'</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.player_id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'y'</span>])</span>
<span id="cb1-9">        </span>
<span id="cb1-10">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> get_velocity(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>,frame):</span>
<span id="cb1-11">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.velocity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array(frame[<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.player_id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x_v'</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.player_id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'y_v'</span>])</span>
<span id="cb1-12">    </span>
<span id="cb1-13">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> tti(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>,final_position):</span>
<span id="cb1-14">        reaction_time <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># in s</span></span>
<span id="cb1-15">        vmax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># in m/s</span></span>
<span id="cb1-16">        reaction_position <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.position <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.velocity <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> reaction_time</span>
<span id="cb1-17">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.tti <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> reaction_time <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> np.linalg.norm(final_positon <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> reaction_position)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>vmax</span>
<span id="cb1-18"></span>
<span id="cb1-19">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> p_intercept(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>,t):</span>
<span id="cb1-20">        tti_sigma <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.45</span></span>
<span id="cb1-21">        den <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> np.exp(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>np.pi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>np.sqrt(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.0</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>tti_sigma <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.tti)))</span>
<span id="cb1-22">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> den</span></code></pre></div>
</details>
</div>
<p>Let’s make some notes and come back to these as we develop our R class.</p>
<ol type="1">
<li><p>We need a unique identifier: <code>player_id</code>. This is just a “best practice” thing for object-oriented programming and makes sense given our context. For a sport like soccer, a unique identifier could just be the player’s name, a combination of the team name and the player jersey number, a league unique identifier, etc.</p></li>
<li><p>A single-row data frame <code>frame</code> is passed to several of the methods, including the constructor <code>__init__</code>. This single row data frame is sourced from a much larger <code>tracking</code> data frame, with rows for every 0.04 second time interval (25 frames per second, or one frame per 0.04 seconds) in the game.</p></li>
<li><p>The python code stores both the player’s <code>position</code> and <code>velocity</code> as 2x1 arrays. This works well with the <a href="https://www.w3schools.com/python/gloss_python_assign_value_to_multiple_variables.asp">unpacking</a> that is done in other places in Laurie’s code.</p></li>
<li><p><code>tti</code>, short for “time to intercept (a target location)”, uses the player’s <code>position</code> and <code>velocity</code> to define the attribute <code>tti</code> (not to be confused with the method itself). This implies that <code>position</code> and <code>velocity</code> should be defined before <code>tti()</code> is ever called, as they are in <code>__init__</code>. <code>tti</code> needs the <code>position_final</code> 2x1 array to calculate <code>tti</code> which is not known upon instantiation; rather, <code>tti</code> can only be properly defined when called to do a specific calculation relating the player’s <code>position</code> and <code>velocity</code> (both defined implicitly in the class, without needing user-specification) with a user-supplied <code>position_final</code> pair of x and y values.</p></li>
<li><p><code>p_intercept</code>, short for “probability to intercept (a target location)” depends on <code>tti</code> and an additional parameter <code>t</code>, a user-specified value representing how much time is allotted to reach the ball. Like <code>tti</code>, <code>p_intercept</code> is only “properly” defined when actually doing a calculation on the player’s attributes. Unlike <code>tti</code>, there is no attribute in the <code>player</code> instance that stores this probability; it’s value must be saved in a variable external to the player class if the user wants to use it for something other than an ephemeral calculation.<sup>3</sup></p></li>
</ol>
<p>Time to intercept a “target” location (<code>tti</code>) may not be intuitive to comprehend immediately. The plot<sup>4</sup> below annotates the <code>tti</code> of a “target” location on the pitch (which does <strong>not</strong> have to be where the ball actually is). <code>tti</code> assumes that the player continues moving at their current speed (annotated by the arrows) for <code>reaction_time</code> seconds before running at <code>vmax</code> (full speed) to the target position. <code>tti</code> for each player is independent of the <code>tti</code> of all other players, which is a relatively reasonable assumption. <sup>5</sup></p>
<p><img src="https://tonyelhabr.rbind.io/posts/soccer-pitch-control-r/viz_tti_ex.png" class="img-fluid"></p>
<p>The probability of reaching the “target” location (<code>p_intercept</code>) is directly related to the player’s <code>tti</code>. Uncertainty about how long it will take the player to reach the target location is quantified by the constant <code>tti_sigma</code> in the calculation. (<code>tti</code> is the mean and <code>tti_sigma</code> is the standard deviation of the distribution for a player’s time to arrive at the target location.)</p>
<p><img src="https://tonyelhabr.rbind.io/posts/soccer-pitch-control-r/viz_p_intercept_ex_1.png" class="img-fluid"></p>
<p>Notably, this probability is independent of all other players’ probabilities (which explains how it is possible that both players are shown to have probabilities greater than 50% when <code>t = 6</code> above). When adjusting for all players’ probabilities (by dividing by the sum of all probabilities), the numbers change. This probability adjustment is key when we calculate pitch control.</p>
<p><img src="https://tonyelhabr.rbind.io/posts/soccer-pitch-control-r/viz_p_intercept_ex_2.png" class="img-fluid"></p>
<p>Ok, on to the R code. We’ll be using <a href="https://adv-r.hadley.nz/s3.html">S3</a> and the <a href="https://vctrs.r-lib.org/"><code>{vctrs}</code> package</a> to help create our <code>player</code> class. (As with the python class, I’ve simplified the actual implementation for demonstration purposes.)</p>
<p>First, we start with the constructor <code>new_player()</code>. Note that there is no direct <code>__init__</code> equivalent in R. Here we will make a function that is prefixed with <code>new_</code> and ends with the name of our class (<code>player</code>).</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">new_player <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(</span>
<span id="cb2-2">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">player_id =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">integer</span>(),</span>
<span id="cb2-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">double</span>(),</span>
<span id="cb2-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">double</span>(),</span>
<span id="cb2-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x_v =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">double</span>(),</span>
<span id="cb2-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y_v =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">double</span>()</span>
<span id="cb2-7">) {</span>
<span id="cb2-8">  vctrs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">new_rcrd</span>(</span>
<span id="cb2-9">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb2-10">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">player_id =</span> player_id,</span>
<span id="cb2-11">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> x,</span>
<span id="cb2-12">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> y,</span>
<span id="cb2-13">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x_v =</span> x_v,</span>
<span id="cb2-14">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y_v =</span> y_v,</span>
<span id="cb2-15">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tti =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># dummy value</span></span>
<span id="cb2-16">    ),</span>
<span id="cb2-17">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'player'</span></span>
<span id="cb2-18">  )</span>
<span id="cb2-19">}</span></code></pre></div>
</details>
</div>
<p>Now let’s reflect upon our prior notes.</p>
<ol type="1">
<li><p>We have the <code>player_id</code> in this constructor.</p></li>
<li><p>We don’t pass the data frame <code>tracking</code> here. We’ll do it in our helper function. We might say that our constructor is “low-level”, not intended for the user to call directly.</p></li>
<li><p>We split the position and velocity vectors into their individual x and y components, resulting in four total variables instead of two. I don’t think a vector (unnamed or named), list, or matrix are particularly compelling data types to use for an x-y pair of values in R. None natively support unpacking (although R vectors do have some form of “broadcasting” with their recycling behavior).</p></li>
<li><p>We assign a “dummy” value (-1) to <code>tti</code> when initializing the class instance. We will have a method to update <code>tti</code> based on x and y components.</p></li>
<li><p>Like <code>tti</code>, we will need a separate <code>p_intercept</code> method to be used to calculate the probabililty of intercepting a ball given a player’s position, speed, and the final position of the ball (all fed as inputs to <code>tti</code>), as well as the additional user-specified <code>t</code>, representing how much time is allotted to reach the ball.</p></li>
</ol>
</section>
<section id="validator" class="level2">
<h2 class="anchored" data-anchor-id="validator">Validator</h2>
<p>Let’s proceed by creating a validator function to, you guessed it, validate fields in the <code>player</code> class. It is good practice to check the values used to construct the class. The python code did not have any validation like this, but I don’t think it was ever expected to be extremely robust to any user input.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">validate_player <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(player) {</span>
<span id="cb3-2">  vctrs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vec_assert</span>(vctrs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">field</span>(player, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'player_id'</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">integer</span>())</span>
<span id="cb3-3">  vctrs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vec_assert</span>(vctrs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">field</span>(player, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x'</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">double</span>())</span>
<span id="cb3-4">  vctrs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vec_assert</span>(vctrs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">field</span>(player, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'y'</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">double</span>())</span>
<span id="cb3-5">  vctrs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vec_assert</span>(vctrs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">field</span>(player, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tti'</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">double</span>())</span>
<span id="cb3-6">  player</span>
<span id="cb3-7">}</span></code></pre></div>
</details>
</div>
<p>Note that we could have simply done this validation in the constructor function, but I think it makes sense to put the validation in its own function so that the constructor is more direct (especially if the validation checks are complex).</p>
</section>
<section id="helper" class="level2">
<h2 class="anchored" data-anchor-id="helper">Helper</h2>
<p>Finally, we’ll create a helper <code>player()</code> function, which is our “user-facing” function that we expect/want users to use to instantiate objects.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">player <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(player_id, frame, tracking) {</span>
<span id="cb4-2">    </span>
<span id="cb4-3">    player_id <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.integer</span>(player_id)</span>
<span id="cb4-4">    frame <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.integer</span>(frame)</span>
<span id="cb4-5"></span>
<span id="cb4-6">    assertthat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">assert_that</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.data.frame</span>(tracking))</span>
<span id="cb4-7">    nms_req <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'player_id'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'frame'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'y'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x_v'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'y_v'</span>)</span>
<span id="cb4-8">    assertthat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">assert_that</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all</span>(nms_req <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(tracking)))</span>
<span id="cb4-9">    </span>
<span id="cb4-10">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># `!!` to make sure that we filter using the integer values, not the column itself.</span></span>
<span id="cb4-11">    tracking_filt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> tracking <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(player_id <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!!</span>player_id, frame <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!!</span>frame)</span>
<span id="cb4-12">    assertthat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">assert_that</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(tracking_filt) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> 1L)</span>
<span id="cb4-13">    </span>
<span id="cb4-14">    player <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span></span>
<span id="cb4-15">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">new_player</span>(</span>
<span id="cb4-16">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">player_id =</span> player_id,</span>
<span id="cb4-17">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> tracking_filt[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x'</span>]],</span>
<span id="cb4-18">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> tracking_filt[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'y'</span>]],</span>
<span id="cb4-19">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x_v =</span> tracking_filt[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x_v'</span>]],</span>
<span id="cb4-20">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y_v =</span> tracking_filt[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'y_v'</span>]]</span>
<span id="cb4-21">      )</span>
<span id="cb4-22">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">validate_player</span>(player)</span>
<span id="cb4-23">  }</span></code></pre></div>
</details>
</div>
<p>Note the following:</p>
<ul>
<li>We coerce <code>player_id</code> and <code>frame</code> to integers instead of doubles (particularly since they are expected to be integers in the constructor). This ensures that the new <code>player</code> is instantiated properly by the constructor and passes our validation.</li>
<li>We pass in our entire <code>tracking</code> data frame (that has rows for every 0.04 second interval in the game), as well as the <code>frame</code> to slice out of it. (<code>player_id</code> is also used to filter <code>tracking</code>.) This makes it convenient for user to instantiate new <code>player</code> objects when operating on the <code>tracking</code> data frame. There is no need to extract the singular initial position and velocity components “manually”; instead, the helper function does it for the user.</li>
</ul>
</section>
<section id="aside" class="level2">
<h2 class="anchored" data-anchor-id="aside">Aside</h2>
<p>R’s S3 framework is not a formal OOP framework (not even close really). Note that it does not have a reserved keyword to represent the instance of the class like <code>self</code> in python. Also, it is not actually necessary for most of what is done above (with the constructor, validator, and helper).</p>
<p>For example, we don’t actually have to create a formal-ish constructor prefixed with <code>new_</code>. We don’t even need a constructor function at all in S3. We could do something like <code>class(var) &lt;- 'player'</code> to create a a <code>player</code> object. Of course, this is prone to errors down the line, so we don’t do that. Likewise with the validator and helper functions. The point of these constructs is to add clarity to our class code. They aren’t strictly necessary.</p>
</section>
<section id="printing" class="level2">
<h2 class="anchored" data-anchor-id="printing">Printing</h2>
<p>Let’s do one more thing for our <code>player</code> class—create a custom print method. (Writing a custom print method is not required whatsoever, but it can be very helpful for debugging.) If we weren’t using <code>{vctrs}</code> and just S3, we would do this by writing a <code>print.player</code> function. However, <code>{vctrs}</code> provides a “pretty” header for us auto-magically (that looks like <code>&lt;player[1]&gt;</code>) if we use it to write our print method.</p>
<p>To take advantage of the pretty-printing functionality offered by <code>{vctrs}</code>, we write a <code>format.player()</code> method that will be called by a subclass of the generic <code>vctrs::obj_print_data</code> method<sup>6</sup>, which itself is called whenever we print out an object (whether explicitly with <code>print</code> or just by typing the name of the variable representing our <code>player</code> instance). We’ll add the player’s position and velocity components to the print out.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">format.player <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(player, ...) {</span>
<span id="cb5-2">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(vctrs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">field</span>(player, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'in_frame'</span>)) {</span>
<span id="cb5-3">    suffix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb5-4">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sprintf</span>(</span>
<span id="cb5-5">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'with `position = (%.2f, %.2f)` and `velocity = &lt;%.1f, %.1f&gt;`'</span>, </span>
<span id="cb5-6">        vctrs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">field</span>(player, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'player_id'</span>), </span>
<span id="cb5-7">        vctrs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">field</span>(player, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'y'</span>), </span>
<span id="cb5-8">        vctrs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">field</span>(player, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x_v'</span>),</span>
<span id="cb5-9">        vctrs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">field</span>(player, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'y_v'</span>)</span>
<span id="cb5-10">      )</span>
<span id="cb5-11">  } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> {</span>
<span id="cb5-12">    suffix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'is not on the pitch'</span></span>
<span id="cb5-13">  }</span>
<span id="cb5-14">  prefix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sprintf</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'`player_id = %s` '</span>, vctrs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">field</span>(player, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'player_id'</span>))</span>
<span id="cb5-15">  msg <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sprintf</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'%s%s'</span>, prefix, suffix)</span>
<span id="cb5-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(msg, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sep =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb5-17">}</span>
<span id="cb5-18"></span>
<span id="cb5-19">obj_print_data.player <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(player) {</span>
<span id="cb5-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">format</span>(player), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sep =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb5-21">}</span></code></pre></div>
</details>
</div>
</section>
<section id="basic-usage" class="level2">
<h2 class="anchored" data-anchor-id="basic-usage">Basic Usage</h2>
<p>Ok, so that is all fine and dandy, but how would we go about instantiating <code>player</code>s in a normal workflow?</p>
<p>Let’s say that we want to calculate the pitch control for a single <code>frame</code> in the <code>tracking</code> data (called <code>tracking_start</code> below).<sup>7</sup></p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">tracking_start</span>
<span id="cb6-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 26 x 9</span></span>
<span id="cb6-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    frame ball_x ball_y side  player_id     x     y   x_v    y_v</span></span>
<span id="cb6-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    &lt;int&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;     &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span id="cb6-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  1 53027  93.71  24.56 home          1 90.72 39.37 5.906 -3.985</span></span>
<span id="cb6-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  2 53027  93.71  24.56 home          2 95.10 27.14 1.5   -2.023</span></span>
<span id="cb6-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  3 53027  93.71  24.56 home          3 96.01 23.32 1.418  2.395</span></span>
<span id="cb6-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  4 53027  93.71  24.56 home          4 92.39 15.64 1.005  3.473</span></span>
<span id="cb6-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  5 53027  93.71  24.56 home          5 83.96 24.69 4.238  1.2  </span></span>
<span id="cb6-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  6 53027  93.71  24.56 home          6 82.19 35.63 3.893 -0.619</span></span>
<span id="cb6-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  7 53027  93.71  24.56 home          7 85.79 17.34 1.703  1.523</span></span>
<span id="cb6-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  8 53027  93.71  24.56 home          8 76.06 50.16 2.018 -0.493</span></span>
<span id="cb6-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  9 53027  93.71  24.56 home          9 61.22 25.35 0.863 -0.77 </span></span>
<span id="cb6-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 10 53027  93.71  24.56 home         10 59.69 35.10 0.9   -0.573</span></span>
<span id="cb6-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # ... with 16 more rows</span></span></code></pre></div>
</details>
</div>
<p>Let’s convert players with id’s 10 through 12 (on the home team) to <code>player</code> instances and see how they look when printed out.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">10L<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>12L <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">player</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">player_id =</span> .x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">frame =</span> 53027L, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tracking =</span> tracking_start))</span>
<span id="cb7-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [[1]]</span></span>
<span id="cb7-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; &lt;player[1]&gt;</span></span>
<span id="cb7-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; `player_id = 10` with `position = (10.00, 35.09)` and `velocity = &lt;0.9, -0.6&gt;`</span></span>
<span id="cb7-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; </span></span>
<span id="cb7-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [[2]]</span></span>
<span id="cb7-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; &lt;player[1]&gt;</span></span>
<span id="cb7-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; `player_id = 11` with `position = (11.00, 32.28)` and `velocity = &lt;-0.3, 0.6&gt;`</span></span>
<span id="cb7-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; </span></span>
<span id="cb7-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [[3]]</span></span>
<span id="cb7-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; &lt;player[1]&gt;</span></span>
<span id="cb7-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; `player_id = 12` is not on the pitch</span></span></code></pre></div>
</details>
</div>
</section>
<section id="pseudo-encapsulation" class="level2">
<h2 class="anchored" data-anchor-id="pseudo-encapsulation">Pseudo-Encapsulation</h2>
<p>We still need to implement analogues for the <code>tti</code> and <code>p_intercept</code> methods in the python <code>player</code> class. Starting with <code>tti</code>, let’s use <a href="https://www.w3schools.com/java/java_encapsulation.asp">some pseudo-encapsulation (with getters and setters)</a> for a player’s <code>tti</code> value.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Frobenious norm</span></span>
<span id="cb8-2">euclidean_norm <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x1, x2, y1, y2) {</span>
<span id="cb8-3">  m <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(x1, y1)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(x2, y2))</span>
<span id="cb8-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(m<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span>
<span id="cb8-5">}</span>
<span id="cb8-6"></span>
<span id="cb8-7">.get_tti.player <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(player, x2, y2) {</span>
<span id="cb8-8">  ri <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># in s</span></span>
<span id="cb8-9">  vmax <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># in m/s</span></span>
<span id="cb8-10">  x1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> vctrs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">field</span>(player, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> vctrs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">field</span>(player, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x_v'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ri</span>
<span id="cb8-11">  y1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> vctrs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">field</span>(player, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'y'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> vctrs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">field</span>(player, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'y_v'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ri</span>
<span id="cb8-12">  ri <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">euclidean_norm</span>(x1, x2, y1, y2) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> vmax</span>
<span id="cb8-13">}</span>
<span id="cb8-14"></span>
<span id="cb8-15">.msg_cls_err <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(player, f) {</span>
<span id="cb8-16">  cls <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">class</span>(player)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb8-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sprintf</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'`%s()` doesn</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\'</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">t know how to handle class `%s`!'</span>, f, cls) </span>
<span id="cb8-18">}</span>
<span id="cb8-19"></span>
<span id="cb8-20">.get_tti.default <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(player, ...) {</span>
<span id="cb8-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stop</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">.msg_cls_err</span>(player, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.get_tti'</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">call. =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span>
<span id="cb8-22">}</span>
<span id="cb8-23"></span>
<span id="cb8-24">.get_tti <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(player, ...) {</span>
<span id="cb8-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">UseMethod</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.get_tti'</span>)</span>
<span id="cb8-26">}</span>
<span id="cb8-27"></span>
<span id="cb8-28"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.set_tti&lt;-.player</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(player, value) {</span>
<span id="cb8-29">  vctrs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">field</span>(player, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tti'</span>) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> value</span>
<span id="cb8-30">  player</span>
<span id="cb8-31">}</span>
<span id="cb8-32"></span>
<span id="cb8-33"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.set_tti&lt;-.default</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(player, ...) {</span>
<span id="cb8-34">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stop</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">.msg_cls_err</span>(player, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.set_tti'</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">call. =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span>
<span id="cb8-35">}</span>
<span id="cb8-36"></span>
<span id="cb8-37"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.set_tti&lt;-</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(player, ...) {</span>
<span id="cb8-38">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">UseMethod</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.set_tti&lt;-'</span>)</span>
<span id="cb8-39">}</span></code></pre></div>
</details>
</div>
<p>There’s a couple of things going on here:</p>
<ul>
<li>The <code>.get_tti</code> and <code>.set_tti</code> functions that call <code>UseMethod</code> are true S3 generics that perform method dispatch, i.e.&nbsp;find the correct method for the object passed to the generic (based on the class of the object). The <code>.get_tti.player</code> and <code>.set_tti.player</code> with the <code>.player</code> “suffix” so that they only work in their defined manners when passed in a <code>player</code> instance. (They won’t be called with an object that is not of the <code>player</code> class.)</li>
<li>The ellipses (<code>...</code>) in the S3 generic function signatures may be a bit mysterious since they aren’t passed explicitly to <code>UseMethod</code>. Any non-<code>player</code> arguments are captured in these ellipses and passed to whatever method that is called from the generic (e.g.&nbsp;<code>.get_tti.player</code> method called from the <code>.get_tti</code> generic). For <code>.get_tti</code>, the ellipses is intended to capture <code>x2</code> and <code>y2</code>, and for <code>.set_tti</code>, it captures <code>value</code>.</li>
<li>We must use the “strange” syntax <code>.set_tti&lt;-.player</code> (instead of just <code>.set_tti.player</code>, which may seem more “natural”) in order to update an attribute in an already instantiated class. <sup>8</sup></li>
<li>We define the function <code>euclidean_norm()</code> outside of <code>.get_tti.player</code> simply because it is not something that is specific to the time to intercept calculation for a player; it can work with any two pairs of x and y coordinates.<sup>9</sup></li>
<li><code>ri</code> and <code>vmax</code>, representing a player’s reaction time and a player’s maximum velocity respectively, are constants defined in the Spearman paper. We could change these if we wanted to, or even make them dynamic (i.e.&nbsp;configurable via other function parameters, or even at instantiation time).</li>
</ul>
<p>To really complete our getter and setter methods for <code>tti</code>, we should write methods to handle the case when a non-<code>player</code> object is passed to them. The generic <code>.get_tti</code> and <code>.set_tti</code> methods will dispatch to these functions if the object passed to them (the first argument named <code>player</code>) doesn’t actually inherit from the <code>player</code> class.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">.get_tti.default <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(player, ...) {</span>
<span id="cb9-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stop</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">.msg_cls_err</span>(player, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.get_tti'</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">call. =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span>
<span id="cb9-3">}</span>
<span id="cb9-4"></span>
<span id="cb9-5">.set_tti.default <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(player, ...) {</span>
<span id="cb9-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stop</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">.msg_cls_err</span>(player, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.get_tti'</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">call. =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span>
<span id="cb9-7">}</span></code></pre></div>
</details>
</div>
<p>Let’s see how our pseudo-encapsulation looks in action.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1">players <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> 8L<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>10L <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">player</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">player_id =</span> .x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">frame =</span> 53027L, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tracking =</span> tracking_start))</span>
<span id="cb10-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map</span>(players, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>vctrs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">field</span>(.x, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tti'</span>))</span>
<span id="cb10-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [[1]]</span></span>
<span id="cb10-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [1] -1</span></span>
<span id="cb10-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; </span></span>
<span id="cb10-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [[2]]</span></span>
<span id="cb10-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [1] -1</span></span>
<span id="cb10-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; </span></span>
<span id="cb10-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [[3]]</span></span>
<span id="cb10-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [1] -1</span></span></code></pre></div>
</details>
</div>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1">target_x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">94</span></span>
<span id="cb11-2">target_y <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">63</span></span>
<span id="cb11-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_along</span>(players)) {</span>
<span id="cb11-4">  value <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">.get_tti</span>(players[[i]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x2 =</span> target_x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y2 =</span> target_y)</span>
<span id="cb11-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">.set_tti</span>(players[[i]]) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> value</span>
<span id="cb11-6">}</span>
<span id="cb11-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map</span>(players, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>vctrs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">field</span>(.x, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tti'</span>))</span>
<span id="cb11-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [[1]]</span></span>
<span id="cb11-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [1] 4.92839</span></span>
<span id="cb11-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; </span></span>
<span id="cb11-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [[2]]</span></span>
<span id="cb11-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [1] 10.6878</span></span>
<span id="cb11-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; </span></span>
<span id="cb11-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [[3]]</span></span>
<span id="cb11-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [1] 9.49904</span></span></code></pre></div>
</details>
</div>
<p>Note how the player <code>tti</code> values changed after we defined them for a specified <code>target_x</code> and <code>target_y</code>.</p>
<p>Our approach to <code>p_intercept</code> is very similar to that for <code>tti</code>, so I don’t show most of it here. As before, we define getters and setters, as well as generics for the class (the intended target of method dispatch), as well as a default class to handle unexpected inputs. Probably the only interesting part is the calculation itself, as shown below. If you compare it to the <code>p_intercept</code> method in the python object definition, you’ll see it’s basically identical.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1">.get_p_intercept.player <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(player, t) {</span>
<span id="cb12-2">  tti_sigma <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.45</span></span>
<span id="cb12-3">  den <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>((<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>base<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>pi <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> tti_sigma) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (t <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> vctrs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">field</span>(player, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tti'</span>)))</span>
<span id="cb12-4">  <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> den</span>
<span id="cb12-5">}</span></code></pre></div>
</details>
</div>
<p>There is certainly more to show, especially for what is needed to calculate pitch control. (We need to integrate probabilities across all players over time, and do it for the entire pitch.) Nonetheless, the <code>player</code> class and the pseudo-encapsulation that we’ve implemented with S3 and <code>{vctrs}</code> is really the key component underlying the whole pitch control calculation.</p>
</section>
<section id="advanced-usage" class="level2">
<h2 class="anchored" data-anchor-id="advanced-usage">Advanced Usage</h2>
<p>To really motivate the reader, let’s see what this implementation allows us to do.</p>
<p>First, let’s emulate the pitch control plot of event 823, which is a pass by the away (blue) team in the home (red) team’s penalty area preceding a successful shot.</p>
<p><img src="https://tonyelhabr.rbind.io/posts/soccer-pitch-control-r/pc_823_r.png" class="img-fluid"></p>
<p>Compare this to the python version.</p>
<p><img src="https://tonyelhabr.rbind.io/posts/soccer-pitch-control-r/pc_822_python.png" class="img-fluid"></p>
<p>It’s not a perfect replication, but I think it’s very close overall.</p>
<p>Second, let’s replicate the <a href="http://www.sloansportsconference.com/wp-content/uploads/2019/02/Decomposing-the-Immeasurable-Sport.pdf">expected possession value (EPV)</a> plot of the same event, including the EPV added by the pass.</p>
<p><img src="https://tonyelhabr.rbind.io/posts/soccer-pitch-control-r/epv_823_r.png" class="img-fluid"></p>
<p>Again, we can compare this plot to the python equivalent.</p>
<p><img src="https://tonyelhabr.rbind.io/posts/soccer-pitch-control-r/epv_822_python.png" class="img-fluid"></p>
<p>Cool, my R version seems to be very close to the python original. We do have a small discrepancy in the EPV added calculation. (This EPV is actually an “expected” EPV calculation that uses pitch control to weight the pre-learned EPV grid). I believe this is probably due to discrepancies in the integration done in the pitch control calculation and not due to a significant code issue.</p>
<p>The code to prepare the data for these plots gets more complex, which is why I have excluded it here.<sup>10</sup> However, none of it is unreasonably difficult to understand or implement once we have a properly defined <code>player</code> object.</p>
</section>
<section id="conclusion" class="level1">
<h1>Conclusion</h1>
<p>Thus, we see that there is a huge payoff to creating a sound and robust <code>player</code> object—we can calculate pitch control and EPV, and feed them into pretty visualizations that can provide insight. I believe that the code here could be easily adapted to fit whatever one would like to study. For example, the valuation grid used here could be easily swapped out with <a href="https://karun.in/blog/expected-threat.html">expected threat (xT)</a>, which is a more modern and probably a better valuation framework than the one used here.<sup>11</sup> Furthermore, one could calculate EPV across the entire game. The possibilities for analyses really open up.</p>



</section>


<div class="quarto-listing quarto-listing-container-default" id="listing-listing">
<div class="list quarto-listing-default">

</div>
<div class="listing-no-matching d-none">
No matching items
</div>
</div><div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>author of one of my favorite books <strong>Soccermatics</strong>↩︎</p></li>
<li id="fn2"><p>If you actually browse Laurie’s code, you’ll notice that I’ve changed some of the names of these functions, e.g.&nbsp;<code>tti()</code> here instead of <code>simple_time_to_intercept()</code> there, <code>tracking_df</code> instead of <code>team</code> there. Don’t worry about that. I just wanted to make things as comparable as possible for the diligent reader, and I tried to make variable names that were either (or both) more succinct or more clear.↩︎</p></li>
<li id="fn3"><p>One might argue that we should be consistent with <code>tti</code> and <code>p_intercept</code> and store them in the same way—either both as attributes or neither as attributes—given that both are dependent on some user-specified values (<code>final_position</code> for <code>tti</code> and <code>t</code> for <code>p_intercept</code>). I’m just showing how it is done in Laurie’s code. I think it is simple enough as is and there is no compelling functional reason why we should change the implementation.↩︎</p></li>
<li id="fn4"><p>Data for this plot and all that follow from post-processed <a href="https://github.com/metrica-sports/sample-data">Metrica Sports sample game 2 data</a>.↩︎</p></li>
<li id="fn5"><p>author of one of my favorite books <strong>Soccermatics</strong>↩︎</p></li>
<li id="fn6"><p><code>vctrs::obj_print_data</code> that can also handle <a href="https://home.unicode.org/">Unicode</a> easily, although we are not using any Unicode characters here. Also, it is able to handle extra <code>NULL</code>s and <code>[1]</code> that may be printed out if we just use <code>cat</code> or <code>print</code> directly.↩︎</p></li>
<li id="fn7"><p>This is the same data used to generate the first handful of plots.↩︎</p></li>
<li id="fn8"><p><a href="https://adv-r.hadley.nz/r6.html">R6</a> is probably a better OOP system to use for this whole use case. The capability to update instance attributes is more native to that framework.↩︎</p></li>
<li id="fn9"><p>It’s best to separate our logic in functions like this where it makes sense to do so. It ultimately makes re-factoring and debugging a lot easier.↩︎</p></li>
<li id="fn10"><p>Feel free to check out the source the <a href="https://github.com/tonyelhabr/LaurieOnTracking/blob/master/analysis/01-freestyle-blog.R">code</a> used in the full implementation, as well as the code to generate the plots.↩︎</p></li>
<li id="fn11"><p><a href="https://raw.githubusercontent.com/anenglishgoat/InteractivePitchControl/master/xT.csv">Here</a> is a CSV with the grid for xT.↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>r</category>
  <category>soccer</category>
  <guid>https://tonyelhabr.rbind.io/posts/soccer-pitch-control-r/index.html</guid>
  <pubDate>Wed, 23 Sep 2020 05:00:00 GMT</pubDate>
  <media:content url="https://tonyelhabr.rbind.io/posts/soccer-pitch-control-r/viz_pc_823_combined.png" medium="image" type="image/png" height="60" width="144"/>
</item>
</channel>
</rss>
