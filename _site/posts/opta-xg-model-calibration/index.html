<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Tony ElHabr">
<meta name="dcterms.date" content="2023-02-20">
<meta name="description" content="Evaluating Opta’s xG model performance with Brier skill score (BSS) and calibration curves">

<title>Tony’s Blog - xG Model Calibration</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../assets/img/keyboard.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-listing/list.min.js"></script>
<script src="../../site_libs/quarto-listing/quarto-listing.js"></script>
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script>

  window.document.addEventListener("DOMContentLoaded", function (_event) {
    const listingTargetEl = window.document.querySelector('#listing-listing .list');
    if (!listingTargetEl) {
      // No listing discovered, do not attach.
      return; 
    }

    const options = {
      valueNames: [{ data: ['index'] },{ data: ['categories'] },{ data: ['listing-date-sort'] },{ data: ['listing-file-modified-sort'] }],
      
      searchColumns: [],
    };

    window['quarto-listings'] = window['quarto-listings'] || {};
    window['quarto-listings']['listing-listing'] = new List('listing-listing', options);

    if (window['quarto-listing-loaded']) {
      window['quarto-listing-loaded']();
    }
  });

  window.addEventListener('hashchange',() => {
    if (window['quarto-listing-loaded']) {
      window['quarto-listing-loaded']();
    }
  })
  </script>

<script type="text/javascript">

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-79842648-2', 'auto');

ga('send', {
  hitType: 'pageview',
  'anonymizeIp': true,
});
</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="alternate" type="application/rss+xml" title="Tony's Blog" href="index.xml"><meta name="twitter:title" content="Tony’s Blog - xG Model Calibration">
<meta name="twitter:description" content="Evaluating Opta's xG model performance with Brier skill score (BSS) and calibration curves">
<meta name="twitter:image" content="https://itsmetoeknee.netlify.app/posts\opta-xg-model-calibration\footedness_calibration.png">
<meta name="twitter:site" content="@TonyElHabr">
<meta name="twitter:image-height" content="2100">
<meta name="twitter:image-width" content="3000">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Tony’s Blog</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../projects.html">
 <span class="menu-text">Projects</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/tonyelhabr"><i class="bi bi-github" role="img" aria-label="github">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/TonyElHabr"><i class="bi bi-twitter" role="img" aria-label="twitter">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div class="quarto-toggle-container">
                  <a href="" class="quarto-color-scheme-toggle nav-link" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
              </div>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#pre--and-post-update-xg-comparison" id="toc-pre--and-post-update-xg-comparison" class="nav-link" data-scroll-target="#pre--and-post-update-xg-comparison">1. Pre- and post-update xG comparison</a></li>
  <li><a href="#xg-model-calibration" id="toc-xg-model-calibration" class="nav-link" data-scroll-target="#xg-model-calibration">2. xG Model Calibration</a>
  <ul>
  <li><a href="#calibration-plot" id="toc-calibration-plot" class="nav-link" data-scroll-target="#calibration-plot">Calibration plot</a></li>
  <li><a href="#brier-skill-score-bss" id="toc-brier-skill-score-bss" class="nav-link" data-scroll-target="#brier-skill-score-bss">Brier Skill Score (BSS)</a></li>
  <li><a href="#grouped-calibration-and-bss" id="toc-grouped-calibration-and-bss" class="nav-link" data-scroll-target="#grouped-calibration-and-bss">Grouped Calibration and BSS</a></li>
  </ul></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  </ul>
</nav>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">xG Model Calibration</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
  <div class="quarto-categories">
    <div class="quarto-category">r</div>
    <div class="quarto-category">soccer</div>
  </div>
  </div>

<div>
  <div class="description">
    Evaluating Opta’s xG model performance with Brier skill score (BSS) and calibration curves
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Tony ElHabr </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">February 20, 2023</p>
    </div>
  </div>
  
    <div>
    <div class="quarto-title-meta-heading">Modified</div>
    <div class="quarto-title-meta-contents">
      <p class="date-modified">February 24, 2023</p>
    </div>
  </div>
    
  </div>
  

</header>

<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>Recently, <a href="https://twitter.com/TonyElHabr/status/1614288983105617922">I pointed out</a> what seemed to be a bug with the <a href="https://theanalyst.com/na/2021/07/what-are-expected-goals-xg/">expected goals (xG)</a> data shown on <a href="https://fbref.com">FBref</a>. In particular, the difference between non-penalty goals (npG) and non-penalty xG (npxG)<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> seemed to be an outlier for the 2021/22 season across <a href="https://fbref.com/en/comps/Big5/Big-5-European-Leagues-Stats">the Big 5 leagues</a>.</p>
<blockquote class="twitter-tweet blockquote">
<p lang="en" dir="ltr">
</p><p>“aLl xG mOdeLs ArE thE sAme”<br><br>my brother in christ wut is this then <a href="https://t.co/7tjp1VFkoc">pic.twitter.com/7tjp1VFkoc</a></p>
<p></p>
<p>— Tony (<span class="citation" data-cites="TonyElHabr">@TonyElHabr</span>) <a href="https://twitter.com/TonyElHabr/status/1614288983105617922?ref_src=twsrc%5Etfw">January 14, 2023</a></p>
</blockquote>
<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<p>As it turns out FBref and their data provider, <a href="https://www.statsperform.com/opta/">Opta</a>, agreed! On Feb.&nbsp;8, 2023, <a href="https://twitter.com/fbref/status/1623358271791722502?s=20">they posted an update</a> indicating that they adjusted their 2021/22 xG such that the difference between npG and npxG is much more in line with other seasons.</p>
<p>The FBref/Opta update gave me two ideas:</p>
<ol type="1">
<li><p><strong>Compare pre- and post-update xG</strong> to identify where/how adjustments were applied. Where were the “blind spot(s)”?<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p></li>
<li><p><strong>Quantify the <a href="https://en.wikipedia.org/wiki/Calibration_(statistics)">calibration</a> of their xG model.</strong> Are there obvious weak points with the model?</p></li>
</ol>
<div class="cell">

</div>
<div class="cell">

</div>
</section>
<section id="pre--and-post-update-xg-comparison" class="level2">
<h2 class="anchored" data-anchor-id="pre--and-post-update-xg-comparison">1. Pre- and post-update xG comparison</h2>
<div class="cell">

</div>
<div class="cell">

</div>
<p>First, let’s take a wholistic look at all of the shots for the 2021/22 seasons played in Big 5 leagues.</p>
<div class="cell">

</div>
<p><img src="old_vs_new_xg.png" class="img-fluid"></p>
<p>Of the 44,986 shots in the data set, 30,326 (67.2%) had changes to their xG values.<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> Of those that changed, 23, 584 (78.0%) were reduced, i.e.&nbsp;the pre-update xG value was higher. The average change was pretty minimal, just about ~0.01 xG.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(discretized_updated_np_shots)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Rows: 44,986</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Columns: 16</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; $ league             &lt;fct&gt; ENG, ENG, ENG, ENG, ENG, ENG, ENG, ENG, ENG, ENG, E…</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; $ date               &lt;date&gt; 2021-08-13, 2021-08-13, 2021-08-13, 2021-08-13, 20…</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; $ half               &lt;dbl&gt; 1, 1, 1, 1, 1, 2, 2, 2, 1, 1, 1, 1, 1, 1, 1, 2, 2, …</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; $ minute             &lt;chr&gt; "11", "12", "22", "28", "30", "66", "73", "80", "2"…</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; $ team               &lt;chr&gt; "Brentford", "Brentford", "Brentford", "Brentford",…</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; $ player             &lt;chr&gt; "Frank Onyeka", "Bryan Mbeumo", "Sergi Canós", "Ser…</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; $ new_xg             &lt;dbl&gt; 0.08, 0.09, 0.02, 0.06, 0.26, 0.06, 0.40, 0.28, 0.0…</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; $ old_xg             &lt;dbl&gt; 0.09, 0.14, 0.04, 0.07, 0.31, 0.13, 0.58, 0.27, 0.0…</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; $ is_goal            &lt;fct&gt; no, no, yes, no, no, no, yes, no, no, no, no, no, n…</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; $ distance           &lt;fct&gt; "(8,10]", "(12,14]", "(16,18]", "(20,25]", "(12,14]…</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; $ sca1               &lt;fct&gt; pass_live, pass_live, pass_live, pass_live, take_on…</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; $ body_part          &lt;fct&gt; Head, Right Foot, Right Foot, Right Foot, Right Foo…</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; $ is_from_deflection &lt;fct&gt; no, no, no, no, no, no, no, no, no, no, no, no, no,…</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; $ is_from_volley     &lt;fct&gt; no, no, no, no, no, no, no, no, no, yes, no, no, no…</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; $ is_free_kick       &lt;fct&gt; no, no, no, no, no, no, no, no, no, no, no, no, no,…</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; $ is_primary_foot    &lt;fct&gt; missing, no, yes, yes, no, yes, missing, missing, y…</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>discretized_updated_np_shots <span class="sc">|&gt;</span> </span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">xgd =</span> old_xg <span class="sc">-</span> new_xg) <span class="sc">|&gt;</span> </span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(xgd) <span class="sc">|&gt;</span> </span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>()</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 0.0095014</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>To get more insight into how/why xG changed, we can look at changes to xG values grouped by various <code>feature</code>s that we can derive from data that FBref publishes alongside each shot’s xG, including <code>distance</code> (yards), <code>sca1</code> (first <a href="https://www.sports-reference.com/blog/2020/04/goal-creation-possession-passing-and-more-advanced-stats-on-fbref/">shot-creating action</a>), <code>body_part</code>, <code>is_from_deflection</code>, <code>is_from_volley</code>, <code>is_free_kick</code>, and <code>is_primary_foot</code>.<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a><a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a></p>
<div class="cell">

</div>
<p>The table below shows that the reductions in npxG occurred most frequently for longer <code>distance</code>s, suggesting that the pre-update xG model was over-predicting xG for longer shots. Interestingly, xG for shots when interceptions were the shot-creating action that led directly to the shot, and xG for shots with <code>body_part = "other"</code> (non-foot, non-header) were also frequently reduced, in the cases where xG was changed.</p>
<table class="table">
<colgroup>
<col style="width: 8%">
<col style="width: 12%">
<col style="width: 16%">
<col style="width: 20%">
<col style="width: 42%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Feature</th>
<th style="text-align: left;">Group</th>
<th style="text-align: right;"># of non-penalty shots</th>
<th style="text-align: right;"># of shots with changed npxG</th>
<th style="text-align: right;"># of shots with lower post-update npxG of those that changed</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>distance</code></td>
<td style="text-align: left;"><code>(25,30]</code></td>
<td style="text-align: right;">6,061</td>
<td style="text-align: right;">3,659 (60.4%)</td>
<td style="text-align: right;">3,437 (93.9%)</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>distance</code></td>
<td style="text-align: left;"><code>(20,25]</code></td>
<td style="text-align: right;">6,760</td>
<td style="text-align: right;">4,463 (66.0%)</td>
<td style="text-align: right;">4,088 (91.6%)</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>sca1</code></td>
<td style="text-align: left;"><code>"interception"</code></td>
<td style="text-align: right;">149</td>
<td style="text-align: right;">96 (64.4%)</td>
<td style="text-align: right;">87 (90.6%)</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>distance</code></td>
<td style="text-align: left;"><code>(18,20]</code></td>
<td style="text-align: right;">1,889</td>
<td style="text-align: right;">1,232 (65.2%)</td>
<td style="text-align: right;">1,088 (88.3%)</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>distance</code></td>
<td style="text-align: left;"><code>(30,35]</code></td>
<td style="text-align: right;">2,725</td>
<td style="text-align: right;">1,267 (46.5%)</td>
<td style="text-align: right;">1,117 (88.2%)</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>body_part</code></td>
<td style="text-align: left;"><code>"Other"</code></td>
<td style="text-align: right;">191</td>
<td style="text-align: right;">153 (80.1%)</td>
<td style="text-align: right;">130 (85.0%)</td>
</tr>
</tbody>
</table>
<p>On the other end of the spectrum, reductions in npxG occurred least frequently for shorter <code>distance</code> buckets (<code>(0,2]</code>, <code>(2,4]</code>, <code>(4,6]</code>, <code>(6,8)</code>). Reductions still occurred a majority of the time when there was a change—note that each has <code>&gt;50%</code> for the last column—for all but the shortest <code>distance</code> group, <code>(0,2]</code>.</p>
<table class="table">
<colgroup>
<col style="width: 10%">
<col style="width: 8%">
<col style="width: 17%">
<col style="width: 21%">
<col style="width: 42%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Feature</th>
<th style="text-align: left;">Group</th>
<th style="text-align: right;"># of non-penalty shots</th>
<th style="text-align: right;"># of shots with changed npxG</th>
<th style="text-align: right;"># of shots with lower post-update npxG of those that changed</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>distance</code></td>
<td style="text-align: left;"><code>(0,2]</code></td>
<td style="text-align: right;">173</td>
<td style="text-align: right;">130 (75.1%)</td>
<td style="text-align: right;">51 (39.2%)</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>distance</code></td>
<td style="text-align: left;"><code>(2,4]</code></td>
<td style="text-align: right;">1,087</td>
<td style="text-align: right;">826 (76.0%)</td>
<td style="text-align: right;">428 (51.8%)</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>distance</code></td>
<td style="text-align: left;"><code>(4,6]</code></td>
<td style="text-align: right;">2,003</td>
<td style="text-align: right;">1,479 (73.8%)</td>
<td style="text-align: right;">831 (56.2%)</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>distance</code></td>
<td style="text-align: left;"><code>(35,Inf]</code></td>
<td style="text-align: right;">539</td>
<td style="text-align: right;">313 (58.1%)</td>
<td style="text-align: right;">177 (56.5%)</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>distance</code></td>
<td style="text-align: left;"><code>(6,8]</code></td>
<td style="text-align: right;">2,557</td>
<td style="text-align: right;">1,882 (73.6%)</td>
<td style="text-align: right;">1,183 (62.9%)</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>is_free_kick</code></td>
<td style="text-align: left;"><code>"yes"</code></td>
<td style="text-align: right;">1,576</td>
<td style="text-align: right;">882 (56.0%)</td>
<td style="text-align: right;">557 (63.2%)</td>
</tr>
</tbody>
</table>
</section>
<section id="xg-model-calibration" class="level2">
<h2 class="anchored" data-anchor-id="xg-model-calibration">2. xG Model Calibration</h2>
<p><a href="../../posts/epl-xpts-simulation-1/#match-predictive-performance7">I’ve touched on model calibration before</a>, when discussing xG-implied match outcome probabilities. There, I wrote my own code to create a <a href="https://changhsinlee.com/python-calibration-plot/">calibration plot</a>. Since then, the <a href="https://www.tidymodels.org/"><code>{tidymodels}</code> team</a> has added <a href="https://www.tidyverse.org/blog/2022/11/model-calibration/">calibration plot functionality</a> to the <a href="https://probably.tidymodels.org/"><code>{probably}</code> package</a>. Let’s try it out.</p>
<p>Here, we’ll use a big sample of data—all 2017/18 - 2021/22 non-penalty shots for the Big 5 leagues and several other first and second tier leagues.<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a></p>
<div class="cell">

</div>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>np_shots <span class="sc">|&gt;</span> <span class="fu">count</span>(league, <span class="at">name =</span> <span class="st">'n_shots'</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 13 × 2</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    league    n_shots</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    &lt;chr&gt;       &lt;int&gt;</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  1 BRA_1st_M   39380</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  2 ENG_1st_F   11366</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  3 ENG_1st_M   46766</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  4 ENG_2nd_M   52701</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  5 ESP_1st_M   43398</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  6 FRA_1st_M   43021</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  7 GER_1st_M   39148</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  8 ITA_1st_M   49903</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  9 MEX_1st_M   32650</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 10 NED_1st_M   29803</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 11 POR_1st_M   27366</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 12 USA_1st_F    9887</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 13 USA_1st_M   31047</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="calibration-plot" class="level3">
<h3 class="anchored" data-anchor-id="calibration-plot">Calibration plot</h3>
<p>We can use <code>probably::cal_plot_breaks()</code> to visually assess whether the observed rate of non-penalty goals (y-axis) is close to the predicted probability of goals (npxG, x-axis).<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a> If the xG model’s predictions are “well calibrated”, the calibration points will align with the “ideal” line having slope 1 and intercept 0. Points at which the curve is below the diagonal line indicate where the model is more likelty to overpredict; and, likewise, points where the curve is above the diagonal line indicate where the model is underpredicting.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(probably) <span class="do">## 0.1.0.9007</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>overall_calibration <span class="ot">&lt;-</span> <span class="fu">cal_plot_breaks</span>(</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  np_shots,</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">truth =</span> is_goal,</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimate =</span> xg,</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">num_breaks =</span> <span class="dv">20</span>,</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">conf_level =</span> <span class="fl">0.9</span>,</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">event_level =</span> <span class="st">'second'</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">

</div>
<p><img src="overall_calibration.png" class="img-fluid"></p>
<p>We can see that the model is pretty well calibrated on the lower end of the spectrum, when xG &lt; 0.25. This makes up a larger majority of the shots (~90%). However, the model is not as well calibrated for higher xG values, tending to overpredict. For example, at the calibration point where npxG is <code>0.675</code>, the actual goal rate is <code>0.6</code>.</p>
</section>
<section id="brier-skill-score-bss" class="level3">
<h3 class="anchored" data-anchor-id="brier-skill-score-bss">Brier Skill Score (BSS)</h3>
<p>One thing that is not provided in the <code>{tidymodels}</code> realm (specifically, the <code>{yardstick}</code> package) is a function to compute <a href="https://en.wikipedia.org/wiki/Brier_score">Brier score</a>. Nonetheless, we can define a Brier score function ourselves by closely following <a href="https://www.tidymodels.org/learn/develop/metrics/">the mean squared error custom metric example</a> provided by the <code>{tidymodels}</code> team.<a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a></p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(yardstick)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rlang)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>brier_score <span class="ot">&lt;-</span> <span class="cf">function</span>(data, ...) {</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">UseMethod</span>(<span class="st">'brier_score'</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>brier_score <span class="ot">&lt;-</span> yardstick<span class="sc">::</span><span class="fu">new_prob_metric</span>(brier_score, <span class="at">direction =</span> <span class="st">'minimize'</span>)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>brier_score_vec <span class="ot">&lt;-</span> <span class="cf">function</span>(truth, estimate, <span class="at">na_rm =</span> <span class="cn">TRUE</span>, event_level, ...) {</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  brier_score_impl <span class="ot">&lt;-</span> <span class="cf">function</span>(truth, estimate, event_level, ...) {</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    truth <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> (<span class="fu">as.numeric</span>(truth) <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (event_level <span class="sc">==</span> <span class="st">'second'</span>) {</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>      truth <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> truth</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mean</span>((truth <span class="sc">-</span> estimate)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Recycle the estimate value if it's scalar-ish.</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(estimate) <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    estimate <span class="ot">&lt;-</span> <span class="fu">rep</span>(estimate, <span class="fu">length</span>(truth))</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>  yardstick<span class="sc">::</span><span class="fu">metric_vec_template</span>(</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">metric_impl =</span> brier_score_impl,</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">truth =</span> truth,</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">estimate =</span> estimate,</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">na_rm =</span> na_rm,</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">cls =</span> <span class="fu">c</span>(<span class="st">'factor'</span>, <span class="st">'numeric'</span>),</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">estimator =</span> <span class="st">'binary'</span>,</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">event_level =</span> event_level,</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>    ...</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>brier_score.data.frame <span class="ot">&lt;-</span> <span class="cf">function</span>(data, truth, estimate, <span class="at">na_rm =</span> <span class="cn">TRUE</span>, <span class="at">event_level =</span> <span class="st">'first'</span>, ...) {</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>  yardstick<span class="sc">::</span><span class="fu">metric_summarizer</span>(</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">metric_nm =</span> <span class="st">'brier_score'</span>,</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">metric_fn =</span> brier_score_vec,</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> data,</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">truth =</span> <span class="sc">!!</span>rlang<span class="sc">::</span><span class="fu">enquo</span>(truth),</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">estimate =</span> <span class="sc">!!</span>rlang<span class="sc">::</span><span class="fu">enquo</span>(estimate),</span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">na_rm =</span> na_rm,</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">event_level =</span> event_level,</span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>    ...</span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let’s compute the Brier scores for (1) the overall goal rate (i.e.&nbsp;shots per goal) and (2) xG. We should expect the Brier score for the latter to be closer to 0 (perfect model), since xG should be a better predictor of goals than the naive goal rate.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>np_goal_rate <span class="ot">&lt;-</span> np_shots <span class="sc">|&gt;</span> </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(is_goal) <span class="sc">|&gt;</span> </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prop =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n)) <span class="sc">|&gt;</span> </span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(is_goal <span class="sc">==</span> <span class="st">'yes'</span>) <span class="sc">|&gt;</span> </span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(prop)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>np_goal_rate</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 0.0960288</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>np_goal_rate_brier_score <span class="ot">&lt;-</span> np_shots <span class="sc">|&gt;</span> </span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">brier_score</span>(</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">truth =</span> is_goal,</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">estimate =</span> <span class="sc">!!</span>np_goal_rate,</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">event_level =</span> <span class="st">'second'</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(.estimate)</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>np_goal_rate_brier_score</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 0.08680727</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>npxg_brier_score <span class="ot">&lt;-</span> np_shots <span class="sc">|&gt;</span> </span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">brier_score</span>(</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">truth =</span> is_goal,</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">estimate =</span> xg,</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">event_level =</span> <span class="st">'second'</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(.estimate)</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>npxg_brier_score</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 0.07150071</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now we can go on to compute <a href="https://en.wikipedia.org/wiki/Brier_score#Brier_Skill_Score_(BSS)">Brier skill score (BSS)</a> using an appropriate reference Brier score.<a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a> In this context, the average goal rate seems to be a good choice for a baseline. In contrast to the Brier score, a higher BSS is ideal. (A perfect model would have a BSS of 1.)</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="sc">-</span> (npxg_brier_score <span class="sc">/</span> np_goal_rate_brier_score)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 0.176328</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>A BSS of ~0.18 is not bad! This is better than <a href="https://projects.fivethirtyeight.com/checking-our-work/">FiveThirtyEight’s BSS</a> for predicting the results for men’s World Cup matches (~0.12 at time of writing) and right around their BSS for predicting WNBA playoff game outcomes (~0.18).<a href="#fn10" class="footnote-ref" id="fnref10" role="doc-noteref"><sup>10</sup></a></p>
</section>
<section id="grouped-calibration-and-bss" class="level3">
<h3 class="anchored" data-anchor-id="grouped-calibration-and-bss">Grouped Calibration and BSS</h3>
<p>Now let’s take a look at model calibration under specific criteria. Is the model worse for shots that follow a dribble (<code>take_on</code>) shot-creating action? After a <code>live_ball</code> pass? etc.</p>
<div class="cell">

</div>
<p><img src="sca1_calibration.png" class="img-fluid"></p>
<p>A couple of observations and thoughts:</p>
<ul>
<li><p>xG of shots following another shot are over-predicted so much that it causes the BSS to be negative. This means that the model is actually doing worse in its xG assignment than simply predicting naive goal rate for shots after another shot!</p></li>
<li><p>A relatively “jagged” calibration plot may not correspond with a worse (lower) BSS score; and visa versa, a relatively “smooth” calibration plot may not correspond with a better (higher) BSS.</p>
<ul>
<li>Note that the <code>fouled</code> calibration looks jagged for higher predicted xG, but the fact that goals are only scored on about 5% shots immediately following a foul means that inprecise probabilities are not “penalized” quite as much. On the other hand, while the <code>pass_live</code> calibration looks relatively smooth, the 10% goal rate following live ball passes (2x the frequency for shots following fouls) means that it is more penalized for imprecision than an otherwise equivalent post-<code>fouled</code> shot. In fact, this is <a href="https://en.wikipedia.org/wiki/Brier_score#Shortcomings">one of the shortcomings of BSS</a>—it does not do a great job with evaluation of relatively infrequent events.</li>
</ul></li>
</ul>
<p>Next, let’s take a look at calibration of shots coming after deflections (of other shots).</p>
<div class="cell">

</div>
<p><img src="deflection_calibration.png" class="img-fluid"></p>
<ul>
<li>The model doesn’t seem to be very well calibrated for shots following deflections! Like shots following other shots in the shot-creating action calibration plot, the BSS for shots after deflections is negative. And, perhaps more interestingly, the model seems to underpredict post-deflection shots, which is the opposite of it’s general tendency to overpredict. (See the wholistic calibration plot from before.)
<ul>
<li>I’d suspect that there’s lots of confounders that might explain the lack of calibration after deflections. For one, it could be the case that there are often zero defenders between the shot-taker and keeper for shots following a deflection. As far as I know, the Opta model doesn’t have an explicit feature for this.</li>
<li>It might also be the case that Opta’s <a href="https://theanalyst.com/eu/2021/07/what-are-expected-goals-xg">“big chance” indicator</a>—which is not published on FBref but which I suspect take on a value of “yes”/1/true for many post-deflection shots—may have some flaws.</li>
<li>The high goal rate on shots after deflections relative to the goal rate on all other shots certainly contributes to the negative BSS, as we saw earlier with shots following other shots.</li>
</ul></li>
</ul>
<p>Moving on, let’s look at calibration of the xG model by groups of leagues, splitting out by tier and gender.</p>
<div class="cell">

</div>
<p><img src="league_group_calibration.png" class="img-fluid"></p>
<ul>
<li><a href="https://statsbomb.com/articles/soccer/analytics-and-modelling-in-womens-football/">StatsBomb has talked</a> about how a “gender-aware” model outperformed a baseline model, so one might expect the calibration of Opta’s singular model to be weaker for the women’s game. It turns out that while, yes, the calibration seems to be a bit worse for shots in the women’s leagues, the overall difference in model performance for men’s and women’s leagues seems to be trivial for the sample here.</li>
<li>Interestingly, the calibration of the model for non-Big 5 leagues and the English men’s Championship league are slightly better according to BSS, although the differences (both visually, with the calibration curve, and with BSS) are very minimal.</li>
</ul>
<p>Finally, let’s look at how footedness may play a role in model calibration. As far as I know, whether or not a footed shot is take by a player’s primary foot is not an input into the Opta model, so it may be particularly interesting to look at.</p>
<div class="cell">

</div>
<p><img src="footedness_calibration.png" class="img-fluid"></p>
<ul>
<li>Despite my suspicion that xG for shots taken by a player’s weaker foot (<code>right foot shot, left-footed</code> and <code>left foot shot, right-footed</code>) might be severely overpredicted, this doesn’t really seem to be the case. Yes, the model tends to overpredict for these kinds of shots, but the degree to which overprediction occurs doesn’t seem out of line with the whole model.
<ul>
<li>I can think of least two types of “selection bias” at play here that might explain why the calibration isn’t as bad as I might have guessed for weak-footed shots:
<ol type="1">
<li>Players are more likely to take weak-footed shots when they’re closer to the goal, where shots are likely to have higher xG, but also where shots are more likely to go in.</li>
<li>Players are less likely to take more difficult shots with their weak foot, so they’re not taking as many shots that are unlikely to go in, holding all else equal.</li>
</ol></li>
</ul></li>
<li>Of the non-footed shots, it’s interesting to see that the BSS for headers and shots from <code>other</code> body parts are not particularly well calibrated. In fact, the latter has a negative BSS, indicating that we’d better off with a model that predicted the average goal rate for such shots.
<ul>
<li>A high goal rate on such shots compared to other types of shots seems to, once again, be the reason that BSS looks particularly bad here.</li>
</ul></li>
</ul>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>We’ve explored the wonderful world of model calibration, making friends with BSS and calibration curves in our investigation of a public xG model. Are BSS and calibration curves the be-all and end-all when it comes to model evaluation? Of course not! But they’re useful tools that may or may not be appropriate for your use case.</p>
<p>When it comes to the Opta xG model specifically, am I implying that the model is bad? Of course not (again)! Yes, faceted calibration curves and feature-specific BSS can make a model look bad, but we must keep in mind that there are trade-offs to be made with modeling. Fine-tuning a model to be more well calibrated under certain conditions, e.g.&nbsp;shots after deflections, may make other parts of the model worse! It’s all about trade-offs.</p>



<!-- -->

</section>


<div class="quarto-listing quarto-listing-container-default" id="listing-listing">
<div class="list quarto-listing-default">

</div>
<div class="listing-no-matching d-none">
No matching items
</div>
</div><div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>It’s typically better to analyze expected goals after removing penalties since penalties can distort quantities, adding “noise” to an analysis.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>FBref/Opta didn’t specify how they changed their xG model. Given how I observed very only trivial differences in the shot-level xG for prior seasons, it’s possible that they didn’t even change their model! There could have been some data issue specific to the 2021/22 season, that, when addressed, resulted in more plausible xG.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>Observe that, for a large majority of shots, where xG is in the (0, 0.05] range, xG either did not change at all or only trivially changed. (See the blur of white points on the left-hand side of the plot.)<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>Several of these are not provided directly from the raw FBref tables. For example, <code>is_from_deflection</code> is derived from the <code>Notes</code> field in the FBref shot table. <code>is_primary_foot</code> is derived from collecting player footedness data and checking for a match with <code>body_part</code>.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>Note that I use the term “feature” here, although this set of fields does not quite match the actual <a href="https://theanalyst.com/eu/2021/07/what-are-expected-goals-xg">inputs to the</a> <a href="https://fbref.com/en/expected-goals-model-explained/">Opta xG model</a>. While things like <code>distance</code> and <code>body_part</code> certainly are inputs to the model, we don’t have angle of the shot to the goal, and <code>is_primary_foot</code>—a field that I’ve added the feature set myself—isn’t one of the model inputs, as far as I’m aware.<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6"><p>Several leagues don’t have data available for all such seasons, which is reflected in the number of shots per league in <code>np_shots</code>.<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn7"><p>I’ve written my own code to plot the calibration, but I imagine most users will be satisfied with the plot that <code>{probably}</code> will generate for you.<a href="#fnref7" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn8"><p>Brier score for a binary classification task is equivalent to mean squared error.<a href="#fnref8" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn9"><p>Personally, I like to use BSS over other classification metrics like <a href="https://en.wikipedia.org/wiki/Receiver_operating_characteristic">ROC AUC</a> or Brier score alone. BSS is arguably the most interpretable probabilistic classification measure. Also, I like that you have to specify a reference with which to compare, which seems like good principle in general.<a href="#fnref9" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn10"><p>I’m perhaps comparing apples to oranges here for the sake of providing some additional context that might help interpretability. The truth is that BSS is only comparable among different tasks to the extent that the reference choice in each task is “uninformed” to the same degree. For example, I could have said that the baseline for goals per shot is 50% instead of the actual goal rate (about 10%). This would change the baseline brier score to 0.25, and would inflate the BSS to 0.71. On the other hand, a 50/50 baseline makes sense in other settings. In fact, that’s what FiveThirtyEight uses for match outcome BSS for various sports.<a href="#fnref10" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb7" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> xG Model Calibration</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="an">description:</span><span class="co"> Evaluating Opta's xG model performance with Brier skill score (BSS) and calibration curves</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> 2023-02-20</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="an">date-modified:</span><span class="co"> 2023-02-24</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="an">categories:</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="co">  - r</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="co">  - soccer</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="an">image:</span><span class="co"> footedness_calibration.png</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span><span class="co"> </span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="co">  include: true</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="fu">## Introduction</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>Recently, <span class="co">[</span><span class="ot">I pointed out</span><span class="co">](https://twitter.com/TonyElHabr/status/1614288983105617922)</span> what seemed to be a bug with the <span class="co">[</span><span class="ot">expected goals (xG)</span><span class="co">](https://theanalyst.com/na/2021/07/what-are-expected-goals-xg/)</span> data shown on <span class="co">[</span><span class="ot">FBref</span><span class="co">](https://fbref.com)</span>. In particular, the difference between non-penalty goals (npG) and non-penalty xG (npxG)<span class="ot">[^1]</span> seemed to be an outlier for the 2021/22 season across <span class="co">[</span><span class="ot">the Big 5 leagues</span><span class="co">](https://fbref.com/en/comps/Big5/Big-5-European-Leagues-Stats)</span>.</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="ot">[^1]: </span>It's typically better to analyze expected goals after removing penalties since penalties can distort quantities, adding "noise" to an analysis.</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;blockquote</span> <span class="er">class</span><span class="ot">=</span><span class="st">"twitter-tweet"</span><span class="kw">&gt;</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;p</span> <span class="er">lang</span><span class="ot">=</span><span class="st">"en"</span> <span class="er">dir</span><span class="ot">=</span><span class="st">"ltr"</span><span class="kw">&gt;</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>"aLl xG mOdeLs ArE thE sAme"<span class="kw">&lt;br&gt;&lt;br&gt;</span>my brother in christ wut is this then <span class="kw">&lt;a</span> <span class="er">href</span><span class="ot">=</span><span class="st">"https://t.co/7tjp1VFkoc"</span><span class="kw">&gt;</span>pic.twitter.com/7tjp1VFkoc<span class="kw">&lt;/a&gt;</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/p&gt;</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>--- Tony (@TonyElHabr) <span class="kw">&lt;a</span> <span class="er">href</span><span class="ot">=</span><span class="st">"https://twitter.com/TonyElHabr/status/1614288983105617922?ref_src=twsrc%5Etfw"</span><span class="kw">&gt;</span>January 14, 2023<span class="kw">&lt;/a&gt;</span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/blockquote&gt;</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a><span class="in">```{=html}</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;script async src="https://platform.twitter.com/widgets.js" charset="utf-8"&gt;&lt;/script&gt;</span></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>As it turns out FBref and their data provider, <span class="co">[</span><span class="ot">Opta</span><span class="co">](https://www.statsperform.com/opta/)</span>, agreed! On Feb. 8, 2023, <span class="co">[</span><span class="ot">they posted an update</span><span class="co">](https://twitter.com/fbref/status/1623358271791722502?s=20)</span> indicating that they adjusted their 2021/22 xG such that the difference between npG and npxG is much more in line with other seasons.</span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>The FBref/Opta update gave me two ideas:</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>**Compare pre- and post-update xG** to identify where/how adjustments were applied. Where were the "blind spot(s)"?<span class="ot">[^2]</span></span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>**Quantify the [calibration](https://en.wikipedia.org/wiki/Calibration_(statistics)) of their xG model.** Are there obvious weak points with the model?</span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a><span class="ot">[^2]: </span>FBref/Opta didn't specify how they changed their xG model. Given how I observed very only trivial differences in the shot-level xG for prior seasons, it's possible that they didn't even change their model! There could have been some data issue specific to the 2021/22 season, that, when addressed, resulted in more plausible xG.</span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: data-pull</span></span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr) <span class="do">## 1.0.99.9000</span></span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)</span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(worldfootballR)</span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a>  <span class="st">'big5'</span> <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">country =</span> <span class="fu">c</span>(<span class="st">'ENG'</span>, <span class="st">'ESP'</span>, <span class="st">'FRA'</span>, <span class="st">'GER'</span>, <span class="st">'ITA'</span>),</span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">tier =</span> <span class="st">'1st'</span>,</span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">gender =</span> <span class="st">'M'</span></span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a>  <span class="st">'other_1st_M'</span> <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">country =</span> <span class="fu">c</span>(<span class="st">'POR'</span>, <span class="st">'NED'</span>, <span class="st">'BRA'</span>, <span class="st">'MEX'</span>, <span class="st">'USA'</span>),</span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">tier =</span> <span class="st">'1st'</span>,</span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">gender =</span> <span class="st">'M'</span></span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a>  <span class="st">'1st_F'</span> <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a>    <span class="do">## ESP only starts in season_end_year = 2023</span></span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a>    <span class="at">country =</span> <span class="fu">c</span>(<span class="st">'ENG'</span>, <span class="st">'USA'</span>),</span>
<span id="cb7-68"><a href="#cb7-68" aria-hidden="true" tabindex="-1"></a>    <span class="at">tier =</span> <span class="st">'1st'</span>,</span>
<span id="cb7-69"><a href="#cb7-69" aria-hidden="true" tabindex="-1"></a>    <span class="at">gender =</span> <span class="st">'F'</span></span>
<span id="cb7-70"><a href="#cb7-70" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb7-71"><a href="#cb7-71" aria-hidden="true" tabindex="-1"></a>  <span class="st">'2nd_M'</span> <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb7-72"><a href="#cb7-72" aria-hidden="true" tabindex="-1"></a>    <span class="at">country =</span> <span class="fu">c</span>(<span class="st">'ENG'</span>),</span>
<span id="cb7-73"><a href="#cb7-73" aria-hidden="true" tabindex="-1"></a>    <span class="at">tier =</span> <span class="st">'2nd'</span>,</span>
<span id="cb7-74"><a href="#cb7-74" aria-hidden="true" tabindex="-1"></a>    <span class="at">gender =</span> <span class="st">'M'</span></span>
<span id="cb7-75"><a href="#cb7-75" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb7-76"><a href="#cb7-76" aria-hidden="true" tabindex="-1"></a>  <span class="at">.id =</span> <span class="st">'group'</span></span>
<span id="cb7-77"><a href="#cb7-77" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-78"><a href="#cb7-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-79"><a href="#cb7-79" aria-hidden="true" tabindex="-1"></a>match_shooting <span class="ot">&lt;-</span> params <span class="sc">|&gt;</span> </span>
<span id="cb7-80"><a href="#cb7-80" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(group, tier, gender) <span class="sc">|&gt;</span> </span>
<span id="cb7-81"><a href="#cb7-81" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">countries =</span> <span class="fu">list</span>(country)) <span class="sc">|&gt;</span> </span>
<span id="cb7-82"><a href="#cb7-82" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> </span>
<span id="cb7-83"><a href="#cb7-83" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb7-84"><a href="#cb7-84" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">pmap</span>(</span>
<span id="cb7-85"><a href="#cb7-85" aria-hidden="true" tabindex="-1"></a>      <span class="fu">list</span>(</span>
<span id="cb7-86"><a href="#cb7-86" aria-hidden="true" tabindex="-1"></a>        countries,</span>
<span id="cb7-87"><a href="#cb7-87" aria-hidden="true" tabindex="-1"></a>        tier,</span>
<span id="cb7-88"><a href="#cb7-88" aria-hidden="true" tabindex="-1"></a>        gender,</span>
<span id="cb7-89"><a href="#cb7-89" aria-hidden="true" tabindex="-1"></a>        group</span>
<span id="cb7-90"><a href="#cb7-90" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb7-91"><a href="#cb7-91" aria-hidden="true" tabindex="-1"></a>      <span class="sc">~</span>{</span>
<span id="cb7-92"><a href="#cb7-92" aria-hidden="true" tabindex="-1"></a>        first_season_end_year <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(..<span class="dv">4</span> <span class="sc">==</span> <span class="st">'big5'</span>, 2018L, 2019L)</span>
<span id="cb7-93"><a href="#cb7-93" aria-hidden="true" tabindex="-1"></a>        res <span class="ot">&lt;-</span> <span class="fu">load_fb_match_shooting</span>(</span>
<span id="cb7-94"><a href="#cb7-94" aria-hidden="true" tabindex="-1"></a>          <span class="at">country =</span> ..<span class="dv">1</span>,</span>
<span id="cb7-95"><a href="#cb7-95" aria-hidden="true" tabindex="-1"></a>          <span class="at">tier =</span> ..<span class="dv">2</span>,</span>
<span id="cb7-96"><a href="#cb7-96" aria-hidden="true" tabindex="-1"></a>          <span class="at">gender =</span> ..<span class="dv">3</span>,</span>
<span id="cb7-97"><a href="#cb7-97" aria-hidden="true" tabindex="-1"></a>          <span class="at">season_end_year =</span> first_season_end_year<span class="sc">:</span>2022L</span>
<span id="cb7-98"><a href="#cb7-98" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb7-99"><a href="#cb7-99" aria-hidden="true" tabindex="-1"></a>        res<span class="sc">$</span>Tier <span class="ot">&lt;-</span> ..<span class="dv">2</span></span>
<span id="cb7-100"><a href="#cb7-100" aria-hidden="true" tabindex="-1"></a>        res</span>
<span id="cb7-101"><a href="#cb7-101" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb7-102"><a href="#cb7-102" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-103"><a href="#cb7-103" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb7-104"><a href="#cb7-104" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(group, data) <span class="sc">|&gt;</span> </span>
<span id="cb7-105"><a href="#cb7-105" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(data)</span>
<span id="cb7-106"><a href="#cb7-106" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb7-107"><a href="#cb7-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-110"><a href="#cb7-110" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb7-111"><a href="#cb7-111" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: data-clean</span></span>
<span id="cb7-112"><a href="#cb7-112" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb7-113"><a href="#cb7-113" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb7-114"><a href="#cb7-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-115"><a href="#cb7-115" aria-hidden="true" tabindex="-1"></a><span class="do">## https://github.com/tonyelhabr/sports_viz/blob/master/65-opta_xg_calib/1-pull-footedness.R</span></span>
<span id="cb7-116"><a href="#cb7-116" aria-hidden="true" tabindex="-1"></a>footedness <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(</span>
<span id="cb7-117"><a href="#cb7-117" aria-hidden="true" tabindex="-1"></a>  <span class="st">'https://raw.githubusercontent.com/tonyelhabr/sports_viz/master/65-opta_xg_calib/data/footedness.csv'</span></span>
<span id="cb7-118"><a href="#cb7-118" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-119"><a href="#cb7-119" aria-hidden="true" tabindex="-1"></a>unambiguous_footedness <span class="ot">&lt;-</span> footedness <span class="sc">|&gt;</span> </span>
<span id="cb7-120"><a href="#cb7-120" aria-hidden="true" tabindex="-1"></a>  <span class="fu">semi_join</span>(</span>
<span id="cb7-121"><a href="#cb7-121" aria-hidden="true" tabindex="-1"></a>    footedness <span class="sc">|&gt;</span> </span>
<span id="cb7-122"><a href="#cb7-122" aria-hidden="true" tabindex="-1"></a>      <span class="fu">count</span>(country, tier, gender, season_end_year, player, <span class="at">sort =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb7-123"><a href="#cb7-123" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(n <span class="sc">==</span> 1L),</span>
<span id="cb7-124"><a href="#cb7-124" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">join_by</span>(country, tier, gender, season_end_year, player)</span>
<span id="cb7-125"><a href="#cb7-125" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-126"><a href="#cb7-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-127"><a href="#cb7-127" aria-hidden="true" tabindex="-1"></a>clean_match_shooting <span class="ot">&lt;-</span> <span class="cf">function</span>(df) {</span>
<span id="cb7-128"><a href="#cb7-128" aria-hidden="true" tabindex="-1"></a>  df <span class="sc">|&gt;</span> </span>
<span id="cb7-129"><a href="#cb7-129" aria-hidden="true" tabindex="-1"></a>    <span class="fu">transmute</span>(</span>
<span id="cb7-130"><a href="#cb7-130" aria-hidden="true" tabindex="-1"></a>      <span class="at">match_url =</span> MatchURL,</span>
<span id="cb7-131"><a href="#cb7-131" aria-hidden="true" tabindex="-1"></a>      group,</span>
<span id="cb7-132"><a href="#cb7-132" aria-hidden="true" tabindex="-1"></a>      <span class="at">country =</span> Country,</span>
<span id="cb7-133"><a href="#cb7-133" aria-hidden="true" tabindex="-1"></a>      <span class="at">gender =</span> Gender,</span>
<span id="cb7-134"><a href="#cb7-134" aria-hidden="true" tabindex="-1"></a>      <span class="at">tier =</span> Tier,</span>
<span id="cb7-135"><a href="#cb7-135" aria-hidden="true" tabindex="-1"></a>      <span class="at">season_end_year =</span> Season_End_Year,</span>
<span id="cb7-136"><a href="#cb7-136" aria-hidden="true" tabindex="-1"></a>      <span class="at">date =</span> <span class="fu">ymd</span>(Date),</span>
<span id="cb7-137"><a href="#cb7-137" aria-hidden="true" tabindex="-1"></a>      <span class="at">half =</span> Match_Half,</span>
<span id="cb7-138"><a href="#cb7-138" aria-hidden="true" tabindex="-1"></a>      <span class="at">minute =</span> Minute,</span>
<span id="cb7-139"><a href="#cb7-139" aria-hidden="true" tabindex="-1"></a>      <span class="at">team =</span> Squad,</span>
<span id="cb7-140"><a href="#cb7-140" aria-hidden="true" tabindex="-1"></a>      <span class="at">player =</span> <span class="fu">str_remove</span>(Player, <span class="st">' </span><span class="sc">\\</span><span class="st">(.*$'</span>),</span>
<span id="cb7-141"><a href="#cb7-141" aria-hidden="true" tabindex="-1"></a>      <span class="at">xg =</span> <span class="fu">as.numeric</span>(xG),</span>
<span id="cb7-142"><a href="#cb7-142" aria-hidden="true" tabindex="-1"></a>      <span class="at">psxg =</span> <span class="fu">as.numeric</span>(PSxG),</span>
<span id="cb7-143"><a href="#cb7-143" aria-hidden="true" tabindex="-1"></a>      <span class="at">outcome =</span> Outcome,</span>
<span id="cb7-144"><a href="#cb7-144" aria-hidden="true" tabindex="-1"></a>      <span class="at">is_penalty =</span> <span class="fu">str_detect</span>(Player, <span class="st">'</span><span class="sc">\\</span><span class="st">(pen</span><span class="sc">\\</span><span class="st">)'</span>),</span>
<span id="cb7-145"><a href="#cb7-145" aria-hidden="true" tabindex="-1"></a>      <span class="at">is_goal =</span> <span class="fu">factor</span>(<span class="fu">ifelse</span>(outcome <span class="sc">==</span> <span class="st">'Goal'</span>, <span class="st">'yes'</span>, <span class="st">'no'</span>)),</span>
<span id="cb7-146"><a href="#cb7-146" aria-hidden="true" tabindex="-1"></a>      <span class="at">distance =</span> <span class="fu">as.integer</span>(Distance),</span>
<span id="cb7-147"><a href="#cb7-147" aria-hidden="true" tabindex="-1"></a>      <span class="at">body_part =</span> <span class="st">`</span><span class="at">Body Part</span><span class="st">`</span>,</span>
<span id="cb7-148"><a href="#cb7-148" aria-hidden="true" tabindex="-1"></a>      <span class="at">notes =</span> Notes,</span>
<span id="cb7-149"><a href="#cb7-149" aria-hidden="true" tabindex="-1"></a>      <span class="do">## seems that they started to exclusively use Take-On instead of Dribble in 2022</span></span>
<span id="cb7-150"><a href="#cb7-150" aria-hidden="true" tabindex="-1"></a>      <span class="at">sca1 =</span> <span class="fu">ifelse</span>(Event_SCA_1 <span class="sc">==</span> <span class="st">'Dribble'</span>, <span class="st">'Take-On'</span>, Event_SCA_1),</span>
<span id="cb7-151"><a href="#cb7-151" aria-hidden="true" tabindex="-1"></a>      <span class="at">sca2 =</span> <span class="fu">ifelse</span>(Event_SCA_2 <span class="sc">==</span> <span class="st">'Dribble'</span>, <span class="st">'Take-On'</span>, Event_SCA_2)</span>
<span id="cb7-152"><a href="#cb7-152" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb7-153"><a href="#cb7-153" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(</span>
<span id="cb7-154"><a href="#cb7-154" aria-hidden="true" tabindex="-1"></a>      unambiguous_footedness <span class="sc">|&gt;</span> </span>
<span id="cb7-155"><a href="#cb7-155" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(</span>
<span id="cb7-156"><a href="#cb7-156" aria-hidden="true" tabindex="-1"></a>          country,</span>
<span id="cb7-157"><a href="#cb7-157" aria-hidden="true" tabindex="-1"></a>          tier,</span>
<span id="cb7-158"><a href="#cb7-158" aria-hidden="true" tabindex="-1"></a>          gender,</span>
<span id="cb7-159"><a href="#cb7-159" aria-hidden="true" tabindex="-1"></a>          season_end_year,</span>
<span id="cb7-160"><a href="#cb7-160" aria-hidden="true" tabindex="-1"></a>          player, </span>
<span id="cb7-161"><a href="#cb7-161" aria-hidden="true" tabindex="-1"></a>          <span class="at">primary_foot =</span> foot</span>
<span id="cb7-162"><a href="#cb7-162" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb7-163"><a href="#cb7-163" aria-hidden="true" tabindex="-1"></a>      <span class="at">multiple =</span> <span class="st">'all'</span>,</span>
<span id="cb7-164"><a href="#cb7-164" aria-hidden="true" tabindex="-1"></a>      <span class="at">by =</span> <span class="fu">join_by</span>(</span>
<span id="cb7-165"><a href="#cb7-165" aria-hidden="true" tabindex="-1"></a>        country, </span>
<span id="cb7-166"><a href="#cb7-166" aria-hidden="true" tabindex="-1"></a>        tier, gender, </span>
<span id="cb7-167"><a href="#cb7-167" aria-hidden="true" tabindex="-1"></a>        season_end_year, </span>
<span id="cb7-168"><a href="#cb7-168" aria-hidden="true" tabindex="-1"></a>        player</span>
<span id="cb7-169"><a href="#cb7-169" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb7-170"><a href="#cb7-170" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb7-171"><a href="#cb7-171" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb7-172"><a href="#cb7-172" aria-hidden="true" tabindex="-1"></a>      <span class="at">is_true_open_play =</span> notes <span class="sc">==</span> <span class="st">''</span> <span class="sc">&amp;</span> <span class="sc">!</span>is_penalty,</span>
<span id="cb7-173"><a href="#cb7-173" aria-hidden="true" tabindex="-1"></a>      <span class="at">is_from_deflection =</span> <span class="fu">str_detect</span>(notes, <span class="st">'Deflected'</span>),</span>
<span id="cb7-174"><a href="#cb7-174" aria-hidden="true" tabindex="-1"></a>      <span class="at">is_from_volley =</span> <span class="fu">str_detect</span>(notes, <span class="st">'Volley'</span>),</span>
<span id="cb7-175"><a href="#cb7-175" aria-hidden="true" tabindex="-1"></a>      <span class="at">is_free_kick =</span> notes <span class="sc">==</span> <span class="st">'Free kick'</span>,</span>
<span id="cb7-176"><a href="#cb7-176" aria-hidden="true" tabindex="-1"></a>      <span class="at">is_open_play =</span> <span class="sc">!</span>is_free_kick <span class="sc">&amp;</span> <span class="sc">!</span>is_penalty,</span>
<span id="cb7-177"><a href="#cb7-177" aria-hidden="true" tabindex="-1"></a>      <span class="at">is_primary_foot =</span> <span class="fu">case_when</span>(</span>
<span id="cb7-178"><a href="#cb7-178" aria-hidden="true" tabindex="-1"></a>        <span class="fu">is.na</span>(body_part) <span class="sc">~</span> <span class="cn">NA</span>,</span>
<span id="cb7-179"><a href="#cb7-179" aria-hidden="true" tabindex="-1"></a>        <span class="fu">is.na</span>(primary_foot) <span class="sc">~</span> <span class="cn">NA</span>,</span>
<span id="cb7-180"><a href="#cb7-180" aria-hidden="true" tabindex="-1"></a>        <span class="sc">!</span>(body_part <span class="sc">%in%</span> <span class="fu">sprintf</span>(<span class="st">'%s Foot'</span>, <span class="fu">c</span>(<span class="st">'Left'</span>, <span class="st">'Right'</span>))) <span class="sc">~</span> <span class="cn">NA</span>,</span>
<span id="cb7-181"><a href="#cb7-181" aria-hidden="true" tabindex="-1"></a>        primary_foot <span class="sc">==</span> <span class="fu">tolower</span>(<span class="fu">str_remove</span>(body_part, <span class="st">' Foot'</span>)) <span class="sc">~</span> <span class="cn">TRUE</span>,</span>
<span id="cb7-182"><a href="#cb7-182" aria-hidden="true" tabindex="-1"></a>        <span class="at">.default =</span> <span class="cn">FALSE</span></span>
<span id="cb7-183"><a href="#cb7-183" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb7-184"><a href="#cb7-184" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-185"><a href="#cb7-185" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-186"><a href="#cb7-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-187"><a href="#cb7-187" aria-hidden="true" tabindex="-1"></a>shots <span class="ot">&lt;-</span> <span class="fu">clean_match_shooting</span>(match_shooting)</span>
<span id="cb7-188"><a href="#cb7-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-189"><a href="#cb7-189" aria-hidden="true" tabindex="-1"></a>pull_old_fb_match_shooting <span class="ot">&lt;-</span> <span class="cf">function</span>(country, gender, tier) {</span>
<span id="cb7-190"><a href="#cb7-190" aria-hidden="true" tabindex="-1"></a>  url <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(</span>
<span id="cb7-191"><a href="#cb7-191" aria-hidden="true" tabindex="-1"></a>    <span class="st">'https://github.com/JaseZiv/worldfootballR_data/releases/download/old_fb_match_shooting/%s_%s_%s_match_shooting.rds'</span>, </span>
<span id="cb7-192"><a href="#cb7-192" aria-hidden="true" tabindex="-1"></a>    country,</span>
<span id="cb7-193"><a href="#cb7-193" aria-hidden="true" tabindex="-1"></a>    gender,</span>
<span id="cb7-194"><a href="#cb7-194" aria-hidden="true" tabindex="-1"></a>    tier</span>
<span id="cb7-195"><a href="#cb7-195" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-196"><a href="#cb7-196" aria-hidden="true" tabindex="-1"></a>  <span class="fu">readRDS</span>(<span class="fu">url</span>(url))</span>
<span id="cb7-197"><a href="#cb7-197" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-198"><a href="#cb7-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-199"><a href="#cb7-199" aria-hidden="true" tabindex="-1"></a>old_fb_match_shooting <span class="ot">&lt;-</span> params <span class="sc">|&gt;</span> </span>
<span id="cb7-200"><a href="#cb7-200" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(group <span class="sc">==</span> <span class="st">'big5'</span>) <span class="sc">|&gt;</span> </span>
<span id="cb7-201"><a href="#cb7-201" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb7-202"><a href="#cb7-202" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">pmap</span>(</span>
<span id="cb7-203"><a href="#cb7-203" aria-hidden="true" tabindex="-1"></a>      <span class="fu">list</span>(</span>
<span id="cb7-204"><a href="#cb7-204" aria-hidden="true" tabindex="-1"></a>        country,</span>
<span id="cb7-205"><a href="#cb7-205" aria-hidden="true" tabindex="-1"></a>        gender,</span>
<span id="cb7-206"><a href="#cb7-206" aria-hidden="true" tabindex="-1"></a>        tier</span>
<span id="cb7-207"><a href="#cb7-207" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb7-208"><a href="#cb7-208" aria-hidden="true" tabindex="-1"></a>      pull_old_fb_match_shooting</span>
<span id="cb7-209"><a href="#cb7-209" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-210"><a href="#cb7-210" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb7-211"><a href="#cb7-211" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(data)</span>
<span id="cb7-212"><a href="#cb7-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-213"><a href="#cb7-213" aria-hidden="true" tabindex="-1"></a>updated_shots <span class="ot">&lt;-</span> <span class="fu">inner_join</span>(</span>
<span id="cb7-214"><a href="#cb7-214" aria-hidden="true" tabindex="-1"></a>  shots <span class="sc">|&gt;</span> </span>
<span id="cb7-215"><a href="#cb7-215" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(group <span class="sc">==</span> <span class="st">'big5'</span>, season_end_year <span class="sc">==</span> <span class="dv">2022</span>) <span class="sc">|&gt;</span> </span>
<span id="cb7-216"><a href="#cb7-216" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">new_xg =</span> xg),</span>
<span id="cb7-217"><a href="#cb7-217" aria-hidden="true" tabindex="-1"></a>  old_fb_match_shooting <span class="sc">|&gt;</span> </span>
<span id="cb7-218"><a href="#cb7-218" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Season_End_Year <span class="sc">==</span> <span class="dv">2022</span>) <span class="sc">|&gt;</span> </span>
<span id="cb7-219"><a href="#cb7-219" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(</span>
<span id="cb7-220"><a href="#cb7-220" aria-hidden="true" tabindex="-1"></a>      <span class="at">Tier =</span> tier</span>
<span id="cb7-221"><a href="#cb7-221" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb7-222"><a href="#cb7-222" aria-hidden="true" tabindex="-1"></a>    <span class="fu">clean_match_shooting</span>() <span class="sc">|&gt;</span> </span>
<span id="cb7-223"><a href="#cb7-223" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(</span>
<span id="cb7-224"><a href="#cb7-224" aria-hidden="true" tabindex="-1"></a>      match_url, </span>
<span id="cb7-225"><a href="#cb7-225" aria-hidden="true" tabindex="-1"></a>      half,</span>
<span id="cb7-226"><a href="#cb7-226" aria-hidden="true" tabindex="-1"></a>      minute,</span>
<span id="cb7-227"><a href="#cb7-227" aria-hidden="true" tabindex="-1"></a>      team,</span>
<span id="cb7-228"><a href="#cb7-228" aria-hidden="true" tabindex="-1"></a>      player,</span>
<span id="cb7-229"><a href="#cb7-229" aria-hidden="true" tabindex="-1"></a>      <span class="at">old_xg =</span> xg</span>
<span id="cb7-230"><a href="#cb7-230" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb7-231"><a href="#cb7-231" aria-hidden="true" tabindex="-1"></a>  <span class="at">by =</span> <span class="fu">join_by</span>(match_url, half, minute, team, player),</span>
<span id="cb7-232"><a href="#cb7-232" aria-hidden="true" tabindex="-1"></a>  <span class="at">multiple =</span> <span class="st">'first'</span></span>
<span id="cb7-233"><a href="#cb7-233" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb7-234"><a href="#cb7-234" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(old_xg, <span class="at">.before =</span> new_xg)</span>
<span id="cb7-235"><a href="#cb7-235" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb7-236"><a href="#cb7-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-237"><a href="#cb7-237" aria-hidden="true" tabindex="-1"></a><span class="fu">## 1. Pre- and post-update xG comparison</span></span>
<span id="cb7-238"><a href="#cb7-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-241"><a href="#cb7-241" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb7-242"><a href="#cb7-242" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: updated_np_shots</span></span>
<span id="cb7-243"><a href="#cb7-243" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb7-244"><a href="#cb7-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-245"><a href="#cb7-245" aria-hidden="true" tabindex="-1"></a>updated_np_shots <span class="ot">&lt;-</span> <span class="fu">read_rds</span>(<span class="st">'../sports_viz/65-opta_xg_calib/data/clean_updated_shots.rds'</span>) <span class="sc">|&gt;</span> </span>
<span id="cb7-246"><a href="#cb7-246" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>is_penalty) <span class="sc">|&gt;</span> </span>
<span id="cb7-247"><a href="#cb7-247" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">league =</span> country)</span>
<span id="cb7-248"><a href="#cb7-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-249"><a href="#cb7-249" aria-hidden="true" tabindex="-1"></a>compare_by <span class="ot">&lt;-</span> <span class="cf">function</span>(shots, ...) {</span>
<span id="cb7-250"><a href="#cb7-250" aria-hidden="true" tabindex="-1"></a>  shots <span class="sc">|&gt;</span> </span>
<span id="cb7-251"><a href="#cb7-251" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(...) <span class="sc">|&gt;</span> </span>
<span id="cb7-252"><a href="#cb7-252" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(</span>
<span id="cb7-253"><a href="#cb7-253" aria-hidden="true" tabindex="-1"></a>      <span class="at">n_shots =</span> <span class="fu">n</span>(),</span>
<span id="cb7-254"><a href="#cb7-254" aria-hidden="true" tabindex="-1"></a>      <span class="at">n_same_npxg =</span> <span class="fu">sum</span>(<span class="fu">round</span>(old_xg, <span class="dv">2</span>) <span class="sc">==</span> <span class="fu">round</span>(new_xg, <span class="dv">2</span>), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb7-255"><a href="#cb7-255" aria-hidden="true" tabindex="-1"></a>      <span class="at">n_old_npxg_is_higher =</span> <span class="fu">sum</span>(<span class="fu">round</span>(old_xg, <span class="dv">2</span>) <span class="sc">&gt;</span> <span class="fu">round</span>(new_xg, <span class="dv">2</span>), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb7-256"><a href="#cb7-256" aria-hidden="true" tabindex="-1"></a>      <span class="at">new_npxg =</span> <span class="fu">sum</span>(new_xg, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb7-257"><a href="#cb7-257" aria-hidden="true" tabindex="-1"></a>      <span class="at">old_npxg =</span> <span class="fu">sum</span>(old_xg, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-258"><a href="#cb7-258" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb7-259"><a href="#cb7-259" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> </span>
<span id="cb7-260"><a href="#cb7-260" aria-hidden="true" tabindex="-1"></a>    <span class="fu">transmute</span>(</span>
<span id="cb7-261"><a href="#cb7-261" aria-hidden="true" tabindex="-1"></a>      ...,</span>
<span id="cb7-262"><a href="#cb7-262" aria-hidden="true" tabindex="-1"></a>      n_shots,</span>
<span id="cb7-263"><a href="#cb7-263" aria-hidden="true" tabindex="-1"></a>      n_same_npxg,</span>
<span id="cb7-264"><a href="#cb7-264" aria-hidden="true" tabindex="-1"></a>      <span class="at">n_diff_npxg =</span> n_shots <span class="sc">-</span> n_same_npxg,</span>
<span id="cb7-265"><a href="#cb7-265" aria-hidden="true" tabindex="-1"></a>      n_old_npxg_is_higher,</span>
<span id="cb7-266"><a href="#cb7-266" aria-hidden="true" tabindex="-1"></a>      <span class="at">n_new_npxg_is_higher =</span> n_diff_npxg <span class="sc">-</span> n_old_npxg_is_higher,</span>
<span id="cb7-267"><a href="#cb7-267" aria-hidden="true" tabindex="-1"></a>      <span class="at">prop_diff_npxg =</span> n_diff_npxg <span class="sc">/</span> n_shots,</span>
<span id="cb7-268"><a href="#cb7-268" aria-hidden="true" tabindex="-1"></a>      <span class="at">prop_old_npxg_is_higher =</span> n_old_npxg_is_higher <span class="sc">/</span> n_diff_npxg</span>
<span id="cb7-269"><a href="#cb7-269" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb7-270"><a href="#cb7-270" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(<span class="fu">desc</span>(n_shots))</span>
<span id="cb7-271"><a href="#cb7-271" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-272"><a href="#cb7-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-273"><a href="#cb7-273" aria-hidden="true" tabindex="-1"></a>updated_np_shots <span class="sc">|&gt;</span></span>
<span id="cb7-274"><a href="#cb7-274" aria-hidden="true" tabindex="-1"></a>  <span class="fu">compare_by</span>() <span class="sc">|&gt;</span> </span>
<span id="cb7-275"><a href="#cb7-275" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glimpse</span>()</span>
<span id="cb7-276"><a href="#cb7-276" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Rows: 1</span></span>
<span id="cb7-277"><a href="#cb7-277" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Columns: 7</span></span>
<span id="cb7-278"><a href="#cb7-278" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; $ n_shots                 &lt;int&gt; 44986</span></span>
<span id="cb7-279"><a href="#cb7-279" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; $ n_same_npxg             &lt;int&gt; 14750</span></span>
<span id="cb7-280"><a href="#cb7-280" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; $ n_diff_npxg             &lt;int&gt; 30236</span></span>
<span id="cb7-281"><a href="#cb7-281" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; $ n_old_npxg_is_higher    &lt;int&gt; 23584</span></span>
<span id="cb7-282"><a href="#cb7-282" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; $ n_new_npxg_is_higher    &lt;int&gt; 6652</span></span>
<span id="cb7-283"><a href="#cb7-283" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; $ prop_diff_npxg          &lt;dbl&gt; 0.6721202</span></span>
<span id="cb7-284"><a href="#cb7-284" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; $ prop_old_npxg_is_higher &lt;dbl&gt; 0.7799974</span></span>
<span id="cb7-285"><a href="#cb7-285" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; $ prop_old_npxg_is_higher  &lt;dbl&gt; 0.7799974</span></span>
<span id="cb7-286"><a href="#cb7-286" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb7-287"><a href="#cb7-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-290"><a href="#cb7-290" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb7-291"><a href="#cb7-291" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: discretized_updated_shots</span></span>
<span id="cb7-292"><a href="#cb7-292" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(forcats)</span>
<span id="cb7-293"><a href="#cb7-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-294"><a href="#cb7-294" aria-hidden="true" tabindex="-1"></a>discretize_cols <span class="ot">&lt;-</span> <span class="cf">function</span>(shots) {</span>
<span id="cb7-295"><a href="#cb7-295" aria-hidden="true" tabindex="-1"></a>  shots <span class="sc">|&gt;</span> </span>
<span id="cb7-296"><a href="#cb7-296" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(</span>
<span id="cb7-297"><a href="#cb7-297" aria-hidden="true" tabindex="-1"></a>      league,</span>
<span id="cb7-298"><a href="#cb7-298" aria-hidden="true" tabindex="-1"></a>      date,</span>
<span id="cb7-299"><a href="#cb7-299" aria-hidden="true" tabindex="-1"></a>      half,</span>
<span id="cb7-300"><a href="#cb7-300" aria-hidden="true" tabindex="-1"></a>      minute,</span>
<span id="cb7-301"><a href="#cb7-301" aria-hidden="true" tabindex="-1"></a>      team,</span>
<span id="cb7-302"><a href="#cb7-302" aria-hidden="true" tabindex="-1"></a>      player,</span>
<span id="cb7-303"><a href="#cb7-303" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb7-304"><a href="#cb7-304" aria-hidden="true" tabindex="-1"></a>      <span class="fu">matches</span>(<span class="st">'^xg$|^(old|new)_xg$'</span>),</span>
<span id="cb7-305"><a href="#cb7-305" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb7-306"><a href="#cb7-306" aria-hidden="true" tabindex="-1"></a>      is_goal,</span>
<span id="cb7-307"><a href="#cb7-307" aria-hidden="true" tabindex="-1"></a>      distance,</span>
<span id="cb7-308"><a href="#cb7-308" aria-hidden="true" tabindex="-1"></a>      sca1,</span>
<span id="cb7-309"><a href="#cb7-309" aria-hidden="true" tabindex="-1"></a>      body_part,</span>
<span id="cb7-310"><a href="#cb7-310" aria-hidden="true" tabindex="-1"></a>      is_from_deflection,</span>
<span id="cb7-311"><a href="#cb7-311" aria-hidden="true" tabindex="-1"></a>      is_from_volley,</span>
<span id="cb7-312"><a href="#cb7-312" aria-hidden="true" tabindex="-1"></a>      is_free_kick,</span>
<span id="cb7-313"><a href="#cb7-313" aria-hidden="true" tabindex="-1"></a>      is_open_play,</span>
<span id="cb7-314"><a href="#cb7-314" aria-hidden="true" tabindex="-1"></a>      is_primary_foot</span>
<span id="cb7-315"><a href="#cb7-315" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb7-316"><a href="#cb7-316" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb7-317"><a href="#cb7-317" aria-hidden="true" tabindex="-1"></a>      <span class="fu">across</span>(</span>
<span id="cb7-318"><a href="#cb7-318" aria-hidden="true" tabindex="-1"></a>        league,</span>
<span id="cb7-319"><a href="#cb7-319" aria-hidden="true" tabindex="-1"></a>        factor</span>
<span id="cb7-320"><a href="#cb7-320" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb7-321"><a href="#cb7-321" aria-hidden="true" tabindex="-1"></a>      <span class="fu">across</span>(</span>
<span id="cb7-322"><a href="#cb7-322" aria-hidden="true" tabindex="-1"></a>        distance,</span>
<span id="cb7-323"><a href="#cb7-323" aria-hidden="true" tabindex="-1"></a>        <span class="sc">~</span><span class="fu">cut</span>(</span>
<span id="cb7-324"><a href="#cb7-324" aria-hidden="true" tabindex="-1"></a>          .x,</span>
<span id="cb7-325"><a href="#cb7-325" aria-hidden="true" tabindex="-1"></a>          <span class="at">breaks =</span> <span class="fu">c</span>(<span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">18</span>, <span class="at">by =</span> <span class="dv">2</span>), <span class="dv">20</span>, <span class="dv">25</span>, <span class="dv">30</span>, <span class="dv">35</span>, <span class="cn">Inf</span>)</span>
<span id="cb7-326"><a href="#cb7-326" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb7-327"><a href="#cb7-327" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb7-328"><a href="#cb7-328" aria-hidden="true" tabindex="-1"></a>      <span class="fu">across</span>(sca1, <span class="sc">~</span><span class="fu">na_if</span>(.x, <span class="st">''</span>)),</span>
<span id="cb7-329"><a href="#cb7-329" aria-hidden="true" tabindex="-1"></a>      <span class="fu">across</span>(</span>
<span id="cb7-330"><a href="#cb7-330" aria-hidden="true" tabindex="-1"></a>        sca1, </span>
<span id="cb7-331"><a href="#cb7-331" aria-hidden="true" tabindex="-1"></a>        <span class="sc">~</span>.x <span class="sc">|&gt;</span> </span>
<span id="cb7-332"><a href="#cb7-332" aria-hidden="true" tabindex="-1"></a>          <span class="fu">str_remove_all</span>( <span class="st">'</span><span class="sc">\\</span><span class="st">(|</span><span class="sc">\\</span><span class="st">)'</span>) <span class="sc">|&gt;</span> </span>
<span id="cb7-333"><a href="#cb7-333" aria-hidden="true" tabindex="-1"></a>          <span class="fu">str_replace_all</span>(<span class="st">'</span><span class="sc">\\</span><span class="st">s|[-]'</span>, <span class="st">'_'</span>) <span class="sc">|&gt;</span> </span>
<span id="cb7-334"><a href="#cb7-334" aria-hidden="true" tabindex="-1"></a>          <span class="fu">tolower</span>() <span class="sc">|&gt;</span> </span>
<span id="cb7-335"><a href="#cb7-335" aria-hidden="true" tabindex="-1"></a>          <span class="fu">factor</span>()</span>
<span id="cb7-336"><a href="#cb7-336" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb7-337"><a href="#cb7-337" aria-hidden="true" tabindex="-1"></a>      <span class="fu">across</span>(</span>
<span id="cb7-338"><a href="#cb7-338" aria-hidden="true" tabindex="-1"></a>        <span class="fu">c</span>(</span>
<span id="cb7-339"><a href="#cb7-339" aria-hidden="true" tabindex="-1"></a>          is_from_deflection,</span>
<span id="cb7-340"><a href="#cb7-340" aria-hidden="true" tabindex="-1"></a>          is_from_volley,</span>
<span id="cb7-341"><a href="#cb7-341" aria-hidden="true" tabindex="-1"></a>          is_free_kick,</span>
<span id="cb7-342"><a href="#cb7-342" aria-hidden="true" tabindex="-1"></a>          is_open_play,</span>
<span id="cb7-343"><a href="#cb7-343" aria-hidden="true" tabindex="-1"></a>          is_primary_foot</span>
<span id="cb7-344"><a href="#cb7-344" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb7-345"><a href="#cb7-345" aria-hidden="true" tabindex="-1"></a>        <span class="sc">~</span><span class="fu">ifelse</span>(.x, <span class="st">'yes'</span>, <span class="st">'no'</span>) <span class="sc">|&gt;</span> </span>
<span id="cb7-346"><a href="#cb7-346" aria-hidden="true" tabindex="-1"></a>          <span class="fu">factor</span>()</span>
<span id="cb7-347"><a href="#cb7-347" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb7-348"><a href="#cb7-348" aria-hidden="true" tabindex="-1"></a>      <span class="fu">across</span>(</span>
<span id="cb7-349"><a href="#cb7-349" aria-hidden="true" tabindex="-1"></a>        <span class="fu">c</span>(</span>
<span id="cb7-350"><a href="#cb7-350" aria-hidden="true" tabindex="-1"></a>          is_primary_foot,</span>
<span id="cb7-351"><a href="#cb7-351" aria-hidden="true" tabindex="-1"></a>          body_part, </span>
<span id="cb7-352"><a href="#cb7-352" aria-hidden="true" tabindex="-1"></a>          sca1,</span>
<span id="cb7-353"><a href="#cb7-353" aria-hidden="true" tabindex="-1"></a>          distance</span>
<span id="cb7-354"><a href="#cb7-354" aria-hidden="true" tabindex="-1"></a>        ), </span>
<span id="cb7-355"><a href="#cb7-355" aria-hidden="true" tabindex="-1"></a>        <span class="sc">~</span><span class="fu">fct_explicit_na</span>(.x, <span class="at">na_level =</span> <span class="st">'missing'</span>)</span>
<span id="cb7-356"><a href="#cb7-356" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb7-357"><a href="#cb7-357" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-358"><a href="#cb7-358" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-359"><a href="#cb7-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-360"><a href="#cb7-360" aria-hidden="true" tabindex="-1"></a>discretized_updated_np_shots <span class="ot">&lt;-</span> <span class="fu">discretize_cols</span>(updated_np_shots)</span>
<span id="cb7-361"><a href="#cb7-361" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb7-362"><a href="#cb7-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-363"><a href="#cb7-363" aria-hidden="true" tabindex="-1"></a>First, let's take a wholistic look at all of the shots for the 2021/22 seasons played in Big 5 leagues.</span>
<span id="cb7-364"><a href="#cb7-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-367"><a href="#cb7-367" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb7-368"><a href="#cb7-368" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: post-update-xgd</span></span>
<span id="cb7-369"><a href="#cb7-369" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb7-370"><a href="#cb7-370" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sysfonts)</span>
<span id="cb7-371"><a href="#cb7-371" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(showtext)</span>
<span id="cb7-372"><a href="#cb7-372" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggtext)</span>
<span id="cb7-373"><a href="#cb7-373" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggforce)</span>
<span id="cb7-374"><a href="#cb7-374" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ragg)</span>
<span id="cb7-375"><a href="#cb7-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-376"><a href="#cb7-376" aria-hidden="true" tabindex="-1"></a>font <span class="ot">&lt;-</span> <span class="st">'Titillium Web'</span></span>
<span id="cb7-377"><a href="#cb7-377" aria-hidden="true" tabindex="-1"></a>sysfonts<span class="sc">::</span><span class="fu">font_add_google</span>(font, font)</span>
<span id="cb7-378"><a href="#cb7-378" aria-hidden="true" tabindex="-1"></a><span class="do">## https://github.com/tashapiro/tanya-data-viz/blob/main/chatgpt-lensa/chatgpt-lensa.R for twitter logo</span></span>
<span id="cb7-379"><a href="#cb7-379" aria-hidden="true" tabindex="-1"></a>sysfonts<span class="sc">::</span><span class="fu">font_add</span>(<span class="st">'fb'</span>, <span class="st">'Font Awesome 6 Brands-Regular-400.otf'</span>)</span>
<span id="cb7-380"><a href="#cb7-380" aria-hidden="true" tabindex="-1"></a>showtext<span class="sc">::</span><span class="fu">showtext_auto</span>()</span>
<span id="cb7-381"><a href="#cb7-381" aria-hidden="true" tabindex="-1"></a>showtext<span class="sc">::</span><span class="fu">showtext_opts</span>(<span class="at">dpi =</span> <span class="dv">300</span>)</span>
<span id="cb7-382"><a href="#cb7-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-383"><a href="#cb7-383" aria-hidden="true" tabindex="-1"></a>blackish_background <span class="ot">&lt;-</span> <span class="st">'#1c1c1c'</span></span>
<span id="cb7-384"><a href="#cb7-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-385"><a href="#cb7-385" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_minimal</span>())</span>
<span id="cb7-386"><a href="#cb7-386" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_update</span>(</span>
<span id="cb7-387"><a href="#cb7-387" aria-hidden="true" tabindex="-1"></a>  <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">family =</span> font),</span>
<span id="cb7-388"><a href="#cb7-388" aria-hidden="true" tabindex="-1"></a>  <span class="at">title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>, <span class="at">color =</span> <span class="st">'white'</span>),</span>
<span id="cb7-389"><a href="#cb7-389" aria-hidden="true" tabindex="-1"></a>  <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">'bold'</span>, <span class="at">size =</span> <span class="dv">20</span>, <span class="at">color =</span> <span class="st">'white'</span>),</span>
<span id="cb7-390"><a href="#cb7-390" aria-hidden="true" tabindex="-1"></a>  <span class="at">plot.title.position =</span> <span class="st">'plot'</span>,</span>
<span id="cb7-391"><a href="#cb7-391" aria-hidden="true" tabindex="-1"></a>  <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">16</span>, <span class="at">color =</span> <span class="st">'#f1f1f1'</span>),</span>
<span id="cb7-392"><a href="#cb7-392" aria-hidden="true" tabindex="-1"></a>  <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">'white'</span>, <span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb7-393"><a href="#cb7-393" aria-hidden="true" tabindex="-1"></a>  <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">color =</span> <span class="st">'white'</span>, <span class="at">face =</span> <span class="st">'bold'</span>, <span class="at">hjust =</span> <span class="fl">0.99</span>),</span>
<span id="cb7-394"><a href="#cb7-394" aria-hidden="true" tabindex="-1"></a>  <span class="at">axis.line =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb7-395"><a href="#cb7-395" aria-hidden="true" tabindex="-1"></a>  <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">color =</span> <span class="st">'white'</span>, <span class="at">face =</span> <span class="st">'bold'</span>, <span class="at">hjust =</span> <span class="dv">0</span>),</span>
<span id="cb7-396"><a href="#cb7-396" aria-hidden="true" tabindex="-1"></a>  <span class="at">panel.grid.major =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">'#4d4d4d'</span>),</span>
<span id="cb7-397"><a href="#cb7-397" aria-hidden="true" tabindex="-1"></a>  <span class="at">panel.grid.minor =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">'#4d4d4d'</span>),</span>
<span id="cb7-398"><a href="#cb7-398" aria-hidden="true" tabindex="-1"></a>  <span class="at">panel.grid.minor.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb7-399"><a href="#cb7-399" aria-hidden="true" tabindex="-1"></a>  <span class="at">panel.grid.minor.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb7-400"><a href="#cb7-400" aria-hidden="true" tabindex="-1"></a>  <span class="at">plot.margin =</span> <span class="fu">margin</span>(<span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">10</span>, <span class="dv">20</span>),</span>
<span id="cb7-401"><a href="#cb7-401" aria-hidden="true" tabindex="-1"></a>  <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> blackish_background, <span class="at">color =</span> <span class="st">'#1c1c1c'</span>),</span>
<span id="cb7-402"><a href="#cb7-402" aria-hidden="true" tabindex="-1"></a>  <span class="at">plot.caption =</span> <span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">'white'</span>, <span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">size =</span> <span class="dv">12</span>, <span class="at">face =</span> <span class="st">'plain'</span>),</span>
<span id="cb7-403"><a href="#cb7-403" aria-hidden="true" tabindex="-1"></a>  <span class="at">plot.caption.position =</span> <span class="st">'plot'</span>,</span>
<span id="cb7-404"><a href="#cb7-404" aria-hidden="true" tabindex="-1"></a>  <span class="at">plot.tag =</span> ggtext<span class="sc">::</span><span class="fu">element_markdown</span>(<span class="at">size =</span> <span class="dv">12</span>, <span class="at">color =</span> <span class="st">'white'</span>, <span class="at">hjust =</span> <span class="dv">1</span>),</span>
<span id="cb7-405"><a href="#cb7-405" aria-hidden="true" tabindex="-1"></a>  <span class="at">plot.tag.position =</span> <span class="fu">c</span>(<span class="fl">0.99</span>, <span class="fl">0.01</span>),</span>
<span id="cb7-406"><a href="#cb7-406" aria-hidden="true" tabindex="-1"></a>  <span class="at">panel.spacing.x =</span> <span class="fu">unit</span>(<span class="dv">2</span>, <span class="st">'lines'</span>),</span>
<span id="cb7-407"><a href="#cb7-407" aria-hidden="true" tabindex="-1"></a>  <span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> blackish_background, <span class="at">color =</span> <span class="st">'#1c1c1c'</span>)</span>
<span id="cb7-408"><a href="#cb7-408" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-409"><a href="#cb7-409" aria-hidden="true" tabindex="-1"></a><span class="fu">update_geom_defaults</span>(<span class="st">'text'</span>, <span class="fu">list</span>(<span class="at">color =</span> <span class="st">'white'</span>, <span class="at">size =</span> <span class="dv">12</span> <span class="sc">/</span> .pt))</span>
<span id="cb7-410"><a href="#cb7-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-411"><a href="#cb7-411" aria-hidden="true" tabindex="-1"></a>updated_xgd_n <span class="ot">&lt;-</span> updated_np_shots <span class="sc">|&gt;</span> </span>
<span id="cb7-412"><a href="#cb7-412" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>is_penalty) <span class="sc">|&gt;</span> </span>
<span id="cb7-413"><a href="#cb7-413" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(old_xg, new_xg) <span class="sc">|&gt;</span></span>
<span id="cb7-414"><a href="#cb7-414" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(old_xg, new_xg)</span>
<span id="cb7-415"><a href="#cb7-415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-416"><a href="#cb7-416" aria-hidden="true" tabindex="-1"></a>tag_lab <span class="ot">&lt;-</span> <span class="st">'&lt;span style="font-family:fb";"&gt;&amp;#xf099;&lt;/span&gt; @TonyElHabr'</span></span>
<span id="cb7-417"><a href="#cb7-417" aria-hidden="true" tabindex="-1"></a>p_old_vs_new_xg <span class="ot">&lt;-</span> updated_xgd_n <span class="sc">|&gt;</span> </span>
<span id="cb7-418"><a href="#cb7-418" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb7-419"><a href="#cb7-419" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> old_xg, <span class="at">y =</span> new_xg) <span class="sc">+</span></span>
<span id="cb7-420"><a href="#cb7-420" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(</span>
<span id="cb7-421"><a href="#cb7-421" aria-hidden="true" tabindex="-1"></a>    <span class="at">linetype =</span> <span class="dv">2</span>,</span>
<span id="cb7-422"><a href="#cb7-422" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">'white'</span>,</span>
<span id="cb7-423"><a href="#cb7-423" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb7-424"><a href="#cb7-424" aria-hidden="true" tabindex="-1"></a>      <span class="at">slope =</span> <span class="dv">1</span>,</span>
<span id="cb7-425"><a href="#cb7-425" aria-hidden="true" tabindex="-1"></a>      <span class="at">intercept =</span> <span class="dv">0</span></span>
<span id="cb7-426"><a href="#cb7-426" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-427"><a href="#cb7-427" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb7-428"><a href="#cb7-428" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb7-429"><a href="#cb7-429" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">'white'</span>,</span>
<span id="cb7-430"><a href="#cb7-430" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb7-431"><a href="#cb7-431" aria-hidden="true" tabindex="-1"></a>      <span class="at">size =</span> n, </span>
<span id="cb7-432"><a href="#cb7-432" aria-hidden="true" tabindex="-1"></a>      <span class="at">alpha =</span> n</span>
<span id="cb7-433"><a href="#cb7-433" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-434"><a href="#cb7-434" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb7-435"><a href="#cb7-435" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.25</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb7-436"><a href="#cb7-436" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(</span>
<span id="cb7-437"><a href="#cb7-437" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="st">'none'</span>,</span>
<span id="cb7-438"><a href="#cb7-438" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="st">'none'</span></span>
<span id="cb7-439"><a href="#cb7-439" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb7-440"><a href="#cb7-440" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(</span>
<span id="cb7-441"><a href="#cb7-441" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb7-442"><a href="#cb7-442" aria-hidden="true" tabindex="-1"></a>    <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb7-443"><a href="#cb7-443" aria-hidden="true" tabindex="-1"></a>    <span class="at">expand =</span> <span class="cn">TRUE</span></span>
<span id="cb7-444"><a href="#cb7-444" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb7-445"><a href="#cb7-445" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb7-446"><a href="#cb7-446" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">'Comparison of Opta non-penalty expected goals (npxG)'</span>,</span>
<span id="cb7-447"><a href="#cb7-447" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">'Pre- and post-FBref update (2023-02-08) for Big 5 leagues, 2021/22 season'</span>,</span>
<span id="cb7-448"><a href="#cb7-448" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">'Pre-update npxG'</span>,</span>
<span id="cb7-449"><a href="#cb7-449" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">'Post-update npxG'</span>,</span>
<span id="cb7-450"><a href="#cb7-450" aria-hidden="true" tabindex="-1"></a>    <span class="at">tag =</span> tag_lab,</span>
<span id="cb7-451"><a href="#cb7-451" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">'Each point represents a shot.</span><span class="sc">\n</span><span class="st">Larger, more opaque points = more shots.'</span></span>
<span id="cb7-452"><a href="#cb7-452" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-453"><a href="#cb7-453" aria-hidden="true" tabindex="-1"></a>p_old_vs_new_xg</span>
<span id="cb7-454"><a href="#cb7-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-455"><a href="#cb7-455" aria-hidden="true" tabindex="-1"></a>plot_resolution <span class="ot">&lt;-</span> <span class="dv">300</span></span>
<span id="cb7-456"><a href="#cb7-456" aria-hidden="true" tabindex="-1"></a>plot_dir <span class="ot">&lt;-</span> <span class="st">'posts/opta-xg-model-calibration'</span></span>
<span id="cb7-457"><a href="#cb7-457" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(</span>
<span id="cb7-458"><a href="#cb7-458" aria-hidden="true" tabindex="-1"></a>  p_old_vs_new_xg,</span>
<span id="cb7-459"><a href="#cb7-459" aria-hidden="true" tabindex="-1"></a>  <span class="at">device =</span> ragg<span class="sc">::</span>agg_png,</span>
<span id="cb7-460"><a href="#cb7-460" aria-hidden="true" tabindex="-1"></a>  <span class="at">res =</span> plot_resolution,</span>
<span id="cb7-461"><a href="#cb7-461" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> <span class="fu">file.path</span>(plot_dir, <span class="st">'old_vs_new_xg.png'</span>),</span>
<span id="cb7-462"><a href="#cb7-462" aria-hidden="true" tabindex="-1"></a>  <span class="at">width =</span> <span class="dv">8</span> <span class="sc">*</span> plot_resolution,</span>
<span id="cb7-463"><a href="#cb7-463" aria-hidden="true" tabindex="-1"></a>  <span class="at">height =</span> <span class="dv">8</span> <span class="sc">*</span> plot_resolution,</span>
<span id="cb7-464"><a href="#cb7-464" aria-hidden="true" tabindex="-1"></a>  <span class="at">units =</span> <span class="st">'px'</span></span>
<span id="cb7-465"><a href="#cb7-465" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-466"><a href="#cb7-466" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb7-467"><a href="#cb7-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-468"><a href="#cb7-468" aria-hidden="true" tabindex="-1"></a><span class="al">![](old_vs_new_xg.png)</span></span>
<span id="cb7-469"><a href="#cb7-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-470"><a href="#cb7-470" aria-hidden="true" tabindex="-1"></a>Of the 44,986 shots in the data set, 30,326 (67.2%) had changes to their xG values.<span class="ot">[^3]</span> Of those that changed, 23, 584 (78.0%) were reduced, i.e. the pre-update xG value was higher. The average change was pretty minimal, just about \~0.01 xG.</span>
<span id="cb7-471"><a href="#cb7-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-472"><a href="#cb7-472" aria-hidden="true" tabindex="-1"></a><span class="ot">[^3]: </span>Observe that, for a large majority of shots, where xG is in the (0, 0.05<span class="sc">\]</span> range, xG either did not change at all or only trivially changed. (See the blur of white points on the left-hand side of the plot.)</span>
<span id="cb7-473"><a href="#cb7-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-476"><a href="#cb7-476" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb7-477"><a href="#cb7-477" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: discretized_updated_np_shots-glimpse</span></span>
<span id="cb7-478"><a href="#cb7-478" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: true</span></span>
<span id="cb7-479"><a href="#cb7-479" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb7-480"><a href="#cb7-480" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: show</span></span>
<span id="cb7-481"><a href="#cb7-481" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(discretized_updated_np_shots)</span>
<span id="cb7-482"><a href="#cb7-482" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Rows: 44,986</span></span>
<span id="cb7-483"><a href="#cb7-483" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Columns: 16</span></span>
<span id="cb7-484"><a href="#cb7-484" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; $ league             &lt;fct&gt; ENG, ENG, ENG, ENG, ENG, ENG, ENG, ENG, ENG, ENG, E…</span></span>
<span id="cb7-485"><a href="#cb7-485" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; $ date               &lt;date&gt; 2021-08-13, 2021-08-13, 2021-08-13, 2021-08-13, 20…</span></span>
<span id="cb7-486"><a href="#cb7-486" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; $ half               &lt;dbl&gt; 1, 1, 1, 1, 1, 2, 2, 2, 1, 1, 1, 1, 1, 1, 1, 2, 2, …</span></span>
<span id="cb7-487"><a href="#cb7-487" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; $ minute             &lt;chr&gt; "11", "12", "22", "28", "30", "66", "73", "80", "2"…</span></span>
<span id="cb7-488"><a href="#cb7-488" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; $ team               &lt;chr&gt; "Brentford", "Brentford", "Brentford", "Brentford",…</span></span>
<span id="cb7-489"><a href="#cb7-489" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; $ player             &lt;chr&gt; "Frank Onyeka", "Bryan Mbeumo", "Sergi Canós", "Ser…</span></span>
<span id="cb7-490"><a href="#cb7-490" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; $ new_xg             &lt;dbl&gt; 0.08, 0.09, 0.02, 0.06, 0.26, 0.06, 0.40, 0.28, 0.0…</span></span>
<span id="cb7-491"><a href="#cb7-491" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; $ old_xg             &lt;dbl&gt; 0.09, 0.14, 0.04, 0.07, 0.31, 0.13, 0.58, 0.27, 0.0…</span></span>
<span id="cb7-492"><a href="#cb7-492" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; $ is_goal            &lt;fct&gt; no, no, yes, no, no, no, yes, no, no, no, no, no, n…</span></span>
<span id="cb7-493"><a href="#cb7-493" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; $ distance           &lt;fct&gt; "(8,10]", "(12,14]", "(16,18]", "(20,25]", "(12,14]…</span></span>
<span id="cb7-494"><a href="#cb7-494" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; $ sca1               &lt;fct&gt; pass_live, pass_live, pass_live, pass_live, take_on…</span></span>
<span id="cb7-495"><a href="#cb7-495" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; $ body_part          &lt;fct&gt; Head, Right Foot, Right Foot, Right Foot, Right Foo…</span></span>
<span id="cb7-496"><a href="#cb7-496" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; $ is_from_deflection &lt;fct&gt; no, no, no, no, no, no, no, no, no, no, no, no, no,…</span></span>
<span id="cb7-497"><a href="#cb7-497" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; $ is_from_volley     &lt;fct&gt; no, no, no, no, no, no, no, no, no, yes, no, no, no…</span></span>
<span id="cb7-498"><a href="#cb7-498" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; $ is_free_kick       &lt;fct&gt; no, no, no, no, no, no, no, no, no, no, no, no, no,…</span></span>
<span id="cb7-499"><a href="#cb7-499" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; $ is_primary_foot    &lt;fct&gt; missing, no, yes, yes, no, yes, missing, missing, y…</span></span>
<span id="cb7-500"><a href="#cb7-500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-501"><a href="#cb7-501" aria-hidden="true" tabindex="-1"></a>discretized_updated_np_shots <span class="sc">|&gt;</span> </span>
<span id="cb7-502"><a href="#cb7-502" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">xgd =</span> old_xg <span class="sc">-</span> new_xg) <span class="sc">|&gt;</span> </span>
<span id="cb7-503"><a href="#cb7-503" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(xgd) <span class="sc">|&gt;</span> </span>
<span id="cb7-504"><a href="#cb7-504" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>()</span>
<span id="cb7-505"><a href="#cb7-505" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 0.0095014</span></span>
<span id="cb7-506"><a href="#cb7-506" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb7-507"><a href="#cb7-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-508"><a href="#cb7-508" aria-hidden="true" tabindex="-1"></a>To get more insight into how/why xG changed, we can look at changes to xG values grouped by various <span class="in">`feature`</span>s that we can derive from data that FBref publishes alongside each shot's xG, including <span class="in">`distance`</span> (yards), <span class="in">`sca1`</span> (first <span class="co">[</span><span class="ot">shot-creating action</span><span class="co">](https://www.sports-reference.com/blog/2020/04/goal-creation-possession-passing-and-more-advanced-stats-on-fbref/)</span>), <span class="in">`body_part`</span>, <span class="in">`is_from_deflection`</span>, <span class="in">`is_from_volley`</span>, <span class="in">`is_free_kick`</span>, and <span class="in">`is_primary_foot`</span>.<span class="ot">[^4][^5]</span></span>
<span id="cb7-509"><a href="#cb7-509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-510"><a href="#cb7-510" aria-hidden="true" tabindex="-1"></a><span class="ot">[^4]: </span>Several of these are not provided directly from the raw FBref tables. For example, <span class="in">`is_from_deflection`</span> is derived from the <span class="in">`Notes`</span> field in the FBref shot table. <span class="in">`is_primary_foot`</span> is derived from collecting player footedness data and checking for a match with <span class="in">`body_part`</span>.</span>
<span id="cb7-511"><a href="#cb7-511" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-512"><a href="#cb7-512" aria-hidden="true" tabindex="-1"></a><span class="ot">[^5]: </span>Note that I use the term "feature" here, although this set of fields does not quite match the actual <span class="co">[</span><span class="ot">inputs to the</span><span class="co">](https://theanalyst.com/eu/2021/07/what-are-expected-goals-xg)</span> <span class="co">[</span><span class="ot">Opta xG model</span><span class="co">](https://fbref.com/en/expected-goals-model-explained/)</span>. While things like <span class="in">`distance`</span> and <span class="in">`body_part`</span> certainly are inputs to the model, we don't have angle of the shot to the goal, and <span class="in">`is_primary_foot`</span>---a field that I've added the feature set myself---isn't one of the model inputs, as far as I'm aware.</span>
<span id="cb7-513"><a href="#cb7-513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-516"><a href="#cb7-516" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb7-517"><a href="#cb7-517" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: updated_np_shot_diffs</span></span>
<span id="cb7-518"><a href="#cb7-518" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scales)</span>
<span id="cb7-519"><a href="#cb7-519" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb7-520"><a href="#cb7-520" aria-hidden="true" tabindex="-1"></a>pivot_discretized_cols <span class="ot">&lt;-</span> <span class="cf">function</span>(df) {</span>
<span id="cb7-521"><a href="#cb7-521" aria-hidden="true" tabindex="-1"></a>  df <span class="sc">|&gt;</span> </span>
<span id="cb7-522"><a href="#cb7-522" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(league, date, half, minute, team, player)) <span class="sc">|&gt;</span> </span>
<span id="cb7-523"><a href="#cb7-523" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(</span>
<span id="cb7-524"><a href="#cb7-524" aria-hidden="true" tabindex="-1"></a>      <span class="sc">-</span><span class="fu">c</span>(is_goal, <span class="fu">matches</span>(<span class="st">'xg$'</span>)),</span>
<span id="cb7-525"><a href="#cb7-525" aria-hidden="true" tabindex="-1"></a>      <span class="at">names_to =</span> <span class="st">'feature'</span>,</span>
<span id="cb7-526"><a href="#cb7-526" aria-hidden="true" tabindex="-1"></a>      <span class="at">values_to =</span> <span class="st">'group'</span></span>
<span id="cb7-527"><a href="#cb7-527" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-528"><a href="#cb7-528" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-529"><a href="#cb7-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-530"><a href="#cb7-530" aria-hidden="true" tabindex="-1"></a>updated_np_shot_diffs <span class="ot">&lt;-</span> discretized_updated_np_shots <span class="sc">|&gt;</span> </span>
<span id="cb7-531"><a href="#cb7-531" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_discretized_cols</span>() <span class="sc">|&gt;</span> </span>
<span id="cb7-532"><a href="#cb7-532" aria-hidden="true" tabindex="-1"></a>  <span class="fu">compare_by</span>(feature, group)</span>
<span id="cb7-533"><a href="#cb7-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-534"><a href="#cb7-534" aria-hidden="true" tabindex="-1"></a>slice_and_tabularize_np_shot_diffs <span class="ot">&lt;-</span> <span class="cf">function</span>(op, <span class="at">n =</span> <span class="dv">6</span>) {</span>
<span id="cb7-535"><a href="#cb7-535" aria-hidden="true" tabindex="-1"></a>  updated_np_shot_diffs <span class="sc">|&gt;</span> </span>
<span id="cb7-536"><a href="#cb7-536" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(n_shots <span class="sc">&gt;=</span> <span class="dv">100</span>) <span class="sc">|&gt;</span> </span>
<span id="cb7-537"><a href="#cb7-537" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(<span class="fu">op</span>(prop_old_npxg_is_higher)) <span class="sc">|&gt;</span> </span>
<span id="cb7-538"><a href="#cb7-538" aria-hidden="true" tabindex="-1"></a>    <span class="fu">head</span>(n) <span class="sc">|&gt;</span> </span>
<span id="cb7-539"><a href="#cb7-539" aria-hidden="true" tabindex="-1"></a>    <span class="fu">transmute</span>(</span>
<span id="cb7-540"><a href="#cb7-540" aria-hidden="true" tabindex="-1"></a>      <span class="at">Feature =</span> <span class="fu">sprintf</span>(<span class="st">'`%s`'</span>, feature),</span>
<span id="cb7-541"><a href="#cb7-541" aria-hidden="true" tabindex="-1"></a>      <span class="at">Group =</span> <span class="fu">sprintf</span>(<span class="st">'`%s`'</span>, <span class="fu">ifelse</span>(feature <span class="sc">==</span> <span class="st">"distance"</span>, <span class="fu">as.character</span>(group), <span class="fu">paste0</span>(<span class="st">'"'</span>, group, <span class="st">'"'</span>))),</span>
<span id="cb7-542"><a href="#cb7-542" aria-hidden="true" tabindex="-1"></a>      <span class="st">`</span><span class="at"># of non-penalty shots</span><span class="st">`</span> <span class="ot">=</span> scales<span class="sc">::</span><span class="fu">comma</span>(n_shots),</span>
<span id="cb7-543"><a href="#cb7-543" aria-hidden="true" tabindex="-1"></a>      <span class="st">`</span><span class="at"># of shots with changed npxG</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">sprintf</span>(<span class="st">'%s (%.1f%%)'</span>, scales<span class="sc">::</span><span class="fu">comma</span>(n_diff_npxg), <span class="dv">100</span> <span class="sc">*</span> prop_diff_npxg),</span>
<span id="cb7-544"><a href="#cb7-544" aria-hidden="true" tabindex="-1"></a>      <span class="st">`</span><span class="at"># of shots with lower post-update npxG of those that changed</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">sprintf</span>(<span class="st">'%s (%.1f%%)'</span>, scales<span class="sc">::</span><span class="fu">comma</span>(n_old_npxg_is_higher), <span class="dv">100</span> <span class="sc">*</span> prop_old_npxg_is_higher),</span>
<span id="cb7-545"><a href="#cb7-545" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb7-546"><a href="#cb7-546" aria-hidden="true" tabindex="-1"></a>    knitr<span class="sc">::</span><span class="fu">kable</span>()</span>
<span id="cb7-547"><a href="#cb7-547" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-548"><a href="#cb7-548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-549"><a href="#cb7-549" aria-hidden="true" tabindex="-1"></a><span class="fu">slice_and_tabularize_np_shot_diffs</span>(<span class="st">`</span><span class="at">-</span><span class="st">`</span>)</span>
<span id="cb7-550"><a href="#cb7-550" aria-hidden="true" tabindex="-1"></a><span class="fu">slice_and_tabularize_np_shot_diffs</span>(<span class="st">`</span><span class="at">+</span><span class="st">`</span>)</span>
<span id="cb7-551"><a href="#cb7-551" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb7-552"><a href="#cb7-552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-553"><a href="#cb7-553" aria-hidden="true" tabindex="-1"></a>The table below shows that the reductions in npxG occurred most frequently for longer <span class="in">`distance`</span>s, suggesting that the pre-update xG model was over-predicting xG for longer shots. Interestingly, xG for shots when interceptions were the shot-creating action that led directly to the shot, and xG for shots with <span class="in">`body_part = "other"`</span> (non-foot, non-header) were also frequently reduced, in the cases where xG was changed.</span>
<span id="cb7-554"><a href="#cb7-554" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-555"><a href="#cb7-555" aria-hidden="true" tabindex="-1"></a>| Feature     | Group            | <span class="sc">\#</span> of non-penalty shots | <span class="sc">\#</span> of shots with changed npxG | <span class="sc">\#</span> of shots with lower post-update npxG of those that changed |</span>
<span id="cb7-556"><a href="#cb7-556" aria-hidden="true" tabindex="-1"></a>|:------------|:-----------------|------------------------:|------------------------------:|--------------------------------------------------------------:|</span>
<span id="cb7-557"><a href="#cb7-557" aria-hidden="true" tabindex="-1"></a>| <span class="in">`distance`</span>  | <span class="in">`(25,30]`</span>        |                   6,061 |                 3,659 (60.4%) |                                                 3,437 (93.9%) |</span>
<span id="cb7-558"><a href="#cb7-558" aria-hidden="true" tabindex="-1"></a>| <span class="in">`distance`</span>  | <span class="in">`(20,25]`</span>        |                   6,760 |                 4,463 (66.0%) |                                                 4,088 (91.6%) |</span>
<span id="cb7-559"><a href="#cb7-559" aria-hidden="true" tabindex="-1"></a>| <span class="in">`sca1`</span>      | <span class="in">`"interception"`</span> |                     149 |                    96 (64.4%) |                                                    87 (90.6%) |</span>
<span id="cb7-560"><a href="#cb7-560" aria-hidden="true" tabindex="-1"></a>| <span class="in">`distance`</span>  | <span class="in">`(18,20]`</span>        |                   1,889 |                 1,232 (65.2%) |                                                 1,088 (88.3%) |</span>
<span id="cb7-561"><a href="#cb7-561" aria-hidden="true" tabindex="-1"></a>| <span class="in">`distance`</span>  | <span class="in">`(30,35]`</span>        |                   2,725 |                 1,267 (46.5%) |                                                 1,117 (88.2%) |</span>
<span id="cb7-562"><a href="#cb7-562" aria-hidden="true" tabindex="-1"></a>| <span class="in">`body_part`</span> | <span class="in">`"Other"`</span>        |                     191 |                   153 (80.1%) |                                                   130 (85.0%) |</span>
<span id="cb7-563"><a href="#cb7-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-564"><a href="#cb7-564" aria-hidden="true" tabindex="-1"></a>On the other end of the spectrum, reductions in npxG occurred least frequently for shorter <span class="in">`distance`</span> buckets (<span class="in">`(0,2]`</span>, <span class="in">`(2,4]`</span>, <span class="in">`(4,6]`</span>, <span class="in">`(6,8)`</span>). Reductions still occurred a majority of the time when there was a change---note that each has <span class="in">`&gt;50%`</span> for the last column---for all but the shortest <span class="in">`distance`</span> group, <span class="in">`(0,2]`</span>.</span>
<span id="cb7-565"><a href="#cb7-565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-566"><a href="#cb7-566" aria-hidden="true" tabindex="-1"></a>| Feature        | Group      | <span class="sc">\#</span> of non-penalty shots | <span class="sc">\#</span> of shots with changed npxG | <span class="sc">\#</span> of shots with lower post-update npxG of those that changed |</span>
<span id="cb7-567"><a href="#cb7-567" aria-hidden="true" tabindex="-1"></a>|:---------------|:-----------|------------------------:|------------------------------:|--------------------------------------------------------------:|</span>
<span id="cb7-568"><a href="#cb7-568" aria-hidden="true" tabindex="-1"></a>| <span class="in">`distance`</span>     | <span class="in">`(0,2]`</span>    |                     173 |                   130 (75.1%) |                                                    51 (39.2%) |</span>
<span id="cb7-569"><a href="#cb7-569" aria-hidden="true" tabindex="-1"></a>| <span class="in">`distance`</span>     | <span class="in">`(2,4]`</span>    |                   1,087 |                   826 (76.0%) |                                                   428 (51.8%) |</span>
<span id="cb7-570"><a href="#cb7-570" aria-hidden="true" tabindex="-1"></a>| <span class="in">`distance`</span>     | <span class="in">`(4,6]`</span>    |                   2,003 |                 1,479 (73.8%) |                                                   831 (56.2%) |</span>
<span id="cb7-571"><a href="#cb7-571" aria-hidden="true" tabindex="-1"></a>| <span class="in">`distance`</span>     | <span class="in">`(35,Inf]`</span> |                     539 |                   313 (58.1%) |                                                   177 (56.5%) |</span>
<span id="cb7-572"><a href="#cb7-572" aria-hidden="true" tabindex="-1"></a>| <span class="in">`distance`</span>     | <span class="in">`(6,8]`</span>    |                   2,557 |                 1,882 (73.6%) |                                                 1,183 (62.9%) |</span>
<span id="cb7-573"><a href="#cb7-573" aria-hidden="true" tabindex="-1"></a>| <span class="in">`is_free_kick`</span> | <span class="in">`"yes"`</span>    |                   1,576 |                   882 (56.0%) |                                                   557 (63.2%) |</span>
<span id="cb7-574"><a href="#cb7-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-575"><a href="#cb7-575" aria-hidden="true" tabindex="-1"></a><span class="fu">## 2. xG Model Calibration</span></span>
<span id="cb7-576"><a href="#cb7-576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-577"><a href="#cb7-577" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">I've touched on model calibration before</span><span class="co">](/posts/epl-xpts-simulation-1/#match-predictive-performance7)</span>, when discussing xG-implied match outcome probabilities. There, I wrote my own code to create a <span class="co">[</span><span class="ot">calibration plot</span><span class="co">](https://changhsinlee.com/python-calibration-plot/)</span>. Since then, the <span class="co">[</span><span class="ot">`{tidymodels}` team</span><span class="co">](https://www.tidymodels.org/)</span> has added <span class="co">[</span><span class="ot">calibration plot functionality</span><span class="co">](https://www.tidyverse.org/blog/2022/11/model-calibration/)</span> to the <span class="co">[</span><span class="ot">`{probably}` package</span><span class="co">](https://probably.tidymodels.org/)</span>. Let's try it out.</span>
<span id="cb7-578"><a href="#cb7-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-579"><a href="#cb7-579" aria-hidden="true" tabindex="-1"></a>Here, we'll use a big sample of data---all 2017/18 - 2021/22 non-penalty shots for the Big 5 leagues and several other first and second tier leagues.<span class="ot">[^6]</span></span>
<span id="cb7-580"><a href="#cb7-580" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-581"><a href="#cb7-581" aria-hidden="true" tabindex="-1"></a><span class="ot">[^6]: </span>Several leagues don't have data available for all such seasons, which is reflected in the number of shots per league in <span class="in">`np_shots`</span>.</span>
<span id="cb7-582"><a href="#cb7-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-585"><a href="#cb7-585" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb7-586"><a href="#cb7-586" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: np_shots</span></span>
<span id="cb7-587"><a href="#cb7-587" aria-hidden="true" tabindex="-1"></a>np_shots <span class="ot">&lt;-</span> <span class="fu">read_rds</span>(<span class="st">'../sports_viz/65-opta_xg_calib/data/clean_shots.rds'</span>) <span class="sc">|&gt;</span> </span>
<span id="cb7-588"><a href="#cb7-588" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>is_penalty) <span class="sc">|&gt;</span> </span>
<span id="cb7-589"><a href="#cb7-589" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb7-590"><a href="#cb7-590" aria-hidden="true" tabindex="-1"></a>    <span class="at">league =</span> <span class="fu">sprintf</span>(<span class="st">'%s_%s_%s'</span>, country, tier, gender)</span>
<span id="cb7-591"><a href="#cb7-591" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-592"><a href="#cb7-592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-593"><a href="#cb7-593" aria-hidden="true" tabindex="-1"></a>npxg_by <span class="ot">&lt;-</span> <span class="cf">function</span>(shots, ...) {</span>
<span id="cb7-594"><a href="#cb7-594" aria-hidden="true" tabindex="-1"></a>  shots <span class="sc">|&gt;</span> </span>
<span id="cb7-595"><a href="#cb7-595" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(...) <span class="sc">|&gt;</span> </span>
<span id="cb7-596"><a href="#cb7-596" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(</span>
<span id="cb7-597"><a href="#cb7-597" aria-hidden="true" tabindex="-1"></a>      <span class="at">n_shots =</span> <span class="fu">n</span>(),</span>
<span id="cb7-598"><a href="#cb7-598" aria-hidden="true" tabindex="-1"></a>      <span class="at">npxg =</span> <span class="fu">sum</span>(xg, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb7-599"><a href="#cb7-599" aria-hidden="true" tabindex="-1"></a>      <span class="at">npg =</span> <span class="fu">sum</span>(<span class="fu">as.character</span>(is_goal) <span class="sc">==</span> <span class="st">'yes'</span>)</span>
<span id="cb7-600"><a href="#cb7-600" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb7-601"><a href="#cb7-601" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> </span>
<span id="cb7-602"><a href="#cb7-602" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb7-603"><a href="#cb7-603" aria-hidden="true" tabindex="-1"></a>      <span class="at">d =</span> npxg <span class="sc">-</span> npg,</span>
<span id="cb7-604"><a href="#cb7-604" aria-hidden="true" tabindex="-1"></a>      <span class="at">d_rate =</span> d <span class="sc">/</span> n_shots</span>
<span id="cb7-605"><a href="#cb7-605" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb7-606"><a href="#cb7-606" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(<span class="fu">desc</span>(n_shots))</span>
<span id="cb7-607"><a href="#cb7-607" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-608"><a href="#cb7-608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-609"><a href="#cb7-609" aria-hidden="true" tabindex="-1"></a>discretized_np_shots <span class="ot">&lt;-</span> <span class="fu">discretize_cols</span>(np_shots)</span>
<span id="cb7-610"><a href="#cb7-610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-611"><a href="#cb7-611" aria-hidden="true" tabindex="-1"></a>np_shot_diffs <span class="ot">&lt;-</span> discretized_np_shots <span class="sc">|&gt;</span> </span>
<span id="cb7-612"><a href="#cb7-612" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_discretized_cols</span>() <span class="sc">|&gt;</span> </span>
<span id="cb7-613"><a href="#cb7-613" aria-hidden="true" tabindex="-1"></a>  <span class="fu">npxg_by</span>(feature, group)</span>
<span id="cb7-614"><a href="#cb7-614" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb7-615"><a href="#cb7-615" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-618"><a href="#cb7-618" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb7-619"><a href="#cb7-619" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: np_shots-counts</span></span>
<span id="cb7-620"><a href="#cb7-620" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: true</span></span>
<span id="cb7-621"><a href="#cb7-621" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb7-622"><a href="#cb7-622" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: show</span></span>
<span id="cb7-623"><a href="#cb7-623" aria-hidden="true" tabindex="-1"></a>np_shots <span class="sc">|&gt;</span> <span class="fu">count</span>(league, <span class="at">name =</span> <span class="st">'n_shots'</span>)</span>
<span id="cb7-624"><a href="#cb7-624" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 13 × 2</span></span>
<span id="cb7-625"><a href="#cb7-625" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    league    n_shots</span></span>
<span id="cb7-626"><a href="#cb7-626" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    &lt;chr&gt;       &lt;int&gt;</span></span>
<span id="cb7-627"><a href="#cb7-627" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  1 BRA_1st_M   39380</span></span>
<span id="cb7-628"><a href="#cb7-628" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  2 ENG_1st_F   11366</span></span>
<span id="cb7-629"><a href="#cb7-629" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  3 ENG_1st_M   46766</span></span>
<span id="cb7-630"><a href="#cb7-630" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  4 ENG_2nd_M   52701</span></span>
<span id="cb7-631"><a href="#cb7-631" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  5 ESP_1st_M   43398</span></span>
<span id="cb7-632"><a href="#cb7-632" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  6 FRA_1st_M   43021</span></span>
<span id="cb7-633"><a href="#cb7-633" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  7 GER_1st_M   39148</span></span>
<span id="cb7-634"><a href="#cb7-634" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  8 ITA_1st_M   49903</span></span>
<span id="cb7-635"><a href="#cb7-635" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  9 MEX_1st_M   32650</span></span>
<span id="cb7-636"><a href="#cb7-636" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 10 NED_1st_M   29803</span></span>
<span id="cb7-637"><a href="#cb7-637" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 11 POR_1st_M   27366</span></span>
<span id="cb7-638"><a href="#cb7-638" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 12 USA_1st_F    9887</span></span>
<span id="cb7-639"><a href="#cb7-639" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 13 USA_1st_M   31047</span></span>
<span id="cb7-640"><a href="#cb7-640" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb7-641"><a href="#cb7-641" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-642"><a href="#cb7-642" aria-hidden="true" tabindex="-1"></a><span class="fu">### Calibration plot</span></span>
<span id="cb7-643"><a href="#cb7-643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-644"><a href="#cb7-644" aria-hidden="true" tabindex="-1"></a>We can use <span class="in">`probably::cal_plot_breaks()`</span> to visually assess whether the observed rate of non-penalty goals (y-axis) is close to the predicted probability of goals (npxG, x-axis).<span class="ot">[^7]</span> If the xG model's predictions are "well calibrated", the calibration points will align with the "ideal" line having slope 1 and intercept 0. Points at which the curve is below the diagonal line indicate where the model is more likelty to overpredict; and, likewise, points where the curve is above the diagonal line indicate where the model is underpredicting.</span>
<span id="cb7-645"><a href="#cb7-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-646"><a href="#cb7-646" aria-hidden="true" tabindex="-1"></a><span class="ot">[^7]: </span>I've written my own code to plot the calibration, but I imagine most users will be satisfied with the plot that <span class="in">`{probably}`</span> will generate for you.</span>
<span id="cb7-647"><a href="#cb7-647" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-650"><a href="#cb7-650" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb7-651"><a href="#cb7-651" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: overall_calibration</span></span>
<span id="cb7-652"><a href="#cb7-652" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb7-653"><a href="#cb7-653" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: true</span></span>
<span id="cb7-654"><a href="#cb7-654" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: show</span></span>
<span id="cb7-655"><a href="#cb7-655" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(probably) <span class="do">## 0.1.0.9007</span></span>
<span id="cb7-656"><a href="#cb7-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-657"><a href="#cb7-657" aria-hidden="true" tabindex="-1"></a>overall_calibration <span class="ot">&lt;-</span> <span class="fu">cal_plot_breaks</span>(</span>
<span id="cb7-658"><a href="#cb7-658" aria-hidden="true" tabindex="-1"></a>  np_shots,</span>
<span id="cb7-659"><a href="#cb7-659" aria-hidden="true" tabindex="-1"></a>  <span class="at">truth =</span> is_goal,</span>
<span id="cb7-660"><a href="#cb7-660" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimate =</span> xg,</span>
<span id="cb7-661"><a href="#cb7-661" aria-hidden="true" tabindex="-1"></a>  <span class="at">num_breaks =</span> <span class="dv">20</span>,</span>
<span id="cb7-662"><a href="#cb7-662" aria-hidden="true" tabindex="-1"></a>  <span class="at">conf_level =</span> <span class="fl">0.9</span>,</span>
<span id="cb7-663"><a href="#cb7-663" aria-hidden="true" tabindex="-1"></a>  <span class="at">event_level =</span> <span class="st">'second'</span></span>
<span id="cb7-664"><a href="#cb7-664" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-665"><a href="#cb7-665" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb7-666"><a href="#cb7-666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-669"><a href="#cb7-669" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb7-670"><a href="#cb7-670" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: p_overall_calibration</span></span>
<span id="cb7-671"><a href="#cb7-671" aria-hidden="true" tabindex="-1"></a>overall_calibration<span class="sc">$</span>data <span class="sc">|&gt;</span> </span>
<span id="cb7-672"><a href="#cb7-672" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(<span class="at">group =</span> predicted_midpoint <span class="sc">&lt;=</span> <span class="fl">0.25</span>) <span class="sc">|&gt;</span> </span>
<span id="cb7-673"><a href="#cb7-673" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="fu">across</span>(total, sum)) <span class="sc">|&gt;</span> </span>
<span id="cb7-674"><a href="#cb7-674" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> </span>
<span id="cb7-675"><a href="#cb7-675" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prop =</span> total <span class="sc">/</span> <span class="fu">sum</span>(total))</span>
<span id="cb7-676"><a href="#cb7-676" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-677"><a href="#cb7-677" aria-hidden="true" tabindex="-1"></a>plot_and_save_calibration <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb7-678"><a href="#cb7-678" aria-hidden="true" tabindex="-1"></a>    df,</span>
<span id="cb7-679"><a href="#cb7-679" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">7</span>,</span>
<span id="cb7-680"><a href="#cb7-680" aria-hidden="true" tabindex="-1"></a>    <span class="at">width =</span> size, </span>
<span id="cb7-681"><a href="#cb7-681" aria-hidden="true" tabindex="-1"></a>    <span class="at">height =</span> <span class="dv">7</span>, </span>
<span id="cb7-682"><a href="#cb7-682" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="cn">NULL</span>,</span>
<span id="cb7-683"><a href="#cb7-683" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">'Big 5 and 8 other leagues'</span>,</span>
<span id="cb7-684"><a href="#cb7-684" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="cn">NULL</span>,</span>
<span id="cb7-685"><a href="#cb7-685" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> <span class="fu">tempfile</span>(),</span>
<span id="cb7-686"><a href="#cb7-686" aria-hidden="true" tabindex="-1"></a>    labels_layer</span>
<span id="cb7-687"><a href="#cb7-687" aria-hidden="true" tabindex="-1"></a>) {</span>
<span id="cb7-688"><a href="#cb7-688" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-689"><a href="#cb7-689" aria-hidden="true" tabindex="-1"></a>  group_cols <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(</span>
<span id="cb7-690"><a href="#cb7-690" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(df),</span>
<span id="cb7-691"><a href="#cb7-691" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">'predicted_midpoint'</span>, <span class="st">'event_rate'</span>, <span class="st">'events'</span>, <span class="st">'total'</span>, <span class="st">'lower'</span>, <span class="st">'upper'</span>)</span>
<span id="cb7-692"><a href="#cb7-692" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-693"><a href="#cb7-693" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-694"><a href="#cb7-694" aria-hidden="true" tabindex="-1"></a>  has_group_cols <span class="ot">&lt;-</span> <span class="fu">length</span>(group_cols) <span class="sc">&gt;</span> <span class="dv">0</span></span>
<span id="cb7-695"><a href="#cb7-695" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-696"><a href="#cb7-696" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span> </span>
<span id="cb7-697"><a href="#cb7-697" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb7-698"><a href="#cb7-698" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> predicted_midpoint, <span class="at">y =</span> event_rate) <span class="sc">+</span></span>
<span id="cb7-699"><a href="#cb7-699" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_abline</span>(<span class="at">color =</span> <span class="st">'white'</span>, <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb7-700"><a href="#cb7-700" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_ribbon</span>(</span>
<span id="cb7-701"><a href="#cb7-701" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> <span class="st">'#999999'</span>,</span>
<span id="cb7-702"><a href="#cb7-702" aria-hidden="true" tabindex="-1"></a>      <span class="at">alpha =</span> <span class="fl">0.5</span>,</span>
<span id="cb7-703"><a href="#cb7-703" aria-hidden="true" tabindex="-1"></a>      <span class="fu">aes</span>(<span class="at">ymin =</span> lower, <span class="at">ymax =</span> upper)</span>
<span id="cb7-704"><a href="#cb7-704" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb7-705"><a href="#cb7-705" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">'white'</span>) <span class="sc">+</span></span>
<span id="cb7-706"><a href="#cb7-706" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(</span>
<span id="cb7-707"><a href="#cb7-707" aria-hidden="true" tabindex="-1"></a>      <span class="at">color =</span> <span class="st">'white'</span>,</span>
<span id="cb7-708"><a href="#cb7-708" aria-hidden="true" tabindex="-1"></a>      <span class="fu">aes</span>(<span class="at">size =</span> total),</span>
<span id="cb7-709"><a href="#cb7-709" aria-hidden="true" tabindex="-1"></a>      <span class="at">show.legend =</span> <span class="cn">FALSE</span></span>
<span id="cb7-710"><a href="#cb7-710" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb7-711"><a href="#cb7-711" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb7-712"><a href="#cb7-712" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="fu">paste0</span>(<span class="fu">c</span>(<span class="st">'Opta npxG calibration'</span>, title), <span class="at">collapse =</span> <span class="st">', by '</span>),</span>
<span id="cb7-713"><a href="#cb7-713" aria-hidden="true" tabindex="-1"></a>      <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="fu">c</span>(<span class="st">'2017/18 - 2021/22 seasons'</span>, subtitle), <span class="at">collapse =</span> <span class="st">', '</span>),</span>
<span id="cb7-714"><a href="#cb7-714" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">'Actual non-penalty goal rate'</span>,</span>
<span id="cb7-715"><a href="#cb7-715" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">'npxG'</span>,</span>
<span id="cb7-716"><a href="#cb7-716" aria-hidden="true" tabindex="-1"></a>      <span class="at">caption =</span> <span class="fu">paste0</span>(<span class="fu">c</span>(<span class="st">'Point size is proportional to number of observations.'</span>, caption), <span class="at">collapse =</span> <span class="st">'</span><span class="sc">\n</span><span class="st">'</span>),</span>
<span id="cb7-717"><a href="#cb7-717" aria-hidden="true" tabindex="-1"></a>      <span class="at">tag =</span> tag_lab</span>
<span id="cb7-718"><a href="#cb7-718" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-719"><a href="#cb7-719" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-720"><a href="#cb7-720" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">isTRUE</span>(has_group_cols)) {</span>
<span id="cb7-721"><a href="#cb7-721" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> p <span class="sc">+</span> </span>
<span id="cb7-722"><a href="#cb7-722" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme</span>(</span>
<span id="cb7-723"><a href="#cb7-723" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid.major =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb7-724"><a href="#cb7-724" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">color =</span> <span class="st">'white'</span>)</span>
<span id="cb7-725"><a href="#cb7-725" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">+</span> </span>
<span id="cb7-726"><a href="#cb7-726" aria-hidden="true" tabindex="-1"></a>      <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(<span class="sc">!!!</span>rlang<span class="sc">::</span><span class="fu">syms</span>(group_cols)))</span>
<span id="cb7-727"><a href="#cb7-727" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-728"><a href="#cb7-728" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-729"><a href="#cb7-729" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">missing</span>(labels_layer)) {</span>
<span id="cb7-730"><a href="#cb7-730" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> p <span class="sc">+</span> labels_layer</span>
<span id="cb7-731"><a href="#cb7-731" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-732"><a href="#cb7-732" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-733"><a href="#cb7-733" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggsave</span>(</span>
<span id="cb7-734"><a href="#cb7-734" aria-hidden="true" tabindex="-1"></a>    p,</span>
<span id="cb7-735"><a href="#cb7-735" aria-hidden="true" tabindex="-1"></a>    <span class="at">device =</span> ragg<span class="sc">::</span>agg_png,</span>
<span id="cb7-736"><a href="#cb7-736" aria-hidden="true" tabindex="-1"></a>    <span class="at">res =</span> plot_resolution,</span>
<span id="cb7-737"><a href="#cb7-737" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> <span class="fu">file.path</span>(plot_dir, <span class="fu">sprintf</span>(<span class="st">'%s_calibration.png'</span>, filename)),</span>
<span id="cb7-738"><a href="#cb7-738" aria-hidden="true" tabindex="-1"></a>    <span class="at">width =</span> width <span class="sc">*</span> plot_resolution,</span>
<span id="cb7-739"><a href="#cb7-739" aria-hidden="true" tabindex="-1"></a>    <span class="at">height =</span> height <span class="sc">*</span> plot_resolution,</span>
<span id="cb7-740"><a href="#cb7-740" aria-hidden="true" tabindex="-1"></a>    <span class="at">units =</span> <span class="st">'px'</span></span>
<span id="cb7-741"><a href="#cb7-741" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-742"><a href="#cb7-742" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>(p)</span>
<span id="cb7-743"><a href="#cb7-743" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-744"><a href="#cb7-744" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-745"><a href="#cb7-745" aria-hidden="true" tabindex="-1"></a>overall_calibration<span class="sc">$</span>data <span class="sc">|&gt;</span> </span>
<span id="cb7-746"><a href="#cb7-746" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_and_save_calibration</span>(</span>
<span id="cb7-747"><a href="#cb7-747" aria-hidden="true" tabindex="-1"></a>    <span class="at">width =</span> <span class="dv">7</span>,</span>
<span id="cb7-748"><a href="#cb7-748" aria-hidden="true" tabindex="-1"></a>    <span class="at">height =</span> <span class="dv">7</span> <span class="sc">/</span> <span class="fl">1.5</span>,</span>
<span id="cb7-749"><a href="#cb7-749" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> <span class="st">'overall'</span></span>
<span id="cb7-750"><a href="#cb7-750" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-751"><a href="#cb7-751" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb7-752"><a href="#cb7-752" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-753"><a href="#cb7-753" aria-hidden="true" tabindex="-1"></a><span class="al">![](overall_calibration.png)</span></span>
<span id="cb7-754"><a href="#cb7-754" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-755"><a href="#cb7-755" aria-hidden="true" tabindex="-1"></a>We can see that the model is pretty well calibrated on the lower end of the spectrum, when xG <span class="sc">\&lt;</span> 0.25. This makes up a larger majority of the shots (\~90%). However, the model is not as well calibrated for higher xG values, tending to overpredict. For example, at the calibration point where npxG is <span class="in">`0.675`</span>, the actual goal rate is <span class="in">`0.6`</span>.</span>
<span id="cb7-756"><a href="#cb7-756" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-757"><a href="#cb7-757" aria-hidden="true" tabindex="-1"></a><span class="fu">### Brier Skill Score (BSS)</span></span>
<span id="cb7-758"><a href="#cb7-758" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-759"><a href="#cb7-759" aria-hidden="true" tabindex="-1"></a>One thing that is not provided in the <span class="in">`{tidymodels}`</span> realm (specifically, the <span class="in">`{yardstick}`</span> package) is a function to compute <span class="co">[</span><span class="ot">Brier score</span><span class="co">](https://en.wikipedia.org/wiki/Brier_score)</span>. Nonetheless, we can define a Brier score function ourselves by closely following <span class="co">[</span><span class="ot">the mean squared error custom metric example</span><span class="co">](https://www.tidymodels.org/learn/develop/metrics/)</span> provided by the <span class="in">`{tidymodels}`</span> team.<span class="ot">[^8]</span></span>
<span id="cb7-760"><a href="#cb7-760" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-761"><a href="#cb7-761" aria-hidden="true" tabindex="-1"></a><span class="ot">[^8]: </span>Brier score for a binary classification task is equivalent to mean squared error.</span>
<span id="cb7-762"><a href="#cb7-762" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-765"><a href="#cb7-765" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb7-766"><a href="#cb7-766" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: bss</span></span>
<span id="cb7-767"><a href="#cb7-767" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: true</span></span>
<span id="cb7-768"><a href="#cb7-768" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb7-769"><a href="#cb7-769" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: show</span></span>
<span id="cb7-770"><a href="#cb7-770" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(yardstick)</span>
<span id="cb7-771"><a href="#cb7-771" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rlang)</span>
<span id="cb7-772"><a href="#cb7-772" aria-hidden="true" tabindex="-1"></a>brier_score <span class="ot">&lt;-</span> <span class="cf">function</span>(data, ...) {</span>
<span id="cb7-773"><a href="#cb7-773" aria-hidden="true" tabindex="-1"></a>  <span class="fu">UseMethod</span>(<span class="st">'brier_score'</span>)</span>
<span id="cb7-774"><a href="#cb7-774" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-775"><a href="#cb7-775" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-776"><a href="#cb7-776" aria-hidden="true" tabindex="-1"></a>brier_score <span class="ot">&lt;-</span> yardstick<span class="sc">::</span><span class="fu">new_prob_metric</span>(brier_score, <span class="at">direction =</span> <span class="st">'minimize'</span>)</span>
<span id="cb7-777"><a href="#cb7-777" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-778"><a href="#cb7-778" aria-hidden="true" tabindex="-1"></a>brier_score_vec <span class="ot">&lt;-</span> <span class="cf">function</span>(truth, estimate, <span class="at">na_rm =</span> <span class="cn">TRUE</span>, event_level, ...) {</span>
<span id="cb7-779"><a href="#cb7-779" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-780"><a href="#cb7-780" aria-hidden="true" tabindex="-1"></a>  brier_score_impl <span class="ot">&lt;-</span> <span class="cf">function</span>(truth, estimate, event_level, ...) {</span>
<span id="cb7-781"><a href="#cb7-781" aria-hidden="true" tabindex="-1"></a>    truth <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> (<span class="fu">as.numeric</span>(truth) <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb7-782"><a href="#cb7-782" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-783"><a href="#cb7-783" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (event_level <span class="sc">==</span> <span class="st">'second'</span>) {</span>
<span id="cb7-784"><a href="#cb7-784" aria-hidden="true" tabindex="-1"></a>      truth <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> truth</span>
<span id="cb7-785"><a href="#cb7-785" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-786"><a href="#cb7-786" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-787"><a href="#cb7-787" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mean</span>((truth <span class="sc">-</span> estimate)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb7-788"><a href="#cb7-788" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-789"><a href="#cb7-789" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-790"><a href="#cb7-790" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Recycle the estimate value if it's scalar-ish.</span></span>
<span id="cb7-791"><a href="#cb7-791" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(estimate) <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb7-792"><a href="#cb7-792" aria-hidden="true" tabindex="-1"></a>    estimate <span class="ot">&lt;-</span> <span class="fu">rep</span>(estimate, <span class="fu">length</span>(truth))</span>
<span id="cb7-793"><a href="#cb7-793" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-794"><a href="#cb7-794" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-795"><a href="#cb7-795" aria-hidden="true" tabindex="-1"></a>  yardstick<span class="sc">::</span><span class="fu">metric_vec_template</span>(</span>
<span id="cb7-796"><a href="#cb7-796" aria-hidden="true" tabindex="-1"></a>    <span class="at">metric_impl =</span> brier_score_impl,</span>
<span id="cb7-797"><a href="#cb7-797" aria-hidden="true" tabindex="-1"></a>    <span class="at">truth =</span> truth,</span>
<span id="cb7-798"><a href="#cb7-798" aria-hidden="true" tabindex="-1"></a>    <span class="at">estimate =</span> estimate,</span>
<span id="cb7-799"><a href="#cb7-799" aria-hidden="true" tabindex="-1"></a>    <span class="at">na_rm =</span> na_rm,</span>
<span id="cb7-800"><a href="#cb7-800" aria-hidden="true" tabindex="-1"></a>    <span class="at">cls =</span> <span class="fu">c</span>(<span class="st">'factor'</span>, <span class="st">'numeric'</span>),</span>
<span id="cb7-801"><a href="#cb7-801" aria-hidden="true" tabindex="-1"></a>    <span class="at">estimator =</span> <span class="st">'binary'</span>,</span>
<span id="cb7-802"><a href="#cb7-802" aria-hidden="true" tabindex="-1"></a>    <span class="at">event_level =</span> event_level,</span>
<span id="cb7-803"><a href="#cb7-803" aria-hidden="true" tabindex="-1"></a>    ...</span>
<span id="cb7-804"><a href="#cb7-804" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-805"><a href="#cb7-805" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-806"><a href="#cb7-806" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-807"><a href="#cb7-807" aria-hidden="true" tabindex="-1"></a>brier_score.data.frame <span class="ot">&lt;-</span> <span class="cf">function</span>(data, truth, estimate, <span class="at">na_rm =</span> <span class="cn">TRUE</span>, <span class="at">event_level =</span> <span class="st">'first'</span>, ...) {</span>
<span id="cb7-808"><a href="#cb7-808" aria-hidden="true" tabindex="-1"></a>  yardstick<span class="sc">::</span><span class="fu">metric_summarizer</span>(</span>
<span id="cb7-809"><a href="#cb7-809" aria-hidden="true" tabindex="-1"></a>    <span class="at">metric_nm =</span> <span class="st">'brier_score'</span>,</span>
<span id="cb7-810"><a href="#cb7-810" aria-hidden="true" tabindex="-1"></a>    <span class="at">metric_fn =</span> brier_score_vec,</span>
<span id="cb7-811"><a href="#cb7-811" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> data,</span>
<span id="cb7-812"><a href="#cb7-812" aria-hidden="true" tabindex="-1"></a>    <span class="at">truth =</span> <span class="sc">!!</span>rlang<span class="sc">::</span><span class="fu">enquo</span>(truth),</span>
<span id="cb7-813"><a href="#cb7-813" aria-hidden="true" tabindex="-1"></a>    <span class="at">estimate =</span> <span class="sc">!!</span>rlang<span class="sc">::</span><span class="fu">enquo</span>(estimate),</span>
<span id="cb7-814"><a href="#cb7-814" aria-hidden="true" tabindex="-1"></a>    <span class="at">na_rm =</span> na_rm,</span>
<span id="cb7-815"><a href="#cb7-815" aria-hidden="true" tabindex="-1"></a>    <span class="at">event_level =</span> event_level,</span>
<span id="cb7-816"><a href="#cb7-816" aria-hidden="true" tabindex="-1"></a>    ...</span>
<span id="cb7-817"><a href="#cb7-817" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-818"><a href="#cb7-818" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-819"><a href="#cb7-819" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb7-820"><a href="#cb7-820" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-821"><a href="#cb7-821" aria-hidden="true" tabindex="-1"></a>Let's compute the Brier scores for (1) the overall goal rate (i.e. shots per goal) and (2) xG. We should expect the Brier score for the latter to be closer to 0 (perfect model), since xG should be a better predictor of goals than the naive goal rate.</span>
<span id="cb7-822"><a href="#cb7-822" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-825"><a href="#cb7-825" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb7-826"><a href="#cb7-826" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: np_goal_rate_brier_score</span></span>
<span id="cb7-827"><a href="#cb7-827" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: true</span></span>
<span id="cb7-828"><a href="#cb7-828" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb7-829"><a href="#cb7-829" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: show</span></span>
<span id="cb7-830"><a href="#cb7-830" aria-hidden="true" tabindex="-1"></a>np_goal_rate <span class="ot">&lt;-</span> np_shots <span class="sc">|&gt;</span> </span>
<span id="cb7-831"><a href="#cb7-831" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(is_goal) <span class="sc">|&gt;</span> </span>
<span id="cb7-832"><a href="#cb7-832" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prop =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n)) <span class="sc">|&gt;</span> </span>
<span id="cb7-833"><a href="#cb7-833" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(is_goal <span class="sc">==</span> <span class="st">'yes'</span>) <span class="sc">|&gt;</span> </span>
<span id="cb7-834"><a href="#cb7-834" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(prop)</span>
<span id="cb7-835"><a href="#cb7-835" aria-hidden="true" tabindex="-1"></a>np_goal_rate</span>
<span id="cb7-836"><a href="#cb7-836" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 0.0960288</span></span>
<span id="cb7-837"><a href="#cb7-837" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-838"><a href="#cb7-838" aria-hidden="true" tabindex="-1"></a>np_goal_rate_brier_score <span class="ot">&lt;-</span> np_shots <span class="sc">|&gt;</span> </span>
<span id="cb7-839"><a href="#cb7-839" aria-hidden="true" tabindex="-1"></a>  <span class="fu">brier_score</span>(</span>
<span id="cb7-840"><a href="#cb7-840" aria-hidden="true" tabindex="-1"></a>    <span class="at">truth =</span> is_goal,</span>
<span id="cb7-841"><a href="#cb7-841" aria-hidden="true" tabindex="-1"></a>    <span class="at">estimate =</span> <span class="sc">!!</span>np_goal_rate,</span>
<span id="cb7-842"><a href="#cb7-842" aria-hidden="true" tabindex="-1"></a>    <span class="at">event_level =</span> <span class="st">'second'</span></span>
<span id="cb7-843"><a href="#cb7-843" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb7-844"><a href="#cb7-844" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(.estimate)</span>
<span id="cb7-845"><a href="#cb7-845" aria-hidden="true" tabindex="-1"></a>np_goal_rate_brier_score</span>
<span id="cb7-846"><a href="#cb7-846" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 0.08680727</span></span>
<span id="cb7-847"><a href="#cb7-847" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-848"><a href="#cb7-848" aria-hidden="true" tabindex="-1"></a>npxg_brier_score <span class="ot">&lt;-</span> np_shots <span class="sc">|&gt;</span> </span>
<span id="cb7-849"><a href="#cb7-849" aria-hidden="true" tabindex="-1"></a>  <span class="fu">brier_score</span>(</span>
<span id="cb7-850"><a href="#cb7-850" aria-hidden="true" tabindex="-1"></a>    <span class="at">truth =</span> is_goal,</span>
<span id="cb7-851"><a href="#cb7-851" aria-hidden="true" tabindex="-1"></a>    <span class="at">estimate =</span> xg,</span>
<span id="cb7-852"><a href="#cb7-852" aria-hidden="true" tabindex="-1"></a>    <span class="at">event_level =</span> <span class="st">'second'</span></span>
<span id="cb7-853"><a href="#cb7-853" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb7-854"><a href="#cb7-854" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(.estimate)</span>
<span id="cb7-855"><a href="#cb7-855" aria-hidden="true" tabindex="-1"></a>npxg_brier_score</span>
<span id="cb7-856"><a href="#cb7-856" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 0.07150071</span></span>
<span id="cb7-857"><a href="#cb7-857" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb7-858"><a href="#cb7-858" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-859"><a href="#cb7-859" aria-hidden="true" tabindex="-1"></a>Now we can go on to compute <span class="co">[</span><span class="ot">Brier skill score (BSS)</span><span class="co">]</span>(https://en.wikipedia.org/wiki/Brier_score#Brier_Skill_Score_(BSS)) using an appropriate reference Brier score.<span class="ot">[^9]</span> In this context, the average goal rate seems to be a good choice for a baseline. In contrast to the Brier score, a higher BSS is ideal. (A perfect model would have a BSS of 1.)</span>
<span id="cb7-860"><a href="#cb7-860" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-861"><a href="#cb7-861" aria-hidden="true" tabindex="-1"></a><span class="ot">[^9]: </span>Personally, I like to use BSS over other classification metrics like <span class="co">[</span><span class="ot">ROC AUC</span><span class="co">](https://en.wikipedia.org/wiki/Receiver_operating_characteristic)</span> or Brier score alone. BSS is arguably the most interpretable probabilistic classification measure. Also, I like that you have to specify a reference with which to compare, which seems like good principle in general.</span>
<span id="cb7-862"><a href="#cb7-862" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-865"><a href="#cb7-865" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb7-866"><a href="#cb7-866" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: npxg_brier_score</span></span>
<span id="cb7-867"><a href="#cb7-867" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: true</span></span>
<span id="cb7-868"><a href="#cb7-868" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb7-869"><a href="#cb7-869" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: show</span></span>
<span id="cb7-870"><a href="#cb7-870" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="sc">-</span> (npxg_brier_score <span class="sc">/</span> np_goal_rate_brier_score)</span>
<span id="cb7-871"><a href="#cb7-871" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 0.176328</span></span>
<span id="cb7-872"><a href="#cb7-872" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb7-873"><a href="#cb7-873" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-874"><a href="#cb7-874" aria-hidden="true" tabindex="-1"></a>A BSS of \~0.18 is not bad! This is better than <span class="co">[</span><span class="ot">FiveThirtyEight's BSS</span><span class="co">](https://projects.fivethirtyeight.com/checking-our-work/)</span> for predicting the results for men's World Cup matches (\~0.12 at time of writing) and right around their BSS for predicting WNBA playoff game outcomes (\~0.18).<span class="ot">[^10]</span></span>
<span id="cb7-875"><a href="#cb7-875" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-876"><a href="#cb7-876" aria-hidden="true" tabindex="-1"></a><span class="ot">[^10]: </span>I'm perhaps comparing apples to oranges here for the sake of providing some additional context that might help interpretability. The truth is that BSS is only comparable among different tasks to the extent that the reference choice in each task is "uninformed" to the same degree. For example, I could have said that the baseline for goals per shot is 50% instead of the actual goal rate (about 10%). This would change the baseline brier score to 0.25, and would inflate the BSS to 0.71. On the other hand, a 50/50 baseline makes sense in other settings. In fact, that's what FiveThirtyEight uses for match outcome BSS for various sports.</span>
<span id="cb7-877"><a href="#cb7-877" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-878"><a href="#cb7-878" aria-hidden="true" tabindex="-1"></a><span class="fu">### Grouped Calibration and BSS</span></span>
<span id="cb7-879"><a href="#cb7-879" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-880"><a href="#cb7-880" aria-hidden="true" tabindex="-1"></a>Now let's take a look at model calibration under specific criteria. Is the model worse for shots that follow a dribble (<span class="in">`take_on`</span>) shot-creating action? After a <span class="in">`live_ball`</span> pass? etc.</span>
<span id="cb7-881"><a href="#cb7-881" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-884"><a href="#cb7-884" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb7-885"><a href="#cb7-885" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: sca1-calibration</span></span>
<span id="cb7-886"><a href="#cb7-886" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(forcats)</span>
<span id="cb7-887"><a href="#cb7-887" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scales)</span>
<span id="cb7-888"><a href="#cb7-888" aria-hidden="true" tabindex="-1"></a>generate_labels_layer <span class="ot">&lt;-</span> <span class="cf">function</span>(df) {</span>
<span id="cb7-889"><a href="#cb7-889" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(</span>
<span id="cb7-890"><a href="#cb7-890" aria-hidden="true" tabindex="-1"></a>    <span class="at">inherit.aes =</span> <span class="cn">FALSE</span>,</span>
<span id="cb7-891"><a href="#cb7-891" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> df,</span>
<span id="cb7-892"><a href="#cb7-892" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">'white'</span>,</span>
<span id="cb7-893"><a href="#cb7-893" aria-hidden="true" tabindex="-1"></a>    <span class="at">fontface =</span> <span class="st">'italic'</span>,</span>
<span id="cb7-894"><a href="#cb7-894" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">12</span> <span class="sc">/</span> .pt,</span>
<span id="cb7-895"><a href="#cb7-895" aria-hidden="true" tabindex="-1"></a>    <span class="at">hjust =</span> <span class="dv">0</span>,</span>
<span id="cb7-896"><a href="#cb7-896" aria-hidden="true" tabindex="-1"></a>    <span class="at">vjust =</span> <span class="dv">1</span>,</span>
<span id="cb7-897"><a href="#cb7-897" aria-hidden="true" tabindex="-1"></a>    <span class="at">lineheight =</span> <span class="dv">1</span>,</span>
<span id="cb7-898"><a href="#cb7-898" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb7-899"><a href="#cb7-899" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="fl">0.01</span>,</span>
<span id="cb7-900"><a href="#cb7-900" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="fl">0.99</span>,</span>
<span id="cb7-901"><a href="#cb7-901" aria-hidden="true" tabindex="-1"></a>      <span class="at">label =</span> label</span>
<span id="cb7-902"><a href="#cb7-902" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-903"><a href="#cb7-903" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-904"><a href="#cb7-904" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-905"><a href="#cb7-905" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-906"><a href="#cb7-906" aria-hidden="true" tabindex="-1"></a>calculate_then_plot_and_save_calibration <span class="ot">&lt;-</span> <span class="cf">function</span>(df, group, ...) {</span>
<span id="cb7-907"><a href="#cb7-907" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-908"><a href="#cb7-908" aria-hidden="true" tabindex="-1"></a>  group <span class="ot">&lt;-</span> rlang<span class="sc">::</span><span class="fu">enquo</span>(group) </span>
<span id="cb7-909"><a href="#cb7-909" aria-hidden="true" tabindex="-1"></a>  bss <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span> </span>
<span id="cb7-910"><a href="#cb7-910" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(<span class="sc">!!</span>group) <span class="sc">|&gt;</span> </span>
<span id="cb7-911"><a href="#cb7-911" aria-hidden="true" tabindex="-1"></a>    <span class="fu">brier_score</span>(</span>
<span id="cb7-912"><a href="#cb7-912" aria-hidden="true" tabindex="-1"></a>      <span class="at">truth =</span> is_goal,</span>
<span id="cb7-913"><a href="#cb7-913" aria-hidden="true" tabindex="-1"></a>      <span class="at">estimate =</span> xg,</span>
<span id="cb7-914"><a href="#cb7-914" aria-hidden="true" tabindex="-1"></a>      <span class="at">event_level =</span> <span class="st">'second'</span></span>
<span id="cb7-915"><a href="#cb7-915" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb7-916"><a href="#cb7-916" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> </span>
<span id="cb7-917"><a href="#cb7-917" aria-hidden="true" tabindex="-1"></a>    <span class="fu">transmute</span>(</span>
<span id="cb7-918"><a href="#cb7-918" aria-hidden="true" tabindex="-1"></a>      <span class="sc">!!</span>group, </span>
<span id="cb7-919"><a href="#cb7-919" aria-hidden="true" tabindex="-1"></a>      <span class="at">bss =</span>  <span class="dv">1</span> <span class="sc">-</span> (.estimate <span class="sc">/</span> <span class="sc">!!</span>np_goal_rate_brier_score)</span>
<span id="cb7-920"><a href="#cb7-920" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb7-921"><a href="#cb7-921" aria-hidden="true" tabindex="-1"></a>    <span class="fu">inner_join</span>(</span>
<span id="cb7-922"><a href="#cb7-922" aria-hidden="true" tabindex="-1"></a>      df <span class="sc">|&gt;</span> </span>
<span id="cb7-923"><a href="#cb7-923" aria-hidden="true" tabindex="-1"></a>        <span class="fu">group_by</span>(<span class="sc">!!</span>group) <span class="sc">|&gt;</span> </span>
<span id="cb7-924"><a href="#cb7-924" aria-hidden="true" tabindex="-1"></a>        <span class="fu">summarize</span>(</span>
<span id="cb7-925"><a href="#cb7-925" aria-hidden="true" tabindex="-1"></a>          <span class="at">n_shots =</span> <span class="fu">n</span>(), </span>
<span id="cb7-926"><a href="#cb7-926" aria-hidden="true" tabindex="-1"></a>          <span class="at">n_goals =</span> <span class="fu">sum</span>(is_goal <span class="sc">==</span> <span class="st">'yes'</span>)</span>
<span id="cb7-927"><a href="#cb7-927" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">|&gt;</span> </span>
<span id="cb7-928"><a href="#cb7-928" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> </span>
<span id="cb7-929"><a href="#cb7-929" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">goal_rate =</span> n_goals <span class="sc">/</span> n_shots)</span>
<span id="cb7-930"><a href="#cb7-930" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb7-931"><a href="#cb7-931" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb7-932"><a href="#cb7-932" aria-hidden="true" tabindex="-1"></a>      <span class="at">label =</span> <span class="fu">sprintf</span>(</span>
<span id="cb7-933"><a href="#cb7-933" aria-hidden="true" tabindex="-1"></a>        <span class="st">'BSS: %.2f</span><span class="sc">\n</span><span class="st">Shots: %s</span><span class="sc">\n</span><span class="st">Goal rate: %s'</span>, </span>
<span id="cb7-934"><a href="#cb7-934" aria-hidden="true" tabindex="-1"></a>        bss, </span>
<span id="cb7-935"><a href="#cb7-935" aria-hidden="true" tabindex="-1"></a>        scales<span class="sc">::</span><span class="fu">number</span>(n_shots, <span class="at">scale =</span> <span class="fl">0.001</span>, <span class="at">accuracy =</span> <span class="fl">0.1</span>, <span class="at">suffix =</span> <span class="st">'k'</span>, <span class="at">big.mark =</span> <span class="st">','</span>), </span>
<span id="cb7-936"><a href="#cb7-936" aria-hidden="true" tabindex="-1"></a>        scales<span class="sc">::</span><span class="fu">percent</span>(goal_rate, <span class="at">accuracy =</span> <span class="fl">0.1</span>)</span>
<span id="cb7-937"><a href="#cb7-937" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb7-938"><a href="#cb7-938" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb7-939"><a href="#cb7-939" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb7-940"><a href="#cb7-940" aria-hidden="true" tabindex="-1"></a>      <span class="fu">across</span>(</span>
<span id="cb7-941"><a href="#cb7-941" aria-hidden="true" tabindex="-1"></a>        <span class="sc">!!</span>group,</span>
<span id="cb7-942"><a href="#cb7-942" aria-hidden="true" tabindex="-1"></a>        <span class="sc">~</span><span class="fu">fct_reorder</span>(.x, <span class="sc">-</span>bss)</span>
<span id="cb7-943"><a href="#cb7-943" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb7-944"><a href="#cb7-944" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-945"><a href="#cb7-945" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-946"><a href="#cb7-946" aria-hidden="true" tabindex="-1"></a>  lvls <span class="ot">&lt;-</span> bss <span class="sc">|&gt;</span> <span class="fu">pull</span>(<span class="sc">!!</span>group) <span class="sc">|&gt;</span> <span class="fu">levels</span>()</span>
<span id="cb7-947"><a href="#cb7-947" aria-hidden="true" tabindex="-1"></a>  labels_layer <span class="ot">&lt;-</span> <span class="fu">generate_labels_layer</span>(bss)</span>
<span id="cb7-948"><a href="#cb7-948" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-949"><a href="#cb7-949" aria-hidden="true" tabindex="-1"></a>  df <span class="sc">|&gt;</span> </span>
<span id="cb7-950"><a href="#cb7-950" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cal_plot_breaks</span>(</span>
<span id="cb7-951"><a href="#cb7-951" aria-hidden="true" tabindex="-1"></a>      <span class="at">group =</span> <span class="sc">!!</span>group,</span>
<span id="cb7-952"><a href="#cb7-952" aria-hidden="true" tabindex="-1"></a>      <span class="at">truth =</span> is_goal,</span>
<span id="cb7-953"><a href="#cb7-953" aria-hidden="true" tabindex="-1"></a>      <span class="at">estimate =</span> xg,</span>
<span id="cb7-954"><a href="#cb7-954" aria-hidden="true" tabindex="-1"></a>      <span class="at">num_breaks =</span> <span class="dv">20</span>,</span>
<span id="cb7-955"><a href="#cb7-955" aria-hidden="true" tabindex="-1"></a>      <span class="at">conf_level =</span> <span class="fl">0.9</span>,</span>
<span id="cb7-956"><a href="#cb7-956" aria-hidden="true" tabindex="-1"></a>      <span class="at">event_level =</span> <span class="st">'second'</span></span>
<span id="cb7-957"><a href="#cb7-957" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb7-958"><a href="#cb7-958" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pluck</span>(<span class="st">'data'</span>) <span class="sc">|&gt;</span> </span>
<span id="cb7-959"><a href="#cb7-959" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb7-960"><a href="#cb7-960" aria-hidden="true" tabindex="-1"></a>      <span class="fu">across</span>(<span class="sc">!!</span>group, <span class="sc">~</span><span class="fu">factor</span>(.x, <span class="at">levels =</span> <span class="sc">!!</span>lvls))</span>
<span id="cb7-961"><a href="#cb7-961" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb7-962"><a href="#cb7-962" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot_and_save_calibration</span>(</span>
<span id="cb7-963"><a href="#cb7-963" aria-hidden="true" tabindex="-1"></a>      ...,</span>
<span id="cb7-964"><a href="#cb7-964" aria-hidden="true" tabindex="-1"></a>      <span class="at">labels_layer =</span> labels_layer</span>
<span id="cb7-965"><a href="#cb7-965" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-966"><a href="#cb7-966" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-967"><a href="#cb7-967" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-968"><a href="#cb7-968" aria-hidden="true" tabindex="-1"></a>discretized_np_shots <span class="sc">|&gt;</span> </span>
<span id="cb7-969"><a href="#cb7-969" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>(sca1 <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">'missing'</span>, <span class="st">'pass_dead'</span>))) <span class="sc">|&gt;</span> </span>
<span id="cb7-970"><a href="#cb7-970" aria-hidden="true" tabindex="-1"></a>  <span class="fu">calculate_then_plot_and_save_calibration</span>(</span>
<span id="cb7-971"><a href="#cb7-971" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> sca1,</span>
<span id="cb7-972"><a href="#cb7-972" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">'direct shot-creating action'</span>,</span>
<span id="cb7-973"><a href="#cb7-973" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">10</span>,</span>
<span id="cb7-974"><a href="#cb7-974" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> <span class="st">'sca1'</span></span>
<span id="cb7-975"><a href="#cb7-975" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-976"><a href="#cb7-976" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb7-977"><a href="#cb7-977" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-978"><a href="#cb7-978" aria-hidden="true" tabindex="-1"></a><span class="al">![](sca1_calibration.png)</span></span>
<span id="cb7-979"><a href="#cb7-979" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-980"><a href="#cb7-980" aria-hidden="true" tabindex="-1"></a>A couple of observations and thoughts:</span>
<span id="cb7-981"><a href="#cb7-981" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-982"><a href="#cb7-982" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>xG of shots following another shot are over-predicted so much that it causes the BSS to be negative. This means that the model is actually doing worse in its xG assignment than simply predicting naive goal rate for shots after another shot!</span>
<span id="cb7-983"><a href="#cb7-983" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-984"><a href="#cb7-984" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>A relatively "jagged" calibration plot may not correspond with a worse (lower) BSS score; and visa versa, a relatively "smooth" calibration plot may not correspond with a better (higher) BSS.</span>
<span id="cb7-985"><a href="#cb7-985" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-986"><a href="#cb7-986" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>Note that the <span class="in">`fouled`</span> calibration looks jagged for higher predicted xG, but the fact that goals are only scored on about 5% shots immediately following a foul means that inprecise probabilities are not "penalized" quite as much. On the other hand, while the <span class="in">`pass_live`</span> calibration looks relatively smooth, the 10% goal rate following live ball passes (2x the frequency for shots following fouls) means that it is more penalized for imprecision than an otherwise equivalent post-<span class="in">`fouled`</span> shot. In fact, this is <span class="co">[</span><span class="ot">one of the shortcomings of BSS</span><span class="co">](https://en.wikipedia.org/wiki/Brier_score#Shortcomings)</span>---it does not do a great job with evaluation of relatively infrequent events.</span>
<span id="cb7-987"><a href="#cb7-987" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-988"><a href="#cb7-988" aria-hidden="true" tabindex="-1"></a>Next, let's take a look at calibration of shots coming after deflections (of other shots).</span>
<span id="cb7-989"><a href="#cb7-989" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-992"><a href="#cb7-992" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb7-993"><a href="#cb7-993" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: deflection-calibration</span></span>
<span id="cb7-994"><a href="#cb7-994" aria-hidden="true" tabindex="-1"></a>discretized_np_shots <span class="sc">|&gt;</span> </span>
<span id="cb7-995"><a href="#cb7-995" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb7-996"><a href="#cb7-996" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(</span>
<span id="cb7-997"><a href="#cb7-997" aria-hidden="true" tabindex="-1"></a>      is_from_deflection,</span>
<span id="cb7-998"><a href="#cb7-998" aria-hidden="true" tabindex="-1"></a>      <span class="sc">~</span><span class="fu">factor</span>(<span class="fu">sprintf</span>(<span class="st">'Is off deflection? %s'</span>, <span class="fu">as.character</span>(.x)))</span>
<span id="cb7-999"><a href="#cb7-999" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-1000"><a href="#cb7-1000" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb7-1001"><a href="#cb7-1001" aria-hidden="true" tabindex="-1"></a>  <span class="fu">calculate_then_plot_and_save_calibration</span>(</span>
<span id="cb7-1002"><a href="#cb7-1002" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> is_from_deflection,</span>
<span id="cb7-1003"><a href="#cb7-1003" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">'deflection status'</span>,</span>
<span id="cb7-1004"><a href="#cb7-1004" aria-hidden="true" tabindex="-1"></a>    <span class="at">width =</span> <span class="dv">8</span>,</span>
<span id="cb7-1005"><a href="#cb7-1005" aria-hidden="true" tabindex="-1"></a>    <span class="at">height =</span> <span class="dv">8</span> <span class="sc">/</span> <span class="fl">1.5</span>,</span>
<span id="cb7-1006"><a href="#cb7-1006" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> <span class="st">'deflection'</span></span>
<span id="cb7-1007"><a href="#cb7-1007" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-1008"><a href="#cb7-1008" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb7-1009"><a href="#cb7-1009" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1010"><a href="#cb7-1010" aria-hidden="true" tabindex="-1"></a><span class="al">![](deflection_calibration.png)</span></span>
<span id="cb7-1011"><a href="#cb7-1011" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1012"><a href="#cb7-1012" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>The model doesn't seem to be very well calibrated for shots following deflections! Like shots following other shots in the shot-creating action calibration plot, the BSS for shots after deflections is negative. And, perhaps more interestingly, the model seems to underpredict post-deflection shots, which is the opposite of it's general tendency to overpredict. (See the wholistic calibration plot from before.)</span>
<span id="cb7-1013"><a href="#cb7-1013" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>I'd suspect that there's lots of confounders that might explain the lack of calibration after deflections. For one, it could be the case that there are often zero defenders between the shot-taker and keeper for shots following a deflection. As far as I know, the Opta model doesn't have an explicit feature for this.</span>
<span id="cb7-1014"><a href="#cb7-1014" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>It might also be the case that Opta's <span class="co">[</span><span class="ot">"big chance" indicator</span><span class="co">](https://theanalyst.com/eu/2021/07/what-are-expected-goals-xg)</span>---which is not published on FBref but which I suspect take on a value of "yes"/1/true for many post-deflection shots---may have some flaws.</span>
<span id="cb7-1015"><a href="#cb7-1015" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>The high goal rate on shots after deflections relative to the goal rate on all other shots certainly contributes to the negative BSS, as we saw earlier with shots following other shots.</span>
<span id="cb7-1016"><a href="#cb7-1016" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1017"><a href="#cb7-1017" aria-hidden="true" tabindex="-1"></a>Moving on, let's look at calibration of the xG model by groups of leagues, splitting out by tier and gender.</span>
<span id="cb7-1018"><a href="#cb7-1018" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1021"><a href="#cb7-1021" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb7-1022"><a href="#cb7-1022" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: league_group-calibration</span></span>
<span id="cb7-1023"><a href="#cb7-1023" aria-hidden="true" tabindex="-1"></a>discretized_np_shots <span class="sc">|&gt;</span> </span>
<span id="cb7-1024"><a href="#cb7-1024" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb7-1025"><a href="#cb7-1025" aria-hidden="true" tabindex="-1"></a>    <span class="at">league_group =</span> <span class="fu">case_when</span>(</span>
<span id="cb7-1026"><a href="#cb7-1026" aria-hidden="true" tabindex="-1"></a>      league <span class="sc">%in%</span> <span class="fu">sprintf</span>(<span class="st">'%s_1st_M'</span>, <span class="fu">c</span>(<span class="st">'ENG'</span>, <span class="st">'ESP'</span>, <span class="st">'FRA'</span>, <span class="st">'GER'</span>, <span class="st">'ITA'</span>)) <span class="sc">~</span> <span class="st">"Men's 1st tier: ENG, ESP, FRA, GER, ITA (Big 5)"</span>,</span>
<span id="cb7-1027"><a href="#cb7-1027" aria-hidden="true" tabindex="-1"></a>      league <span class="sc">%in%</span> <span class="fu">sprintf</span>(<span class="st">'%s_1st_F'</span>, <span class="fu">c</span>(<span class="st">'ENG'</span>, <span class="st">'USA'</span>)) <span class="sc">~</span> <span class="st">"Women's 1st tier: USA, ENG"</span>,</span>
<span id="cb7-1028"><a href="#cb7-1028" aria-hidden="true" tabindex="-1"></a>      league <span class="sc">==</span> <span class="st">'ENG_2nd_M'</span> <span class="sc">~</span> <span class="st">"Men's 2nd tier: ENG"</span>,</span>
<span id="cb7-1029"><a href="#cb7-1029" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Men's 1st tier: BRA, MEX, NED, POR, USA"</span></span>
<span id="cb7-1030"><a href="#cb7-1030" aria-hidden="true" tabindex="-1"></a>    ) </span>
<span id="cb7-1031"><a href="#cb7-1031" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb7-1032"><a href="#cb7-1032" aria-hidden="true" tabindex="-1"></a>  <span class="fu">calculate_then_plot_and_save_calibration</span>(</span>
<span id="cb7-1033"><a href="#cb7-1033" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> league_group,</span>
<span id="cb7-1034"><a href="#cb7-1034" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">'league'</span>,</span>
<span id="cb7-1035"><a href="#cb7-1035" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="cn">NULL</span>,</span>
<span id="cb7-1036"><a href="#cb7-1036" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">10</span>,</span>
<span id="cb7-1037"><a href="#cb7-1037" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> <span class="st">'league_group'</span></span>
<span id="cb7-1038"><a href="#cb7-1038" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-1039"><a href="#cb7-1039" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb7-1040"><a href="#cb7-1040" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1041"><a href="#cb7-1041" aria-hidden="true" tabindex="-1"></a><span class="al">![](league_group_calibration.png)</span></span>
<span id="cb7-1042"><a href="#cb7-1042" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1043"><a href="#cb7-1043" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="co">[</span><span class="ot">StatsBomb has talked</span><span class="co">](https://statsbomb.com/articles/soccer/analytics-and-modelling-in-womens-football/)</span> about how a "gender-aware" model outperformed a baseline model, so one might expect the calibration of Opta's singular model to be weaker for the women's game. It turns out that while, yes, the calibration seems to be a bit worse for shots in the women's leagues, the overall difference in model performance for men's and women's leagues seems to be trivial for the sample here.</span>
<span id="cb7-1044"><a href="#cb7-1044" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Interestingly, the calibration of the model for non-Big 5 leagues and the English men's Championship league are slightly better according to BSS, although the differences (both visually, with the calibration curve, and with BSS) are very minimal.</span>
<span id="cb7-1045"><a href="#cb7-1045" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1046"><a href="#cb7-1046" aria-hidden="true" tabindex="-1"></a>Finally, let's look at how footedness may play a role in model calibration. As far as I know, whether or not a footed shot is take by a player's primary foot is not an input into the Opta model, so it may be particularly interesting to look at.</span>
<span id="cb7-1047"><a href="#cb7-1047" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1050"><a href="#cb7-1050" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb7-1051"><a href="#cb7-1051" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: footedness-calibration</span></span>
<span id="cb7-1052"><a href="#cb7-1052" aria-hidden="true" tabindex="-1"></a>discretized_np_shots <span class="sc">|&gt;</span> </span>
<span id="cb7-1053"><a href="#cb7-1053" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb7-1054"><a href="#cb7-1054" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span>(body_part <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">'Right Foot'</span>, <span class="st">'Left Foot'</span>) <span class="sc">&amp;</span> is_primary_foot <span class="sc">==</span> <span class="st">'missing'</span>)</span>
<span id="cb7-1055"><a href="#cb7-1055" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb7-1056"><a href="#cb7-1056" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb7-1057"><a href="#cb7-1057" aria-hidden="true" tabindex="-1"></a>    <span class="at">footedness =</span> <span class="fu">case_when</span>(</span>
<span id="cb7-1058"><a href="#cb7-1058" aria-hidden="true" tabindex="-1"></a>      body_part <span class="sc">==</span> <span class="st">'Head'</span> <span class="sc">~</span> <span class="st">'head'</span>,</span>
<span id="cb7-1059"><a href="#cb7-1059" aria-hidden="true" tabindex="-1"></a>      body_part <span class="sc">==</span> <span class="st">'Other'</span> <span class="sc">~</span> <span class="st">'other'</span>,</span>
<span id="cb7-1060"><a href="#cb7-1060" aria-hidden="true" tabindex="-1"></a>      body_part <span class="sc">==</span> <span class="st">'Left Foot'</span> <span class="sc">&amp;</span> is_primary_foot <span class="sc">==</span> <span class="st">'yes'</span> <span class="sc">~</span> <span class="st">'left foot shot, left-footed'</span>,</span>
<span id="cb7-1061"><a href="#cb7-1061" aria-hidden="true" tabindex="-1"></a>      body_part <span class="sc">==</span> <span class="st">'Left Foot'</span> <span class="sc">&amp;</span> is_primary_foot <span class="sc">==</span> <span class="st">'no'</span> <span class="sc">~</span> <span class="st">'left foot shot, right-footed'</span>,</span>
<span id="cb7-1062"><a href="#cb7-1062" aria-hidden="true" tabindex="-1"></a>      body_part <span class="sc">==</span> <span class="st">'Right Foot'</span> <span class="sc">&amp;</span> is_primary_foot <span class="sc">==</span> <span class="st">'yes'</span> <span class="sc">~</span> <span class="st">'right foot shot, right-footed'</span>,</span>
<span id="cb7-1063"><a href="#cb7-1063" aria-hidden="true" tabindex="-1"></a>      body_part <span class="sc">==</span> <span class="st">'Right Foot'</span> <span class="sc">&amp;</span> is_primary_foot <span class="sc">==</span> <span class="st">'no'</span> <span class="sc">~</span> <span class="st">'right foot shot, left-footed'</span></span>
<span id="cb7-1064"><a href="#cb7-1064" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb7-1065"><a href="#cb7-1065" aria-hidden="true" tabindex="-1"></a>      <span class="fu">factor</span>(</span>
<span id="cb7-1066"><a href="#cb7-1066" aria-hidden="true" tabindex="-1"></a>        <span class="at">levels =</span> <span class="fu">c</span>(</span>
<span id="cb7-1067"><a href="#cb7-1067" aria-hidden="true" tabindex="-1"></a>          <span class="st">'head'</span>,</span>
<span id="cb7-1068"><a href="#cb7-1068" aria-hidden="true" tabindex="-1"></a>          <span class="st">'other'</span>,</span>
<span id="cb7-1069"><a href="#cb7-1069" aria-hidden="true" tabindex="-1"></a>          <span class="fu">sprintf</span>(<span class="st">'left foot shot, %s-footed'</span>, <span class="fu">c</span>(<span class="st">'left'</span>, <span class="st">'right'</span>)),</span>
<span id="cb7-1070"><a href="#cb7-1070" aria-hidden="true" tabindex="-1"></a>          <span class="fu">sprintf</span>(<span class="st">'right foot shot, %s-footed'</span>, <span class="fu">c</span>(<span class="st">'right'</span>, <span class="st">'left'</span>))</span>
<span id="cb7-1071"><a href="#cb7-1071" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb7-1072"><a href="#cb7-1072" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb7-1073"><a href="#cb7-1073" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb7-1074"><a href="#cb7-1074" aria-hidden="true" tabindex="-1"></a>  <span class="fu">calculate_then_plot_and_save_calibration</span>(</span>
<span id="cb7-1075"><a href="#cb7-1075" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> footedness,</span>
<span id="cb7-1076"><a href="#cb7-1076" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">'body part and footedness'</span>,</span>
<span id="cb7-1077"><a href="#cb7-1077" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">'Shots taken by both-footed players or missing footedness data not shown.'</span>,</span>
<span id="cb7-1078"><a href="#cb7-1078" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">10</span>,</span>
<span id="cb7-1079"><a href="#cb7-1079" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> <span class="st">'footedness'</span></span>
<span id="cb7-1080"><a href="#cb7-1080" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-1081"><a href="#cb7-1081" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb7-1082"><a href="#cb7-1082" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1083"><a href="#cb7-1083" aria-hidden="true" tabindex="-1"></a><span class="al">![](footedness_calibration.png)</span></span>
<span id="cb7-1084"><a href="#cb7-1084" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1085"><a href="#cb7-1085" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Despite my suspicion that xG for shots taken by a player's weaker foot (<span class="in">`right foot shot, left-footed`</span> and <span class="in">`left foot shot, right-footed`</span>) might be severely overpredicted, this doesn't really seem to be the case. Yes, the model tends to overpredict for these kinds of shots, but the degree to which overprediction occurs doesn't seem out of line with the whole model.</span>
<span id="cb7-1086"><a href="#cb7-1086" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>I can think of least two types of "selection bias" at play here that might explain why the calibration isn't as bad as I might have guessed for weak-footed shots:</span>
<span id="cb7-1087"><a href="#cb7-1087" aria-hidden="true" tabindex="-1"></a><span class="ss">        1.  </span>Players are more likely to take weak-footed shots when they're closer to the goal, where shots are likely to have higher xG, but also where shots are more likely to go in.</span>
<span id="cb7-1088"><a href="#cb7-1088" aria-hidden="true" tabindex="-1"></a><span class="ss">        2.  </span>Players are less likely to take more difficult shots with their weak foot, so they're not taking as many shots that are unlikely to go in, holding all else equal.</span>
<span id="cb7-1089"><a href="#cb7-1089" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Of the non-footed shots, it's interesting to see that the BSS for headers and shots from <span class="in">`other`</span> body parts are not particularly well calibrated. In fact, the latter has a negative BSS, indicating that we'd better off with a model that predicted the average goal rate for such shots.</span>
<span id="cb7-1090"><a href="#cb7-1090" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>A high goal rate on such shots compared to other types of shots seems to, once again, be the reason that BSS looks particularly bad here.</span>
<span id="cb7-1091"><a href="#cb7-1091" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1092"><a href="#cb7-1092" aria-hidden="true" tabindex="-1"></a><span class="fu">## Conclusion</span></span>
<span id="cb7-1093"><a href="#cb7-1093" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1094"><a href="#cb7-1094" aria-hidden="true" tabindex="-1"></a>We've explored the wonderful world of model calibration, making friends with BSS and calibration curves in our investigation of a public xG model. Are BSS and calibration curves the be-all and end-all when it comes to model evaluation? Of course not! But they're useful tools that may or may not be appropriate for your use case.</span>
<span id="cb7-1095"><a href="#cb7-1095" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1096"><a href="#cb7-1096" aria-hidden="true" tabindex="-1"></a>When it comes to the Opta xG model specifically, am I implying that the model is bad? Of course not (again)! Yes, faceted calibration curves and feature-specific BSS can make a model look bad, but we must keep in mind that there are trade-offs to be made with modeling. Fine-tuning a model to be more well calibrated under certain conditions, e.g. shots after deflections, may make other parts of the model worse! It's all about trade-offs.</span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>