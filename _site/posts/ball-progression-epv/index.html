<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Tony ElHabr">
<meta name="dcterms.date" content="2024-04-20">
<meta name="description" content="Identifying where passes (even incomplete ones) have the most positive impact on the pitch.">

<title>Tony’s Blog - Ball Progression is All You Need</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../assets/img/keyboard.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-listing/list.min.js"></script>
<script src="../../site_libs/quarto-listing/quarto-listing.js"></script>
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script>

  window.document.addEventListener("DOMContentLoaded", function (_event) {
    const listingTargetEl = window.document.querySelector('#listing-listing .list');
    if (!listingTargetEl) {
      // No listing discovered, do not attach.
      return; 
    }

    const options = {
      valueNames: [{ data: ['index'] },{ data: ['categories'] },{ data: ['listing-date-sort'] },{ data: ['listing-file-modified-sort'] }],
      
      searchColumns: [],
    };

    window['quarto-listings'] = window['quarto-listings'] || {};
    window['quarto-listings']['listing-listing'] = new List('listing-listing', options);

    if (window['quarto-listing-loaded']) {
      window['quarto-listing-loaded']();
    }
  });

  window.addEventListener('hashchange',() => {
    if (window['quarto-listing-loaded']) {
      window['quarto-listing-loaded']();
    }
  })
  </script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-TKB26G5GZW"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-TKB26G5GZW', { 'anonymize_ip': true});
</script>
<script type="module" src="../../site_libs/quarto-ojs/quarto-ojs-runtime.js"></script>
<link href="../../site_libs/quarto-ojs/quarto-ojs.css" rel="stylesheet">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="alternate" type="application/rss+xml" title="Tony's Blog" href="index.xml"><meta name="twitter:title" content="Tony’s Blog - Ball Progression is All You Need">
<meta name="twitter:description" content="Identifying where passes (even incomplete ones) have the most positive impact on the pitch.">
<meta name="twitter:image" content="https://tonyelhabr.rbind.io/posts/ball-progression-epv/header.png">
<meta name="twitter:site" content="@TonyElHabr">
<meta name="twitter:image-height" content="810">
<meta name="twitter:image-width" content="904">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Tony’s Blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../posts.html" rel="" target="">
 <span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../projects.html" rel="" target="">
 <span class="menu-text">Projects</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/tonyelhabr" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/TonyElHabr" rel="" target=""><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/tony-elhabr/" rel="" target=""><i class="bi bi-linkedin" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#possession-value-pv-for-passes" id="toc-possession-value-pv-for-passes" class="nav-link" data-scroll-target="#possession-value-pv-for-passes">Possession Value (PV) for Passes</a>
  <ul>
  <li><a href="#completed-passes" id="toc-completed-passes" class="nav-link" data-scroll-target="#completed-passes">Completed Passes</a>
  <ul class="collapse">
  <li><a href="#from-one-spot-to-anywhere-on-the-pitch" id="toc-from-one-spot-to-anywhere-on-the-pitch" class="nav-link" data-scroll-target="#from-one-spot-to-anywhere-on-the-pitch">From One Spot, To Anywhere on the Pitch</a></li>
  <li><a href="#from-anywhere-on-the-pitch-to-anywhere-on-the-pitch" id="toc-from-anywhere-on-the-pitch-to-anywhere-on-the-pitch" class="nav-link" data-scroll-target="#from-anywhere-on-the-pitch-to-anywhere-on-the-pitch">From Anywhere on the Pitch, To Anywhere on the Pitch</a></li>
  </ul></li>
  <li><a href="#incomplete-passes" id="toc-incomplete-passes" class="nav-link" data-scroll-target="#incomplete-passes">Incomplete Passes</a>
  <ul class="collapse">
  <li><a href="#from-one-spot-to-anywhere-on-the-pitch-1" id="toc-from-one-spot-to-anywhere-on-the-pitch-1" class="nav-link" data-scroll-target="#from-one-spot-to-anywhere-on-the-pitch-1">From One Spot, To Anywhere on the Pitch</a></li>
  <li><a href="#from-anywhere-on-the-pitch-to-anywhere-on-the-pitch-1" id="toc-from-anywhere-on-the-pitch-to-anywhere-on-the-pitch-1" class="nav-link" data-scroll-target="#from-anywhere-on-the-pitch-to-anywhere-on-the-pitch-1">From Anywhere on the Pitch, To Anywhere on the Pitch</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a>
  <ul>
  <li><a href="#caveats" id="toc-caveats" class="nav-link" data-scroll-target="#caveats">Caveats</a></li>
  </ul></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Ball Progression is All You Need</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button" data-quarto-source-url="https://github.com/tonyelhabr/itsmetoeknee/blob/main/posts/ball-progression-epv/index.qmd">View Source</a></li></ul></div></div>
  <div class="quarto-categories">
    <div class="quarto-category">r</div>
    <div class="quarto-category">soccer</div>
    <div class="quarto-category">observablejs</div>
  </div>
  </div>

<div>
  <div class="description">
    Identifying where passes (even incomplete ones) have the most positive impact on the pitch.
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Tony ElHabr </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">April 20, 2024</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>I’ve written a lot about expected goals (xG) in soccer, but I haven’t yet talked much about <a href="https://statsbomb.com/soccer-metrics/possession-value-models-explained/">possession value (PV) models</a><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>, another big topic in soccer analytics. What are they? Well, every PV model is different, but they all generally try to assign value to every on-ball action on the pitch. Such a model can help inform decisions about how to improve player and team performance.</p>
<p>I heard someone recently say something like “PV models in soccer basically come down to ball progression”. That’s an interesting thought, and I add a hunch that it probably isn’t too wrong.</p>
<p>One way of getting at that idea is to look at how your PV model treats incomplete passes. Does it say that all long passes are “good”? What is the importance of the starting and end points of the pass? How does PV for an unsuccessful pass compare to a successful one, holding all else equal?</p>
<p>I attempt to answer some of these questions with <a href="https://dtai.cs.kuleuven.be/sports/vaep">a VAEP model</a>–an <a href="https://fivethirtyeight.com/features/possession-is-the-puzzle-of-soccer-analytics-these-models-are-trying-to-solve-it/">open-source PV model</a>.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a><a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a></p>
</section>
<section id="possession-value-pv-for-passes" class="level1">
<h1>Possession Value (PV) for Passes</h1>
<section id="completed-passes" class="level2">
<h2 class="anchored" data-anchor-id="completed-passes">Completed Passes</h2>
<p>We’ll want to eventually look at the PV of incomplete passes, but it’s probably easier to start with completed passes, as we have a pretty strong intuition about them–pass the ball successfully closer to the goal, and you’re most likely helping your team (i.e.&nbsp;positive PV).</p>
<section id="from-one-spot-to-anywhere-on-the-pitch" class="level3">
<h3 class="anchored" data-anchor-id="from-one-spot-to-anywhere-on-the-pitch">From One Spot, To Anywhere on the Pitch</h3>
<p>In the interactive 8x12 pitch below, the blue cell illustrates where a pass is made, and the colored cells illustrate the average PV associated with all historicalLY successful passes made to that area. Hovering over a cell shows the PV value above the pitch as well.<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a></p>
<p>Overall, I’d say that this illustration matches intuition–forward completed passes into the final third should be assigned a non-trivial positive value.</p>
<div class="cell" data-include="true">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb1" data-startfrom="819" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 818;"><span id="cb1-819"><a href="#cb1-819" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb1-820"><a href="#cb1-820" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> chart <span class="op">=</span> d3<span class="op">.</span><span class="fu">create</span>(<span class="st">"div"</span>)<span class="op">.</span><span class="fu">style</span>(<span class="st">"background-color"</span><span class="op">,</span> <span class="st">"8f8f8f"</span>)</span>
<span id="cb1-821"><a href="#cb1-821" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> title <span class="op">=</span> chart<span class="op">.</span><span class="fu">append</span>(<span class="st">"div"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"id"</span><span class="op">,</span> <span class="st">"heatmap-title-complete-empirical"</span>)</span>
<span id="cb1-822"><a href="#cb1-822" aria-hidden="true" tabindex="-1"></a>  title<span class="op">.</span><span class="fu">append</span>(<span class="st">"p"</span>)<span class="op">.</span><span class="fu">html</span>(<span class="vs">`PV: &lt;span id='pv-value-complete-empirical'&gt;0&lt;/span&gt;`</span>)</span>
<span id="cb1-823"><a href="#cb1-823" aria-hidden="true" tabindex="-1"></a>  chart<span class="op">.</span><span class="fu">append</span>(<span class="st">"div"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"id"</span><span class="op">,</span> <span class="st">"heatmap-complete-empirical"</span>)</span>
<span id="cb1-824"><a href="#cb1-824" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-825"><a href="#cb1-825" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> legendSwatchContainer <span class="op">=</span> chart<span class="op">.</span><span class="fu">append</span>(<span class="st">"div"</span>)</span>
<span id="cb1-826"><a href="#cb1-826" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"id"</span><span class="op">,</span> <span class="st">"heatmap-legend-complete-empirical"</span>)</span>
<span id="cb1-827"><a href="#cb1-827" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"display"</span><span class="op">,</span> <span class="st">"flex"</span>)</span>
<span id="cb1-828"><a href="#cb1-828" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"flex-direction"</span><span class="op">,</span> <span class="st">"column"</span>)</span>
<span id="cb1-829"><a href="#cb1-829" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"align-items"</span><span class="op">,</span> <span class="st">"center"</span>)</span>
<span id="cb1-830"><a href="#cb1-830" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"width"</span><span class="op">,</span> <span class="st">"100%"</span>)<span class="op">;</span></span>
<span id="cb1-831"><a href="#cb1-831" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-832"><a href="#cb1-832" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> legendRange <span class="op">=</span> [</span>
<span id="cb1-833"><a href="#cb1-833" aria-hidden="true" tabindex="-1"></a>    <span class="fl">1.1</span> <span class="op">*</span> d3<span class="op">.</span><span class="fu">min</span>(colorScaleCompleteRange)<span class="op">,</span></span>
<span id="cb1-834"><a href="#cb1-834" aria-hidden="true" tabindex="-1"></a>    <span class="fl">1.1</span> <span class="op">*</span> d3<span class="op">.</span><span class="fu">max</span>(colorScaleCompleteRange)</span>
<span id="cb1-835"><a href="#cb1-835" aria-hidden="true" tabindex="-1"></a>  ]<span class="op">;</span></span>
<span id="cb1-836"><a href="#cb1-836" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> stepSize <span class="op">=</span> (legendRange[<span class="dv">1</span>] <span class="op">-</span> legendRange[<span class="dv">0</span>]) <span class="op">/</span> (swatchParams<span class="op">.</span><span class="at">num</span> <span class="op">-</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb1-837"><a href="#cb1-837" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> legendSwatches <span class="op">=</span> d3<span class="op">.</span><span class="fu">range</span>(legendRange[<span class="dv">0</span>]<span class="op">,</span> legendRange[<span class="dv">1</span>] <span class="op">+</span> stepSize<span class="op">,</span> stepSize)<span class="op">;</span></span>
<span id="cb1-838"><a href="#cb1-838" aria-hidden="true" tabindex="-1"></a>  legendSwatches[legendSwatches<span class="op">.</span><span class="at">length</span> <span class="op">-</span> <span class="dv">1</span>] <span class="op">=</span> legendRange[<span class="dv">1</span>]<span class="op">;</span></span>
<span id="cb1-839"><a href="#cb1-839" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-840"><a href="#cb1-840" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> totalLegendWidth <span class="op">=</span> swatchParams<span class="op">.</span><span class="at">width</span> <span class="op">*</span> swatchParams<span class="op">.</span><span class="at">num</span><span class="op">;</span></span>
<span id="cb1-841"><a href="#cb1-841" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-842"><a href="#cb1-842" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> swatchRow <span class="op">=</span> legendSwatchContainer<span class="op">.</span><span class="fu">append</span>(<span class="st">"div"</span>)</span>
<span id="cb1-843"><a href="#cb1-843" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"display"</span><span class="op">,</span> <span class="st">"flex"</span>)</span>
<span id="cb1-844"><a href="#cb1-844" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"justify-content"</span><span class="op">,</span> <span class="st">"center"</span>)</span>
<span id="cb1-845"><a href="#cb1-845" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"width"</span><span class="op">,</span> <span class="st">"100%"</span>)<span class="op">;</span></span>
<span id="cb1-846"><a href="#cb1-846" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-847"><a href="#cb1-847" aria-hidden="true" tabindex="-1"></a>  swatchRow<span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"div"</span>)</span>
<span id="cb1-848"><a href="#cb1-848" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">data</span>(legendSwatches)</span>
<span id="cb1-849"><a href="#cb1-849" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">enter</span>()</span>
<span id="cb1-850"><a href="#cb1-850" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">append</span>(<span class="st">"div"</span>)</span>
<span id="cb1-851"><a href="#cb1-851" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"width"</span><span class="op">,</span> <span class="vs">`</span><span class="sc">${</span>swatchParams<span class="op">.</span><span class="at">width</span><span class="sc">}</span><span class="vs">px`</span>)</span>
<span id="cb1-852"><a href="#cb1-852" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"height"</span><span class="op">,</span> <span class="vs">`</span><span class="sc">${</span>swatchParams<span class="op">.</span><span class="at">height</span><span class="sc">}</span><span class="vs">px`</span>)</span>
<span id="cb1-853"><a href="#cb1-853" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"background-color"</span><span class="op">,</span> d <span class="kw">=&gt;</span> <span class="fu">colorScaleComplete</span>(d))<span class="op">;</span></span>
<span id="cb1-854"><a href="#cb1-854" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-855"><a href="#cb1-855" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> labelRow <span class="op">=</span> legendSwatchContainer<span class="op">.</span><span class="fu">append</span>(<span class="st">"div"</span>)</span>
<span id="cb1-856"><a href="#cb1-856" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"display"</span><span class="op">,</span> <span class="st">"flex"</span>)</span>
<span id="cb1-857"><a href="#cb1-857" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"justify-content"</span><span class="op">,</span> <span class="st">"center"</span>)</span>
<span id="cb1-858"><a href="#cb1-858" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"width"</span><span class="op">,</span> <span class="vs">`</span><span class="sc">${</span>totalLegendWidth<span class="sc">}</span><span class="vs">px`</span>)<span class="op">;</span></span>
<span id="cb1-859"><a href="#cb1-859" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-860"><a href="#cb1-860" aria-hidden="true" tabindex="-1"></a>  labelRow<span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"span"</span>)</span>
<span id="cb1-861"><a href="#cb1-861" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">data</span>(colorScaleCompleteRange)</span>
<span id="cb1-862"><a href="#cb1-862" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">enter</span>()</span>
<span id="cb1-863"><a href="#cb1-863" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">append</span>(<span class="st">"span"</span>)</span>
<span id="cb1-864"><a href="#cb1-864" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">text</span>(d <span class="kw">=&gt;</span> {</span>
<span id="cb1-865"><a href="#cb1-865" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (d <span class="op">===</span> d3<span class="op">.</span><span class="fu">min</span>(colorScaleCompleteRange)) {</span>
<span id="cb1-866"><a href="#cb1-866" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> d <span class="op">+</span> <span class="st">" &lt;="</span><span class="op">;</span></span>
<span id="cb1-867"><a href="#cb1-867" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (d <span class="op">===</span> d3<span class="op">.</span><span class="fu">max</span>(colorScaleCompleteRange)) {</span>
<span id="cb1-868"><a href="#cb1-868" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"&gt;= "</span> <span class="op">+</span> d<span class="op">;</span></span>
<span id="cb1-869"><a href="#cb1-869" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb1-870"><a href="#cb1-870" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> d<span class="op">;</span></span>
<span id="cb1-871"><a href="#cb1-871" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb1-872"><a href="#cb1-872" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"flex"</span><span class="op">,</span> d <span class="kw">=&gt;</span> d <span class="op">===</span> <span class="dv">0</span> <span class="op">?</span> <span class="st">"1"</span> <span class="op">:</span> <span class="kw">null</span>)</span>
<span id="cb1-873"><a href="#cb1-873" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"text-align"</span><span class="op">,</span> <span class="st">"center"</span>)</span>
<span id="cb1-874"><a href="#cb1-874" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-875"><a href="#cb1-875" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> chart<span class="op">.</span><span class="fu">node</span>()<span class="op">;</span></span>
<span id="cb1-876"><a href="#cb1-876" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="fig-ojs-cell-1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<div id="ojs-cell-1" data-nodetype="expression">

</div>
<figcaption class="figure-caption">Figure&nbsp;1: A heatmap showing the average possession value (PV) of historically completed passes from the center spot (annotated in blue) to all areas on the pitch. The relative frequency of successful passes from the center spot to each other cell is shown as a percentage. The exact PV value associated with a complete pass ending at the hover point can be viewed above the pitch. Black cells represent areas to which successful passes from the center spot have never been made.</figcaption>
</figure>
</div>
</div>
<div class="cell">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb2" data-startfrom="882" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 881;"><span id="cb2-882"><a href="#cb2-882" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb2-883"><a href="#cb2-883" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> heatmap_complete_empirical <span class="op">=</span> d3_soccer<span class="op">.</span><span class="fu">heatmap</span>(pitch)</span>
<span id="cb2-884"><a href="#cb2-884" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">colorScale</span>(colorScaleComplete)</span>
<span id="cb2-885"><a href="#cb2-885" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">enableInteraction</span>(<span class="kw">true</span>)</span>
<span id="cb2-886"><a href="#cb2-886" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">onSelect</span>((x<span class="op">,</span> y<span class="op">,</span> v) <span class="kw">=&gt;</span> {</span>
<span id="cb2-887"><a href="#cb2-887" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> cappedValue <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">min</span>(<span class="bu">Math</span><span class="op">.</span><span class="fu">max</span>(v<span class="op">,</span> <span class="op">-</span><span class="dv">1</span>)<span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb2-888"><a href="#cb2-888" aria-hidden="true" tabindex="-1"></a>      d3<span class="op">.</span><span class="fu">select</span>(<span class="st">"#pv-value-complete-empirical"</span>)<span class="op">.</span><span class="fu">text</span>(cappedValue<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">3</span>))<span class="op">;</span></span>
<span id="cb2-889"><a href="#cb2-889" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb2-890"><a href="#cb2-890" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">parent_el</span>(<span class="st">"#heatmap-complete-empirical"</span>)</span>
<span id="cb2-891"><a href="#cb2-891" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">interpolate</span>(<span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb2-892"><a href="#cb2-892" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-893"><a href="#cb2-893" aria-hidden="true" tabindex="-1"></a>  d3<span class="op">.</span><span class="fu">select</span>(<span class="st">"#heatmap-complete-empirical"</span>)</span>
<span id="cb2-894"><a href="#cb2-894" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">html</span>(<span class="st">""</span>)</span>
<span id="cb2-895"><a href="#cb2-895" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">datum</span>(complete_empirical_pv_data)</span>
<span id="cb2-896"><a href="#cb2-896" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">call</span>(heatmap_complete_empirical)<span class="op">;</span></span>
<span id="cb2-897"><a href="#cb2-897" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-898"><a href="#cb2-898" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> svg <span class="op">=</span> d3<span class="op">.</span><span class="fu">select</span>(<span class="st">"#heatmap-complete-empirical"</span>)<span class="op">.</span><span class="fu">select</span>(<span class="st">"svg"</span>)<span class="op">;</span></span>
<span id="cb2-899"><a href="#cb2-899" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-900"><a href="#cb2-900" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> cells <span class="op">=</span> svg<span class="op">.</span><span class="fu">selectAll</span>(<span class="st">".cell"</span>)<span class="op">;</span></span>
<span id="cb2-901"><a href="#cb2-901" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-902"><a href="#cb2-902" aria-hidden="true" tabindex="-1"></a>  cells<span class="op">.</span><span class="fu">each</span>(<span class="kw">function</span>(d<span class="op">,</span> i) {</span>
<span id="cb2-903"><a href="#cb2-903" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> cell <span class="op">=</span> d3<span class="op">.</span><span class="fu">select</span>(<span class="kw">this</span>)<span class="op">;</span></span>
<span id="cb2-904"><a href="#cb2-904" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> bbox <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getBBox</span>()<span class="op">;</span></span>
<span id="cb2-905"><a href="#cb2-905" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-906"><a href="#cb2-906" aria-hidden="true" tabindex="-1"></a>    d3<span class="op">.</span><span class="fu">select</span>(<span class="kw">this</span><span class="op">.</span><span class="at">parentNode</span>)</span>
<span id="cb2-907"><a href="#cb2-907" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">append</span>(<span class="st">"text"</span>)</span>
<span id="cb2-908"><a href="#cb2-908" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> bbox<span class="op">.</span><span class="at">x</span> <span class="op">+</span> bbox<span class="op">.</span><span class="at">width</span> <span class="op">/</span> <span class="dv">2</span>)</span>
<span id="cb2-909"><a href="#cb2-909" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> bbox<span class="op">.</span><span class="at">y</span> <span class="op">+</span> bbox<span class="op">.</span><span class="at">height</span> <span class="op">/</span> <span class="dv">2</span>)</span>
<span id="cb2-910"><a href="#cb2-910" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"text-anchor"</span><span class="op">,</span> <span class="st">"middle"</span>)</span>
<span id="cb2-911"><a href="#cb2-911" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"alignment-baseline"</span><span class="op">,</span> <span class="st">"central"</span>)</span>
<span id="cb2-912"><a href="#cb2-912" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">style</span>(<span class="st">"font-size"</span><span class="op">,</span> <span class="st">"3px"</span>)</span>
<span id="cb2-913"><a href="#cb2-913" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">style</span>(<span class="st">"pointer-events"</span><span class="op">,</span> <span class="st">"none"</span>)</span>
<span id="cb2-914"><a href="#cb2-914" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">text</span>((d<span class="op">.</span><span class="at">prop</span> <span class="op">*</span> <span class="dv">100</span>)<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">1</span>) <span class="op">+</span> <span class="st">"%"</span>)<span class="op">;</span></span>
<span id="cb2-915"><a href="#cb2-915" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb2-916"><a href="#cb2-916" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-917"><a href="#cb2-917" aria-hidden="true" tabindex="-1"></a>  svg<span class="op">.</span><span class="fu">append</span>(<span class="st">"rect"</span>)</span>
<span id="cb2-918"><a href="#cb2-918" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> passStartParams<span class="op">.</span><span class="at">x</span>)</span>
<span id="cb2-919"><a href="#cb2-919" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> passStartParams<span class="op">.</span><span class="at">y</span>)</span>
<span id="cb2-920"><a href="#cb2-920" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"width"</span><span class="op">,</span> cellParams<span class="op">.</span><span class="at">width</span>)</span>
<span id="cb2-921"><a href="#cb2-921" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"height"</span><span class="op">,</span> cellParams<span class="op">.</span><span class="at">height</span>)</span>
<span id="cb2-922"><a href="#cb2-922" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"stroke"</span><span class="op">,</span> <span class="st">"blue"</span>)</span>
<span id="cb2-923"><a href="#cb2-923" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"fill"</span><span class="op">,</span> <span class="st">"none"</span>)</span>
<span id="cb2-924"><a href="#cb2-924" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"stroke-width"</span><span class="op">,</span> <span class="st">"1px"</span>)<span class="op">;</span></span>
<span id="cb2-925"><a href="#cb2-925" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display hidden">
<div id="ojs-cell-2" data-nodetype="expression">

</div>
</div>
</div>
<p>Note that the gradient in the pitch above is for PV, not for the relative frequency of completed passes from the center spot, which is instead shown as overlayed text. While passes into the box from the center spot have really strong positive PV, they’re uncommon because defenders are generally looking to stop those kinds of threatening passes.</p>
<p>The gradient in the plot below illustrates the relative frequency of successful passes from the center spot directly.</p>
<div class="cell" data-include="true">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb3" data-startfrom="935" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 934;"><span id="cb3-935"><a href="#cb3-935" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb3-936"><a href="#cb3-936" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> chart <span class="op">=</span> d3<span class="op">.</span><span class="fu">create</span>(<span class="st">"div"</span>)<span class="op">.</span><span class="fu">style</span>(<span class="st">"background-color"</span><span class="op">,</span> <span class="st">"8f8f8f"</span>)</span>
<span id="cb3-937"><a href="#cb3-937" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> title <span class="op">=</span> chart<span class="op">.</span><span class="fu">append</span>(<span class="st">"div"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"id"</span><span class="op">,</span> <span class="st">"heatmap-title-complete-empirical-prop"</span>)</span>
<span id="cb3-938"><a href="#cb3-938" aria-hidden="true" tabindex="-1"></a>  chart<span class="op">.</span><span class="fu">append</span>(<span class="st">"div"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"id"</span><span class="op">,</span> <span class="st">"heatmap-complete-empirical-prop"</span>)</span>
<span id="cb3-939"><a href="#cb3-939" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-940"><a href="#cb3-940" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> chart<span class="op">.</span><span class="fu">node</span>()<span class="op">;</span></span>
<span id="cb3-941"><a href="#cb3-941" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="fig-ojs-cell-3" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<div id="ojs-cell-3" data-nodetype="expression">

</div>
<figcaption class="figure-caption">Figure&nbsp;2: A heatmap where the gradient and text illustrate the relative frequency of historically successful passes from the center spot (annotated in blue) to all areas on the pitch. Black cells represent areas to which successful passes from the center spot have never been made.</figcaption>
</figure>
</div>
</div>
<div class="cell">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb4" data-startfrom="947" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 946;"><span id="cb4-947"><a href="#cb4-947" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb4-948"><a href="#cb4-948" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> colorScaleSeq <span class="op">=</span> d3<span class="op">.</span><span class="fu">scaleSequential</span>(d3<span class="op">.</span><span class="fu">interpolateRgb</span>(<span class="st">"white"</span><span class="op">,</span> <span class="st">"gold"</span>))</span>
<span id="cb4-949"><a href="#cb4-949" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">domain</span>([<span class="dv">0</span><span class="op">,</span> <span class="fl">0.1</span>])</span>
<span id="cb4-950"><a href="#cb4-950" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">clamp</span>(<span class="kw">true</span>)</span>
<span id="cb4-951"><a href="#cb4-951" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> heatmap_complete_empirical_prop <span class="op">=</span> d3_soccer<span class="op">.</span><span class="fu">heatmap</span>(pitch)</span>
<span id="cb4-952"><a href="#cb4-952" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">colorScale</span>(colorScaleSeq)</span>
<span id="cb4-953"><a href="#cb4-953" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">enableInteraction</span>(<span class="kw">false</span>)</span>
<span id="cb4-954"><a href="#cb4-954" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">parent_el</span>(<span class="st">"#heatmap-complete-empirical-prop"</span>)</span>
<span id="cb4-955"><a href="#cb4-955" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">interpolate</span>(<span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb4-956"><a href="#cb4-956" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-957"><a href="#cb4-957" aria-hidden="true" tabindex="-1"></a>  d3<span class="op">.</span><span class="fu">select</span>(<span class="st">"#heatmap-complete-empirical-prop"</span>)</span>
<span id="cb4-958"><a href="#cb4-958" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">html</span>(<span class="st">""</span>)</span>
<span id="cb4-959"><a href="#cb4-959" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">datum</span>(complete_empirical_prop_data)</span>
<span id="cb4-960"><a href="#cb4-960" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">call</span>(heatmap_complete_empirical_prop)<span class="op">;</span></span>
<span id="cb4-961"><a href="#cb4-961" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-962"><a href="#cb4-962" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> svg <span class="op">=</span> d3<span class="op">.</span><span class="fu">select</span>(<span class="st">"#heatmap-complete-empirical-prop"</span>)<span class="op">.</span><span class="fu">select</span>(<span class="st">"svg"</span>)<span class="op">;</span></span>
<span id="cb4-963"><a href="#cb4-963" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-964"><a href="#cb4-964" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> cells <span class="op">=</span> svg<span class="op">.</span><span class="fu">selectAll</span>(<span class="st">".cell"</span>)<span class="op">;</span></span>
<span id="cb4-965"><a href="#cb4-965" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-966"><a href="#cb4-966" aria-hidden="true" tabindex="-1"></a>  cells<span class="op">.</span><span class="fu">each</span>(<span class="kw">function</span>(d<span class="op">,</span> i) {</span>
<span id="cb4-967"><a href="#cb4-967" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> cell <span class="op">=</span> d3<span class="op">.</span><span class="fu">select</span>(<span class="kw">this</span>)<span class="op">;</span></span>
<span id="cb4-968"><a href="#cb4-968" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> bbox <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getBBox</span>()<span class="op">;</span></span>
<span id="cb4-969"><a href="#cb4-969" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-970"><a href="#cb4-970" aria-hidden="true" tabindex="-1"></a>    d3<span class="op">.</span><span class="fu">select</span>(<span class="kw">this</span><span class="op">.</span><span class="at">parentNode</span>)</span>
<span id="cb4-971"><a href="#cb4-971" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">append</span>(<span class="st">"text"</span>)</span>
<span id="cb4-972"><a href="#cb4-972" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> bbox<span class="op">.</span><span class="at">x</span> <span class="op">+</span> bbox<span class="op">.</span><span class="at">width</span> <span class="op">/</span> <span class="dv">2</span>)</span>
<span id="cb4-973"><a href="#cb4-973" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> bbox<span class="op">.</span><span class="at">y</span> <span class="op">+</span> bbox<span class="op">.</span><span class="at">height</span> <span class="op">/</span> <span class="dv">2</span>)</span>
<span id="cb4-974"><a href="#cb4-974" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"text-anchor"</span><span class="op">,</span> <span class="st">"middle"</span>)</span>
<span id="cb4-975"><a href="#cb4-975" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"alignment-baseline"</span><span class="op">,</span> <span class="st">"central"</span>)</span>
<span id="cb4-976"><a href="#cb4-976" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">style</span>(<span class="st">"font-size"</span><span class="op">,</span> <span class="st">"3px"</span>)</span>
<span id="cb4-977"><a href="#cb4-977" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">style</span>(<span class="st">"pointer-events"</span><span class="op">,</span> <span class="st">"none"</span>)</span>
<span id="cb4-978"><a href="#cb4-978" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">text</span>((d<span class="op">.</span><span class="at">prop</span> <span class="op">*</span> <span class="dv">100</span>)<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">1</span>) <span class="op">+</span> <span class="st">"%"</span>)<span class="op">;</span></span>
<span id="cb4-979"><a href="#cb4-979" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb4-980"><a href="#cb4-980" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-981"><a href="#cb4-981" aria-hidden="true" tabindex="-1"></a>  svg<span class="op">.</span><span class="fu">append</span>(<span class="st">"rect"</span>)</span>
<span id="cb4-982"><a href="#cb4-982" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> passStartParams<span class="op">.</span><span class="at">x</span>)</span>
<span id="cb4-983"><a href="#cb4-983" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> passStartParams<span class="op">.</span><span class="at">y</span>)</span>
<span id="cb4-984"><a href="#cb4-984" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"width"</span><span class="op">,</span> cellParams<span class="op">.</span><span class="at">width</span>)</span>
<span id="cb4-985"><a href="#cb4-985" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"height"</span><span class="op">,</span> cellParams<span class="op">.</span><span class="at">height</span>)</span>
<span id="cb4-986"><a href="#cb4-986" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"stroke"</span><span class="op">,</span> <span class="st">"blue"</span>)</span>
<span id="cb4-987"><a href="#cb4-987" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"fill"</span><span class="op">,</span> <span class="st">"none"</span>)</span>
<span id="cb4-988"><a href="#cb4-988" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"stroke-width"</span><span class="op">,</span> <span class="st">"1px"</span>)<span class="op">;</span></span>
<span id="cb4-989"><a href="#cb4-989" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display hidden">
<div id="ojs-cell-4" data-nodetype="expression">

</div>
</div>
</div>
</section>
<section id="from-anywhere-on-the-pitch-to-anywhere-on-the-pitch" class="level3">
<h3 class="anchored" data-anchor-id="from-anywhere-on-the-pitch-to-anywhere-on-the-pitch">From Anywhere on the Pitch, To Anywhere on the Pitch</h3>
<p>Now, to give the full picture, the interactive pitch below dynamically updates to show the average PV values associated with a pass starting from <strong>any</strong> cell that you hover over. The minimum and maximum PV achieved with a successful pass from the hovered spot are shown in the text above the pitch.</p>
<div class="cell" data-include="true">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb5" data-startfrom="999" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 998;"><span id="cb5-999"><a href="#cb5-999" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb5-1000"><a href="#cb5-1000" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> chart <span class="op">=</span> d3<span class="op">.</span><span class="fu">create</span>(<span class="st">"div"</span>)<span class="op">.</span><span class="fu">style</span>(<span class="st">"background-color"</span><span class="op">,</span> <span class="st">"8f8f8f"</span>)</span>
<span id="cb5-1001"><a href="#cb5-1001" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> title <span class="op">=</span> chart<span class="op">.</span><span class="fu">append</span>(<span class="st">"div"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"id"</span><span class="op">,</span> <span class="st">"heatmap-title-complete-empirical-nested"</span>)</span>
<span id="cb5-1002"><a href="#cb5-1002" aria-hidden="true" tabindex="-1"></a>  title<span class="op">.</span><span class="fu">append</span>(<span class="st">"p"</span>)<span class="op">.</span><span class="fu">html</span>(<span class="vs">`min PV: &lt;span id='pv-min-complete-empirical-nested'&gt;0&lt;/span&gt;, max PV: &lt;span id='pv-max-complete-empirical-nested'&gt;0&lt;/span&gt;`</span>)</span>
<span id="cb5-1003"><a href="#cb5-1003" aria-hidden="true" tabindex="-1"></a>  chart<span class="op">.</span><span class="fu">append</span>(<span class="st">"div"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"id"</span><span class="op">,</span> <span class="st">"heatmap-complete-empirical-nested"</span>)</span>
<span id="cb5-1004"><a href="#cb5-1004" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-1005"><a href="#cb5-1005" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> legendSwatchContainer <span class="op">=</span> chart<span class="op">.</span><span class="fu">append</span>(<span class="st">"div"</span>)</span>
<span id="cb5-1006"><a href="#cb5-1006" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"id"</span><span class="op">,</span> <span class="st">"heatmap-legend-complete-empirical-nested"</span>)</span>
<span id="cb5-1007"><a href="#cb5-1007" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"display"</span><span class="op">,</span> <span class="st">"flex"</span>)</span>
<span id="cb5-1008"><a href="#cb5-1008" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"flex-direction"</span><span class="op">,</span> <span class="st">"column"</span>)</span>
<span id="cb5-1009"><a href="#cb5-1009" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"align-items"</span><span class="op">,</span> <span class="st">"center"</span>)</span>
<span id="cb5-1010"><a href="#cb5-1010" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"width"</span><span class="op">,</span> <span class="st">"100%"</span>)<span class="op">;</span></span>
<span id="cb5-1011"><a href="#cb5-1011" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-1012"><a href="#cb5-1012" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> legendRange <span class="op">=</span> [</span>
<span id="cb5-1013"><a href="#cb5-1013" aria-hidden="true" tabindex="-1"></a>    <span class="fl">1.1</span> <span class="op">*</span> d3<span class="op">.</span><span class="fu">min</span>(colorScaleCompleteRange)<span class="op">,</span></span>
<span id="cb5-1014"><a href="#cb5-1014" aria-hidden="true" tabindex="-1"></a>    <span class="fl">1.1</span> <span class="op">*</span> d3<span class="op">.</span><span class="fu">max</span>(colorScaleCompleteRange)</span>
<span id="cb5-1015"><a href="#cb5-1015" aria-hidden="true" tabindex="-1"></a>  ]<span class="op">;</span></span>
<span id="cb5-1016"><a href="#cb5-1016" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> stepSize <span class="op">=</span> (legendRange[<span class="dv">1</span>] <span class="op">-</span> legendRange[<span class="dv">0</span>]) <span class="op">/</span> (swatchParams<span class="op">.</span><span class="at">num</span> <span class="op">-</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb5-1017"><a href="#cb5-1017" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> legendSwatches <span class="op">=</span> d3<span class="op">.</span><span class="fu">range</span>(legendRange[<span class="dv">0</span>]<span class="op">,</span> legendRange[<span class="dv">1</span>] <span class="op">+</span> stepSize<span class="op">,</span> stepSize)<span class="op">;</span></span>
<span id="cb5-1018"><a href="#cb5-1018" aria-hidden="true" tabindex="-1"></a>  legendSwatches[legendSwatches<span class="op">.</span><span class="at">length</span> <span class="op">-</span> <span class="dv">1</span>] <span class="op">=</span> legendRange[<span class="dv">1</span>]<span class="op">;</span></span>
<span id="cb5-1019"><a href="#cb5-1019" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-1020"><a href="#cb5-1020" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> totalLegendWidth <span class="op">=</span> swatchParams<span class="op">.</span><span class="at">width</span> <span class="op">*</span> swatchParams<span class="op">.</span><span class="at">num</span><span class="op">;</span></span>
<span id="cb5-1021"><a href="#cb5-1021" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-1022"><a href="#cb5-1022" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> swatchRow <span class="op">=</span> legendSwatchContainer<span class="op">.</span><span class="fu">append</span>(<span class="st">"div"</span>)</span>
<span id="cb5-1023"><a href="#cb5-1023" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"display"</span><span class="op">,</span> <span class="st">"flex"</span>)</span>
<span id="cb5-1024"><a href="#cb5-1024" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"justify-content"</span><span class="op">,</span> <span class="st">"center"</span>)</span>
<span id="cb5-1025"><a href="#cb5-1025" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"width"</span><span class="op">,</span> <span class="st">"100%"</span>)<span class="op">;</span></span>
<span id="cb5-1026"><a href="#cb5-1026" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-1027"><a href="#cb5-1027" aria-hidden="true" tabindex="-1"></a>  swatchRow<span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"div"</span>)</span>
<span id="cb5-1028"><a href="#cb5-1028" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">data</span>(legendSwatches)</span>
<span id="cb5-1029"><a href="#cb5-1029" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">enter</span>()</span>
<span id="cb5-1030"><a href="#cb5-1030" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">append</span>(<span class="st">"div"</span>)</span>
<span id="cb5-1031"><a href="#cb5-1031" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"width"</span><span class="op">,</span> <span class="vs">`</span><span class="sc">${</span>swatchParams<span class="op">.</span><span class="at">width</span><span class="sc">}</span><span class="vs">px`</span>)</span>
<span id="cb5-1032"><a href="#cb5-1032" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"height"</span><span class="op">,</span> <span class="vs">`</span><span class="sc">${</span>swatchParams<span class="op">.</span><span class="at">height</span><span class="sc">}</span><span class="vs">px`</span>)</span>
<span id="cb5-1033"><a href="#cb5-1033" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"background-color"</span><span class="op">,</span> d <span class="kw">=&gt;</span> <span class="fu">colorScaleComplete</span>(d))<span class="op">;</span></span>
<span id="cb5-1034"><a href="#cb5-1034" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-1035"><a href="#cb5-1035" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> labelRow <span class="op">=</span> legendSwatchContainer<span class="op">.</span><span class="fu">append</span>(<span class="st">"div"</span>)</span>
<span id="cb5-1036"><a href="#cb5-1036" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"display"</span><span class="op">,</span> <span class="st">"flex"</span>)</span>
<span id="cb5-1037"><a href="#cb5-1037" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"justify-content"</span><span class="op">,</span> <span class="st">"center"</span>)</span>
<span id="cb5-1038"><a href="#cb5-1038" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"width"</span><span class="op">,</span> <span class="vs">`</span><span class="sc">${</span>totalLegendWidth<span class="sc">}</span><span class="vs">px`</span>)<span class="op">;</span></span>
<span id="cb5-1039"><a href="#cb5-1039" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-1040"><a href="#cb5-1040" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-1041"><a href="#cb5-1041" aria-hidden="true" tabindex="-1"></a>  labelRow<span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"span"</span>)</span>
<span id="cb5-1042"><a href="#cb5-1042" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">data</span>(colorScaleCompleteRange)</span>
<span id="cb5-1043"><a href="#cb5-1043" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">enter</span>()</span>
<span id="cb5-1044"><a href="#cb5-1044" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">append</span>(<span class="st">"span"</span>)</span>
<span id="cb5-1045"><a href="#cb5-1045" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">text</span>(d <span class="kw">=&gt;</span> {</span>
<span id="cb5-1046"><a href="#cb5-1046" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (d <span class="op">===</span> d3<span class="op">.</span><span class="fu">min</span>(colorScaleCompleteRange)) {</span>
<span id="cb5-1047"><a href="#cb5-1047" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> d <span class="op">+</span> <span class="st">" &lt;="</span><span class="op">;</span></span>
<span id="cb5-1048"><a href="#cb5-1048" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (d <span class="op">===</span> d3<span class="op">.</span><span class="fu">max</span>(colorScaleCompleteRange)) {</span>
<span id="cb5-1049"><a href="#cb5-1049" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"&gt;= "</span> <span class="op">+</span> d<span class="op">;</span></span>
<span id="cb5-1050"><a href="#cb5-1050" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb5-1051"><a href="#cb5-1051" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> d<span class="op">;</span></span>
<span id="cb5-1052"><a href="#cb5-1052" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb5-1053"><a href="#cb5-1053" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"flex"</span><span class="op">,</span> d <span class="kw">=&gt;</span> d <span class="op">===</span> <span class="dv">0</span> <span class="op">?</span> <span class="st">"1"</span> <span class="op">:</span> <span class="kw">null</span>)</span>
<span id="cb5-1054"><a href="#cb5-1054" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"text-align"</span><span class="op">,</span> <span class="st">"center"</span>)</span>
<span id="cb5-1055"><a href="#cb5-1055" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-1056"><a href="#cb5-1056" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> chart<span class="op">.</span><span class="fu">node</span>()<span class="op">;</span></span>
<span id="cb5-1057"><a href="#cb5-1057" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-1058"><a href="#cb5-1058" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="fig-ojs-cell-5" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<div id="ojs-cell-5" data-nodetype="expression">

</div>
<figcaption class="figure-caption">Figure&nbsp;3: A heatmap showing the average possession value (PV) of historically completed pass from the hover spot to all areas on the pitch. The relative frequency of successful passes from the center spot to each other cell is shown as a percentage. The highest and lowest PV values across all end points associated with a completed pass from the hover point are shown above the pitch. Black cells represent areas to which successful passes from the hover spot have never been made.</figcaption>
</figure>
</div>
</div>
<div class="cell">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb6" data-startfrom="1064" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1063;"><span id="cb6-1064"><a href="#cb6-1064" aria-hidden="true" tabindex="-1"></a>{  </span>
<span id="cb6-1065"><a href="#cb6-1065" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> heatmap_complete_empirical_nested <span class="op">=</span> d3_soccer<span class="op">.</span><span class="fu">heatmap</span>(pitch)</span>
<span id="cb6-1066"><a href="#cb6-1066" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">colorScale</span>(d3<span class="op">.</span><span class="fu">scaleLinear</span>()<span class="op">.</span><span class="fu">domain</span>([<span class="op">-</span><span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>])<span class="op">.</span><span class="fu">range</span>([<span class="st">"white"</span><span class="op">,</span> <span class="st">"white"</span>]))</span>
<span id="cb6-1067"><a href="#cb6-1067" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">enableInteraction</span>(<span class="kw">true</span>)</span>
<span id="cb6-1068"><a href="#cb6-1068" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">onSelect</span>((x<span class="op">,</span> y<span class="op">,</span> v) <span class="kw">=&gt;</span> {</span>
<span id="cb6-1069"><a href="#cb6-1069" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> rawMinValue <span class="op">=</span> d3<span class="op">.</span><span class="fu">min</span>(v<span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">value</span>)<span class="op">;</span></span>
<span id="cb6-1070"><a href="#cb6-1070" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> rawMaxValue <span class="op">=</span> d3<span class="op">.</span><span class="fu">max</span>(v<span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">value</span>)<span class="op">;</span></span>
<span id="cb6-1071"><a href="#cb6-1071" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> minValue <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">max</span>(rawMinValue<span class="op">,</span> <span class="op">-</span><span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb6-1072"><a href="#cb6-1072" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> maxValue <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">min</span>(rawMaxValue<span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb6-1073"><a href="#cb6-1073" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-1074"><a href="#cb6-1074" aria-hidden="true" tabindex="-1"></a>      d3<span class="op">.</span><span class="fu">select</span>(<span class="st">"#pv-min-complete-empirical-nested"</span>)<span class="op">.</span><span class="fu">text</span>(minValue<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">3</span>))<span class="op">;</span></span>
<span id="cb6-1075"><a href="#cb6-1075" aria-hidden="true" tabindex="-1"></a>      d3<span class="op">.</span><span class="fu">select</span>(<span class="st">"#pv-max-complete-empirical-nested"</span>)<span class="op">.</span><span class="fu">text</span>(maxValue<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">3</span>))<span class="op">;</span></span>
<span id="cb6-1076"><a href="#cb6-1076" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> cells <span class="op">=</span> d3</span>
<span id="cb6-1077"><a href="#cb6-1077" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">select</span>(<span class="st">"#heatmap-complete-empirical-nested"</span>)</span>
<span id="cb6-1078"><a href="#cb6-1078" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"rect.cell"</span>)</span>
<span id="cb6-1079"><a href="#cb6-1079" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">data</span>(v)</span>
<span id="cb6-1080"><a href="#cb6-1080" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-1081"><a href="#cb6-1081" aria-hidden="true" tabindex="-1"></a>      cells<span class="op">.</span><span class="fu">enter</span>()</span>
<span id="cb6-1082"><a href="#cb6-1082" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">merge</span>(cells)</span>
<span id="cb6-1083"><a href="#cb6-1083" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">x</span>)</span>
<span id="cb6-1084"><a href="#cb6-1084" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">y</span>)</span>
<span id="cb6-1085"><a href="#cb6-1085" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"width"</span><span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">width</span>)</span>
<span id="cb6-1086"><a href="#cb6-1086" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"height"</span><span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">height</span>)</span>
<span id="cb6-1087"><a href="#cb6-1087" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">style</span>(<span class="st">"fill"</span><span class="op">,</span> d <span class="kw">=&gt;</span> <span class="fu">colorScaleComplete</span>(<span class="op">+</span>d<span class="op">.</span><span class="at">value</span>))<span class="op">;</span></span>
<span id="cb6-1088"><a href="#cb6-1088" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-1089"><a href="#cb6-1089" aria-hidden="true" tabindex="-1"></a>      d3<span class="op">.</span><span class="fu">select</span>(<span class="st">"#heatmap-complete-empirical-nested"</span>)</span>
<span id="cb6-1090"><a href="#cb6-1090" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"text"</span>)</span>
<span id="cb6-1091"><a href="#cb6-1091" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">remove</span>()<span class="op">;</span></span>
<span id="cb6-1092"><a href="#cb6-1092" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-1093"><a href="#cb6-1093" aria-hidden="true" tabindex="-1"></a>      cells<span class="op">.</span><span class="fu">each</span>(<span class="kw">function</span>(d<span class="op">,</span> i) {</span>
<span id="cb6-1094"><a href="#cb6-1094" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> cell <span class="op">=</span> d3<span class="op">.</span><span class="fu">select</span>(<span class="kw">this</span><span class="op">.</span><span class="at">parentNode</span>)<span class="op">;</span></span>
<span id="cb6-1095"><a href="#cb6-1095" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> bbox <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getBBox</span>()<span class="op">;</span></span>
<span id="cb6-1096"><a href="#cb6-1096" aria-hidden="true" tabindex="-1"></a>        cell<span class="op">.</span><span class="fu">append</span>(<span class="st">"text"</span>)</span>
<span id="cb6-1097"><a href="#cb6-1097" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> bbox<span class="op">.</span><span class="at">x</span> <span class="op">+</span> bbox<span class="op">.</span><span class="at">width</span> <span class="op">/</span> <span class="dv">2</span>)</span>
<span id="cb6-1098"><a href="#cb6-1098" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> bbox<span class="op">.</span><span class="at">y</span> <span class="op">+</span> bbox<span class="op">.</span><span class="at">height</span> <span class="op">/</span> <span class="dv">2</span>)</span>
<span id="cb6-1099"><a href="#cb6-1099" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">attr</span>(<span class="st">"text-anchor"</span><span class="op">,</span> <span class="st">"middle"</span>)</span>
<span id="cb6-1100"><a href="#cb6-1100" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">attr</span>(<span class="st">"alignment-baseline"</span><span class="op">,</span> <span class="st">"central"</span>)</span>
<span id="cb6-1101"><a href="#cb6-1101" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">style</span>(<span class="st">"font-size"</span><span class="op">,</span> <span class="st">"3px"</span>)</span>
<span id="cb6-1102"><a href="#cb6-1102" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">style</span>(<span class="st">"pointer-events"</span><span class="op">,</span> <span class="st">"none"</span>)</span>
<span id="cb6-1103"><a href="#cb6-1103" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">text</span>((d<span class="op">.</span><span class="at">prop</span> <span class="op">*</span> <span class="dv">100</span>)<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">1</span>) <span class="op">+</span> <span class="st">"%"</span>)<span class="op">;</span></span>
<span id="cb6-1104"><a href="#cb6-1104" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb6-1105"><a href="#cb6-1105" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb6-1106"><a href="#cb6-1106" aria-hidden="true" tabindex="-1"></a>      cells<span class="op">.</span><span class="fu">exit</span>()<span class="op">.</span><span class="fu">remove</span>()<span class="op">;</span></span>
<span id="cb6-1107"><a href="#cb6-1107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-1108"><a href="#cb6-1108" aria-hidden="true" tabindex="-1"></a>      d3<span class="op">.</span><span class="fu">select</span>(<span class="st">"#heatmap-complete-empirical-nested"</span>)</span>
<span id="cb6-1109"><a href="#cb6-1109" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"rect.cell"</span>)</span>
<span id="cb6-1110"><a href="#cb6-1110" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">data</span>(complete_empirical_nested_pv_data)</span>
<span id="cb6-1111"><a href="#cb6-1111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-1112"><a href="#cb6-1112" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb6-1113"><a href="#cb6-1113" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">parent_el</span>(<span class="st">"#heatmap-complete-empirical-nested"</span>)</span>
<span id="cb6-1114"><a href="#cb6-1114" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">interpolate</span>(<span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb6-1115"><a href="#cb6-1115" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-1116"><a href="#cb6-1116" aria-hidden="true" tabindex="-1"></a>  <span class="co">// plot heatmap</span></span>
<span id="cb6-1117"><a href="#cb6-1117" aria-hidden="true" tabindex="-1"></a>  d3<span class="op">.</span><span class="fu">select</span>(<span class="st">"#heatmap-complete-empirical-nested"</span>)</span>
<span id="cb6-1118"><a href="#cb6-1118" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">html</span>(<span class="st">""</span>)</span>
<span id="cb6-1119"><a href="#cb6-1119" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">datum</span>(complete_empirical_nested_pv_data)</span>
<span id="cb6-1120"><a href="#cb6-1120" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">call</span>(heatmap_complete_empirical_nested)<span class="op">;</span></span>
<span id="cb6-1121"><a href="#cb6-1121" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display hidden">
<div id="ojs-cell-6" data-nodetype="expression">

</div>
</div>
</div>
<p>There are several takeaways one might have from this view, but the big one that I have is this: As you move your mouse (i.e.&nbsp;the starting point of the pass) from the defender’s box to the opponent’s box, the consolidated green box of +0.025 PV doesn’t change much. It stays basically at around the final quarter of the pitch. So you can’t just complete a 30-yard pass from the top of your own box progressing the ball towards the middle of the pitch and expect to get anywhere near the same PV as completing a 30-yard pass from the center of the pitch to near the opponent’s 18-yard box. The end point really matters.</p>
<p>This conclusion gets at our primary question–“Are all long passes good?”–to which the answer so far is “not quite” (in the sense that “good” is more than just “positive PV” for completed passes). A long completed pass in your own half doesn’t boast a huge positive PV, unless it ends up near the opponent’s box.</p>
<p>To get a more complete perspective, we’ll plot out the PV for incomplete passes to see what the answer is there.</p>
</section>
</section>
<section id="incomplete-passes" class="level2">
<h2 class="anchored" data-anchor-id="incomplete-passes">Incomplete Passes</h2>
<section id="from-one-spot-to-anywhere-on-the-pitch-1" class="level3">
<h3 class="anchored" data-anchor-id="from-one-spot-to-anywhere-on-the-pitch-1">From One Spot, To Anywhere on the Pitch</h3>
<p>Let’s start with an example again, looking at PV for unsuccessful passes from the center spot.</p>
<div class="cell" data-include="true">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb7" data-startfrom="1139" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1138;"><span id="cb7-1139"><a href="#cb7-1139" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb7-1140"><a href="#cb7-1140" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> chart <span class="op">=</span> d3<span class="op">.</span><span class="fu">create</span>(<span class="st">"div"</span>)<span class="op">.</span><span class="fu">style</span>(<span class="st">"background-color"</span><span class="op">,</span> <span class="st">"8f8f8f"</span>)</span>
<span id="cb7-1141"><a href="#cb7-1141" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> title <span class="op">=</span> chart<span class="op">.</span><span class="fu">append</span>(<span class="st">"div"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"id"</span><span class="op">,</span> <span class="st">"heatmap-title-incomplete-empirical"</span>)</span>
<span id="cb7-1142"><a href="#cb7-1142" aria-hidden="true" tabindex="-1"></a>  title<span class="op">.</span><span class="fu">append</span>(<span class="st">"p"</span>)<span class="op">.</span><span class="fu">html</span>(<span class="vs">`PV: &lt;span id='pv-value-incomplete-empirical'&gt;0&lt;/span&gt;`</span>)</span>
<span id="cb7-1143"><a href="#cb7-1143" aria-hidden="true" tabindex="-1"></a>  chart<span class="op">.</span><span class="fu">append</span>(<span class="st">"div"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"id"</span><span class="op">,</span> <span class="st">"heatmap-incomplete-empirical"</span>)</span>
<span id="cb7-1144"><a href="#cb7-1144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1145"><a href="#cb7-1145" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> legendSwatchContainer <span class="op">=</span> chart<span class="op">.</span><span class="fu">append</span>(<span class="st">"div"</span>)</span>
<span id="cb7-1146"><a href="#cb7-1146" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"id"</span><span class="op">,</span> <span class="st">"heatmap-legend-incomplete-empirical"</span>)</span>
<span id="cb7-1147"><a href="#cb7-1147" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"display"</span><span class="op">,</span> <span class="st">"flex"</span>)</span>
<span id="cb7-1148"><a href="#cb7-1148" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"flex-direction"</span><span class="op">,</span> <span class="st">"column"</span>)</span>
<span id="cb7-1149"><a href="#cb7-1149" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"align-items"</span><span class="op">,</span> <span class="st">"center"</span>)</span>
<span id="cb7-1150"><a href="#cb7-1150" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"width"</span><span class="op">,</span> <span class="st">"100%"</span>)<span class="op">;</span></span>
<span id="cb7-1151"><a href="#cb7-1151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1152"><a href="#cb7-1152" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> legendRange <span class="op">=</span> [</span>
<span id="cb7-1153"><a href="#cb7-1153" aria-hidden="true" tabindex="-1"></a>    <span class="fl">1.1</span> <span class="op">*</span> d3<span class="op">.</span><span class="fu">min</span>(colorScaleIncompleteRange)<span class="op">,</span></span>
<span id="cb7-1154"><a href="#cb7-1154" aria-hidden="true" tabindex="-1"></a>    <span class="fl">1.1</span> <span class="op">*</span> d3<span class="op">.</span><span class="fu">max</span>(colorScaleIncompleteRange)</span>
<span id="cb7-1155"><a href="#cb7-1155" aria-hidden="true" tabindex="-1"></a>  ]<span class="op">;</span></span>
<span id="cb7-1156"><a href="#cb7-1156" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> stepSize <span class="op">=</span> (legendRange[<span class="dv">1</span>] <span class="op">-</span> legendRange[<span class="dv">0</span>]) <span class="op">/</span> (swatchParams<span class="op">.</span><span class="at">num</span> <span class="op">-</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb7-1157"><a href="#cb7-1157" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> legendSwatches <span class="op">=</span> d3<span class="op">.</span><span class="fu">range</span>(legendRange[<span class="dv">0</span>]<span class="op">,</span> legendRange[<span class="dv">1</span>] <span class="op">+</span> stepSize<span class="op">,</span> stepSize)<span class="op">;</span></span>
<span id="cb7-1158"><a href="#cb7-1158" aria-hidden="true" tabindex="-1"></a>  legendSwatches[legendSwatches<span class="op">.</span><span class="at">length</span> <span class="op">-</span> <span class="dv">1</span>] <span class="op">=</span> legendRange[<span class="dv">1</span>]<span class="op">;</span></span>
<span id="cb7-1159"><a href="#cb7-1159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1160"><a href="#cb7-1160" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> totalLegendWidth <span class="op">=</span> swatchParams<span class="op">.</span><span class="at">width</span> <span class="op">*</span> swatchParams<span class="op">.</span><span class="at">num</span><span class="op">;</span></span>
<span id="cb7-1161"><a href="#cb7-1161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1162"><a href="#cb7-1162" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> swatchRow <span class="op">=</span> legendSwatchContainer<span class="op">.</span><span class="fu">append</span>(<span class="st">"div"</span>)</span>
<span id="cb7-1163"><a href="#cb7-1163" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"display"</span><span class="op">,</span> <span class="st">"flex"</span>)</span>
<span id="cb7-1164"><a href="#cb7-1164" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"justify-content"</span><span class="op">,</span> <span class="st">"center"</span>)</span>
<span id="cb7-1165"><a href="#cb7-1165" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"width"</span><span class="op">,</span> <span class="st">"100%"</span>)<span class="op">;</span></span>
<span id="cb7-1166"><a href="#cb7-1166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1167"><a href="#cb7-1167" aria-hidden="true" tabindex="-1"></a>  swatchRow<span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"div"</span>)</span>
<span id="cb7-1168"><a href="#cb7-1168" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">data</span>(legendSwatches)</span>
<span id="cb7-1169"><a href="#cb7-1169" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">enter</span>()</span>
<span id="cb7-1170"><a href="#cb7-1170" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">append</span>(<span class="st">"div"</span>)</span>
<span id="cb7-1171"><a href="#cb7-1171" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"width"</span><span class="op">,</span> <span class="vs">`</span><span class="sc">${</span>swatchParams<span class="op">.</span><span class="at">width</span><span class="sc">}</span><span class="vs">px`</span>)</span>
<span id="cb7-1172"><a href="#cb7-1172" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"height"</span><span class="op">,</span> <span class="vs">`</span><span class="sc">${</span>swatchParams<span class="op">.</span><span class="at">height</span><span class="sc">}</span><span class="vs">px`</span>)</span>
<span id="cb7-1173"><a href="#cb7-1173" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"background-color"</span><span class="op">,</span> d <span class="kw">=&gt;</span> <span class="fu">colorScaleIncomplete</span>(d))<span class="op">;</span></span>
<span id="cb7-1174"><a href="#cb7-1174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1175"><a href="#cb7-1175" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> labelRow <span class="op">=</span> legendSwatchContainer<span class="op">.</span><span class="fu">append</span>(<span class="st">"div"</span>)</span>
<span id="cb7-1176"><a href="#cb7-1176" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"display"</span><span class="op">,</span> <span class="st">"flex"</span>)</span>
<span id="cb7-1177"><a href="#cb7-1177" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"justify-content"</span><span class="op">,</span> <span class="st">"center"</span>)</span>
<span id="cb7-1178"><a href="#cb7-1178" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"width"</span><span class="op">,</span> <span class="vs">`</span><span class="sc">${</span>totalLegendWidth<span class="sc">}</span><span class="vs">px`</span>)<span class="op">;</span></span>
<span id="cb7-1179"><a href="#cb7-1179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1180"><a href="#cb7-1180" aria-hidden="true" tabindex="-1"></a>  labelRow<span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"span"</span>)</span>
<span id="cb7-1181"><a href="#cb7-1181" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">data</span>(colorScaleIncompleteRange)</span>
<span id="cb7-1182"><a href="#cb7-1182" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">enter</span>()</span>
<span id="cb7-1183"><a href="#cb7-1183" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">append</span>(<span class="st">"span"</span>)</span>
<span id="cb7-1184"><a href="#cb7-1184" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">text</span>(d <span class="kw">=&gt;</span> {</span>
<span id="cb7-1185"><a href="#cb7-1185" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (d <span class="op">===</span> d3<span class="op">.</span><span class="fu">min</span>(colorScaleIncompleteRange)) {</span>
<span id="cb7-1186"><a href="#cb7-1186" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> d <span class="op">+</span> <span class="st">" &lt;="</span><span class="op">;</span></span>
<span id="cb7-1187"><a href="#cb7-1187" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (d <span class="op">===</span> d3<span class="op">.</span><span class="fu">max</span>(colorScaleIncompleteRange)) {</span>
<span id="cb7-1188"><a href="#cb7-1188" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"&gt;= "</span> <span class="op">+</span> d<span class="op">;</span></span>
<span id="cb7-1189"><a href="#cb7-1189" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb7-1190"><a href="#cb7-1190" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> d<span class="op">;</span></span>
<span id="cb7-1191"><a href="#cb7-1191" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb7-1192"><a href="#cb7-1192" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"flex"</span><span class="op">,</span> d <span class="kw">=&gt;</span> d <span class="op">===</span> <span class="dv">0</span> <span class="op">?</span> <span class="st">"1"</span> <span class="op">:</span> <span class="kw">null</span>)</span>
<span id="cb7-1193"><a href="#cb7-1193" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"text-align"</span><span class="op">,</span> <span class="st">"center"</span>)</span>
<span id="cb7-1194"><a href="#cb7-1194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1195"><a href="#cb7-1195" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> chart<span class="op">.</span><span class="fu">node</span>()<span class="op">;</span></span>
<span id="cb7-1196"><a href="#cb7-1196" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="fig-ojs-cell-7" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<div id="ojs-cell-7" data-nodetype="expression">

</div>
<figcaption class="figure-caption">Figure&nbsp;4: A heatmap showing the average possession value (PV) of historically incomplete passes from the center spot (annotated in blue) to all areas of the pitch. The relative frequency of unsuccessful passes from the center spot to each other cell is shown as a percentage. The exact PV value associated with an incomplete pass ending at the hover point can be viewed above the pitch. Black cells represent areas to which unsuccessful passes from the center spot have never been made.</figcaption>
</figure>
</div>
</div>
<div class="cell">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb8" data-startfrom="1202" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1201;"><span id="cb8-1202"><a href="#cb8-1202" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb8-1203"><a href="#cb8-1203" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> heatmap_incomplete_empirical <span class="op">=</span> d3_soccer<span class="op">.</span><span class="fu">heatmap</span>(pitch)</span>
<span id="cb8-1204"><a href="#cb8-1204" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">colorScale</span>(colorScaleIncomplete)</span>
<span id="cb8-1205"><a href="#cb8-1205" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">enableInteraction</span>(<span class="kw">true</span>)</span>
<span id="cb8-1206"><a href="#cb8-1206" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">onSelect</span>((x<span class="op">,</span> y<span class="op">,</span> v) <span class="kw">=&gt;</span> {</span>
<span id="cb8-1207"><a href="#cb8-1207" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> cappedValue <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">min</span>(<span class="bu">Math</span><span class="op">.</span><span class="fu">max</span>(v<span class="op">,</span> <span class="op">-</span><span class="dv">1</span>)<span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb8-1208"><a href="#cb8-1208" aria-hidden="true" tabindex="-1"></a>      d3<span class="op">.</span><span class="fu">select</span>(<span class="st">"#pv-value-incomplete-empirical"</span>)<span class="op">.</span><span class="fu">text</span>(cappedValue<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">3</span>))<span class="op">;</span></span>
<span id="cb8-1209"><a href="#cb8-1209" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb8-1210"><a href="#cb8-1210" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">parent_el</span>(<span class="st">"#heatmap-incomplete-empirical"</span>)</span>
<span id="cb8-1211"><a href="#cb8-1211" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">interpolate</span>(<span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb8-1212"><a href="#cb8-1212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1213"><a href="#cb8-1213" aria-hidden="true" tabindex="-1"></a>  d3<span class="op">.</span><span class="fu">select</span>(<span class="st">"#heatmap-incomplete-empirical"</span>)</span>
<span id="cb8-1214"><a href="#cb8-1214" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">html</span>(<span class="st">""</span>)</span>
<span id="cb8-1215"><a href="#cb8-1215" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">datum</span>(incomplete_empirical_pv_data)</span>
<span id="cb8-1216"><a href="#cb8-1216" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">call</span>(heatmap_incomplete_empirical)<span class="op">;</span></span>
<span id="cb8-1217"><a href="#cb8-1217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1218"><a href="#cb8-1218" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> svg <span class="op">=</span> d3<span class="op">.</span><span class="fu">select</span>(<span class="st">"#heatmap-incomplete-empirical"</span>)<span class="op">.</span><span class="fu">select</span>(<span class="st">"svg"</span>)<span class="op">;</span></span>
<span id="cb8-1219"><a href="#cb8-1219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1220"><a href="#cb8-1220" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> cells <span class="op">=</span> svg<span class="op">.</span><span class="fu">selectAll</span>(<span class="st">".cell"</span>)<span class="op">;</span></span>
<span id="cb8-1221"><a href="#cb8-1221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1222"><a href="#cb8-1222" aria-hidden="true" tabindex="-1"></a>  cells<span class="op">.</span><span class="fu">each</span>(<span class="kw">function</span>(d<span class="op">,</span> i) {</span>
<span id="cb8-1223"><a href="#cb8-1223" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> cell <span class="op">=</span> d3<span class="op">.</span><span class="fu">select</span>(<span class="kw">this</span>)<span class="op">;</span></span>
<span id="cb8-1224"><a href="#cb8-1224" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> bbox <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getBBox</span>()<span class="op">;</span></span>
<span id="cb8-1225"><a href="#cb8-1225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1226"><a href="#cb8-1226" aria-hidden="true" tabindex="-1"></a>    d3<span class="op">.</span><span class="fu">select</span>(<span class="kw">this</span><span class="op">.</span><span class="at">parentNode</span>)</span>
<span id="cb8-1227"><a href="#cb8-1227" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">append</span>(<span class="st">"text"</span>)</span>
<span id="cb8-1228"><a href="#cb8-1228" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> bbox<span class="op">.</span><span class="at">x</span> <span class="op">+</span> bbox<span class="op">.</span><span class="at">width</span> <span class="op">/</span> <span class="dv">2</span>)</span>
<span id="cb8-1229"><a href="#cb8-1229" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> bbox<span class="op">.</span><span class="at">y</span> <span class="op">+</span> bbox<span class="op">.</span><span class="at">height</span> <span class="op">/</span> <span class="dv">2</span>)</span>
<span id="cb8-1230"><a href="#cb8-1230" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"text-anchor"</span><span class="op">,</span> <span class="st">"middle"</span>)</span>
<span id="cb8-1231"><a href="#cb8-1231" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"alignment-baseline"</span><span class="op">,</span> <span class="st">"central"</span>)</span>
<span id="cb8-1232"><a href="#cb8-1232" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">style</span>(<span class="st">"font-size"</span><span class="op">,</span> <span class="st">"3px"</span>)</span>
<span id="cb8-1233"><a href="#cb8-1233" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">style</span>(<span class="st">"pointer-events"</span><span class="op">,</span> <span class="st">"none"</span>)</span>
<span id="cb8-1234"><a href="#cb8-1234" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">text</span>((d<span class="op">.</span><span class="at">prop</span> <span class="op">*</span> <span class="dv">100</span>)<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">1</span>) <span class="op">+</span> <span class="st">"%"</span>)<span class="op">;</span></span>
<span id="cb8-1235"><a href="#cb8-1235" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb8-1236"><a href="#cb8-1236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-1237"><a href="#cb8-1237" aria-hidden="true" tabindex="-1"></a>  svg<span class="op">.</span><span class="fu">append</span>(<span class="st">"rect"</span>)</span>
<span id="cb8-1238"><a href="#cb8-1238" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> passStartParams<span class="op">.</span><span class="at">x</span>)</span>
<span id="cb8-1239"><a href="#cb8-1239" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> passStartParams<span class="op">.</span><span class="at">y</span>)</span>
<span id="cb8-1240"><a href="#cb8-1240" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"width"</span><span class="op">,</span> cellParams<span class="op">.</span><span class="at">width</span>)</span>
<span id="cb8-1241"><a href="#cb8-1241" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"height"</span><span class="op">,</span> cellParams<span class="op">.</span><span class="at">height</span>)</span>
<span id="cb8-1242"><a href="#cb8-1242" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"stroke"</span><span class="op">,</span> <span class="st">"blue"</span>)</span>
<span id="cb8-1243"><a href="#cb8-1243" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"fill"</span><span class="op">,</span> <span class="st">"none"</span>)</span>
<span id="cb8-1244"><a href="#cb8-1244" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"stroke-width"</span><span class="op">,</span> <span class="st">"1px"</span>)<span class="op">;</span></span>
<span id="cb8-1245"><a href="#cb8-1245" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display hidden">
<div id="ojs-cell-8" data-nodetype="expression">

</div>
</div>
</div>
<p>I think this grid is fairly intuitive.<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a> Incomplete passes backward have fairly negative PVs, as those are turnovers probably setting up the opponent for good scoring opportunities. Incomplete passes forward mostly have neutral PVs, with some spots on the pitch having slightly positive PVs. Notably, a positive PV for an incomplete pass is a non-trivial revelation.</p>
<p>Some of the positive PV cells include the area at the top of the 18-yard box, i.e.&nbsp;<a href="https://www.youtube.com/watch?v=_EFtACGzD7E">“zone 14”</a>. You can make the argument that the “risk” of losing possession to passes to zone 14 is justified from the potential to take a shot. Further, a loss of possession in this area can be advantageous, as it leaves the opponent likely in a vulnerable position.</p>
</section>
<section id="from-anywhere-on-the-pitch-to-anywhere-on-the-pitch-1" class="level3">
<h3 class="anchored" data-anchor-id="from-anywhere-on-the-pitch-to-anywhere-on-the-pitch-1">From Anywhere on the Pitch, To Anywhere on the Pitch</h3>
<p>Now let’s scale up our pass PV grid to all incomplete passes. As with the dynamic successful pass heatmap, hovering over a cell will show PV associated with unsuccessful passes from that point on the pitch.</p>
<div class="cell" data-include="true">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb9" data-startfrom="1261" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1260;"><span id="cb9-1261"><a href="#cb9-1261" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb9-1262"><a href="#cb9-1262" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> chart <span class="op">=</span> d3<span class="op">.</span><span class="fu">create</span>(<span class="st">"div"</span>)<span class="op">.</span><span class="fu">style</span>(<span class="st">"background-color"</span><span class="op">,</span> <span class="st">"8f8f8f"</span>)</span>
<span id="cb9-1263"><a href="#cb9-1263" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> title <span class="op">=</span> chart<span class="op">.</span><span class="fu">append</span>(<span class="st">"div"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"id"</span><span class="op">,</span> <span class="st">"heatmap-title-incomplete-empirical-nested"</span>)</span>
<span id="cb9-1264"><a href="#cb9-1264" aria-hidden="true" tabindex="-1"></a>  title<span class="op">.</span><span class="fu">append</span>(<span class="st">"p"</span>)<span class="op">.</span><span class="fu">html</span>(<span class="vs">`min PV: &lt;span id='pv-min-incomplete-empirical-nested'&gt;0&lt;/span&gt;, max PV: &lt;span id='pv-max-incomplete-empirical-nested'&gt;0&lt;/span&gt;`</span>)</span>
<span id="cb9-1265"><a href="#cb9-1265" aria-hidden="true" tabindex="-1"></a>  chart<span class="op">.</span><span class="fu">append</span>(<span class="st">"div"</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"id"</span><span class="op">,</span> <span class="st">"heatmap-incomplete-empirical-nested"</span>)</span>
<span id="cb9-1266"><a href="#cb9-1266" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-1267"><a href="#cb9-1267" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> legendSwatchContainer <span class="op">=</span> chart<span class="op">.</span><span class="fu">append</span>(<span class="st">"div"</span>)</span>
<span id="cb9-1268"><a href="#cb9-1268" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"id"</span><span class="op">,</span> <span class="st">"heatmap-legend-incomplete-empirical-nested"</span>)</span>
<span id="cb9-1269"><a href="#cb9-1269" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"display"</span><span class="op">,</span> <span class="st">"flex"</span>)</span>
<span id="cb9-1270"><a href="#cb9-1270" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"flex-direction"</span><span class="op">,</span> <span class="st">"column"</span>)</span>
<span id="cb9-1271"><a href="#cb9-1271" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"align-items"</span><span class="op">,</span> <span class="st">"center"</span>)</span>
<span id="cb9-1272"><a href="#cb9-1272" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"width"</span><span class="op">,</span> <span class="st">"100%"</span>)<span class="op">;</span></span>
<span id="cb9-1273"><a href="#cb9-1273" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-1274"><a href="#cb9-1274" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> legendRange <span class="op">=</span> [</span>
<span id="cb9-1275"><a href="#cb9-1275" aria-hidden="true" tabindex="-1"></a>    <span class="fl">1.1</span> <span class="op">*</span> d3<span class="op">.</span><span class="fu">min</span>(colorScaleIncompleteRange)<span class="op">,</span></span>
<span id="cb9-1276"><a href="#cb9-1276" aria-hidden="true" tabindex="-1"></a>    <span class="fl">1.1</span> <span class="op">*</span> d3<span class="op">.</span><span class="fu">max</span>(colorScaleIncompleteRange)</span>
<span id="cb9-1277"><a href="#cb9-1277" aria-hidden="true" tabindex="-1"></a>  ]<span class="op">;</span></span>
<span id="cb9-1278"><a href="#cb9-1278" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> stepSize <span class="op">=</span> (legendRange[<span class="dv">1</span>] <span class="op">-</span> legendRange[<span class="dv">0</span>]) <span class="op">/</span> (swatchParams<span class="op">.</span><span class="at">num</span> <span class="op">-</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb9-1279"><a href="#cb9-1279" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> legendSwatches <span class="op">=</span> d3<span class="op">.</span><span class="fu">range</span>(legendRange[<span class="dv">0</span>]<span class="op">,</span> legendRange[<span class="dv">1</span>] <span class="op">+</span> stepSize<span class="op">,</span> stepSize)<span class="op">;</span></span>
<span id="cb9-1280"><a href="#cb9-1280" aria-hidden="true" tabindex="-1"></a>  legendSwatches[legendSwatches<span class="op">.</span><span class="at">length</span> <span class="op">-</span> <span class="dv">1</span>] <span class="op">=</span> legendRange[<span class="dv">1</span>]<span class="op">;</span></span>
<span id="cb9-1281"><a href="#cb9-1281" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-1282"><a href="#cb9-1282" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> totalLegendWidth <span class="op">=</span> swatchParams<span class="op">.</span><span class="at">width</span> <span class="op">*</span> swatchParams<span class="op">.</span><span class="at">num</span><span class="op">;</span></span>
<span id="cb9-1283"><a href="#cb9-1283" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-1284"><a href="#cb9-1284" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> swatchRow <span class="op">=</span> legendSwatchContainer<span class="op">.</span><span class="fu">append</span>(<span class="st">"div"</span>)</span>
<span id="cb9-1285"><a href="#cb9-1285" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"display"</span><span class="op">,</span> <span class="st">"flex"</span>)</span>
<span id="cb9-1286"><a href="#cb9-1286" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"justify-content"</span><span class="op">,</span> <span class="st">"center"</span>)</span>
<span id="cb9-1287"><a href="#cb9-1287" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"width"</span><span class="op">,</span> <span class="st">"100%"</span>)<span class="op">;</span></span>
<span id="cb9-1288"><a href="#cb9-1288" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-1289"><a href="#cb9-1289" aria-hidden="true" tabindex="-1"></a>  swatchRow<span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"div"</span>)</span>
<span id="cb9-1290"><a href="#cb9-1290" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">data</span>(legendSwatches)</span>
<span id="cb9-1291"><a href="#cb9-1291" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">enter</span>()</span>
<span id="cb9-1292"><a href="#cb9-1292" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">append</span>(<span class="st">"div"</span>)</span>
<span id="cb9-1293"><a href="#cb9-1293" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"width"</span><span class="op">,</span> <span class="vs">`</span><span class="sc">${</span>swatchParams<span class="op">.</span><span class="at">width</span><span class="sc">}</span><span class="vs">px`</span>)</span>
<span id="cb9-1294"><a href="#cb9-1294" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"height"</span><span class="op">,</span> <span class="vs">`</span><span class="sc">${</span>swatchParams<span class="op">.</span><span class="at">height</span><span class="sc">}</span><span class="vs">px`</span>)</span>
<span id="cb9-1295"><a href="#cb9-1295" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"background-color"</span><span class="op">,</span> d <span class="kw">=&gt;</span> <span class="fu">colorScaleIncomplete</span>(d))<span class="op">;</span></span>
<span id="cb9-1296"><a href="#cb9-1296" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-1297"><a href="#cb9-1297" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> labelRow <span class="op">=</span> legendSwatchContainer<span class="op">.</span><span class="fu">append</span>(<span class="st">"div"</span>)</span>
<span id="cb9-1298"><a href="#cb9-1298" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"display"</span><span class="op">,</span> <span class="st">"flex"</span>)</span>
<span id="cb9-1299"><a href="#cb9-1299" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"justify-content"</span><span class="op">,</span> <span class="st">"center"</span>)</span>
<span id="cb9-1300"><a href="#cb9-1300" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"width"</span><span class="op">,</span> <span class="vs">`</span><span class="sc">${</span>totalLegendWidth<span class="sc">}</span><span class="vs">px`</span>)<span class="op">;</span></span>
<span id="cb9-1301"><a href="#cb9-1301" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-1302"><a href="#cb9-1302" aria-hidden="true" tabindex="-1"></a>  labelRow<span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"span"</span>)</span>
<span id="cb9-1303"><a href="#cb9-1303" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">data</span>(colorScaleIncompleteRange)</span>
<span id="cb9-1304"><a href="#cb9-1304" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">enter</span>()</span>
<span id="cb9-1305"><a href="#cb9-1305" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">append</span>(<span class="st">"span"</span>)</span>
<span id="cb9-1306"><a href="#cb9-1306" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">text</span>(d <span class="kw">=&gt;</span> {</span>
<span id="cb9-1307"><a href="#cb9-1307" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (d <span class="op">===</span> d3<span class="op">.</span><span class="fu">min</span>(colorScaleIncompleteRange)) {</span>
<span id="cb9-1308"><a href="#cb9-1308" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> d <span class="op">+</span> <span class="st">" &lt;="</span><span class="op">;</span></span>
<span id="cb9-1309"><a href="#cb9-1309" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (d <span class="op">===</span> d3<span class="op">.</span><span class="fu">max</span>(colorScaleIncompleteRange)) {</span>
<span id="cb9-1310"><a href="#cb9-1310" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"&gt;= "</span> <span class="op">+</span> d<span class="op">;</span></span>
<span id="cb9-1311"><a href="#cb9-1311" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb9-1312"><a href="#cb9-1312" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> d<span class="op">;</span></span>
<span id="cb9-1313"><a href="#cb9-1313" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb9-1314"><a href="#cb9-1314" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"flex"</span><span class="op">,</span> d <span class="kw">=&gt;</span> d <span class="op">===</span> <span class="dv">0</span> <span class="op">?</span> <span class="st">"1"</span> <span class="op">:</span> <span class="kw">null</span>)</span>
<span id="cb9-1315"><a href="#cb9-1315" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"text-align"</span><span class="op">,</span> <span class="st">"center"</span>)</span>
<span id="cb9-1316"><a href="#cb9-1316" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-1317"><a href="#cb9-1317" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> chart<span class="op">.</span><span class="fu">node</span>()<span class="op">;</span></span>
<span id="cb9-1318"><a href="#cb9-1318" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="fig-ojs-cell-9" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<div id="ojs-cell-9" data-nodetype="expression">

</div>
<figcaption class="figure-caption">Figure&nbsp;5: A heatmap showing the average possession value (PV) of historically incomplete pass from the hover spot to all areas on the pitch. The relative frequency of successful passes from the center spot to each other cell is shown as a percentage. The highest and lowest PV values across all end points associated with an incomplete pass from the hover point are shown above the pitch. Black cells represent areas to which unsuccessful passes from the hover spot have never been made.</figcaption>
</figure>
</div>
</div>
<div class="cell">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb10" data-startfrom="1324" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1323;"><span id="cb10-1324"><a href="#cb10-1324" aria-hidden="true" tabindex="-1"></a>{  </span>
<span id="cb10-1325"><a href="#cb10-1325" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> heatmap_incomplete_empirical_nested <span class="op">=</span> d3_soccer<span class="op">.</span><span class="fu">heatmap</span>(pitch)</span>
<span id="cb10-1326"><a href="#cb10-1326" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">colorScale</span>(d3<span class="op">.</span><span class="fu">scaleLinear</span>()<span class="op">.</span><span class="fu">domain</span>([<span class="op">-</span><span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>])<span class="op">.</span><span class="fu">range</span>([<span class="st">"white"</span><span class="op">,</span> <span class="st">"white"</span>]))</span>
<span id="cb10-1327"><a href="#cb10-1327" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">enableInteraction</span>(<span class="kw">true</span>)</span>
<span id="cb10-1328"><a href="#cb10-1328" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">onSelect</span>((x<span class="op">,</span> y<span class="op">,</span> v) <span class="kw">=&gt;</span> {</span>
<span id="cb10-1329"><a href="#cb10-1329" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> rawMinValue <span class="op">=</span> d3<span class="op">.</span><span class="fu">min</span>(v<span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">value</span>)<span class="op">;</span></span>
<span id="cb10-1330"><a href="#cb10-1330" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> rawMaxValue <span class="op">=</span> d3<span class="op">.</span><span class="fu">max</span>(v<span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">value</span>)<span class="op">;</span></span>
<span id="cb10-1331"><a href="#cb10-1331" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> minValue <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">max</span>(rawMinValue<span class="op">,</span> <span class="op">-</span><span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb10-1332"><a href="#cb10-1332" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> maxValue <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">min</span>(rawMaxValue<span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb10-1333"><a href="#cb10-1333" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-1334"><a href="#cb10-1334" aria-hidden="true" tabindex="-1"></a>      d3<span class="op">.</span><span class="fu">select</span>(<span class="st">'#pv-min-incomplete-empirical-nested'</span>)<span class="op">.</span><span class="fu">text</span>(minValue<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">3</span>))<span class="op">;</span></span>
<span id="cb10-1335"><a href="#cb10-1335" aria-hidden="true" tabindex="-1"></a>      d3<span class="op">.</span><span class="fu">select</span>(<span class="st">'#pv-max-incomplete-empirical-nested'</span>)<span class="op">.</span><span class="fu">text</span>(maxValue<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">3</span>))<span class="op">;</span></span>
<span id="cb10-1336"><a href="#cb10-1336" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> cells <span class="op">=</span> d3</span>
<span id="cb10-1337"><a href="#cb10-1337" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">select</span>(<span class="st">"#heatmap-incomplete-empirical-nested"</span>)</span>
<span id="cb10-1338"><a href="#cb10-1338" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"rect.cell"</span>)</span>
<span id="cb10-1339"><a href="#cb10-1339" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">data</span>(v)<span class="op">;</span></span>
<span id="cb10-1340"><a href="#cb10-1340" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-1341"><a href="#cb10-1341" aria-hidden="true" tabindex="-1"></a>      cells<span class="op">.</span><span class="fu">enter</span>()</span>
<span id="cb10-1342"><a href="#cb10-1342" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">merge</span>(cells)</span>
<span id="cb10-1343"><a href="#cb10-1343" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">x</span>)</span>
<span id="cb10-1344"><a href="#cb10-1344" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">y</span>)</span>
<span id="cb10-1345"><a href="#cb10-1345" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"width"</span><span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">width</span>)</span>
<span id="cb10-1346"><a href="#cb10-1346" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">attr</span>(<span class="st">"height"</span><span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">height</span>)</span>
<span id="cb10-1347"><a href="#cb10-1347" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">style</span>(<span class="st">"fill"</span><span class="op">,</span> d <span class="kw">=&gt;</span> <span class="fu">colorScaleIncomplete</span>(<span class="op">+</span>d<span class="op">.</span><span class="at">value</span>))<span class="op">;</span></span>
<span id="cb10-1348"><a href="#cb10-1348" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-1349"><a href="#cb10-1349" aria-hidden="true" tabindex="-1"></a>      d3<span class="op">.</span><span class="fu">select</span>(<span class="st">"#heatmap-incomplete-empirical-nested"</span>)</span>
<span id="cb10-1350"><a href="#cb10-1350" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"text"</span>)</span>
<span id="cb10-1351"><a href="#cb10-1351" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">remove</span>()<span class="op">;</span></span>
<span id="cb10-1352"><a href="#cb10-1352" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-1353"><a href="#cb10-1353" aria-hidden="true" tabindex="-1"></a>      cells<span class="op">.</span><span class="fu">each</span>(<span class="kw">function</span>(d<span class="op">,</span> i) {</span>
<span id="cb10-1354"><a href="#cb10-1354" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> cell <span class="op">=</span> d3<span class="op">.</span><span class="fu">select</span>(<span class="kw">this</span><span class="op">.</span><span class="at">parentNode</span>)<span class="op">;</span></span>
<span id="cb10-1355"><a href="#cb10-1355" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> bbox <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getBBox</span>()<span class="op">;</span></span>
<span id="cb10-1356"><a href="#cb10-1356" aria-hidden="true" tabindex="-1"></a>        cell<span class="op">.</span><span class="fu">append</span>(<span class="st">"text"</span>)</span>
<span id="cb10-1357"><a href="#cb10-1357" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> bbox<span class="op">.</span><span class="at">x</span> <span class="op">+</span> bbox<span class="op">.</span><span class="at">width</span> <span class="op">/</span> <span class="dv">2</span>)</span>
<span id="cb10-1358"><a href="#cb10-1358" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> bbox<span class="op">.</span><span class="at">y</span> <span class="op">+</span> bbox<span class="op">.</span><span class="at">height</span> <span class="op">/</span> <span class="dv">2</span>)</span>
<span id="cb10-1359"><a href="#cb10-1359" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">attr</span>(<span class="st">"text-anchor"</span><span class="op">,</span> <span class="st">"middle"</span>)</span>
<span id="cb10-1360"><a href="#cb10-1360" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">attr</span>(<span class="st">"alignment-baseline"</span><span class="op">,</span> <span class="st">"central"</span>)</span>
<span id="cb10-1361"><a href="#cb10-1361" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">style</span>(<span class="st">"font-size"</span><span class="op">,</span> <span class="st">"3px"</span>)</span>
<span id="cb10-1362"><a href="#cb10-1362" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">style</span>(<span class="st">"pointer-events"</span><span class="op">,</span> <span class="st">"none"</span>)</span>
<span id="cb10-1363"><a href="#cb10-1363" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">text</span>((d<span class="op">.</span><span class="at">prop</span> <span class="op">*</span> <span class="dv">100</span>)<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">1</span>) <span class="op">+</span> <span class="st">"%"</span>)<span class="op">;</span></span>
<span id="cb10-1364"><a href="#cb10-1364" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb10-1365"><a href="#cb10-1365" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb10-1366"><a href="#cb10-1366" aria-hidden="true" tabindex="-1"></a>      cells<span class="op">.</span><span class="fu">exit</span>()<span class="op">.</span><span class="fu">remove</span>()<span class="op">;</span></span>
<span id="cb10-1367"><a href="#cb10-1367" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-1368"><a href="#cb10-1368" aria-hidden="true" tabindex="-1"></a>      d3<span class="op">.</span><span class="fu">select</span>(<span class="st">"#heatmap-incomplete-empirical-nested"</span>)</span>
<span id="cb10-1369"><a href="#cb10-1369" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"rect.cell"</span>)</span>
<span id="cb10-1370"><a href="#cb10-1370" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">data</span>(incomplete_empirical_nested_pv_data)<span class="op">;</span></span>
<span id="cb10-1371"><a href="#cb10-1371" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb10-1372"><a href="#cb10-1372" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">parent_el</span>(<span class="st">"#heatmap-incomplete-empirical-nested"</span>)</span>
<span id="cb10-1373"><a href="#cb10-1373" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">interpolate</span>(<span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb10-1374"><a href="#cb10-1374" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-1375"><a href="#cb10-1375" aria-hidden="true" tabindex="-1"></a>  d3<span class="op">.</span><span class="fu">select</span>(<span class="st">"#heatmap-incomplete-empirical-nested"</span>)</span>
<span id="cb10-1376"><a href="#cb10-1376" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">html</span>(<span class="st">""</span>)</span>
<span id="cb10-1377"><a href="#cb10-1377" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">datum</span>(incomplete_empirical_nested_pv_data)</span>
<span id="cb10-1378"><a href="#cb10-1378" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">call</span>(heatmap_incomplete_empirical_nested)<span class="op">;</span></span>
<span id="cb10-1379"><a href="#cb10-1379" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display hidden">
<div id="ojs-cell-10" data-nodetype="expression">

</div>
</div>
</div>
<p>Hovering my mouse over various areas in the middle third of the pitch, I consistently see slightly positive values near the top of the 18-yard box. This is not all that dissimilar from the trend observed with the successful pass pitch, where the passes into the final quarter of the pitch had strong positive PV from basically anywhere. And, like the interactive pitch for completed passes, a 30-yard incomplete pass forward from one’s own 18-yard box doesn’t have the same PV as a 30-yard incomplete pass forward from the half line to the opponent’s 18-yard box. Not all long incomplete passes are judged equally.</p>
</section>
</section>
</section>
<section id="conclusion" class="level1">
<h1>Conclusion</h1>
<p>Overall, my takeaways are as follows:</p>
<ol type="1">
<li>Not all long passes add the same kind of value. The pass has to be one that ends up near the box to create non-trivial positive PV.</li>
<li>And, while completed passes will almost always add more value, incomplete passes can also have positive PV when they’re played into dangerous areas.</li>
</ol>
<p>For those who have built PV models or are very familiar with them in some way, perhaps the latter observation is not an unsurprising result. Indeed, we should want our PV models to see past the outcome of a pass and properly quantify the threat that a through ball can have, whether it’s completed or not.</p>
<section id="caveats" class="level2">
<h2 class="anchored" data-anchor-id="caveats">Caveats</h2>
<ul>
<li><p>The choice of model surely plays a role in the inference we’ll make. Even <a href="https://dtai.cs.kuleuven.be/sports/blog/introducing-atomic-spadl:-a-new-way-to-represent-event-stream-data">atomic VAEP</a>, the cooler younger brother to the baseline VAEP model, may yield different answers due to the way that it treats passes.<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a></p></li>
<li><p>Along the same lines, the gradients in the pitches are only as “good” as the quality of the model. While the cells show average PV values over many passes<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a>, the PV value may not match intuition if the model doesn’t account for all relevant factors. If headed passes weren’t treated differently from footed passes, the gradients would likely show a lot more noise due to the randomness at which headed passes are successfully made.</p></li>
<li><p>The endpoint of incomplete passes is subject to a fundamental source of noise–interception locations. I’ve implicitly assumed that unsuccessful passes are intercepted very near the intended target, but this is not always the case. Interceptions where, for example, the defender blocks a long through ball near where the pass is made, can skew the model training, exaggerating the value of short incomplete passes.</p></li>
</ul>
<div class="cell" data-include="false">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb11" data-startfrom="1407" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1406;"><span id="cb11-1407"><a href="#cb11-1407" aria-hidden="true" tabindex="-1"></a>pitch <span class="op">=</span> d3_soccer<span class="op">.</span><span class="fu">pitch</span>()</span>
<span id="cb11-1408"><a href="#cb11-1408" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">height</span>(<span class="dv">300</span>)</span>
<span id="cb11-1409"><a href="#cb11-1409" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">rotate</span>(<span class="kw">false</span>)</span>
<span id="cb11-1410"><a href="#cb11-1410" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">showDirOfPlay</span>(<span class="kw">true</span>)</span>
<span id="cb11-1411"><a href="#cb11-1411" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">shadeMiddleThird</span>(<span class="kw">false</span>)</span>
<span id="cb11-1412"><a href="#cb11-1412" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">pitchStrokeWidth</span>(<span class="fl">0.5</span>)</span>
<span id="cb11-1413"><a href="#cb11-1413" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">clip</span>([[<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span>]<span class="op">,</span> [<span class="dv">105</span><span class="op">,</span> <span class="dv">68</span>]])<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display hidden">
<div id="ojs-cell-11" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell" data-include="false">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb12" data-startfrom="1418" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1417;"><span id="cb12-1418"><a href="#cb12-1418" aria-hidden="true" tabindex="-1"></a>d3 <span class="op">=</span> <span class="pp">require</span>(<span class="st">"d3@v5"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display hidden">
<div id="ojs-cell-12" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell" data-include="false">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb13" data-startfrom="1423" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1422;"><span id="cb13-1423"><a href="#cb13-1423" aria-hidden="true" tabindex="-1"></a>d3_soccer <span class="op">=</span> <span class="pp">require</span>(<span class="st">"d3-soccer@0.1.0"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display hidden">
<div id="ojs-cell-13" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell" data-include="false">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb14" data-startfrom="1429" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1428;"><span id="cb14-1429"><a href="#cb14-1429" aria-hidden="true" tabindex="-1"></a>complete_empirical_prop_data  <span class="op">=</span> <span class="fu">FileAttachment</span>(<span class="st">"complete_empirical_prop_data.json"</span>)<span class="op">.</span><span class="fu">json</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="complete_empirical_prop_data" class="cell-output cell-output-display hidden">
<div id="ojs-cell-14" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell" data-include="false">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb15" data-startfrom="1435" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1434;"><span id="cb15-1435"><a href="#cb15-1435" aria-hidden="true" tabindex="-1"></a>complete_empirical_pv_data  <span class="op">=</span> <span class="fu">FileAttachment</span>(<span class="st">"complete_empirical_pv_data.json"</span>)<span class="op">.</span><span class="fu">json</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="complete_empirical_pv_data" class="cell-output cell-output-display hidden">
<div id="ojs-cell-15" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell" data-include="true">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb16" data-startfrom="1441" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1440;"><span id="cb16-1441"><a href="#cb16-1441" aria-hidden="true" tabindex="-1"></a>complete_empirical_nested_pv_data <span class="op">=</span> <span class="fu">FileAttachment</span>(<span class="st">"complete_empirical_nested_pv_data.json"</span>)<span class="op">.</span><span class="fu">json</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="complete_empirical_nested_pv_data" class="cell-output cell-output-display">
<div id="ojs-cell-16" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell" data-include="false">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb17" data-startfrom="1447" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1446;"><span id="cb17-1447"><a href="#cb17-1447" aria-hidden="true" tabindex="-1"></a>incomplete_empirical_pv_data  <span class="op">=</span> <span class="fu">FileAttachment</span>(<span class="st">"incomplete_empirical_pv_data.json"</span>)<span class="op">.</span><span class="fu">json</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="incomplete_empirical_pv_data" class="cell-output cell-output-display hidden">
<div id="ojs-cell-17" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell" data-include="true">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb18" data-startfrom="1453" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1452;"><span id="cb18-1453"><a href="#cb18-1453" aria-hidden="true" tabindex="-1"></a>incomplete_empirical_nested_pv_data <span class="op">=</span> <span class="fu">FileAttachment</span>(<span class="st">"incomplete_empirical_nested_pv_data.json"</span>)<span class="op">.</span><span class="fu">json</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="incomplete_empirical_nested_pv_data" class="cell-output cell-output-display">
<div id="ojs-cell-18" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell" data-include="false">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb19" data-startfrom="1459" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1458;"><span id="cb19-1459"><a href="#cb19-1459" aria-hidden="true" tabindex="-1"></a>colorScaleCompleteRange <span class="op">=</span> [<span class="op">-</span><span class="fl">0.025</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="fl">0.025</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="colorscalecompleterange" class="cell-output cell-output-display hidden">
<div id="ojs-cell-19" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell" data-include="false">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb20" data-startfrom="1465" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1464;"><span id="cb20-1465"><a href="#cb20-1465" aria-hidden="true" tabindex="-1"></a>colorScaleIncompleteRange <span class="op">=</span> [<span class="op">-</span><span class="fl">0.025</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="fl">0.025</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="colorscaleincompleterange" class="cell-output cell-output-display hidden">
<div id="ojs-cell-20" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell" data-include="false">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb21" data-startfrom="1471" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1470;"><span id="cb21-1471"><a href="#cb21-1471" aria-hidden="true" tabindex="-1"></a>colorScaleComplete <span class="op">=</span> d3<span class="op">.</span><span class="fu">scaleLinear</span>()</span>
<span id="cb21-1472"><a href="#cb21-1472" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">domain</span>(colorScaleCompleteRange)</span>
<span id="cb21-1473"><a href="#cb21-1473" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">range</span>([<span class="st">"#a6611a"</span><span class="op">,</span> <span class="st">"white"</span><span class="op">,</span> <span class="st">"#018571"</span>])<span class="op">.</span><span class="fu">clamp</span>(<span class="kw">true</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="colorscalecomplete" class="cell-output cell-output-display hidden">
<div id="ojs-cell-21" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell" data-include="false">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb22" data-startfrom="1479" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1478;"><span id="cb22-1479"><a href="#cb22-1479" aria-hidden="true" tabindex="-1"></a>colorScaleIncomplete <span class="op">=</span> d3<span class="op">.</span><span class="fu">scaleLinear</span>()</span>
<span id="cb22-1480"><a href="#cb22-1480" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">domain</span>(colorScaleIncompleteRange)</span>
<span id="cb22-1481"><a href="#cb22-1481" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">range</span>([<span class="st">"#d01c8b"</span><span class="op">,</span> <span class="st">"white"</span><span class="op">,</span> <span class="st">"#4dac26"</span>])<span class="op">.</span><span class="fu">clamp</span>(<span class="kw">true</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="colorscaleincomplete" class="cell-output cell-output-display hidden">
<div id="ojs-cell-22" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell" data-include="false">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb23" data-startfrom="1487" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1486;"><span id="cb23-1487"><a href="#cb23-1487" aria-hidden="true" tabindex="-1"></a>swatchParams <span class="op">=</span> {</span>
<span id="cb23-1488"><a href="#cb23-1488" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> {</span>
<span id="cb23-1489"><a href="#cb23-1489" aria-hidden="true" tabindex="-1"></a>    <span class="dt">width</span><span class="op">:</span> <span class="dv">40</span><span class="op">,</span></span>
<span id="cb23-1490"><a href="#cb23-1490" aria-hidden="true" tabindex="-1"></a>    <span class="dt">height</span><span class="op">:</span> <span class="dv">20</span><span class="op">,</span></span>
<span id="cb23-1491"><a href="#cb23-1491" aria-hidden="true" tabindex="-1"></a>    <span class="dt">num</span><span class="op">:</span> <span class="dv">7</span></span>
<span id="cb23-1492"><a href="#cb23-1492" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb23-1493"><a href="#cb23-1493" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="swatchparams" class="cell-output cell-output-display hidden">
<div id="ojs-cell-23" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell" data-include="false">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb24" data-startfrom="1499" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1498;"><span id="cb24-1499"><a href="#cb24-1499" aria-hidden="true" tabindex="-1"></a>passStartParams <span class="op">=</span> {</span>
<span id="cb24-1500"><a href="#cb24-1500" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> {</span>
<span id="cb24-1501"><a href="#cb24-1501" aria-hidden="true" tabindex="-1"></a>    <span class="dt">x</span><span class="op">:</span> <span class="fl">43.75</span><span class="op">,</span></span>
<span id="cb24-1502"><a href="#cb24-1502" aria-hidden="true" tabindex="-1"></a>    <span class="dt">y</span><span class="op">:</span> <span class="dv">34</span></span>
<span id="cb24-1503"><a href="#cb24-1503" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb24-1504"><a href="#cb24-1504" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="passstartparams" class="cell-output cell-output-display hidden">
<div id="ojs-cell-24" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell" data-include="false">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb25" data-startfrom="1510" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 1509;"><span id="cb25-1510"><a href="#cb25-1510" aria-hidden="true" tabindex="-1"></a>cellParams <span class="op">=</span> {</span>
<span id="cb25-1511"><a href="#cb25-1511" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> {</span>
<span id="cb25-1512"><a href="#cb25-1512" aria-hidden="true" tabindex="-1"></a>    <span class="dt">width</span><span class="op">:</span> <span class="fl">8.75</span><span class="op">,</span></span>
<span id="cb25-1513"><a href="#cb25-1513" aria-hidden="true" tabindex="-1"></a>    <span class="dt">height</span><span class="op">:</span> <span class="fl">8.5</span></span>
<span id="cb25-1514"><a href="#cb25-1514" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-1515"><a href="#cb25-1515" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="cellparams" class="cell-output cell-output-display hidden">
<div id="ojs-cell-25" data-nodetype="declaration">

</div>
</div>
</div>



</section>
</section>


<div class="quarto-listing quarto-listing-container-default" id="listing-listing">
<div class="list quarto-listing-default">

</div>
<div class="listing-no-matching d-none">
No matching items
</div>
</div><div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Except in <a href="../../posts/soccer-league-strength/">this post</a>, where I only briefly mention that I use a PV model.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>My model is trained on 2013/14 - 2023/24 English Premier League data.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>While all PV models <a href="https://statsbomb.com/soccer-metrics/possession-value-models-explained/">are similar conceptually</a>, it’s important to identify how they differ in their target variables. VAEP specifically tries to quantify the difference in the probability of scoring and conceding in the next 10 actions. In contrast, expected threat (xT)–perhaps the most well-known PV model–tries to quantify only the probability of scoring in the next 5 actions, not accounting for the conceding probability, which can undermine the “risk” associated with incomplete passes.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>Do not be alarmed by the small values! Values between 0.02 and 0.02 are very common for PV models. After all, the values represent goal probabilities over sequence of actions, and goals don’t happen all that frequently in soccer.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>We observe lots of missingness near the defender’s box. Such incomplete passes backward would be very illogical no matter the game situation, so it’s not surprising to see that such passes are not observed in our data set.<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6"><p>Atomic VAEP splits passes into two actions–the pass itself and the reception (or lack of).<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn7"><p>There are over 3.4M total passes in the data set.<a href="#fnref7" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script type="ojs-module-contents">
{"contents":[{"methodName":"interpret","cellName":"ojs-cell-1","inline":false,"source":"{\n  const chart = d3.create(\"div\").style(\"background-color\", \"8f8f8f\")\n  const title = chart.append(\"div\").attr(\"id\", \"heatmap-title-complete-empirical\")\n  title.append(\"p\").html(`PV: <span id='pv-value-complete-empirical'>0</span>`)\n  chart.append(\"div\").attr(\"id\", \"heatmap-complete-empirical\")\n\n  const legendSwatchContainer = chart.append(\"div\")\n    .attr(\"id\", \"heatmap-legend-complete-empirical\")\n    .style(\"display\", \"flex\")\n    .style(\"flex-direction\", \"column\")\n    .style(\"align-items\", \"center\")\n    .style(\"width\", \"100%\");\n\n  const legendRange = [\n    1.1 * d3.min(colorScaleCompleteRange),\n    1.1 * d3.max(colorScaleCompleteRange)\n  ];\n  const stepSize = (legendRange[1] - legendRange[0]) / (swatchParams.num - 1);\n  const legendSwatches = d3.range(legendRange[0], legendRange[1] + stepSize, stepSize);\n  legendSwatches[legendSwatches.length - 1] = legendRange[1];\n\n  const totalLegendWidth = swatchParams.width * swatchParams.num;\n\n  const swatchRow = legendSwatchContainer.append(\"div\")\n    .style(\"display\", \"flex\")\n    .style(\"justify-content\", \"center\")\n    .style(\"width\", \"100%\");\n\n  swatchRow.selectAll(\"div\")\n    .data(legendSwatches)\n    .enter()\n    .append(\"div\")\n    .style(\"width\", `${swatchParams.width}px`)\n    .style(\"height\", `${swatchParams.height}px`)\n    .style(\"background-color\", d => colorScaleComplete(d));\n\n  const labelRow = legendSwatchContainer.append(\"div\")\n    .style(\"display\", \"flex\")\n    .style(\"justify-content\", \"center\")\n    .style(\"width\", `${totalLegendWidth}px`);\n\n  labelRow.selectAll(\"span\")\n    .data(colorScaleCompleteRange)\n    .enter()\n    .append(\"span\")\n    .text(d => {\n      if (d === d3.min(colorScaleCompleteRange)) {\n        return d + \" <=\";\n      } else if (d === d3.max(colorScaleCompleteRange)) {\n        return \">= \" + d;\n      }\n      return d;\n    })\n    .style(\"flex\", d => d === 0 ? \"1\" : null)\n    .style(\"text-align\", \"center\")\n\n  return chart.node();\n}\n"},{"methodName":"interpret","cellName":"ojs-cell-2","inline":false,"source":"{\n  const heatmap_complete_empirical = d3_soccer.heatmap(pitch)\n    .colorScale(colorScaleComplete)\n    .enableInteraction(true)\n    .onSelect((x, y, v) => {\n      const cappedValue = Math.min(Math.max(v, -1), 1);\n      d3.select(\"#pv-value-complete-empirical\").text(cappedValue.toFixed(3));\n    })\n    .parent_el(\"#heatmap-complete-empirical\")\n    .interpolate(false);\n\n  d3.select(\"#heatmap-complete-empirical\")\n    .html(\"\")\n    .datum(complete_empirical_pv_data)\n    .call(heatmap_complete_empirical);\n\n  const svg = d3.select(\"#heatmap-complete-empirical\").select(\"svg\");\n\n  const cells = svg.selectAll(\".cell\");\n\n  cells.each(function(d, i) {\n    const cell = d3.select(this);\n    const bbox = this.getBBox();\n\n    d3.select(this.parentNode)\n      .append(\"text\")\n      .attr(\"x\", bbox.x + bbox.width / 2)\n      .attr(\"y\", bbox.y + bbox.height / 2)\n      .attr(\"text-anchor\", \"middle\")\n      .attr(\"alignment-baseline\", \"central\")\n      .style(\"font-size\", \"3px\")\n      .style(\"pointer-events\", \"none\")\n      .text((d.prop * 100).toFixed(1) + \"%\");\n  });\n\n  svg.append(\"rect\")\n    .attr(\"x\", passStartParams.x)\n    .attr(\"y\", passStartParams.y)\n    .attr(\"width\", cellParams.width)\n    .attr(\"height\", cellParams.height)\n    .style(\"stroke\", \"blue\")\n    .style(\"fill\", \"none\")\n    .style(\"stroke-width\", \"1px\");\n}\n"},{"methodName":"interpret","cellName":"ojs-cell-3","inline":false,"source":"{\n  const chart = d3.create(\"div\").style(\"background-color\", \"8f8f8f\")\n  const title = chart.append(\"div\").attr(\"id\", \"heatmap-title-complete-empirical-prop\")\n  chart.append(\"div\").attr(\"id\", \"heatmap-complete-empirical-prop\")\n\n  return chart.node();\n}\n"},{"methodName":"interpret","cellName":"ojs-cell-4","inline":false,"source":"{\n  const colorScaleSeq = d3.scaleSequential(d3.interpolateRgb(\"white\", \"gold\"))\n    .domain([0, 0.1])\n    .clamp(true)\n  const heatmap_complete_empirical_prop = d3_soccer.heatmap(pitch)\n    .colorScale(colorScaleSeq)\n    .enableInteraction(false)\n    .parent_el(\"#heatmap-complete-empirical-prop\")\n    .interpolate(false);\n\n  d3.select(\"#heatmap-complete-empirical-prop\")\n    .html(\"\")\n    .datum(complete_empirical_prop_data)\n    .call(heatmap_complete_empirical_prop);\n\n  const svg = d3.select(\"#heatmap-complete-empirical-prop\").select(\"svg\");\n\n  const cells = svg.selectAll(\".cell\");\n\n  cells.each(function(d, i) {\n    const cell = d3.select(this);\n    const bbox = this.getBBox();\n\n    d3.select(this.parentNode)\n      .append(\"text\")\n      .attr(\"x\", bbox.x + bbox.width / 2)\n      .attr(\"y\", bbox.y + bbox.height / 2)\n      .attr(\"text-anchor\", \"middle\")\n      .attr(\"alignment-baseline\", \"central\")\n      .style(\"font-size\", \"3px\")\n      .style(\"pointer-events\", \"none\")\n      .text((d.prop * 100).toFixed(1) + \"%\");\n  });\n\n  svg.append(\"rect\")\n    .attr(\"x\", passStartParams.x)\n    .attr(\"y\", passStartParams.y)\n    .attr(\"width\", cellParams.width)\n    .attr(\"height\", cellParams.height)\n    .style(\"stroke\", \"blue\")\n    .style(\"fill\", \"none\")\n    .style(\"stroke-width\", \"1px\");\n}\n"},{"methodName":"interpret","cellName":"ojs-cell-5","inline":false,"source":"{\n  const chart = d3.create(\"div\").style(\"background-color\", \"8f8f8f\")\n  const title = chart.append(\"div\").attr(\"id\", \"heatmap-title-complete-empirical-nested\")\n  title.append(\"p\").html(`min PV: <span id='pv-min-complete-empirical-nested'>0</span>, max PV: <span id='pv-max-complete-empirical-nested'>0</span>`)\n  chart.append(\"div\").attr(\"id\", \"heatmap-complete-empirical-nested\")\n  \n  const legendSwatchContainer = chart.append(\"div\")\n    .attr(\"id\", \"heatmap-legend-complete-empirical-nested\")\n    .style(\"display\", \"flex\")\n    .style(\"flex-direction\", \"column\")\n    .style(\"align-items\", \"center\")\n    .style(\"width\", \"100%\");\n  \n  const legendRange = [\n    1.1 * d3.min(colorScaleCompleteRange),\n    1.1 * d3.max(colorScaleCompleteRange)\n  ];\n  const stepSize = (legendRange[1] - legendRange[0]) / (swatchParams.num - 1);\n  const legendSwatches = d3.range(legendRange[0], legendRange[1] + stepSize, stepSize);\n  legendSwatches[legendSwatches.length - 1] = legendRange[1];\n  \n  const totalLegendWidth = swatchParams.width * swatchParams.num;\n  \n  const swatchRow = legendSwatchContainer.append(\"div\")\n    .style(\"display\", \"flex\")\n    .style(\"justify-content\", \"center\")\n    .style(\"width\", \"100%\");\n  \n  swatchRow.selectAll(\"div\")\n    .data(legendSwatches)\n    .enter()\n    .append(\"div\")\n    .style(\"width\", `${swatchParams.width}px`)\n    .style(\"height\", `${swatchParams.height}px`)\n    .style(\"background-color\", d => colorScaleComplete(d));\n  \n  const labelRow = legendSwatchContainer.append(\"div\")\n    .style(\"display\", \"flex\")\n    .style(\"justify-content\", \"center\")\n    .style(\"width\", `${totalLegendWidth}px`);\n  \n  \n  labelRow.selectAll(\"span\")\n    .data(colorScaleCompleteRange)\n    .enter()\n    .append(\"span\")\n    .text(d => {\n      if (d === d3.min(colorScaleCompleteRange)) {\n        return d + \" <=\";\n      } else if (d === d3.max(colorScaleCompleteRange)) {\n        return \">= \" + d;\n      }\n      return d;\n    })\n    .style(\"flex\", d => d === 0 ? \"1\" : null)\n    .style(\"text-align\", \"center\")\n  \n  return chart.node();\n\n}\n"},{"methodName":"interpret","cellName":"ojs-cell-6","inline":false,"source":"{  \n  const heatmap_complete_empirical_nested = d3_soccer.heatmap(pitch)\n    .colorScale(d3.scaleLinear().domain([-1, 1]).range([\"white\", \"white\"]))\n    .enableInteraction(true)\n    .onSelect((x, y, v) => {\n      const rawMinValue = d3.min(v, d => d.value);\n      const rawMaxValue = d3.max(v, d => d.value);\n      const minValue = Math.max(rawMinValue, -1);\n      const maxValue = Math.min(rawMaxValue, 1);\n  \n      d3.select(\"#pv-min-complete-empirical-nested\").text(minValue.toFixed(3));\n      d3.select(\"#pv-max-complete-empirical-nested\").text(maxValue.toFixed(3));\n      const cells = d3\n        .select(\"#heatmap-complete-empirical-nested\")\n        .selectAll(\"rect.cell\")\n        .data(v)\n  \n      cells.enter()\n        .merge(cells)\n        .attr(\"x\", d => d.x)\n        .attr(\"y\", d => d.y)\n        .attr(\"width\", d => d.width)\n        .attr(\"height\", d => d.height)\n        .style(\"fill\", d => colorScaleComplete(+d.value));\n\n      d3.select(\"#heatmap-complete-empirical-nested\")\n        .selectAll(\"text\")\n        .remove();\n        \n      cells.each(function(d, i) {\n        const cell = d3.select(this.parentNode);\n        const bbox = this.getBBox();\n        cell.append(\"text\")\n          .attr(\"x\", bbox.x + bbox.width / 2)\n          .attr(\"y\", bbox.y + bbox.height / 2)\n          .attr(\"text-anchor\", \"middle\")\n          .attr(\"alignment-baseline\", \"central\")\n          .style(\"font-size\", \"3px\")\n          .style(\"pointer-events\", \"none\")\n          .text((d.prop * 100).toFixed(1) + \"%\");\n      });\n      \n      cells.exit().remove();\n\n      d3.select(\"#heatmap-complete-empirical-nested\")\n        .selectAll(\"rect.cell\")\n        .data(complete_empirical_nested_pv_data)\n\n    })\n    .parent_el(\"#heatmap-complete-empirical-nested\")\n    .interpolate(false);\n  \n  // plot heatmap\n  d3.select(\"#heatmap-complete-empirical-nested\")\n    .html(\"\")\n    .datum(complete_empirical_nested_pv_data)\n    .call(heatmap_complete_empirical_nested);\n}\n"},{"methodName":"interpret","cellName":"ojs-cell-7","inline":false,"source":"{\n  const chart = d3.create(\"div\").style(\"background-color\", \"8f8f8f\")\n  const title = chart.append(\"div\").attr(\"id\", \"heatmap-title-incomplete-empirical\")\n  title.append(\"p\").html(`PV: <span id='pv-value-incomplete-empirical'>0</span>`)\n  chart.append(\"div\").attr(\"id\", \"heatmap-incomplete-empirical\")\n\n  const legendSwatchContainer = chart.append(\"div\")\n    .attr(\"id\", \"heatmap-legend-incomplete-empirical\")\n    .style(\"display\", \"flex\")\n    .style(\"flex-direction\", \"column\")\n    .style(\"align-items\", \"center\")\n    .style(\"width\", \"100%\");\n\n  const legendRange = [\n    1.1 * d3.min(colorScaleIncompleteRange),\n    1.1 * d3.max(colorScaleIncompleteRange)\n  ];\n  const stepSize = (legendRange[1] - legendRange[0]) / (swatchParams.num - 1);\n  const legendSwatches = d3.range(legendRange[0], legendRange[1] + stepSize, stepSize);\n  legendSwatches[legendSwatches.length - 1] = legendRange[1];\n\n  const totalLegendWidth = swatchParams.width * swatchParams.num;\n\n  const swatchRow = legendSwatchContainer.append(\"div\")\n    .style(\"display\", \"flex\")\n    .style(\"justify-content\", \"center\")\n    .style(\"width\", \"100%\");\n\n  swatchRow.selectAll(\"div\")\n    .data(legendSwatches)\n    .enter()\n    .append(\"div\")\n    .style(\"width\", `${swatchParams.width}px`)\n    .style(\"height\", `${swatchParams.height}px`)\n    .style(\"background-color\", d => colorScaleIncomplete(d));\n\n  const labelRow = legendSwatchContainer.append(\"div\")\n    .style(\"display\", \"flex\")\n    .style(\"justify-content\", \"center\")\n    .style(\"width\", `${totalLegendWidth}px`);\n\n  labelRow.selectAll(\"span\")\n    .data(colorScaleIncompleteRange)\n    .enter()\n    .append(\"span\")\n    .text(d => {\n      if (d === d3.min(colorScaleIncompleteRange)) {\n        return d + \" <=\";\n      } else if (d === d3.max(colorScaleIncompleteRange)) {\n        return \">= \" + d;\n      }\n      return d;\n    })\n    .style(\"flex\", d => d === 0 ? \"1\" : null)\n    .style(\"text-align\", \"center\")\n\n  return chart.node();\n}\n"},{"methodName":"interpret","cellName":"ojs-cell-8","inline":false,"source":"{\n  const heatmap_incomplete_empirical = d3_soccer.heatmap(pitch)\n    .colorScale(colorScaleIncomplete)\n    .enableInteraction(true)\n    .onSelect((x, y, v) => {\n      const cappedValue = Math.min(Math.max(v, -1), 1);\n      d3.select(\"#pv-value-incomplete-empirical\").text(cappedValue.toFixed(3));\n    })\n    .parent_el(\"#heatmap-incomplete-empirical\")\n    .interpolate(false);\n\n  d3.select(\"#heatmap-incomplete-empirical\")\n    .html(\"\")\n    .datum(incomplete_empirical_pv_data)\n    .call(heatmap_incomplete_empirical);\n\n  const svg = d3.select(\"#heatmap-incomplete-empirical\").select(\"svg\");\n\n  const cells = svg.selectAll(\".cell\");\n\n  cells.each(function(d, i) {\n    const cell = d3.select(this);\n    const bbox = this.getBBox();\n\n    d3.select(this.parentNode)\n      .append(\"text\")\n      .attr(\"x\", bbox.x + bbox.width / 2)\n      .attr(\"y\", bbox.y + bbox.height / 2)\n      .attr(\"text-anchor\", \"middle\")\n      .attr(\"alignment-baseline\", \"central\")\n      .style(\"font-size\", \"3px\")\n      .style(\"pointer-events\", \"none\")\n      .text((d.prop * 100).toFixed(1) + \"%\");\n  });\n\n  svg.append(\"rect\")\n    .attr(\"x\", passStartParams.x)\n    .attr(\"y\", passStartParams.y)\n    .attr(\"width\", cellParams.width)\n    .attr(\"height\", cellParams.height)\n    .style(\"stroke\", \"blue\")\n    .style(\"fill\", \"none\")\n    .style(\"stroke-width\", \"1px\");\n}\n"},{"methodName":"interpret","cellName":"ojs-cell-9","inline":false,"source":"{\n  const chart = d3.create(\"div\").style(\"background-color\", \"8f8f8f\")\n  const title = chart.append(\"div\").attr(\"id\", \"heatmap-title-incomplete-empirical-nested\")\n  title.append(\"p\").html(`min PV: <span id='pv-min-incomplete-empirical-nested'>0</span>, max PV: <span id='pv-max-incomplete-empirical-nested'>0</span>`)\n  chart.append(\"div\").attr(\"id\", \"heatmap-incomplete-empirical-nested\")\n  \n  const legendSwatchContainer = chart.append(\"div\")\n    .attr(\"id\", \"heatmap-legend-incomplete-empirical-nested\")\n    .style(\"display\", \"flex\")\n    .style(\"flex-direction\", \"column\")\n    .style(\"align-items\", \"center\")\n    .style(\"width\", \"100%\");\n  \n  const legendRange = [\n    1.1 * d3.min(colorScaleIncompleteRange),\n    1.1 * d3.max(colorScaleIncompleteRange)\n  ];\n  const stepSize = (legendRange[1] - legendRange[0]) / (swatchParams.num - 1);\n  const legendSwatches = d3.range(legendRange[0], legendRange[1] + stepSize, stepSize);\n  legendSwatches[legendSwatches.length - 1] = legendRange[1];\n  \n  const totalLegendWidth = swatchParams.width * swatchParams.num;\n  \n  const swatchRow = legendSwatchContainer.append(\"div\")\n    .style(\"display\", \"flex\")\n    .style(\"justify-content\", \"center\")\n    .style(\"width\", \"100%\");\n  \n  swatchRow.selectAll(\"div\")\n    .data(legendSwatches)\n    .enter()\n    .append(\"div\")\n    .style(\"width\", `${swatchParams.width}px`)\n    .style(\"height\", `${swatchParams.height}px`)\n    .style(\"background-color\", d => colorScaleIncomplete(d));\n  \n  const labelRow = legendSwatchContainer.append(\"div\")\n    .style(\"display\", \"flex\")\n    .style(\"justify-content\", \"center\")\n    .style(\"width\", `${totalLegendWidth}px`);\n  \n  labelRow.selectAll(\"span\")\n    .data(colorScaleIncompleteRange)\n    .enter()\n    .append(\"span\")\n    .text(d => {\n      if (d === d3.min(colorScaleIncompleteRange)) {\n        return d + \" <=\";\n      } else if (d === d3.max(colorScaleIncompleteRange)) {\n        return \">= \" + d;\n      }\n      return d;\n    })\n    .style(\"flex\", d => d === 0 ? \"1\" : null)\n    .style(\"text-align\", \"center\")\n  \n  return chart.node();\n}\n"},{"methodName":"interpret","cellName":"ojs-cell-10","inline":false,"source":"{  \n  const heatmap_incomplete_empirical_nested = d3_soccer.heatmap(pitch)\n    .colorScale(d3.scaleLinear().domain([-1, 1]).range([\"white\", \"white\"]))\n    .enableInteraction(true)\n    .onSelect((x, y, v) => {\n      const rawMinValue = d3.min(v, d => d.value);\n      const rawMaxValue = d3.max(v, d => d.value);\n      const minValue = Math.max(rawMinValue, -1);\n      const maxValue = Math.min(rawMaxValue, 1);\n  \n      d3.select('#pv-min-incomplete-empirical-nested').text(minValue.toFixed(3));\n      d3.select('#pv-max-incomplete-empirical-nested').text(maxValue.toFixed(3));\n      const cells = d3\n        .select(\"#heatmap-incomplete-empirical-nested\")\n        .selectAll(\"rect.cell\")\n        .data(v);\n  \n      cells.enter()\n        .merge(cells)\n        .attr(\"x\", d => d.x)\n        .attr(\"y\", d => d.y)\n        .attr(\"width\", d => d.width)\n        .attr(\"height\", d => d.height)\n        .style(\"fill\", d => colorScaleIncomplete(+d.value));\n        \n      d3.select(\"#heatmap-incomplete-empirical-nested\")\n        .selectAll(\"text\")\n        .remove();\n        \n      cells.each(function(d, i) {\n        const cell = d3.select(this.parentNode);\n        const bbox = this.getBBox();\n        cell.append(\"text\")\n          .attr(\"x\", bbox.x + bbox.width / 2)\n          .attr(\"y\", bbox.y + bbox.height / 2)\n          .attr(\"text-anchor\", \"middle\")\n          .attr(\"alignment-baseline\", \"central\")\n          .style(\"font-size\", \"3px\")\n          .style(\"pointer-events\", \"none\")\n          .text((d.prop * 100).toFixed(1) + \"%\");\n      });\n      \n      cells.exit().remove();\n  \n      d3.select(\"#heatmap-incomplete-empirical-nested\")\n        .selectAll(\"rect.cell\")\n        .data(incomplete_empirical_nested_pv_data);\n    })\n    .parent_el(\"#heatmap-incomplete-empirical-nested\")\n    .interpolate(false);\n  \n  d3.select(\"#heatmap-incomplete-empirical-nested\")\n    .html(\"\")\n    .datum(incomplete_empirical_nested_pv_data)\n    .call(heatmap_incomplete_empirical_nested);\n}\n"},{"methodName":"interpret","cellName":"ojs-cell-11","inline":false,"source":"pitch = d3_soccer.pitch()\n  .height(300)\n  .rotate(false)\n  .showDirOfPlay(true)\n  .shadeMiddleThird(false)\n  .pitchStrokeWidth(0.5)\n  .clip([[0, 0], [105, 68]]);\n"},{"methodName":"interpret","cellName":"ojs-cell-12","inline":false,"source":"d3 = require(\"d3@v5\")\n"},{"methodName":"interpret","cellName":"ojs-cell-13","inline":false,"source":"d3_soccer = require(\"d3-soccer@0.1.0\")\n"},{"methodName":"interpret","cellName":"ojs-cell-14","inline":false,"source":"complete_empirical_prop_data  = FileAttachment(\"complete_empirical_prop_data.json\").json()\n"},{"methodName":"interpret","cellName":"ojs-cell-15","inline":false,"source":"complete_empirical_pv_data  = FileAttachment(\"complete_empirical_pv_data.json\").json()\n"},{"methodName":"interpret","cellName":"ojs-cell-16","inline":false,"source":"complete_empirical_nested_pv_data = FileAttachment(\"complete_empirical_nested_pv_data.json\").json()\n"},{"methodName":"interpret","cellName":"ojs-cell-17","inline":false,"source":"incomplete_empirical_pv_data  = FileAttachment(\"incomplete_empirical_pv_data.json\").json()\n"},{"methodName":"interpret","cellName":"ojs-cell-18","inline":false,"source":"incomplete_empirical_nested_pv_data = FileAttachment(\"incomplete_empirical_nested_pv_data.json\").json()\n"},{"methodName":"interpret","cellName":"ojs-cell-19","inline":false,"source":"colorScaleCompleteRange = [-0.025, 0, 0.025]\n"},{"methodName":"interpret","cellName":"ojs-cell-20","inline":false,"source":"colorScaleIncompleteRange = [-0.025, 0, 0.025]\n"},{"methodName":"interpret","cellName":"ojs-cell-21","inline":false,"source":"colorScaleComplete = d3.scaleLinear()\n  .domain(colorScaleCompleteRange)\n  .range([\"#a6611a\", \"white\", \"#018571\"]).clamp(true)\n"},{"methodName":"interpret","cellName":"ojs-cell-22","inline":false,"source":"colorScaleIncomplete = d3.scaleLinear()\n  .domain(colorScaleIncompleteRange)\n  .range([\"#d01c8b\", \"white\", \"#4dac26\"]).clamp(true)\n"},{"methodName":"interpret","cellName":"ojs-cell-23","inline":false,"source":"swatchParams = {\n  return {\n    width: 40,\n    height: 20,\n    num: 7\n  }\n}\n"},{"methodName":"interpret","cellName":"ojs-cell-24","inline":false,"source":"passStartParams = {\n  return {\n    x: 43.75,\n    y: 34\n  }\n}\n"},{"methodName":"interpret","cellName":"ojs-cell-25","inline":false,"source":"cellParams = {\n  return {\n    width: 8.75,\n    height: 8.5\n  }\n}\n"}]}
</script>
<script type="module">
if (window.location.protocol === "file:") { alert("The OJS runtime does not work with file:// URLs. Please use a web server to view this document."); }
window._ojs.paths.runtimeToDoc = "../../posts/ball-progression-epv";
window._ojs.paths.runtimeToRoot = "../..";
window._ojs.paths.docToRoot = "../..";
window._ojs.selfContained = false;
window._ojs.runtime.interpretFromScriptTags();
</script>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>