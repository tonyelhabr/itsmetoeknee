<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Tony ElHabr">
<meta name="dcterms.date" content="2020-10-14">
<meta name="description" content="With data.table, reticulate, and spatstat">

<title>Tony’s Blog - Decomposing and Smoothing Soccer Spatial Tendencies</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../assets/img/keyboard.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-listing/list.min.js"></script>
<script src="../../site_libs/quarto-listing/quarto-listing.js"></script>
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script>

  window.document.addEventListener("DOMContentLoaded", function (_event) {
    const listingTargetEl = window.document.querySelector('#listing-listing .list');
    if (!listingTargetEl) {
      // No listing discovered, do not attach.
      return; 
    }

    const options = {
      valueNames: [{ data: ['index'] },{ data: ['categories'] },{ data: ['listing-date-sort'] },{ data: ['listing-file-modified-sort'] }],
      
      searchColumns: [],
    };

    window['quarto-listings'] = window['quarto-listings'] || {};
    window['quarto-listings']['listing-listing'] = new List('listing-listing', options);

    if (window['quarto-listing-loaded']) {
      window['quarto-listing-loaded']();
    }
  });

  window.addEventListener('hashchange',() => {
    if (window['quarto-listing-loaded']) {
      window['quarto-listing-loaded']();
    }
  })
  </script>

<script type="text/javascript">

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-79842648-2', 'auto');

ga('send', {
  hitType: 'pageview',
  'anonymizeIp': true,
});
</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="alternate" type="application/rss+xml" title="Tony's Blog" href="index.xml"><meta name="twitter:title" content="Tony’s Blog - Decomposing and Smoothing Soccer Spatial Tendencies">
<meta name="twitter:description" content="With data.table, reticulate, and spatstat">
<meta name="twitter:image" content="https://itsmetoeknee.netlify.app/posts\decomposition-smoothing-soccer\viz_nnmf_dimensions_1to9_r_smooth.png">
<meta name="twitter:site" content="@TonyElHabr">
<meta name="twitter:image-height" content="2000">
<meta name="twitter:image-width" content="3000">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Tony’s Blog</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../projects.html">
 <span class="menu-text">Projects</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../gallery.html">
 <span class="menu-text">Data Viz</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/tonyelhabr"><i class="bi bi-github" role="img" aria-label="github">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/TonyElHabr"><i class="bi bi-twitter" role="img" aria-label="twitter">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div class="quarto-toggle-container">
                  <a href="" class="quarto-color-scheme-toggle nav-link" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
              </div>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#data" id="toc-data" class="nav-link active" data-scroll-target="#data">Data</a></li>
  <li><a href="#non-equi-joining-with-data.table" id="toc-non-equi-joining-with-data.table" class="nav-link" data-scroll-target="#non-equi-joining-with-data.table">Non-Equi Joining with <code>{data.table}</code></a></li>
  <li><a href="#non-negative-matrix-factorization-nnmf-with-reticulate-and-sklearn" id="toc-non-negative-matrix-factorization-nnmf-with-reticulate-and-sklearn" class="nav-link" data-scroll-target="#non-negative-matrix-factorization-nnmf-with-reticulate-and-sklearn">Non-Negative Matrix Factorization (NNMF) with <code>{reticulate}</code> and <code>sklearn</code></a></li>
  <li><a href="#gaussian-smoothing-with-spatstat" id="toc-gaussian-smoothing-with-spatstat" class="nav-link" data-scroll-target="#gaussian-smoothing-with-spatstat">Gaussian Smoothing with <code>{spatstat}</code></a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  </ul>
</nav>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Decomposing and Smoothing Soccer Spatial Tendencies</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
  <div class="quarto-categories">
    <div class="quarto-category">r</div>
    <div class="quarto-category">soccer</div>
  </div>
  </div>

<div>
  <div class="description">
    With data.table, reticulate, and spatstat
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Tony ElHabr </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">October 14, 2020</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<p>While reading up on modern soccer analytics (<a href="../../posts/soccer-pitch-control-r/">I’ve had an itch for soccer and tracking data recently</a>, I stumbled upon <a href="https://github.com/devinpleuler/analytics-handbook">an excellent set of tutorials</a> written by <a href="https://twitter.com/devinpleuler">Devin Pleuler</a>. In particular, his notebook on <a href="https://en.wikipedia.org/wiki/Non-negative_matrix_factorization">non-negative matrix factorization (NNMF)</a> caught my eye. I hadn’t really heard of the concept before, but it turned out to be much less daunting once I realized that it is just another type of matrix decomposition. <a href="https://en.wikipedia.org/wiki/Singular_value_decomposition">Singular value decomposition (SVD)</a>, which I’m much more familiar with, belongs to the same family of calculations (although NNMF and SVD are quite different). In an effort to really gain a better understanding of NNMF, I set out to emulate his notebook.</p>
<p>In the process of converting his python code to R, I encountered three challenges with resolutions worth documenting.</p>
<ol type="1">
<li><p>Before the NNMF calculation, I needed to perform <a href="https://www.w3resource.com/sql/joins/perform-a-non-equi-join.php">non-equi join</a> with a fairly size-able data set. Unfortunately, <a href="https://dplyr.tidyverse.org/"><code>{dplyr}</code></a><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> does not have built-in support for such a join. I tossed aside any kind of personal implicit bias against <a href="https://cran.r-project.org/web/packages/data.table/index.html"><code>{data.table}</code></a>—which is certainly the go-to option in the R ecosystem for non-equi joins—and used it for this process.</p></li>
<li><p>For the NNMF calculation, the only R implementation (that I could find) comes with the <a href="https://cran.r-project.org/web/packages/NMF/index.html">{NMF} package</a><a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>, which requires the installation of the <a href="https://cran.r-project.org/web/packages/BiocManager/index.html">Bioconductor-exclusive {BiocManager} package</a>. I’m relatively unfamiliar with <a href="https://www.bioconductor.org/">Bioconductor</a>, so this was not very appealing (although I did end up downloading <code>{NMF}</code> and trying it out). Instead, I ended up using <a href="https://rstudio.github.io/reticulate/"><code>{reticulate}</code></a> to call the <a href="https://scikit-learn.org/stable/modules/generated/sklearn.decomposition.NMF.html"><code>skearn.decomposition.NMF()</code></a> function directly (as is done in the python code). This is a perfect example of using <code>{reticulate}</code> for a non-trivial reason (i.e.&nbsp;for an algorithm).</p></li>
<li><p>After the NNMF computation, I needed to perform <a href="https://en.wikipedia.org/wiki/Gaussian_blur">2-D Gaussian smoothing</a>, which is helpful for making the output of the NNMF output more interpretable. The <a href="https://cran.r-project.org/web/packages/spatstat/index.html"><code>{spatstat}</code> package</a> had just the function for the job (<code>spatstat::blur()</code>), and it all it took for me was to write some a tidy wrapper function to integrate it nicely into my workflow.</p></li>
</ol>
<p>I’ve always considered myself a “whatever gets the job done” kind of person, not insistent on ignoring solutions that use “base” R, <code>{data.table}</code>, python, etc. Nonetheless, replicating Devin’s notebook really underscored the importance of being comfortable outside of a <code>{tidyverse}</code>-centric workflow.</p>
<p>Anyways, this post outlines the code and my thought process in porting Devin’s code to R. I’ll skip some of the details, emphasizing the things that are most interesting.</p>
<section id="data" class="level2">
<h2 class="anchored" data-anchor-id="data">Data</h2>
<p>We’ll be working with the <a href="https://github.com/statsbomb/open-data">open-sourced StatsBomb data</a> for the <a href="https://en.wikipedia.org/wiki/2018_FIFA_World_Cup">2018 Men’s World Cup</a>, which I’ve called <code>events</code> below. <a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a></p>
<p>This is a relatively large data set with lots of columns (and rows). However, we only need three columns for what we’re going to do: (1) a unique identifier for each player, <code>player_id</code>, along with their (2) <code>x</code> and (3) <code>y</code> coordinates.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>comps <span class="ot">&lt;-</span> StatsBombR<span class="sc">::</span><span class="fu">FreeCompetitions</span>()</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>matches <span class="ot">&lt;-</span> comps <span class="sc">%&gt;%</span> </span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(competition_id <span class="sc">==</span> <span class="dv">43</span>) <span class="sc">%&gt;%</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  StatsBombR<span class="sc">::</span><span class="fu">FreeMatches</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(match_date)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>events <span class="ot">&lt;-</span> StatsBombR<span class="sc">::</span><span class="fu">StatsBombFreeEvents</span>(matches)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>events <span class="ot">&lt;-</span> StatsBombR<span class="sc">::</span><span class="fu">allclean</span>(events)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>events <span class="ot">&lt;-</span> events <span class="sc">%&gt;%</span> </span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="at">player_id =</span> player.id, <span class="at">x =</span> location.x, <span class="at">y =</span> location.y) <span class="sc">%&gt;%</span> </span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>A quick summary of the data shows that there are 603 unique players, and that the <code>x</code> and <code>y</code> coordinates range from 1 to 120 (yards) and 1 to 80 respectively.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>events <span class="sc">%&gt;%</span> </span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_player =</span> <span class="fu">n_distinct</span>(player_id),</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(<span class="fu">c</span>(x, y), <span class="fu">list</span>(<span class="at">min =</span> min, <span class="at">max =</span> max, <span class="at">mean =</span> mean))</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 1 x 8</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;       n n_player x_min x_max x_mean y_min y_max y_mean</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   &lt;int&gt;    &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1 224018      603     1   120  60.05     1    80  40.37</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="non-equi-joining-with-data.table" class="level2">
<h2 class="anchored" data-anchor-id="non-equi-joining-with-data.table">Non-Equi Joining with <code>{data.table}</code></h2>
<p>Our first challenge is to convert the following chunk of python.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>x_scale, y_scale <span class="op">=</span> <span class="dv">30</span>, <span class="dv">20</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>x_bins <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="dv">120</span>, x_scale)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>y_bins <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="dv">80</span>, y_scale)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>players <span class="op">=</span> {}</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> e <span class="kw">in</span> events:</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'player'</span> <span class="kw">in</span> e.keys():</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>        player_id <span class="op">=</span> e[<span class="st">'player'</span>][<span class="st">'id'</span>]</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> player_id <span class="kw">not</span> <span class="kw">in</span> players.keys():</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>            players[player_id] <span class="op">=</span> np.zeros((x_scale, y_scale))</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>            x_bin <span class="op">=</span> <span class="bu">int</span>(np.digitize(e[<span class="st">'location'</span>][<span class="dv">0</span>], x_bins[<span class="dv">1</span>:], right<span class="op">=</span><span class="va">True</span>))</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>            y_bin <span class="op">=</span> <span class="bu">int</span>(np.digitize(e[<span class="st">'location'</span>][<span class="dv">1</span>], y_bins[<span class="dv">1</span>:], right<span class="op">=</span><span class="va">True</span>))</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>            players[player_id][x_bin][y_bin] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>:</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>            <span class="cf">pass</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>This code creates a nested <code>dict</code>, where the keys are player id’s and the values are 20x30 matrices. Each element in the matrix is an integer that represents the count of times that the player was recorded being at a certain position on the pitch. (These counts range from 0 to 94 for this data set.)</p>
<p>Some technical details:</p>
<ol type="1">
<li>The python <code>events</code> is actually a pretty heavily nested list<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>, hence the non-rectangular operations such as <code>e['player']['id']</code>.</li>
<li>Observations with missing coordinates are ignored with the <code>try</code>-<code>except</code> block.</li>
<li><code>x</code> and <code>y</code> values (elements of the <code>'location'</code> sub-list) are mapped to “bins” using <code>numpy</code>’s <code>digitize()</code> function, which is analogous to <code>base::cut()</code>.</li>
</ol>
<p>How can we do this same data manipulation in an idiomatic R fashion? We could certainly create a named list element and use <code>base::cut()</code> to closely match the python approach. However, I prefer to stick with data frames and SQL-ish operations since I think these are much more “natural” for R users.<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a></p>
<p>So, going forward with data frames and joins, it’s quickly apparent that we’ll have to do some non-equi joining. <code>{fuzzyjoin}</code> and <a href="https://cran.r-project.org/web/packages/sqldf/index.html"><code>{sqldf}</code></a> offer functionality for such an approach, but <code>{data.table}</code> is really the best option. The only minor inconvenience here is that we have to explicitly coerce our <code>events</code> data frame to a data.table.</p>
<p>We’ll also need a helper, grid-like data frame to assist with the binning. The 600-row <code>grid_xy_yards</code> data frame (30 <code>x</code> bins * 20 <code>y</code> bins) below is essentially a tidy definition of the cells of the grid upon which we are binning the <code>events</code> data. (One can use whatever flavor of <code>crossing()</code>, <code>expand.grid()</code>, <code>seq()</code>, etc. that you prefer to create a data frame like this.)</p>
<p>Visually, this grid looks like this.</p>
<p><img src="viz_grid_nnmf.png" class="img-fluid"></p>
<p>And if you prefer numbers instead of a chart, see the first 10 rows below.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>grid_xy_yards</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 600 x 5</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;     idx     x      y next_y next_x</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   &lt;int&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1     1     0  0      4.211  4.138</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2     2     0  4.211  8.421  4.138</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 3     3     0  8.421 12.63   4.138</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 4     4     0 12.63  16.84   4.138</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 5     5     0 16.84  21.05   4.138</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 6     6     0 21.05  25.26   4.138</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 7     7     0 25.26  29.47   4.138</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 8     8     0 29.47  33.68   4.138</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 9     9     0 33.68  37.89   4.138</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 10    10    0 37.89  42.11   4.138</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # ... with 590 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Two things to note about this supplementary data frame:</p>
<ol type="1">
<li><p>Cells aren’t evenly spaced integers, i.e.&nbsp;<code>x</code> cells are defined at 0, 4.138, 8.276, …, 80 instead of something like 0, 4, 8, …, 80, and <code>y</code> cells are defined at 0, 4.211, 8.421, …, 120 instead of something like 0, 4, 8, …, 120). That’s simply due to using 30 and 20 instead of 31 and 21 to split up the <code>x</code> and <code>y</code> ranges respectively. I point this out because this SQL-ish approach would have been much easier if these numbers were just integers! We could have done an inner join on an integer grid instead of non-equi-joining upon a grid of floating point numbers. Unfortunately, joining on floating point numbers as keys leads to <a href="https://stackoverflow.com/questions/52207851/how-do-you-join-on-floating-point-columns-in-sql">inconsistent results, simply due to the nature of floating points</a>.<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a></p></li>
<li><p>The index <code>idx</code> is important! This will come back into play when we do the NNMF procedure, at which point we’ll “flatten” out our <code>x</code>-<code>y</code> pairs into a 1-d format.</p></li>
</ol>
<p>Ok, on to the actual data joining.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>events_dt <span class="ot">&lt;-</span> events <span class="sc">%&gt;%</span> <span class="fu">drop_na</span>() <span class="sc">%&gt;%</span> data.table<span class="sc">::</span><span class="fu">as.data.table</span>()</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>grid_xy_yards_dt <span class="ot">&lt;-</span> grid_xy_yards <span class="sc">%&gt;%</span> data.table<span class="sc">::</span><span class="fu">as.data.table</span>()</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># We don't even have to load `{data.table}` for this to work!</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>events_binned <span class="ot">&lt;-</span> events_dt[grid_xy_yards_dt, on<span class="ot">=</span>.(x <span class="sc">&gt;</span> x, x <span class="sc">&lt;=</span> next_x, y <span class="sc">&gt;=</span> y, y <span class="sc">&lt;</span> next_y)] <span class="sc">%&gt;%</span> </span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(player_id, idx, x, y)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>events_binned</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 224,038 x 4</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    player_id   idx     x     y</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;        &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  1      5462     1     0     0</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  2      5467     1     0     0</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  3      5488     1     0     0</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  4      3632     1     0     0</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  5      5576     1     0     0</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  6      5595     1     0     0</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  7      5263     1     0     0</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  8      4063     1     0     0</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  9      5231     1     0     0</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 10      5231     1     0     0</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # ... with 224,028 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>In retrospect, this join was pretty straightforward!</p>
<p>The rest of the code below is just doing the actual tallying.</p>
<ol type="1">
<li>First, we make an intermediate data set <code>grid_players</code>, which is the Cartesian product of all possible cells in the grid and all players in <code>events</code>.</li>
<li>Second, we “add back” missing cells to <code>events_binned</code> using the intermediate data set <code>grid_players</code>.</li>
</ol>
<p>In the end, we end up with a <code>players</code> data frame with 603 <code>player_id</code>s * 30 <code>x</code> bins * 20 <code>y</code> bins = 361,800 rows.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This `dummy` column approach is an easy way to do a Cartesian join when the two data frames don't share any column names.</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>grid_players <span class="ot">&lt;-</span> grid_xy_yards <span class="sc">%&gt;%</span> </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">dummy =</span> 0L) <span class="sc">%&gt;%</span> </span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Cartesian join of all possible cells in the grid and all players in `events`.</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">full_join</span>(</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    events <span class="sc">%&gt;%</span> </span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">drop_na</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">distinct</span>(player_id) <span class="sc">%&gt;%</span> </span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">dummy =</span> 0L),</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">'dummy'</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>players <span class="ot">&lt;-</span> events_binned <span class="sc">%&gt;%</span> </span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(player_id, x, y, idx) <span class="sc">%&gt;%</span> </span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Rejoin back on the grid to 'add back' cells with empty counts (i.e. `n = 0`).</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">full_join</span>(grid_players, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">'player_id'</span>, <span class="st">'x'</span>, <span class="st">'y'</span>, <span class="st">'idx'</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>dummy, <span class="sc">-</span>next_x, <span class="sc">-</span>next_y) <span class="sc">%&gt;%</span> </span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">replace_na</span>(<span class="fu">list</span>(<span class="at">n =</span> 0L)) <span class="sc">%&gt;%</span> </span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(player_id, x, y)</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>players</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 361,800 x 5</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    player_id     x      y   idx     n</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;        &lt;int&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;int&gt; &lt;int&gt;</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  1      2941     0  0         1     0</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  2      2941     0  4.211     2     0</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  3      2941     0  8.421     3     0</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  4      2941     0 12.63      4     0</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  5      2941     0 16.84      5     0</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  6      2941     0 21.05      6     0</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  7      2941     0 25.26      7     0</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  8      2941     0 29.47      8     0</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  9      2941     0 33.68      9     0</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 10      2941     0 37.89     10     0</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # ... with 361,790 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>To make this a little bit more tangible, let’s plot Messi’s heatmap. (Is this really a blog post about soccer if it doesn’t mention Messi 😆?)</p>
<p><img src="viz_43_messi_binned.png" class="img-fluid"></p>
</section>
<section id="non-negative-matrix-factorization-nnmf-with-reticulate-and-sklearn" class="level2">
<h2 class="anchored" data-anchor-id="non-negative-matrix-factorization-nnmf-with-reticulate-and-sklearn">Non-Negative Matrix Factorization (NNMF) with <code>{reticulate}</code> and <code>sklearn</code></h2>
<p>Next up is the actual NNMF calculation. I don’t care if you’re the biggest R <a href="https://www.urbandictionary.com/define.php?term=Stan">stan</a> in the world—you have to admit that the python code to perform the NNMF is quite simple and (dare I say) elegant. The <code>comps=30</code> here means</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.decomposition <span class="im">import</span> NMF</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Flatten individual player matrices into shape=(600,) which is the product of the original shape components (30 by 20)</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>unraveled <span class="op">=</span> [np.matrix.flatten(v) <span class="cf">for</span> k, v <span class="kw">in</span> players.items()]</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>comps <span class="op">=</span> <span class="dv">30</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> NMF(n_components<span class="op">=</span>comps, init<span class="op">=</span><span class="st">'random'</span>, random_state<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>W <span class="op">=</span> model.fit_transform(unraveled)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>My understanding is that <code>comps=30</code> is telling the algorithm to reduce our original data (with 603 players) to a lower dimensional space with 30 player “archetypes” that best represent the commonalities among the 603 players.<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a> Per Devin, the choice of 30 here is somewhat arbitrary. In practice, one might perform some cross validation to identify what number minimizes some loss function, but that’s beyond the scope of what we’re doing here.</p>
<p>After re-formatting our <code>players</code> data into a wide format—equivalent to the <code>numpy.matrix.flatten()</code> call in the python code—we could use the <code>{NMF}</code> package for an R replication.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert from tidy format to wide format (603 rows x 600 columns)</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>players_mat <span class="ot">&lt;-</span> players <span class="sc">%&gt;%</span> </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(player_id, idx, n) <span class="sc">%&gt;%</span> </span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> idx, <span class="at">values_from =</span> n) <span class="sc">%&gt;%</span> </span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>player_id) <span class="sc">%&gt;%</span> </span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>()</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>comps <span class="ot">&lt;-</span> 30L</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>W <span class="ot">&lt;-</span> NMF<span class="sc">::</span><span class="fu">nmf</span>(NMF<span class="sc">::</span><span class="fu">rmatrix</span>(players_mat), <span class="at">rank =</span> comps, <span class="at">seed =</span> <span class="dv">0</span>, <span class="at">method =</span> <span class="st">'Frobenius'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>However, I found that the results weren’t all that comparable to the python results. (Perhaps I needed to define the arguments in a different manner.) So why not use <code>{reticulate}</code> and call the <code>sklearn.decomposition.NMF()</code> function to make sure that we exactly emulate the python decomposition?</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>sklearn <span class="ot">&lt;-</span> reticulate<span class="sc">::</span><span class="fu">import</span>(<span class="st">'sklearn'</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Won't work if `n_components` aren't explicitly defined as integers!</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> sklearn<span class="sc">$</span>decomposition<span class="sc">$</span><span class="fu">NMF</span>(<span class="at">n_components =</span> comps, <span class="at">init =</span> <span class="st">'random'</span>, <span class="at">random_state =</span> 0L)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>W <span class="ot">&lt;-</span> model<span class="sc">$</span><span class="fu">fit_transform</span>(players_mat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The result includes 30 20x30 matrices—one 30x20 <code>x</code>-<code>y</code> matrix for each of the 30 components (<code>comps</code>). We have some wrangling left to do to gain anything meaningful from this NNMF procedure, but we have something to work with!</p>
</section>
<section id="gaussian-smoothing-with-spatstat" class="level2">
<h2 class="anchored" data-anchor-id="gaussian-smoothing-with-spatstat">Gaussian Smoothing with <code>{spatstat}</code></h2>
<p>The last thing to do is to post-process the NNMF results and, of course, make pretty plots. The python plotting is pretty standard <code>matplotlib</code>, with the exception of the Gaussian smoothing performed on each component’s matrix <code>model.component_</code> in the loop to make sub-plots.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.ndimage <span class="im">import</span> gaussian_filter</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">9</span>):</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ...</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    z <span class="op">=</span> np.rot90(gaussian_filter(model.components_[i].reshape(x_scale, y_scale), sigma<span class="op">=</span><span class="fl">1.5</span>), <span class="dv">1</span>)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The first 9 smoothed component matrices come out looking like this. <a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a></p>
<p><img src="viz_nnmf_dimensions_1to9_py.png" class="img-fluid"></p>
<p>There’s a couple of steps involved to do the same thing in R.</p>
<ol type="1">
<li><p>First, we’ll convert the components matrices to a tidy format, <code>decomp_tidy</code></p></li>
<li><p>Second, we’ll join our tidied components matrices with our tidy grid of cells, <code>grid_xy_yards</code>, and convert our <code>x</code> and <code>y</code> bins to integers in preparation of the matrix operation performed in the subsequent step.</p></li>
<li><p>Lastly, we’ll perform the Gaussian smoothing on nested data frames with a custom function, <code>smoothen_dimension</code>, that wraps <code>spatstat::blur()</code>. This function also maps <code>idx</code> back to field positions (in meters instead of yards) using the supplementary <code>grid_xy_rev_m</code><a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a> data frame (which is a lot like <code>grid_xy_yards</code>)</p></li>
</ol>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 1</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>decomp_tidy <span class="ot">&lt;-</span> model<span class="sc">$</span>components_ <span class="sc">%&gt;%</span> </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># "Un-tidy" tibble with 30 rows (one for each dimension) and 600 columns (one for every `idx`)</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">dimension =</span> <span class="fu">row_number</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert to a tidy tibble with dimensions * x * y rows (30 * 30 * 20 = 18,000)</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>dimension, <span class="at">names_to =</span> <span class="st">'idx'</span>, <span class="at">values_to =</span> <span class="st">'value'</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># The columns from the matrix are named `V1`, `V2`, ... `V600` by default, so convert them to an integer that can be joined on.</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(idx, <span class="sc">~</span><span class="fu">str_remove</span>(.x, <span class="st">'^V'</span>) <span class="sc">%&gt;%</span> <span class="fu">as.integer</span>()))</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="do">## 2</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>decomp <span class="ot">&lt;-</span> decomp_tidy <span class="sc">%&gt;%</span> </span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Join on our grid of x-y pairs.</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Using `dense_rank` because we need indexes here (i.e. 1, 2, ..., 30 instead of 0, 4.1, 8.2, ..., 120 for `x`).</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    grid_xy_yards <span class="sc">%&gt;%</span> </span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(idx, x, y) <span class="sc">%&gt;%</span> </span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">c</span>(x, y), dense_rank))</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a><span class="do">## 3</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>smoothen_component <span class="ot">&lt;-</span> <span class="cf">function</span>(.data, ...) {</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>  mat <span class="ot">&lt;-</span> .data <span class="sc">%&gt;%</span> </span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(x, y, value) <span class="sc">%&gt;%</span> </span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> x, <span class="at">values_from =</span> value) <span class="sc">%&gt;%</span> </span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>y) <span class="sc">%&gt;%</span> </span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.matrix</span>()</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>  mat_smoothed <span class="ot">&lt;-</span> mat <span class="sc">%&gt;%</span> </span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>    spatstat<span class="sc">::</span><span class="fu">as.im</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Pass `sigma` in here.</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>    spatstat<span class="sc">::</span><span class="fu">blur</span>(...) <span class="sc">%&gt;%</span> </span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Could use `spatstat::as.data.frame.im()`, but it converts directly to x,y,value triplet of columns, which is not the format I want.</span></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pluck</span>(<span class="st">'v'</span>)</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> mat_smoothed <span class="sc">%&gt;%</span> </span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert 20x30 y-x matrix to tidy format with 20*30 rows.</span></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">y =</span> <span class="fu">row_number</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="sc">-</span>y, <span class="at">names_to =</span> <span class="st">'x'</span>, <span class="at">values_to =</span> <span class="st">'value'</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The columns from the matrix are named `V1`, `V2`, ... `V30` by default, so convert them to an integer that can be joined on.</span></span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>(x, <span class="sc">~</span><span class="fu">str_remove</span>(.x, <span class="st">'^V'</span>) <span class="sc">%&gt;%</span> <span class="fu">as.integer</span>())) <span class="sc">%&gt;%</span> </span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(x, y) <span class="sc">%&gt;%</span> </span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># "Re-index" rows with `idx`, ranging from 1 to 600.</span></span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">idx =</span> <span class="fu">row_number</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>x, <span class="sc">-</span>y) <span class="sc">%&gt;%</span> </span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert `x` and `y` indexes (i.e. 1, 2, 3, ..., to meters and flip the y-axis).</span></span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">inner_join</span>(grid_xy_rev_m) <span class="sc">%&gt;%</span> </span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Re-scale smoothed values to 0-1 range.</span></span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">frac =</span> (value <span class="sc">-</span> <span class="fu">min</span>(value)) <span class="sc">/</span> (<span class="fu">max</span>(value) <span class="sc">-</span> <span class="fu">min</span>(value))) <span class="sc">%&gt;%</span> </span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>()</span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>  res</span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>decomp_smooth <span class="ot">&lt;-</span> decomp <span class="sc">%&gt;%</span> </span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest</span>(<span class="at">data =</span> <span class="sc">-</span><span class="fu">c</span>(dimension)) <span class="sc">%&gt;%</span> </span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a>  <span class="co"># `sigma` passed into `...` of `smoothen_component()`. (`data` passed as first argument.)</span></span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">data =</span> <span class="fu">map</span>(data, smoothen_component, <span class="at">sigma =</span> <span class="fl">1.5</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(data)</span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a>decomp_smooth</span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 18,000 x 8</span></span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    dimension    value   idx     x     y next_y next_x     frac</span></span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;        &lt;int&gt;    &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;</span></span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  1         1 0.002191     1     0 68     4.211  4.138 0.004569</span></span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  2         1 0.004843     2     0 64.42  8.421  4.138 0.01064 </span></span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  3         1 0.008334     3     0 60.84 12.63   4.138 0.01863 </span></span>
<span id="cb11-67"><a href="#cb11-67" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  4         1 0.01130      4     0 57.26 16.84   4.138 0.02541 </span></span>
<span id="cb11-68"><a href="#cb11-68" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  5         1 0.01258      5     0 53.68 21.05   4.138 0.02834 </span></span>
<span id="cb11-69"><a href="#cb11-69" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  6         1 0.01208      6     0 50.11 25.26   4.138 0.02719 </span></span>
<span id="cb11-70"><a href="#cb11-70" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  7         1 0.01033      7     0 46.53 29.47   4.138 0.02319 </span></span>
<span id="cb11-71"><a href="#cb11-71" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  8         1 0.008165     8     0 42.95 33.68   4.138 0.01824 </span></span>
<span id="cb11-72"><a href="#cb11-72" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  9         1 0.006156     9     0 39.37 37.89   4.138 0.01364 </span></span>
<span id="cb11-73"><a href="#cb11-73" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 10         1 0.004425    10     0 35.79 42.11   4.138 0.009680</span></span>
<span id="cb11-74"><a href="#cb11-74" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # ... with 17,990 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>With the data in the proper format, the plotting is pretty straightforward <code>{ggplot2}</code> code.</p>
<p><img src="viz_nnmf_dimensions_1to9_r_smooth.png" class="img-fluid"></p>
<p>Viola! I would say that our R version of the python plot is very comparable (just by visual inspection). Note that we could achieve a similar visual profile without the smoothing—see below—but the smoothing undoubtedly makes pattern detection a little less ambiguous.</p>
<p><img src="viz_nnmf_dimensions_1to9_r_unsmooth.png" class="img-fluid"></p>
<p>From the smoothed contours, we can discern several different player profiles (in terms of positioning).</p>
<ul>
<li>Components 1, 5, 9: left back</li>
<li>Components 2: right midfielder</li>
<li>Component 3: attacking right midfielder</li>
<li>Component 4: wide left midfielder</li>
<li>Component 6: central left midfielder</li>
<li>Components 7, 8: goalkeeper</li>
</ul>
<p>The redundancy with left back and goalkeeper is not ideal. That’s certainly something we could fine tune with more experimentation with components. Anyways, the point of this post wasn’t so much about the insights that could be gained (although that’s ultimately what stakeholders would be interested in if this were a “real” analysis).</p>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>Translating python code can be challenging, throwing us off from our typical workflow (for me, being <code>{tidyverse}</code>-centric). But hopefully one can see the value in “doing whatever it takes”, even if it means using “non-tidy” R functions (e.g.&nbsp;<code>{data.table}</code>, matrices, etc.) or a different language altogether.</p>



<!-- -->

</section>


<div class="quarto-listing quarto-listing-container-default" id="listing-listing">
<div class="list quarto-listing-default">

</div>
<div class="listing-no-matching d-none">
No matching items
</div>
</div><div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>the go-to package for data manipulation and all SQL-ish things<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>Non-negative matrix factorization may also be abbreviated just as NMF, hence the package name.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>There’s nothing too interesting about the data retrieval—I’ve essentially just called <code>StatsBombR::FreeCompetitions()</code>, <code>StatsBombR::FreeMatches()</code>,<code>StatsBombR::FreeEvents()</code>, and <code>StatsBombR::allclean()</code> in succession for <code>competition_id = 43</code>.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>minimally converted from the original JSON format<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>compared to <code>dict</code> and <code>list</code>s or python users<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6"><p>A potential solution would be to round the floating point numbers before joining and “restore” them after the join, but that’s just kluge-y and inelegant.<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn7"><p>I believe the number of components is analogous to the number of components that one would define in performing <a href="https://en.wikipedia.org/wiki/Principal_component_analysis">principal components analysis (PCA)</a>.<a href="#fnref7" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn8"><p>There is nothing stopping us from plotting all 30 components—and, in fact, Devin does in his notebook—but I think it’s easier to digest a fraction of the components (for pedagogical purposes).<a href="#fnref8" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn9"><p>StatsBomb data treats the origin as the top-left corner of the pitch, which I find inconvenient for plotting since I prefer the origin to be the bottom left. Thus, this grid also flip the y-axis of the grid, hence the <code>_rev</code> part of the variable name.<a href="#fnref9" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb12" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> Decomposing and Smoothing Soccer Spatial Tendencies</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="an">description:</span><span class="co"> With data.table, reticulate, and spatstat</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> 2020-10-14</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="an">categories:</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co">  - r</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co">  - soccer</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="an">image:</span><span class="co"> viz_nnmf_dimensions_1to9_r_smooth.png</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="co">  include: true</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="co">  echo: true</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>While reading up on modern soccer analytics (<span class="co">[</span><span class="ot">I've had an itch for soccer and tracking data recently</span><span class="co">](/posts/soccer-pitch-control-r/)</span>, I stumbled upon <span class="co">[</span><span class="ot">an excellent set of tutorials</span><span class="co">](https://github.com/devinpleuler/analytics-handbook)</span> written by <span class="co">[</span><span class="ot">Devin Pleuler</span><span class="co">](https://twitter.com/devinpleuler)</span>. In particular, his notebook on <span class="co">[</span><span class="ot">non-negative matrix factorization (NNMF)</span><span class="co">](https://en.wikipedia.org/wiki/Non-negative_matrix_factorization)</span> caught my eye. I hadn't really heard of the concept before, but it turned out to be much less daunting once I realized that it is just another type of matrix decomposition. <span class="co">[</span><span class="ot">Singular value decomposition (SVD)</span><span class="co">](https://en.wikipedia.org/wiki/Singular_value_decomposition)</span>, which I'm much more familiar with, belongs to the same family of calculations (although NNMF and SVD are quite different). In an effort to really gain a better understanding of NNMF, I set out to emulate his notebook.</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>In the process of converting his python code to R, I encountered three challenges with resolutions worth documenting.</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>1)  Before the NNMF calculation, I needed to perform <span class="co">[</span><span class="ot">non-equi join</span><span class="co">](https://www.w3resource.com/sql/joins/perform-a-non-equi-join.php)</span> with a fairly size-able data set. Unfortunately, <span class="co">[</span><span class="ot">`{dplyr}`</span><span class="co">](https://dplyr.tidyverse.org/)</span><span class="ot">[^1]</span> does not have built-in support for such a join. I tossed aside any kind of personal implicit bias against <span class="co">[</span><span class="ot">`{data.table}`</span><span class="co">](https://cran.r-project.org/web/packages/data.table/index.html)</span>---which is certainly the go-to option in the R ecosystem for non-equi joins---and used it for this process.</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>2)  For the NNMF calculation, the only R implementation (that I could find) comes with the <span class="co">[</span><span class="ot">{NMF} package</span><span class="co">](https://cran.r-project.org/web/packages/NMF/index.html)</span><span class="ot">[^2]</span>, which requires the installation of the <span class="co">[</span><span class="ot">Bioconductor-exclusive {BiocManager} package</span><span class="co">](https://cran.r-project.org/web/packages/BiocManager/index.html)</span>. I'm relatively unfamiliar with <span class="co">[</span><span class="ot">Bioconductor</span><span class="co">](https://www.bioconductor.org/)</span>, so this was not very appealing (although I did end up downloading <span class="in">`{NMF}`</span> and trying it out). Instead, I ended up using <span class="co">[</span><span class="ot">`{reticulate}`</span><span class="co">](https://rstudio.github.io/reticulate/)</span> to call the <span class="co">[</span><span class="ot">`skearn.decomposition.NMF()`</span><span class="co">](https://scikit-learn.org/stable/modules/generated/sklearn.decomposition.NMF.html)</span> function directly (as is done in the python code). This is a perfect example of using <span class="in">`{reticulate}`</span> for a non-trivial reason (i.e. for an algorithm).</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>3)  After the NNMF computation, I needed to perform <span class="co">[</span><span class="ot">2-D Gaussian smoothing</span><span class="co">](https://en.wikipedia.org/wiki/Gaussian_blur)</span>, which is helpful for making the output of the NNMF output more interpretable. The <span class="co">[</span><span class="ot">`{spatstat}` package</span><span class="co">](https://cran.r-project.org/web/packages/spatstat/index.html)</span> had just the function for the job (<span class="in">`spatstat::blur()`</span>), and it all it took for me was to write some a tidy wrapper function to integrate it nicely into my workflow.</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a><span class="ot">[^1]: </span>the go-to package for data manipulation and all SQL-ish things</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a><span class="ot">[^2]: </span>Non-negative matrix factorization may also be abbreviated just as NMF, hence the package name.</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>I've always considered myself a "whatever gets the job done" kind of person, not insistent on ignoring solutions that use "base" R, <span class="in">`{data.table}`</span>, python, etc. Nonetheless, replicating Devin's notebook really underscored the importance of being comfortable outside of a <span class="in">`{tidyverse}`</span>-centric workflow.</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>Anyways, this post outlines the code and my thought process in porting Devin's code to R. I'll skip some of the details, emphasizing the things that are most interesting.</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data</span></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>We'll be working with the <span class="co">[</span><span class="ot">open-sourced StatsBomb data</span><span class="co">](https://github.com/statsbomb/open-data)</span> for the <span class="co">[</span><span class="ot">2018 Men's World Cup</span><span class="co">](https://en.wikipedia.org/wiki/2018_FIFA_World_Cup)</span>, which I've called <span class="in">`events`</span> below. <span class="ot">[^3]</span></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a><span class="ot">[^3]: </span>There's nothing too interesting about the data retrieval---I've essentially just called <span class="in">`StatsBombR::FreeCompetitions()`</span>, <span class="in">`StatsBombR::FreeMatches()`</span>,<span class="in">`StatsBombR::FreeEvents()`</span>, and <span class="in">`StatsBombR::allclean()`</span> in succession for <span class="in">`competition_id = 43`</span>.</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>This is a relatively large data set with lots of columns (and rows). However, we only need three columns for what we're going to do: (1) a unique identifier for each player, <span class="in">`player_id`</span>, along with their (2) <span class="in">`x`</span> and (3) <span class="in">`y`</span> coordinates.</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: import-data</span></span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: show</span></span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>comps <span class="ot">&lt;-</span> StatsBombR<span class="sc">::</span><span class="fu">FreeCompetitions</span>()</span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>matches <span class="ot">&lt;-</span> comps <span class="sc">%&gt;%</span> </span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(competition_id <span class="sc">==</span> <span class="dv">43</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>  StatsBombR<span class="sc">::</span><span class="fu">FreeMatches</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(match_date)</span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a>events <span class="ot">&lt;-</span> StatsBombR<span class="sc">::</span><span class="fu">StatsBombFreeEvents</span>(matches)</span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a>events <span class="ot">&lt;-</span> StatsBombR<span class="sc">::</span><span class="fu">allclean</span>(events)</span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a>events <span class="ot">&lt;-</span> events <span class="sc">%&gt;%</span> </span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="at">player_id =</span> player.id, <span class="at">x =</span> location.x, <span class="at">y =</span> location.y) <span class="sc">%&gt;%</span> </span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>()</span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a>A quick summary of the data shows that there are 603 unique players, and that the <span class="in">`x`</span> and <span class="in">`y`</span> coordinates range from 1 to 120 (yards) and 1 to 80 respectively.</span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb12-65"><a href="#cb12-65" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: events</span></span>
<span id="cb12-66"><a href="#cb12-66" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: show</span></span>
<span id="cb12-67"><a href="#cb12-67" aria-hidden="true" tabindex="-1"></a>events <span class="sc">%&gt;%</span> </span>
<span id="cb12-68"><a href="#cb12-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb12-69"><a href="#cb12-69" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb12-70"><a href="#cb12-70" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_player =</span> <span class="fu">n_distinct</span>(player_id),</span>
<span id="cb12-71"><a href="#cb12-71" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(<span class="fu">c</span>(x, y), <span class="fu">list</span>(<span class="at">min =</span> min, <span class="at">max =</span> max, <span class="at">mean =</span> mean))</span>
<span id="cb12-72"><a href="#cb12-72" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-73"><a href="#cb12-73" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 1 x 8</span></span>
<span id="cb12-74"><a href="#cb12-74" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;       n n_player x_min x_max x_mean y_min y_max y_mean</span></span>
<span id="cb12-75"><a href="#cb12-75" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   &lt;int&gt;    &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span id="cb12-76"><a href="#cb12-76" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1 224018      603     1   120  60.05     1    80  40.37</span></span>
<span id="cb12-77"><a href="#cb12-77" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-78"><a href="#cb12-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-79"><a href="#cb12-79" aria-hidden="true" tabindex="-1"></a><span class="fu">## Non-Equi Joining with `{data.table}`</span></span>
<span id="cb12-80"><a href="#cb12-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-81"><a href="#cb12-81" aria-hidden="true" tabindex="-1"></a>Our first challenge is to convert the following chunk of python.</span>
<span id="cb12-82"><a href="#cb12-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-85"><a href="#cb12-85" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb12-86"><a href="#cb12-86" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: python-players</span></span>
<span id="cb12-87"><a href="#cb12-87" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: show</span></span>
<span id="cb12-88"><a href="#cb12-88" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb12-89"><a href="#cb12-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-90"><a href="#cb12-90" aria-hidden="true" tabindex="-1"></a>x_scale, y_scale <span class="op">=</span> <span class="dv">30</span>, <span class="dv">20</span></span>
<span id="cb12-91"><a href="#cb12-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-92"><a href="#cb12-92" aria-hidden="true" tabindex="-1"></a>x_bins <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="dv">120</span>, x_scale)</span>
<span id="cb12-93"><a href="#cb12-93" aria-hidden="true" tabindex="-1"></a>y_bins <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="dv">80</span>, y_scale)</span>
<span id="cb12-94"><a href="#cb12-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-95"><a href="#cb12-95" aria-hidden="true" tabindex="-1"></a>players <span class="op">=</span> {}</span>
<span id="cb12-96"><a href="#cb12-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-97"><a href="#cb12-97" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> e <span class="kw">in</span> events:</span>
<span id="cb12-98"><a href="#cb12-98" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'player'</span> <span class="kw">in</span> e.keys():</span>
<span id="cb12-99"><a href="#cb12-99" aria-hidden="true" tabindex="-1"></a>        player_id <span class="op">=</span> e[<span class="st">'player'</span>][<span class="st">'id'</span>]</span>
<span id="cb12-100"><a href="#cb12-100" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> player_id <span class="kw">not</span> <span class="kw">in</span> players.keys():</span>
<span id="cb12-101"><a href="#cb12-101" aria-hidden="true" tabindex="-1"></a>            players[player_id] <span class="op">=</span> np.zeros((x_scale, y_scale))</span>
<span id="cb12-102"><a href="#cb12-102" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb12-103"><a href="#cb12-103" aria-hidden="true" tabindex="-1"></a>            x_bin <span class="op">=</span> <span class="bu">int</span>(np.digitize(e[<span class="st">'location'</span>][<span class="dv">0</span>], x_bins[<span class="dv">1</span>:], right<span class="op">=</span><span class="va">True</span>))</span>
<span id="cb12-104"><a href="#cb12-104" aria-hidden="true" tabindex="-1"></a>            y_bin <span class="op">=</span> <span class="bu">int</span>(np.digitize(e[<span class="st">'location'</span>][<span class="dv">1</span>], y_bins[<span class="dv">1</span>:], right<span class="op">=</span><span class="va">True</span>))</span>
<span id="cb12-105"><a href="#cb12-105" aria-hidden="true" tabindex="-1"></a>            players[player_id][x_bin][y_bin] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb12-106"><a href="#cb12-106" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>:</span>
<span id="cb12-107"><a href="#cb12-107" aria-hidden="true" tabindex="-1"></a>            <span class="cf">pass</span></span>
<span id="cb12-108"><a href="#cb12-108" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-109"><a href="#cb12-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-110"><a href="#cb12-110" aria-hidden="true" tabindex="-1"></a>This code creates a nested <span class="in">`dict`</span>, where the keys are player id's and the values are 20x30 matrices. Each element in the matrix is an integer that represents the count of times that the player was recorded being at a certain position on the pitch. (These counts range from 0 to 94 for this data set.)</span>
<span id="cb12-111"><a href="#cb12-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-112"><a href="#cb12-112" aria-hidden="true" tabindex="-1"></a>Some technical details:</span>
<span id="cb12-113"><a href="#cb12-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-114"><a href="#cb12-114" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>The python <span class="in">`events`</span> is actually a pretty heavily nested list<span class="ot">[^4]</span>, hence the non-rectangular operations such as <span class="in">`e['player']['id']`</span>.</span>
<span id="cb12-115"><a href="#cb12-115" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>Observations with missing coordinates are ignored with the <span class="in">`try`</span>-<span class="in">`except`</span> block.</span>
<span id="cb12-116"><a href="#cb12-116" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span><span class="in">`x`</span> and <span class="in">`y`</span> values (elements of the <span class="in">`'location'`</span> sub-list) are mapped to "bins" using <span class="in">`numpy`</span>'s <span class="in">`digitize()`</span> function, which is analogous to <span class="in">`base::cut()`</span>.</span>
<span id="cb12-117"><a href="#cb12-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-118"><a href="#cb12-118" aria-hidden="true" tabindex="-1"></a><span class="ot">[^4]: </span>minimally converted from the original JSON format</span>
<span id="cb12-119"><a href="#cb12-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-120"><a href="#cb12-120" aria-hidden="true" tabindex="-1"></a>How can we do this same data manipulation in an idiomatic R fashion? We could certainly create a named list element and use <span class="in">`base::cut()`</span> to closely match the python approach. However, I prefer to stick with data frames and SQL-ish operations since I think these are much more "natural" for R users.<span class="ot">[^5]</span></span>
<span id="cb12-121"><a href="#cb12-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-122"><a href="#cb12-122" aria-hidden="true" tabindex="-1"></a><span class="ot">[^5]: </span>compared to <span class="in">`dict`</span> and <span class="in">`list`</span>s or python users</span>
<span id="cb12-123"><a href="#cb12-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-124"><a href="#cb12-124" aria-hidden="true" tabindex="-1"></a>So, going forward with data frames and joins, it's quickly apparent that we'll have to do some non-equi joining. <span class="in">`{fuzzyjoin}`</span> and <span class="co">[</span><span class="ot">`{sqldf}`</span><span class="co">](https://cran.r-project.org/web/packages/sqldf/index.html)</span> offer functionality for such an approach, but <span class="in">`{data.table}`</span> is really the best option. The only minor inconvenience here is that we have to explicitly coerce our <span class="in">`events`</span> data frame to a data.table.</span>
<span id="cb12-125"><a href="#cb12-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-126"><a href="#cb12-126" aria-hidden="true" tabindex="-1"></a>We'll also need a helper, grid-like data frame to assist with the binning. The 600-row <span class="in">`grid_xy_yards`</span> data frame (30 <span class="in">`x`</span> bins <span class="sc">\*</span> 20 <span class="in">`y`</span> bins) below is essentially a tidy definition of the cells of the grid upon which we are binning the <span class="in">`events`</span> data. (One can use whatever flavor of <span class="in">`crossing()`</span>, <span class="in">`expand.grid()`</span>, <span class="in">`seq()`</span>, etc. that you prefer to create a data frame like this.)</span>
<span id="cb12-127"><a href="#cb12-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-128"><a href="#cb12-128" aria-hidden="true" tabindex="-1"></a>Visually, this grid looks like this.</span>
<span id="cb12-129"><a href="#cb12-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-132"><a href="#cb12-132" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb12-133"><a href="#cb12-133" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: grid_xy_yards</span></span>
<span id="cb12-134"><a href="#cb12-134" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb12-135"><a href="#cb12-135" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb12-136"><a href="#cb12-136" aria-hidden="true" tabindex="-1"></a>rng_x_yards <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">120</span>)</span>
<span id="cb12-137"><a href="#cb12-137" aria-hidden="true" tabindex="-1"></a>rng_y_yards <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">80</span>)</span>
<span id="cb12-138"><a href="#cb12-138" aria-hidden="true" tabindex="-1"></a>rng_x_m <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">105</span>)</span>
<span id="cb12-139"><a href="#cb12-139" aria-hidden="true" tabindex="-1"></a>rng_y_m <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">68</span>)</span>
<span id="cb12-140"><a href="#cb12-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-141"><a href="#cb12-141" aria-hidden="true" tabindex="-1"></a>seq_coord_yards <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">coord =</span> <span class="fu">c</span>(<span class="st">'x'</span>, <span class="st">'y'</span>), n) {</span>
<span id="cb12-142"><a href="#cb12-142" aria-hidden="true" tabindex="-1"></a>  rng <span class="ot">&lt;-</span> <span class="cf">switch</span>(coord, <span class="at">x =</span> rng_x_yards, <span class="at">y =</span> rng_y_yards)</span>
<span id="cb12-143"><a href="#cb12-143" aria-hidden="true" tabindex="-1"></a>  <span class="fu">seq</span>(rng[<span class="dv">1</span>], rng[<span class="dv">2</span>], <span class="at">length.out =</span> n)</span>
<span id="cb12-144"><a href="#cb12-144" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-145"><a href="#cb12-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-146"><a href="#cb12-146" aria-hidden="true" tabindex="-1"></a>seq_x_yards <span class="ot">&lt;-</span> <span class="fu">seq_coord_yards</span>(<span class="st">'x'</span>, <span class="at">n =</span> <span class="dv">30</span>)</span>
<span id="cb12-147"><a href="#cb12-147" aria-hidden="true" tabindex="-1"></a>seq_y_yards <span class="ot">&lt;-</span> <span class="fu">seq_coord_yards</span>(<span class="st">'y'</span>, <span class="at">n =</span> <span class="dv">20</span>)</span>
<span id="cb12-148"><a href="#cb12-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-149"><a href="#cb12-149" aria-hidden="true" tabindex="-1"></a>grid_xy_yards <span class="ot">&lt;-</span> <span class="fu">crossing</span>(</span>
<span id="cb12-150"><a href="#cb12-150" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> seq_x_yards,</span>
<span id="cb12-151"><a href="#cb12-151" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> seq_y_yards</span>
<span id="cb12-152"><a href="#cb12-152" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-153"><a href="#cb12-153" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(x, y) <span class="sc">%&gt;%</span> </span>
<span id="cb12-154"><a href="#cb12-154" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">idx =</span> <span class="fu">row_number</span>())</span>
<span id="cb12-155"><a href="#cb12-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-156"><a href="#cb12-156" aria-hidden="true" tabindex="-1"></a>grid_xy_yards <span class="ot">&lt;-</span> grid_xy_yards <span class="sc">%&gt;%</span> </span>
<span id="cb12-157"><a href="#cb12-157" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(idx, x, y) <span class="sc">%&gt;%</span> </span>
<span id="cb12-158"><a href="#cb12-158" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(x) <span class="sc">%&gt;%</span> </span>
<span id="cb12-159"><a href="#cb12-159" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">next_y =</span> dplyr<span class="sc">::</span><span class="fu">lead</span>(y) <span class="sc">%&gt;%</span> <span class="fu">coalesce</span>(y <span class="sc">+</span> (y <span class="sc">-</span> dplyr<span class="sc">::</span><span class="fu">lag</span>(y)))) <span class="sc">%&gt;%</span> </span>
<span id="cb12-160"><a href="#cb12-160" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-161"><a href="#cb12-161" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(y) <span class="sc">%&gt;%</span> </span>
<span id="cb12-162"><a href="#cb12-162" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">next_x =</span> dplyr<span class="sc">::</span><span class="fu">lead</span>(x) <span class="sc">%&gt;%</span> <span class="fu">coalesce</span>(x <span class="sc">+</span> (x <span class="sc">-</span> dplyr<span class="sc">::</span><span class="fu">lag</span>(x)))) <span class="sc">%&gt;%</span> </span>
<span id="cb12-163"><a href="#cb12-163" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb12-164"><a href="#cb12-164" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-165"><a href="#cb12-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-166"><a href="#cb12-166" aria-hidden="true" tabindex="-1"></a><span class="al">![](viz_grid_nnmf.png)</span></span>
<span id="cb12-167"><a href="#cb12-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-168"><a href="#cb12-168" aria-hidden="true" tabindex="-1"></a>And if you prefer numbers instead of a chart, see the first 10 rows below.</span>
<span id="cb12-169"><a href="#cb12-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-172"><a href="#cb12-172" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb12-173"><a href="#cb12-173" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: grid_xy_yards-show</span></span>
<span id="cb12-174"><a href="#cb12-174" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: show</span></span>
<span id="cb12-175"><a href="#cb12-175" aria-hidden="true" tabindex="-1"></a>grid_xy_yards</span>
<span id="cb12-176"><a href="#cb12-176" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 600 x 5</span></span>
<span id="cb12-177"><a href="#cb12-177" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;     idx     x      y next_y next_x</span></span>
<span id="cb12-178"><a href="#cb12-178" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   &lt;int&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span id="cb12-179"><a href="#cb12-179" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1     1     0  0      4.211  4.138</span></span>
<span id="cb12-180"><a href="#cb12-180" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2     2     0  4.211  8.421  4.138</span></span>
<span id="cb12-181"><a href="#cb12-181" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 3     3     0  8.421 12.63   4.138</span></span>
<span id="cb12-182"><a href="#cb12-182" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 4     4     0 12.63  16.84   4.138</span></span>
<span id="cb12-183"><a href="#cb12-183" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 5     5     0 16.84  21.05   4.138</span></span>
<span id="cb12-184"><a href="#cb12-184" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 6     6     0 21.05  25.26   4.138</span></span>
<span id="cb12-185"><a href="#cb12-185" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 7     7     0 25.26  29.47   4.138</span></span>
<span id="cb12-186"><a href="#cb12-186" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 8     8     0 29.47  33.68   4.138</span></span>
<span id="cb12-187"><a href="#cb12-187" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 9     9     0 33.68  37.89   4.138</span></span>
<span id="cb12-188"><a href="#cb12-188" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 10    10    0 37.89  42.11   4.138</span></span>
<span id="cb12-189"><a href="#cb12-189" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # ... with 590 more rows</span></span>
<span id="cb12-190"><a href="#cb12-190" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-191"><a href="#cb12-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-192"><a href="#cb12-192" aria-hidden="true" tabindex="-1"></a>Two things to note about this supplementary data frame:</span>
<span id="cb12-193"><a href="#cb12-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-194"><a href="#cb12-194" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>Cells aren't evenly spaced integers, i.e. <span class="in">`x`</span> cells are defined at 0, 4.138, 8.276, ..., 80 instead of something like 0, 4, 8, ..., 80, and <span class="in">`y`</span> cells are defined at 0, 4.211, 8.421, ..., 120 instead of something like 0, 4, 8, ..., 120). That's simply due to using 30 and 20 instead of 31 and 21 to split up the <span class="in">`x`</span> and <span class="in">`y`</span> ranges respectively. I point this out because this SQL-ish approach would have been much easier if these numbers were just integers! We could have done an inner join on an integer grid instead of non-equi-joining upon a grid of floating point numbers. Unfortunately, joining on floating point numbers as keys leads to <span class="co">[</span><span class="ot">inconsistent results, simply due to the nature of floating points</span><span class="co">](https://stackoverflow.com/questions/52207851/how-do-you-join-on-floating-point-columns-in-sql)</span>.<span class="ot">[^6]</span></span>
<span id="cb12-195"><a href="#cb12-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-196"><a href="#cb12-196" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>The index <span class="in">`idx`</span> is important! This will come back into play when we do the NNMF procedure, at which point we'll "flatten" out our <span class="in">`x`</span>-<span class="in">`y`</span> pairs into a 1-d format.</span>
<span id="cb12-197"><a href="#cb12-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-198"><a href="#cb12-198" aria-hidden="true" tabindex="-1"></a><span class="ot">[^6]: </span>A potential solution would be to round the floating point numbers before joining and "restore" them after the join, but that's just kluge-y and inelegant.</span>
<span id="cb12-199"><a href="#cb12-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-200"><a href="#cb12-200" aria-hidden="true" tabindex="-1"></a>Ok, on to the actual data joining.</span>
<span id="cb12-201"><a href="#cb12-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-204"><a href="#cb12-204" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb12-205"><a href="#cb12-205" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: events_binned</span></span>
<span id="cb12-206"><a href="#cb12-206" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: show</span></span>
<span id="cb12-207"><a href="#cb12-207" aria-hidden="true" tabindex="-1"></a>events_dt <span class="ot">&lt;-</span> events <span class="sc">%&gt;%</span> <span class="fu">drop_na</span>() <span class="sc">%&gt;%</span> data.table<span class="sc">::</span><span class="fu">as.data.table</span>()</span>
<span id="cb12-208"><a href="#cb12-208" aria-hidden="true" tabindex="-1"></a>grid_xy_yards_dt <span class="ot">&lt;-</span> grid_xy_yards <span class="sc">%&gt;%</span> data.table<span class="sc">::</span><span class="fu">as.data.table</span>()</span>
<span id="cb12-209"><a href="#cb12-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-210"><a href="#cb12-210" aria-hidden="true" tabindex="-1"></a><span class="co"># We don't even have to load `{data.table}` for this to work!</span></span>
<span id="cb12-211"><a href="#cb12-211" aria-hidden="true" tabindex="-1"></a>events_binned <span class="ot">&lt;-</span> events_dt[grid_xy_yards_dt, on<span class="ot">=</span>.(x <span class="sc">&gt;</span> x, x <span class="sc">&lt;=</span> next_x, y <span class="sc">&gt;=</span> y, y <span class="sc">&lt;</span> next_y)] <span class="sc">%&gt;%</span> </span>
<span id="cb12-212"><a href="#cb12-212" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-213"><a href="#cb12-213" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(player_id, idx, x, y)</span>
<span id="cb12-214"><a href="#cb12-214" aria-hidden="true" tabindex="-1"></a>events_binned</span>
<span id="cb12-215"><a href="#cb12-215" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 224,038 x 4</span></span>
<span id="cb12-216"><a href="#cb12-216" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    player_id   idx     x     y</span></span>
<span id="cb12-217"><a href="#cb12-217" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;        &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb12-218"><a href="#cb12-218" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  1      5462     1     0     0</span></span>
<span id="cb12-219"><a href="#cb12-219" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  2      5467     1     0     0</span></span>
<span id="cb12-220"><a href="#cb12-220" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  3      5488     1     0     0</span></span>
<span id="cb12-221"><a href="#cb12-221" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  4      3632     1     0     0</span></span>
<span id="cb12-222"><a href="#cb12-222" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  5      5576     1     0     0</span></span>
<span id="cb12-223"><a href="#cb12-223" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  6      5595     1     0     0</span></span>
<span id="cb12-224"><a href="#cb12-224" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  7      5263     1     0     0</span></span>
<span id="cb12-225"><a href="#cb12-225" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  8      4063     1     0     0</span></span>
<span id="cb12-226"><a href="#cb12-226" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  9      5231     1     0     0</span></span>
<span id="cb12-227"><a href="#cb12-227" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 10      5231     1     0     0</span></span>
<span id="cb12-228"><a href="#cb12-228" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # ... with 224,028 more rows</span></span>
<span id="cb12-229"><a href="#cb12-229" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-230"><a href="#cb12-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-231"><a href="#cb12-231" aria-hidden="true" tabindex="-1"></a>In retrospect, this join was pretty straightforward!</span>
<span id="cb12-232"><a href="#cb12-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-233"><a href="#cb12-233" aria-hidden="true" tabindex="-1"></a>The rest of the code below is just doing the actual tallying.</span>
<span id="cb12-234"><a href="#cb12-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-235"><a href="#cb12-235" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>First, we make an intermediate data set <span class="in">`grid_players`</span>, which is the Cartesian product of all possible cells in the grid and all players in <span class="in">`events`</span>.</span>
<span id="cb12-236"><a href="#cb12-236" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>Second, we "add back" missing cells to <span class="in">`events_binned`</span> using the intermediate data set <span class="in">`grid_players`</span>.</span>
<span id="cb12-237"><a href="#cb12-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-238"><a href="#cb12-238" aria-hidden="true" tabindex="-1"></a>In the end, we end up with a <span class="in">`players`</span> data frame with 603 <span class="in">`player_id`</span>s <span class="sc">\*</span> 30 <span class="in">`x`</span> bins <span class="sc">\*</span> 20 <span class="in">`y`</span> bins = 361,800 rows.</span>
<span id="cb12-239"><a href="#cb12-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-242"><a href="#cb12-242" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb12-243"><a href="#cb12-243" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: players</span></span>
<span id="cb12-244"><a href="#cb12-244" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: show</span></span>
<span id="cb12-245"><a href="#cb12-245" aria-hidden="true" tabindex="-1"></a><span class="co"># This `dummy` column approach is an easy way to do a Cartesian join when the two data frames don't share any column names.</span></span>
<span id="cb12-246"><a href="#cb12-246" aria-hidden="true" tabindex="-1"></a>grid_players <span class="ot">&lt;-</span> grid_xy_yards <span class="sc">%&gt;%</span> </span>
<span id="cb12-247"><a href="#cb12-247" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">dummy =</span> 0L) <span class="sc">%&gt;%</span> </span>
<span id="cb12-248"><a href="#cb12-248" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Cartesian join of all possible cells in the grid and all players in `events`.</span></span>
<span id="cb12-249"><a href="#cb12-249" aria-hidden="true" tabindex="-1"></a>  <span class="fu">full_join</span>(</span>
<span id="cb12-250"><a href="#cb12-250" aria-hidden="true" tabindex="-1"></a>    events <span class="sc">%&gt;%</span> </span>
<span id="cb12-251"><a href="#cb12-251" aria-hidden="true" tabindex="-1"></a>      <span class="fu">drop_na</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-252"><a href="#cb12-252" aria-hidden="true" tabindex="-1"></a>      <span class="fu">distinct</span>(player_id) <span class="sc">%&gt;%</span> </span>
<span id="cb12-253"><a href="#cb12-253" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">dummy =</span> 0L),</span>
<span id="cb12-254"><a href="#cb12-254" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">'dummy'</span></span>
<span id="cb12-255"><a href="#cb12-255" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-256"><a href="#cb12-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-257"><a href="#cb12-257" aria-hidden="true" tabindex="-1"></a>players <span class="ot">&lt;-</span> events_binned <span class="sc">%&gt;%</span> </span>
<span id="cb12-258"><a href="#cb12-258" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(player_id, x, y, idx) <span class="sc">%&gt;%</span> </span>
<span id="cb12-259"><a href="#cb12-259" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb12-260"><a href="#cb12-260" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-261"><a href="#cb12-261" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Rejoin back on the grid to 'add back' cells with empty counts (i.e. `n = 0`).</span></span>
<span id="cb12-262"><a href="#cb12-262" aria-hidden="true" tabindex="-1"></a>  <span class="fu">full_join</span>(grid_players, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">'player_id'</span>, <span class="st">'x'</span>, <span class="st">'y'</span>, <span class="st">'idx'</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-263"><a href="#cb12-263" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>dummy, <span class="sc">-</span>next_x, <span class="sc">-</span>next_y) <span class="sc">%&gt;%</span> </span>
<span id="cb12-264"><a href="#cb12-264" aria-hidden="true" tabindex="-1"></a>  <span class="fu">replace_na</span>(<span class="fu">list</span>(<span class="at">n =</span> 0L)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-265"><a href="#cb12-265" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(player_id, x, y)</span>
<span id="cb12-266"><a href="#cb12-266" aria-hidden="true" tabindex="-1"></a>players</span>
<span id="cb12-267"><a href="#cb12-267" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 361,800 x 5</span></span>
<span id="cb12-268"><a href="#cb12-268" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    player_id     x      y   idx     n</span></span>
<span id="cb12-269"><a href="#cb12-269" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;        &lt;int&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;int&gt; &lt;int&gt;</span></span>
<span id="cb12-270"><a href="#cb12-270" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  1      2941     0  0         1     0</span></span>
<span id="cb12-271"><a href="#cb12-271" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  2      2941     0  4.211     2     0</span></span>
<span id="cb12-272"><a href="#cb12-272" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  3      2941     0  8.421     3     0</span></span>
<span id="cb12-273"><a href="#cb12-273" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  4      2941     0 12.63      4     0</span></span>
<span id="cb12-274"><a href="#cb12-274" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  5      2941     0 16.84      5     0</span></span>
<span id="cb12-275"><a href="#cb12-275" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  6      2941     0 21.05      6     0</span></span>
<span id="cb12-276"><a href="#cb12-276" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  7      2941     0 25.26      7     0</span></span>
<span id="cb12-277"><a href="#cb12-277" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  8      2941     0 29.47      8     0</span></span>
<span id="cb12-278"><a href="#cb12-278" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  9      2941     0 33.68      9     0</span></span>
<span id="cb12-279"><a href="#cb12-279" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 10      2941     0 37.89     10     0</span></span>
<span id="cb12-280"><a href="#cb12-280" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # ... with 361,790 more rows</span></span>
<span id="cb12-281"><a href="#cb12-281" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-282"><a href="#cb12-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-283"><a href="#cb12-283" aria-hidden="true" tabindex="-1"></a>To make this a little bit more tangible, let's plot Messi's heatmap. (Is this really a blog post about soccer if it doesn't mention Messi 😆?)</span>
<span id="cb12-284"><a href="#cb12-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-287"><a href="#cb12-287" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb12-288"><a href="#cb12-288" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: viz_players1</span></span>
<span id="cb12-289"><a href="#cb12-289" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb12-290"><a href="#cb12-290" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb12-291"><a href="#cb12-291" aria-hidden="true" tabindex="-1"></a>.rescale_vec <span class="ot">&lt;-</span> <span class="cf">function</span>(x, rng1, rng2) {</span>
<span id="cb12-292"><a href="#cb12-292" aria-hidden="true" tabindex="-1"></a>  rng2[<span class="dv">1</span>] <span class="sc">+</span> ((x <span class="sc">-</span> rng1[<span class="dv">1</span>]) <span class="sc">*</span> (rng2[<span class="dv">2</span>] <span class="sc">-</span> rng2[<span class="dv">1</span>])) <span class="sc">/</span> (rng1[<span class="dv">2</span>] <span class="sc">-</span> rng1[<span class="dv">1</span>])</span>
<span id="cb12-293"><a href="#cb12-293" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-294"><a href="#cb12-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-295"><a href="#cb12-295" aria-hidden="true" tabindex="-1"></a>.rescale_xy_cols <span class="ot">&lt;-</span></span>
<span id="cb12-296"><a href="#cb12-296" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(.data,</span>
<span id="cb12-297"><a href="#cb12-297" aria-hidden="true" tabindex="-1"></a>           <span class="at">rng_x_from =</span> rng_x_yards,</span>
<span id="cb12-298"><a href="#cb12-298" aria-hidden="true" tabindex="-1"></a>           <span class="at">rng_y_from =</span> rng_y_yards,</span>
<span id="cb12-299"><a href="#cb12-299" aria-hidden="true" tabindex="-1"></a>           <span class="at">rng_x_to =</span> rng_x_m,</span>
<span id="cb12-300"><a href="#cb12-300" aria-hidden="true" tabindex="-1"></a>           <span class="at">rng_y_to =</span> rng_y_m,</span>
<span id="cb12-301"><a href="#cb12-301" aria-hidden="true" tabindex="-1"></a>           <span class="at">rgx_x =</span> <span class="st">'^x$'</span>,</span>
<span id="cb12-302"><a href="#cb12-302" aria-hidden="true" tabindex="-1"></a>           <span class="at">rgx_y =</span> <span class="st">'^y$'</span>,</span>
<span id="cb12-303"><a href="#cb12-303" aria-hidden="true" tabindex="-1"></a>           <span class="at">scaler_x =</span> <span class="dv">1</span>,</span>
<span id="cb12-304"><a href="#cb12-304" aria-hidden="true" tabindex="-1"></a>           <span class="at">scaler_y =</span> <span class="dv">1</span>) {</span>
<span id="cb12-305"><a href="#cb12-305" aria-hidden="true" tabindex="-1"></a>    res <span class="ot">&lt;-</span></span>
<span id="cb12-306"><a href="#cb12-306" aria-hidden="true" tabindex="-1"></a>      .data <span class="sc">%&gt;%</span></span>
<span id="cb12-307"><a href="#cb12-307" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb12-308"><a href="#cb12-308" aria-hidden="true" tabindex="-1"></a>        <span class="fu">across</span>(</span>
<span id="cb12-309"><a href="#cb12-309" aria-hidden="true" tabindex="-1"></a>          <span class="fu">matches</span>(rgx_x),</span>
<span id="cb12-310"><a href="#cb12-310" aria-hidden="true" tabindex="-1"></a>          <span class="sc">~</span> <span class="fu">.rescale_vec</span>(scaler_x <span class="sc">*</span> .x, rng_x_from, rng_x_to)</span>
<span id="cb12-311"><a href="#cb12-311" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb12-312"><a href="#cb12-312" aria-hidden="true" tabindex="-1"></a>        <span class="fu">across</span>(</span>
<span id="cb12-313"><a href="#cb12-313" aria-hidden="true" tabindex="-1"></a>          <span class="fu">matches</span>(rgx_y),</span>
<span id="cb12-314"><a href="#cb12-314" aria-hidden="true" tabindex="-1"></a>          <span class="sc">~</span> <span class="fu">.rescale_vec</span>(scaler_y <span class="sc">*</span> .x, rng_y_from, rng_y_to)</span>
<span id="cb12-315"><a href="#cb12-315" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb12-316"><a href="#cb12-316" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb12-317"><a href="#cb12-317" aria-hidden="true" tabindex="-1"></a>    res</span>
<span id="cb12-318"><a href="#cb12-318" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-319"><a href="#cb12-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-320"><a href="#cb12-320" aria-hidden="true" tabindex="-1"></a><span class="co"># Fix for pitch_international here: https://github.com/Torvaney/ggsoccer/blob/master/R/dimensions.R (which has length = 106 instead of 105).</span></span>
<span id="cb12-321"><a href="#cb12-321" aria-hidden="true" tabindex="-1"></a>.pitch_international <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb12-322"><a href="#cb12-322" aria-hidden="true" tabindex="-1"></a>  <span class="at">length =</span> <span class="dv">105</span>,</span>
<span id="cb12-323"><a href="#cb12-323" aria-hidden="true" tabindex="-1"></a>  <span class="at">width =</span> <span class="dv">68</span>,</span>
<span id="cb12-324"><a href="#cb12-324" aria-hidden="true" tabindex="-1"></a>  <span class="at">penalty_box_length =</span> <span class="fl">16.5</span>,</span>
<span id="cb12-325"><a href="#cb12-325" aria-hidden="true" tabindex="-1"></a>  <span class="at">penalty_box_width =</span> <span class="fl">40.32</span>,</span>
<span id="cb12-326"><a href="#cb12-326" aria-hidden="true" tabindex="-1"></a>  <span class="at">six_yard_box_length =</span> <span class="fl">5.5</span>,</span>
<span id="cb12-327"><a href="#cb12-327" aria-hidden="true" tabindex="-1"></a>  <span class="at">six_yard_box_width =</span> <span class="fl">18.32</span>,</span>
<span id="cb12-328"><a href="#cb12-328" aria-hidden="true" tabindex="-1"></a>  <span class="at">penalty_spot_distance =</span> <span class="dv">11</span>,</span>
<span id="cb12-329"><a href="#cb12-329" aria-hidden="true" tabindex="-1"></a>  <span class="at">goal_width =</span> <span class="fl">7.32</span>,</span>
<span id="cb12-330"><a href="#cb12-330" aria-hidden="true" tabindex="-1"></a>  <span class="at">origin_x =</span> <span class="dv">0</span>,</span>
<span id="cb12-331"><a href="#cb12-331" aria-hidden="true" tabindex="-1"></a>  <span class="at">origin_y =</span> <span class="dv">0</span></span>
<span id="cb12-332"><a href="#cb12-332" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-333"><a href="#cb12-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-334"><a href="#cb12-334" aria-hidden="true" tabindex="-1"></a>..get_pitch <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">pitch_fill =</span> <span class="st">'white'</span>, <span class="at">pitch_color =</span> <span class="st">'black'</span>, <span class="at">limits =</span> <span class="cn">FALSE</span>, <span class="at">dimension =</span> .pitch_international) {</span>
<span id="cb12-335"><a href="#cb12-335" aria-hidden="true" tabindex="-1"></a>  ggsoccer<span class="sc">::</span><span class="fu">annotate_pitch</span>(</span>
<span id="cb12-336"><a href="#cb12-336" aria-hidden="true" tabindex="-1"></a>    <span class="at">dimension =</span> dimension,</span>
<span id="cb12-337"><a href="#cb12-337" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> pitch_fill, </span>
<span id="cb12-338"><a href="#cb12-338" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour =</span> pitch_color,</span>
<span id="cb12-339"><a href="#cb12-339" aria-hidden="true" tabindex="-1"></a>    <span class="at">limits =</span> limits</span>
<span id="cb12-340"><a href="#cb12-340" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-341"><a href="#cb12-341" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-342"><a href="#cb12-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-343"><a href="#cb12-343" aria-hidden="true" tabindex="-1"></a>.gg_pitch <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">pitch =</span> <span class="fu">..get_pitch</span>(), ..., <span class="at">aspect_ratio =</span> <span class="dv">68</span><span class="sc">/</span><span class="dv">105</span>) {</span>
<span id="cb12-344"><a href="#cb12-344" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span></span>
<span id="cb12-345"><a href="#cb12-345" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(</span>
<span id="cb12-346"><a href="#cb12-346" aria-hidden="true" tabindex="-1"></a>      ...,</span>
<span id="cb12-347"><a href="#cb12-347" aria-hidden="true" tabindex="-1"></a>      pitch,</span>
<span id="cb12-348"><a href="#cb12-348" aria-hidden="true" tabindex="-1"></a>      ggsoccer<span class="sc">::</span><span class="fu">theme_pitch</span>(<span class="at">aspect_ratio =</span> aspect_ratio),</span>
<span id="cb12-349"><a href="#cb12-349" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">'none'</span>)</span>
<span id="cb12-350"><a href="#cb12-350" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-351"><a href="#cb12-351" aria-hidden="true" tabindex="-1"></a>  res</span>
<span id="cb12-352"><a href="#cb12-352" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-353"><a href="#cb12-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-354"><a href="#cb12-354" aria-hidden="true" tabindex="-1"></a>viz_players1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb12-355"><a href="#cb12-355" aria-hidden="true" tabindex="-1"></a>  <span class="fu">.gg_pitch</span>(<span class="at">pitch =</span> <span class="fu">..get_pitch</span>(<span class="at">dimension =</span> ggsoccer<span class="sc">::</span>pitch_statsbomb)) <span class="sc">+</span></span>
<span id="cb12-356"><a href="#cb12-356" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_fixed</span>(<span class="at">ratio =</span> <span class="dv">2</span> <span class="sc">/</span> <span class="dv">3</span>, <span class="at">clip =</span> <span class="st">'off'</span>) <span class="sc">+</span></span>
<span id="cb12-357"><a href="#cb12-357" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb12-358"><a href="#cb12-358" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_raster</span>(</span>
<span id="cb12-359"><a href="#cb12-359" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span></span>
<span id="cb12-360"><a href="#cb12-360" aria-hidden="true" tabindex="-1"></a>      players <span class="sc">%&gt;%</span> </span>
<span id="cb12-361"><a href="#cb12-361" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(player_id <span class="sc">==</span> 5503L) <span class="sc">%&gt;%</span> </span>
<span id="cb12-362"><a href="#cb12-362" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(x <span class="sc">!=</span> <span class="fu">max</span>(x) <span class="sc">&amp;</span> y <span class="sc">!=</span> <span class="fu">max</span>(y)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-363"><a href="#cb12-363" aria-hidden="true" tabindex="-1"></a>      <span class="fu">.rescale_xy_cols</span>(</span>
<span id="cb12-364"><a href="#cb12-364" aria-hidden="true" tabindex="-1"></a>        <span class="at">rng_x_from =</span> rng_x_yards,</span>
<span id="cb12-365"><a href="#cb12-365" aria-hidden="true" tabindex="-1"></a>        <span class="at">rng_y_from =</span> rng_y_yards,</span>
<span id="cb12-366"><a href="#cb12-366" aria-hidden="true" tabindex="-1"></a>        <span class="at">rng_x_to =</span> rng_x_yards, </span>
<span id="cb12-367"><a href="#cb12-367" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Need to flip y in order to put the origin on the bottom-left instead of the top-left.</span></span>
<span id="cb12-368"><a href="#cb12-368" aria-hidden="true" tabindex="-1"></a>        <span class="at">rng_y_to =</span> <span class="fu">c</span>(<span class="fu">rev</span>(seq_y_yards)[<span class="dv">1</span>] <span class="sc">-</span> seq_y_yards[<span class="dv">2</span>], <span class="sc">-</span>seq_y_yards[<span class="dv">2</span>])</span>
<span id="cb12-369"><a href="#cb12-369" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb12-370"><a href="#cb12-370" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">fill =</span> n), <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">hjust =</span> <span class="dv">1</span>, <span class="at">vjust =</span> <span class="dv">1</span></span>
<span id="cb12-371"><a href="#cb12-371" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb12-372"><a href="#cb12-372" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_distiller</span>(<span class="at">palette =</span> <span class="st">'Reds'</span>, <span class="at">direction =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb12-373"><a href="#cb12-373" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb12-374"><a href="#cb12-374" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">'none'</span>,</span>
<span id="cb12-375"><a href="#cb12-375" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="st">'Arial'</span>, <span class="at">face =</span> <span class="st">'bold'</span>, <span class="at">size =</span> <span class="dv">18</span>, <span class="at">color =</span> <span class="st">'black'</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb12-376"><a href="#cb12-376" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="st">'Arial'</span>, <span class="at">size =</span> <span class="dv">14</span>, <span class="at">color =</span> <span class="st">'black'</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb12-377"><a href="#cb12-377" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.margin =</span> <span class="fu">margin</span>(<span class="dv">10</span>, <span class="dv">10</span>, <span class="dv">10</span>, <span class="dv">10</span>)</span>
<span id="cb12-378"><a href="#cb12-378" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb12-379"><a href="#cb12-379" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(</span>
<span id="cb12-380"><a href="#cb12-380" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">tibble</span>(<span class="at">y =</span> <span class="sc">-</span><span class="dv">4</span>, <span class="at">x_start =</span> <span class="dv">60</span> <span class="sc">-</span> <span class="dv">20</span>, <span class="at">x_end =</span> <span class="dv">60</span> <span class="sc">+</span> <span class="dv">20</span>),</span>
<span id="cb12-381"><a href="#cb12-381" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> x_start, <span class="at">y =</span> y, <span class="at">xend =</span> x_end, <span class="at">yend =</span> y),</span>
<span id="cb12-382"><a href="#cb12-382" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">1</span>,</span>
<span id="cb12-383"><a href="#cb12-383" aria-hidden="true" tabindex="-1"></a>    <span class="at">arrow =</span> <span class="fu">arrow</span>(<span class="at">length =</span> <span class="fu">unit</span>(<span class="dv">5</span>, <span class="st">'pt'</span>), <span class="at">type =</span> <span class="st">'closed'</span>)</span>
<span id="cb12-384"><a href="#cb12-384" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb12-385"><a href="#cb12-385" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(</span>
<span id="cb12-386"><a href="#cb12-386" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">tibble</span>(<span class="at">y =</span> <span class="sc">-</span><span class="dv">8</span>, <span class="at">x =</span> <span class="dv">60</span>, <span class="at">lab =</span> <span class="st">'Direction of attack'</span>),</span>
<span id="cb12-387"><a href="#cb12-387" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">label =</span> lab),</span>
<span id="cb12-388"><a href="#cb12-388" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">4</span>,</span>
<span id="cb12-389"><a href="#cb12-389" aria-hidden="true" tabindex="-1"></a>    <span class="co"># fontface = 'bold',</span></span>
<span id="cb12-390"><a href="#cb12-390" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="st">'Arial'</span></span>
<span id="cb12-391"><a href="#cb12-391" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb12-392"><a href="#cb12-392" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">'Lionel Messi'</span>, <span class="at">subtitle =</span> <span class="st">'2018 World Cup Heat Map'</span>)</span>
<span id="cb12-393"><a href="#cb12-393" aria-hidden="true" tabindex="-1"></a>viz_players1</span>
<span id="cb12-394"><a href="#cb12-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-395"><a href="#cb12-395" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(</span>
<span id="cb12-396"><a href="#cb12-396" aria-hidden="true" tabindex="-1"></a>  <span class="at">plot =</span> viz_players1, </span>
<span id="cb12-397"><a href="#cb12-397" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> fs<span class="sc">::</span><span class="fu">path</span>(<span class="fu">.get_dir_plots</span>(), <span class="st">'viz_43_messi_binned.png'</span>), </span>
<span id="cb12-398"><a href="#cb12-398" aria-hidden="true" tabindex="-1"></a>  <span class="at">width =</span> <span class="dv">8</span>, </span>
<span id="cb12-399"><a href="#cb12-399" aria-hidden="true" tabindex="-1"></a>  <span class="at">height =</span> <span class="dv">8</span> <span class="sc">*</span> <span class="dv">2</span> <span class="sc">/</span> <span class="dv">3</span> <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb12-400"><a href="#cb12-400" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-401"><a href="#cb12-401" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-402"><a href="#cb12-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-403"><a href="#cb12-403" aria-hidden="true" tabindex="-1"></a><span class="al">![](viz_43_messi_binned.png)</span></span>
<span id="cb12-404"><a href="#cb12-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-405"><a href="#cb12-405" aria-hidden="true" tabindex="-1"></a><span class="fu">## Non-Negative Matrix Factorization (NNMF) with `{reticulate}` and `sklearn`</span></span>
<span id="cb12-406"><a href="#cb12-406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-407"><a href="#cb12-407" aria-hidden="true" tabindex="-1"></a>Next up is the actual NNMF calculation. I don't care if you're the biggest R <span class="co">[</span><span class="ot">stan</span><span class="co">](https://www.urbandictionary.com/define.php?term=Stan)</span> in the world---you have to admit that the python code to perform the NNMF is quite simple and (dare I say) elegant. The <span class="in">`comps=30`</span> here means</span>
<span id="cb12-408"><a href="#cb12-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-411"><a href="#cb12-411" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb12-412"><a href="#cb12-412" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: python-nmf</span></span>
<span id="cb12-413"><a href="#cb12-413" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: show</span></span>
<span id="cb12-414"><a href="#cb12-414" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.decomposition <span class="im">import</span> NMF</span>
<span id="cb12-415"><a href="#cb12-415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-416"><a href="#cb12-416" aria-hidden="true" tabindex="-1"></a><span class="co"># Flatten individual player matrices into shape=(600,) which is the product of the original shape components (30 by 20)</span></span>
<span id="cb12-417"><a href="#cb12-417" aria-hidden="true" tabindex="-1"></a>unraveled <span class="op">=</span> [np.matrix.flatten(v) <span class="cf">for</span> k, v <span class="kw">in</span> players.items()]</span>
<span id="cb12-418"><a href="#cb12-418" aria-hidden="true" tabindex="-1"></a>comps <span class="op">=</span> <span class="dv">30</span></span>
<span id="cb12-419"><a href="#cb12-419" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> NMF(n_components<span class="op">=</span>comps, init<span class="op">=</span><span class="st">'random'</span>, random_state<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb12-420"><a href="#cb12-420" aria-hidden="true" tabindex="-1"></a>W <span class="op">=</span> model.fit_transform(unraveled)</span>
<span id="cb12-421"><a href="#cb12-421" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-422"><a href="#cb12-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-423"><a href="#cb12-423" aria-hidden="true" tabindex="-1"></a>My understanding is that <span class="in">`comps=30`</span> is telling the algorithm to reduce our original data (with 603 players) to a lower dimensional space with 30 player "archetypes" that best represent the commonalities among the 603 players.<span class="ot">[^7]</span> Per Devin, the choice of 30 here is somewhat arbitrary. In practice, one might perform some cross validation to identify what number minimizes some loss function, but that's beyond the scope of what we're doing here.</span>
<span id="cb12-424"><a href="#cb12-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-425"><a href="#cb12-425" aria-hidden="true" tabindex="-1"></a><span class="ot">[^7]: </span>I believe the number of components is analogous to the number of components that one would define in performing <span class="co">[</span><span class="ot">principal components analysis (PCA)</span><span class="co">](https://en.wikipedia.org/wiki/Principal_component_analysis)</span>.</span>
<span id="cb12-426"><a href="#cb12-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-427"><a href="#cb12-427" aria-hidden="true" tabindex="-1"></a>After re-formatting our <span class="in">`players`</span> data into a wide format---equivalent to the <span class="in">`numpy.matrix.flatten()`</span> call in the python code---we could use the <span class="in">`{NMF}`</span> package for an R replication.</span>
<span id="cb12-428"><a href="#cb12-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-431"><a href="#cb12-431" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb12-432"><a href="#cb12-432" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: r-nmf</span></span>
<span id="cb12-433"><a href="#cb12-433" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: show</span></span>
<span id="cb12-434"><a href="#cb12-434" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert from tidy format to wide format (603 rows x 600 columns)</span></span>
<span id="cb12-435"><a href="#cb12-435" aria-hidden="true" tabindex="-1"></a>players_mat <span class="ot">&lt;-</span> players <span class="sc">%&gt;%</span> </span>
<span id="cb12-436"><a href="#cb12-436" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-437"><a href="#cb12-437" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(player_id, idx, n) <span class="sc">%&gt;%</span> </span>
<span id="cb12-438"><a href="#cb12-438" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> idx, <span class="at">values_from =</span> n) <span class="sc">%&gt;%</span> </span>
<span id="cb12-439"><a href="#cb12-439" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>player_id) <span class="sc">%&gt;%</span> </span>
<span id="cb12-440"><a href="#cb12-440" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>()</span>
<span id="cb12-441"><a href="#cb12-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-442"><a href="#cb12-442" aria-hidden="true" tabindex="-1"></a>comps <span class="ot">&lt;-</span> 30L</span>
<span id="cb12-443"><a href="#cb12-443" aria-hidden="true" tabindex="-1"></a>W <span class="ot">&lt;-</span> NMF<span class="sc">::</span><span class="fu">nmf</span>(NMF<span class="sc">::</span><span class="fu">rmatrix</span>(players_mat), <span class="at">rank =</span> comps, <span class="at">seed =</span> <span class="dv">0</span>, <span class="at">method =</span> <span class="st">'Frobenius'</span>)</span>
<span id="cb12-444"><a href="#cb12-444" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-445"><a href="#cb12-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-446"><a href="#cb12-446" aria-hidden="true" tabindex="-1"></a>However, I found that the results weren't all that comparable to the python results. (Perhaps I needed to define the arguments in a different manner.) So why not use <span class="in">`{reticulate}`</span> and call the <span class="in">`sklearn.decomposition.NMF()`</span> function to make sure that we exactly emulate the python decomposition?</span>
<span id="cb12-447"><a href="#cb12-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-450"><a href="#cb12-450" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb12-451"><a href="#cb12-451" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: reticulate-nmf</span></span>
<span id="cb12-452"><a href="#cb12-452" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: show</span></span>
<span id="cb12-453"><a href="#cb12-453" aria-hidden="true" tabindex="-1"></a>sklearn <span class="ot">&lt;-</span> reticulate<span class="sc">::</span><span class="fu">import</span>(<span class="st">'sklearn'</span>)</span>
<span id="cb12-454"><a href="#cb12-454" aria-hidden="true" tabindex="-1"></a><span class="co"># Won't work if `n_components` aren't explicitly defined as integers!</span></span>
<span id="cb12-455"><a href="#cb12-455" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> sklearn<span class="sc">$</span>decomposition<span class="sc">$</span><span class="fu">NMF</span>(<span class="at">n_components =</span> comps, <span class="at">init =</span> <span class="st">'random'</span>, <span class="at">random_state =</span> 0L)</span>
<span id="cb12-456"><a href="#cb12-456" aria-hidden="true" tabindex="-1"></a>W <span class="ot">&lt;-</span> model<span class="sc">$</span><span class="fu">fit_transform</span>(players_mat)</span>
<span id="cb12-457"><a href="#cb12-457" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-458"><a href="#cb12-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-459"><a href="#cb12-459" aria-hidden="true" tabindex="-1"></a>The result includes 30 20x30 matrices---one 30x20 <span class="in">`x`</span>-<span class="in">`y`</span> matrix for each of the 30 components (<span class="in">`comps`</span>). We have some wrangling left to do to gain anything meaningful from this NNMF procedure, but we have something to work with!</span>
<span id="cb12-460"><a href="#cb12-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-461"><a href="#cb12-461" aria-hidden="true" tabindex="-1"></a><span class="fu">## Gaussian Smoothing with `{spatstat}`</span></span>
<span id="cb12-462"><a href="#cb12-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-463"><a href="#cb12-463" aria-hidden="true" tabindex="-1"></a>The last thing to do is to post-process the NNMF results and, of course, make pretty plots. The python plotting is pretty standard <span class="in">`matplotlib`</span>, with the exception of the Gaussian smoothing performed on each component's matrix <span class="in">`model.component_`</span> in the loop to make sub-plots.</span>
<span id="cb12-464"><a href="#cb12-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-467"><a href="#cb12-467" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb12-468"><a href="#cb12-468" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: gaussian_filter</span></span>
<span id="cb12-469"><a href="#cb12-469" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: show</span></span>
<span id="cb12-470"><a href="#cb12-470" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.ndimage <span class="im">import</span> gaussian_filter</span>
<span id="cb12-471"><a href="#cb12-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-472"><a href="#cb12-472" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">9</span>):</span>
<span id="cb12-473"><a href="#cb12-473" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ...</span></span>
<span id="cb12-474"><a href="#cb12-474" aria-hidden="true" tabindex="-1"></a>    z <span class="op">=</span> np.rot90(gaussian_filter(model.components_[i].reshape(x_scale, y_scale), sigma<span class="op">=</span><span class="fl">1.5</span>), <span class="dv">1</span>)</span>
<span id="cb12-475"><a href="#cb12-475" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ...</span></span>
<span id="cb12-476"><a href="#cb12-476" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-477"><a href="#cb12-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-478"><a href="#cb12-478" aria-hidden="true" tabindex="-1"></a>The first 9 smoothed component matrices come out looking like this. <span class="ot">[^8]</span></span>
<span id="cb12-479"><a href="#cb12-479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-480"><a href="#cb12-480" aria-hidden="true" tabindex="-1"></a><span class="ot">[^8]: </span>There is nothing stopping us from plotting all 30 components---and, in fact, Devin does in his notebook---but I think it's easier to digest a fraction of the components (for pedagogical purposes).</span>
<span id="cb12-481"><a href="#cb12-481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-482"><a href="#cb12-482" aria-hidden="true" tabindex="-1"></a><span class="al">![](viz_nnmf_dimensions_1to9_py.png)</span></span>
<span id="cb12-483"><a href="#cb12-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-484"><a href="#cb12-484" aria-hidden="true" tabindex="-1"></a>There's a couple of steps involved to do the same thing in R.</span>
<span id="cb12-485"><a href="#cb12-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-486"><a href="#cb12-486" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>First, we'll convert the components matrices to a tidy format, <span class="in">`decomp_tidy`</span></span>
<span id="cb12-487"><a href="#cb12-487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-488"><a href="#cb12-488" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>Second, we'll join our tidied components matrices with our tidy grid of cells, <span class="in">`grid_xy_yards`</span>, and convert our <span class="in">`x`</span> and <span class="in">`y`</span> bins to integers in preparation of the matrix operation performed in the subsequent step.</span>
<span id="cb12-489"><a href="#cb12-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-490"><a href="#cb12-490" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>Lastly, we'll perform the Gaussian smoothing on nested data frames with a custom function, <span class="in">`smoothen_dimension`</span>, that wraps <span class="in">`spatstat::blur()`</span>. This function also maps <span class="in">`idx`</span> back to field positions (in meters instead of yards) using the supplementary <span class="in">`grid_xy_rev_m`</span><span class="ot">[^9]</span> data frame (which is a lot like <span class="in">`grid_xy_yards`</span>)</span>
<span id="cb12-491"><a href="#cb12-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-492"><a href="#cb12-492" aria-hidden="true" tabindex="-1"></a><span class="ot">[^9]: </span>StatsBomb data treats the origin as the top-left corner of the pitch, which I find inconvenient for plotting since I prefer the origin to be the bottom left. Thus, this grid also flip the y-axis of the grid, hence the <span class="in">`_rev`</span> part of the variable name.</span>
<span id="cb12-493"><a href="#cb12-493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-496"><a href="#cb12-496" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb12-497"><a href="#cb12-497" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: decomp_unsmooth</span></span>
<span id="cb12-498"><a href="#cb12-498" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb12-499"><a href="#cb12-499" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb12-500"><a href="#cb12-500" aria-hidden="true" tabindex="-1"></a>grid_xy_rev_m <span class="ot">&lt;-</span> grid_xy_yards <span class="sc">%&gt;%</span></span>
<span id="cb12-501"><a href="#cb12-501" aria-hidden="true" tabindex="-1"></a>  <span class="fu">.rescale_xy_cols</span>(</span>
<span id="cb12-502"><a href="#cb12-502" aria-hidden="true" tabindex="-1"></a>    <span class="at">rng_x_from =</span> rng_x_yards,</span>
<span id="cb12-503"><a href="#cb12-503" aria-hidden="true" tabindex="-1"></a>    <span class="at">rng_y_from =</span> rng_y_yards,</span>
<span id="cb12-504"><a href="#cb12-504" aria-hidden="true" tabindex="-1"></a>    <span class="at">rng_x_to =</span> rng_x_m, </span>
<span id="cb12-505"><a href="#cb12-505" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Need to flip y in order to put the origin on the bottom-left instead of the top-left.</span></span>
<span id="cb12-506"><a href="#cb12-506" aria-hidden="true" tabindex="-1"></a>    <span class="at">rng_y_to =</span> <span class="fu">rev</span>(rng_y_m)</span>
<span id="cb12-507"><a href="#cb12-507" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-508"><a href="#cb12-508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-509"><a href="#cb12-509" aria-hidden="true" tabindex="-1"></a>decomp_unsmooth <span class="ot">&lt;-</span> model<span class="sc">$</span>components_ <span class="sc">%&gt;%</span></span>
<span id="cb12-510"><a href="#cb12-510" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb12-511"><a href="#cb12-511" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">dimension =</span> <span class="fu">row_number</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb12-512"><a href="#cb12-512" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>dimension, <span class="at">names_to =</span> <span class="st">'idx'</span>, <span class="at">values_to =</span> <span class="st">'value'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-513"><a href="#cb12-513" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(idx, <span class="sc">~</span><span class="fu">str_remove</span>(.x, <span class="st">'^V'</span>) <span class="sc">%&gt;%</span> <span class="fu">as.integer</span>())) <span class="sc">%&gt;%</span> </span>
<span id="cb12-514"><a href="#cb12-514" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(grid_xy_rev_m) <span class="sc">%&gt;%</span></span>
<span id="cb12-515"><a href="#cb12-515" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(dimension) <span class="sc">%&gt;%</span></span>
<span id="cb12-516"><a href="#cb12-516" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">frac =</span> (value <span class="sc">-</span> <span class="fu">min</span>(value)) <span class="sc">/</span> (<span class="fu">max</span>(value) <span class="sc">-</span> <span class="fu">min</span>(value))) <span class="sc">%&gt;%</span></span>
<span id="cb12-517"><a href="#cb12-517" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb12-518"><a href="#cb12-518" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-519"><a href="#cb12-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-522"><a href="#cb12-522" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb12-523"><a href="#cb12-523" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: decomp_smooth</span></span>
<span id="cb12-524"><a href="#cb12-524" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: show</span></span>
<span id="cb12-525"><a href="#cb12-525" aria-hidden="true" tabindex="-1"></a><span class="do">## 1</span></span>
<span id="cb12-526"><a href="#cb12-526" aria-hidden="true" tabindex="-1"></a>decomp_tidy <span class="ot">&lt;-</span> model<span class="sc">$</span>components_ <span class="sc">%&gt;%</span> </span>
<span id="cb12-527"><a href="#cb12-527" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-528"><a href="#cb12-528" aria-hidden="true" tabindex="-1"></a>  <span class="co"># "Un-tidy" tibble with 30 rows (one for each dimension) and 600 columns (one for every `idx`)</span></span>
<span id="cb12-529"><a href="#cb12-529" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">dimension =</span> <span class="fu">row_number</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb12-530"><a href="#cb12-530" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert to a tidy tibble with dimensions * x * y rows (30 * 30 * 20 = 18,000)</span></span>
<span id="cb12-531"><a href="#cb12-531" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>dimension, <span class="at">names_to =</span> <span class="st">'idx'</span>, <span class="at">values_to =</span> <span class="st">'value'</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-532"><a href="#cb12-532" aria-hidden="true" tabindex="-1"></a>  <span class="co"># The columns from the matrix are named `V1`, `V2`, ... `V600` by default, so convert them to an integer that can be joined on.</span></span>
<span id="cb12-533"><a href="#cb12-533" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(idx, <span class="sc">~</span><span class="fu">str_remove</span>(.x, <span class="st">'^V'</span>) <span class="sc">%&gt;%</span> <span class="fu">as.integer</span>()))</span>
<span id="cb12-534"><a href="#cb12-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-535"><a href="#cb12-535" aria-hidden="true" tabindex="-1"></a><span class="do">## 2</span></span>
<span id="cb12-536"><a href="#cb12-536" aria-hidden="true" tabindex="-1"></a>decomp <span class="ot">&lt;-</span> decomp_tidy <span class="sc">%&gt;%</span> </span>
<span id="cb12-537"><a href="#cb12-537" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Join on our grid of x-y pairs.</span></span>
<span id="cb12-538"><a href="#cb12-538" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(</span>
<span id="cb12-539"><a href="#cb12-539" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Using `dense_rank` because we need indexes here (i.e. 1, 2, ..., 30 instead of 0, 4.1, 8.2, ..., 120 for `x`).</span></span>
<span id="cb12-540"><a href="#cb12-540" aria-hidden="true" tabindex="-1"></a>    grid_xy_yards <span class="sc">%&gt;%</span> </span>
<span id="cb12-541"><a href="#cb12-541" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(idx, x, y) <span class="sc">%&gt;%</span> </span>
<span id="cb12-542"><a href="#cb12-542" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">c</span>(x, y), dense_rank))</span>
<span id="cb12-543"><a href="#cb12-543" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-544"><a href="#cb12-544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-545"><a href="#cb12-545" aria-hidden="true" tabindex="-1"></a><span class="do">## 3</span></span>
<span id="cb12-546"><a href="#cb12-546" aria-hidden="true" tabindex="-1"></a>smoothen_component <span class="ot">&lt;-</span> <span class="cf">function</span>(.data, ...) {</span>
<span id="cb12-547"><a href="#cb12-547" aria-hidden="true" tabindex="-1"></a>  mat <span class="ot">&lt;-</span> .data <span class="sc">%&gt;%</span> </span>
<span id="cb12-548"><a href="#cb12-548" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(x, y, value) <span class="sc">%&gt;%</span> </span>
<span id="cb12-549"><a href="#cb12-549" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> x, <span class="at">values_from =</span> value) <span class="sc">%&gt;%</span> </span>
<span id="cb12-550"><a href="#cb12-550" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>y) <span class="sc">%&gt;%</span> </span>
<span id="cb12-551"><a href="#cb12-551" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.matrix</span>()</span>
<span id="cb12-552"><a href="#cb12-552" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-553"><a href="#cb12-553" aria-hidden="true" tabindex="-1"></a>  mat_smoothed <span class="ot">&lt;-</span> mat <span class="sc">%&gt;%</span> </span>
<span id="cb12-554"><a href="#cb12-554" aria-hidden="true" tabindex="-1"></a>    spatstat<span class="sc">::</span><span class="fu">as.im</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-555"><a href="#cb12-555" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Pass `sigma` in here.</span></span>
<span id="cb12-556"><a href="#cb12-556" aria-hidden="true" tabindex="-1"></a>    spatstat<span class="sc">::</span><span class="fu">blur</span>(...) <span class="sc">%&gt;%</span> </span>
<span id="cb12-557"><a href="#cb12-557" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Could use `spatstat::as.data.frame.im()`, but it converts directly to x,y,value triplet of columns, which is not the format I want.</span></span>
<span id="cb12-558"><a href="#cb12-558" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pluck</span>(<span class="st">'v'</span>)</span>
<span id="cb12-559"><a href="#cb12-559" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-560"><a href="#cb12-560" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> mat_smoothed <span class="sc">%&gt;%</span> </span>
<span id="cb12-561"><a href="#cb12-561" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert 20x30 y-x matrix to tidy format with 20*30 rows.</span></span>
<span id="cb12-562"><a href="#cb12-562" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-563"><a href="#cb12-563" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">y =</span> <span class="fu">row_number</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb12-564"><a href="#cb12-564" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="sc">-</span>y, <span class="at">names_to =</span> <span class="st">'x'</span>, <span class="at">values_to =</span> <span class="st">'value'</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-565"><a href="#cb12-565" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The columns from the matrix are named `V1`, `V2`, ... `V30` by default, so convert them to an integer that can be joined on.</span></span>
<span id="cb12-566"><a href="#cb12-566" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>(x, <span class="sc">~</span><span class="fu">str_remove</span>(.x, <span class="st">'^V'</span>) <span class="sc">%&gt;%</span> <span class="fu">as.integer</span>())) <span class="sc">%&gt;%</span> </span>
<span id="cb12-567"><a href="#cb12-567" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(x, y) <span class="sc">%&gt;%</span> </span>
<span id="cb12-568"><a href="#cb12-568" aria-hidden="true" tabindex="-1"></a>    <span class="co"># "Re-index" rows with `idx`, ranging from 1 to 600.</span></span>
<span id="cb12-569"><a href="#cb12-569" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">idx =</span> <span class="fu">row_number</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb12-570"><a href="#cb12-570" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>x, <span class="sc">-</span>y) <span class="sc">%&gt;%</span> </span>
<span id="cb12-571"><a href="#cb12-571" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert `x` and `y` indexes (i.e. 1, 2, 3, ..., to meters and flip the y-axis).</span></span>
<span id="cb12-572"><a href="#cb12-572" aria-hidden="true" tabindex="-1"></a>    <span class="fu">inner_join</span>(grid_xy_rev_m) <span class="sc">%&gt;%</span> </span>
<span id="cb12-573"><a href="#cb12-573" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Re-scale smoothed values to 0-1 range.</span></span>
<span id="cb12-574"><a href="#cb12-574" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">frac =</span> (value <span class="sc">-</span> <span class="fu">min</span>(value)) <span class="sc">/</span> (<span class="fu">max</span>(value) <span class="sc">-</span> <span class="fu">min</span>(value))) <span class="sc">%&gt;%</span> </span>
<span id="cb12-575"><a href="#cb12-575" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>()</span>
<span id="cb12-576"><a href="#cb12-576" aria-hidden="true" tabindex="-1"></a>  res</span>
<span id="cb12-577"><a href="#cb12-577" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-578"><a href="#cb12-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-579"><a href="#cb12-579" aria-hidden="true" tabindex="-1"></a>decomp_smooth <span class="ot">&lt;-</span> decomp <span class="sc">%&gt;%</span> </span>
<span id="cb12-580"><a href="#cb12-580" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest</span>(<span class="at">data =</span> <span class="sc">-</span><span class="fu">c</span>(dimension)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-581"><a href="#cb12-581" aria-hidden="true" tabindex="-1"></a>  <span class="co"># `sigma` passed into `...` of `smoothen_component()`. (`data` passed as first argument.)</span></span>
<span id="cb12-582"><a href="#cb12-582" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">data =</span> <span class="fu">map</span>(data, smoothen_component, <span class="at">sigma =</span> <span class="fl">1.5</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-583"><a href="#cb12-583" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(data)</span>
<span id="cb12-584"><a href="#cb12-584" aria-hidden="true" tabindex="-1"></a>decomp_smooth</span>
<span id="cb12-585"><a href="#cb12-585" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 18,000 x 8</span></span>
<span id="cb12-586"><a href="#cb12-586" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    dimension    value   idx     x     y next_y next_x     frac</span></span>
<span id="cb12-587"><a href="#cb12-587" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;        &lt;int&gt;    &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;</span></span>
<span id="cb12-588"><a href="#cb12-588" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  1         1 0.002191     1     0 68     4.211  4.138 0.004569</span></span>
<span id="cb12-589"><a href="#cb12-589" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  2         1 0.004843     2     0 64.42  8.421  4.138 0.01064 </span></span>
<span id="cb12-590"><a href="#cb12-590" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  3         1 0.008334     3     0 60.84 12.63   4.138 0.01863 </span></span>
<span id="cb12-591"><a href="#cb12-591" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  4         1 0.01130      4     0 57.26 16.84   4.138 0.02541 </span></span>
<span id="cb12-592"><a href="#cb12-592" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  5         1 0.01258      5     0 53.68 21.05   4.138 0.02834 </span></span>
<span id="cb12-593"><a href="#cb12-593" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  6         1 0.01208      6     0 50.11 25.26   4.138 0.02719 </span></span>
<span id="cb12-594"><a href="#cb12-594" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  7         1 0.01033      7     0 46.53 29.47   4.138 0.02319 </span></span>
<span id="cb12-595"><a href="#cb12-595" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  8         1 0.008165     8     0 42.95 33.68   4.138 0.01824 </span></span>
<span id="cb12-596"><a href="#cb12-596" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  9         1 0.006156     9     0 39.37 37.89   4.138 0.01364 </span></span>
<span id="cb12-597"><a href="#cb12-597" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 10         1 0.004425    10     0 35.79 42.11   4.138 0.009680</span></span>
<span id="cb12-598"><a href="#cb12-598" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # ... with 17,990 more rows</span></span>
<span id="cb12-599"><a href="#cb12-599" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-600"><a href="#cb12-600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-601"><a href="#cb12-601" aria-hidden="true" tabindex="-1"></a>With the data in the proper format, the plotting is pretty straightforward <span class="in">`{ggplot2}`</span> code.</span>
<span id="cb12-602"><a href="#cb12-602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-605"><a href="#cb12-605" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb12-606"><a href="#cb12-606" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: plot_dimensions</span></span>
<span id="cb12-607"><a href="#cb12-607" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb12-608"><a href="#cb12-608" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb12-609"><a href="#cb12-609" aria-hidden="true" tabindex="-1"></a>.get_dir_plots <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb12-610"><a href="#cb12-610" aria-hidden="true" tabindex="-1"></a>  <span class="fu">getwd</span>()</span>
<span id="cb12-611"><a href="#cb12-611" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-612"><a href="#cb12-612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-613"><a href="#cb12-613" aria-hidden="true" tabindex="-1"></a>plot_dimensions <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb12-614"><a href="#cb12-614" aria-hidden="true" tabindex="-1"></a>    .data,</span>
<span id="cb12-615"><a href="#cb12-615" aria-hidden="true" tabindex="-1"></a>    ...,</span>
<span id="cb12-616"><a href="#cb12-616" aria-hidden="true" tabindex="-1"></a>    <span class="at">dir =</span> <span class="fu">.get_dir_plots</span>(),</span>
<span id="cb12-617"><a href="#cb12-617" aria-hidden="true" tabindex="-1"></a>    <span class="at">suffix =</span> <span class="fu">c</span>(<span class="st">'smooth'</span>, <span class="st">'unsmooth'</span>),</span>
<span id="cb12-618"><a href="#cb12-618" aria-hidden="true" tabindex="-1"></a>    <span class="at">prefix =</span> <span class="st">'viz_nnmf_dimensions_1to9_r'</span>,</span>
<span id="cb12-619"><a href="#cb12-619" aria-hidden="true" tabindex="-1"></a>    <span class="at">path =</span> fs<span class="sc">::</span><span class="fu">path</span>(dir, <span class="fu">sprintf</span>(<span class="st">'%s_%s.png'</span>, prefix, suffix))</span>
<span id="cb12-620"><a href="#cb12-620" aria-hidden="true" tabindex="-1"></a>) {</span>
<span id="cb12-621"><a href="#cb12-621" aria-hidden="true" tabindex="-1"></a>  suffix <span class="ot">&lt;-</span> <span class="fu">match.arg</span>(suffix)</span>
<span id="cb12-622"><a href="#cb12-622" aria-hidden="true" tabindex="-1"></a>  viz <span class="ot">&lt;-</span></span>
<span id="cb12-623"><a href="#cb12-623" aria-hidden="true" tabindex="-1"></a>    .data <span class="sc">%&gt;%</span></span>
<span id="cb12-624"><a href="#cb12-624" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(dimension <span class="sc">&lt;=</span> 9L) <span class="sc">%&gt;%</span></span>
<span id="cb12-625"><a href="#cb12-625" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">lab_facet =</span> <span class="fu">sprintf</span>(<span class="st">'Component %d'</span>, dimension)) <span class="sc">%&gt;%</span></span>
<span id="cb12-626"><a href="#cb12-626" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb12-627"><a href="#cb12-627" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y) <span class="sc">+</span></span>
<span id="cb12-628"><a href="#cb12-628" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb12-629"><a href="#cb12-629" aria-hidden="true" tabindex="-1"></a>    <span class="fu">.gg_pitch</span>() <span class="sc">+</span></span>
<span id="cb12-630"><a href="#cb12-630" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>( <span class="sc">~</span> lab_facet, <span class="at">ncol =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb12-631"><a href="#cb12-631" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_contour_filled</span>(<span class="fu">aes</span>(<span class="at">z =</span> frac), <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb12-632"><a href="#cb12-632" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="st">'Arial'</span>, <span class="at">size =</span> <span class="dv">8</span>, <span class="at">hjust =</span> <span class="fl">0.05</span>, <span class="at">vjust =</span> <span class="fl">0.01</span>)) <span class="sc">+</span></span>
<span id="cb12-633"><a href="#cb12-633" aria-hidden="true" tabindex="-1"></a>    <span class="co"># labs(title = sprintf(</span></span>
<span id="cb12-634"><a href="#cb12-634" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   'First 9 Components, %s',</span></span>
<span id="cb12-635"><a href="#cb12-635" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   ifelse(suffix == 'smooth', 'Smoothed', 'Not Smoothed')</span></span>
<span id="cb12-636"><a href="#cb12-636" aria-hidden="true" tabindex="-1"></a>    <span class="co"># )) +</span></span>
<span id="cb12-637"><a href="#cb12-637" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_viridis_d</span>(<span class="at">direction =</span> <span class="dv">1</span>)</span>
<span id="cb12-638"><a href="#cb12-638" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggsave</span>(</span>
<span id="cb12-639"><a href="#cb12-639" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot =</span> viz,</span>
<span id="cb12-640"><a href="#cb12-640" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> path,</span>
<span id="cb12-641"><a href="#cb12-641" aria-hidden="true" tabindex="-1"></a>    <span class="at">width =</span> <span class="dv">10</span>,</span>
<span id="cb12-642"><a href="#cb12-642" aria-hidden="true" tabindex="-1"></a>    <span class="at">height =</span> <span class="dv">10</span> <span class="sc">*</span> <span class="dv">2</span> <span class="sc">/</span> <span class="dv">3</span></span>
<span id="cb12-643"><a href="#cb12-643" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-644"><a href="#cb12-644" aria-hidden="true" tabindex="-1"></a>  viz</span>
<span id="cb12-645"><a href="#cb12-645" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-646"><a href="#cb12-646" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-647"><a href="#cb12-647" aria-hidden="true" tabindex="-1"></a>viz_smooth <span class="ot">&lt;-</span> decomp_smooth <span class="sc">%&gt;%</span> <span class="fu">plot_dimensions</span>(<span class="at">suffix =</span> <span class="st">'smooth'</span>)</span>
<span id="cb12-648"><a href="#cb12-648" aria-hidden="true" tabindex="-1"></a>viz_smooth</span>
<span id="cb12-649"><a href="#cb12-649" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-650"><a href="#cb12-650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-651"><a href="#cb12-651" aria-hidden="true" tabindex="-1"></a><span class="al">![](viz_nnmf_dimensions_1to9_r_smooth.png)</span></span>
<span id="cb12-652"><a href="#cb12-652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-653"><a href="#cb12-653" aria-hidden="true" tabindex="-1"></a>Viola! I would say that our R version of the python plot is very comparable (just by visual inspection). Note that we could achieve a similar visual profile without the smoothing---see below---but the smoothing undoubtedly makes pattern detection a little less ambiguous.</span>
<span id="cb12-654"><a href="#cb12-654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-655"><a href="#cb12-655" aria-hidden="true" tabindex="-1"></a><span class="al">![](viz_nnmf_dimensions_1to9_r_unsmooth.png)</span></span>
<span id="cb12-656"><a href="#cb12-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-657"><a href="#cb12-657" aria-hidden="true" tabindex="-1"></a>From the smoothed contours, we can discern several different player profiles (in terms of positioning).</span>
<span id="cb12-658"><a href="#cb12-658" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-659"><a href="#cb12-659" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Components 1, 5, 9: left back</span>
<span id="cb12-660"><a href="#cb12-660" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Components 2: right midfielder</span>
<span id="cb12-661"><a href="#cb12-661" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Component 3: attacking right midfielder</span>
<span id="cb12-662"><a href="#cb12-662" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Component 4: wide left midfielder</span>
<span id="cb12-663"><a href="#cb12-663" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Component 6: central left midfielder</span>
<span id="cb12-664"><a href="#cb12-664" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Components 7, 8: goalkeeper</span>
<span id="cb12-665"><a href="#cb12-665" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-666"><a href="#cb12-666" aria-hidden="true" tabindex="-1"></a>The redundancy with left back and goalkeeper is not ideal. That's certainly something we could fine tune with more experimentation with components. Anyways, the point of this post wasn't so much about the insights that could be gained (although that's ultimately what stakeholders would be interested in if this were a "real" analysis).</span>
<span id="cb12-667"><a href="#cb12-667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-668"><a href="#cb12-668" aria-hidden="true" tabindex="-1"></a><span class="fu">## Conclusion</span></span>
<span id="cb12-669"><a href="#cb12-669" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-670"><a href="#cb12-670" aria-hidden="true" tabindex="-1"></a>Translating python code can be challenging, throwing us off from our typical workflow (for me, being <span class="in">`{tidyverse}`</span>-centric). But hopefully one can see the value in "doing whatever it takes", even if it means using "non-tidy" R functions (e.g. <span class="in">`{data.table}`</span>, matrices, etc.) or a different language altogether.</span>
<span id="cb12-671"><a href="#cb12-671" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-674"><a href="#cb12-674" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb12-675"><a href="#cb12-675" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: header</span></span>
<span id="cb12-676"><a href="#cb12-676" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb12-677"><a href="#cb12-677" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb12-678"><a href="#cb12-678" aria-hidden="true" tabindex="-1"></a>pts <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb12-679"><a href="#cb12-679" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.numeric</span>(grid<span class="sc">::</span><span class="fu">convertUnit</span>(grid<span class="sc">::</span><span class="fu">unit</span>(x, <span class="st">'pt'</span>), <span class="st">'mm'</span>))</span>
<span id="cb12-680"><a href="#cb12-680" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-681"><a href="#cb12-681" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-682"><a href="#cb12-682" aria-hidden="true" tabindex="-1"></a>.generate_and_export_header <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb12-683"><a href="#cb12-683" aria-hidden="true" tabindex="-1"></a>  viz <span class="ot">&lt;-</span> </span>
<span id="cb12-684"><a href="#cb12-684" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(</span>
<span id="cb12-685"><a href="#cb12-685" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">2</span>, <span class="sc">-</span><span class="fl">1.1</span>, <span class="dv">0</span>, <span class="fl">1.1</span>, <span class="dv">2</span>),</span>
<span id="cb12-686"><a href="#cb12-686" aria-hidden="true" tabindex="-1"></a>      <span class="at">lab =</span> <span class="fu">c</span>(<span class="st">''</span>, <span class="st">'python'</span>, <span class="st">''</span>, <span class="st">'R'</span>, <span class="st">''</span>)</span>
<span id="cb12-687"><a href="#cb12-687" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb12-688"><a href="#cb12-688" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb12-689"><a href="#cb12-689" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb12-690"><a href="#cb12-690" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> lab), <span class="at">size =</span> <span class="fu">pts</span>(<span class="dv">18</span>), <span class="at">fontface =</span> <span class="st">'bold'</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb12-691"><a href="#cb12-691" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_void</span>()</span>
<span id="cb12-692"><a href="#cb12-692" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="at">plot =</span> viz, <span class="at">filename =</span> fs<span class="sc">::</span><span class="fu">path</span>(<span class="fu">.get_dir_plots</span>(), <span class="st">'header.png'</span>), <span class="at">height =</span> <span class="fl">0.5</span>, <span class="at">width =</span> <span class="dv">16</span>, <span class="at">type =</span> <span class="st">'cairo'</span>)</span>
<span id="cb12-693"><a href="#cb12-693" aria-hidden="true" tabindex="-1"></a>  viz</span>
<span id="cb12-694"><a href="#cb12-694" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-695"><a href="#cb12-695" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-696"><a href="#cb12-696" aria-hidden="true" tabindex="-1"></a>.import_png <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">lang =</span> <span class="fu">c</span>(<span class="st">'python'</span>, <span class="st">'r'</span>), <span class="at">dir =</span> <span class="fu">.get_dir_plots</span>()) {</span>
<span id="cb12-697"><a href="#cb12-697" aria-hidden="true" tabindex="-1"></a>  lang <span class="ot">&lt;-</span> <span class="fu">match.arg</span>(lang)</span>
<span id="cb12-698"><a href="#cb12-698" aria-hidden="true" tabindex="-1"></a>  suffix <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(lang <span class="sc">==</span> <span class="st">'python'</span>, <span class="st">'py'</span>, <span class="st">'r_smooth'</span>)</span>
<span id="cb12-699"><a href="#cb12-699" aria-hidden="true" tabindex="-1"></a>  path <span class="ot">&lt;-</span> fs<span class="sc">::</span><span class="fu">path</span>(dir, <span class="fu">sprintf</span>(<span class="st">'viz_nnmf_dimensions_1to9_%s.png'</span>, suffix))</span>
<span id="cb12-700"><a href="#cb12-700" aria-hidden="true" tabindex="-1"></a>  magick<span class="sc">::</span><span class="fu">image_read</span>(path)</span>
<span id="cb12-701"><a href="#cb12-701" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-702"><a href="#cb12-702" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-703"><a href="#cb12-703" aria-hidden="true" tabindex="-1"></a>.import_png_header <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">dir =</span> <span class="fu">.get_dir_plots</span>()) {</span>
<span id="cb12-704"><a href="#cb12-704" aria-hidden="true" tabindex="-1"></a>  path <span class="ot">&lt;-</span> fs<span class="sc">::</span><span class="fu">path</span>(dir, <span class="fu">sprintf</span>(<span class="st">'header.png'</span>))</span>
<span id="cb12-705"><a href="#cb12-705" aria-hidden="true" tabindex="-1"></a>  magick<span class="sc">::</span><span class="fu">image_read</span>(path)</span>
<span id="cb12-706"><a href="#cb12-706" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-707"><a href="#cb12-707" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-708"><a href="#cb12-708" aria-hidden="true" tabindex="-1"></a>.png_scale <span class="ot">&lt;-</span> <span class="cf">function</span>(img, <span class="at">dpi =</span> <span class="dv">96</span>, <span class="at">width =</span> <span class="dv">8</span>, <span class="at">height =</span> <span class="dv">10</span>, <span class="at">geometry =</span> <span class="fu">sprintf</span>(<span class="st">'%dx%d'</span>, width <span class="sc">*</span> dpi, height <span class="sc">*</span> dpi)) {</span>
<span id="cb12-709"><a href="#cb12-709" aria-hidden="true" tabindex="-1"></a>  magick<span class="sc">::</span><span class="fu">image_scale</span>(img, <span class="at">geometry =</span> geometry)</span>
<span id="cb12-710"><a href="#cb12-710" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-711"><a href="#cb12-711" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-712"><a href="#cb12-712" aria-hidden="true" tabindex="-1"></a><span class="fu">.generate_and_export_header</span>()</span>
<span id="cb12-713"><a href="#cb12-713" aria-hidden="true" tabindex="-1"></a>viz_header <span class="ot">&lt;-</span> <span class="fu">.import_png_header</span>()</span>
<span id="cb12-714"><a href="#cb12-714" aria-hidden="true" tabindex="-1"></a>viz_py <span class="ot">&lt;-</span> <span class="fu">.import_png</span>(<span class="at">lang =</span> <span class="st">'python'</span>)</span>
<span id="cb12-715"><a href="#cb12-715" aria-hidden="true" tabindex="-1"></a>viz_r <span class="ot">&lt;-</span> <span class="fu">.import_png</span>(<span class="at">lang =</span> <span class="st">'r'</span>)</span>
<span id="cb12-716"><a href="#cb12-716" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> magick<span class="sc">::</span><span class="fu">image_append</span>(<span class="fu">c</span>(<span class="fu">.png_scale</span>(viz_py), <span class="fu">.png_scale</span>(viz_r)))</span>
<span id="cb12-717"><a href="#cb12-717" aria-hidden="true" tabindex="-1"></a><span class="co"># res &lt;- magick::image_append(c(.png_scale(viz_header, height = 0.5, width = 16), res), stack = TRUE)</span></span>
<span id="cb12-718"><a href="#cb12-718" aria-hidden="true" tabindex="-1"></a>img_info <span class="ot">&lt;-</span> magick<span class="sc">::</span><span class="fu">image_info</span>(res)</span>
<span id="cb12-719"><a href="#cb12-719" aria-hidden="true" tabindex="-1"></a>w <span class="ot">&lt;-</span> img_info<span class="sc">$</span>width</span>
<span id="cb12-720"><a href="#cb12-720" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> magick<span class="sc">::</span><span class="fu">image_append</span>(<span class="fu">c</span>(<span class="fu">.png_scale</span>(viz_header, <span class="at">geometry =</span> <span class="fu">sprintf</span>(<span class="st">'%dx%d'</span>, w, w)), res), <span class="at">stack =</span> <span class="cn">TRUE</span>)</span>
<span id="cb12-721"><a href="#cb12-721" aria-hidden="true" tabindex="-1"></a>path <span class="ot">&lt;-</span> fs<span class="sc">::</span><span class="fu">path</span>(<span class="fu">.get_dir_plots</span>(), <span class="st">'viz_nnmf_dimensions_1to9_combined.png'</span>)</span>
<span id="cb12-722"><a href="#cb12-722" aria-hidden="true" tabindex="-1"></a>magick<span class="sc">::</span><span class="fu">image_write</span>(res, <span class="at">path =</span> path)</span>
<span id="cb12-723"><a href="#cb12-723" aria-hidden="true" tabindex="-1"></a>res</span>
<span id="cb12-724"><a href="#cb12-724" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>