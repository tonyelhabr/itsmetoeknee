---
title: 'xG Model Calibration'
description: "Evaluating Opta's xG Model performance with Brier Skill Score and Calibration Plots"
draft: true
author:
  - name: Tony ElHabr
    url: 'https://twitter.com/TonyElHabr'
date: 2022-02-26
categories:
  - r
  - soccer
output: 
  distill::distill_article:
    toc: true
    toc_depth: 4
    self_contained: false
preview: preview.png
twitter:
  site: '@TonyElHabr'
  creator: '@TonyElHabr'
---

```{r}
#| label: setup,
#| include: FALSE
#| echo: FALSE
knitr::opts_chunk$set(
  include = FALSE,
  echo = FALSE,
  cache = FALSE,
  eval = FALSE,
  cache.lazy = FALSE,
  fig.show = 'hide',
  fig.align = 'center',
  fig.width = 8,
  fig.asp = 0.75,
  fig.retina = 2,
  warning = FALSE,
  message = FALSE
)
```

## Introduction

Recently, [I pointed out](https://twitter.com/TonyElHabr/status/1614288983105617922) what seemed to be a bug with the [expected goals (xG)](https://theanalyst.com/na/2021/07/what-are-expected-goals-xg/) data shown on [FBref](https://fbref.com). In particular, the difference between non-penalty goals (npG) and non-penalty xG (npxG)[^1] seemed to be an outlier for the 2021/22 season across [the Big 5 leagues](https://fbref.com/en/comps/Big5/Big-5-European-Leagues-Stats).

[^1]: It's typically better to analyze expected goals after removing penalties since penalties can distort quantities, adding "noise" to an analysis.

<blockquote class="twitter-tweet">

<p lang="en" dir="ltr">

"aLl xG mOdeLs ArE thE sAme"<br><br>my brother in christ wut is this then <a href="https://t.co/7tjp1VFkoc">pic.twitter.com/7tjp1VFkoc</a>

</p>

--- Tony (@TonyElHabr) <a href="https://twitter.com/TonyElHabr/status/1614288983105617922?ref_src=twsrc%5Etfw">January 14, 2023</a>

</blockquote>

```{=html}
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
```
As it turns out FBref and their data provider, [Opta](https://www.statsperform.com/opta/), agreed! On Feb. 8, 2023, [they posted an update](https://twitter.com/fbref/status/1623358271791722502?s=20) indicating that they adjusted 2021/22 xG such that the difference between npG and npxG is much more in line with other seasons.

### Objectives

The FBref/Opta update gave me two ideas:

1.  **Compare pre- and post-update xG** to identify where/how adjustments were applied.[^2]

2.  **Quantify the [calibration level](https://en.wikipedia.org/wiki/Calibration_(statistics)) of their current xG model.**

[^2]: FBref/Opta didn't specify how they changed their xG model. Given how I observed very only trivial differences in the shot-level xG for prior seasons, it's possible that they didn't even change their model! There could have been some data issue specific to the 2021/22 season, that, when addressed, resulted in more plausible xG.

```{r}
#| label: data-pull
library(dplyr) ## 1.0.99.9000
library(purrr)
library(worldfootballR)
library(tidyr)

params <- bind_rows(
  'big5' = list(
    country = c('ENG', 'ESP', 'FRA', 'GER', 'ITA'),
    tier = '1st',
    gender = 'M'
  ),
  'other_1st_M' = list(
    country = c('POR', 'NED', 'BRA', 'MEX', 'USA'),
    tier = '1st',
    gender = 'M'
  ),
  '1st_F' = list(
    ## ESP only starts in season_end_year = 2023
    country = c('ENG', 'USA'),
    tier = '1st',
    gender = 'F'
  ),
  '2nd_M' = list(
    country = c('ENG'),
    tier = '2nd',
    gender = 'M'
  ),
  .id = 'group'
)

match_shooting <- params |> 
  group_by(group, tier, gender) |> 
  summarize(countries = list(country)) |> 
  ungroup() |> 
  mutate(
    data = pmap(
      list(
        countries,
        tier,
        gender,
        group
      ),
      ~{
        first_season_end_year <- ifelse(..4 == 'big5', 2018L, 2019L)
        res <- load_fb_match_shooting(
          country = ..1,
          tier = ..2,
          gender = ..3,
          season_end_year = first_season_end_year:2022L
        )
        res$Tier <- ..2
        res
      }
    )
  ) |> 
  select(group, data) |> 
  unnest(data)
```

```{r}
#| label: data-clean
library(lubridate)
library(stringr)

## https://github.com/tonyelhabr/sports_viz/blob/master/65-opta_xg_calib/1-pull-footedness.R
footedness <- read_csv(
  'https://raw.githubusercontent.com/tonyelhabr/sports_viz/master/65-opta_xg_calib/data/footedness.csv'
)
unambiguous_footedness <- footedness |> 
  semi_join(
    footedness |> 
      count(country, tier, gender, season_end_year, player, sort = TRUE) |> 
      filter(n == 1L),
    by = join_by(country, tier, gender, season_end_year, player)
  )

clean_match_shooting <- function(df) {
  df |> 
    transmute(
      match_url = MatchURL,
      group,
      country = Country,
      gender = Gender,
      tier = Tier,
      season_end_year = Season_End_Year,
      date = ymd(Date),
      half = Match_Half,
      minute = Minute,
      team = Squad,
      player = str_remove(Player, ' \\(.*$'),
      xg = as.numeric(xG),
      psxg = as.numeric(PSxG),
      outcome = Outcome,
      is_penalty = str_detect(Player, '\\(pen\\)'),
      is_goal = factor(ifelse(outcome == 'Goal', 'yes', 'no')),
      distance = as.integer(Distance),
      body_part = `Body Part`,
      notes = Notes,
      ## seems that they started to exclusively use Take-On instead of Dribble in 2022
      sca1 = ifelse(Event_SCA_1 == 'Dribble', 'Take-On', Event_SCA_1),
      sca2 = ifelse(Event_SCA_2 == 'Dribble', 'Take-On', Event_SCA_2)
    ) |> 
    left_join(
      unambiguous_footedness |> 
        select(
          country,
          tier,
          gender,
          season_end_year,
          player, 
          primary_foot = foot
        ),
      multiple = 'all',
      by = join_by(
        country, 
        tier, gender, 
        season_end_year, 
        player
      )
    ) |> 
    mutate(
      is_true_open_play = notes == '' & !is_penalty,
      is_from_deflection = str_detect(notes, 'Deflected'),
      is_from_volley = str_detect(notes, 'Volley'),
      is_free_kick = notes == 'Free kick',
      is_open_play = !is_free_kick & !is_penalty,
      is_primary_foot = case_when(
        is.na(body_part) ~ NA,
        is.na(primary_foot) ~ NA,
        !(body_part %in% sprintf('%s Foot', c('Left', 'Right'))) ~ NA,
        primary_foot == tolower(str_remove(body_part, ' Foot')) ~ TRUE,
        .default = FALSE
      )
    )
}

shots <- clean_match_shooting(match_shooting)

pull_old_fb_match_shooting <- function(country, gender, tier) {
  url <- sprintf(
    'https://github.com/JaseZiv/worldfootballR_data/releases/download/old_fb_match_shooting/%s_%s_%s_match_shooting.rds', 
    country,
    gender,
    tier
  )
  readRDS(url(url))
}

old_fb_match_shooting <- params |> 
  filter(group == 'big5') |> 
  mutate(
    data = pmap(
      list(
        country,
        gender,
        tier
      ),
      pull_old_fb_match_shooting
    )
  ) |> 
  unnest(data)

updated_shots <- inner_join(
  shots |> 
    filter(group == 'big5', season_end_year == 2022) |> 
    rename(new_xg = xg),
  old_fb_match_shooting |> 
    filter(Season_End_Year == 2022) |> 
    rename(
      Tier = tier
    ) |> 
    clean_match_shooting() |> 
    select(
      match_url, 
      half,
      minute,
      team,
      player,
      old_xg = xg
    ),
  by = join_by(match_url, half, minute, team, player),
  multiple = 'first'
) |> 
  relocate(old_xg, .before = new_xg)
```

## 1. Pre- and Post-update xG Comparison

```{r}
#| label: updated_np_shots
library(readr)

updated_np_shots <- read_rds('../sports_viz/65-opta_xg_calib/data/clean_updated_shots.rds') |> 
  filter(!is_penalty)

compare_by <- function(shots, ...) {
  shots |> 
    group_by(...) |> 
    summarize(
      n_shots = n(),
      n_same_npxg = sum(round(old_xg, 2) == round(new_xg, 2), na.rm = TRUE),
      n_old_npxg_is_higher = sum(round(old_xg, 2) > round(new_xg, 2), na.rm = TRUE),
      new_npxg = sum(new_xg, na.rm = TRUE),
      old_npxg = sum(old_xg, na.rm = TRUE)
    ) |> 
    ungroup() |> 
    transmute(
      ...,
      n_shots,
      n_same_npxg,
      n_diff_npxg = n_shots - n_same_npxg,
      n_old_npxg_is_higher,
      n_new_npxg_is_higher = n_diff_npxg - n_old_npxg_is_higher,
      prop_diff_npxg = n_diff_npxg / n_shots,
      prop_old_npxg_is_higher = n_old_npxg_is_higher / n_diff_npxg
    ) |> 
    arrange(desc(n_shots))
}

updated_np_shots |>
  compare_by() |> 
  glimpse()
#> Rows: 1
#> Columns: 7
#> $ n_shots                 <int> 44986
#> $ n_same_npxg             <int> 14750
#> $ n_diff_npxg             <int> 30236
#> $ n_old_npxg_is_higher    <int> 23584
#> $ n_new_npxg_is_higher    <int> 6652
#> $ prop_diff_npxg          <dbl> 0.6721202
#> $ prop_old_npxg_is_higher <dbl> 0.7799974
#> $ prop_old_npxg_is_higher  <dbl> 0.7799974
```

```{r}
#| label: discretized_updated_shots
library(forcats)
meta_updated_shots_cols <- c(
  'country',
  'date',
  'half',
  'minute',
  'team',
  'player'
)

discretized_updated_np_shots <- updated_np_shots |> 
  select(
    all_of(meta_updated_shots_cols),
    
    new_xg,
    old_xg,
    is_goal,
    
    country,
    distance,
    sca1,
    body_part,
    is_from_deflection,
    is_from_volley,
    is_free_kick,
    is_open_play,
    is_primary_foot
  ) |> 
  mutate(
    across(
      country,
      factor
    ),
    across(
      distance,
      ~cut(
        .x,
        breaks = c(seq(0, 18, by = 2), 20, 25, 30, 35, Inf)
      )
    ),
    across(sca1, ~na_if(.x, '')),
    across(
      sca1, 
      ~.x |> 
        str_remove_all( '\\(|\\)') |> 
        str_replace_all('\\s|[-]', '_') |> 
        tolower() |> 
        factor()
    ),
    across(
      c(
        is_from_deflection,
        is_from_volley,
        is_free_kick,
        is_open_play,
        is_primary_foot
      ),
      ~ifelse(.x, 'yes', 'no') |> 
        factor()
    ),
    across(
      c(is_primary_foot, body_part, sca1, distance), 
      ~fct_explicit_na(.x, na_level = 'missing')
    )
  )
```

First, let's take a wholistic look at all of the shots for the 2021/22 seasons played in Big 5 leagues.

```{r}
#| label: post-update-xgd
library(ggplot2)
library(sysfonts)
library(showtext)
library(ggtext)
library(ggforce)
library(ragg)

font <- 'Titillium Web'
sysfonts::font_add_google(font, font)
## https://github.com/tashapiro/tanya-data-viz/blob/main/chatgpt-lensa/chatgpt-lensa.R for twitter logo
sysfonts::font_add('fb', 'Font Awesome 6 Brands-Regular-400.otf')
showtext::showtext_auto()
showtext::showtext_opts(dpi = 300)

blackish_background <- '#1c1c1c'
  
# extrafont::loadfonts(quiet = TRUE)
theme_set(theme_minimal())
theme_update(
  text = element_text(family = font),
  title = element_text(size = 20, color = 'white'),
  plot.title = element_text(face = 'bold', size = 20, color = 'white'),
  plot.title.position = 'plot',
  plot.subtitle = element_text(size = 16, color = '#f1f1f1'),
  axis.text = element_text(color = 'white', size = 14),
  axis.title = element_text(size = 14, color = 'white', face = 'bold', hjust = 0.99),
  axis.line = element_blank(),
  panel.grid.major = element_line(color = '#4d4d4d'),
  panel.grid.minor = element_line(color = '#4d4d4d'),
  panel.grid.minor.x = element_blank(),
  panel.grid.minor.y = element_blank(),
  plot.margin = margin(10, 10, 10, 10),
  plot.background = element_rect(fill = blackish_background, color = blackish_background),
  plot.caption = element_text(color = 'white', hjust = 0, size = 12, face = 'plain'),
  plot.caption.position = 'plot',
  panel.background = element_rect(fill = blackish_background, color = blackish_background)
)
update_geom_defaults('text', list(color = 'white', size = 12 / .pt))
update_geom_defaults('point', list(color = 'white'))
arw_annotate <- arrow(length = unit(5, 'pt'), type = 'closed')

updated_xgd_n <- updated_shots |> 
  filter(!is_penalty) |> 
  count(old_xg, xgd = old_xg - new_xg) |>
  mutate(xgd_is_pos = xgd > 0) |> 
  arrange(old_xg, xgd)

xgd_miss_color <- '#00b2a9'
p_old_xg_vs_xgd <- updated_xgd_n |> 
  ggplot() +
  aes(x = old_xg, y = xgd) +
  geom_point(
    aes(
      size = n, 
      alpha = n
    )
  ) +
  scale_alpha_continuous(range = c(0.25, 1)) +
  guides(
    size = 'none',
    alpha = 'none'
  ) +
  theme(
    plot.tag = ggtext::element_markdown(size = 12, color = 'white', hjust = 1),
    plot.tag.position = c(0.99, 0.01)
  ) +
  coord_cartesian(
    xlim = c(0, 1),
    ylim = c(-1, 1),
    expand = TRUE
  ) +
  labs(
    title = 'Comparison of Opta non-penalty expected goals (npxG)',
    subtitle = 'Pre- and post-FBref update (2023-02-08) for Big 5 leagues, 2021/22 season',
    x = 'Pre-update npxG',
    y = 'Pre-update npxG minus post-update npxG',
    tag = '<span style="font-family:fb";">&#xf099;</span> @TonyElHabr',
    caption = 'Each point represents a shot.\nLarger, more opaque points means there are more shots with a given x- and y-axis value.'
  ) +
  ggforce::geom_mark_hull(
    data = updated_xgd_n |> filter(xgd_is_pos),
    aes(
      label = 'Shots where pre-update\nnpxG was reduced'
    ),
    label.family = font,
    label.fontface = 'bold',
    label.hjust = 1,
    label.fontsize = 14,
    expand = unit(1, 'mm'),
    label.fill = NA_character_,
    # label.buffer = unit(5, 'mm'),
    con.border = 'none',
    # con.arrow = arw_annotate,
    con.linetype = 0,
    concavity = 10,
    label.colour = xgd_miss_color,  
    con.colour = xgd_miss_color,
    colour = xgd_miss_color
  )
p_old_xg_vs_xgd

ggsave(
  p_old_xg_vs_xgd,
  device = ragg::agg_png,
  res = 300,
  filename = '_post/opta-xg-model-calibration/old_xg_vs_xgd.png',
  width = 2400,
  height = 2400,
  units = 'px'
)
```

![](old_xg_vs_xgd.png)

Plotting the pre-update non-penalty shot-level xG data versus the difference in pre- and post-update xG, we see that the biggest reductions in xG occurred for shots where xG was relatively high (i.e. \>0.2). While there were shots where xG increased post-update, the reductions pull down the overall average difference between the new and old xG data by \~0.01 per shot.

```{r}
#| label: discretized_updated_np_shots-glimpse
#| include: true
#| echo: true
glimpse(discretized_updated_np_shots)
#> Rows: 44,986
#> Columns: 16
#> $ country            <fct> ENG, ENG, ENG, ENG, ENG, ENG, ENG, ENG, ENG, ENG, E…
#> $ date               <date> 2021-08-13, 2021-08-13, 2021-08-13, 2021-08-13, 20…
#> $ half               <dbl> 1, 1, 1, 1, 1, 2, 2, 2, 1, 1, 1, 1, 1, 1, 1, 2, 2, …
#> $ minute             <chr> "11", "12", "22", "28", "30", "66", "73", "80", "2"…
#> $ team               <chr> "Brentford", "Brentford", "Brentford", "Brentford",…
#> $ player             <chr> "Frank Onyeka", "Bryan Mbeumo", "Sergi Canós", "Ser…
#> $ new_xg             <dbl> 0.08, 0.09, 0.02, 0.06, 0.26, 0.06, 0.40, 0.28, 0.0…
#> $ old_xg             <dbl> 0.09, 0.14, 0.04, 0.07, 0.31, 0.13, 0.58, 0.27, 0.0…
#> $ is_goal            <fct> no, no, yes, no, no, no, yes, no, no, no, no, no, n…
#> $ distance           <fct> "(8,10]", "(12,14]", "(16,18]", "(20,25]", "(12,14]…
#> $ sca1               <fct> pass_live, pass_live, pass_live, pass_live, take_on…
#> $ body_part          <fct> Head, Right Foot, Right Foot, Right Foot, Right Foo…
#> $ is_from_deflection <fct> no, no, no, no, no, no, no, no, no, no, no, no, no,…
#> $ is_from_volley     <fct> no, no, no, no, no, no, no, no, no, yes, no, no, no…
#> $ is_free_kick       <fct> no, no, no, no, no, no, no, no, no, no, no, no, no,…
#> $ is_primary_foot    <fct> missing, no, yes, yes, no, yes, missing, missing, y…

discretized_updated_np_shots |> 
  filter(!is_penalty) |> 
  mutate(xgd = old_xg - new_xg) |> 
  pull(xgd) |> 
  mean()
#> [1] 0.0095014
```

Of the 44,986 shots in the data set, 30,326 (67.2%) had changes to their xG values.[^3] Of those that changed, 23, 584 (78.0%) ended up being reduced, i.e. the pre-update xG value was higher. We can look at changes to xG values grouped by various `feature`s that FBref publishes alongside each shot's xG, including `distance` (yards), `sca1` (direct [shot-creating action](https://www.sports-reference.com/blog/2020/04/goal-creation-possession-passing-and-more-advanced-stats-on-fbref/)), `body_part`, `is_from_deflection`, `is_from_volley`, `is_free_kick`, and `is_primary_foot`.[^4]

[^3]: Note that, for a large majority of shots, where xG is in the (0, 0.05] range, xG either did not change at all or only trivially changed. (See the blur of white points on the left-hand side of the plot.)

[^4]: Several of these are not provided directly from the raw FBref tables. For example, `is_from_deflection` is derived from the `Notes` field in the FBref shot table. `is_primary_foot` is derived from collecting player footedness data and checking for a match with `body_part`.

```{r}
#| label: updated_np_shot_diffs
library(scales)
library(knitr)
updated_np_shot_diffs <- discretized_updated_np_shots |> 
  select(-all_of(meta_updated_shots_cols)) |> 
  pivot_longer(
    -c(is_goal, old_xg, new_xg),
    names_to = 'feature',
    values_to = 'group'
  ) |> 
  compare_by(feature, group)

slice_and_tabularize_np_shot_diffs <- function(op, n = 5) {
  updated_np_shot_diffs |> 
    filter(n_shots >= 100) |> 
    arrange(op(prop_old_npxg_is_higher)) |> 
    head(n) |> 
    transmute(
      Feature = sprintf('`%s`', feature),
      Group = sprintf('`%s`', ifelse(feature == "distance", as.character(group), paste0('"', group, '"'))),
      `# of non-penalty shots` = scales::comma(n_shots),
      `# of shots with changed npxG` = sprintf('%s (%.1f%%)', scales::comma(n_diff_npxg), 100 * prop_diff_npxg),
      `# of shots with lower post-update npxG of those that changed` = sprintf('%s (%.1f%%)', scales::comma(n_old_npxg_is_higher), 100 * prop_old_npxg_is_higher),
    ) |> 
    knitr::kable()
}

slice_and_tabularize_np_shot_diffs(`-`, n = 5)
slice_and_tabularize_np_shot_diffs(`+`, n = 6)
```

Observe that the reductions in npxG occurred most frequently for longer `distance`s (yards), suggesting that the pre-update xG model was over-predicting xG for longer shots. Interestingly, xG for shots when interceptions led directly to the shot (`sca1`), and xG for shots with `body_part = "other"` (non-foot, non-header) were also frequently reduced, in the cases where xG was changed.

| Feature     | Group            | \# of non-penalty shots | \# of shots with changed npxG | \# of shots with lower post-update npxG of those that changed |
|:------------|:-----------------|------------------------:|------------------------------:|--------------------------------------------------------------:|
| `distance`  | `(25,30]`        |                   6,061 |                 3,659 (60.4%) |                                                 3,437 (93.9%) |
| `distance`  | `(20,25]`        |                   6,760 |                 4,463 (66.0%) |                                                 4,088 (91.6%) |
| `sca1`      | `"interception"` |                     149 |                    96 (64.4%) |                                                    87 (90.6%) |
| `distance`  | `(18,20]`        |                   1,889 |                 1,232 (65.2%) |                                                 1,088 (88.3%) |
| `distance`  | `(30,35]`        |                   2,725 |                 1,267 (46.5%) |                                                 1,117 (88.2%) |
| `body_part` | `"Other"`        |                     191 |                   153 (80.1%) |                                                   130 (85.0%) |

On the other end of the spectrum, reductions in npxG occurred least frequently for shorter `distance` buckets (`(0,2]`, `(2,4]`, `(4,6]`, `(6,8)`). Reductions still occurred a majority of the time when there was a change---note that each has `>50%` for the last column---for all but the shortest `distance` group, `(0,2]`.

| Feature        | Group      | \# of non-penalty shots | \# of shots with changed npxG | \# of shots with lower post-update npxG of those that changed |
|:---------------|:-----------|------------------------:|------------------------------:|--------------------------------------------------------------:|
| `distance`     | `(0,2]`    |                     173 |                   130 (75.1%) |                                                    51 (39.2%) |
| `distance`     | `(2,4]`    |                   1,087 |                   826 (76.0%) |                                                   428 (51.8%) |
| `distance`     | `(4,6]`    |                   2,003 |                 1,479 (73.8%) |                                                   831 (56.2%) |
| `distance`     | `(35,Inf]` |                     539 |                   313 (58.1%) |                                                   177 (56.5%) |
| `distance`     | `(6,8]`    |                   2,557 |                 1,882 (73.6%) |                                                 1,183 (62.9%) |
| `is_free_kick` | `"yes"`    |                   1,576 |                   882 (56.0%) |                                                   557 (63.2%) |

## 2. xG Model Calibration

[I've touched on model calibration before, when discussing xG-implied match outcome probabilities](https://tonyelhabr.rbind.io/post/epl-xpts-simulation-1/#match-predictive-performance7). There, I wrote my own code to create a [calibration plot](https://changhsinlee.com/python-calibration-plot/)

Since then, the [`{tidymodels}` team](https://www.tidymodels.org/) has done some work on the [`{probably}` package](https://probably.tidymodels.org/), adding [functions to generate calibration plots](https://www.tidyverse.org/blog/2022/11/model-calibration/). Let's try some of those out.

Here, we'll use a big sample of data---all 2017/18 - 2021/22 non-penalty shots for the Big 5 leagues and several other first and second tier leagues.[^5]

[^5]: Several leagues don't have data available for all such seasons, which is reflected in the row counts by group.

```{r}
#| label: part-2
match_shooting |> 
  filter(!is_penalty) |> 
  count(Country, Tier, Gender, name = 'n_shots')
#> # A tibble: 13 × 4
#>    Country Tier  Gender     n
#>    <chr>   <chr> <chr>  <int>
#>  1 BRA     1st   M      39881
#>  2 ENG     1st   F      11472
#>  3 ENG     1st   M      47269
#>  4 ENG     2nd   M      53218
#>  5 ESP     1st   M      44063
#>  6 FRA     1st   M      43661
#>  7 GER     1st   M      39600
#>  8 ITA     1st   M      50630
#>  9 MEX     1st   M      33184
#> 10 NED     1st   M      30176
#> 11 POR     1st   M      27788
#> 12 USA     1st   F       9983
#> 13 USA     1st   M      43858
```
