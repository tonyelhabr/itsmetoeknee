<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">

<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"/>
  <meta name="generator" content="distill" />

  <style type="text/css">
  /* Hide doc at startup (prevent jankiness while JS renders/transforms) */
  body {
    visibility: hidden;
  }
  </style>

 <!--radix_placeholder_import_source-->
 <!--/radix_placeholder_import_source-->

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  { color: #00769e; background-color: #f1f3f5; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span { color: #00769e; } /* Normal */
code span.al { color: #ad0000; } /* Alert */
code span.an { color: #5e5e5e; } /* Annotation */
code span.at { color: #657422; } /* Attribute */
code span.bn { color: #ad0000; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #00769e; } /* ControlFlow */
code span.ch { color: #20794d; } /* Char */
code span.cn { color: #8f5902; } /* Constant */
code span.co { color: #5e5e5e; } /* Comment */
code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
code span.dt { color: #ad0000; } /* DataType */
code span.dv { color: #ad0000; } /* DecVal */
code span.er { color: #ad0000; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #ad0000; } /* Float */
code span.fu { color: #4758ab; } /* Function */
code span.im { } /* Import */
code span.in { color: #5e5e5e; } /* Information */
code span.kw { color: #00769e; } /* Keyword */
code span.op { color: #5e5e5e; } /* Operator */
code span.ot { color: #00769e; } /* Other */
code span.pp { color: #ad0000; } /* Preprocessor */
code span.sc { color: #5e5e5e; } /* SpecialChar */
code span.ss { color: #20794d; } /* SpecialString */
code span.st { color: #20794d; } /* String */
code span.va { color: #111111; } /* Variable */
code span.vs { color: #20794d; } /* VerbatimString */
code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
</style>


  <!--radix_placeholder_meta_tags-->
<title>Tony: What exactly is an "expected point"? (part 2)</title>

<meta property="description" itemprop="description" content="Evaluating how we can use match outcome probabilites for season-long insights"/>

<link rel="canonical" href="https://itsmetoeknee.netlify.app/post/epl-xpts-simulation-2/"/>
<link rel="icon" type="image/png" href="../../assets/img/keyboard.png"/>

<!--  https://schema.org/Article -->
<meta property="article:published" itemprop="datePublished" content="2022-09-05"/>
<meta property="article:created" itemprop="dateCreated" content="2022-09-05"/>
<meta name="article:author" content="Tony ElHabr"/>

<!--  https://developers.facebook.com/docs/sharing/webmasters#markup -->
<meta property="og:title" content="Tony: What exactly is an &quot;expected point&quot;? (part 2)"/>
<meta property="og:type" content="article"/>
<meta property="og:description" content="Evaluating how we can use match outcome probabilites for season-long insights"/>
<meta property="og:url" content="https://itsmetoeknee.netlify.app/post/epl-xpts-simulation-2/"/>
<meta property="og:image" content="https://itsmetoeknee.netlify.app/post/epl-xpts-simulation-2/unexpected.png"/>
<meta property="og:image:width" content="1423"/>
<meta property="og:image:height" content="1156"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:site_name" content="Tony"/>

<!--  https://dev.twitter.com/cards/types/summary -->
<meta property="twitter:card" content="summary_large_image"/>
<meta property="twitter:title" content="Tony: What exactly is an &quot;expected point&quot;? (part 2)"/>
<meta property="twitter:description" content="Evaluating how we can use match outcome probabilites for season-long insights"/>
<meta property="twitter:url" content="https://itsmetoeknee.netlify.app/post/epl-xpts-simulation-2/"/>
<meta property="twitter:image" content="https://itsmetoeknee.netlify.app/post/epl-xpts-simulation-2/unexpected.png"/>
<meta property="twitter:image:width" content="1423"/>
<meta property="twitter:image:height" content="1156"/>
<meta property="twitter:site" content="@TonyElHabr"/>
<meta property="twitter:creator" content="@TonyElHabr"/>

<!--  https://scholar.google.com/intl/en/scholar/inclusion.html#indexing -->
<meta name="citation_title" content="Tony: What exactly is an &quot;expected point&quot;? (part 2)"/>
<meta name="citation_fulltext_html_url" content="https://itsmetoeknee.netlify.app/post/epl-xpts-simulation-2/"/>
<meta name="citation_online_date" content="2022/09/05"/>
<meta name="citation_publication_date" content="2022/09/05"/>
<meta name="citation_author" content="Tony ElHabr"/>
<!--/radix_placeholder_meta_tags-->
  <!--radix_placeholder_rmarkdown_metadata-->

<script type="text/json" id="radix-rmarkdown-metadata">
{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["title","description","author","date","categories","output","preview","twitter","citation_url","canonical_url"]}},"value":[{"type":"character","attributes":{},"value":["What exactly is an \"expected point\"? (part 2)"]},{"type":"character","attributes":{},"value":["Evaluating how we can use match outcome probabilites for season-long insights"]},{"type":"list","attributes":{},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","url"]}},"value":[{"type":"character","attributes":{},"value":["Tony ElHabr"]},{"type":"character","attributes":{},"value":["https://twitter.com/TonyElHabr"]}]}]},{"type":"character","attributes":{},"value":["2022-09-05"]},{"type":"character","attributes":{},"value":["r","soccer"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["distill::distill_article"]}},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["toc","toc_depth","self_contained"]}},"value":[{"type":"logical","attributes":{},"value":[true]},{"type":"integer","attributes":{},"value":[4]},{"type":"logical","attributes":{},"value":[false]}]}]},{"type":"character","attributes":{},"value":["unexpected.png"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["site","creator"]}},"value":[{"type":"character","attributes":{},"value":["@TonyElHabr"]},{"type":"character","attributes":{},"value":["@TonyElHabr"]}]},{"type":"character","attributes":{},"value":["https://itsmetoeknee.netlify.app/post/epl-xpts-simulation-2/"]},{"type":"character","attributes":{},"value":["https://itsmetoeknee.netlify.app/post/epl-xpts-simulation-2/"]}]}
</script>
<!--/radix_placeholder_rmarkdown_metadata-->
  
  <script type="text/json" id="radix-resource-manifest">
  {"type":"character","attributes":{},"value":["epl-xpts-simulation-2_files/anchor-4.2.2/anchor.min.js","epl-xpts-simulation-2_files/bowser-1.9.3/bowser.min.js","epl-xpts-simulation-2_files/distill-2.2.21/template.v2.js","epl-xpts-simulation-2_files/header-attrs-2.14/header-attrs.js","epl-xpts-simulation-2_files/jquery-3.6.0/jquery-3.6.0.js","epl-xpts-simulation-2_files/jquery-3.6.0/jquery-3.6.0.min.js","epl-xpts-simulation-2_files/jquery-3.6.0/jquery-3.6.0.min.map","epl-xpts-simulation-2_files/popper-2.6.0/popper.min.js","epl-xpts-simulation-2_files/tippy-6.2.7/tippy-bundle.umd.min.js","epl-xpts-simulation-2_files/tippy-6.2.7/tippy-light-border.css","epl-xpts-simulation-2_files/tippy-6.2.7/tippy.css","epl-xpts-simulation-2_files/tippy-6.2.7/tippy.umd.min.js","epl-xpts-simulation-2_files/webcomponents-2.0.0/webcomponents.js","unexpected.png"]}
  </script>
  <!--radix_placeholder_navigation_in_header-->
<meta name="distill:offset" content="../.."/>

<script type="application/javascript">

  window.headroom_prevent_pin = false;

  window.document.addEventListener("DOMContentLoaded", function (event) {

    // initialize headroom for banner
    var header = $('header').get(0);
    var headerHeight = header.offsetHeight;
    var headroom = new Headroom(header, {
      tolerance: 5,
      onPin : function() {
        if (window.headroom_prevent_pin) {
          window.headroom_prevent_pin = false;
          headroom.unpin();
        }
      }
    });
    headroom.init();
    if(window.location.hash)
      headroom.unpin();
    $(header).addClass('headroom--transition');

    // offset scroll location for banner on hash change
    // (see: https://github.com/WickyNilliams/headroom.js/issues/38)
    window.addEventListener("hashchange", function(event) {
      window.scrollTo(0, window.pageYOffset - (headerHeight + 25));
    });

    // responsive menu
    $('.distill-site-header').each(function(i, val) {
      var topnav = $(this);
      var toggle = topnav.find('.nav-toggle');
      toggle.on('click', function() {
        topnav.toggleClass('responsive');
      });
    });

    // nav dropdowns
    $('.nav-dropbtn').click(function(e) {
      $(this).next('.nav-dropdown-content').toggleClass('nav-dropdown-active');
      $(this).parent().siblings('.nav-dropdown')
         .children('.nav-dropdown-content').removeClass('nav-dropdown-active');
    });
    $("body").click(function(e){
      $('.nav-dropdown-content').removeClass('nav-dropdown-active');
    });
    $(".nav-dropdown").click(function(e){
      e.stopPropagation();
    });
  });
</script>

<style type="text/css">

/* Theme (user-documented overrideables for nav appearance) */

.distill-site-nav {
  color: rgba(255, 255, 255, 0.8);
  background-color: #0F2E3D;
  font-size: 15px;
  font-weight: 300;
}

.distill-site-nav a {
  color: inherit;
  text-decoration: none;
}

.distill-site-nav a:hover {
  color: white;
}

@media print {
  .distill-site-nav {
    display: none;
  }
}

.distill-site-header {

}

.distill-site-footer {

}


/* Site Header */

.distill-site-header {
  width: 100%;
  box-sizing: border-box;
  z-index: 3;
}

.distill-site-header .nav-left {
  display: inline-block;
  margin-left: 8px;
}

@media screen and (max-width: 768px) {
  .distill-site-header .nav-left {
    margin-left: 0;
  }
}


.distill-site-header .nav-right {
  float: right;
  margin-right: 8px;
}

.distill-site-header a,
.distill-site-header .title {
  display: inline-block;
  text-align: center;
  padding: 14px 10px 14px 10px;
}

.distill-site-header .title {
  font-size: 18px;
  min-width: 150px;
}

.distill-site-header .logo {
  padding: 0;
}

.distill-site-header .logo img {
  display: none;
  max-height: 20px;
  width: auto;
  margin-bottom: -4px;
}

.distill-site-header .nav-image img {
  max-height: 18px;
  width: auto;
  display: inline-block;
  margin-bottom: -3px;
}



@media screen and (min-width: 1000px) {
  .distill-site-header .logo img {
    display: inline-block;
  }
  .distill-site-header .nav-left {
    margin-left: 20px;
  }
  .distill-site-header .nav-right {
    margin-right: 20px;
  }
  .distill-site-header .title {
    padding-left: 12px;
  }
}


.distill-site-header .nav-toggle {
  display: none;
}

.nav-dropdown {
  display: inline-block;
  position: relative;
}

.nav-dropdown .nav-dropbtn {
  border: none;
  outline: none;
  color: rgba(255, 255, 255, 0.8);
  padding: 16px 10px;
  background-color: transparent;
  font-family: inherit;
  font-size: inherit;
  font-weight: inherit;
  margin: 0;
  margin-top: 1px;
  z-index: 2;
}

.nav-dropdown-content {
  display: none;
  position: absolute;
  background-color: white;
  min-width: 200px;
  border: 1px solid rgba(0,0,0,0.15);
  border-radius: 4px;
  box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.1);
  z-index: 1;
  margin-top: 2px;
  white-space: nowrap;
  padding-top: 4px;
  padding-bottom: 4px;
}

.nav-dropdown-content hr {
  margin-top: 4px;
  margin-bottom: 4px;
  border: none;
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

.nav-dropdown-active {
  display: block;
}

.nav-dropdown-content a, .nav-dropdown-content .nav-dropdown-header {
  color: black;
  padding: 6px 24px;
  text-decoration: none;
  display: block;
  text-align: left;
}

.nav-dropdown-content .nav-dropdown-header {
  display: block;
  padding: 5px 24px;
  padding-bottom: 0;
  text-transform: uppercase;
  font-size: 14px;
  color: #999999;
  white-space: nowrap;
}

.nav-dropdown:hover .nav-dropbtn {
  color: white;
}

.nav-dropdown-content a:hover {
  background-color: #ddd;
  color: black;
}

.nav-right .nav-dropdown-content {
  margin-left: -45%;
  right: 0;
}

@media screen and (max-width: 768px) {
  .distill-site-header a, .distill-site-header .nav-dropdown  {display: none;}
  .distill-site-header a.nav-toggle {
    float: right;
    display: block;
  }
  .distill-site-header .title {
    margin-left: 0;
  }
  .distill-site-header .nav-right {
    margin-right: 0;
  }
  .distill-site-header {
    overflow: hidden;
  }
  .nav-right .nav-dropdown-content {
    margin-left: 0;
  }
}


@media screen and (max-width: 768px) {
  .distill-site-header.responsive {position: relative; min-height: 500px; }
  .distill-site-header.responsive a.nav-toggle {
    position: absolute;
    right: 0;
    top: 0;
  }
  .distill-site-header.responsive a,
  .distill-site-header.responsive .nav-dropdown {
    display: block;
    text-align: left;
  }
  .distill-site-header.responsive .nav-left,
  .distill-site-header.responsive .nav-right {
    width: 100%;
  }
  .distill-site-header.responsive .nav-dropdown {float: none;}
  .distill-site-header.responsive .nav-dropdown-content {position: relative;}
  .distill-site-header.responsive .nav-dropdown .nav-dropbtn {
    display: block;
    width: 100%;
    text-align: left;
  }
}

/* Site Footer */

.distill-site-footer {
  width: 100%;
  overflow: hidden;
  box-sizing: border-box;
  z-index: 3;
  margin-top: 30px;
  padding-top: 30px;
  padding-bottom: 30px;
  text-align: center;
}

/* Headroom */

d-title {
  padding-top: 6rem;
}

@media print {
  d-title {
    padding-top: 4rem;
  }
}

.headroom {
  z-index: 1000;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
}

.headroom--transition {
  transition: all .4s ease-in-out;
}

.headroom--unpinned {
  top: -100px;
}

.headroom--pinned {
  top: 0;
}

/* adjust viewport for navbar height */
/* helps vertically center bootstrap (non-distill) content */
.min-vh-100 {
  min-height: calc(100vh - 100px) !important;
}

</style>

<script src="../../site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<link href="../../site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet"/>
<link href="../../site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet"/>
<script src="../../site_libs/headroom-0.9.4/headroom.min.js"></script>
<script src="../../site_libs/autocomplete-0.37.1/autocomplete.min.js"></script>
<script src="../../site_libs/fuse-6.4.1/fuse.min.js"></script>

<script type="application/javascript">

function getMeta(metaName) {
  var metas = document.getElementsByTagName('meta');
  for (let i = 0; i < metas.length; i++) {
    if (metas[i].getAttribute('name') === metaName) {
      return metas[i].getAttribute('content');
    }
  }
  return '';
}

function offsetURL(url) {
  var offset = getMeta('distill:offset');
  return offset ? offset + '/' + url : url;
}

function createFuseIndex() {

  // create fuse index
  var options = {
    keys: [
      { name: 'title', weight: 20 },
      { name: 'categories', weight: 15 },
      { name: 'description', weight: 10 },
      { name: 'contents', weight: 5 },
    ],
    ignoreLocation: true,
    threshold: 0
  };
  var fuse = new window.Fuse([], options);

  // fetch the main search.json
  return fetch(offsetURL('search.json'))
    .then(function(response) {
      if (response.status == 200) {
        return response.json().then(function(json) {
          // index main articles
          json.articles.forEach(function(article) {
            fuse.add(article);
          });
          // download collections and index their articles
          return Promise.all(json.collections.map(function(collection) {
            return fetch(offsetURL(collection)).then(function(response) {
              if (response.status === 200) {
                return response.json().then(function(articles) {
                  articles.forEach(function(article) {
                    fuse.add(article);
                  });
                })
              } else {
                return Promise.reject(
                  new Error('Unexpected status from search index request: ' +
                            response.status)
                );
              }
            });
          })).then(function() {
            return fuse;
          });
        });

      } else {
        return Promise.reject(
          new Error('Unexpected status from search index request: ' +
                      response.status)
        );
      }
    });
}

window.document.addEventListener("DOMContentLoaded", function (event) {

  // get search element (bail if we don't have one)
  var searchEl = window.document.getElementById('distill-search');
  if (!searchEl)
    return;

  createFuseIndex()
    .then(function(fuse) {

      // make search box visible
      searchEl.classList.remove('hidden');

      // initialize autocomplete
      var options = {
        autoselect: true,
        hint: false,
        minLength: 2,
      };
      window.autocomplete(searchEl, options, [{
        source: function(query, callback) {
          const searchOptions = {
            isCaseSensitive: false,
            shouldSort: true,
            minMatchCharLength: 2,
            limit: 10,
          };
          var results = fuse.search(query, searchOptions);
          callback(results
            .map(function(result) { return result.item; })
          );
        },
        templates: {
          suggestion: function(suggestion) {
            var img = suggestion.preview && Object.keys(suggestion.preview).length > 0
              ? `<img src="${offsetURL(suggestion.preview)}"</img>`
              : '';
            var html = `
              <div class="search-item">
                <h3>${suggestion.title}</h3>
                <div class="search-item-description">
                  ${suggestion.description || ''}
                </div>
                <div class="search-item-preview">
                  ${img}
                </div>
              </div>
            `;
            return html;
          }
        }
      }]).on('autocomplete:selected', function(event, suggestion) {
        window.location.href = offsetURL(suggestion.path);
      });
      // remove inline display style on autocompleter (we want to
      // manage responsive display via css)
      $('.algolia-autocomplete').css("display", "");
    })
    .catch(function(error) {
      console.log(error);
    });

});

</script>

<style type="text/css">

.nav-search {
  font-size: x-small;
}

/* Algolioa Autocomplete */

.algolia-autocomplete {
  display: inline-block;
  margin-left: 10px;
  vertical-align: sub;
  background-color: white;
  color: black;
  padding: 6px;
  padding-top: 8px;
  padding-bottom: 0;
  border-radius: 6px;
  border: 1px #0F2E3D solid;
  width: 180px;
}


@media screen and (max-width: 768px) {
  .distill-site-nav .algolia-autocomplete {
    display: none;
    visibility: hidden;
  }
  .distill-site-nav.responsive .algolia-autocomplete {
    display: inline-block;
    visibility: visible;
  }
  .distill-site-nav.responsive .algolia-autocomplete .aa-dropdown-menu {
    margin-left: 0;
    width: 400px;
    max-height: 400px;
  }
}

.algolia-autocomplete .aa-input, .algolia-autocomplete .aa-hint {
  width: 90%;
  outline: none;
  border: none;
}

.algolia-autocomplete .aa-hint {
  color: #999;
}
.algolia-autocomplete .aa-dropdown-menu {
  width: 550px;
  max-height: 70vh;
  overflow-x: visible;
  overflow-y: scroll;
  padding: 5px;
  margin-top: 3px;
  margin-left: -150px;
  background-color: #fff;
  border-radius: 5px;
  border: 1px solid #999;
  border-top: none;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion {
  cursor: pointer;
  padding: 5px 4px;
  border-bottom: 1px solid #eee;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion:last-of-type {
  border-bottom: none;
  margin-bottom: 2px;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item {
  overflow: hidden;
  font-size: 0.8em;
  line-height: 1.4em;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item h3 {
  font-size: 1rem;
  margin-block-start: 0;
  margin-block-end: 5px;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-description {
  display: inline-block;
  overflow: hidden;
  height: 2.8em;
  width: 80%;
  margin-right: 4%;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-preview {
  display: inline-block;
  width: 15%;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-preview img {
  height: 3em;
  width: auto;
  display: none;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-preview img[src] {
  display: initial;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion.aa-cursor {
  background-color: #eee;
}
.algolia-autocomplete .aa-dropdown-menu .aa-suggestion em {
  font-weight: bold;
  font-style: normal;
}

</style>


<!--/radix_placeholder_navigation_in_header-->
  <!--radix_placeholder_distill-->

<style type="text/css">

body {
  background-color: white;
}

.pandoc-table {
  width: 100%;
}

.pandoc-table>caption {
  margin-bottom: 10px;
}

.pandoc-table th:not([align]) {
  text-align: left;
}

.pagedtable-footer {
  font-size: 15px;
}

d-byline .byline {
  grid-template-columns: 2fr 2fr;
}

d-byline .byline h3 {
  margin-block-start: 1.5em;
}

d-byline .byline .authors-affiliations h3 {
  margin-block-start: 0.5em;
}

.authors-affiliations .orcid-id {
  width: 16px;
  height:16px;
  margin-left: 4px;
  margin-right: 4px;
  vertical-align: middle;
  padding-bottom: 2px;
}

d-title .dt-tags {
  margin-top: 1em;
  grid-column: text;
}

.dt-tags .dt-tag {
  text-decoration: none;
  display: inline-block;
  color: rgba(0,0,0,0.6);
  padding: 0em 0.4em;
  margin-right: 0.5em;
  margin-bottom: 0.4em;
  font-size: 70%;
  border: 1px solid rgba(0,0,0,0.2);
  border-radius: 3px;
  text-transform: uppercase;
  font-weight: 500;
}

d-article table.gt_table td,
d-article table.gt_table th {
  border-bottom: none;
}

.html-widget {
  margin-bottom: 2.0em;
}

.l-screen-inset {
  padding-right: 16px;
}

.l-screen .caption {
  margin-left: 10px;
}

.shaded {
  background: rgb(247, 247, 247);
  padding-top: 20px;
  padding-bottom: 20px;
  border-top: 1px solid rgba(0, 0, 0, 0.1);
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

.shaded .html-widget {
  margin-bottom: 0;
  border: 1px solid rgba(0, 0, 0, 0.1);
}

.shaded .shaded-content {
  background: white;
}

.text-output {
  margin-top: 0;
  line-height: 1.5em;
}

.hidden {
  display: none !important;
}

d-article {
  padding-top: 2.5rem;
  padding-bottom: 30px;
}

d-appendix {
  padding-top: 30px;
}

d-article>p>img {
  width: 100%;
}

d-article h2 {
  margin: 1rem 0 1.5rem 0;
}

d-article h3 {
  margin-top: 1.5rem;
}

d-article iframe {
  border: 1px solid rgba(0, 0, 0, 0.1);
  margin-bottom: 2.0em;
  width: 100%;
}

/* Tweak code blocks */

d-article div.sourceCode code,
d-article pre code {
  font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
}

d-article pre,
d-article div.sourceCode,
d-article div.sourceCode pre {
  overflow: auto;
}

d-article div.sourceCode {
  background-color: white;
}

d-article div.sourceCode pre {
  padding-left: 10px;
  font-size: 12px;
  border-left: 2px solid rgba(0,0,0,0.1);
}

d-article pre {
  font-size: 12px;
  color: black;
  background: none;
  margin-top: 0;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.5;

  -moz-tab-size: 4;
  -o-tab-size: 4;
  tab-size: 4;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

d-article pre a {
  border-bottom: none;
}

d-article pre a:hover {
  border-bottom: none;
  text-decoration: underline;
}

d-article details {
  grid-column: text;
  margin-bottom: 0.8em;
}

@media(min-width: 768px) {

d-article pre,
d-article div.sourceCode,
d-article div.sourceCode pre {
  overflow: visible !important;
}

d-article div.sourceCode pre {
  padding-left: 18px;
  font-size: 14px;
}

d-article pre {
  font-size: 14px;
}

}

figure img.external {
  background: white;
  border: 1px solid rgba(0, 0, 0, 0.1);
  box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
  padding: 18px;
  box-sizing: border-box;
}

/* CSS for d-contents */

.d-contents {
  grid-column: text;
  color: rgba(0,0,0,0.8);
  font-size: 0.9em;
  padding-bottom: 1em;
  margin-bottom: 1em;
  padding-bottom: 0.5em;
  margin-bottom: 1em;
  padding-left: 0.25em;
  justify-self: start;
}

@media(min-width: 1000px) {
  .d-contents.d-contents-float {
    height: 0;
    grid-column-start: 1;
    grid-column-end: 4;
    justify-self: center;
    padding-right: 3em;
    padding-left: 2em;
  }
}

.d-contents nav h3 {
  font-size: 18px;
  margin-top: 0;
  margin-bottom: 1em;
}

.d-contents li {
  list-style-type: none
}

.d-contents nav > ul {
  padding-left: 0;
}

.d-contents ul {
  padding-left: 1em
}

.d-contents nav ul li {
  margin-top: 0.6em;
  margin-bottom: 0.2em;
}

.d-contents nav a {
  font-size: 13px;
  border-bottom: none;
  text-decoration: none
  color: rgba(0, 0, 0, 0.8);
}

.d-contents nav a:hover {
  text-decoration: underline solid rgba(0, 0, 0, 0.6)
}

.d-contents nav > ul > li > a {
  font-weight: 600;
}

.d-contents nav > ul > li > ul {
  font-weight: inherit;
}

.d-contents nav > ul > li > ul > li {
  margin-top: 0.2em;
}


.d-contents nav ul {
  margin-top: 0;
  margin-bottom: 0.25em;
}

.d-article-with-toc h2:nth-child(2) {
  margin-top: 0;
}


/* Figure */

.figure {
  position: relative;
  margin-bottom: 2.5em;
  margin-top: 1.5em;
}

.figure .caption {
  color: rgba(0, 0, 0, 0.6);
  font-size: 12px;
  line-height: 1.5em;
}

.figure img.external {
  background: white;
  border: 1px solid rgba(0, 0, 0, 0.1);
  box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
  padding: 18px;
  box-sizing: border-box;
}

.figure .caption a {
  color: rgba(0, 0, 0, 0.6);
}

.figure .caption b,
.figure .caption strong, {
  font-weight: 600;
  color: rgba(0, 0, 0, 1.0);
}

/* Citations */

d-article .citation {
  color: inherit;
  cursor: inherit;
}

div.hanging-indent{
  margin-left: 1em; text-indent: -1em;
}

/* Citation hover box */

.tippy-box[data-theme~=light-border] {
  background-color: rgba(250, 250, 250, 0.95);
}

.tippy-content > p {
  margin-bottom: 0;
  padding: 2px;
}


/* Tweak 1000px media break to show more text */

@media(min-width: 1000px) {
  .base-grid,
  distill-header,
  d-title,
  d-abstract,
  d-article,
  d-appendix,
  distill-appendix,
  d-byline,
  d-footnote-list,
  d-citation-list,
  distill-footer {
    grid-template-columns: [screen-start] 1fr [page-start kicker-start] 80px [middle-start] 50px [text-start kicker-end] 65px 65px 65px 65px 65px 65px 65px 65px [text-end gutter-start] 65px [middle-end] 65px [page-end gutter-end] 1fr [screen-end];
    grid-column-gap: 16px;
  }

  .grid {
    grid-column-gap: 16px;
  }

  d-article {
    font-size: 1.06rem;
    line-height: 1.7em;
  }
  figure .caption, .figure .caption, figure figcaption {
    font-size: 13px;
  }
}

@media(min-width: 1180px) {
  .base-grid,
  distill-header,
  d-title,
  d-abstract,
  d-article,
  d-appendix,
  distill-appendix,
  d-byline,
  d-footnote-list,
  d-citation-list,
  distill-footer {
    grid-template-columns: [screen-start] 1fr [page-start kicker-start] 60px [middle-start] 60px [text-start kicker-end] 60px 60px 60px 60px 60px 60px 60px 60px [text-end gutter-start] 60px [middle-end] 60px [page-end gutter-end] 1fr [screen-end];
    grid-column-gap: 32px;
  }

  .grid {
    grid-column-gap: 32px;
  }
}


/* Get the citation styles for the appendix (not auto-injected on render since
   we do our own rendering of the citation appendix) */

d-appendix .citation-appendix,
.d-appendix .citation-appendix {
  font-size: 11px;
  line-height: 15px;
  border-left: 1px solid rgba(0, 0, 0, 0.1);
  padding-left: 18px;
  border: 1px solid rgba(0,0,0,0.1);
  background: rgba(0, 0, 0, 0.02);
  padding: 10px 18px;
  border-radius: 3px;
  color: rgba(150, 150, 150, 1);
  overflow: hidden;
  margin-top: -12px;
  white-space: pre-wrap;
  word-wrap: break-word;
}

/* Include appendix styles here so they can be overridden */

d-appendix {
  contain: layout style;
  font-size: 0.8em;
  line-height: 1.7em;
  margin-top: 60px;
  margin-bottom: 0;
  border-top: 1px solid rgba(0, 0, 0, 0.1);
  color: rgba(0,0,0,0.5);
  padding-top: 60px;
  padding-bottom: 48px;
}

d-appendix h3 {
  grid-column: page-start / text-start;
  font-size: 15px;
  font-weight: 500;
  margin-top: 1em;
  margin-bottom: 0;
  color: rgba(0,0,0,0.65);
}

d-appendix h3 + * {
  margin-top: 1em;
}

d-appendix ol {
  padding: 0 0 0 15px;
}

@media (min-width: 768px) {
  d-appendix ol {
    padding: 0 0 0 30px;
    margin-left: -30px;
  }
}

d-appendix li {
  margin-bottom: 1em;
}

d-appendix a {
  color: rgba(0, 0, 0, 0.6);
}

d-appendix > * {
  grid-column: text;
}

d-appendix > d-footnote-list,
d-appendix > d-citation-list,
d-appendix > distill-appendix {
  grid-column: screen;
}

/* Include footnote styles here so they can be overridden */

d-footnote-list {
  contain: layout style;
}

d-footnote-list > * {
  grid-column: text;
}

d-footnote-list a.footnote-backlink {
  color: rgba(0,0,0,0.3);
  padding-left: 0.5em;
}



/* Anchor.js */

.anchorjs-link {
  /*transition: all .25s linear; */
  text-decoration: none;
  border-bottom: none;
}
*:hover > .anchorjs-link {
  margin-left: -1.125em !important;
  text-decoration: none;
  border-bottom: none;
}

/* Social footer */

.social_footer {
  margin-top: 30px;
  margin-bottom: 0;
  color: rgba(0,0,0,0.67);
}

.disqus-comments {
  margin-right: 30px;
}

.disqus-comment-count {
  border-bottom: 1px solid rgba(0, 0, 0, 0.4);
  cursor: pointer;
}

#disqus_thread {
  margin-top: 30px;
}

.article-sharing a {
  border-bottom: none;
  margin-right: 8px;
}

.article-sharing a:hover {
  border-bottom: none;
}

.sidebar-section.subscribe {
  font-size: 12px;
  line-height: 1.6em;
}

.subscribe p {
  margin-bottom: 0.5em;
}


.article-footer .subscribe {
  font-size: 15px;
  margin-top: 45px;
}


.sidebar-section.custom {
  font-size: 12px;
  line-height: 1.6em;
}

.custom p {
  margin-bottom: 0.5em;
}

/* Styles for listing layout (hide title) */
.layout-listing d-title, .layout-listing .d-title {
  display: none;
}

/* Styles for posts lists (not auto-injected) */


.posts-with-sidebar {
  padding-left: 45px;
  padding-right: 45px;
}

.posts-list .description h2,
.posts-list .description p {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
}

.posts-list .description h2 {
  font-weight: 700;
  border-bottom: none;
  padding-bottom: 0;
}

.posts-list h2.post-tag {
  border-bottom: 1px solid rgba(0, 0, 0, 0.2);
  padding-bottom: 12px;
}
.posts-list {
  margin-top: 60px;
  margin-bottom: 24px;
}

.posts-list .post-preview {
  text-decoration: none;
  overflow: hidden;
  display: block;
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  padding: 24px 0;
}

.post-preview-last {
  border-bottom: none !important;
}

.posts-list .posts-list-caption {
  grid-column: screen;
  font-weight: 400;
}

.posts-list .post-preview h2 {
  margin: 0 0 6px 0;
  line-height: 1.2em;
  font-style: normal;
  font-size: 24px;
}

.posts-list .post-preview p {
  margin: 0 0 12px 0;
  line-height: 1.4em;
  font-size: 16px;
}

.posts-list .post-preview .thumbnail {
  box-sizing: border-box;
  margin-bottom: 24px;
  position: relative;
  max-width: 500px;
}
.posts-list .post-preview img {
  width: 100%;
  display: block;
}

.posts-list .metadata {
  font-size: 12px;
  line-height: 1.4em;
  margin-bottom: 18px;
}

.posts-list .metadata > * {
  display: inline-block;
}

.posts-list .metadata .publishedDate {
  margin-right: 2em;
}

.posts-list .metadata .dt-authors {
  display: block;
  margin-top: 0.3em;
  margin-right: 2em;
}

.posts-list .dt-tags {
  display: block;
  line-height: 1em;
}

.posts-list .dt-tags .dt-tag {
  display: inline-block;
  color: rgba(0,0,0,0.6);
  padding: 0.3em 0.4em;
  margin-right: 0.2em;
  margin-bottom: 0.4em;
  font-size: 60%;
  border: 1px solid rgba(0,0,0,0.2);
  border-radius: 3px;
  text-transform: uppercase;
  font-weight: 500;
}

.posts-list img {
  opacity: 1;
}

.posts-list img[data-src] {
  opacity: 0;
}

.posts-more {
  clear: both;
}


.posts-sidebar {
  font-size: 16px;
}

.posts-sidebar h3 {
  font-size: 16px;
  margin-top: 0;
  margin-bottom: 0.5em;
  font-weight: 400;
  text-transform: uppercase;
}

.sidebar-section {
  margin-bottom: 30px;
}

.categories ul {
  list-style-type: none;
  margin: 0;
  padding: 0;
}

.categories li {
  color: rgba(0, 0, 0, 0.8);
  margin-bottom: 0;
}

.categories li>a {
  border-bottom: none;
}

.categories li>a:hover {
  border-bottom: 1px solid rgba(0, 0, 0, 0.4);
}

.categories .active {
  font-weight: 600;
}

.categories .category-count {
  color: rgba(0, 0, 0, 0.4);
}


@media(min-width: 768px) {
  .posts-list .post-preview h2 {
    font-size: 26px;
  }
  .posts-list .post-preview .thumbnail {
    float: right;
    width: 30%;
    margin-bottom: 0;
  }
  .posts-list .post-preview .description {
    float: left;
    width: 45%;
  }
  .posts-list .post-preview .metadata {
    float: left;
    width: 20%;
    margin-top: 8px;
  }
  .posts-list .post-preview p {
    margin: 0 0 12px 0;
    line-height: 1.5em;
    font-size: 16px;
  }
  .posts-with-sidebar .posts-list {
    float: left;
    width: 75%;
  }
  .posts-with-sidebar .posts-sidebar {
    float: right;
    width: 20%;
    margin-top: 60px;
    padding-top: 24px;
    padding-bottom: 24px;
  }
}


/* Improve display for browsers without grid (IE/Edge <= 15) */

.downlevel {
  line-height: 1.6em;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
  margin: 0;
}

.downlevel .d-title {
  padding-top: 6rem;
  padding-bottom: 1.5rem;
}

.downlevel .d-title h1 {
  font-size: 50px;
  font-weight: 700;
  line-height: 1.1em;
  margin: 0 0 0.5rem;
}

.downlevel .d-title p {
  font-weight: 300;
  font-size: 1.2rem;
  line-height: 1.55em;
  margin-top: 0;
}

.downlevel .d-byline {
  padding-top: 0.8em;
  padding-bottom: 0.8em;
  font-size: 0.8rem;
  line-height: 1.8em;
}

.downlevel .section-separator {
  border: none;
  border-top: 1px solid rgba(0, 0, 0, 0.1);
}

.downlevel .d-article {
  font-size: 1.06rem;
  line-height: 1.7em;
  padding-top: 1rem;
  padding-bottom: 2rem;
}


.downlevel .d-appendix {
  padding-left: 0;
  padding-right: 0;
  max-width: none;
  font-size: 0.8em;
  line-height: 1.7em;
  margin-bottom: 0;
  color: rgba(0,0,0,0.5);
  padding-top: 40px;
  padding-bottom: 48px;
}

.downlevel .footnotes ol {
  padding-left: 13px;
}

.downlevel .base-grid,
.downlevel .distill-header,
.downlevel .d-title,
.downlevel .d-abstract,
.downlevel .d-article,
.downlevel .d-appendix,
.downlevel .distill-appendix,
.downlevel .d-byline,
.downlevel .d-footnote-list,
.downlevel .d-citation-list,
.downlevel .distill-footer,
.downlevel .appendix-bottom,
.downlevel .posts-container {
  padding-left: 40px;
  padding-right: 40px;
}

@media(min-width: 768px) {
  .downlevel .base-grid,
  .downlevel .distill-header,
  .downlevel .d-title,
  .downlevel .d-abstract,
  .downlevel .d-article,
  .downlevel .d-appendix,
  .downlevel .distill-appendix,
  .downlevel .d-byline,
  .downlevel .d-footnote-list,
  .downlevel .d-citation-list,
  .downlevel .distill-footer,
  .downlevel .appendix-bottom,
  .downlevel .posts-container {
  padding-left: 150px;
  padding-right: 150px;
  max-width: 900px;
}
}

.downlevel pre code {
  display: block;
  border-left: 2px solid rgba(0, 0, 0, .1);
  padding: 0 0 0 20px;
  font-size: 14px;
}

.downlevel code, .downlevel pre {
  color: black;
  background: none;
  font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.5;

  -moz-tab-size: 4;
  -o-tab-size: 4;
  tab-size: 4;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

.downlevel .posts-list .post-preview {
  color: inherit;
}



</style>

<script type="application/javascript">

function is_downlevel_browser() {
  if (bowser.isUnsupportedBrowser({ msie: "12", msedge: "16"},
                                 window.navigator.userAgent)) {
    return true;
  } else {
    return window.load_distill_framework === undefined;
  }
}

// show body when load is complete
function on_load_complete() {

  // add anchors
  if (window.anchors) {
    window.anchors.options.placement = 'left';
    window.anchors.add('d-article > h2, d-article > h3, d-article > h4, d-article > h5');
  }


  // set body to visible
  document.body.style.visibility = 'visible';

  // force redraw for leaflet widgets
  if (window.HTMLWidgets) {
    var maps = window.HTMLWidgets.findAll(".leaflet");
    $.each(maps, function(i, el) {
      var map = this.getMap();
      map.invalidateSize();
      map.eachLayer(function(layer) {
        if (layer instanceof L.TileLayer)
          layer.redraw();
      });
    });
  }

  // trigger 'shown' so htmlwidgets resize
  $('d-article').trigger('shown');
}

function init_distill() {

  init_common();

  // create front matter
  var front_matter = $('<d-front-matter></d-front-matter>');
  $('#distill-front-matter').wrap(front_matter);

  // create d-title
  $('.d-title').changeElementType('d-title');

  // create d-byline
  var byline = $('<d-byline></d-byline>');
  $('.d-byline').replaceWith(byline);

  // create d-article
  var article = $('<d-article></d-article>');
  $('.d-article').wrap(article).children().unwrap();

  // move posts container into article
  $('.posts-container').appendTo($('d-article'));

  // create d-appendix
  $('.d-appendix').changeElementType('d-appendix');

  // flag indicating that we have appendix items
  var appendix = $('.appendix-bottom').children('h3').length > 0;

  // replace footnotes with <d-footnote>
  $('.footnote-ref').each(function(i, val) {
    appendix = true;
    var href = $(this).attr('href');
    var id = href.replace('#', '');
    var fn = $('#' + id);
    var fn_p = $('#' + id + '>p');
    fn_p.find('.footnote-back').remove();
    var text = fn_p.html();
    var dtfn = $('<d-footnote></d-footnote>');
    dtfn.html(text);
    $(this).replaceWith(dtfn);
  });
  // remove footnotes
  $('.footnotes').remove();

  // move refs into #references-listing
  $('#references-listing').replaceWith($('#refs'));

  $('h1.appendix, h2.appendix').each(function(i, val) {
    $(this).changeElementType('h3');
  });
  $('h3.appendix').each(function(i, val) {
    var id = $(this).attr('id');
    $('.d-contents a[href="#' + id + '"]').parent().remove();
    appendix = true;
    $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('d-appendix'));
  });

  // show d-appendix if we have appendix content
  $("d-appendix").css('display', appendix ? 'grid' : 'none');

  // localize layout chunks to just output
  $('.layout-chunk').each(function(i, val) {

    // capture layout
    var layout = $(this).attr('data-layout');

    // apply layout to markdown level block elements
    var elements = $(this).children().not('details, div.sourceCode, pre, script');
    elements.each(function(i, el) {
      var layout_div = $('<div class="' + layout + '"></div>');
      if (layout_div.hasClass('shaded')) {
        var shaded_content = $('<div class="shaded-content"></div>');
        $(this).wrap(shaded_content);
        $(this).parent().wrap(layout_div);
      } else {
        $(this).wrap(layout_div);
      }
    });


    // unwrap the layout-chunk div
    $(this).children().unwrap();
  });

  // remove code block used to force  highlighting css
  $('.distill-force-highlighting-css').parent().remove();

  // remove empty line numbers inserted by pandoc when using a
  // custom syntax highlighting theme
  $('code.sourceCode a:empty').remove();

  // load distill framework
  load_distill_framework();

  // wait for window.distillRunlevel == 4 to do post processing
  function distill_post_process() {

    if (!window.distillRunlevel || window.distillRunlevel < 4)
      return;

    // hide author/affiliations entirely if we have no authors
    var front_matter = JSON.parse($("#distill-front-matter").html());
    var have_authors = front_matter.authors && front_matter.authors.length > 0;
    if (!have_authors)
      $('d-byline').addClass('hidden');

    // article with toc class
    $('.d-contents').parent().addClass('d-article-with-toc');

    // strip links that point to #
    $('.authors-affiliations').find('a[href="#"]').removeAttr('href');

    // add orcid ids
    $('.authors-affiliations').find('.author').each(function(i, el) {
      var orcid_id = front_matter.authors[i].orcidID;
      if (orcid_id) {
        var a = $('<a></a>');
        a.attr('href', 'https://orcid.org/' + orcid_id);
        var img = $('<img></img>');
        img.addClass('orcid-id');
        img.attr('alt', 'ORCID ID');
        img.attr('src','data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg==');
        a.append(img);
        $(this).append(a);
      }
    });

    // hide elements of author/affiliations grid that have no value
    function hide_byline_column(caption) {
      $('d-byline').find('h3:contains("' + caption + '")').parent().css('visibility', 'hidden');
    }

    // affiliations
    var have_affiliations = false;
    for (var i = 0; i<front_matter.authors.length; ++i) {
      var author = front_matter.authors[i];
      if (author.affiliation !== "&nbsp;") {
        have_affiliations = true;
        break;
      }
    }
    if (!have_affiliations)
      $('d-byline').find('h3:contains("Affiliations")').css('visibility', 'hidden');

    // published date
    if (!front_matter.publishedDate)
      hide_byline_column("Published");

    // document object identifier
    var doi = $('d-byline').find('h3:contains("DOI")');
    var doi_p = doi.next().empty();
    if (!front_matter.doi) {
      // if we have a citation and valid citationText then link to that
      if ($('#citation').length > 0 && front_matter.citationText) {
        doi.html('Citation');
        $('<a href="#citation"></a>')
          .text(front_matter.citationText)
          .appendTo(doi_p);
      } else {
        hide_byline_column("DOI");
      }
    } else {
      $('<a></a>')
         .attr('href', "https://doi.org/" + front_matter.doi)
         .html(front_matter.doi)
         .appendTo(doi_p);
    }

     // change plural form of authors/affiliations
    if (front_matter.authors.length === 1) {
      var grid = $('.authors-affiliations');
      grid.children('h3:contains("Authors")').text('Author');
      grid.children('h3:contains("Affiliations")').text('Affiliation');
    }

    // remove d-appendix and d-footnote-list local styles
    $('d-appendix > style:first-child').remove();
    $('d-footnote-list > style:first-child').remove();

    // move appendix-bottom entries to the bottom
    $('.appendix-bottom').appendTo('d-appendix').children().unwrap();
    $('.appendix-bottom').remove();

    // hoverable references
    $('span.citation[data-cites]').each(function() {
      if ($(this).children()[0].nodeName == "D-FOOTNOTE") {
        var fn = $(this).children()[0]
        $(this).html(fn.shadowRoot.querySelector("sup"))
        $(this).id = fn.id
        fn.remove()
      }
      var refs = $(this).attr('data-cites').split(" ");
      var refHtml = refs.map(function(ref) {
        return "<p>" + $('#ref-' + ref).html() + "</p>";
      }).join("\n");
      window.tippy(this, {
        allowHTML: true,
        content: refHtml,
        maxWidth: 500,
        interactive: true,
        interactiveBorder: 10,
        theme: 'light-border',
        placement: 'bottom-start'
      });
    });

    // fix footnotes in tables (#411)
    // replacing broken distill.pub feature
    $('table d-footnote').each(function() {
      // we replace internal showAtNode methode which is triggered when hovering a footnote
      this.hoverBox.showAtNode = function(node) {
        // ported from https://github.com/distillpub/template/pull/105/files
        calcOffset = function(elem) {
            let x = elem.offsetLeft;
            let y = elem.offsetTop;
            // Traverse upwards until an `absolute` element is found or `elem`
            // becomes null.
            while (elem = elem.offsetParent && elem.style.position != 'absolute') {
                x += elem.offsetLeft;
                y += elem.offsetTop;
            }

            return { left: x, top: y };
        }
        // https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement/offsetTop
        const bbox = node.getBoundingClientRect();
        const offset = calcOffset(node);
        this.show([offset.left + bbox.width, offset.top + bbox.height]);
      }
    })

    // clear polling timer
    clearInterval(tid);

    // show body now that everything is ready
    on_load_complete();
  }

  var tid = setInterval(distill_post_process, 50);
  distill_post_process();

}

function init_downlevel() {

  init_common();

   // insert hr after d-title
  $('.d-title').after($('<hr class="section-separator"/>'));

  // check if we have authors
  var front_matter = JSON.parse($("#distill-front-matter").html());
  var have_authors = front_matter.authors && front_matter.authors.length > 0;

  // manage byline/border
  if (!have_authors)
    $('.d-byline').remove();
  $('.d-byline').after($('<hr class="section-separator"/>'));
  $('.d-byline a').remove();

  // remove toc
  $('.d-contents').remove();

  // move appendix elements
  $('h1.appendix, h2.appendix').each(function(i, val) {
    $(this).changeElementType('h3');
  });
  $('h3.appendix').each(function(i, val) {
    $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('.d-appendix'));
  });


  // inject headers into references and footnotes
  var refs_header = $('<h3></h3>');
  refs_header.text('References');
  $('#refs').prepend(refs_header);

  var footnotes_header = $('<h3></h3');
  footnotes_header.text('Footnotes');
  $('.footnotes').children('hr').first().replaceWith(footnotes_header);

  // move appendix-bottom entries to the bottom
  $('.appendix-bottom').appendTo('.d-appendix').children().unwrap();
  $('.appendix-bottom').remove();

  // remove appendix if it's empty
  if ($('.d-appendix').children().length === 0)
    $('.d-appendix').remove();

  // prepend separator above appendix
  $('.d-appendix').before($('<hr class="section-separator" style="clear: both"/>'));

  // trim code
  $('pre>code').each(function(i, val) {
    $(this).html($.trim($(this).html()));
  });

  // move posts-container right before article
  $('.posts-container').insertBefore($('.d-article'));

  $('body').addClass('downlevel');

  on_load_complete();
}


function init_common() {

  // jquery plugin to change element types
  (function($) {
    $.fn.changeElementType = function(newType) {
      var attrs = {};

      $.each(this[0].attributes, function(idx, attr) {
        attrs[attr.nodeName] = attr.nodeValue;
      });

      this.replaceWith(function() {
        return $("<" + newType + "/>", attrs).append($(this).contents());
      });
    };
  })(jQuery);

  // prevent underline for linked images
  $('a > img').parent().css({'border-bottom' : 'none'});

  // mark non-body figures created by knitr chunks as 100% width
  $('.layout-chunk').each(function(i, val) {
    var figures = $(this).find('img, .html-widget');
    // ignore leaflet img layers (#106)
    figures = figures.filter(':not(img[class*="leaflet"])')
    if ($(this).attr('data-layout') !== "l-body") {
      figures.css('width', '100%');
    } else {
      figures.css('max-width', '100%');
      figures.filter("[width]").each(function(i, val) {
        var fig = $(this);
        fig.css('width', fig.attr('width') + 'px');
      });

    }
  });

  // auto-append index.html to post-preview links in file: protocol
  // and in rstudio ide preview
  $('.post-preview').each(function(i, val) {
    if (window.location.protocol === "file:")
      $(this).attr('href', $(this).attr('href') + "index.html");
  });

  // get rid of index.html references in header
  if (window.location.protocol !== "file:") {
    $('.distill-site-header a[href]').each(function(i,val) {
      $(this).attr('href', $(this).attr('href').replace(/^index[.]html/, "./"));
    });
  }

  // add class to pandoc style tables
  $('tr.header').parent('thead').parent('table').addClass('pandoc-table');
  $('.kable-table').children('table').addClass('pandoc-table');

  // add figcaption style to table captions
  $('caption').parent('table').addClass("figcaption");

  // initialize posts list
  if (window.init_posts_list)
    window.init_posts_list();

  // implmement disqus comment link
  $('.disqus-comment-count').click(function() {
    window.headroom_prevent_pin = true;
    $('#disqus_thread').toggleClass('hidden');
    if (!$('#disqus_thread').hasClass('hidden')) {
      var offset = $(this).offset();
      $(window).resize();
      $('html, body').animate({
        scrollTop: offset.top - 35
      });
    }
  });
}

document.addEventListener('DOMContentLoaded', function() {
  if (is_downlevel_browser())
    init_downlevel();
  else
    window.addEventListener('WebComponentsReady', init_distill);
});

</script>

<!--/radix_placeholder_distill-->
  <script src="../../site_libs/header-attrs-2.14/header-attrs.js"></script>
  <script src="../../site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
  <script src="../../site_libs/popper-2.6.0/popper.min.js"></script>
  <link href="../../site_libs/tippy-6.2.7/tippy.css" rel="stylesheet" />
  <link href="../../site_libs/tippy-6.2.7/tippy-light-border.css" rel="stylesheet" />
  <script src="../../site_libs/tippy-6.2.7/tippy.umd.min.js"></script>
  <script src="../../site_libs/anchor-4.2.2/anchor.min.js"></script>
  <script src="../../site_libs/bowser-1.9.3/bowser.min.js"></script>
  <script src="../../site_libs/webcomponents-2.0.0/webcomponents.js"></script>
  <script src="../../site_libs/distill-2.2.21/template.v2.js"></script>
  <!--radix_placeholder_site_in_header-->
<script type="text/javascript" cookie-consent="tracking" async src="https://www.googletagmanager.com/gtag/js?id=UA-79842648-2"></script>
<script type="text/javascript" cookie-consent="tracking">
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-79842648-2');
</script>
<style type="text/css">
.distill-site-nav {
  font-family: 'Karla', sans-serif;
  color: #000;
  background-color: #fff;
  font-size: 15px;
  font-weight: 400;
}

.distill-site-header {
  font-family: 'Karla', sans-serif;
  color: #000;
  background-color: #fff;
  font-size: 15px;
  font-weight: 400;
}

@import url('https://fonts.googleapis.com/css2?family=Lato');
@import url('https://fonts.googleapis.com/css2?family=Karla');
@import url('https://fonts.googleapis.com/css2?family=Fira+Code');

html,
body,
p {
  font-family: 'Karla', sans-serif;
  font-weight: 300;
  line-height: 1.3;
  font-size: 1em;
  color: #333333;
  font-style: normal;
}

code {
  font-family: 'Fira Code', sans-serif;
  /* color: #383838; */
  background: #ffffff;
  /* font-weight: 400; */
  font-size: 0.9em;
}

h1,
h2,
h3,
h4,
h5 {
  font-family: 'Karla', sans-serif;
}

.distill-site-nav a {
  font-family: 'Karla', sans-serif;
  font-weight: 500;
  font-size: 15px;
  color: #000;
  text-decoration: none;
}

.distill-site-nav a:hover {
  color: #A020F0;
}

.nav-dropdown-content a {
  font-family: 'Karla', sans-serif;
  font-weight: 500;
  color: #ffffff;
}

.distill-site-header {
  font-family: 'Karla', sans-serif;
  font-weight: 500;
  background-color: #ffffff;
}

.distill-site-footer {
  background-color: #000;
  color: #ffffff;
}

@media print {
  .distill-site-nav {
    display: none;
  }
}

details {
  background-color: hsla(60, 7%, 80%, 0.2);
  cursor: pointer;
  color: #2d2d2d;
  margin-bottom: 1vh;
  padding: 1em;
  border: none;
  text-align: left;
  outline: none;
}

.active,
details:hover {
  transition: max-height 0.2s ease-out;
  /* background-color: #acc2c2; */
}

details {
  display: flex;
  justify-content: space-between;
  align-content: center;
  border-radius: 4px;
}

details.active {
  border-bottom-left-radius: 0;
  border-bottom-right-radius: 0;
}

summary::-webkit-details-marker {
  display: none;
}

summary::after {
  float: right;
  font-family: 'Font Awesome 5 Free';
  content: '\f0fe';
}

details[open] summary::after {
  float: right;
  font-family: 'Font Awesome 5 Free';
  content: '\f146';
}

details h4 {
  margin: 0;
  color: #2d2d2d !important;
  line-height: inherit;
}

d-article pre {
  font-size: 12px;
  color: black;
  background: none;
  margin-top: 0;
  text-align: left;
  /* white-space: pre; */
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1;
  -moz-tab-size: 4;
  -o-tab-size: 4;
  tab-size: 4;
  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

</style>
<!--/radix_placeholder_site_in_header-->


</head>

<body>

<!--radix_placeholder_front_matter-->

<script id="distill-front-matter" type="text/json">
{"title":"What exactly is an \"expected point\"? (part 2)","description":"Evaluating how we can use match outcome probabilites for season-long insights","authors":[{"author":"Tony ElHabr","authorURL":"https://twitter.com/TonyElHabr","affiliation":"&nbsp;","affiliationURL":"#","orcidID":""}],"publishedDate":"2022-09-05T00:00:00.000-05:00","citationText":"ElHabr, 2022"}
</script>

<!--/radix_placeholder_front_matter-->
<!--radix_placeholder_navigation_before_body-->
<header class="header header--fixed" role="banner">
<nav class="distill-site-nav distill-site-header">
<div class="nav-left">
<a href="../../index.html" class="title">Tony</a>
<input id="distill-search" class="nav-search hidden" type="text" placeholder="Search..."/>
</div>
<div class="nav-right">
<a href="../../index.html">Home</a>
<a href="../../about.html">About</a>
<a href="../../projects.html">Projects</a>
<a href="javascript:void(0);" class="nav-toggle">&#9776;</a>
</div>
</nav>
</header>
<!--/radix_placeholder_navigation_before_body-->
<!--radix_placeholder_site_before_body-->
<!--/radix_placeholder_site_before_body-->

<div class="d-title">
<h1>What exactly is an “expected point”? (part 2)</h1>
<!--radix_placeholder_categories-->
<div class="dt-tags">
  <a href="../../index.html#category:r" class="dt-tag">r</a>
  <a href="../../index.html#category:soccer" class="dt-tag">soccer</a>
</div>
<!--/radix_placeholder_categories-->
<p>Evaluating how we can use match outcome probabilites for season-long
insights</p>
</div>

<div class="d-byline">
  Tony ElHabr <a href="https://twitter.com/TonyElHabr"
class="uri">https://twitter.com/TonyElHabr</a> 
  
<br/>2022-09-05
</div>

<div class="d-article">
<div class="d-contents d-contents-float">
<nav class="l-text toc figcaption" id="TOC">
<h3>Contents</h3>
<ul>
<li><a href="#introduction" id="toc-introduction">Introduction</a></li>
<li><a href="#analysis" id="toc-analysis">Analysis</a>
<ul>
<li><a href="#predicting-season-long-points"
id="toc-predicting-season-long-points">1. Predicting season-long
points</a>
<ul>
<li><a href="#with-season-long-xpts-and-xgd"
id="toc-with-season-long-xpts-and-xgd">With season-long xPts and
xGD</a></li>
<li><a href="#with-match-level-outcome-probabilities"
id="toc-with-match-level-outcome-probabilities">With match-level outcome
probabilities</a></li>
</ul></li>
<li><a href="#identifying-un-expected-placings"
id="toc-identifying-un-expected-placings">2. Identifying un-expected
placings</a>
<ul>
<li><a href="#comparison-with-a-simpler-approach"
id="toc-comparison-with-a-simpler-approach">Comparison with a simpler
approach</a></li>
</ul></li>
</ul></li>
<li><a href="#conclusion" id="toc-conclusion">Conclusion</a></li>
</ul>
</nav>
</div>
<h2 id="introduction">Introduction</h2>
<p>I’ll be picking up where I left off in <a
href="https://tonyelhabr.rbind.io//post/epl-xpts-simulation-1">my last
post</a>, so stop everything that you’re doing and go read that if you
haven’t already. In this post we’ll do two things:</p>
<ol type="1">
<li><p>We’ll compare how well season-level expected goal difference
(xGD), season-level xPts, and aggregated match-level xPts predict
season-long points for a given team.</p></li>
<li><p>We’ll use the match-level probabilites to answer the question
“Which teams had the most unlikely placings in the table given the
quality of all their shots across the season?”</p></li>
</ol>
<h2 id="analysis">Analysis</h2>
<h3 id="predicting-season-long-points">1. Predicting season-long
points</h3>
<h4 id="with-season-long-xpts-and-xgd">With season-long xPts and
xGD</h4>
<p>We start with the <code>all_raw_understat_xpts_by_match</code>
variable from the prior post, adding the opponent’s expected goals to
create a column for expected goal difference (<code>xgd</code>).</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>all_raw_understat_xpts_by_match_with_opponent</span> <span class='op'>&lt;-</span> <span class='va'>all_raw_understat_xpts_by_match</span> |&gt; 
  <span class='fu'>inner_join</span><span class='op'>(</span>
    <span class='va'>all_understat_shots</span> |&gt; <span class='fu'>distinct</span><span class='op'>(</span><span class='va'>match_id</span>, <span class='va'>season</span>, <span class='va'>date</span>, <span class='va'>team</span>, <span class='va'>opponent</span><span class='op'>)</span>,
    by <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>'season'</span>, <span class='st'>'date'</span>, <span class='st'>'team'</span><span class='op'>)</span>
  <span class='op'>)</span>

<span class='va'>all_raw_understat_xpts_xgd_by_match</span> <span class='op'>&lt;-</span> <span class='va'>all_raw_understat_xpts_by_match_with_opponent</span> |&gt; 
  <span class='fu'>select</span><span class='op'>(</span>
    <span class='va'>match_id</span>,
    <span class='va'>season</span>,
    <span class='va'>date</span>,
    <span class='va'>team</span>,
    <span class='va'>opponent</span>,
    <span class='va'>pts</span>,
    <span class='co'>## we've already determined that the raw_xpts (provided directly by understat) </span>
    <span class='co'>##   is close to our calculated xpts, so we'll just use the raw_xpts.</span>
    xpts <span class='op'>=</span> <span class='va'>raw_xpts</span>,
    <span class='va'>xg</span>
  <span class='op'>)</span> |&gt; 
  <span class='fu'>inner_join</span><span class='op'>(</span>
    <span class='va'>all_raw_understat_xpts_by_match_with_opponent</span> |&gt; 
      <span class='fu'>select</span><span class='op'>(</span><span class='va'>match_id</span>, opponent <span class='op'>=</span> <span class='va'>team</span>, opponent_xg <span class='op'>=</span> <span class='va'>xg</span><span class='op'>)</span>,
    by <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>'match_id'</span>, <span class='st'>'opponent'</span><span class='op'>)</span>
  <span class='op'>)</span> |&gt; 
  <span class='fu'>mutate</span><span class='op'>(</span>
    xgd <span class='op'>=</span> <span class='va'>xg</span> <span class='op'>-</span> <span class='va'>opponent_xg</span>
  <span class='op'>)</span>
</code></pre>
</div>
</div>
<p>Next, we aggregate up to the season-level.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>all_raw_understat_xpts_xgd_by_season</span> <span class='op'>&lt;-</span> <span class='va'>all_raw_understat_xpts_xgd_by_match</span> |&gt; 
  <span class='fu'>group_by</span><span class='op'>(</span><span class='va'>season</span>, <span class='va'>team</span><span class='op'>)</span> |&gt; 
  <span class='fu'>summarize</span><span class='op'>(</span>
    <span class='fu'>across</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>pts</span>, <span class='va'>xpts</span>, <span class='va'>xgd</span><span class='op'>)</span>, <span class='va'>sum</span><span class='op'>)</span>
  <span class='op'>)</span> |&gt; 
  <span class='fu'>ungroup</span><span class='op'>(</span><span class='op'>)</span> |&gt; 
  <span class='fu'>group_by</span><span class='op'>(</span><span class='va'>season</span><span class='op'>)</span> |&gt; 
  <span class='fu'>mutate</span><span class='op'>(</span>xrank <span class='op'>=</span> <span class='fu'>row_number</span><span class='op'>(</span><span class='fu'>desc</span><span class='op'>(</span><span class='va'>xpts</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> |&gt; 
  <span class='fu'>ungroup</span><span class='op'>(</span><span class='op'>)</span> |&gt; 
  <span class='fu'>arrange</span><span class='op'>(</span><span class='va'>season</span>, <span class='fu'>desc</span><span class='op'>(</span><span class='va'>pts</span><span class='op'>)</span>, <span class='va'>team</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<p>Finally, we compute RMSE and R squared, like we did in the last
post.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>diagnose_season_feature</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>df</span>, <span class='va'>col</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='va'>fit</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/lm.html'>lm</a></span><span class='op'>(</span>
    <span class='va'>df</span><span class='op'>$</span><span class='va'>pts</span> <span class='op'>~</span> <span class='va'>df</span><span class='op'>[[</span><span class='va'>col</span><span class='op'>]</span><span class='op'>]</span>
  <span class='op'>)</span>
  
  <span class='va'>preds</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/predict.html'>predict</a></span><span class='op'>(</span><span class='va'>fit</span><span class='op'>)</span>
  <span class='fu'>tibble</span><span class='fu'>::</span><span class='fu'><a href='https://tibble.tidyverse.org/reference/tibble.html'>tibble</a></span><span class='op'>(</span>
    rmse <span class='op'>=</span> <span class='fu'>compute_rmse</span><span class='op'>(</span><span class='va'>df</span><span class='op'>$</span><span class='va'>pts</span>, <span class='va'>preds</span><span class='op'>)</span>,
    r2 <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/summary.html'>summary</a></span><span class='op'>(</span><span class='va'>fit</span><span class='op'>)</span><span class='op'>$</span><span class='va'>r.squared</span>
  <span class='op'>)</span>
<span class='op'>}</span>

<span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>'xgd'</span>, <span class='st'>'xpts'</span><span class='op'>)</span> |&gt; 
  <span class='fu'>set_names</span><span class='op'>(</span><span class='op'>)</span> |&gt; 
  <span class='fu'>map_dfr</span><span class='op'>(</span>
    <span class='op'>~</span><span class='fu'>diagnose_season_feature</span><span class='op'>(</span><span class='va'>all_raw_understat_xpts_xgd_by_season</span>, <span class='va'>.x</span><span class='op'>)</span>, 
    .id <span class='op'>=</span> <span class='st'>'feature'</span>
  <span class='op'>)</span>
<span class='co'>#&gt; # A tibble: 2 × 3</span>
<span class='co'>#&gt;   feature  rmse    r2</span>
<span class='co'>#&gt;   &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt;</span>
<span class='co'>#&gt; 1 xgd      7.31 0.831</span>
<span class='co'>#&gt; 2 xpts     7.19 0.837</span>
</code></pre>
</div>
</div>
<p>As we should expect, a model using season-long xPts to predict final
points outperforms one using season-long xGD as a feature, although
maybe the difference between the two is smaller than we might have
expected.</p>
<h4 id="with-match-level-outcome-probabilities">With match-level outcome
probabilities</h4>
<p>First, we use the full understat shot data set and the custom
functions from the prior post to calculate xPts by match.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>all_understat_xpts_by_match</span> <span class='op'>&lt;-</span> <span class='va'>all_understat_shots</span> |&gt; 
  <span class='fu'>calculate_permuted_xg</span><span class='op'>(</span><span class='op'>)</span> |&gt; 
  <span class='fu'>summarize_permuted_xg_by_match</span><span class='op'>(</span><span class='op'>)</span>
<span class='va'>all_understat_xpts_by_match</span>
<span class='co'>#&gt; # A tibble: 6,078 × 10</span>
<span class='co'>#&gt;    match…¹ season date       is_home team  oppon…² prob_…³ prob_…⁴ prob_…⁵  xpts</span>
<span class='co'>#&gt;      &lt;dbl&gt; &lt;chr&gt;  &lt;date&gt;     &lt;lgl&gt;   &lt;chr&gt; &lt;chr&gt;     &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;</span>
<span class='co'>#&gt;  1      81 2015/… 2015-08-08 FALSE   Tott… Manche…   0.399   0.321   0.280 1.36 </span>
<span class='co'>#&gt;  2      81 2015/… 2015-08-08 TRUE    Manc… Totten…   0.399   0.280   0.321 1.24 </span>
<span class='co'>#&gt;  3      82 2015/… 2015-08-08 FALSE   Asto… AFC Bo…   0.358   0.292   0.350 1.23 </span>
<span class='co'>#&gt;  4      82 2015/… 2015-08-08 TRUE    AFC … Aston …   0.358   0.350   0.292 1.41 </span>
<span class='co'>#&gt;  5      83 2015/… 2015-08-08 FALSE   Watf… Everton   0.425   0.270   0.305 1.24 </span>
<span class='co'>#&gt;  6      83 2015/… 2015-08-08 TRUE    Ever… Watford   0.425   0.305   0.270 1.34 </span>
<span class='co'>#&gt;  7      84 2015/… 2015-08-08 FALSE   Sund… Leices…   0.207   0.148   0.645 0.651</span>
<span class='co'>#&gt;  8      84 2015/… 2015-08-08 TRUE    Leic… Sunder…   0.207   0.645   0.148 2.14 </span>
<span class='co'>#&gt;  9      85 2015/… 2015-08-08 FALSE   Crys… Norwic…   0.224   0.635   0.141 2.13 </span>
<span class='co'>#&gt; 10      85 2015/… 2015-08-08 TRUE    Norw… Crysta…   0.224   0.141   0.635 0.648</span>
<span class='co'>#&gt; # … with 6,068 more rows, and abbreviated variable names ¹​match_id, ²​opponent,</span>
<span class='co'>#&gt; #   ³​prob_draw, ⁴​prob_win, ⁵​prob_lose</span>
</code></pre>
</div>
</div>
<p>Then, before we move on, we need to handle an edge case: some teams
do not have any shots in some matches.<a href="#fn1"
class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> So
we need to specify that their loss probability is 1.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>init_all_understat_probs_by_match</span> <span class='op'>&lt;-</span> <span class='va'>all_understat_xpts_by_match</span> |&gt; 
  <span class='fu'>select</span><span class='op'>(</span><span class='va'>team</span>, <span class='va'>season</span>, <span class='va'>match_id</span>, <span class='fu'>starts_with</span><span class='op'>(</span><span class='st'>'prob'</span><span class='op'>)</span><span class='op'>)</span> |&gt; 
  <span class='fu'>rename_with</span><span class='op'>(</span><span class='op'>~</span><span class='fu'>str_remove</span><span class='op'>(</span><span class='va'>.x</span>, <span class='st'>'^prob_'</span><span class='op'>)</span>, <span class='fu'>starts_with</span><span class='op'>(</span><span class='st'>'prob'</span><span class='op'>)</span><span class='op'>)</span> |&gt; 
  <span class='fu'>pivot_longer</span><span class='op'>(</span>
    <span class='op'>-</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>team</span>, <span class='va'>season</span>, <span class='va'>match_id</span><span class='op'>)</span>,
    names_to <span class='op'>=</span> <span class='st'>'result'</span>,
    values_to <span class='op'>=</span> <span class='st'>'prob'</span>
  <span class='op'>)</span>

<span class='va'>understat_guaranteed_losses</span> <span class='op'>&lt;-</span> <span class='va'>init_all_understat_probs_by_match</span> |&gt; 
  <span class='fu'>group_by</span><span class='op'>(</span><span class='va'>team</span>, <span class='va'>match_id</span><span class='op'>)</span> |&gt; 
  <span class='fu'><a href='https://rdrr.io/r/stats/filter.html'>filter</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/all.html'>all</a></span><span class='op'>(</span><span class='va'>prob</span> <span class='op'>==</span> <span class='fl'>0</span><span class='op'>)</span><span class='op'>)</span> |&gt; 
  <span class='fu'>ungroup</span><span class='op'>(</span><span class='op'>)</span> |&gt; 
  <span class='fu'><a href='https://rdrr.io/r/stats/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>result</span> <span class='op'>==</span> <span class='st'>'lose'</span><span class='op'>)</span> |&gt; 
  <span class='fu'>mutate</span><span class='op'>(</span>prob <span class='op'>=</span> <span class='fl'>1</span><span class='op'>)</span>

<span class='va'>all_understat_probs_by_match</span> <span class='op'>&lt;-</span> <span class='va'>init_all_understat_probs_by_match</span> |&gt; 
  <span class='fu'>anti_join</span><span class='op'>(</span>
    <span class='va'>understat_guaranteed_losses</span> |&gt; <span class='fu'>select</span><span class='op'>(</span><span class='va'>team</span>, <span class='va'>match_id</span>, <span class='va'>result</span><span class='op'>)</span>,
    by <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>'team'</span>, <span class='st'>'match_id'</span>, <span class='st'>'result'</span><span class='op'>)</span>
  <span class='op'>)</span> |&gt; 
  <span class='fu'>bind_rows</span><span class='op'>(</span>
    <span class='va'>understat_guaranteed_losses</span>
  <span class='op'>)</span> |&gt; 
  <span class='fu'>arrange</span><span class='op'>(</span><span class='va'>season</span>, <span class='va'>team</span>, <span class='va'>match_id</span><span class='op'>)</span>
<span class='va'>all_understat_probs_by_match</span>
<span class='co'>#&gt; # A tibble: 18,234 × 5</span>
<span class='co'>#&gt;    team    season  match_id result   prob</span>
<span class='co'>#&gt;    &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;chr&gt;   &lt;dbl&gt;</span>
<span class='co'>#&gt;  1 Arsenal 2014/15     4408 draw   0.0675</span>
<span class='co'>#&gt;  2 Arsenal 2014/15     4408 win    0.914 </span>
<span class='co'>#&gt;  3 Arsenal 2014/15     4408 lose   0.0183</span>
<span class='co'>#&gt;  4 Arsenal 2014/15     4418 draw   0.159 </span>
<span class='co'>#&gt;  5 Arsenal 2014/15     4418 win    0.795 </span>
<span class='co'>#&gt;  6 Arsenal 2014/15     4418 lose   0.0454</span>
<span class='co'>#&gt;  7 Arsenal 2014/15     4427 draw   0.323 </span>
<span class='co'>#&gt;  8 Arsenal 2014/15     4427 win    0.467 </span>
<span class='co'>#&gt;  9 Arsenal 2014/15     4427 lose   0.210 </span>
<span class='co'>#&gt; 10 Arsenal 2014/15     4429 draw   0.259 </span>
<span class='co'>#&gt; # … with 18,224 more rows</span>
</code></pre>
</div>
</div>
<p>Next, the fun part: simulating match outcomes using the xG-implied
match outcome probabilities, and aggregating the resulting points for an
entire season.<a href="#fn2" class="footnote-ref" id="fnref2"
role="doc-noteref"><sup>2</sup></a> This is computationally intense, so
we parallelize the calculation.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'>parallel</span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://future.futureverse.org'>future</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://github.com/DavisVaughan/furrr'>furrr</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://dplyr.tidyverse.org'>dplyr</a></span><span class='op'>)</span>
<span class='va'>n_cores</span> <span class='op'>&lt;-</span> <span class='fu'>parallel</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/r/parallel/detectCores.html'>detectCores</a></span><span class='op'>(</span><span class='op'>)</span>
<span class='va'>cores_for_parallel</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/Round.html'>ceiling</a></span><span class='op'>(</span><span class='va'>n_cores</span> <span class='op'>*</span> <span class='fl'>1</span><span class='op'>/</span><span class='fl'>2</span><span class='op'>)</span>
<span class='fu'>future</span><span class='fu'>::</span><span class='fu'><a href='https://future.futureverse.org/reference/plan.html'>plan</a></span><span class='op'>(</span>
  <span class='fu'>future</span><span class='fu'>::</span><span class='va'><a href='https://future.futureverse.org/reference/multisession.html'>multisession</a></span>,
  workers <span class='op'>=</span> <span class='va'>cores_for_parallel</span>
<span class='op'>)</span>

<span class='fu'><a href='https://rdrr.io/r/base/Random.html'>set.seed</a></span><span class='op'>(</span><span class='fl'>42</span><span class='op'>)</span>
<span class='va'>n_sims</span> <span class='op'>&lt;-</span> <span class='fl'>10000</span>
<span class='va'>understat_sim_pts_by_season</span> <span class='op'>&lt;-</span> <span class='fu'>furrr</span><span class='fu'>::</span><span class='fu'><a href='https://furrr.futureverse.org/reference/future_imap.html'>future_imap_dfr</a></span><span class='op'>(</span>
  <span class='fu'>rlang</span><span class='fu'>::</span><span class='fu'><a href='https://rlang.r-lib.org/reference/set_names.html'>set_names</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>:</span><span class='va'>n_sims</span><span class='op'>)</span>,
  <span class='op'>~</span><span class='op'>{</span>
    <span class='va'>understat_probs_by_match</span> |&gt; 
      <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>team</span>, <span class='va'>season</span>, <span class='va'>match_id</span><span class='op'>)</span> |&gt; 
      <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice_sample</a></span><span class='op'>(</span>n <span class='op'>=</span> <span class='fl'>1</span>, weight_by <span class='op'>=</span> <span class='va'>prob</span><span class='op'>)</span> |&gt; 
      <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>ungroup</a></span><span class='op'>(</span><span class='op'>)</span> |&gt;
      <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>
        sim_idx <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/integer.html'>as.integer</a></span><span class='op'>(</span><span class='op'>!</span><span class='op'>!</span><span class='va'>.y</span><span class='op'>)</span>,
        .before <span class='op'>=</span> <span class='fl'>1</span>
      <span class='op'>)</span> |&gt; 
      <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>
        pts <span class='op'>=</span> <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/case_when.html'>case_when</a></span><span class='op'>(</span>
          <span class='va'>result</span> <span class='op'>==</span> <span class='st'>'win'</span> <span class='op'>~</span> <span class='fl'>3L</span>,
          <span class='va'>result</span> <span class='op'>==</span> <span class='st'>'lose'</span> <span class='op'>~</span> <span class='fl'>1L</span>,
          <span class='cn'>TRUE</span> <span class='op'>~</span> <span class='fl'>0L</span>
        <span class='op'>)</span>
      <span class='op'>)</span> |&gt; 
      <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>season</span>, <span class='va'>team</span>, <span class='va'>sim_idx</span><span class='op'>)</span> |&gt; 
      <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/summarise.html'>summarize</a></span><span class='op'>(</span>
        <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/across.html'>across</a></span><span class='op'>(</span><span class='va'>pts</span>, <span class='va'>sum</span><span class='op'>)</span>
      <span class='op'>)</span> |&gt; 
      <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>ungroup</a></span><span class='op'>(</span><span class='op'>)</span> |&gt; 
      <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>season</span>, <span class='va'>sim_idx</span><span class='op'>)</span> |&gt; 
      <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>
        rank <span class='op'>=</span> <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/ranking.html'>row_number</a></span><span class='op'>(</span><span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/desc.html'>desc</a></span><span class='op'>(</span><span class='va'>pts</span><span class='op'>)</span><span class='op'>)</span>
      <span class='op'>)</span> |&gt; 
      <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>ungroup</a></span><span class='op'>(</span><span class='op'>)</span> |&gt; 
      <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/arrange.html'>arrange</a></span><span class='op'>(</span><span class='va'>season</span>, <span class='va'>sim_idx</span>, <span class='va'>rank</span><span class='op'>)</span>
  <span class='op'>}</span>
<span class='op'>)</span>

<span class='co'>## back to normal processing</span>
<span class='fu'>future</span><span class='fu'>::</span><span class='fu'><a href='https://future.futureverse.org/reference/plan.html'>plan</a></span><span class='op'>(</span><span class='fu'>future</span><span class='fu'>::</span><span class='va'><a href='https://future.futureverse.org/reference/sequential.html'>sequential</a></span><span class='op'>)</span>

<span class='va'>understat_sim_pts_by_season</span>
<span class='co'>#&gt; # A tibble: 1,600,000 × 5</span>
<span class='co'>#&gt;    season  team                 sim_idx   pts  rank</span>
<span class='co'>#&gt;    &lt;chr&gt;   &lt;chr&gt;                  &lt;int&gt; &lt;int&gt; &lt;int&gt;</span>
<span class='co'>#&gt;  1 2014/15 Chelsea                    1    75     1</span>
<span class='co'>#&gt;  2 2014/15 Manchester City            1    75     2</span>
<span class='co'>#&gt;  3 2014/15 Arsenal                    1    70     3</span>
<span class='co'>#&gt;  4 2014/15 Manchester United          1    69     4</span>
<span class='co'>#&gt;  5 2014/15 Stoke City                 1    69     5</span>
<span class='co'>#&gt;  6 2014/15 Liverpool                  1    68     6</span>
<span class='co'>#&gt;  7 2014/15 Southampton                1    68     7</span>
<span class='co'>#&gt;  8 2014/15 West Ham United            1    67     8</span>
<span class='co'>#&gt;  9 2014/15 Tottenham Hotspur          1    57     9</span>
<span class='co'>#&gt; 10 2014/15 West Bromwich Albion       1    56    10</span>
<span class='co'>#&gt; # … with 1,599,990 more rows</span>
</code></pre>
</div>
</div>
<p>Next, we aggregate the season-long points across simulations,
calculating the relative proportion of simulations (<code>prop</code>)
in which a given team ends up at a given rank (<code>xrank</code>).</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>understat_sim_placings</span> <span class='op'>&lt;-</span> <span class='va'>understat_sim_pts_by_season</span> |&gt; 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>season</span>, <span class='va'>team</span>, xrank <span class='op'>=</span> <span class='va'>rank</span><span class='op'>)</span> |&gt; 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/summarise.html'>summarize</a></span><span class='op'>(</span>
    n <span class='op'>=</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/context.html'>n</a></span><span class='op'>(</span><span class='op'>)</span>,
    xpts <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='va'>pts</span><span class='op'>)</span>
  <span class='op'>)</span> |&gt; 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>ungroup</a></span><span class='op'>(</span><span class='op'>)</span> |&gt; 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>season</span>, <span class='va'>team</span><span class='op'>)</span> |&gt; 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>
    prop <span class='op'>=</span> <span class='va'>n</span> <span class='op'>/</span> <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='va'>n</span><span class='op'>)</span>
  <span class='op'>)</span> |&gt; 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>ungroup</a></span><span class='op'>(</span><span class='op'>)</span> |&gt; 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/arrange.html'>arrange</a></span><span class='op'>(</span><span class='va'>season</span>, <span class='va'>team</span>, <span class='fu'><a href='https://dplyr.tidyverse.org/reference/desc.html'>desc</a></span><span class='op'>(</span><span class='va'>xrank</span><span class='op'>)</span><span class='op'>)</span> |&gt; 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>season</span>, <span class='va'>team</span><span class='op'>)</span> |&gt; 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>
    inv_cumu_prop <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/cumsum.html'>cumsum</a></span><span class='op'>(</span><span class='va'>prop</span><span class='op'>)</span>
  <span class='op'>)</span> |&gt; 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>ungroup</a></span><span class='op'>(</span><span class='op'>)</span> |&gt; 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/arrange.html'>arrange</a></span><span class='op'>(</span><span class='va'>season</span>, <span class='va'>team</span>, <span class='va'>xrank</span><span class='op'>)</span> |&gt; 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>season</span>, <span class='va'>team</span><span class='op'>)</span> |&gt; 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>
    cumu_prop <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/cumsum.html'>cumsum</a></span><span class='op'>(</span><span class='va'>prop</span><span class='op'>)</span>,
    .before <span class='op'>=</span> <span class='va'>inv_cumu_prop</span>
  <span class='op'>)</span> |&gt; 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>ungroup</a></span><span class='op'>(</span><span class='op'>)</span>
<span class='va'>understat_sim_placings</span>
<span class='co'>#&gt; # A tibble: 2,907 × 8</span>
<span class='co'>#&gt;    season  team    xrank     n  xpts   prop cumu_prop inv_cumu_prop</span>
<span class='co'>#&gt;    &lt;chr&gt;   &lt;chr&gt;   &lt;int&gt; &lt;int&gt; &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt;         &lt;dbl&gt;</span>
<span class='co'>#&gt;  1 2014/15 Arsenal     1  3897  80.8 0.390      0.390        1     </span>
<span class='co'>#&gt;  2 2014/15 Arsenal     2  2561  75.4 0.256      0.646        0.610 </span>
<span class='co'>#&gt;  3 2014/15 Arsenal     3  1790  71.7 0.179      0.825        0.354 </span>
<span class='co'>#&gt;  4 2014/15 Arsenal     4   859  68.5 0.0859     0.911        0.175 </span>
<span class='co'>#&gt;  5 2014/15 Arsenal     5   418  65.6 0.0418     0.952        0.0893</span>
<span class='co'>#&gt;  6 2014/15 Arsenal     6   196  63.9 0.0196     0.972        0.0475</span>
<span class='co'>#&gt;  7 2014/15 Arsenal     7   117  61.6 0.0117     0.984        0.0279</span>
<span class='co'>#&gt;  8 2014/15 Arsenal     8    66  59.4 0.0066     0.990        0.0162</span>
<span class='co'>#&gt;  9 2014/15 Arsenal     9    41  58.3 0.0041     0.994        0.0096</span>
<span class='co'>#&gt; 10 2014/15 Arsenal    10    21  57.9 0.0021     0.997        0.0055</span>
<span class='co'>#&gt; # … with 2,897 more rows</span>
</code></pre>
</div>
</div>
<p>Finally, we calculate the weighted average of expected points that a
team ends up with, and run the same regression that we ran earlier with
season-long xPts and xGD.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>understat_sim_placings_agg</span> <span class='op'>&lt;-</span> <span class='va'>understat_sim_placings</span> |&gt; 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>season</span>, <span class='va'>team</span><span class='op'>)</span> |&gt; 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/summarise.html'>summarize</a></span><span class='op'>(</span>
    xpts <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='va'>xpts</span> <span class='op'>*</span> <span class='va'>prop</span><span class='op'>)</span>
  <span class='op'>)</span> |&gt; 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>ungroup</a></span><span class='op'>(</span><span class='op'>)</span> |&gt;
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span>
    <span class='va'>season</span>,
    <span class='va'>team</span>,
    <span class='va'>xpts</span>
  <span class='op'>)</span> |&gt;
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate-joins.html'>inner_join</a></span><span class='op'>(</span>
    <span class='va'>all_raw_understat_xpts_xgd_by_season</span> |&gt; <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='va'>season</span>, <span class='va'>team</span>, <span class='va'>pts</span><span class='op'>)</span>,
    by <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>'season'</span>, <span class='st'>'team'</span><span class='op'>)</span>
  <span class='op'>)</span> |&gt; 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/arrange.html'>arrange</a></span><span class='op'>(</span><span class='va'>season</span>, <span class='fu'><a href='https://dplyr.tidyverse.org/reference/desc.html'>desc</a></span><span class='op'>(</span><span class='va'>xpts</span><span class='op'>)</span><span class='op'>)</span>

<span class='fu'>diagnose_season_feature</span><span class='op'>(</span><span class='va'>understat_sim_placings_agg</span>, <span class='st'>'xpts'</span><span class='op'>)</span>
<span class='co'>#&gt; # A tibble: 1 × 2</span>
<span class='co'>#&gt;    rmse    r2</span>
<span class='co'>#&gt;   &lt;dbl&gt; &lt;dbl&gt;</span>
<span class='co'>#&gt; 1  7.33 0.831</span>
</code></pre>
</div>
</div>
<p>Interestingly, the RMSE and R squared values are almost identical to
the model using season-long xGD, which are themselves almost identical
to the values using season-long xPts. I think this is not too
surprising. Match-level outcome probabilities simulated to get
season-long xPts should give us something very close to just computing
season-long xPts directly. And xPts itself is very closely related to
xGD, particularly at the match-level.</p>
<p>All that work was not for nothing—we may still leverage the
match-level probabilities in a useful manner for season-long insights.
In particular we can use the the relative proportion of simulations
(<code>prop</code>) in which a given team ends up at a given rank
(<code>xrank</code>) to identify which actual end-of-season placings
were the most unexpected.</p>
<h3 id="identifying-un-expected-placings">2. Identifying un-expected
placings</h3>
<p>Before we can identify unlikely placings, we need to step back and
retrieve data on the actual placings. We could theoretically calculate
this from the shot data we already have. However, the logic for handling
own goals is a little complicated. We’re probably better off using
<code>worldfootballR::understat_league_match_results()</code>—which
returns goals at the match-level—to calculate the table. <a href="#fn3"
class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a></p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>match_results</span> <span class='op'>&lt;-</span> <span class='fl'>2014</span><span class='op'>:</span><span class='fl'>2021</span> |&gt; 
  <span class='fu'>purrr</span><span class='fu'>::</span><span class='fu'><a href='https://purrr.tidyverse.org/reference/map.html'>map_dfr</a></span><span class='op'>(</span><span class='op'>~</span><span class='fu'>worldfootballR</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/worldfootballR/man/understat_league_match_results.html'>understat_league_match_results</a></span><span class='op'>(</span><span class='st'>'EPL'</span>, <span class='va'>.x</span><span class='op'>)</span><span class='op'>)</span> |&gt; 
  <span class='fu'>tibble</span><span class='fu'>::</span><span class='fu'><a href='https://tibble.tidyverse.org/reference/as_tibble.html'>as_tibble</a></span><span class='op'>(</span><span class='op'>)</span>

<span class='va'>init_table</span> <span class='op'>&lt;-</span> <span class='va'>match_results</span> |&gt; 
  <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>transmute</a></span><span class='op'>(</span>
    <span class='va'>match_id</span>,
    <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/across.html'>across</a></span><span class='op'>(</span><span class='va'>season</span>, <span class='op'>~</span><span class='fu'>stringr</span><span class='fu'>::</span><span class='fu'><a href='https://stringr.tidyverse.org/reference/str_replace.html'>str_replace</a></span><span class='op'>(</span><span class='va'>.x</span>, <span class='st'>'\\/20'</span>, <span class='st'>'/'</span><span class='op'>)</span><span class='op'>)</span>,
    date <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/strptime.html'>strptime</a></span><span class='op'>(</span><span class='va'>datetime</span>, <span class='st'>'%Y-%m-%d %H:%M:%S'</span>, tz <span class='op'>=</span> <span class='st'>'UTC'</span><span class='op'>)</span> |&gt; <span class='fu'>lubridate</span><span class='fu'>::</span><span class='fu'><a href='https://lubridate.tidyverse.org/reference/date.html'>date</a></span><span class='op'>(</span><span class='op'>)</span>,
    <span class='va'>home_team</span>,
    <span class='va'>home_goals</span>,
    <span class='va'>away_team</span>,
    <span class='va'>away_goals</span>
  <span class='op'>)</span>

<span class='va'>table</span> <span class='op'>&lt;-</span> <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/bind.html'>bind_rows</a></span><span class='op'>(</span>
  <span class='va'>init_table</span> |&gt;
    <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>is_home <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span> |&gt; 
    <span class='fu'>rename_teams</span><span class='op'>(</span><span class='st'>'understat'</span><span class='op'>)</span> |&gt; 
    <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>transmute</a></span><span class='op'>(</span>
      <span class='va'>match_id</span>,
      <span class='va'>date</span>,
      <span class='va'>season</span>,
      <span class='va'>team</span>, 
      <span class='va'>opponent</span>,
      goals <span class='op'>=</span> <span class='va'>home_goals</span>,
      opponent_goals <span class='op'>=</span> <span class='va'>away_goals</span>
    <span class='op'>)</span>,
  <span class='va'>init_table</span> |&gt; 
    <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>is_home <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>)</span> |&gt; 
    <span class='fu'>rename_teams</span><span class='op'>(</span><span class='st'>'understat'</span><span class='op'>)</span> |&gt; 
    <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>transmute</a></span><span class='op'>(</span>
      <span class='va'>match_id</span>,
      <span class='va'>date</span>,
      <span class='va'>season</span>,
      <span class='va'>is_home</span>,
      <span class='va'>team</span>, 
      <span class='va'>opponent</span>,
      goals <span class='op'>=</span> <span class='va'>away_goals</span>,
      opponent_goals <span class='op'>=</span> <span class='va'>home_goals</span>
    <span class='op'>)</span>
<span class='op'>)</span> |&gt; 
  <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>
    pts <span class='op'>=</span> <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/case_when.html'>case_when</a></span><span class='op'>(</span>
      <span class='va'>goals</span> <span class='op'>&gt;</span> <span class='va'>opponent_goals</span> <span class='op'>~</span> <span class='fl'>3L</span>,
      <span class='va'>goals</span> <span class='op'>&lt;</span> <span class='va'>opponent_goals</span> <span class='op'>~</span> <span class='fl'>0L</span>,
      <span class='cn'>TRUE</span> <span class='op'>~</span> <span class='fl'>1L</span>
    <span class='op'>)</span>
  <span class='op'>)</span> |&gt; 
  <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>season</span>, <span class='va'>team</span><span class='op'>)</span> |&gt; 
  <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/summarise.html'>summarize</a></span><span class='op'>(</span>
    <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/across.html'>across</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>goals</span>, <span class='va'>opponent_goals</span>, <span class='va'>pts</span><span class='op'>)</span>, <span class='va'>sum</span><span class='op'>)</span>
  <span class='op'>)</span> |&gt; 
  <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>ungroup</a></span><span class='op'>(</span><span class='op'>)</span> |&gt; 
  <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>gd <span class='op'>=</span> <span class='va'>goals</span> <span class='op'>-</span> <span class='va'>opponent_goals</span><span class='op'>)</span> |&gt; 
  <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/arrange.html'>arrange</a></span><span class='op'>(</span><span class='va'>season</span>, <span class='fu'><a href='https://dplyr.tidyverse.org/reference/desc.html'>desc</a></span><span class='op'>(</span><span class='va'>pts</span><span class='op'>)</span>, <span class='fu'><a href='https://dplyr.tidyverse.org/reference/desc.html'>desc</a></span><span class='op'>(</span><span class='va'>gd</span><span class='op'>)</span><span class='op'>)</span> |&gt; 
  <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>season</span><span class='op'>)</span> |&gt; 
  <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>rank <span class='op'>=</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/ranking.html'>row_number</a></span><span class='op'>(</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/desc.html'>desc</a></span><span class='op'>(</span><span class='va'>pts</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> |&gt; 
  <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>ungroup</a></span><span class='op'>(</span><span class='op'>)</span> |&gt; 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/arrange.html'>arrange</a></span><span class='op'>(</span><span class='va'>season</span>, <span class='va'>rank</span><span class='op'>)</span>
<span class='va'>table</span>
<span class='co'>#&gt; # A tibble: 160 × 7</span>
<span class='co'>#&gt;    season  team              goals opponent_goals   pts    gd  rank</span>
<span class='co'>#&gt;    &lt;chr&gt;   &lt;chr&gt;             &lt;dbl&gt;          &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt; &lt;int&gt;</span>
<span class='co'>#&gt;  1 2014/15 Chelsea              73             32    87    41     1</span>
<span class='co'>#&gt;  2 2014/15 Manchester City      83             38    79    45     2</span>
<span class='co'>#&gt;  3 2014/15 Arsenal              71             36    75    35     3</span>
<span class='co'>#&gt;  4 2014/15 Manchester United    62             37    70    25     4</span>
<span class='co'>#&gt;  5 2014/15 Tottenham            58             53    64     5     5</span>
<span class='co'>#&gt;  6 2014/15 Liverpool            52             48    62     4     6</span>
<span class='co'>#&gt;  7 2014/15 Southampton          54             33    60    21     7</span>
<span class='co'>#&gt;  8 2014/15 Swansea              46             49    56    -3     8</span>
<span class='co'>#&gt;  9 2014/15 Stoke                48             45    54     3     9</span>
<span class='co'>#&gt; 10 2014/15 Crystal Palace       47             51    48    -4    10</span>
<span class='co'>#&gt; # … with 150 more rows</span>
</code></pre>
</div>
</div>
<p>Next, we join the <code>table</code> of end-of-season placements
(<code>actual_rank</code>) to the simulation results that are
<strong><em>not</em></strong> aggregated to a single <code>xrank</code>
per team (<code>understat_sim_placings</code> instead of
<code>understat_sim_placings_agg</code>).</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>understat_sim_placings_with_actual_ranks</span> <span class='op'>&lt;-</span> <span class='va'>understat_sim_placings</span> |&gt; 
  <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate-joins.html'>inner_join</a></span><span class='op'>(</span>
    <span class='va'>table</span> |&gt; <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='va'>season</span>, <span class='va'>team</span>, actual_pts <span class='op'>=</span> <span class='va'>pts</span>, actual_rank <span class='op'>=</span> <span class='va'>rank</span><span class='op'>)</span>,
    by <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>'season'</span>, <span class='st'>'team'</span><span class='op'>)</span>
  <span class='op'>)</span> |&gt; 
  <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate-joins.html'>inner_join</a></span><span class='op'>(</span>
    <span class='va'>all_raw_understat_xpts_xgd_by_season</span> |&gt; 
      <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='va'>season</span>, <span class='va'>team</span>, actual_xpts <span class='op'>=</span> <span class='va'>xpts</span>, <span class='va'>xgd</span><span class='op'>)</span>,
    by <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>'season'</span>, <span class='st'>'team'</span><span class='op'>)</span>
  <span class='op'>)</span> |&gt; 
  <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>transmute</a></span><span class='op'>(</span>
    <span class='va'>season</span>,
    <span class='va'>team</span>,
    <span class='va'>actual_rank</span>,
    <span class='va'>xrank</span>,
    <span class='va'>actual_pts</span>,
    <span class='va'>actual_xpts</span>, 
    <span class='va'>xpts</span>,
    <span class='va'>cumu_prop</span>,
    <span class='va'>inv_cumu_prop</span>
  <span class='op'>)</span>

<span class='va'>understat_sim_placings_with_actual_ranks</span> |&gt;
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='op'>-</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>actual_xpts</span><span class='op'>)</span><span class='op'>)</span> |&gt; 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/across.html'>across</a></span><span class='op'>(</span><span class='fu'><a href='https://tidyselect.r-lib.org/reference/starts_with.html'>ends_with</a></span><span class='op'>(</span><span class='st'>'cumu_prop'</span><span class='op'>)</span>, <span class='va'>round</span>, <span class='fl'>2</span><span class='op'>)</span><span class='op'>)</span>
<span class='co'>#&gt; # A tibble: 2,907 × 8</span>
<span class='co'>#&gt;    season  team    actual_rank xrank actual_pts  xpts cumu_prop inv_cumu_prop</span>
<span class='co'>#&gt;    &lt;chr&gt;   &lt;chr&gt;         &lt;int&gt; &lt;int&gt;      &lt;int&gt; &lt;dbl&gt;     &lt;dbl&gt;         &lt;dbl&gt;</span>
<span class='co'>#&gt;  1 2014/15 Arsenal           3     1         75  80.8      0.39          1   </span>
<span class='co'>#&gt;  2 2014/15 Arsenal           3     2         75  75.4      0.65          0.61</span>
<span class='co'>#&gt;  3 2014/15 Arsenal           3     3         75  71.7      0.82          0.35</span>
<span class='co'>#&gt;  4 2014/15 Arsenal           3     4         75  68.5      0.91          0.18</span>
<span class='co'>#&gt;  5 2014/15 Arsenal           3     5         75  65.6      0.95          0.09</span>
<span class='co'>#&gt;  6 2014/15 Arsenal           3     6         75  63.9      0.97          0.05</span>
<span class='co'>#&gt;  7 2014/15 Arsenal           3     7         75  61.6      0.98          0.03</span>
<span class='co'>#&gt;  8 2014/15 Arsenal           3     8         75  59.4      0.99          0.02</span>
<span class='co'>#&gt;  9 2014/15 Arsenal           3     9         75  58.3      0.99          0.01</span>
<span class='co'>#&gt; 10 2014/15 Arsenal           3    10         75  57.9      1             0.01</span>
<span class='co'>#&gt; # … with 2,897 more rows</span>
</code></pre>
</div>
</div>
<p>Finally, to identify over-acheiving teams, we identify the teams that
had the lowest cumulative probability of placing at their actual placing
or better; and to identify under-achieving teams, we identify the teams
with the lowest cumulative probability of placing at thier actual
placing or worse.<a href="#fn4" class="footnote-ref" id="fnref4"
role="doc-noteref"><sup>4</sup></a></p>
<p><img src="unexpected.png" /></p>
<p>This table certainly passes the eye test. Brighton’s sixteenth place
finish in the 2020/21 season was discussed ad nauseum in the analytics
sphere. Brigthon under-performed historically given their massively
positive xGD. On the other end of the spectrum, it’s not hyperbole to
say that Manchester United’s second place finish in the 2017/18 season
was an under-achievement. Although they ended up with the third best
goal differential that season, they were closely followed by several
teams. And Their xGD was sixth in the league that season.</p>
<h4 id="comparison-with-a-simpler-approach">Comparison with a simpler
approach</h4>
<p>Notably, we could get somewhat similar results by simply looking at
the largest residuals of a model that regresses the actual final table
placing on just xGD, which is how most people tend to think of
“unexpected placings”.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>table_with_xgd</span> <span class='op'>&lt;-</span> <span class='va'>table</span> |&gt; 
  <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='va'>season</span>, <span class='va'>team</span>, actual_pts <span class='op'>=</span> <span class='va'>pts</span>, actual_rank <span class='op'>=</span> <span class='va'>rank</span><span class='op'>)</span> |&gt; 
  <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate-joins.html'>inner_join</a></span><span class='op'>(</span>
    <span class='va'>all_raw_understat_xpts_xgd_by_season</span> |&gt; <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='va'>season</span>, <span class='va'>team</span>, <span class='va'>xgd</span><span class='op'>)</span>,
    by <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>'season'</span>, <span class='st'>'team'</span><span class='op'>)</span>
  <span class='op'>)</span>

<span class='va'>xgd_rank_fit</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/lm.html'>lm</a></span><span class='op'>(</span><span class='va'>actual_rank</span> <span class='op'>~</span> <span class='va'>xgd</span>, <span class='va'>df</span><span class='op'>)</span>

<span class='va'>xgd_rank_preds</span> <span class='op'>&lt;-</span> <span class='va'>table_with_xgd</span> |&gt; 
  <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>transmute</a></span><span class='op'>(</span>
    <span class='va'>season</span>,
    <span class='va'>team</span>,
    <span class='va'>actual_rank</span>,
    .pred <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/predict.html'>predict</a></span><span class='op'>(</span><span class='va'>fit</span><span class='op'>)</span>,
    .resid <span class='op'>=</span> <span class='va'>.pred</span> <span class='op'>-</span> <span class='va'>actual_rank</span>,
    xgd_unexpected_rank <span class='op'>=</span> <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/ranking.html'>row_number</a></span><span class='op'>(</span><span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/desc.html'>desc</a></span><span class='op'>(</span><span class='va'>.resid</span><span class='op'>)</span><span class='op'>)</span>,
    inv_xgd_unexpected_rank <span class='op'>=</span> <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/ranking.html'>row_number</a></span><span class='op'>(</span><span class='va'>.resid</span><span class='op'>)</span>
  <span class='op'>)</span>

<span class='va'>slice_xgd_resids_matching_top5_sim_placings</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>which</span><span class='op'>)</span> <span class='op'>{</span>
  
  <span class='va'>col</span> <span class='op'>&lt;-</span> <span class='kw'><a href='https://rdrr.io/r/base/switch.html'>switch</a></span><span class='op'>(</span>
    <span class='va'>which</span>,
    <span class='st'>'over'</span> <span class='op'>=</span> <span class='st'>'xgd_unexpected_rank'</span>,
    <span class='st'>'under'</span> <span class='op'>=</span> <span class='st'>'inv_xgd_unexpected_rank'</span>
  <span class='op'>)</span>
  
  <span class='va'>unexpected_understat_sim_placings</span> |&gt; 
    <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>which</span> <span class='op'>==</span> <span class='op'>!</span><span class='op'>!</span><span class='va'>which</span><span class='op'>)</span> |&gt; 
    <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>transmute</a></span><span class='op'>(</span><span class='va'>season</span>, <span class='va'>team</span>, <span class='va'>unexpected_rank</span><span class='op'>)</span> |&gt; 
    <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate-joins.html'>inner_join</a></span><span class='op'>(</span>
      <span class='va'>xgd_rank_preds</span> |&gt; 
        <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='va'>season</span>, <span class='va'>team</span>, xgd_unexpected_rank <span class='op'>=</span> <span class='va'>.data</span><span class='op'>[[</span><span class='va'>col</span><span class='op'>]</span><span class='op'>]</span><span class='op'>)</span>,
      by <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>'season'</span>, <span class='st'>'team'</span><span class='op'>)</span>
    <span class='op'>)</span>
<span class='op'>}</span>

<span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>'over'</span>, <span class='st'>'under'</span><span class='op'>)</span> |&gt; 
  <span class='fu'>rlang</span><span class='fu'>::</span><span class='fu'><a href='https://rlang.r-lib.org/reference/set_names.html'>set_names</a></span><span class='op'>(</span><span class='op'>)</span> |&gt; 
  <span class='fu'>purrr</span><span class='fu'>::</span><span class='fu'><a href='https://purrr.tidyverse.org/reference/map.html'>map_dfr</a></span><span class='op'>(</span><span class='va'>slice_xgd_resids_matching_top5_sim_placings</span>, .id <span class='op'>=</span> <span class='st'>'which'</span><span class='op'>)</span>
<span class='co'>#&gt; # A tibble: 10 × 5</span>
<span class='co'>#&gt;    which season  team                     unexpected_rank xgd_unexpected_rank</span>
<span class='co'>#&gt;    &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;                              &lt;int&gt;               &lt;int&gt;</span>
<span class='co'>#&gt;  1 over  2017/18 Manchester United                      1                   6</span>
<span class='co'>#&gt;  2 over  2017/18 Burnley                                2                   1</span>
<span class='co'>#&gt;  3 over  2019/20 Liverpool                              3                  41</span>
<span class='co'>#&gt;  4 over  2020/21 Manchester United                      4                  13</span>
<span class='co'>#&gt;  5 over  2019/20 Newcastle                              5                  17</span>
<span class='co'>#&gt;  6 under 2020/21 Brighton and Hove Albion               1                   1</span>
<span class='co'>#&gt;  7 under 2019/20 Watford                                2                   3</span>
<span class='co'>#&gt;  8 under 2014/15 Queens Park Rangers                    3                   5</span>
<span class='co'>#&gt;  9 under 2017/18 West Bromwich Albion                   4                   2</span>
<span class='co'>#&gt; 10 under 2017/18 Crystal Palace                         5                  58</span>
</code></pre>
</div>
</div>
<p>Four of the top five under-performers according to our expected
points approach are identified as being among the top five
under-achievers by this simpler xGD approach. On the other hand, just
one of the top five over-achievers, 2017/18 Burnley, is identified in
the top five of the xGD approach. Of course, this is just a surface
level comparison.</p>
<h2 id="conclusion">Conclusion</h2>
<p>While using match-level outcome probabilities to try to predict
season-ending points does no better than more direct approaches with
season-long xGD or xPts, match-level outcome probabilities can be used
in a perhaps more interesting way—to quantify just how unlikely a team’s
placement in the table is, given xG for all of their shots across the
season.</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode r distill-force-highlighting-css"><code class="sourceCode r"></code></pre></div>
<section class="footnotes footnotes-end-of-document"
role="doc-endnotes">
<hr />
<ol>
<li id="fn1" role="doc-endnote"><p>Theoretically, there is an even more
extreme case: when both teams do not have any shots in a match. This
does not occur in the data set, so we do not need to correct for this.<a
href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2" role="doc-endnote"><p>This approach is flawed in at least
on way: it doesn’t guarantee that the assigned results in a simulated
match are actually symmetric. For example, if team A is assigned a win
in their match with team B simulation 1, there is no guarantee that team
B is assigned a loss in that simulation. Nonetheless, running lots of
simulations minimizes the noise introduced by such logical
discrepancies.<a href="#fnref2" class="footnote-back"
role="doc-backlink">↩︎</a></p></li>
<li id="fn3" role="doc-endnote"><p>Maybe even more simply, we could use
<code>worldfootballR::fb_season_team_stats(..., stat_type = 'league_table')</code>,
although we’d need to add a column for team names for <a
href="https://fbref.com/en/">FBref</a> to our team mapping to
corroborate team names.<a href="#fnref3" class="footnote-back"
role="doc-backlink">↩︎</a></p></li>
<li id="fn4" role="doc-endnote"><p>Table code is not shown since it’s
not particularly instructive.<a href="#fnref4" class="footnote-back"
role="doc-backlink">↩︎</a></p></li>
</ol>
</section>
<!--radix_placeholder_article_footer-->
<!--/radix_placeholder_article_footer-->
</div>

<div class="d-appendix">
</div>


<!--radix_placeholder_site_after_body-->
<!--/radix_placeholder_site_after_body-->
<!--radix_placeholder_appendices-->
<div class="appendix-bottom">
  <h3 id="citation">Citation</h3>
  <p>For attribution, please cite this work as</p>
  <pre class="citation-appendix short">ElHabr (2022, Sept. 5). Tony: What exactly is an "expected point"? (part 2). Retrieved from https://itsmetoeknee.netlify.app/post/epl-xpts-simulation-2/</pre>
  <p>BibTeX citation</p>
  <pre class="citation-appendix long">@misc{elhabr2022what,
  author = {ElHabr, Tony},
  title = {Tony: What exactly is an "expected point"? (part 2)},
  url = {https://itsmetoeknee.netlify.app/post/epl-xpts-simulation-2/},
  year = {2022}
}</pre>
</div>
<!--/radix_placeholder_appendices-->
<!--radix_placeholder_navigation_after_body-->
<!--/radix_placeholder_navigation_after_body-->

</body>

</html>
