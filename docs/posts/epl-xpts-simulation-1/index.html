<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">

<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"/>
  <meta name="generator" content="distill" />

  <style type="text/css">
  /* Hide doc at startup (prevent jankiness while JS renders/transforms) */
  body {
    visibility: hidden;
  }
  </style>

 <!--radix_placeholder_import_source-->
 <!--/radix_placeholder_import_source-->

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  { color: #00769e; background-color: #f1f3f5; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span { color: #00769e; } /* Normal */
code span.al { color: #ad0000; } /* Alert */
code span.an { color: #5e5e5e; } /* Annotation */
code span.at { color: #657422; } /* Attribute */
code span.bn { color: #ad0000; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #00769e; } /* ControlFlow */
code span.ch { color: #20794d; } /* Char */
code span.cn { color: #8f5902; } /* Constant */
code span.co { color: #5e5e5e; } /* Comment */
code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
code span.dt { color: #ad0000; } /* DataType */
code span.dv { color: #ad0000; } /* DecVal */
code span.er { color: #ad0000; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #ad0000; } /* Float */
code span.fu { color: #4758ab; } /* Function */
code span.im { } /* Import */
code span.in { color: #5e5e5e; } /* Information */
code span.kw { color: #00769e; } /* Keyword */
code span.op { color: #5e5e5e; } /* Operator */
code span.ot { color: #00769e; } /* Other */
code span.pp { color: #ad0000; } /* Preprocessor */
code span.sc { color: #5e5e5e; } /* SpecialChar */
code span.ss { color: #20794d; } /* SpecialString */
code span.st { color: #20794d; } /* String */
code span.va { color: #111111; } /* Variable */
code span.vs { color: #20794d; } /* VerbatimString */
code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
</style>


  <!--radix_placeholder_meta_tags-->
<title>Tony: What exactly is an "expected point"? (part 1)</title>

<meta property="description" itemprop="description" content="Calculating and comparing expected points from different expected goals sources"/>

<link rel="canonical" href="https://itsmetoeknee.netlify.app/posts/epl-xpts-simulation-1/"/>
<link rel="icon" type="image/png" href="../../assets/img/keyboard.png"/>

<!--  https://schema.org/Article -->
<meta property="article:published" itemprop="datePublished" content="2022-09-04"/>
<meta property="article:created" itemprop="dateCreated" content="2022-09-04"/>
<meta name="article:author" content="Tony ElHabr"/>

<!--  https://developers.facebook.com/docs/sharing/webmasters#markup -->
<meta property="og:title" content="Tony: What exactly is an &quot;expected point&quot;? (part 1)"/>
<meta property="og:type" content="article"/>
<meta property="og:description" content="Calculating and comparing expected points from different expected goals sources"/>
<meta property="og:url" content="https://itsmetoeknee.netlify.app/posts/epl-xpts-simulation-1/"/>
<meta property="og:image" content="https://itsmetoeknee.netlify.app/posts/epl-xpts-simulation-1/calib.png"/>
<meta property="og:image:width" content="3000"/>
<meta property="og:image:height" content="2250"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:site_name" content="Tony"/>

<!--  https://dev.twitter.com/cards/types/summary -->
<meta property="twitter:card" content="summary_large_image"/>
<meta property="twitter:title" content="Tony: What exactly is an &quot;expected point&quot;? (part 1)"/>
<meta property="twitter:description" content="Calculating and comparing expected points from different expected goals sources"/>
<meta property="twitter:url" content="https://itsmetoeknee.netlify.app/posts/epl-xpts-simulation-1/"/>
<meta property="twitter:image" content="https://itsmetoeknee.netlify.app/posts/epl-xpts-simulation-1/calib.png"/>
<meta property="twitter:image:width" content="3000"/>
<meta property="twitter:image:height" content="2250"/>
<meta property="twitter:site" content="@TonyElHabr"/>
<meta property="twitter:creator" content="@TonyElHabr"/>

<!--  https://scholar.google.com/intl/en/scholar/inclusion.html#indexing -->
<meta name="citation_title" content="Tony: What exactly is an &quot;expected point&quot;? (part 1)"/>
<meta name="citation_fulltext_html_url" content="https://itsmetoeknee.netlify.app/posts/epl-xpts-simulation-1/"/>
<meta name="citation_online_date" content="2022/09/04"/>
<meta name="citation_publication_date" content="2022/09/04"/>
<meta name="citation_author" content="Tony ElHabr"/>
<!--/radix_placeholder_meta_tags-->
  <!--radix_placeholder_rmarkdown_metadata-->

<script type="text/json" id="radix-rmarkdown-metadata">
{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["title","description","author","date","categories","output","preview","twitter","citation_url","canonical_url"]}},"value":[{"type":"character","attributes":{},"value":["What exactly is an \"expected point\"? (part 1)"]},{"type":"character","attributes":{},"value":["Calculating and comparing expected points from different expected goals sources"]},{"type":"list","attributes":{},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","url"]}},"value":[{"type":"character","attributes":{},"value":["Tony ElHabr"]},{"type":"character","attributes":{},"value":["https://twitter.com/TonyElHabr"]}]}]},{"type":"character","attributes":{},"value":["2022-09-04"]},{"type":"character","attributes":{},"value":["r","soccer"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["distill::distill_article"]}},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["toc","toc_depth","self_contained"]}},"value":[{"type":"logical","attributes":{},"value":[true]},{"type":"integer","attributes":{},"value":[4]},{"type":"logical","attributes":{},"value":[false]}]}]},{"type":"character","attributes":{},"value":["calib.png"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["site","creator"]}},"value":[{"type":"character","attributes":{},"value":["@TonyElHabr"]},{"type":"character","attributes":{},"value":["@TonyElHabr"]}]},{"type":"character","attributes":{},"value":["https://itsmetoeknee.netlify.app/posts/epl-xpts-simulation-1/"]},{"type":"character","attributes":{},"value":["https://itsmetoeknee.netlify.app/posts/epl-xpts-simulation-1/"]}]}
</script>
<!--/radix_placeholder_rmarkdown_metadata-->
  
  <script type="text/json" id="radix-resource-manifest">
  {"type":"character","attributes":{},"value":["calib.png","epl-xpts-simulation-1_files/anchor-4.2.2/anchor.min.js","epl-xpts-simulation-1_files/bowser-1.9.3/bowser.min.js","epl-xpts-simulation-1_files/distill-2.2.21/template.v2.js","epl-xpts-simulation-1_files/header-attrs-2.14/header-attrs.js","epl-xpts-simulation-1_files/jquery-3.6.0/jquery-3.6.0.js","epl-xpts-simulation-1_files/jquery-3.6.0/jquery-3.6.0.min.js","epl-xpts-simulation-1_files/jquery-3.6.0/jquery-3.6.0.min.map","epl-xpts-simulation-1_files/popper-2.6.0/popper.min.js","epl-xpts-simulation-1_files/tippy-6.2.7/tippy-bundle.umd.min.js","epl-xpts-simulation-1_files/tippy-6.2.7/tippy-light-border.css","epl-xpts-simulation-1_files/tippy-6.2.7/tippy.css","epl-xpts-simulation-1_files/tippy-6.2.7/tippy.umd.min.js","epl-xpts-simulation-1_files/webcomponents-2.0.0/webcomponents.js"]}
  </script>
  <!--radix_placeholder_navigation_in_header-->
<meta name="distill:offset" content="../.."/>

<script type="application/javascript">

  window.headroom_prevent_pin = false;

  window.document.addEventListener("DOMContentLoaded", function (event) {

    // initialize headroom for banner
    var header = $('header').get(0);
    var headerHeight = header.offsetHeight;
    var headroom = new Headroom(header, {
      tolerance: 5,
      onPin : function() {
        if (window.headroom_prevent_pin) {
          window.headroom_prevent_pin = false;
          headroom.unpin();
        }
      }
    });
    headroom.init();
    if(window.location.hash)
      headroom.unpin();
    $(header).addClass('headroom--transition');

    // offset scroll location for banner on hash change
    // (see: https://github.com/WickyNilliams/headroom.js/issues/38)
    window.addEventListener("hashchange", function(event) {
      window.scrollTo(0, window.pageYOffset - (headerHeight + 25));
    });

    // responsive menu
    $('.distill-site-header').each(function(i, val) {
      var topnav = $(this);
      var toggle = topnav.find('.nav-toggle');
      toggle.on('click', function() {
        topnav.toggleClass('responsive');
      });
    });

    // nav dropdowns
    $('.nav-dropbtn').click(function(e) {
      $(this).next('.nav-dropdown-content').toggleClass('nav-dropdown-active');
      $(this).parent().siblings('.nav-dropdown')
         .children('.nav-dropdown-content').removeClass('nav-dropdown-active');
    });
    $("body").click(function(e){
      $('.nav-dropdown-content').removeClass('nav-dropdown-active');
    });
    $(".nav-dropdown").click(function(e){
      e.stopPropagation();
    });
  });
</script>

<style type="text/css">

/* Theme (user-documented overrideables for nav appearance) */

.distill-site-nav {
  color: rgba(255, 255, 255, 0.8);
  background-color: #0F2E3D;
  font-size: 15px;
  font-weight: 300;
}

.distill-site-nav a {
  color: inherit;
  text-decoration: none;
}

.distill-site-nav a:hover {
  color: white;
}

@media print {
  .distill-site-nav {
    display: none;
  }
}

.distill-site-header {

}

.distill-site-footer {

}


/* Site Header */

.distill-site-header {
  width: 100%;
  box-sizing: border-box;
  z-index: 3;
}

.distill-site-header .nav-left {
  display: inline-block;
  margin-left: 8px;
}

@media screen and (max-width: 768px) {
  .distill-site-header .nav-left {
    margin-left: 0;
  }
}


.distill-site-header .nav-right {
  float: right;
  margin-right: 8px;
}

.distill-site-header a,
.distill-site-header .title {
  display: inline-block;
  text-align: center;
  padding: 14px 10px 14px 10px;
}

.distill-site-header .title {
  font-size: 18px;
  min-width: 150px;
}

.distill-site-header .logo {
  padding: 0;
}

.distill-site-header .logo img {
  display: none;
  max-height: 20px;
  width: auto;
  margin-bottom: -4px;
}

.distill-site-header .nav-image img {
  max-height: 18px;
  width: auto;
  display: inline-block;
  margin-bottom: -3px;
}



@media screen and (min-width: 1000px) {
  .distill-site-header .logo img {
    display: inline-block;
  }
  .distill-site-header .nav-left {
    margin-left: 20px;
  }
  .distill-site-header .nav-right {
    margin-right: 20px;
  }
  .distill-site-header .title {
    padding-left: 12px;
  }
}


.distill-site-header .nav-toggle {
  display: none;
}

.nav-dropdown {
  display: inline-block;
  position: relative;
}

.nav-dropdown .nav-dropbtn {
  border: none;
  outline: none;
  color: rgba(255, 255, 255, 0.8);
  padding: 16px 10px;
  background-color: transparent;
  font-family: inherit;
  font-size: inherit;
  font-weight: inherit;
  margin: 0;
  margin-top: 1px;
  z-index: 2;
}

.nav-dropdown-content {
  display: none;
  position: absolute;
  background-color: white;
  min-width: 200px;
  border: 1px solid rgba(0,0,0,0.15);
  border-radius: 4px;
  box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.1);
  z-index: 1;
  margin-top: 2px;
  white-space: nowrap;
  padding-top: 4px;
  padding-bottom: 4px;
}

.nav-dropdown-content hr {
  margin-top: 4px;
  margin-bottom: 4px;
  border: none;
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

.nav-dropdown-active {
  display: block;
}

.nav-dropdown-content a, .nav-dropdown-content .nav-dropdown-header {
  color: black;
  padding: 6px 24px;
  text-decoration: none;
  display: block;
  text-align: left;
}

.nav-dropdown-content .nav-dropdown-header {
  display: block;
  padding: 5px 24px;
  padding-bottom: 0;
  text-transform: uppercase;
  font-size: 14px;
  color: #999999;
  white-space: nowrap;
}

.nav-dropdown:hover .nav-dropbtn {
  color: white;
}

.nav-dropdown-content a:hover {
  background-color: #ddd;
  color: black;
}

.nav-right .nav-dropdown-content {
  margin-left: -45%;
  right: 0;
}

@media screen and (max-width: 768px) {
  .distill-site-header a, .distill-site-header .nav-dropdown  {display: none;}
  .distill-site-header a.nav-toggle {
    float: right;
    display: block;
  }
  .distill-site-header .title {
    margin-left: 0;
  }
  .distill-site-header .nav-right {
    margin-right: 0;
  }
  .distill-site-header {
    overflow: hidden;
  }
  .nav-right .nav-dropdown-content {
    margin-left: 0;
  }
}


@media screen and (max-width: 768px) {
  .distill-site-header.responsive {position: relative; min-height: 500px; }
  .distill-site-header.responsive a.nav-toggle {
    position: absolute;
    right: 0;
    top: 0;
  }
  .distill-site-header.responsive a,
  .distill-site-header.responsive .nav-dropdown {
    display: block;
    text-align: left;
  }
  .distill-site-header.responsive .nav-left,
  .distill-site-header.responsive .nav-right {
    width: 100%;
  }
  .distill-site-header.responsive .nav-dropdown {float: none;}
  .distill-site-header.responsive .nav-dropdown-content {position: relative;}
  .distill-site-header.responsive .nav-dropdown .nav-dropbtn {
    display: block;
    width: 100%;
    text-align: left;
  }
}

/* Site Footer */

.distill-site-footer {
  width: 100%;
  overflow: hidden;
  box-sizing: border-box;
  z-index: 3;
  margin-top: 30px;
  padding-top: 30px;
  padding-bottom: 30px;
  text-align: center;
}

/* Headroom */

d-title {
  padding-top: 6rem;
}

@media print {
  d-title {
    padding-top: 4rem;
  }
}

.headroom {
  z-index: 1000;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
}

.headroom--transition {
  transition: all .4s ease-in-out;
}

.headroom--unpinned {
  top: -100px;
}

.headroom--pinned {
  top: 0;
}

/* adjust viewport for navbar height */
/* helps vertically center bootstrap (non-distill) content */
.min-vh-100 {
  min-height: calc(100vh - 100px) !important;
}

</style>

<script src="../../site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<link href="../../site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet"/>
<link href="../../site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet"/>
<script src="../../site_libs/headroom-0.9.4/headroom.min.js"></script>
<script src="../../site_libs/autocomplete-0.37.1/autocomplete.min.js"></script>
<script src="../../site_libs/fuse-6.4.1/fuse.min.js"></script>

<script type="application/javascript">

function getMeta(metaName) {
  var metas = document.getElementsByTagName('meta');
  for (let i = 0; i < metas.length; i++) {
    if (metas[i].getAttribute('name') === metaName) {
      return metas[i].getAttribute('content');
    }
  }
  return '';
}

function offsetURL(url) {
  var offset = getMeta('distill:offset');
  return offset ? offset + '/' + url : url;
}

function createFuseIndex() {

  // create fuse index
  var options = {
    keys: [
      { name: 'title', weight: 20 },
      { name: 'categories', weight: 15 },
      { name: 'description', weight: 10 },
      { name: 'contents', weight: 5 },
    ],
    ignoreLocation: true,
    threshold: 0
  };
  var fuse = new window.Fuse([], options);

  // fetch the main search.json
  return fetch(offsetURL('search.json'))
    .then(function(response) {
      if (response.status == 200) {
        return response.json().then(function(json) {
          // index main articles
          json.articles.forEach(function(article) {
            fuse.add(article);
          });
          // download collections and index their articles
          return Promise.all(json.collections.map(function(collection) {
            return fetch(offsetURL(collection)).then(function(response) {
              if (response.status === 200) {
                return response.json().then(function(articles) {
                  articles.forEach(function(article) {
                    fuse.add(article);
                  });
                })
              } else {
                return Promise.reject(
                  new Error('Unexpected status from search index request: ' +
                            response.status)
                );
              }
            });
          })).then(function() {
            return fuse;
          });
        });

      } else {
        return Promise.reject(
          new Error('Unexpected status from search index request: ' +
                      response.status)
        );
      }
    });
}

window.document.addEventListener("DOMContentLoaded", function (event) {

  // get search element (bail if we don't have one)
  var searchEl = window.document.getElementById('distill-search');
  if (!searchEl)
    return;

  createFuseIndex()
    .then(function(fuse) {

      // make search box visible
      searchEl.classList.remove('hidden');

      // initialize autocomplete
      var options = {
        autoselect: true,
        hint: false,
        minLength: 2,
      };
      window.autocomplete(searchEl, options, [{
        source: function(query, callback) {
          const searchOptions = {
            isCaseSensitive: false,
            shouldSort: true,
            minMatchCharLength: 2,
            limit: 10,
          };
          var results = fuse.search(query, searchOptions);
          callback(results
            .map(function(result) { return result.item; })
          );
        },
        templates: {
          suggestion: function(suggestion) {
            var img = suggestion.preview && Object.keys(suggestion.preview).length > 0
              ? `<img src="${offsetURL(suggestion.preview)}"</img>`
              : '';
            var html = `
              <div class="search-item">
                <h3>${suggestion.title}</h3>
                <div class="search-item-description">
                  ${suggestion.description || ''}
                </div>
                <div class="search-item-preview">
                  ${img}
                </div>
              </div>
            `;
            return html;
          }
        }
      }]).on('autocomplete:selected', function(event, suggestion) {
        window.location.href = offsetURL(suggestion.path);
      });
      // remove inline display style on autocompleter (we want to
      // manage responsive display via css)
      $('.algolia-autocomplete').css("display", "");
    })
    .catch(function(error) {
      console.log(error);
    });

});

</script>

<style type="text/css">

.nav-search {
  font-size: x-small;
}

/* Algolioa Autocomplete */

.algolia-autocomplete {
  display: inline-block;
  margin-left: 10px;
  vertical-align: sub;
  background-color: white;
  color: black;
  padding: 6px;
  padding-top: 8px;
  padding-bottom: 0;
  border-radius: 6px;
  border: 1px #0F2E3D solid;
  width: 180px;
}


@media screen and (max-width: 768px) {
  .distill-site-nav .algolia-autocomplete {
    display: none;
    visibility: hidden;
  }
  .distill-site-nav.responsive .algolia-autocomplete {
    display: inline-block;
    visibility: visible;
  }
  .distill-site-nav.responsive .algolia-autocomplete .aa-dropdown-menu {
    margin-left: 0;
    width: 400px;
    max-height: 400px;
  }
}

.algolia-autocomplete .aa-input, .algolia-autocomplete .aa-hint {
  width: 90%;
  outline: none;
  border: none;
}

.algolia-autocomplete .aa-hint {
  color: #999;
}
.algolia-autocomplete .aa-dropdown-menu {
  width: 550px;
  max-height: 70vh;
  overflow-x: visible;
  overflow-y: scroll;
  padding: 5px;
  margin-top: 3px;
  margin-left: -150px;
  background-color: #fff;
  border-radius: 5px;
  border: 1px solid #999;
  border-top: none;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion {
  cursor: pointer;
  padding: 5px 4px;
  border-bottom: 1px solid #eee;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion:last-of-type {
  border-bottom: none;
  margin-bottom: 2px;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item {
  overflow: hidden;
  font-size: 0.8em;
  line-height: 1.4em;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item h3 {
  font-size: 1rem;
  margin-block-start: 0;
  margin-block-end: 5px;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-description {
  display: inline-block;
  overflow: hidden;
  height: 2.8em;
  width: 80%;
  margin-right: 4%;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-preview {
  display: inline-block;
  width: 15%;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-preview img {
  height: 3em;
  width: auto;
  display: none;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-preview img[src] {
  display: initial;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion.aa-cursor {
  background-color: #eee;
}
.algolia-autocomplete .aa-dropdown-menu .aa-suggestion em {
  font-weight: bold;
  font-style: normal;
}

</style>


<!--/radix_placeholder_navigation_in_header-->
  <!--radix_placeholder_distill-->

<style type="text/css">

body {
  background-color: white;
}

.pandoc-table {
  width: 100%;
}

.pandoc-table>caption {
  margin-bottom: 10px;
}

.pandoc-table th:not([align]) {
  text-align: left;
}

.pagedtable-footer {
  font-size: 15px;
}

d-byline .byline {
  grid-template-columns: 2fr 2fr;
}

d-byline .byline h3 {
  margin-block-start: 1.5em;
}

d-byline .byline .authors-affiliations h3 {
  margin-block-start: 0.5em;
}

.authors-affiliations .orcid-id {
  width: 16px;
  height:16px;
  margin-left: 4px;
  margin-right: 4px;
  vertical-align: middle;
  padding-bottom: 2px;
}

d-title .dt-tags {
  margin-top: 1em;
  grid-column: text;
}

.dt-tags .dt-tag {
  text-decoration: none;
  display: inline-block;
  color: rgba(0,0,0,0.6);
  padding: 0em 0.4em;
  margin-right: 0.5em;
  margin-bottom: 0.4em;
  font-size: 70%;
  border: 1px solid rgba(0,0,0,0.2);
  border-radius: 3px;
  text-transform: uppercase;
  font-weight: 500;
}

d-article table.gt_table td,
d-article table.gt_table th {
  border-bottom: none;
}

.html-widget {
  margin-bottom: 2.0em;
}

.l-screen-inset {
  padding-right: 16px;
}

.l-screen .caption {
  margin-left: 10px;
}

.shaded {
  background: rgb(247, 247, 247);
  padding-top: 20px;
  padding-bottom: 20px;
  border-top: 1px solid rgba(0, 0, 0, 0.1);
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

.shaded .html-widget {
  margin-bottom: 0;
  border: 1px solid rgba(0, 0, 0, 0.1);
}

.shaded .shaded-content {
  background: white;
}

.text-output {
  margin-top: 0;
  line-height: 1.5em;
}

.hidden {
  display: none !important;
}

d-article {
  padding-top: 2.5rem;
  padding-bottom: 30px;
}

d-appendix {
  padding-top: 30px;
}

d-article>p>img {
  width: 100%;
}

d-article h2 {
  margin: 1rem 0 1.5rem 0;
}

d-article h3 {
  margin-top: 1.5rem;
}

d-article iframe {
  border: 1px solid rgba(0, 0, 0, 0.1);
  margin-bottom: 2.0em;
  width: 100%;
}

/* Tweak code blocks */

d-article div.sourceCode code,
d-article pre code {
  font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
}

d-article pre,
d-article div.sourceCode,
d-article div.sourceCode pre {
  overflow: auto;
}

d-article div.sourceCode {
  background-color: white;
}

d-article div.sourceCode pre {
  padding-left: 10px;
  font-size: 12px;
  border-left: 2px solid rgba(0,0,0,0.1);
}

d-article pre {
  font-size: 12px;
  color: black;
  background: none;
  margin-top: 0;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.5;

  -moz-tab-size: 4;
  -o-tab-size: 4;
  tab-size: 4;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

d-article pre a {
  border-bottom: none;
}

d-article pre a:hover {
  border-bottom: none;
  text-decoration: underline;
}

d-article details {
  grid-column: text;
  margin-bottom: 0.8em;
}

@media(min-width: 768px) {

d-article pre,
d-article div.sourceCode,
d-article div.sourceCode pre {
  overflow: visible !important;
}

d-article div.sourceCode pre {
  padding-left: 18px;
  font-size: 14px;
}

d-article pre {
  font-size: 14px;
}

}

figure img.external {
  background: white;
  border: 1px solid rgba(0, 0, 0, 0.1);
  box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
  padding: 18px;
  box-sizing: border-box;
}

/* CSS for d-contents */

.d-contents {
  grid-column: text;
  color: rgba(0,0,0,0.8);
  font-size: 0.9em;
  padding-bottom: 1em;
  margin-bottom: 1em;
  padding-bottom: 0.5em;
  margin-bottom: 1em;
  padding-left: 0.25em;
  justify-self: start;
}

@media(min-width: 1000px) {
  .d-contents.d-contents-float {
    height: 0;
    grid-column-start: 1;
    grid-column-end: 4;
    justify-self: center;
    padding-right: 3em;
    padding-left: 2em;
  }
}

.d-contents nav h3 {
  font-size: 18px;
  margin-top: 0;
  margin-bottom: 1em;
}

.d-contents li {
  list-style-type: none
}

.d-contents nav > ul {
  padding-left: 0;
}

.d-contents ul {
  padding-left: 1em
}

.d-contents nav ul li {
  margin-top: 0.6em;
  margin-bottom: 0.2em;
}

.d-contents nav a {
  font-size: 13px;
  border-bottom: none;
  text-decoration: none
  color: rgba(0, 0, 0, 0.8);
}

.d-contents nav a:hover {
  text-decoration: underline solid rgba(0, 0, 0, 0.6)
}

.d-contents nav > ul > li > a {
  font-weight: 600;
}

.d-contents nav > ul > li > ul {
  font-weight: inherit;
}

.d-contents nav > ul > li > ul > li {
  margin-top: 0.2em;
}


.d-contents nav ul {
  margin-top: 0;
  margin-bottom: 0.25em;
}

.d-article-with-toc h2:nth-child(2) {
  margin-top: 0;
}


/* Figure */

.figure {
  position: relative;
  margin-bottom: 2.5em;
  margin-top: 1.5em;
}

.figure .caption {
  color: rgba(0, 0, 0, 0.6);
  font-size: 12px;
  line-height: 1.5em;
}

.figure img.external {
  background: white;
  border: 1px solid rgba(0, 0, 0, 0.1);
  box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
  padding: 18px;
  box-sizing: border-box;
}

.figure .caption a {
  color: rgba(0, 0, 0, 0.6);
}

.figure .caption b,
.figure .caption strong, {
  font-weight: 600;
  color: rgba(0, 0, 0, 1.0);
}

/* Citations */

d-article .citation {
  color: inherit;
  cursor: inherit;
}

div.hanging-indent{
  margin-left: 1em; text-indent: -1em;
}

/* Citation hover box */

.tippy-box[data-theme~=light-border] {
  background-color: rgba(250, 250, 250, 0.95);
}

.tippy-content > p {
  margin-bottom: 0;
  padding: 2px;
}


/* Tweak 1000px media break to show more text */

@media(min-width: 1000px) {
  .base-grid,
  distill-header,
  d-title,
  d-abstract,
  d-article,
  d-appendix,
  distill-appendix,
  d-byline,
  d-footnote-list,
  d-citation-list,
  distill-footer {
    grid-template-columns: [screen-start] 1fr [page-start kicker-start] 80px [middle-start] 50px [text-start kicker-end] 65px 65px 65px 65px 65px 65px 65px 65px [text-end gutter-start] 65px [middle-end] 65px [page-end gutter-end] 1fr [screen-end];
    grid-column-gap: 16px;
  }

  .grid {
    grid-column-gap: 16px;
  }

  d-article {
    font-size: 1.06rem;
    line-height: 1.7em;
  }
  figure .caption, .figure .caption, figure figcaption {
    font-size: 13px;
  }
}

@media(min-width: 1180px) {
  .base-grid,
  distill-header,
  d-title,
  d-abstract,
  d-article,
  d-appendix,
  distill-appendix,
  d-byline,
  d-footnote-list,
  d-citation-list,
  distill-footer {
    grid-template-columns: [screen-start] 1fr [page-start kicker-start] 60px [middle-start] 60px [text-start kicker-end] 60px 60px 60px 60px 60px 60px 60px 60px [text-end gutter-start] 60px [middle-end] 60px [page-end gutter-end] 1fr [screen-end];
    grid-column-gap: 32px;
  }

  .grid {
    grid-column-gap: 32px;
  }
}


/* Get the citation styles for the appendix (not auto-injected on render since
   we do our own rendering of the citation appendix) */

d-appendix .citation-appendix,
.d-appendix .citation-appendix {
  font-size: 11px;
  line-height: 15px;
  border-left: 1px solid rgba(0, 0, 0, 0.1);
  padding-left: 18px;
  border: 1px solid rgba(0,0,0,0.1);
  background: rgba(0, 0, 0, 0.02);
  padding: 10px 18px;
  border-radius: 3px;
  color: rgba(150, 150, 150, 1);
  overflow: hidden;
  margin-top: -12px;
  white-space: pre-wrap;
  word-wrap: break-word;
}

/* Include appendix styles here so they can be overridden */

d-appendix {
  contain: layout style;
  font-size: 0.8em;
  line-height: 1.7em;
  margin-top: 60px;
  margin-bottom: 0;
  border-top: 1px solid rgba(0, 0, 0, 0.1);
  color: rgba(0,0,0,0.5);
  padding-top: 60px;
  padding-bottom: 48px;
}

d-appendix h3 {
  grid-column: page-start / text-start;
  font-size: 15px;
  font-weight: 500;
  margin-top: 1em;
  margin-bottom: 0;
  color: rgba(0,0,0,0.65);
}

d-appendix h3 + * {
  margin-top: 1em;
}

d-appendix ol {
  padding: 0 0 0 15px;
}

@media (min-width: 768px) {
  d-appendix ol {
    padding: 0 0 0 30px;
    margin-left: -30px;
  }
}

d-appendix li {
  margin-bottom: 1em;
}

d-appendix a {
  color: rgba(0, 0, 0, 0.6);
}

d-appendix > * {
  grid-column: text;
}

d-appendix > d-footnote-list,
d-appendix > d-citation-list,
d-appendix > distill-appendix {
  grid-column: screen;
}

/* Include footnote styles here so they can be overridden */

d-footnote-list {
  contain: layout style;
}

d-footnote-list > * {
  grid-column: text;
}

d-footnote-list a.footnote-backlink {
  color: rgba(0,0,0,0.3);
  padding-left: 0.5em;
}



/* Anchor.js */

.anchorjs-link {
  /*transition: all .25s linear; */
  text-decoration: none;
  border-bottom: none;
}
*:hover > .anchorjs-link {
  margin-left: -1.125em !important;
  text-decoration: none;
  border-bottom: none;
}

/* Social footer */

.social_footer {
  margin-top: 30px;
  margin-bottom: 0;
  color: rgba(0,0,0,0.67);
}

.disqus-comments {
  margin-right: 30px;
}

.disqus-comment-count {
  border-bottom: 1px solid rgba(0, 0, 0, 0.4);
  cursor: pointer;
}

#disqus_thread {
  margin-top: 30px;
}

.article-sharing a {
  border-bottom: none;
  margin-right: 8px;
}

.article-sharing a:hover {
  border-bottom: none;
}

.sidebar-section.subscribe {
  font-size: 12px;
  line-height: 1.6em;
}

.subscribe p {
  margin-bottom: 0.5em;
}


.article-footer .subscribe {
  font-size: 15px;
  margin-top: 45px;
}


.sidebar-section.custom {
  font-size: 12px;
  line-height: 1.6em;
}

.custom p {
  margin-bottom: 0.5em;
}

/* Styles for listing layout (hide title) */
.layout-listing d-title, .layout-listing .d-title {
  display: none;
}

/* Styles for posts lists (not auto-injected) */


.posts-with-sidebar {
  padding-left: 45px;
  padding-right: 45px;
}

.posts-list .description h2,
.posts-list .description p {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
}

.posts-list .description h2 {
  font-weight: 700;
  border-bottom: none;
  padding-bottom: 0;
}

.posts-list h2.post-tag {
  border-bottom: 1px solid rgba(0, 0, 0, 0.2);
  padding-bottom: 12px;
}
.posts-list {
  margin-top: 60px;
  margin-bottom: 24px;
}

.posts-list .post-preview {
  text-decoration: none;
  overflow: hidden;
  display: block;
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  padding: 24px 0;
}

.post-preview-last {
  border-bottom: none !important;
}

.posts-list .posts-list-caption {
  grid-column: screen;
  font-weight: 400;
}

.posts-list .post-preview h2 {
  margin: 0 0 6px 0;
  line-height: 1.2em;
  font-style: normal;
  font-size: 24px;
}

.posts-list .post-preview p {
  margin: 0 0 12px 0;
  line-height: 1.4em;
  font-size: 16px;
}

.posts-list .post-preview .thumbnail {
  box-sizing: border-box;
  margin-bottom: 24px;
  position: relative;
  max-width: 500px;
}
.posts-list .post-preview img {
  width: 100%;
  display: block;
}

.posts-list .metadata {
  font-size: 12px;
  line-height: 1.4em;
  margin-bottom: 18px;
}

.posts-list .metadata > * {
  display: inline-block;
}

.posts-list .metadata .publishedDate {
  margin-right: 2em;
}

.posts-list .metadata .dt-authors {
  display: block;
  margin-top: 0.3em;
  margin-right: 2em;
}

.posts-list .dt-tags {
  display: block;
  line-height: 1em;
}

.posts-list .dt-tags .dt-tag {
  display: inline-block;
  color: rgba(0,0,0,0.6);
  padding: 0.3em 0.4em;
  margin-right: 0.2em;
  margin-bottom: 0.4em;
  font-size: 60%;
  border: 1px solid rgba(0,0,0,0.2);
  border-radius: 3px;
  text-transform: uppercase;
  font-weight: 500;
}

.posts-list img {
  opacity: 1;
}

.posts-list img[data-src] {
  opacity: 0;
}

.posts-more {
  clear: both;
}


.posts-sidebar {
  font-size: 16px;
}

.posts-sidebar h3 {
  font-size: 16px;
  margin-top: 0;
  margin-bottom: 0.5em;
  font-weight: 400;
  text-transform: uppercase;
}

.sidebar-section {
  margin-bottom: 30px;
}

.categories ul {
  list-style-type: none;
  margin: 0;
  padding: 0;
}

.categories li {
  color: rgba(0, 0, 0, 0.8);
  margin-bottom: 0;
}

.categories li>a {
  border-bottom: none;
}

.categories li>a:hover {
  border-bottom: 1px solid rgba(0, 0, 0, 0.4);
}

.categories .active {
  font-weight: 600;
}

.categories .category-count {
  color: rgba(0, 0, 0, 0.4);
}


@media(min-width: 768px) {
  .posts-list .post-preview h2 {
    font-size: 26px;
  }
  .posts-list .post-preview .thumbnail {
    float: right;
    width: 30%;
    margin-bottom: 0;
  }
  .posts-list .post-preview .description {
    float: left;
    width: 45%;
  }
  .posts-list .post-preview .metadata {
    float: left;
    width: 20%;
    margin-top: 8px;
  }
  .posts-list .post-preview p {
    margin: 0 0 12px 0;
    line-height: 1.5em;
    font-size: 16px;
  }
  .posts-with-sidebar .posts-list {
    float: left;
    width: 75%;
  }
  .posts-with-sidebar .posts-sidebar {
    float: right;
    width: 20%;
    margin-top: 60px;
    padding-top: 24px;
    padding-bottom: 24px;
  }
}


/* Improve display for browsers without grid (IE/Edge <= 15) */

.downlevel {
  line-height: 1.6em;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
  margin: 0;
}

.downlevel .d-title {
  padding-top: 6rem;
  padding-bottom: 1.5rem;
}

.downlevel .d-title h1 {
  font-size: 50px;
  font-weight: 700;
  line-height: 1.1em;
  margin: 0 0 0.5rem;
}

.downlevel .d-title p {
  font-weight: 300;
  font-size: 1.2rem;
  line-height: 1.55em;
  margin-top: 0;
}

.downlevel .d-byline {
  padding-top: 0.8em;
  padding-bottom: 0.8em;
  font-size: 0.8rem;
  line-height: 1.8em;
}

.downlevel .section-separator {
  border: none;
  border-top: 1px solid rgba(0, 0, 0, 0.1);
}

.downlevel .d-article {
  font-size: 1.06rem;
  line-height: 1.7em;
  padding-top: 1rem;
  padding-bottom: 2rem;
}


.downlevel .d-appendix {
  padding-left: 0;
  padding-right: 0;
  max-width: none;
  font-size: 0.8em;
  line-height: 1.7em;
  margin-bottom: 0;
  color: rgba(0,0,0,0.5);
  padding-top: 40px;
  padding-bottom: 48px;
}

.downlevel .footnotes ol {
  padding-left: 13px;
}

.downlevel .base-grid,
.downlevel .distill-header,
.downlevel .d-title,
.downlevel .d-abstract,
.downlevel .d-article,
.downlevel .d-appendix,
.downlevel .distill-appendix,
.downlevel .d-byline,
.downlevel .d-footnote-list,
.downlevel .d-citation-list,
.downlevel .distill-footer,
.downlevel .appendix-bottom,
.downlevel .posts-container {
  padding-left: 40px;
  padding-right: 40px;
}

@media(min-width: 768px) {
  .downlevel .base-grid,
  .downlevel .distill-header,
  .downlevel .d-title,
  .downlevel .d-abstract,
  .downlevel .d-article,
  .downlevel .d-appendix,
  .downlevel .distill-appendix,
  .downlevel .d-byline,
  .downlevel .d-footnote-list,
  .downlevel .d-citation-list,
  .downlevel .distill-footer,
  .downlevel .appendix-bottom,
  .downlevel .posts-container {
  padding-left: 150px;
  padding-right: 150px;
  max-width: 900px;
}
}

.downlevel pre code {
  display: block;
  border-left: 2px solid rgba(0, 0, 0, .1);
  padding: 0 0 0 20px;
  font-size: 14px;
}

.downlevel code, .downlevel pre {
  color: black;
  background: none;
  font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.5;

  -moz-tab-size: 4;
  -o-tab-size: 4;
  tab-size: 4;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

.downlevel .posts-list .post-preview {
  color: inherit;
}



</style>

<script type="application/javascript">

function is_downlevel_browser() {
  if (bowser.isUnsupportedBrowser({ msie: "12", msedge: "16"},
                                 window.navigator.userAgent)) {
    return true;
  } else {
    return window.load_distill_framework === undefined;
  }
}

// show body when load is complete
function on_load_complete() {

  // add anchors
  if (window.anchors) {
    window.anchors.options.placement = 'left';
    window.anchors.add('d-article > h2, d-article > h3, d-article > h4, d-article > h5');
  }


  // set body to visible
  document.body.style.visibility = 'visible';

  // force redraw for leaflet widgets
  if (window.HTMLWidgets) {
    var maps = window.HTMLWidgets.findAll(".leaflet");
    $.each(maps, function(i, el) {
      var map = this.getMap();
      map.invalidateSize();
      map.eachLayer(function(layer) {
        if (layer instanceof L.TileLayer)
          layer.redraw();
      });
    });
  }

  // trigger 'shown' so htmlwidgets resize
  $('d-article').trigger('shown');
}

function init_distill() {

  init_common();

  // create front matter
  var front_matter = $('<d-front-matter></d-front-matter>');
  $('#distill-front-matter').wrap(front_matter);

  // create d-title
  $('.d-title').changeElementType('d-title');

  // create d-byline
  var byline = $('<d-byline></d-byline>');
  $('.d-byline').replaceWith(byline);

  // create d-article
  var article = $('<d-article></d-article>');
  $('.d-article').wrap(article).children().unwrap();

  // move posts container into article
  $('.posts-container').appendTo($('d-article'));

  // create d-appendix
  $('.d-appendix').changeElementType('d-appendix');

  // flag indicating that we have appendix items
  var appendix = $('.appendix-bottom').children('h3').length > 0;

  // replace footnotes with <d-footnote>
  $('.footnote-ref').each(function(i, val) {
    appendix = true;
    var href = $(this).attr('href');
    var id = href.replace('#', '');
    var fn = $('#' + id);
    var fn_p = $('#' + id + '>p');
    fn_p.find('.footnote-back').remove();
    var text = fn_p.html();
    var dtfn = $('<d-footnote></d-footnote>');
    dtfn.html(text);
    $(this).replaceWith(dtfn);
  });
  // remove footnotes
  $('.footnotes').remove();

  // move refs into #references-listing
  $('#references-listing').replaceWith($('#refs'));

  $('h1.appendix, h2.appendix').each(function(i, val) {
    $(this).changeElementType('h3');
  });
  $('h3.appendix').each(function(i, val) {
    var id = $(this).attr('id');
    $('.d-contents a[href="#' + id + '"]').parent().remove();
    appendix = true;
    $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('d-appendix'));
  });

  // show d-appendix if we have appendix content
  $("d-appendix").css('display', appendix ? 'grid' : 'none');

  // localize layout chunks to just output
  $('.layout-chunk').each(function(i, val) {

    // capture layout
    var layout = $(this).attr('data-layout');

    // apply layout to markdown level block elements
    var elements = $(this).children().not('details, div.sourceCode, pre, script');
    elements.each(function(i, el) {
      var layout_div = $('<div class="' + layout + '"></div>');
      if (layout_div.hasClass('shaded')) {
        var shaded_content = $('<div class="shaded-content"></div>');
        $(this).wrap(shaded_content);
        $(this).parent().wrap(layout_div);
      } else {
        $(this).wrap(layout_div);
      }
    });


    // unwrap the layout-chunk div
    $(this).children().unwrap();
  });

  // remove code block used to force  highlighting css
  $('.distill-force-highlighting-css').parent().remove();

  // remove empty line numbers inserted by pandoc when using a
  // custom syntax highlighting theme
  $('code.sourceCode a:empty').remove();

  // load distill framework
  load_distill_framework();

  // wait for window.distillRunlevel == 4 to do post processing
  function distill_post_process() {

    if (!window.distillRunlevel || window.distillRunlevel < 4)
      return;

    // hide author/affiliations entirely if we have no authors
    var front_matter = JSON.parse($("#distill-front-matter").html());
    var have_authors = front_matter.authors && front_matter.authors.length > 0;
    if (!have_authors)
      $('d-byline').addClass('hidden');

    // article with toc class
    $('.d-contents').parent().addClass('d-article-with-toc');

    // strip links that point to #
    $('.authors-affiliations').find('a[href="#"]').removeAttr('href');

    // add orcid ids
    $('.authors-affiliations').find('.author').each(function(i, el) {
      var orcid_id = front_matter.authors[i].orcidID;
      if (orcid_id) {
        var a = $('<a></a>');
        a.attr('href', 'https://orcid.org/' + orcid_id);
        var img = $('<img></img>');
        img.addClass('orcid-id');
        img.attr('alt', 'ORCID ID');
        img.attr('src','data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg==');
        a.append(img);
        $(this).append(a);
      }
    });

    // hide elements of author/affiliations grid that have no value
    function hide_byline_column(caption) {
      $('d-byline').find('h3:contains("' + caption + '")').parent().css('visibility', 'hidden');
    }

    // affiliations
    var have_affiliations = false;
    for (var i = 0; i<front_matter.authors.length; ++i) {
      var author = front_matter.authors[i];
      if (author.affiliation !== "&nbsp;") {
        have_affiliations = true;
        break;
      }
    }
    if (!have_affiliations)
      $('d-byline').find('h3:contains("Affiliations")').css('visibility', 'hidden');

    // published date
    if (!front_matter.publishedDate)
      hide_byline_column("Published");

    // document object identifier
    var doi = $('d-byline').find('h3:contains("DOI")');
    var doi_p = doi.next().empty();
    if (!front_matter.doi) {
      // if we have a citation and valid citationText then link to that
      if ($('#citation').length > 0 && front_matter.citationText) {
        doi.html('Citation');
        $('<a href="#citation"></a>')
          .text(front_matter.citationText)
          .appendTo(doi_p);
      } else {
        hide_byline_column("DOI");
      }
    } else {
      $('<a></a>')
         .attr('href', "https://doi.org/" + front_matter.doi)
         .html(front_matter.doi)
         .appendTo(doi_p);
    }

     // change plural form of authors/affiliations
    if (front_matter.authors.length === 1) {
      var grid = $('.authors-affiliations');
      grid.children('h3:contains("Authors")').text('Author');
      grid.children('h3:contains("Affiliations")').text('Affiliation');
    }

    // remove d-appendix and d-footnote-list local styles
    $('d-appendix > style:first-child').remove();
    $('d-footnote-list > style:first-child').remove();

    // move appendix-bottom entries to the bottom
    $('.appendix-bottom').appendTo('d-appendix').children().unwrap();
    $('.appendix-bottom').remove();

    // hoverable references
    $('span.citation[data-cites]').each(function() {
      if ($(this).children()[0].nodeName == "D-FOOTNOTE") {
        var fn = $(this).children()[0]
        $(this).html(fn.shadowRoot.querySelector("sup"))
        $(this).id = fn.id
        fn.remove()
      }
      var refs = $(this).attr('data-cites').split(" ");
      var refHtml = refs.map(function(ref) {
        return "<p>" + $('#ref-' + ref).html() + "</p>";
      }).join("\n");
      window.tippy(this, {
        allowHTML: true,
        content: refHtml,
        maxWidth: 500,
        interactive: true,
        interactiveBorder: 10,
        theme: 'light-border',
        placement: 'bottom-start'
      });
    });

    // fix footnotes in tables (#411)
    // replacing broken distill.pub feature
    $('table d-footnote').each(function() {
      // we replace internal showAtNode methode which is triggered when hovering a footnote
      this.hoverBox.showAtNode = function(node) {
        // ported from https://github.com/distillpub/template/pull/105/files
        calcOffset = function(elem) {
            let x = elem.offsetLeft;
            let y = elem.offsetTop;
            // Traverse upwards until an `absolute` element is found or `elem`
            // becomes null.
            while (elem = elem.offsetParent && elem.style.position != 'absolute') {
                x += elem.offsetLeft;
                y += elem.offsetTop;
            }

            return { left: x, top: y };
        }
        // https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement/offsetTop
        const bbox = node.getBoundingClientRect();
        const offset = calcOffset(node);
        this.show([offset.left + bbox.width, offset.top + bbox.height]);
      }
    })

    // clear polling timer
    clearInterval(tid);

    // show body now that everything is ready
    on_load_complete();
  }

  var tid = setInterval(distill_post_process, 50);
  distill_post_process();

}

function init_downlevel() {

  init_common();

   // insert hr after d-title
  $('.d-title').after($('<hr class="section-separator"/>'));

  // check if we have authors
  var front_matter = JSON.parse($("#distill-front-matter").html());
  var have_authors = front_matter.authors && front_matter.authors.length > 0;

  // manage byline/border
  if (!have_authors)
    $('.d-byline').remove();
  $('.d-byline').after($('<hr class="section-separator"/>'));
  $('.d-byline a').remove();

  // remove toc
  $('.d-contents').remove();

  // move appendix elements
  $('h1.appendix, h2.appendix').each(function(i, val) {
    $(this).changeElementType('h3');
  });
  $('h3.appendix').each(function(i, val) {
    $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('.d-appendix'));
  });


  // inject headers into references and footnotes
  var refs_header = $('<h3></h3>');
  refs_header.text('References');
  $('#refs').prepend(refs_header);

  var footnotes_header = $('<h3></h3');
  footnotes_header.text('Footnotes');
  $('.footnotes').children('hr').first().replaceWith(footnotes_header);

  // move appendix-bottom entries to the bottom
  $('.appendix-bottom').appendTo('.d-appendix').children().unwrap();
  $('.appendix-bottom').remove();

  // remove appendix if it's empty
  if ($('.d-appendix').children().length === 0)
    $('.d-appendix').remove();

  // prepend separator above appendix
  $('.d-appendix').before($('<hr class="section-separator" style="clear: both"/>'));

  // trim code
  $('pre>code').each(function(i, val) {
    $(this).html($.trim($(this).html()));
  });

  // move posts-container right before article
  $('.posts-container').insertBefore($('.d-article'));

  $('body').addClass('downlevel');

  on_load_complete();
}


function init_common() {

  // jquery plugin to change element types
  (function($) {
    $.fn.changeElementType = function(newType) {
      var attrs = {};

      $.each(this[0].attributes, function(idx, attr) {
        attrs[attr.nodeName] = attr.nodeValue;
      });

      this.replaceWith(function() {
        return $("<" + newType + "/>", attrs).append($(this).contents());
      });
    };
  })(jQuery);

  // prevent underline for linked images
  $('a > img').parent().css({'border-bottom' : 'none'});

  // mark non-body figures created by knitr chunks as 100% width
  $('.layout-chunk').each(function(i, val) {
    var figures = $(this).find('img, .html-widget');
    // ignore leaflet img layers (#106)
    figures = figures.filter(':not(img[class*="leaflet"])')
    if ($(this).attr('data-layout') !== "l-body") {
      figures.css('width', '100%');
    } else {
      figures.css('max-width', '100%');
      figures.filter("[width]").each(function(i, val) {
        var fig = $(this);
        fig.css('width', fig.attr('width') + 'px');
      });

    }
  });

  // auto-append index.html to post-preview links in file: protocol
  // and in rstudio ide preview
  $('.post-preview').each(function(i, val) {
    if (window.location.protocol === "file:")
      $(this).attr('href', $(this).attr('href') + "index.html");
  });

  // get rid of index.html references in header
  if (window.location.protocol !== "file:") {
    $('.distill-site-header a[href]').each(function(i,val) {
      $(this).attr('href', $(this).attr('href').replace(/^index[.]html/, "./"));
    });
  }

  // add class to pandoc style tables
  $('tr.header').parent('thead').parent('table').addClass('pandoc-table');
  $('.kable-table').children('table').addClass('pandoc-table');

  // add figcaption style to table captions
  $('caption').parent('table').addClass("figcaption");

  // initialize posts list
  if (window.init_posts_list)
    window.init_posts_list();

  // implmement disqus comment link
  $('.disqus-comment-count').click(function() {
    window.headroom_prevent_pin = true;
    $('#disqus_thread').toggleClass('hidden');
    if (!$('#disqus_thread').hasClass('hidden')) {
      var offset = $(this).offset();
      $(window).resize();
      $('html, body').animate({
        scrollTop: offset.top - 35
      });
    }
  });
}

document.addEventListener('DOMContentLoaded', function() {
  if (is_downlevel_browser())
    init_downlevel();
  else
    window.addEventListener('WebComponentsReady', init_distill);
});

</script>

<!--/radix_placeholder_distill-->
  <script src="../../site_libs/header-attrs-2.14/header-attrs.js"></script>
  <script src="../../site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
  <script src="../../site_libs/popper-2.6.0/popper.min.js"></script>
  <link href="../../site_libs/tippy-6.2.7/tippy.css" rel="stylesheet" />
  <link href="../../site_libs/tippy-6.2.7/tippy-light-border.css" rel="stylesheet" />
  <script src="../../site_libs/tippy-6.2.7/tippy.umd.min.js"></script>
  <script src="../../site_libs/anchor-4.2.2/anchor.min.js"></script>
  <script src="../../site_libs/bowser-1.9.3/bowser.min.js"></script>
  <script src="../../site_libs/webcomponents-2.0.0/webcomponents.js"></script>
  <script src="../../site_libs/distill-2.2.21/template.v2.js"></script>
  <!--radix_placeholder_site_in_header-->
<script type="text/javascript" cookie-consent="tracking" async src="https://www.googletagmanager.com/gtag/js?id=UA-79842648-2"></script>
<script type="text/javascript" cookie-consent="tracking">
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-79842648-2');
</script>
<style type="text/css">
.distill-site-nav {
  font-family: 'Karla', sans-serif;
  color: #000;
  background-color: #fff;
  font-size: 15px;
  font-weight: 400;
}

.distill-site-header {
  font-family: 'Karla', sans-serif;
  color: #000;
  background-color: #fff;
  font-size: 15px;
  font-weight: 400;
}

@import url('https://fonts.googleapis.com/css2?family=Lato');
@import url('https://fonts.googleapis.com/css2?family=Karla');
@import url('https://fonts.googleapis.com/css2?family=Fira+Code');

html,
body,
p {
  font-family: 'Karla', sans-serif;
  font-weight: 300;
  line-height: 1.3;
  font-size: 1em;
  color: #333333;
  font-style: normal;
}

code {
  font-family: 'Fira Code', sans-serif;
  /* color: #383838; */
  background: #ffffff;
  /* font-weight: 400; */
  font-size: 0.9em;
}

h1,
h2,
h3,
h4,
h5 {
  font-family: 'Karla', sans-serif;
}

.distill-site-nav a {
  font-family: 'Karla', sans-serif;
  font-weight: 500;
  font-size: 15px;
  color: #000;
  text-decoration: none;
}

.distill-site-nav a:hover {
  color: #A020F0;
}

.nav-dropdown-content a {
  font-family: 'Karla', sans-serif;
  font-weight: 500;
  color: #ffffff;
}

.distill-site-header {
  font-family: 'Karla', sans-serif;
  font-weight: 500;
  background-color: #ffffff;
}

.distill-site-footer {
  background-color: #000;
  color: #ffffff;
}

@media print {
  .distill-site-nav {
    display: none;
  }
}

details {
  background-color: hsla(60, 7%, 80%, 0.2);
  cursor: pointer;
  color: #2d2d2d;
  margin-bottom: 1vh;
  padding: 1em;
  border: none;
  text-align: left;
  outline: none;
}

.active,
details:hover {
  transition: max-height 0.2s ease-out;
  /* background-color: #acc2c2; */
}

details {
  display: flex;
  justify-content: space-between;
  align-content: center;
  border-radius: 4px;
}

details.active {
  border-bottom-left-radius: 0;
  border-bottom-right-radius: 0;
}

summary::-webkit-details-marker {
  display: none;
}

summary::after {
  float: right;
  font-family: 'Font Awesome 5 Free';
  content: '\f0fe';
}

details[open] summary::after {
  float: right;
  font-family: 'Font Awesome 5 Free';
  content: '\f146';
}

details h4 {
  margin: 0;
  color: #2d2d2d !important;
  line-height: inherit;
}

d-article pre {
  font-size: 12px;
  color: black;
  background: none;
  margin-top: 0;
  text-align: left;
  /* white-space: pre; */
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1;
  -moz-tab-size: 4;
  -o-tab-size: 4;
  tab-size: 4;
  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

</style>
<!--/radix_placeholder_site_in_header-->


</head>

<body>

<!--radix_placeholder_front_matter-->

<script id="distill-front-matter" type="text/json">
{"title":"What exactly is an \"expected point\"? (part 1)","description":"Calculating and comparing expected points from different expected goals sources","authors":[{"author":"Tony ElHabr","authorURL":"https://twitter.com/TonyElHabr","affiliation":"&nbsp;","affiliationURL":"#","orcidID":""}],"publishedDate":"2022-09-04T00:00:00.000-05:00","citationText":"ElHabr, 2022"}
</script>

<!--/radix_placeholder_front_matter-->
<!--radix_placeholder_navigation_before_body-->
<header class="header header--fixed" role="banner">
<nav class="distill-site-nav distill-site-header">
<div class="nav-left">
<a href="../../index.html" class="title">Tony</a>
<input id="distill-search" class="nav-search hidden" type="text" placeholder="Search..."/>
</div>
<div class="nav-right">
<a href="../../index.html">Home</a>
<a href="../../about.html">About</a>
<a href="../../projects.html">Projects</a>
<a href="javascript:void(0);" class="nav-toggle">&#9776;</a>
</div>
</nav>
</header>
<!--/radix_placeholder_navigation_before_body-->
<!--radix_placeholder_site_before_body-->
<!--/radix_placeholder_site_before_body-->

<div class="d-title">
<h1>What exactly is an “expected point”? (part 1)</h1>
<!--radix_placeholder_categories-->
<div class="dt-tags">
  <a href="../../posts.html#category:r" class="dt-tag">r</a>
  <a href="../../posts.html#category:soccer" class="dt-tag">soccer</a>
</div>
<!--/radix_placeholder_categories-->
<p>Calculating and comparing expected points from different expected
goals sources</p>
</div>

<div class="d-byline">
  Tony ElHabr <a href="https://twitter.com/TonyElHabr"
class="uri">https://twitter.com/TonyElHabr</a> 
  
<br/>2022-09-04
</div>

<div class="d-article">
<div class="d-contents d-contents-float">
<nav class="l-text toc figcaption" id="TOC">
<h3>Contents</h3>
<ul>
<li><a href="#introduction" id="toc-introduction">Introduction</a>
<ul>
<li><a href="#objectives" id="toc-objectives">Objectives</a></li>
</ul></li>
<li><a href="#analysis" id="toc-analysis">Analysis</a>
<ul>
<li><a href="#calculating-xpts-from-xg"
id="toc-calculating-xpts-from-xg">1. Calculating xPts from xG</a></li>
<li><a href="#match-predictive-performance6"
id="toc-match-predictive-performance6">2. Match predictive
performance</a>
<ul>
<li><a href="#predicting-match-outcomes-with-binary-logistic-regression"
id="toc-predicting-match-outcomes-with-binary-logistic-regression">Predicting
match outcomes with binary logistic regression</a></li>
<li><a href="#predicting-points-with-linear-regression"
id="toc-predicting-points-with-linear-regression">Predicting points with
linear regression</a></li>
<li><a
href="#predicting-match-outcomes-with-multinomial-logistic-regression"
id="toc-predicting-match-outcomes-with-multinomial-logistic-regression">Predicting
match outcomes with multinomial logistic regression</a></li>
</ul></li>
<li><a href="#season-predictive-performance"
id="toc-season-predictive-performance">3. Season predictive
performance</a></li>
</ul></li>
<li><a href="#conclusion" id="toc-conclusion">Conclusion</a></li>
</ul>
</nav>
</div>
<h2 id="introduction">Introduction</h2>
<p><a
href="https://theanalyst.com/na/2021/07/what-are-expected-goals-xg/">Expected
goals (xG)</a> in soccer have gone mainstream and are no longer cool to
talk about.</p>
<blockquote class="twitter-tweet">
<p lang="en" dir="ltr">
<p>What exactly is an ” expected goal “? Who decides the criteria ? Is
there a list of” expected goal scorers ” ? Or even ” unexpected ones ”
?</p>
</p>
<p>— Ian Darke (<span class="citation"
data-cites="IanDarke">@IanDarke</span>)
<a href="https://twitter.com/IanDarke/status/1341904890914885641?ref_src=twsrc%5Etfw">December
24, 2020</a></p>
</blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<p>So let’s talk about <a
href="https://www.bettingodds.com/news/what-are-expected-points-xp-football-betting">expected
points (xPts)</a>. The one sentence explainer for xPts: it’s a number
between 0 and 3 assigned to each team in a match that we estimate from
the xG of each shot in the match. Teams that accumulate more xG than
their opponents in the match are more likely to have xPts closer to 3,
i.e. the points awarded for a win, and those that accumulate less than
their opponents are more likely to earn xPts closer to 0. xPts is
convenient for translating a team’s xG (relative to it’s opponents) to
the team’s expected placement in the standings.</p>
<p>While <a
href="https://luke-beggs.medium.com/creating-an-expected-points-xp-calculator-for-football-matches-ce4edd18d16f">several</a>
<a
href="https://theshortfuse.sbnation.com/2017/11/15/16655916/how-to-calculate-xpoints-analysis-stats-xg">outlets</a>
have described computing expected points with simulation<a href="#fn1"
class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>, <a
href="https://www.jonaslindstrom.dk/?p=330">simulation is actually not
necessary</a> if you have the xG for every shot taken in a match.<a
href="#fn2" class="footnote-ref" id="fnref2"
role="doc-noteref"><sup>2</sup></a> For example, let’s say team A shoots
six times with an xG of 0.1 for each shot, and team B shoots three shots
with xG’s of 0.1, 0.2, and 0.3 respectively. Given these goal
probabilities, we can analytically compute the probabilities of (1) team
A winning, (2) team B winning, and (3) a draw as follows.<a href="#fn3"
class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a></p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'>poibin</span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'>gdata</span><span class='op'>)</span>
<span class='va'>xg_a</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='fl'>0.1</span>, <span class='fl'>6</span><span class='op'>)</span>
<span class='va'>xg_b</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0.1</span>, <span class='fl'>0.2</span>, <span class='fl'>0.3</span><span class='op'>)</span>

<span class='va'>probs_a</span> <span class='op'>&lt;-</span> <span class='fu'>poibin</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/poibin/man/ppoibin.html'>dpoibin</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/seq.html'>seq.int</a></span><span class='op'>(</span><span class='fl'>0</span>, <span class='fu'><a href='https://rdrr.io/r/base/length.html'>length</a></span><span class='op'>(</span><span class='va'>xg_a</span><span class='op'>)</span><span class='op'>)</span>, <span class='va'>xg_a</span><span class='op'>)</span>
<span class='va'>probs_b</span> <span class='op'>&lt;-</span> <span class='fu'>poibin</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/poibin/man/ppoibin.html'>dpoibin</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/seq.html'>seq.int</a></span><span class='op'>(</span><span class='fl'>0</span>, <span class='fu'><a href='https://rdrr.io/r/base/length.html'>length</a></span><span class='op'>(</span><span class='va'>xg_b</span><span class='op'>)</span><span class='op'>)</span>, <span class='va'>xg_b</span><span class='op'>)</span>

<span class='va'>outer_prod</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/outer.html'>outer</a></span><span class='op'>(</span><span class='va'>probs_a</span>, <span class='va'>probs_b</span><span class='op'>)</span>
<span class='va'>p_a</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='fu'>gdata</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/gdata/man/upperTriangle.html'>upperTriangle</a></span><span class='op'>(</span><span class='va'>outer_prod</span><span class='op'>)</span><span class='op'>)</span>
<span class='va'>p_b</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='fu'>gdata</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/gdata/man/upperTriangle.html'>lowerTriangle</a></span><span class='op'>(</span><span class='va'>outer_prod</span><span class='op'>)</span><span class='op'>)</span>
<span class='va'>p_draw</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/diag.html'>diag</a></span><span class='op'>(</span><span class='va'>outer_prod</span><span class='op'>)</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/base/Round.html'>round</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>p_a</span>, <span class='va'>p_b</span>, <span class='va'>p_draw</span><span class='op'>)</span>, <span class='fl'>2</span><span class='op'>)</span>
<span class='co'>#&gt; [1] 0.30 0.28 0.42</span>
</code></pre>
</div>
</div>
<p>The calculation of xPts is straightforward once the match outcome
probabilities are computed.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>xpts_a</span> <span class='op'>&lt;-</span> <span class='fl'>3</span> <span class='op'>*</span> <span class='va'>p_a</span> <span class='op'>+</span> <span class='fl'>1</span> <span class='op'>*</span> <span class='va'>p_draw</span>
<span class='va'>xpts_b</span> <span class='op'>&lt;-</span> <span class='fl'>3</span> <span class='op'>*</span> <span class='va'>p_b</span> <span class='op'>+</span> <span class='fl'>1</span> <span class='op'>*</span> <span class='va'>p_draw</span>
<span class='fu'><a href='https://rdrr.io/r/base/Round.html'>round</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>xpts_a</span>, <span class='va'>xpts_b</span><span class='op'>)</span>, <span class='fl'>2</span><span class='op'>)</span>
<span class='co'>#&gt; [1] 1.31 1.27</span>
</code></pre>
</div>
</div>
<p>For this example, we arrive at the interesting result that, despite
the two teams total xG being equal (=0.6), team A has a slightly higher
probability of winning. There have been plenty of <a
href="https://hockey-graphs.com/2018/12/19/some-people-were-wrong-on-twitter/">explanations</a>
on this “quality vs. quantity” phenomenon, so I won’t go into it in
detail. Nonetheless, this simple example illustrates why it can be
useful to translate xG into another form—doing so provides a better
perspective on match results and team placement in the standings, which
is determined by points.</p>
<h3 id="objectives">Objectives</h3>
<p>So we’ve gone over what expected points are and why they’re
important. Now we set out to do the following.</p>
<ol type="1">
<li><strong>Calculate xPts from shot xG for multiple seasons of
data.</strong> We’ll limit the scope to the 2020/21 and 2021/22 seasons
for the English Premier League.<a href="#fn4" class="footnote-ref"
id="fnref4" role="doc-noteref"><sup>4</sup></a></li>
<li><strong>Compare the calibration of the understat and fotmob match
outcome probabilities.</strong> <code>{worldfootballR}</code> makes it
easy for us to get xG from both <a
href="https://understat.com/">understat</a> and <a
href="https://www.fotmob.com/">fotmob</a>, and it should be interesting
to compare the the predictive performance of the two models.</li>
<li><strong>Compare predictions of actual season-long points using xPts
that we derive from understat and fotmob xG.</strong> In particular,
we’ll be interested to see if our conclusions regarding the better
source for xG here matches the conclusions for (2).</li>
</ol>
<h2 id="analysis">Analysis</h2>
<h3 id="calculating-xpts-from-xg">1. Calculating xPts from xG</h3>
<p>Let’s start by using the <code>load_understat_league_shots()</code>
function from <code>{worldfootballR}</code> to retrieve understat xG by
shot.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://readr.tidyverse.org'>readr</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://dplyr.tidyverse.org'>dplyr</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://tibble.tidyverse.org/'>tibble</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://tidyr.tidyverse.org'>tidyr</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://stringr.tidyverse.org'>stringr</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://lubridate.tidyverse.org'>lubridate</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://github.com/JaseZiv/worldfootballR'>worldfootballR</a></span><span class='op'>)</span> <span class='co'>## version: 0.5.12.5000</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://github.com/sfirke/janitor'>janitor</a></span><span class='op'>)</span>

<span class='co'>## manually created CSV with 2 columns: team_understat, team_fotmob.</span>
<span class='co'>##   use the team_understat name to be consistent across sources.</span>
<span class='co'>##   CSV: https://raw.githubusercontent.com/tonyelhabr/sports_viz/master/59-xg_xpoints/team_mapping.csv</span>
<span class='va'>team_mapping</span> <span class='op'>&lt;-</span> <span class='st'>'team_mapping.csv'</span> |&gt; <span class='fu'>readr</span><span class='fu'>::</span><span class='fu'><a href='https://readr.tidyverse.org/reference/read_delim.html'>read_csv</a></span><span class='op'>(</span><span class='op'>)</span>

<span class='va'>rename_teams</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>df</span>, <span class='va'>src</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='va'>team_src</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/sprintf.html'>sprintf</a></span><span class='op'>(</span><span class='st'>'team_%s'</span>, <span class='va'>src</span><span class='op'>)</span>
  <span class='va'>df</span> |&gt; 
    <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate-joins.html'>left_join</a></span><span class='op'>(</span>
      <span class='va'>team_mapping</span> |&gt; 
        <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='va'>.data</span><span class='op'>$</span><span class='va'>team_understat</span>, <span class='va'>.data</span><span class='op'>[[</span><span class='va'>team_src</span><span class='op'>]</span><span class='op'>]</span><span class='op'>)</span>,
      by <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>'home_team'</span> <span class='op'>=</span> <span class='va'>team_src</span><span class='op'>)</span>
    <span class='op'>)</span> |&gt; 
    <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='op'>-</span><span class='va'>.data</span><span class='op'>$</span><span class='va'>home_team</span><span class='op'>)</span> |&gt; 
    <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/rename.html'>rename</a></span><span class='op'>(</span>home_team <span class='op'>=</span> <span class='va'>.data</span><span class='op'>$</span><span class='va'>team_538</span><span class='op'>)</span> |&gt; 
    <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate-joins.html'>left_join</a></span><span class='op'>(</span>
      <span class='va'>team_mapping</span> |&gt; 
        <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='va'>.data</span><span class='op'>$</span><span class='va'>team_understat</span>, <span class='va'>.data</span><span class='op'>[[</span><span class='va'>team_src</span><span class='op'>]</span><span class='op'>]</span><span class='op'>)</span>,
      by <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>'away_team'</span> <span class='op'>=</span> <span class='va'>team_src</span><span class='op'>)</span>
    <span class='op'>)</span> |&gt; 
    <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='op'>-</span><span class='va'>.data</span><span class='op'>$</span><span class='va'>away_team</span><span class='op'>)</span> |&gt; 
    <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/rename.html'>rename</a></span><span class='op'>(</span>away_team <span class='op'>=</span> <span class='va'>.data</span><span class='op'>$</span><span class='va'>team_understat</span><span class='op'>)</span> |&gt; 
    <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>
      team <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/ifelse.html'>ifelse</a></span><span class='op'>(</span><span class='va'>is_home</span>, <span class='va'>home_team</span>, <span class='va'>away_team</span><span class='op'>)</span>,
      opponent <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/ifelse.html'>ifelse</a></span><span class='op'>(</span><span class='va'>is_home</span>, <span class='va'>away_team</span>, <span class='va'>home_team</span><span class='op'>)</span>
    <span class='op'>)</span> |&gt; 
    <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='op'>-</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>home_team</span>, <span class='va'>away_team</span><span class='op'>)</span><span class='op'>)</span> 
<span class='op'>}</span>

<span class='va'>convert_understat_year_to_season</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>x</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='fu'><a href='https://rdrr.io/r/base/sprintf.html'>sprintf</a></span><span class='op'>(</span><span class='st'>'%s/%s'</span>, <span class='va'>x</span>, <span class='fu'>stringr</span><span class='fu'>::</span><span class='fu'><a href='https://stringr.tidyverse.org/reference/str_sub.html'>str_sub</a></span><span class='op'>(</span><span class='va'>x</span> <span class='op'>+</span> <span class='fl'>1</span>, <span class='fl'>3</span>, <span class='fl'>4</span><span class='op'>)</span><span class='op'>)</span>
<span class='op'>}</span>

<span class='co'>## we'll use all of the shots later when exporing understat data only</span>
<span class='va'>all_understat_shots</span> <span class='op'>&lt;-</span> <span class='fu'>worldfootballR</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/worldfootballR/man/load_understat_league_shots.html'>load_understat_league_shots</a></span><span class='op'>(</span><span class='st'>'EPL'</span><span class='op'>)</span> |&gt; 
  <span class='fu'>tibble</span><span class='fu'>::</span><span class='fu'><a href='https://tibble.tidyverse.org/reference/as_tibble.html'>as_tibble</a></span><span class='op'>(</span><span class='op'>)</span> |&gt; 
  <span class='co'>## camelcase like "xG" is for Java scrubs</span>
  <span class='fu'>janitor</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/janitor/man/clean_names.html'>clean_names</a></span><span class='op'>(</span><span class='op'>)</span> |&gt; 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>season</span> <span class='op'>&lt;=</span> <span class='fl'>2021</span><span class='op'>)</span> |&gt; 
  <span class='co'>## transmute = select + mutate</span>
  <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>transmute</a></span><span class='op'>(</span>
    <span class='va'>match_id</span>,
    <span class='co'>## "2021/2022" format so that we have a clear, consistent way to represent season</span>
    <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/across.html'>across</a></span><span class='op'>(</span><span class='va'>season</span>, <span class='va'>convert_understat_year_to_season</span><span class='op'>)</span>,
    <span class='co'>## to convert "2020-09-12 11:30:00" to a date ("2020-09-12")</span>
    <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/across.html'>across</a></span><span class='op'>(</span><span class='va'>date</span>, <span class='fu'>lubridate</span><span class='fu'>::</span><span class='va'><a href='https://lubridate.tidyverse.org/reference/date.html'>date</a></span><span class='op'>)</span>,
    <span class='va'>home_team</span>,
    <span class='va'>away_team</span>,
    is_home <span class='op'>=</span> <span class='va'>h_a</span> <span class='op'>==</span> <span class='st'>'h'</span>,
    xg <span class='op'>=</span> <span class='va'>x_g</span>
  <span class='op'>)</span> |&gt;
  <span class='fu'>rename_teams</span><span class='op'>(</span><span class='st'>'understat'</span><span class='op'>)</span> |&gt; 
  <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/arrange.html'>arrange</a></span><span class='op'>(</span><span class='va'>season</span>, <span class='va'>date</span>, <span class='va'>team</span><span class='op'>)</span>

<span class='co'>## but when comparing understat with fotmob, we'll need to limit the seasons to just</span>
<span class='co'>##   those that both sources have</span>
<span class='va'>understat_shots</span> <span class='op'>&lt;-</span> <span class='va'>all_understat_shots</span> |&gt; 
  <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>season</span> <span class='op'>&gt;=</span> <span class='fl'>2020</span><span class='op'>)</span>
<span class='va'>understat_shots</span>
<span class='co'>#&gt; # A tibble: 19,010 × 7</span>
<span class='co'>#&gt;    match_id season  date       is_home     xg team    opponent</span>
<span class='co'>#&gt;       &lt;dbl&gt; &lt;chr&gt;   &lt;date&gt;     &lt;lgl&gt;    &lt;dbl&gt; &lt;chr&gt;   &lt;chr&gt;   </span>
<span class='co'>#&gt;  1    14086 2020/21 2020-09-12 FALSE   0.0644 Arsenal Fulham  </span>
<span class='co'>#&gt;  2    14086 2020/21 2020-09-12 FALSE   0.649  Arsenal Fulham  </span>
<span class='co'>#&gt;  3    14086 2020/21 2020-09-12 FALSE   0.758  Arsenal Fulham  </span>
<span class='co'>#&gt;  4    14086 2020/21 2020-09-12 FALSE   0.110  Arsenal Fulham  </span>
<span class='co'>#&gt;  5    14086 2020/21 2020-09-12 FALSE   0.0572 Arsenal Fulham  </span>
<span class='co'>#&gt;  6    14086 2020/21 2020-09-12 FALSE   0.136  Arsenal Fulham  </span>
<span class='co'>#&gt;  7    14086 2020/21 2020-09-12 FALSE   0.0817 Arsenal Fulham  </span>
<span class='co'>#&gt;  8    14086 2020/21 2020-09-12 FALSE   0.506  Arsenal Fulham  </span>
<span class='co'>#&gt;  9    14086 2020/21 2020-09-12 FALSE   0.0943 Arsenal Fulham  </span>
<span class='co'>#&gt; 10    14086 2020/21 2020-09-12 FALSE   0.0526 Arsenal Fulham  </span>
<span class='co'>#&gt; # … with 19,000 more rows</span>
</code></pre>
</div>
</div>
<p>We can use <code>load_fotmob_match_details()</code> to get fotmob’s
shot xG in a similar fashion.<a href="#fn5" class="footnote-ref"
id="fnref5" role="doc-noteref"><sup>5</sup></a></p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>fotmob_shots</span> <span class='op'>&lt;-</span> <span class='fu'>worldfootballR</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/worldfootballR/man/load_fotmob_match_details.html'>load_fotmob_match_details</a></span><span class='op'>(</span>
  country <span class='op'>=</span> <span class='st'>'ENG'</span>,
  league_name <span class='op'>=</span> <span class='st'>'Premier League'</span>
<span class='op'>)</span> |&gt; 
  <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>
    <span class='co'>## to convert strings from 'Sat, Sep 12, 2020, 11:30 UTC' to a date</span>
    date <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/strptime.html'>strptime</a></span><span class='op'>(</span><span class='va'>match_time_utc</span>, <span class='st'>'%a, %b %d, %Y, %H:%M UTC'</span>, tz <span class='op'>=</span> <span class='st'>'UTC'</span><span class='op'>)</span> |&gt; <span class='fu'>lubridate</span><span class='fu'>::</span><span class='fu'><a href='https://lubridate.tidyverse.org/reference/date.html'>date</a></span><span class='op'>(</span><span class='op'>)</span>,
    <span class='co'>## fotmob's parent_league_season always reflects the current season, so we need to manually</span>
    <span class='co'>##   define the season from the date. we would certainly want a more automated approach</span>
    <span class='co'>##   if working with more seasons and more leagues.</span>
    season <span class='op'>=</span> <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/case_when.html'>case_when</a></span><span class='op'>(</span>
      <span class='va'>date</span> <span class='op'>&gt;=</span> <span class='fu'>lubridate</span><span class='fu'>::</span><span class='fu'><a href='https://lubridate.tidyverse.org/reference/ymd.html'>ymd</a></span><span class='op'>(</span><span class='st'>'2020-09-12'</span><span class='op'>)</span> <span class='op'>&amp;</span> <span class='va'>date</span> <span class='op'>&lt;=</span> <span class='fu'>lubridate</span><span class='fu'>::</span><span class='fu'><a href='https://lubridate.tidyverse.org/reference/ymd.html'>ymd</a></span><span class='op'>(</span><span class='st'>'2021-05-23'</span><span class='op'>)</span> <span class='op'>~</span> <span class='st'>'2020/21'</span>,
      <span class='va'>date</span> <span class='op'>&gt;=</span> <span class='fu'>lubridate</span><span class='fu'>::</span><span class='fu'><a href='https://lubridate.tidyverse.org/reference/ymd.html'>ymd</a></span><span class='op'>(</span><span class='st'>'2021-08-13'</span><span class='op'>)</span> <span class='op'>&amp;</span> <span class='va'>date</span> <span class='op'>&lt;=</span> <span class='fu'>lubridate</span><span class='fu'>::</span><span class='fu'><a href='https://lubridate.tidyverse.org/reference/ymd.html'>ymd</a></span><span class='op'>(</span><span class='st'>'2022-05-22'</span><span class='op'>)</span> <span class='op'>~</span> <span class='st'>'2021/22'</span>,
      <span class='cn'>TRUE</span> <span class='op'>~</span> <span class='cn'>NA_character_</span>
    <span class='op'>)</span>
  <span class='op'>)</span> |&gt; 
  <span class='co'>## the NAs are for 2022/2023 (incomplete as of writing) and the partial data for 2019/2020</span>
  <span class='fu'>tidyr</span><span class='fu'>::</span><span class='fu'><a href='https://tidyr.tidyverse.org/reference/drop_na.html'>drop_na</a></span><span class='op'>(</span><span class='va'>season</span><span class='op'>)</span> |&gt; 
  <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>transmute</a></span><span class='op'>(</span>
    <span class='va'>match_id</span>,
    <span class='va'>season</span>,
    <span class='va'>date</span>,
    <span class='va'>home_team</span>,
    <span class='va'>away_team</span>,
    is_home <span class='op'>=</span> <span class='va'>team_id</span> <span class='op'>==</span> <span class='va'>home_team_id</span>,
    <span class='co'>## some shots with NAs for some reason</span>
    xg <span class='op'>=</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/coalesce.html'>coalesce</a></span><span class='op'>(</span><span class='va'>expected_goals</span>, <span class='fl'>0</span><span class='op'>)</span>
  <span class='op'>)</span> |&gt;
  <span class='fu'>rename_teams</span><span class='op'>(</span><span class='st'>'fotmob'</span><span class='op'>)</span> |&gt; 
  <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/arrange.html'>arrange</a></span><span class='op'>(</span><span class='va'>season</span>, <span class='va'>date</span>, <span class='va'>team</span><span class='op'>)</span>
<span class='va'>fotmob_shots</span>
<span class='co'>#&gt; # A tibble: 19,013 × 7</span>
<span class='co'>#&gt;    match_id season  date       is_home     xg team    opponent</span>
<span class='co'>#&gt;       &lt;int&gt; &lt;chr&gt;   &lt;date&gt;     &lt;lgl&gt;    &lt;dbl&gt; &lt;chr&gt;   &lt;chr&gt;   </span>
<span class='co'>#&gt;  1  3411352 2020/21 2020-09-12 FALSE   0.0602 Arsenal Fulham  </span>
<span class='co'>#&gt;  2  3411352 2020/21 2020-09-12 FALSE   0.737  Arsenal Fulham  </span>
<span class='co'>#&gt;  3  3411352 2020/21 2020-09-12 FALSE   0.845  Arsenal Fulham  </span>
<span class='co'>#&gt;  4  3411352 2020/21 2020-09-12 FALSE   0.0879 Arsenal Fulham  </span>
<span class='co'>#&gt;  5  3411352 2020/21 2020-09-12 FALSE   0.0443 Arsenal Fulham  </span>
<span class='co'>#&gt;  6  3411352 2020/21 2020-09-12 FALSE   0.131  Arsenal Fulham  </span>
<span class='co'>#&gt;  7  3411352 2020/21 2020-09-12 FALSE   0.0916 Arsenal Fulham  </span>
<span class='co'>#&gt;  8  3411352 2020/21 2020-09-12 FALSE   0.310  Arsenal Fulham  </span>
<span class='co'>#&gt;  9  3411352 2020/21 2020-09-12 FALSE   0.0531 Arsenal Fulham  </span>
<span class='co'>#&gt; 10  3411352 2020/21 2020-09-12 FALSE   0.0631 Arsenal Fulham  </span>
<span class='co'>#&gt; # … with 19,003 more rows</span>
</code></pre>
</div>
</div>
<p>Alright, now the fun part. We functionalize the code from the example
for calculating the probability that xG will result in 0, 1, 2, etc.
goals (up to the number of shots taken).</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='http://purrr.tidyverse.org'>purrr</a></span><span class='op'>)</span>
<span class='va'>permute_xg</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>xg</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='va'>n</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/length.html'>length</a></span><span class='op'>(</span><span class='va'>xg</span><span class='op'>)</span>
  <span class='va'>x</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/seq.html'>seq.int</a></span><span class='op'>(</span><span class='fl'>0</span>, <span class='va'>n</span><span class='op'>)</span>
  <span class='fu'>poibin</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/poibin/man/ppoibin.html'>dpoibin</a></span><span class='op'>(</span><span class='va'>x</span>, <span class='va'>xg</span><span class='op'>)</span>
<span class='op'>}</span>

<span class='va'>calculate_permuted_xg</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>df</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='va'>df</span> |&gt; 
    <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/across.html'>across</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://tidyselect.r-lib.org/reference/everything.html'>everything</a></span><span class='op'>(</span><span class='op'>)</span>, <span class='op'>-</span><span class='va'>xg</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> |&gt; 
    <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/summarise.html'>summarize</a></span><span class='op'>(</span><span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/across.html'>across</a></span><span class='op'>(</span><span class='va'>xg</span>, <span class='op'>~</span><span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span><span class='va'>.x</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> |&gt; 
    <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>
      prob <span class='op'>=</span> <span class='fu'>purrr</span><span class='fu'>::</span><span class='fu'><a href='https://purrr.tidyverse.org/reference/map.html'>map</a></span><span class='op'>(</span><span class='va'>xg</span>, <span class='op'>~</span><span class='fu'>permute_xg</span><span class='op'>(</span><span class='va'>.x</span><span class='op'>)</span><span class='op'>)</span>
    <span class='op'>)</span> |&gt; 
    <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='op'>-</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>xg</span><span class='op'>)</span><span class='op'>)</span> |&gt; 
    <span class='fu'>tidyr</span><span class='fu'>::</span><span class='fu'><a href='https://tidyr.tidyverse.org/reference/nest.html'>unnest</a></span><span class='op'>(</span>cols <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>prob</span><span class='op'>)</span><span class='op'>)</span> |&gt; 
    <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/across.html'>across</a></span><span class='op'>(</span><span class='op'>-</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>prob</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> |&gt;
    <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>
      g <span class='op'>=</span> <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/ranking.html'>row_number</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>-</span> <span class='fl'>1L</span>
    <span class='op'>)</span> |&gt;
    <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>ungroup</a></span><span class='op'>(</span><span class='op'>)</span> |&gt; 
    <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/arrange.html'>arrange</a></span><span class='op'>(</span><span class='va'>match_id</span>, <span class='va'>is_home</span>, <span class='va'>g</span><span class='op'>)</span>
<span class='op'>}</span>

<span class='va'>understat_permuted_xg</span> <span class='op'>&lt;-</span> <span class='va'>understat_shots</span> |&gt; <span class='fu'>calculate_permuted_xg</span><span class='op'>(</span><span class='op'>)</span>
<span class='va'>fotmob_permuted_xg</span> <span class='op'>&lt;-</span> <span class='va'>fotmob_shots</span> |&gt; <span class='fu'>calculate_permuted_xg</span><span class='op'>(</span><span class='op'>)</span>

<span class='co'>## just one of the variables. the other one looks the same, with different values for prob</span>
<span class='va'>understat_permuted_xg</span>
<span class='co'>#&gt; # A tibble: 20,530 × 8</span>
<span class='co'>#&gt;    match_id season  date       is_home team    opponent       prob     g</span>
<span class='co'>#&gt;       &lt;dbl&gt; &lt;chr&gt;   &lt;date&gt;     &lt;lgl&gt;   &lt;chr&gt;   &lt;chr&gt;         &lt;dbl&gt; &lt;int&gt;</span>
<span class='co'>#&gt;  1    14086 2020/21 2020-09-12 FALSE   Arsenal Fulham   0.0180         0</span>
<span class='co'>#&gt;  2    14086 2020/21 2020-09-12 FALSE   Arsenal Fulham   0.124          1</span>
<span class='co'>#&gt;  3    14086 2020/21 2020-09-12 FALSE   Arsenal Fulham   0.298          2</span>
<span class='co'>#&gt;  4    14086 2020/21 2020-09-12 FALSE   Arsenal Fulham   0.320          3</span>
<span class='co'>#&gt;  5    14086 2020/21 2020-09-12 FALSE   Arsenal Fulham   0.172          4</span>
<span class='co'>#&gt;  6    14086 2020/21 2020-09-12 FALSE   Arsenal Fulham   0.0543         5</span>
<span class='co'>#&gt;  7    14086 2020/21 2020-09-12 FALSE   Arsenal Fulham   0.0110         6</span>
<span class='co'>#&gt;  8    14086 2020/21 2020-09-12 FALSE   Arsenal Fulham   0.00150        7</span>
<span class='co'>#&gt;  9    14086 2020/21 2020-09-12 FALSE   Arsenal Fulham   0.000141       8</span>
<span class='co'>#&gt; 10    14086 2020/21 2020-09-12 FALSE   Arsenal Fulham   0.00000917     9</span>
<span class='co'>#&gt; # … with 20,520 more rows</span>
</code></pre>
</div>
</div>
<p>Next, we identify all possible goal combinations using xG as
“weights” to compute the relative likelihood of each combination, and
then analytically calculate the probabilities of winning, losing, and
drawing.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>summarize_pivoted_permuted_xg</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>prob_away</span>, <span class='va'>prob_home</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='va'>outer_prod</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/outer.html'>outer</a></span><span class='op'>(</span><span class='va'>prob_away</span>, <span class='va'>prob_home</span><span class='op'>)</span>
  <span class='va'>p_draw</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/diag.html'>diag</a></span><span class='op'>(</span><span class='va'>outer_prod</span><span class='op'>)</span>, na.rm <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span>
  <span class='va'>p_home</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='fu'>gdata</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/gdata/man/upperTriangle.html'>upperTriangle</a></span><span class='op'>(</span><span class='va'>outer_prod</span><span class='op'>)</span>, na.rm <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span>
  <span class='va'>p_away</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='fu'>gdata</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/gdata/man/upperTriangle.html'>lowerTriangle</a></span><span class='op'>(</span><span class='va'>outer_prod</span><span class='op'>)</span>, na.rm <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span>
  <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>
    draw <span class='op'>=</span> <span class='va'>p_draw</span>,
    home <span class='op'>=</span> <span class='va'>p_home</span>,
    away <span class='op'>=</span> <span class='va'>p_away</span>
  <span class='op'>)</span>
<span class='op'>}</span>

<span class='va'>summarize_permuted_xg_by_match</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>df</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='va'>pivoted</span> <span class='op'>&lt;-</span> <span class='va'>df</span> |&gt;
    <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>transmute</a></span><span class='op'>(</span>
      <span class='va'>match_id</span>,
      <span class='va'>season</span>,
      <span class='va'>date</span>,
      <span class='va'>g</span>,
      is_home <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/ifelse.html'>ifelse</a></span><span class='op'>(</span><span class='va'>is_home</span>, <span class='st'>'home'</span>, <span class='st'>'away'</span><span class='op'>)</span>,
      <span class='va'>prob</span>
    <span class='op'>)</span> |&gt;
    <span class='fu'>tidyr</span><span class='fu'>::</span><span class='fu'><a href='https://tidyr.tidyverse.org/reference/pivot_wider.html'>pivot_wider</a></span><span class='op'>(</span>
      names_from <span class='op'>=</span> <span class='va'>is_home</span>,
      names_prefix <span class='op'>=</span> <span class='st'>'prob_'</span>,
      values_from <span class='op'>=</span> <span class='va'>prob</span>,
      values_fill <span class='op'>=</span> <span class='fl'>0L</span>
    <span class='op'>)</span>
  
  <span class='va'>pivoted</span> |&gt; 
    <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='va'>match_id</span>, <span class='va'>season</span>, <span class='va'>date</span>, <span class='va'>prob_away</span>, <span class='va'>prob_home</span><span class='op'>)</span> |&gt;
    <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>match_id</span>, <span class='va'>season</span>, <span class='va'>date</span><span class='op'>)</span> |&gt; 
    <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/summarise.html'>summarize</a></span><span class='op'>(</span>
      <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/across.html'>across</a></span><span class='op'>(</span><span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://tidyselect.r-lib.org/reference/starts_with.html'>starts_with</a></span><span class='op'>(</span><span class='st'>'prob_'</span><span class='op'>)</span>, <span class='op'>~</span><span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span><span class='va'>.x</span><span class='op'>)</span><span class='op'>)</span>
    <span class='op'>)</span> |&gt; 
    <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>ungroup</a></span><span class='op'>(</span><span class='op'>)</span> |&gt; 
    <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate-joins.html'>inner_join</a></span><span class='op'>(</span>
      <span class='va'>df</span> |&gt; <span class='fu'><a href='https://dplyr.tidyverse.org/reference/distinct.html'>distinct</a></span><span class='op'>(</span><span class='va'>match_id</span>, <span class='va'>team</span>, <span class='va'>opponent</span>, <span class='va'>is_home</span><span class='op'>)</span>,
      by <span class='op'>=</span> <span class='st'>'match_id'</span>
    <span class='op'>)</span> |&gt; 
    <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>
      prob <span class='op'>=</span> <span class='fu'><a href='https://purrr.tidyverse.org/reference/map2.html'>map2</a></span><span class='op'>(</span><span class='va'>prob_away</span>, <span class='va'>prob_home</span>, <span class='va'>summarize_pivoted_permuted_xg</span><span class='op'>)</span>
    <span class='op'>)</span> |&gt; 
    <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='op'>-</span><span class='fu'><a href='https://tidyselect.r-lib.org/reference/starts_with.html'>starts_with</a></span><span class='op'>(</span><span class='st'>'prob_'</span><span class='op'>)</span><span class='op'>)</span> |&gt; 
    <span class='fu'>tidyr</span><span class='fu'>::</span><span class='fu'><a href='https://tidyr.tidyverse.org/reference/hoist.html'>unnest_wider</a></span><span class='op'>(</span><span class='va'>prob</span>, names_sep <span class='op'>=</span> <span class='st'>'_'</span><span class='op'>)</span> |&gt; 
    <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>
      prob_win <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/ifelse.html'>ifelse</a></span><span class='op'>(</span><span class='va'>is_home</span>, <span class='va'>prob_home</span>, <span class='va'>prob_away</span><span class='op'>)</span>,
      prob_lose <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/ifelse.html'>ifelse</a></span><span class='op'>(</span><span class='va'>is_home</span>, <span class='va'>prob_away</span>, <span class='va'>prob_home</span><span class='op'>)</span>,
      xpts <span class='op'>=</span> <span class='fl'>3</span> <span class='op'>*</span> <span class='va'>prob_win</span> <span class='op'>+</span> <span class='fl'>1</span> <span class='op'>*</span> <span class='va'>prob_draw</span>
    <span class='op'>)</span> |&gt; 
    <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='op'>-</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>prob_home</span>, <span class='va'>prob_away</span><span class='op'>)</span><span class='op'>)</span>
<span class='op'>}</span>

<span class='va'>understat_xpts_by_match</span> <span class='op'>&lt;-</span> <span class='va'>understat_permuted_xg</span> |&gt; <span class='fu'>summarize_permuted_xg_by_match</span><span class='op'>(</span><span class='op'>)</span>
<span class='va'>fotmob_xpts_by_match</span> <span class='op'>&lt;-</span> <span class='va'>fotmob_permuted_xg</span> |&gt; <span class='fu'>summarize_permuted_xg_by_match</span><span class='op'>(</span><span class='op'>)</span>

<span class='co'>## just one of the variables. the other looks the same, with different values for prob* and xpts</span>
<span class='va'>understat_xpts_by_match</span> |&gt; 
  <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='op'>-</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>season</span>, <span class='va'>match_id</span>, <span class='va'>is_home</span><span class='op'>)</span><span class='op'>)</span> |&gt;
  <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span><span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/across.html'>across</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://tidyselect.r-lib.org/reference/starts_with.html'>starts_with</a></span><span class='op'>(</span><span class='st'>'prob_'</span><span class='op'>)</span>, <span class='va'>xpts</span><span class='op'>)</span>, <span class='va'>round</span>, <span class='fl'>2</span><span class='op'>)</span><span class='op'>)</span>
<span class='co'>#&gt; # A tibble: 1,520 × 7</span>
<span class='co'>#&gt;    date       team              opponent          prob_d…¹ prob_…² prob_…³  xpts</span>
<span class='co'>#&gt;    &lt;date&gt;     &lt;chr&gt;             &lt;chr&gt;                &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;</span>
<span class='co'>#&gt;  1 2020-09-12 Arsenal           Fulham                0.03    0.97    0     2.93</span>
<span class='co'>#&gt;  2 2020-09-12 Fulham            Arsenal               0.03    0       0.97  0.04</span>
<span class='co'>#&gt;  3 2020-09-12 Southampton       Crystal Palace        0.3     0.31    0.39  1.22</span>
<span class='co'>#&gt;  4 2020-09-12 Crystal Palace    Southampton           0.3     0.39    0.31  1.48</span>
<span class='co'>#&gt;  5 2021-01-12 Manchester United Burnley               0.3     0.52    0.18  1.86</span>
<span class='co'>#&gt;  6 2021-01-12 Burnley           Manchester United     0.3     0.18    0.52  0.84</span>
<span class='co'>#&gt;  7 2021-01-20 Aston Villa       Manchester City       0.04    0.01    0.95  0.07</span>
<span class='co'>#&gt;  8 2021-01-20 Manchester City   Aston Villa           0.04    0.95    0.01  2.89</span>
<span class='co'>#&gt;  9 2020-09-12 Leeds             Liverpool             0.03    0       0.97  0.04</span>
<span class='co'>#&gt; 10 2020-09-12 Liverpool         Leeds                 0.03    0.97    0     2.93</span>
<span class='co'>#&gt; # … with 1,510 more rows, and abbreviated variable names ¹​prob_draw, ²​prob_win,</span>
<span class='co'>#&gt; #   ³​prob_lose</span>
</code></pre>
</div>
</div>
<p>If there was any doubt about the expected points calculation, note
that understat offers xPts directly in their data. The mean absolute
error of our calculation of xPts with theirs is ~0.02.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://ewenme.github.io/understatr'>understatr</a></span><span class='op'>)</span>

<span class='va'>all_raw_understat_xpts_by_match</span> <span class='op'>&lt;-</span> <span class='fl'>2014</span><span class='op'>:</span><span class='fl'>2021</span> |&gt; 
  <span class='fu'>rlang</span><span class='fu'>::</span><span class='fu'><a href='https://rlang.r-lib.org/reference/set_names.html'>set_names</a></span><span class='op'>(</span><span class='op'>)</span> |&gt; 
  <span class='fu'>purrr</span><span class='fu'>::</span><span class='fu'><a href='https://purrr.tidyverse.org/reference/map.html'>map_dfr</a></span><span class='op'>(</span>
    <span class='op'>~</span><span class='fu'>understatr</span><span class='fu'>::</span><span class='fu'><a href='https://ewenme.github.io/understatr/reference/get_league_teams_stats.html'>get_league_teams_stats</a></span><span class='op'>(</span><span class='st'>'EPL'</span>, <span class='va'>.x</span><span class='op'>)</span>,
    .id <span class='op'>=</span> <span class='st'>'season'</span>
  <span class='op'>)</span> |&gt; 
  <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>transmute</a></span><span class='op'>(</span>
    <span class='fu'><a href='https://dplyr.tidyverse.org/reference/across.html'>across</a></span><span class='op'>(</span><span class='va'>season</span>, <span class='op'>~</span><span class='fu'>convert_understat_year_to_season</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/integer.html'>as.integer</a></span><span class='op'>(</span><span class='va'>.x</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span>,
    <span class='va'>date</span>,
    team <span class='op'>=</span> <span class='va'>team_name</span>,
    <span class='va'>result</span>,
    <span class='va'>pts</span>,
    raw_xpts <span class='op'>=</span> <span class='va'>xpts</span>,
    xg <span class='op'>=</span> <span class='va'>xG</span>
  <span class='op'>)</span>

<span class='va'>raw_understat_xpts_by_match</span> <span class='op'>&lt;-</span> <span class='va'>all_raw_understat_xpts_by_match</span> |&gt; 
  <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate-joins.html'>inner_join</a></span><span class='op'>(</span>
    <span class='va'>understat_xpts_by_match</span> |&gt; <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='va'>season</span>, <span class='va'>date</span>, <span class='va'>team</span>, <span class='va'>xpts</span><span class='op'>)</span>,
    by <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>'season'</span>, <span class='st'>'date'</span>, <span class='st'>'team'</span><span class='op'>)</span>
  <span class='op'>)</span> |&gt; 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>
    xptsd <span class='op'>=</span> <span class='va'>raw_xpts</span> <span class='op'>-</span> <span class='va'>xpts</span>
  <span class='op'>)</span> |&gt; 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/arrange.html'>arrange</a></span><span class='op'>(</span><span class='va'>season</span>, <span class='va'>date</span>, <span class='va'>team</span><span class='op'>)</span>
<span class='va'>raw_understat_xpts_by_match</span>
<span class='co'>#&gt; # A tibble: 1,520 × 9</span>
<span class='co'>#&gt;    season  date       team           result   pts raw_x…¹    xg   xpts    xptsd</span>
<span class='co'>#&gt;    &lt;chr&gt;   &lt;date&gt;     &lt;chr&gt;          &lt;chr&gt;  &lt;int&gt;   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;</span>
<span class='co'>#&gt;  1 2020/21 2020-09-12 Arsenal        w          3  2.89   2.16  2.93   -3.40e-2</span>
<span class='co'>#&gt;  2 2020/21 2020-09-12 Crystal Palace w          3  1.48   1.40  1.48   -1.08e-3</span>
<span class='co'>#&gt;  3 2020/21 2020-09-12 Fulham         l          0  0.0587 0.126 0.0405  1.82e-2</span>
<span class='co'>#&gt;  4 2020/21 2020-09-12 Leeds          l          0  0.0434 0.270 0.0440 -5.77e-4</span>
<span class='co'>#&gt;  5 2020/21 2020-09-12 Liverpool      w          3  2.93   3.15  2.93    1.03e-3</span>
<span class='co'>#&gt;  6 2020/21 2020-09-12 Newcastle      w          3  2.05   1.66  2.03    1.86e-2</span>
<span class='co'>#&gt;  7 2020/21 2020-09-12 Southampton    l          0  1.22   1.26  1.22   -5.44e-4</span>
<span class='co'>#&gt;  8 2020/21 2020-09-12 West Ham       l          0  0.700  0.861 0.717  -1.71e-2</span>
<span class='co'>#&gt;  9 2020/21 2020-09-13 Everton        w          3  1.74   1.27  1.74    5.98e-3</span>
<span class='co'>#&gt; 10 2020/21 2020-09-13 Leicester      w          3  2.91   2.96  2.91    6.14e-4</span>
<span class='co'>#&gt; # … with 1,510 more rows, and abbreviated variable name ¹​raw_xpts</span>

<span class='co'>## mean absolute error</span>
<span class='fu'><a href='https://rdrr.io/r/base/Round.html'>round</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/MathFun.html'>abs</a></span><span class='op'>(</span><span class='va'>raw_understat_xpts_by_match</span><span class='op'>$</span><span class='va'>xptsd</span><span class='op'>)</span><span class='op'>)</span>, <span class='fl'>3</span><span class='op'>)</span>
<span class='co'>#&gt; [1] 0.022</span>
</code></pre>
</div>
</div>
<h3 id="match-predictive-performance6">2. Match predictive performance<a
href="#fn6" class="footnote-ref" id="fnref6"
role="doc-noteref"><sup>6</sup></a></h3>
<p>As one might guess, the match outcome probabilities implied by the xG
from understat and fotmob are strongly correlated.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>rename_xpts_by_match</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>df</span>, <span class='va'>src</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='va'>df</span> |&gt; 
    <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='va'>season</span>, <span class='va'>date</span>, <span class='va'>team</span>, <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://tidyselect.r-lib.org/reference/starts_with.html'>starts_with</a></span><span class='op'>(</span><span class='st'>'prob_'</span><span class='op'>)</span>, <span class='va'>xpts</span><span class='op'>)</span> |&gt; 
    <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/rename.html'>rename_with</a></span><span class='op'>(</span>
      <span class='op'>~</span><span class='fu'><a href='https://rdrr.io/r/base/sprintf.html'>sprintf</a></span><span class='op'>(</span><span class='st'>'%s_%s'</span>, <span class='va'>.x</span>, <span class='va'>src</span><span class='op'>)</span>, <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://tidyselect.r-lib.org/reference/starts_with.html'>starts_with</a></span><span class='op'>(</span><span class='st'>'prob_'</span><span class='op'>)</span>, <span class='va'>xpts</span><span class='op'>)</span>
    <span class='op'>)</span>
<span class='op'>}</span>

<span class='va'>xpts_by_match</span> <span class='op'>&lt;-</span> <span class='va'>raw_understat_xpts_by_match</span> |&gt; 
  <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='va'>season</span>, <span class='va'>date</span>, <span class='va'>team</span>, <span class='va'>result</span>, <span class='va'>pts</span><span class='op'>)</span> |&gt; 
  <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate-joins.html'>inner_join</a></span><span class='op'>(</span>
    <span class='va'>understat_xpts_by_match</span> |&gt; <span class='fu'>rename_xpts_by_match</span><span class='op'>(</span><span class='st'>'understat'</span><span class='op'>)</span>,
    by <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>'season'</span>, <span class='st'>'date'</span>, <span class='st'>'team'</span><span class='op'>)</span>
  <span class='op'>)</span> |&gt; 
  <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate-joins.html'>inner_join</a></span><span class='op'>(</span>
    <span class='va'>fotmob_xpts_by_match</span> |&gt; <span class='fu'>rename_xpts_by_match</span><span class='op'>(</span><span class='st'>'fotmob'</span><span class='op'>)</span>,
    by <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>'season'</span>, <span class='st'>'date'</span>, <span class='st'>'team'</span><span class='op'>)</span>
  <span class='op'>)</span>

<span class='va'>cor_draw</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/cor.html'>cor</a></span><span class='op'>(</span><span class='va'>xpts_by_match</span><span class='op'>$</span><span class='va'>prob_draw_fotmob</span>, <span class='va'>xpts_by_match</span><span class='op'>$</span><span class='va'>prob_draw_understat</span><span class='op'>)</span>
<span class='va'>cor_win</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/cor.html'>cor</a></span><span class='op'>(</span><span class='va'>xpts_by_match</span><span class='op'>$</span><span class='va'>prob_win_fotmob</span>, <span class='va'>xpts_by_match</span><span class='op'>$</span><span class='va'>prob_win_understat</span><span class='op'>)</span>
<span class='va'>cor_lose</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/cor.html'>cor</a></span><span class='op'>(</span><span class='va'>xpts_by_match</span><span class='op'>$</span><span class='va'>prob_lose_fotmob</span>, <span class='va'>xpts_by_match</span><span class='op'>$</span><span class='va'>prob_lose_understat</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/base/Round.html'>round</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>cor_draw</span>, <span class='va'>cor_win</span>, <span class='va'>cor_lose</span><span class='op'>)</span>, <span class='fl'>3</span><span class='op'>)</span>
<span class='co'>#&gt; [1] 0.906 0.958 0.958</span>
</code></pre>
</div>
</div>
<p>Note that the win and loss correlations are identical. This is due to
the symmetric nature of the data—we have two records for each match, one
from each team’s perspective.<a href="#fn7" class="footnote-ref"
id="fnref7" role="doc-noteref"><sup>7</sup></a></p>
<h4
id="predicting-match-outcomes-with-binary-logistic-regression">Predicting
match outcomes with binary logistic regression</h4>
<p>Now let’s compare how “good” the implied probabilities from the two
sources are. To do this, we’ll create binary logistic regression models
to predict a given outcome and compute:</p>
<ol type="1">
<li>the <a href="https://en.wikipedia.org/wiki/Mean_squared_error">mean
squared error (MSE)</a>;</li>
<li>the <a
href="https://en.wikipedia.org/wiki/Brier_score#Brier_Skill_Score_(BSS)">brier
skill score (BSS)</a>, treating the empirical proportion of the
specified outcome as the reference.<a href="#fn8" class="footnote-ref"
id="fnref8" role="doc-noteref"><sup>8</sup></a><a href="#fn9"
class="footnote-ref" id="fnref9"
role="doc-noteref"><sup>9</sup></a></li>
<li>a <a
href="https://changhsinlee.com/python-calibration-plot/">calibration
plot</a>, grouping predictions into “buckets” at every 5%.</li>
</ol>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>result_props</span> <span class='op'>&lt;-</span> <span class='va'>xpts_by_match</span> |&gt; 
  <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/count.html'>count</a></span><span class='op'>(</span><span class='va'>result</span><span class='op'>)</span> |&gt; 
  <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>prop <span class='op'>=</span> <span class='va'>n</span> <span class='op'>/</span> <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='va'>n</span><span class='op'>)</span><span class='op'>)</span>

<span class='va'>compute_mse</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>truth</span>, <span class='va'>estimate</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='op'>(</span><span class='va'>truth</span> <span class='op'>-</span> <span class='va'>estimate</span><span class='op'>)</span><span class='op'>^</span><span class='fl'>2</span><span class='op'>)</span>
<span class='op'>}</span>

<span class='va'>diagnose_prob_by_match</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>src</span>, <span class='va'>result</span><span class='op'>)</span> <span class='op'>{</span>
  
  <span class='va'>df</span> <span class='op'>&lt;-</span> <span class='va'>xpts_by_match</span> |&gt; 
    <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>
      result <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/ifelse.html'>ifelse</a></span><span class='op'>(</span><span class='va'>result</span> <span class='op'>==</span> <span class='op'>!</span><span class='op'>!</span><span class='va'>result</span>, <span class='fl'>1L</span>, <span class='fl'>0L</span><span class='op'>)</span> |&gt; <span class='fu'><a href='https://rdrr.io/r/base/factor.html'>factor</a></span><span class='op'>(</span><span class='op'>)</span>
    <span class='op'>)</span>
  
  <span class='va'>result_name</span> <span class='op'>&lt;-</span> <span class='kw'><a href='https://rdrr.io/r/base/switch.html'>switch</a></span><span class='op'>(</span>
    <span class='va'>result</span>,
    <span class='st'>'w'</span> <span class='op'>=</span> <span class='st'>'win'</span>,
    <span class='st'>'l'</span> <span class='op'>=</span> <span class='st'>'lose'</span>,
    <span class='st'>'d'</span> <span class='op'>=</span> <span class='st'>'draw'</span>
  <span class='op'>)</span>
  <span class='va'>col</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/sprintf.html'>sprintf</a></span><span class='op'>(</span><span class='st'>'prob_%s_%s'</span>, <span class='va'>result_name</span>, <span class='va'>src</span><span class='op'>)</span>
  
  <span class='va'>fit</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/glm.html'>glm</a></span><span class='op'>(</span>
    <span class='va'>df</span><span class='op'>$</span><span class='va'>result</span> <span class='op'>~</span> <span class='va'>df</span><span class='op'>[[</span><span class='va'>col</span><span class='op'>]</span><span class='op'>]</span>,
    family <span class='op'>=</span> <span class='st'>'binomial'</span>
  <span class='op'>)</span>
  
  <span class='va'>probs</span> <span class='op'>&lt;-</span> <span class='fu'>tibble</span><span class='fu'>::</span><span class='fu'><a href='https://tibble.tidyverse.org/reference/tibble.html'>tibble</a></span><span class='op'>(</span>
    result_num <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/numeric.html'>as.numeric</a></span><span class='op'>(</span><span class='va'>df</span><span class='op'>$</span><span class='va'>result</span><span class='op'>)</span> <span class='op'>-</span> <span class='fl'>1</span>,
    .prob <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/unname.html'>unname</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/stats/predict.html'>predict</a></span><span class='op'>(</span><span class='va'>fit</span>, type <span class='op'>=</span> <span class='st'>'response'</span><span class='op'>)</span><span class='op'>)</span>
  <span class='op'>)</span>
  
  <span class='va'>n_buckets</span> <span class='op'>&lt;-</span> <span class='fl'>20</span>
  <span class='va'>alpha</span> <span class='op'>&lt;-</span> <span class='fl'>0.05</span>
  <span class='va'>calib</span> <span class='op'>&lt;-</span> <span class='va'>probs</span> |&gt;
    <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>
      <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/across.html'>across</a></span><span class='op'>(</span><span class='va'>.prob</span>, <span class='op'>~</span><span class='fu'><a href='https://rdrr.io/r/base/Round.html'>round</a></span><span class='op'>(</span><span class='va'>.x</span> <span class='op'>*</span> <span class='va'>n_buckets</span><span class='op'>)</span> <span class='op'>/</span> <span class='va'>n_buckets</span><span class='op'>)</span>
    <span class='op'>)</span> |&gt;
    <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>.prob</span><span class='op'>)</span> |&gt;
    <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/summarise.html'>summarize</a></span><span class='op'>(</span>
      <span class='co'>## Jeffreys' prior</span>
      ci_lower <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/Beta.html'>qbeta</a></span><span class='op'>(</span><span class='va'>alpha</span> <span class='op'>/</span> <span class='fl'>2</span>, <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='va'>result_num</span><span class='op'>)</span> <span class='op'>+</span> <span class='fl'>0.5</span>, <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/context.html'>n</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>-</span> <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='va'>result_num</span><span class='op'>)</span> <span class='op'>+</span> <span class='fl'>0.5</span><span class='op'>)</span>,
      ci_upper <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/Beta.html'>qbeta</a></span><span class='op'>(</span><span class='fl'>1</span> <span class='op'>-</span> <span class='va'>alpha</span> <span class='op'>/</span> <span class='fl'>2</span>, <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='va'>result_num</span><span class='op'>)</span> <span class='op'>+</span> <span class='fl'>0.5</span>, <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/context.html'>n</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>-</span> <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='va'>result_num</span><span class='op'>)</span> <span class='op'>+</span> <span class='fl'>0.5</span><span class='op'>)</span>,
      actual <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='va'>result_num</span><span class='op'>)</span> <span class='op'>/</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/context.html'>n</a></span><span class='op'>(</span><span class='op'>)</span>,
      n <span class='op'>=</span> <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/context.html'>n</a></span><span class='op'>(</span><span class='op'>)</span>
    <span class='op'>)</span> |&gt; 
    <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>ungroup</a></span><span class='op'>(</span><span class='op'>)</span>
  
  <span class='va'>mse</span> <span class='op'>&lt;-</span> <span class='fu'>compute_mse</span><span class='op'>(</span><span class='va'>probs</span><span class='op'>$</span><span class='va'>result_num</span>, <span class='va'>probs</span><span class='op'>$</span><span class='va'>.prob</span><span class='op'>)</span>
  
  <span class='va'>ref_prob</span> <span class='op'>&lt;-</span> <span class='va'>result_props</span> |&gt; 
    <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>result</span> <span class='op'>==</span> <span class='op'>!</span><span class='op'>!</span><span class='va'>result</span><span class='op'>)</span> |&gt; 
    <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/pull.html'>pull</a></span><span class='op'>(</span><span class='va'>prop</span><span class='op'>)</span>
  
  <span class='va'>ref_mse</span> <span class='op'>&lt;-</span> <span class='fu'>compute_mse</span><span class='op'>(</span><span class='va'>probs</span><span class='op'>$</span><span class='va'>result_num</span>, <span class='va'>ref_prob</span><span class='op'>)</span>
  <span class='va'>bss</span> <span class='op'>&lt;-</span> <span class='fl'>1</span> <span class='op'>-</span> <span class='op'>(</span><span class='va'>mse</span> <span class='op'>/</span> <span class='va'>ref_mse</span><span class='op'>)</span>
  
  <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>
    calib <span class='op'>=</span> <span class='va'>calib</span>,
    mse <span class='op'>=</span> <span class='va'>mse</span>,
    bss <span class='op'>=</span> <span class='va'>bss</span>
  <span class='op'>)</span>
<span class='op'>}</span>

<span class='va'>diagnostics</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://tidyr.tidyverse.org/reference/expand.html'>crossing</a></span><span class='op'>(</span>
  result <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>'w'</span>, <span class='st'>'d'</span><span class='op'>)</span>,
  src <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>'understat'</span>, <span class='st'>'fotmob'</span><span class='op'>)</span>
<span class='op'>)</span> |&gt; 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>
    diagnostics <span class='op'>=</span> <span class='fu'><a href='https://purrr.tidyverse.org/reference/map2.html'>map2</a></span><span class='op'>(</span><span class='va'>src</span>, <span class='va'>result</span>, <span class='va'>diagnose_prob_by_match</span><span class='op'>)</span>
  <span class='op'>)</span> |&gt; 
  <span class='fu'><a href='https://tidyr.tidyverse.org/reference/hoist.html'>unnest_wider</a></span><span class='op'>(</span><span class='va'>diagnostics</span><span class='op'>)</span>
<span class='va'>diagnostics</span>
<span class='co'>#&gt; # A tibble: 4 × 5</span>
<span class='co'>#&gt;   result src       calib               mse    bss</span>
<span class='co'>#&gt;   &lt;chr&gt;  &lt;chr&gt;     &lt;list&gt;            &lt;dbl&gt;  &lt;dbl&gt;</span>
<span class='co'>#&gt; 1 d      fotmob    &lt;tibble [10 × 5]&gt; 0.170 0.0268</span>
<span class='co'>#&gt; 2 d      understat &lt;tibble [10 × 5]&gt; 0.166 0.0466</span>
<span class='co'>#&gt; 3 w      fotmob    &lt;tibble [17 × 5]&gt; 0.173 0.270 </span>
<span class='co'>#&gt; 4 w      understat &lt;tibble [17 × 5]&gt; 0.162 0.317</span>
</code></pre>
</div>
</div>
<p>The MSE (where lower is “better”) and the BSS (where higher is
“better”) lead us to same conclusion—the models based on understat’s xG
slightly outperform the one based on fotmob’s xG.</p>
<p>Moreover, looking at the calibration plot, the understat model
predictions seem to stick closer to the 45 degree slope, which
represents perfect calibration.<a href="#fn10" class="footnote-ref"
id="fnref10" role="doc-noteref"><sup>10</sup></a></p>
<p><img src="calib.png" /></p>
<h4 id="predicting-points-with-linear-regression">Predicting points with
linear regression</h4>
<p>Alternatively, we could regress points on expected points. For linear
regression, we can use the <a
href="https://en.wikipedia.org/wiki/Root-mean-square_deviation">root
mean squared error (RMSE)</a> (where lower is “better”) and <a
href="https://en.wikipedia.org/wiki/Coefficient_of_determination">R
squared</a> (where higher is “better”) to compare the models.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>compute_rmse <span class="ot">&lt;-</span> <span class="cf">function</span>(truth, estimate) {</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sqrt</span>(<span class="fu">mean</span>((truth <span class="sc">-</span> estimate)<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>diagnose_xpts_by_match <span class="ot">&lt;-</span> <span class="cf">function</span>(src) {</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  col <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">&#39;xpts_%s&#39;</span>, src)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  fit <span class="ot">&lt;-</span> <span class="fu">lm</span>(xpts_by_match<span class="sc">$</span>pts <span class="sc">~</span> xpts_by_match[[col]])</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  tibble<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">rmse =</span> <span class="fu">compute_rmse</span>(xpts_by_match<span class="sc">$</span>pts, pred),</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">r2 =</span> <span class="fu">summary</span>(fit)r.squared</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="st">&#39;understat&#39;</span>, <span class="st">&#39;fotmob&#39;</span>) <span class="sc">|&gt;</span> </span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_names</span>() <span class="sc">|&gt;</span> </span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map_dfr</span>(diagnose_xpts_by_match, <span class="at">.id =</span> <span class="st">&#39;src&#39;</span>)</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 2 × 3</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   src        rmse    r2</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1 understat  1.06 0.374</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2 fotmob     1.10 0.322</span></span></code></pre></div>
</div>
<p>The understat model proves to be better by both metrics, having a
lower RMSE and higher R squared than the fotmob model.</p>
<h4
id="predicting-match-outcomes-with-multinomial-logistic-regression">Predicting
match outcomes with multinomial logistic regression</h4>
<p>Personally, I don’t like predicting points directly like this since
it’s a discrete variable that can only take on three values (0, 1, and
3). If we’re going to predict points instead of a probability, I think
the better approach is to run a multinomial logistic regression and
convert the predicted probabilities to expected points.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='http://www.stats.ox.ac.uk/pub/MASS4/'>nnet</a></span><span class='op'>)</span>
<span class='va'>diagnose_implied_xpts_by_match</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>src</span><span class='op'>)</span> <span class='op'>{</span>
  
  <span class='va'>col_win</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/sprintf.html'>sprintf</a></span><span class='op'>(</span><span class='st'>'prob_win_%s'</span>, <span class='va'>src</span><span class='op'>)</span>
  <span class='va'>col_draw</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/sprintf.html'>sprintf</a></span><span class='op'>(</span><span class='st'>'prob_draw_%s'</span>, <span class='va'>src</span><span class='op'>)</span>
  <span class='va'>fit</span> <span class='op'>&lt;-</span> <span class='fu'>nnet</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/nnet/man/multinom.html'>multinom</a></span><span class='op'>(</span>
    <span class='va'>xpts_by_match</span><span class='op'>$</span><span class='va'>result</span> <span class='op'>~</span> <span class='va'>xpts_by_match</span><span class='op'>[[</span><span class='va'>col_win</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>+</span> <span class='va'>xpts_by_match</span><span class='op'>[[</span><span class='va'>col_draw</span><span class='op'>]</span><span class='op'>]</span>,
    trace <span class='op'>=</span> <span class='cn'>FALSE</span>
  <span class='op'>)</span>
  <span class='va'>probs</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/predict.html'>predict</a></span><span class='op'>(</span><span class='va'>fit</span>, type <span class='op'>=</span> <span class='st'>'probs'</span><span class='op'>)</span> |&gt; <span class='fu'>tibble</span><span class='fu'>::</span><span class='fu'><a href='https://tibble.tidyverse.org/reference/as_tibble.html'>as_tibble</a></span><span class='op'>(</span><span class='op'>)</span>
  <span class='va'>preds</span> <span class='op'>&lt;-</span> <span class='fl'>3</span> <span class='op'>*</span> <span class='va'>probs</span><span class='op'>$</span><span class='va'>w</span> <span class='op'>+</span> <span class='fl'>1</span> <span class='op'>*</span> <span class='va'>probs</span><span class='op'>$</span><span class='va'>d</span>
  
  <span class='fu'>tibble</span><span class='fu'>::</span><span class='fu'><a href='https://tibble.tidyverse.org/reference/tibble.html'>tibble</a></span><span class='op'>(</span>
    rmse <span class='op'>=</span> <span class='fu'>compute_rmse</span><span class='op'>(</span><span class='va'>xpts_by_match</span><span class='op'>$</span><span class='va'>pts</span>, <span class='va'>preds</span><span class='op'>)</span>,
    r2 <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/cor.html'>cor</a></span><span class='op'>(</span><span class='va'>xpts_by_match</span><span class='op'>$</span><span class='va'>pts</span>, <span class='va'>preds</span><span class='op'>)</span><span class='op'>^</span><span class='fl'>2</span>
  <span class='op'>)</span>
<span class='op'>}</span>

<span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>'understat'</span>, <span class='st'>'fotmob'</span><span class='op'>)</span> |&gt; 
  <span class='fu'><a href='https://purrr.tidyverse.org/reference/set_names.html'>set_names</a></span><span class='op'>(</span><span class='op'>)</span> |&gt; 
  <span class='fu'><a href='https://purrr.tidyverse.org/reference/map.html'>map_dfr</a></span><span class='op'>(</span><span class='va'>diagnose_implied_xpts_by_match</span>, .id <span class='op'>=</span> <span class='st'>'src'</span><span class='op'>)</span>
<span class='co'>#&gt; # A tibble: 2 × 3</span>
<span class='co'>#&gt;   src        rmse    r2</span>
<span class='co'>#&gt;   &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt;</span>
<span class='co'>#&gt; 1 understat  1.06 0.374</span>
<span class='co'>#&gt; 2 fotmob     1.10 0.321</span>
</code></pre>
</div>
</div>
<p>Again, we see that understat has a lower RMSE and higher R squared
with both approaches to predicting points. The implication that
understat performs slighlty better agrees with the binary logistic
regression models for predicting match outcome probabilities and the
linear regression models for predicting points.</p>
<p>Overall, we might say that understat seems to be the better of the
two xG sources for explaining individual match results.</p>
<h3 id="season-predictive-performance">3. Season predictive
performance</h3>
<p>How do the understat and fotmob models fare if we aggregate up the
expected points to the season level and predict actual points?<a
href="#fn11" class="footnote-ref" id="fnref11"
role="doc-noteref"><sup>11</sup></a></p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>xpts_by_season</span> <span class='op'>&lt;-</span> <span class='va'>xpts_by_match</span> |&gt; 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>season</span>, <span class='va'>team</span><span class='op'>)</span> |&gt; 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/summarise.html'>summarize</a></span><span class='op'>(</span>
    <span class='fu'><a href='https://dplyr.tidyverse.org/reference/across.html'>across</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>pts</span>, <span class='fu'><a href='https://tidyselect.r-lib.org/reference/starts_with.html'>starts_with</a></span><span class='op'>(</span><span class='st'>'xpts'</span><span class='op'>)</span><span class='op'>)</span>, <span class='va'>sum</span><span class='op'>)</span>
  <span class='op'>)</span> |&gt; 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>ungroup</a></span><span class='op'>(</span><span class='op'>)</span>
<span class='va'>xpts_by_season</span>

<span class='va'>diagnose_xpts_by_season</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>src</span><span class='op'>)</span> <span class='op'>{</span>
  
  <span class='va'>col</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/sprintf.html'>sprintf</a></span><span class='op'>(</span><span class='st'>'xpts_%s'</span>, <span class='va'>src</span><span class='op'>)</span>
  <span class='va'>fit</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/lm.html'>lm</a></span><span class='op'>(</span><span class='va'>xpts_by_season</span><span class='op'>$</span><span class='va'>pts</span> <span class='op'>~</span> <span class='va'>xpts_by_season</span><span class='op'>[[</span><span class='va'>col</span><span class='op'>]</span><span class='op'>]</span><span class='op'>)</span>
  
  <span class='va'>preds</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/predict.html'>predict</a></span><span class='op'>(</span><span class='va'>fit</span><span class='op'>)</span>
  
  <span class='fu'>tibble</span><span class='fu'>::</span><span class='fu'><a href='https://tibble.tidyverse.org/reference/tibble.html'>tibble</a></span><span class='op'>(</span>
    rmse <span class='op'>=</span> <span class='fu'>compute_rmse</span><span class='op'>(</span><span class='va'>xpts_by_match</span><span class='op'>$</span><span class='va'>pts</span>, <span class='va'>preds</span><span class='op'>)</span>,
    r2 <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/summary.html'>summary</a></span><span class='op'>(</span><span class='va'>fit</span><span class='op'>)</span><span class='op'>$</span><span class='va'>r.squared</span>
  <span class='op'>)</span>
<span class='op'>}</span>

<span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>'understat'</span>, <span class='st'>'fotmob'</span><span class='op'>)</span> |&gt; 
  <span class='fu'><a href='https://purrr.tidyverse.org/reference/set_names.html'>set_names</a></span><span class='op'>(</span><span class='op'>)</span> |&gt; 
  <span class='fu'><a href='https://purrr.tidyverse.org/reference/map.html'>map_dfr</a></span><span class='op'>(</span><span class='va'>diagnose_xpts_by_season</span>, .id <span class='op'>=</span> <span class='st'>'src'</span><span class='op'>)</span>
<span class='co'>#&gt; # A tibble: 2 × 3</span>
<span class='co'>#&gt;   src        rmse    r2</span>
<span class='co'>#&gt;   &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt;</span>
<span class='co'>#&gt; 1 understat  53.9 0.845</span>
<span class='co'>#&gt; 2 fotmob     53.8 0.825</span>
</code></pre>
</div>
</div>
<p>The results are closer than those at the match-level. In fact, fotmob
barely edges out understat in terms of RMSE xPts, although understat
outperforms fotmob according to R squared by a relatively comfortable
0.02. It’s harder to make a general statement regarding which data
source provides better xG for explaining season-long expected points,
but we might lean in favor of understat again.</p>
<h2 id="conclusion">Conclusion</h2>
<p><strong><em>SARCASM ACTIVATED</em></strong></p>
<p>Alas, we find that understat’s xG model seems to outperform fotmob’s
in terms of explaining match results and season-long point totals, so no
one should ever use fotmob’s site again! As my dedicated followers know
(all three of you), I am not one to shy away from calling out data
providers on their B.S. I am glad to continue to live up to my
reputation.</p>
<blockquote class="twitter-tweet">
<p lang="en" dir="ltr">
<p>Fine, since no one has been brave enough to do it, I will. I’m
calling out Opta for stat-padding for attackers, giving them more credit
than StatsBomb for aerial duel success.
<a href="https://t.co/ZOeCg320qp">pic.twitter.com/ZOeCg320qp</a></p>
</p>
<p>— Tony (<span class="citation"
data-cites="TonyElHabr">@TonyElHabr</span>)
<a href="https://twitter.com/TonyElHabr/status/1530196320790642689?ref_src=twsrc%5Etfw">May
27, 2022</a></p>
</blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<p><strong>SARCASM DE-ACTIVATED</strong></p>
<p>In a follow up post, we’ll go more in depth regarding how we can
leverage the match outcome probabilities to simulate season-ending
points in a more rigorous fashion that done in the last section
above.</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode r distill-force-highlighting-css"><code class="sourceCode r"></code></pre></div>
<section class="footnotes footnotes-end-of-document"
role="doc-endnotes">
<hr />
<ol>
<li id="fn1" role="doc-endnote"><p><a
href="https://danny.page/expected_goals.html">Danny Page’s interactive
web app</a> also uses simulation.<a href="#fnref1" class="footnote-back"
role="doc-backlink">↩︎</a></p></li>
<li id="fn2" role="doc-endnote"><p>Now, if you desire the statistical
properties that simulation offers, such as an estimation of error,
that’s understandable; however, in write-ups that I’ve seen, such is not
mentioned explicitly. Additionally, if one chooses to go down the
simulation route because they believe that it helps to suppress flaws
with the xG model, that’s also understandable. On the other hand, the
analytical approach I present should present nearly identical results to
that which one would find with simulation, and it offers the advantage
of being much faster.<a href="#fnref2" class="footnote-back"
role="doc-backlink">↩︎</a></p></li>
<li id="fn3" role="doc-endnote"><p>How does this work? Under the
assumption that xG comes from a <a
href="https://en.wikipedia.org/wiki/Poisson_binomial_distribution">Poisson
binomial distribution</a>, we look at all combinations of makes and
misses of the shots and compare the relative proportion of instances in
which one team’s number of success, i.e. goals, is greater than, equal
to, or less than their opponent’s.<a href="#fnref3"
class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4" role="doc-endnote"><p>We’ve limited the scope for several
reasons: (1) fotmob only has complete xG data for the 2020/21 and
2021/22 seasons as of writing, (2) I didn’t want to have to map team
names across the two data sources for a ton of teams; and (3) of all
league, I’m most interested in the EPL 😄.<a href="#fnref4"
class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5" role="doc-endnote"><p>Note that there are three additional
shots in the fotmob data. There’s no simple solution to resolving this
data discrepancy since we don’t have matching shot identifiers in the
two data sets 🤷.<a href="#fnref5" class="footnote-back"
role="doc-backlink">↩︎</a></p></li>
<li id="fn6" role="doc-endnote"><p>Using the adjective “predictive” is a
little misleading, since we’re not actually making predictions
out-of-sample. Rather, we’re using models based on xG to evaluate which
xG data source better explains the observed results.<a href="#fnref6"
class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn7" role="doc-endnote"><p>Home field advantage is treated as a
feature instead of defined directly via columns,
i.e. <code>home_team</code>, <code>home_score</code>, etc., which is
good practice in general.<a href="#fnref7" class="footnote-back"
role="doc-backlink">↩︎</a></p></li>
<li id="fn8" role="doc-endnote"><p>Draws occur for 22.5% of matches in
the data set, and wins and losses occur in 38.8% of matches each.<a
href="#fnref8" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn9" role="doc-endnote"><p>Personally, I tend to rely on BSS
wherever I can. Not only is it more interpretable—it’s a number between
0 and 1, while MSE can take on any value, depending on the context—I
like that it forces one to compare to a baseline, which is a good
principle in general.<a href="#fnref9" class="footnote-back"
role="doc-backlink">↩︎</a></p></li>
<li id="fn10" role="doc-endnote"><p>Plotting code is omitted here since
it’s not relevant to our analysis.<a href="#fnref10"
class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn11" role="doc-endnote"><p>Note that aggregating match-level
probabilities to the season-level is not a statistically valid way to
use the probabilities, which are intended to be treated independently.<a
href="#fnref11" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>
<!--radix_placeholder_article_footer-->
<!--/radix_placeholder_article_footer-->
</div>

<div class="d-appendix">
</div>


<!--radix_placeholder_site_after_body-->
<!--/radix_placeholder_site_after_body-->
<!--radix_placeholder_appendices-->
<div class="appendix-bottom">
  <h3 id="citation">Citation</h3>
  <p>For attribution, please cite this work as</p>
  <pre class="citation-appendix short">ElHabr (2022, Sept. 4). Tony: What exactly is an "expected point"? (part 1). Retrieved from https://itsmetoeknee.netlify.app/posts/epl-xpts-simulation-1/</pre>
  <p>BibTeX citation</p>
  <pre class="citation-appendix long">@misc{elhabr2022what,
  author = {ElHabr, Tony},
  title = {Tony: What exactly is an "expected point"? (part 1)},
  url = {https://itsmetoeknee.netlify.app/posts/epl-xpts-simulation-1/},
  year = {2022}
}</pre>
</div>
<!--/radix_placeholder_appendices-->
<!--radix_placeholder_navigation_after_body-->
<!--/radix_placeholder_navigation_after_body-->

</body>

</html>
